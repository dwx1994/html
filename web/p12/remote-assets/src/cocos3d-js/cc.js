System.register([],(function(e){"use strict";return{execute:function(){e({BitMask:Xe,CCClass:Nt,CacheMode:void 0,Enum:Ye,Eventify:Ka,GFXAPI:void 0,GFXAddress:void 0,GFXAttributeName:void 0,GFXBlendFactor:void 0,GFXBlendOp:void 0,GFXBufferAccessBit:void 0,GFXBufferFlagBit:void 0,GFXBufferUsageBit:void 0,GFXClearFlag:void 0,GFXColorMask:void 0,GFXCommandBufferType:void 0,GFXComparisonFunc:void 0,GFXCullMode:void 0,GFXDescriptorType:void 0,GFXDynamicStateFlagBit:void 0,GFXFeature:void 0,GFXFilter:void 0,GFXFormat:void 0,GFXFormatSize:ds,GFXFormatSurfaceSize:ms,GFXFormatType:void 0,GFXGetTypeSize:fs,GFXLoadOp:void 0,GFXMemoryUsageBit:void 0,GFXObjectType:void 0,GFXPipelineBindPoint:void 0,GFXPolygonMode:void 0,GFXPrimitiveMode:void 0,GFXQueueType:void 0,GFXSampleCount:void 0,GFXShadeModel:void 0,GFXShaderStageFlagBit:void 0,GFXStencilFace:void 0,GFXStencilOp:void 0,GFXStoreOp:void 0,GFXTextureFlagBit:void 0,GFXTextureLayout:void 0,GFXTextureType:void 0,GFXTextureUsageBit:void 0,GFXType:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,IsPowerOf2:js,Overflow:void 0,SystemEventType:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Bg,WorldNode3DToWorldNodeUI:Ng,absMax:ai,absMaxComponent:oi,approx:Wt,assert:_,assertID:E,bezier:$L,bezierByTime:sB,ccenum:$e,clamp:jt,clamp01:qt,color:zi,computeRatioByType:cB,deserialize:Qg,equals:kt,error:u,errorID:S,find:Wp,fragmentText:bo,getPathFromRoot:function(e,t){let i=e,n="";for(;null!==i&&i!==t;)n=`${i.name}/${n}`,i=i.parent;return n.slice(0,-1)},getTypedArrayConstructor:gs,getWorldTransformUntilRoot:rm,instantiate:iv,inverseLerp:ri,isCustomTargetModifier:YN,isDisplayStats:b,isElementModifier:XN,isPropertyModifier:qN,isUnicodeCJK:To,isUnicodeSpace:Eo,isValid:Ha,lerp:Xt,log:l,logID:g,markAsWarning:void 0,mat4:Pi,murmurhash2_32_gc:Os,nextPow2:ii,pingPong:si,pseudoRandom:Jt,pseudoRandomRange:ei,pseudoRandomRangeInt:ti,quat:Ri,randomRange:$t,randomRangeInt:Qt,rect:Ni,removeProperty:void 0,repeat:ni,replaceProperty:void 0,safeMeasureText:Ao,sampleAnimationCurve:aB,setDefaultLogTimes:function(e){e>0&&(ji=e)},setDisplayStats:R,size:Li,toDegree:Kt,toRadian:Yt,tween:MU,tweenUtil:DU,v2:ui,v3:pi,v4:gi,warn:h,warnID:y});const t="undefined"==typeof window?global:window,i=e("cclegacy",{_global:t});i.internal={},t.CC_BUILD=!0,t.CC_TEST=!1,t.CC_EDITOR=!1,t.CC_PREVIEW=!1,t.CC_DEV=!1,t.CC_DEBUG=!1,t.CC_JSB=!0,t.CC_BYTEDANCE=!1,t.CC_WECHAT=!1,t.CC_ALIPAY=!1,t.CC_XIAOMI=!1,t.CC_BAIDU=!1,t.CC_COCOSPLAY=!1,t.CC_HUAWEI=!1,t.CC_OPPO=!1,t.CC_VIVO=!1,t.CC_MINIGAME=!1,t.CC_RUNTIME_BASED=!1,t.CC_SUPPORT_JIT=!0;t.CocosEngine=i.ENGINE_VERSION="1.2.0",t.cc=i;let n=null,s=console.log,r=console.log,o=console.log,a=(e,t,...i)=>{e||console.log("ASSERT: "+c(t,...i))};function c(e,...t){return i.js.formatStr.apply(null,[e].concat(t))}function l(e,...t){return s(e,...t)}function h(e,...t){return r(e,...t)}function u(e,...t){return o(e,...t)}function _(e,t,...i){return a(e,t,...i)}function d(e){if(s=r=o=a=()=>{},e!==A.NONE){if(e>A.ERROR){const t=e=>{if(i.game.canvas){if(!n){const e=document.createElement("Div");e.setAttribute("id","logInfoDiv"),e.setAttribute("width","200"),e.setAttribute("height",i.game.canvas.height);const t=e.style;t.zIndex="99999",t.position="absolute",t.top=t.left="0",n=document.createElement("textarea"),n.setAttribute("rows","20"),n.setAttribute("cols","30"),n.setAttribute("disabled","true");const s=n.style;s.backgroundColor="transparent",s.borderBottom="1px solid #cccccc",s.borderTopWidth=s.borderLeftWidth=s.borderRightWidth="0px",s.borderTopStyle=s.borderLeftStyle=s.borderRightStyle="none",s.padding="0px",s.margin="0px",e.appendChild(n),i.game.canvas.parentNode.appendChild(e)}n.value=n.value+e+"\r\n",n.scrollTop=n.scrollHeight}};o=(e,...i)=>{t("ERROR :  "+c(e,...i))},a=(e,i,...n)=>{e||t("ASSERT: "+c(i,...n))},e!==A.ERROR_FOR_WEB_PAGE&&(r=(e,...i)=>{t("WARN :  "+c(e,...i))}),e===A.INFO_FOR_WEB_PAGE&&(s=(e,...i)=>{t(c(e,...i))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),o=console.error.bind?console.error.bind(console):console.error,a=(e,t,...i)=>{if(!e){const e=c(t,...i);throw new Error(e)}});e!==A.ERROR&&(r=console.warn.bind?console.warn.bind(console):console.warn),e===A.INFO&&(s="JavaScriptCore"===scriptEngineType?(e,...t)=>console.log.apply(console,[e,...t]):console.log)}}function m(e){{const t=e.stack;u(t?e+"\n"+t:e)}}function p(e){return(t,...i)=>{const n=`${e} ${t}, please go to https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md#${t} to see details.`;return 0===i.length?n:n+" Arguments: "+i.join(", ")}}const f=p("Log");function g(e,...t){l(f(e,...t))}const v=p("Warning");function y(e,...t){h(v(e,...t))}const x=p("Error");function S(e,...t){u(x(e,...t))}const T=p("Assert");function E(e,t,...i){e||_(!1,T(t,...i))}let A;function C(e,...t){return x(e,...t)}function b(){return!!i.profiler&&i.profiler.isShowingStats()}function R(e){i.profiler&&(e?i.profiler.showStats():i.profiler.hideStats(),i.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE"}(A||(A={}));var w=Object.freeze({__proto__:null,log:l,warn:h,error:u,assert:_,_resetDebugSetting:d,_throw:m,logID:g,warnID:y,errorID:S,assertID:E,get DebugMode(){return A},getError:C,isDisplayStats:b,setDisplayStats:R});const I=/(\.[^\.\/\?\\]*)(\?.*)?$/,O=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,P=/[^\.\/]+\/\.\.\//;function M(...e){let t="";for(const i of e)t=(t+(""===t?"":"/")+i).replace(/(\/|\\\\)$/,"");return t}function D(e){const t=I.exec(e);return t?t[1]:""}function L(e){if(e){const t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function B(e,t){const i=e.indexOf("?");i>0&&(e=e.substring(0,i));const n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return"";const s=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?s.substring(0,s.length-t.length):s}function N(e){const t=O.exec(e);return t?t[2]:""}function F(e,t){t=t||"";let i=e.indexOf("?"),n="";return i>0&&(n=e.substring(i),e=e.substring(0,i)),i=e.lastIndexOf("."),i<0?e+t+n:e.substring(0,i)+t+n}function z(e,t,i){if(0===t.indexOf("."))return F(e,t);let n=e.indexOf("?"),s="";const r=i?D(e):"";return n>0&&(s=e.substring(n),e=e.substring(0,n)),n=e.lastIndexOf("/"),n=n<=0?0:n+1,e.substring(0,n)+t+r+s}function U(e){let t=e=String(e);do{t=e,e=e.replace(P,"")}while(t.length!==e.length);return e}function G(e){return e.replace(/[\/\\]$/,"")}function H(){return i.sys.os===i.sys.OS_WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:M,extname:D,mainFileName:L,basename:B,dirname:N,changeExtname:F,changeBasename:z,_normalize:U,stripSep:G,getSeperator:H})),i.log=l,i.warn=h,i.error=u,i.assert=_,i._throw=m,i.logID=g,i.warnID=y,i.errorID=S,i.assertID=E,i.debug=w,i.path={join:M,extname:D,mainFileName:L,basename:B,dirname:N,changeExtname:F,changeBasename:z,_normalize:U,stripSep:G,get sep(){return H()}};var V={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512};function k(e){let t,i;return t=(e>65535)<<4,i=((e>>>=t)>255)<<3,t|=i,i=((e>>>=i)>15)<<2,t|=i,i=((e>>>=i)>3)<<1,t|=i,t|(e>>>=i)>>1}function W(e){let t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function j(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)+1}const q=new Array(256);(e=>{for(let t=0;t<256;++t){let i=t,n=t,s=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--s;e[t]=n<<s&255}})(q);var X=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-1<<31,sign:function(e){return(e>0)-(e<0)},abs:function(e){const t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:k,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:W,nextPow2:j,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return q[255&e]<<24|q[e>>>8&255]<<16|q[e>>>16&255]<<8|q[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){const t=e|e-1;return t+1|(~t&-~t)-1>>>W(e)+1}});e("bits",X);class Y{constructor(e){this.i=0,this.array=e}get length(){return this.array.length}set length(e){this.array.length=e,this.i>=e&&(this.i=e-1)}remove(e){const t=this.array.indexOf(e);t>=0&&this.removeAt(t)}removeAt(e){this.array.splice(e,1),e<=this.i&&--this.i}fastRemove(e){const t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)}fastRemoveAt(e){const t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}push(e){this.array.push(e)}}function K(e,t){e.splice(t,1)}function Z(e,t){const i=e.indexOf(t);return i>=0&&(K(e,i),!0)}function $(e,t){return e.indexOf(t)>=0}var Q=Object.freeze({__proto__:null,removeAt:K,fastRemoveAt:function(e,t){const i=e.length;t<0||t>=i||(e[t]=e[i-1],e.length=i-1)},remove:Z,fastRemove:function(e,t){const i=e.indexOf(t);i>=0&&(e[i]=e[e.length-1],--e.length)},removeIf:function(e,t){const i=e.findIndex(t);if(i>=0){const t=e[i];return K(e,i),t}},verifyType:function(e,t){if(e&&e.length>0)for(const i of e)if(!(i instanceof t))return g(1300),!1;return!0},removeArray:function(e,t){for(let i=0,n=t.length;i<n;i++)Z(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0,...t]),e},contains:$,copy:function(e){const t=e.length,i=new Array(t);for(let n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:Y});class J{constructor(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}getNewId(){return this.prefix+ ++this.id}}J.global=new J("global");const ee=new J("TmpCId."),te="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]");function ie(e){return"number"==typeof e||e instanceof Number}function ne(e){return"string"==typeof e||e instanceof String}const se=(()=>{const e={value:void 0,enumerable:!1,writable:!1,configurable:!0};return(t,i,n,s,r)=>{e.value=n,e.writable=s,e.enumerable=r,Object.defineProperty(t,i,e),e.value=void 0}})(),re=(()=>{const e={get:void 0,set:void 0,enumerable:!1};return(t,i,n,s,r=!1,o=!1)=>{"boolean"==typeof s&&(r=s,s=void 0),e.get=n,e.set=s,e.enumerable=r,e.configurable=o,Object.defineProperty(t,i,e),e.get=void 0,e.set=void 0}})(),oe=(()=>{const e={get:void 0,enumerable:!1,configurable:!1};return(t,i,n,s,r)=>{e.get=n,e.enumerable=s,e.configurable=r,Object.defineProperty(t,i,e),e.get=void 0}})(),ae=(()=>{const e={set:void 0,enumerable:!1,configurable:!1};return(t,i,n,s,r)=>{e.set=n,e.enumerable=s,e.configurable=r,Object.defineProperty(t,i,e),e.set=void 0}})();function ce(e){const t=Object.create(null);if(e){const e=".",i="/";t[e]=!0,t[i]=!0,delete t[e],delete t[i]}return t}function le(e){if("function"==typeof e){const t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;let i="";if(e.name&&(i=e.name),e.toString){let t;const n=e.toString();t="["===n.charAt(0)?n.match(/\[\w+\s*(\w+)\]/):n.match(/function\s*(\w+)/),t&&2===t.length&&(i=t[1])}return"Object"!==i?i:""}return e&&e.constructor?le(e.constructor):""}function he(e,t,i,n){const s=/([^.]+)$/,r=s.exec(t)[0],o=s.exec(i)[0];function a(){return this[o]}n?re(e,r,a,(function(e){this[o]=e})):oe(e,r,a)}function ue(e,t,i,n){for(const s in i){he(e,t+"."+s,i[s],n)}}const _e=/(%d)|(%s)/,de=/%s/;function me(e,...t){if(0===arguments.length)return"";if(0===t.length)return""+e;const i="string"==typeof e&&_e.test(e);if(i)for(const i of t){const t="number"==typeof i?_e:de;t.test(e)?e=e.replace(t,i):e+=" "+i}else for(const i of t)e+=" "+i;return e}function pe(){const e=arguments.length-1,t=new Array(e);for(let i=0;i<e;++i)t[i]=arguments[i+1];return t}function fe(e,t){for(;e;){const i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function ge(e,t,i){const n=fe(t,e);n&&Object.defineProperty(i,e,n)}function ve(e,...t){e=e||{};for(const i of t)if(i){if("object"!=typeof i){S(5402,i);continue}for(const t in i)t in e||ge(t,i,e)}return e}function ye(e,...t){e=e||{};for(const i of t)if(i){if("object"!=typeof i){S(5403,i);continue}for(const t in i)ge(t,i,e)}return e}function xe(e,t){for(const i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Se(e){const t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function Te(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Se(e)))return!1;if(e===t)return!0}}return!1}function Ee(e){for(const t of Object.keys(e))delete e[t]}const Ae={},Ce={};function be(e,t){const i=Ae;if(t.prototype.hasOwnProperty("__cid__")&&delete i[t.prototype.__cid__],se(t.prototype,"__cid__",e),e){const n=i[e];if(n&&n!==t){u('A Class already exists with the same __cid__ : "'+e+'".')}else i[e]=t}}function Re(e,t){if(function(e,t){const i=Ce;if(t.prototype.hasOwnProperty("__classname__")&&delete i[t.prototype.__classname__],se(t.prototype,"__classname__",e),e){const n=i[e];if(n&&n!==t){u('A Class already exists with the same __classname__ : "'+e+'".')}else i[e]=t}}(e,t),!t.prototype.hasOwnProperty("__cid__")){const i=e||ee.getNewId();i&&be(i,t)}}function we(e,t){const i=Ce[t],n=Ae[t];let s=!0;if(i&&i!==e&&(u(`"${t}" has already been set as name or alias of another class.`),s=!1),n&&n!==e&&(u(`"${t}" has already been set as id or alias of another class.`),s=!1),s){let i=e[te];i||(i=[],e[te]=i),i.push(t),Ce[t]=e,Ae[t]=e}}function Ie(...e){for(const t of e){const e=t.prototype,i=e.__cid__;i&&delete Ae[i];const n=e.__classname__;n&&delete Ce[n];const s=e[te];if(s)for(let e=0;e<s.length;++e){const t=s[e];delete Ce[t],delete Ae[t]}}}function Oe(e){return Ae[e]}function Pe(e){return Ce[e]}function Me(e,t){let i;if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty("__cid__"))return i=e.prototype.__cid__,i;if(e&&e.constructor){const t=e.constructor.prototype;if(t&&t.hasOwnProperty("__cid__"))return i=e.__cid__,i}return""}class De{get(){return this._get()}constructor(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;const i=void 0===t?e:t,n=void 0===t?null:e;this.count=0,this._pool=new Array(i),this._cleanup=n}_get(){if(this.count>0){--this.count;const e=this._pool[this.count];return this._pool[this.count]=null,e}return null}put(e){const t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}resize(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))}}const Le=Q,Be={IDGenerator:J,Pool:De,array:Q,isNumber:ie,isString:ne,getPropertyDescriptor:fe,addon:ve,mixin:ye,extend:xe,getSuper:Se,isChildClassOf:Te,clear:Ee,value:se,getset:re,get:oe,set:ae,unregisterClass:Ie,getClassName:le,setClassName:Re,setClassAlias:we,getClassByName:Pe,_getClassId:Me,_setClassId:be,_getClassById:Oe,obsolete:he,obsoletes:ue,formatStr:me,shiftArguments:pe,createMap:ce};i.js=Be,e("js",Object.freeze({__proto__:null,array:Le,js:Be,IDGenerator:J,Pool:De,isNumber:ie,isString:ne,value:se,getset:re,get:oe,set:ae,createMap:ce,getClassName:le,obsolete:he,obsoletes:ue,formatStr:me,shiftArguments:pe,getPropertyDescriptor:fe,addon:ve,mixin:ye,extend:xe,getSuper:Se,isChildClassOf:Te,clear:Ee,_idToClass:Ae,_nameToClass:Ce,_setClassId:be,setClassName:Re,setClassAlias:we,unregisterClass:Ie,_getClassById:Oe,getClassByName:Pe,_getClassId:Me}));const Ne=/^(?:cc|dragonBones|sp|ccsg)\..+/,Fe=new Array(123);for(let e=0;e<123;++e)Fe[e]=64;for(let e=0;e<64;++e)Fe["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(e)]=e;const ze=Fe;function Ue(e,t,i){function n(e,t,i,n){const s=Object.getOwnPropertyDescriptor(e,t);if(s)s.get&&(e[i]=s.get),s.set&&n&&(e[n]=s.set);else{const s=e[i];re(e,t,s,e[n])}}let s,r=e.prototype;for(let e=0;e<t.length;e++){s=t[e];const i=s[0].toUpperCase()+s.slice(1);n(r,s,"get"+i,"set"+i)}for(s in i){const e=i[s];n(r,s,e[0],e[1])}}function Ge(e,t,i,n){const s=e[t];s?Array.isArray(s)?n?(s.push(s[0]),s[0]=i):s.push(i):e[t]=n?[i,s]:[s,i]:e[t]=i}function He(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));{let i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}}function Ve(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function ke(e,t,i){e&&setTimeout((function(){e(t,i)}),0)}function We(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")}function je(e){if(!e||e.constructor!==Object)return!1;for(const t in e)return!1;return!0}function qe(e){return e&&"function"==typeof e.clone&&(e.constructor&&e.constructor.prototype.hasOwnProperty("clone")||e.hasOwnProperty("clone"))}function Xe(e){if("__bitmask__"in e)return e;se(e,"__bitmask__",null,!0);let t=-1;const i=Object.keys(e);for(let n=0;n<i.length;n++){const s=i[n];let r=e[s];if(-1===r)r=++t,e[s]=r;else if("number"==typeof r)t=r;else if("string"==typeof r&&Number.isInteger(parseFloat(s)))continue;const o=""+r;s!==o&&se(e,o,s)}return e}function Ye(e){return"__enums__"in e?e:(se(e,"__enums__",null,!0),Ye.update(e))}function Ke(e){e.hasOwnProperty("__enums__")}function Ze(e){Ke(e);const t=e.__enums__||[];t.length=0;for(const i in e){const n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort((e,t)=>e.value-t.value),e.__enums__=t,t}function $e(e){"__enums__"in e||se(e,"__enums__",null,!0)}i.misc={BUILTIN_CLASSID_RE:Ne,BASE64_VALUES:ze,propertyDefine:Ue,pushToMap:Ge,contains:He,isDomNode:Ve,callInNextTick:ke,tryCatchFunctor_EDITOR:We,isPlainEmptyObj_DEV:je,cloneable_DEV:qe},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:Ne,BASE64_VALUES:ze,propertyDefine:Ue,pushToMap:Ge,contains:He,isDomNode:Ve,callInNextTick:ke,tryCatchFunctor_EDITOR:We,isPlainEmptyObj_DEV:je,cloneable_DEV:qe})),Xe.isBitMask=e=>e&&e.hasOwnProperty("__bitmask__"),Xe.getList=e=>{if(e.__bitmask__)return e.__bitmask__;const t=e.__bitmask__=[];for(const i in e){const n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort((e,t)=>e.value-t.value),t},i.BitMask=Xe,Ye.update=e=>{let t=-1;const i=Object.keys(e);for(let n=0;n<i.length;n++){const s=i[n];let r=e[s];if(-1===r)r=++t,e[s]=r;else if("number"==typeof r)t=r;else if("string"==typeof r&&Number.isInteger(parseFloat(s)))continue;const o=""+r;s!==o&&se(e,o,s)}return Array.isArray(e.__enums__)&&Ze(e),e},Ye||(Ye=e("Enum",{})),Ye.isEnum=e=>e&&e.hasOwnProperty("__enums__"),Ye.getList=e=>(Ke(e),e.__enums__?e.__enums__:Ze(e)),i.Enum=Ye;class Qe{clone(){return S(100,le(this)+".clone"),this}equals(e){return!1}set(e){S(100,le(this)+".set")}toString(){return""+{}}}e("ValueType",Qe),Re("cc.ValueType",Qe),i.ValueType=Qe;function Je(e,t,i){let n;n=function(){},i&&xe(n,i.constructor);const s=new n;return se(e,"__attrs__",s),s}function et(e){let t;const n=i.Class.getInheritanceChain(e);for(let e=n.length-1;e>=0;e--){const i=n[e];i.hasOwnProperty("__attrs__")&&i.__attrs__||(t=n[e+1],Je(i,0,t&&t.__attrs__))}return t=n[0],Je(e,0,t&&t.__attrs__),e.__attrs__}function tt(e,t,i){let n,s;if("function"==typeof e)n=it(e),s=n.constructor.prototype;else{const t=e;if(n=t.__attrs__,!n){n=Je(t,0,it(e=t.constructor))}s=n}if(void 0===i){const e=t+"$_$",i={};for(const t in n)t.startsWith(e)&&(i[t.slice(e.length)]=n[t]);return i}if("object"==typeof i)for(const e in i)95!==e.charCodeAt(0)&&(s[t+"$_$"+e]=i[e])}function it(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||et(e)}function nt(e){return it(e).constructor.prototype}function st(e,t,i,n){nt(e)[t+"$_$"+i]=n}class rt{constructor(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}toString(){return this.name}}const ot=e("CCInteger",new rt("Integer",0));i.Integer=ot,i.CCInteger=ot;const at=e("CCFloat",new rt("Float",0));i.Float=at,i.CCFloat=at;const ct=e("CCBoolean",new rt("Boolean",!1));i.Boolean=ct,i.CCBoolean=ct;const lt=e("CCString",new rt("String",""));function ht(e,t){return function(n,s){const r='"'+le(n)+"."+s+'"',o=tt(n,s);if(!o.saveUrlAsAsset){let t=o.type;if(t===ot||t===at?t="Number":t!==lt&&t!==ct||(t=t.toString()),t!==e)return void y(3604,r)}if(!o.hasOwnProperty("default"))return;const a=o.default;if(void 0===a)return;if(Array.isArray(a)||je(a))return;const c=typeof a,l=e.toLowerCase();if(c===l){if(!o.saveUrlAsAsset)if("object"===l){if(!a||a instanceof o.ctor)return;y(3605,r,le(o.ctor))}else"Number"!==e&&y(3606,t,r,e)}else{if("function"===c)return;e===lt.default&&null==a?Te(o.ctor,i.RawAsset)||y(3607,r):y(3611,t,r,c)}delete o.type}}i.String=lt,i.CCString=lt;var ut=Object.freeze({__proto__:null,DELIMETER:"$_$",createAttrsSingle:Je,createAttrs:et,attr:tt,getClassAttrs:it,getClassAttrsProto:nt,setClassAttr:st,PrimitiveType:rt,CCInteger:ot,CCFloat:at,CCBoolean:ct,CCString:lt,getTypeChecker:ht,getObjTypeChecker:function(e){return function(t,n){ht("Object","type")(t,n);const s=it(t)[n+"$_$default"],r=i.Class.getDefault(s);if(!Array.isArray(r)&&Te(e,i.ValueType)){const i=le(e),r=me('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',le(t),n,i);s?l(r):y(3612,r,i,le(t),n,i)}}}});const _t={url:{canUsedInGet:!0},default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function dt(e,t,i,n){if(!e.get&&!e.set&&e.hasOwnProperty("default")){const s="_N$"+t;e.get=function(){return this[s]},e.set=function(e){const t=this[s];this[s]=e,i.call(this,t)};const r={};n[s]=r;for(const t in _t){const i=_t[t];e.hasOwnProperty(t)&&(r[t]=e[t],i.canUsedInGet||delete e[t])}}}function mt(e,t,i,n){Array.isArray(n)&&n.length>0&&(n=n[0]),e.type=n}function pt(e,t,n,s){if(Array.isArray(t)){if(!(t.length>0))return S(5508,n,s);if(i.RawAsset.isRawAssetType(t[0]))return e.url=t[0],void delete e.type;e.type=t=t[0]}}function ft(e,t,n){if(!(e&&e.constructor===Object)){if(Array.isArray(e)&&e.length>0){e[0];return{default:[],type:e,_short:!0}}if("function"==typeof e){const t=e;return i.RawAsset.isRawAssetType(t)?{default:"",url:t,_short:!0}:{default:Te(t,i.ValueType)?new t:null,type:t,_short:!0}}return e instanceof rt?{default:e.default,_short:!0}:{default:e,_short:!0}}return null}function gt(e,t,i,n,s){return"function"==typeof e||null===e}let vt=[];function yt(){return vt[vt.length-1]}i._RF={push:function(e,t,i,n){void 0===i&&(i=t,t=""),vt.push({uuid:t,script:i,module:e,exports:e.exports,beh:null,importMeta:n})},pop:function(){const e=vt.pop(),t=e.module;let i=t.exports;if(i===e.exports){for(const e in i)return;t.exports=i=e.cls}},peek:yt};const xt=["name","extends","mixins","ctor","__ctor__","properties","statics","editor","__ES6__"];function St(e,t){e.indexOf(t)<0&&e.push(t)}const Tt={datas:null,push(e){if(this.datas)this.datas.push(e);else{this.datas=[e];const t=this;setTimeout((function(){t.init()}),0)}},init(){const e=this.datas;if(e){for(let t=0;t<e.length;++t){const i=e[t],n=i.cls;let s=i.props;"function"==typeof s&&(s=s());const r=le(n);s?Bt(n,r,s,n.$super,i.mixins):S(3633,r)}this.datas=null}}};const Et=[];function At(e,t,i,n,s){st(e,i,"default",n.default),function(e,t){St(e.__props__,t)}(e,i);const r=Ut(e,n,t,i);if(r){const t=Et;for(let n=0;n<r.length;n++){const s=r[n];tt(e,i,s),!1===s.serializable&&St(e.__values__,i),s._onAfterProp&&t.push(s._onAfterProp)}for(let n=0;n<t.length;n++)t[n](e,i);Et.length=0,r.length=0}}function Ct(e,t,i,n,s){const r=n.get,o=n.set,a=e.prototype,c=!Object.getOwnPropertyDescriptor(a,i);if(r){const o=Ut(e,n,t,i);for(let t=0;t<o.length;t++)tt(e,i,o[t]);o.length=0,st(e,i,"serializable",!1),s||oe(a,i,r,c,c)}o&&(s||ae(a,i,o,c,c))}function bt(e){return"function"==typeof e?e():e}function Rt(e,t,i){for(const n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,fe(t,n))}function wt(e,t,i,n){const s=n.__ctor__;let r=n.ctor;const o=n.__ES6__;let a,c;o?(a=[r],c=r):(a=s?[s]:function(e,t,i){const n=[],s=[e].concat(t);for(let e=0;e<s.length;e++){const t=s[e];if(t){const e=(r=t,Nt._isCCClass(r)?r.__ctors__||[]:[r]);for(let t=0;t<e.length;t++)St(n,e[t])}}var r;const o=i.ctor;o&&n.push(o);return n}(t,i,n),c=Dt(a,t,e,n),se(c,"extend",(function(e){return e.extends=this,Nt(e)}),!0)),se(c,"__ctors__",a.length>0?a:null,!0);let l=c.prototype;if(t&&(o||(xe(c,t),l=c.prototype),c.$super=t),i){for(let e=i.length-1;e>=0;e--){const t=i[e];Rt(l,t.prototype),Rt(c,t,(function(e){return t.hasOwnProperty(e)&&!0})),Nt._isCCClass(t)&&Rt(it(c).constructor.prototype,it(t).constructor.prototype)}l.constructor=c}return o||(l.__initProps__=Mt),Re(e,c),c}function It(e){const t=le(e),i=e.constructor;let n="new "+t+"(";for(let t=0;t<i.__props__.length;t++){n+=e[i.__props__[t]],t<i.__props__.length-1&&(n+=",")}return n+")"}function Ot(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}const Pt=/^[A-Za-z_$][0-9A-Za-z_$]*$/;function Mt(e){const t=it(e);let n=e.__props__;null===n&&(Tt.init(),n=e.__props__);const s=function(e,t){const n=[];let s,r="";for(let s=0;s<t.length;s++){const o=t[s],a=o+"$_$default";if(a in e){let t,s;t=Pt.test(o)?"this."+o+"=":"this["+Ot(o)+"]=";const c=e[a];if("object"==typeof c&&c)s=c instanceof i.ValueType?It(c):Array.isArray(c)?"[]":"{}";else if("function"==typeof c){const e=n.length;n.push(c),s="F["+e+"]()"}else s="string"==typeof c?Ot(c):c;t=t+s+";\n",r+=t}}return s=0===n.length?Function(r):Function("F","return (function(){\n"+r+"})")(n),s}(t,n);e.prototype.__initProps__=s,s.call(this)}const Dt=function(e,t,i,n){let s="return function CCClass(){\n";t&&function(e,t,i){let n=!1;for(const i in t){if(xt.indexOf(i)>=0)continue;const s=t[i];if("function"!=typeof s)continue;const r=fe(e.prototype,i);if(r){const e=r.value;if("function"==typeof e){Lt.test(s)&&(n=!0,t[i]=function(e,t){return function(){const i=this._super;this._super=e;const n=t.apply(this,arguments);return this._super=i,n}}(e,s));continue}}}return n}(t,n)&&(s+="this._super=null;\n"),s+="this.__initProps__(CCClass);\n";const r=e.length;if(r>0){const e="].apply(this,arguments);\n";if(1===r)s+="CCClass.__ctors__[0"+e;else{s+="var cs=CCClass.__ctors__;\n";for(let t=0;t<r;t++)s+="cs["+t+e}}return s+="}",Function(s)()};const Lt=/xyz/.test(function(){}.toString())?/\b\._super\b/:/.*/;function Bt(e,t,i,n,s,r){if(e.__props__=[],n&&n.__props__&&(e.__props__=n.__props__.slice()),s)for(let t=0;t<s.length;++t){const i=s[t];i.__props__&&(e.__props__=e.__props__.concat(i.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(i){!function(e,t,i,n){for(const i in e){let n=e[i];const s=ft(n);if(s&&(n=e[i]=s),n){const s=n.notify;s&&dt(n,i,s,e),"type"in n&&pt(n,n.type,t,i),"url"in n&&mt(n,0,0,n.url),"type"in n&&n.type}}}(i,t);for(const n in i){const s=i[n];"default"in s?At(e,t,n,s):Ct(e,t,n,s,r)}}const o=it(e);e.__values__=e.__props__.filter((function(e){return!1!==o[e+"$_$serializable"]}))}function Nt(e){let t=(e=e||{}).name;const n=e.extends,s=e.mixins,r=function(e,t,n,s){const r=i.Component,o=yt();if(o&&Te(t,r)){if(Te(o.cls,r))return S(3615),null;e=e||o.script}const a=wt(e,t,n,s),c=Te(t,i.RenderPipeline),l=Te(t,i.RenderFlow),h=Te(t,i.RenderStage);if(c||l||h||!1){let t="";c?t="render_pipeline":l?t="render_flow":h&&(t="render_stage"),t&&be(e,a)}if(o)if(Te(t,r)){const e=o.uuid;e&&be(e,a),o.cls=a}else Te(o.cls,r)||(o.cls=a);return a}(t,n,s,e);t||(t=i.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);const o=e.properties;"function"==typeof o||n&&null===n.__props__||s&&s.some((function(e){return null===e.__props__}))?(Tt.push({cls:r,props:o,mixins:s}),r.__props__=r.__values__=null):Bt(r,t,o,n,e.mixins,e.__ES6__);const a=e.statics;if(a){let e;for(e in a)r[e]=a[e]}for(const t in e){if(xt.indexOf(t)>=0)continue;const i=e[t];gt(i)&&se(r.prototype,t,i,!0,!0)}const c=e.editor;return c&&Te(n,i.Component)&&i.Component._registerEditorProps(r,c),r}Nt._isCCClass=function(e){return e&&e.hasOwnProperty&&e.hasOwnProperty("__ctors__")},Nt.fastDefine=function(e,t,i){Re(e,t);const n=t.__props__=t.__values__=Object.keys(i),s=nt(t);for(let e=0;e<n.length;e++){const t=n[e];s[t+"$_$visible"]=!1,s[t+"$_$default"]=i[t]}},Nt.Attr=ut,Nt.attr=tt,Nt.getInheritanceChain=function(e){const t=[];for(;e=Se(e);)e!==Object&&t.push(e);return t};const Ft={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"},zt=[];function Ut(e,t,i,n,s){let r=null,o="";function a(){return o=n+"$_$",r=nt(e)}zt.length=0;const c=zt;"type"in t&&void 0===t.type&&y(3660,n,i);const l=t.type;if(l){if(Ft[l])c.push({type:l,_onAfterProp:void 0});else if("Object"===l);else if("object"==typeof l)Ye.isEnum(l)?c.push({type:"Enum",enumList:Ye.getList(l)}):Xe.isBitMask(l)&&c.push({type:"BitMask",bitmaskList:Xe.getList(l)});else if("function"==typeof l){let e;c.push({type:"Object",ctor:l,_onAfterProp:e})}}const h=(e,i)=>{if(e in t){const n=t[e];typeof n===i&&((r||a())[o+e]=n)}};var u;(t.editorOnly&&((r||a())[o+"editorOnly"]=!0),t.url&&((r||a())[o+"saveUrlAsAsset"]=!0),t.__noImplicit)?(r||a())[o+"serializable"]=null!==(u=t.serializable)&&void 0!==u&&u:!1===t.serializable&&((r||a())[o+"serializable"]=!1);h("formerlySerializedAs","string");const _=t.range;return _&&Array.isArray(_)&&_.length>=2&&((r||a())[o+"min"]=_[0],(r||a())[o+"max"]=_[1],_.length>2&&((r||a())[o+"step"]=_[2])),h("min","number"),h("max","number"),h("step","number"),c}Nt.isArray=function(e){return e=bt(e),Array.isArray(e)},Nt.getDefault=bt,Nt.escapeForJS=Ot,Nt.IDENTIFIER_RE=Pt,Nt.getNewValueTypeCode=It,i.Class=Nt;const Gt=Math.PI/180,Ht=180/Math.PI,Vt=e("EPSILON",1e-6);function kt(e,t){return Math.abs(e-t)<=Vt*Math.max(1,Math.abs(e),Math.abs(t))}function Wt(e,t,i){return i=i||Vt,Math.abs(e-t)<=i}function jt(e,t,i){if(t>i){const e=t;t=i,i=e}return e<t?t:e>i?i:e}function qt(e){return e<0?0:e>1?1:e}function Xt(e,t,i){return e+(t-e)*i}function Yt(e){return e*Gt}function Kt(e){return e*Ht}const Zt=e("random",Math.random);function $t(e,t){return Math.random()*(t-e)+e}function Qt(e,t){return Math.floor($t(e,t))}function Jt(e){return(e=(9301*e+49297)%233280)/233280}function ei(e,t,i){return Jt(e)*(i-t)+t}function ti(e,t,i){return Math.floor(ei(e,t,i))}function ii(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function ni(e,t){return e-Math.floor(e/t)*t}function si(e,t){return e=ni(e,2*t),e=t-Math.abs(e-t)}function ri(e,t,i){return(i-e)/(t-e)}function oi(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function ai(e,t){return Math.abs(e)>Math.abs(t)?e:t}class ci extends Qe{static clone(e){return new ci(e.x,e.y)}static copy(e,t){return e.x=t.x,e.y=t.y,e}static set(e,t,i){return e.x=t,e.y=i,e}static add(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}static subtract(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}static multiply(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}static divide(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}static ceil(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}static floor(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}static min(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}static max(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}static round(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}static multiplyScalar(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}static scaleAndAdd(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}static distance(e,t){const i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}static squaredDistance(e,t){const i=t.x-e.x,n=t.y-e.y;return i*i+n*n}static len(e){const t=e.x,i=e.y;return Math.sqrt(t*t+i*i)}static lengthSqr(e){const t=e.x,i=e.y;return t*t+i*i}static negate(e,t){return e.x=-t.x,e.y=-t.y,e}static inverse(e,t){return e.x=1/t.x,e.y=1/t.y,e}static inverseSafe(e,t){const i=t.x,n=t.y;return Math.abs(i)<Vt?e.x=0:e.x=1/i,Math.abs(n)<Vt?e.y=0:e.y=1/n,e}static normalize(e,t){const i=t.x,n=t.y;let s=i*i+n*n;return s>0&&(s=1/Math.sqrt(s),e.x=i*s,e.y=n*s),e}static dot(e,t){return e.x*t.x+e.y*t.y}static cross(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}static lerp(e,t,i,n){const s=t.x,r=t.y;return e.x=s+n*(i.x-s),e.y=r+n*(i.y-r),e}static random(e,t){t=t||1;const i=2*Zt()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}static transformMat3(e,t,i){const n=t.x,s=t.y;return e.x=i.m00*n+i.m03*s+i.m06,e.y=i.m01*n+i.m04*s+i.m07,e}static transformMat4(e,t,i){const n=t.x,s=t.y;return e.x=i.m00*n+i.m04*s+i.m12,e.y=i.m01*n+i.m05*s+i.m13,e}static str(e){return`Vec2(${e.x}, ${e.y})`}static toArray(e,t,i=0){return e[i+0]=t.x,e[i+1]=t.y,e}static fromArray(e,t,i=0){return e.x=t[i+0],e.y=t[i+1],e}static strictEquals(e,t){return e.x===t.x&&e.y===t.y}static equals(e,t,i=Vt){return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))}static angle(e,t){ci.normalize(li,e),ci.normalize(hi,t);const i=ci.dot(li,hi);return i>1?0:i<-1?Math.PI:Math.acos(i)}constructor(e,t){super(),e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0)}clone(){return new ci(this.x,this.y)}set(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this}equals(e,t=Vt){return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))}equals2f(e,t,i=Vt){return Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))}strictEquals(e){return e&&this.x===e.x&&this.y===e.y}strictEquals2f(e,t){return this.x===e&&this.y===t}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}lerp(e,t){const i=this.x,n=this.y;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this}clampf(e,t){return this.x=jt(this.x,e.x,t.x),this.y=jt(this.y,e.y,t.y),this}add(e){return this.x=this.x+e.x,this.y=this.y+e.y,this}add2f(e,t){return this.x=this.x+e,this.y=this.y+t,this}subtract(e){return this.x=this.x-e.x,this.y=this.y-e.y,this}subtract2f(e,t){return this.x=this.x-e,this.y=this.y-t,this}multiplyScalar(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this}multiply(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this}multiply2f(e,t){return this.x=this.x*e,this.y=this.y*t,this}divide(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}divide2f(e,t){return this.x=this.x/e,this.y=this.y/t,this}negative(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSqr(){return this.x*this.x+this.y*this.y}normalize(){const e=this.x,t=this.y;let i=e*e+t*t;return i>0&&(i=1/Math.sqrt(i),this.x=this.x*i,this.y=this.y*i),this}angle(e){const t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;let n=this.dot(e)/Math.sqrt(t*i);return n=jt(n,-1,1),Math.acos(n)}signAngle(e){const t=this.angle(e);return this.cross(e)<0?-t:t}rotate(e){const t=this.x,i=this.y,n=Math.sin(e),s=Math.cos(e);return this.x=s*t-n*i,this.y=n*t+s*i,this}project(e){const t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}transformMat4(e){const t=this.x,i=this.y;return this.x=e.m00*t+e.m04*i+e.m12,this.y=e.m01*t+e.m05*i+e.m13,this}}e("Vec2",ci),ci.ZERO=Object.freeze(new ci(0,0)),ci.ONE=Object.freeze(new ci(1,1)),ci.NEG_ONE=Object.freeze(new ci(-1,-1)),ci.UNIT_X=Object.freeze(new ci(1,0)),ci.UNIT_Y=Object.freeze(new ci(0,1));const li=new ci,hi=new ci;function ui(e,t){return new ci(e,t)}Nt.fastDefine("cc.Vec2",ci,{x:0,y:0}),i.Vec2=ci,i.v2=ui;class _i extends Qe{static zero(e){return e.x=0,e.y=0,e.z=0,e}static clone(e){return new _i(e.x,e.y,e.z)}static copy(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}static set(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}static add(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}static subtract(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}static multiply(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}static divide(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}static ceil(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}static floor(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}static min(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}static max(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}static round(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}static multiplyScalar(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}static scaleAndAdd(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}static distance(e,t){const i=t.x-e.x,n=t.y-e.y,s=t.z-e.z;return Math.sqrt(i*i+n*n+s*s)}static squaredDistance(e,t){const i=t.x-e.x,n=t.y-e.y,s=t.z-e.z;return i*i+n*n+s*s}static len(e){const t=e.x,i=e.y,n=e.z;return Math.sqrt(t*t+i*i+n*n)}static lengthSqr(e){const t=e.x,i=e.y,n=e.z;return t*t+i*i+n*n}static negate(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}static invert(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}static invertSafe(e,t){const i=t.x,n=t.y,s=t.z;return Math.abs(i)<Vt?e.x=0:e.x=1/i,Math.abs(n)<Vt?e.y=0:e.y=1/n,Math.abs(s)<Vt?e.z=0:e.z=1/s,e}static normalize(e,t){const i=t.x,n=t.y,s=t.z;let r=i*i+n*n+s*s;return r>0&&(r=1/Math.sqrt(r),e.x=i*r,e.y=n*r,e.z=s*r),e}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static cross(e,t,i){const{x:n,y:s,z:r}=t,{x:o,y:a,z:c}=i;return e.x=s*c-r*a,e.y=r*o-n*c,e.z=n*a-s*o,e}static lerp(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e}static random(e,t){t=t||1;const i=2*Zt()*Math.PI,n=2*Zt()-1,s=Math.sqrt(1-n*n);return e.x=s*Math.cos(i)*t,e.y=s*Math.sin(i)*t,e.z=n*t,e}static transformMat4(e,t,i){const n=t.x,s=t.y,r=t.z;let o=i.m03*n+i.m07*s+i.m11*r+i.m15;return o=o?Math.abs(1/o):1,e.x=(i.m00*n+i.m04*s+i.m08*r+i.m12)*o,e.y=(i.m01*n+i.m05*s+i.m09*r+i.m13)*o,e.z=(i.m02*n+i.m06*s+i.m10*r+i.m14)*o,e}static transformMat4Normal(e,t,i){const n=t.x,s=t.y,r=t.z;let o=i.m03*n+i.m07*s+i.m11*r;return o=o?Math.abs(1/o):1,e.x=(i.m00*n+i.m04*s+i.m08*r)*o,e.y=(i.m01*n+i.m05*s+i.m09*r)*o,e.z=(i.m02*n+i.m06*s+i.m10*r)*o,e}static transformMat3(e,t,i){const n=t.x,s=t.y,r=t.z;return e.x=n*i.m00+s*i.m03+r*i.m06,e.y=n*i.m01+s*i.m04+r*i.m07,e.z=n*i.m02+s*i.m05+r*i.m08,e}static transformAffine(e,t,i){const n=t.x,s=t.y,r=t.z;return e.x=i.m00*n+i.m04*s+i.m08*r+i.m12,e.y=i.m01*n+i.m05*s+i.m09*r+i.m13,e.x=i.m02*n+i.m06*s+i.m10*r+i.m14,e}static transformQuat(e,t,i){const n=i.w*t.x+i.y*t.z-i.z*t.y,s=i.w*t.y+i.z*t.x-i.x*t.z,r=i.w*t.z+i.x*t.y-i.y*t.x,o=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+o*-i.x+s*-i.z-r*-i.y,e.y=s*i.w+o*-i.y+r*-i.x-n*-i.z,e.z=r*i.w+o*-i.z+n*-i.y-s*-i.x,e}static transformRTS(e,t,i,n,s){const r=t.x*s.x,o=t.y*s.y,a=t.z*s.z,c=i.w*r+i.y*a-i.z*o,l=i.w*o+i.z*r-i.x*a,h=i.w*a+i.x*o-i.y*r,u=-i.x*r-i.y*o-i.z*a;return e.x=c*i.w+u*-i.x+l*-i.z-h*-i.y+n.x,e.y=l*i.w+u*-i.y+h*-i.x-c*-i.z+n.y,e.z=h*i.w+u*-i.z+c*-i.y-l*-i.x+n.z,e}static transformInverseRTS(e,t,i,n,s){const r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,c=i.w*r-i.y*a+i.z*o,l=i.w*o-i.z*r+i.x*a,h=i.w*a-i.x*o+i.y*r,u=i.x*r+i.y*o+i.z*a;return e.x=(c*i.w+u*i.x+l*i.z-h*i.y)/s.x,e.y=(l*i.w+u*i.y+h*i.x-c*i.z)/s.y,e.z=(h*i.w+u*i.z+c*i.y-l*i.x)/s.z,e}static rotateX(e,t,i,n){const s=t.x-i.x,r=t.y-i.y,o=t.z-i.z,a=Math.cos(n),c=Math.sin(n),l=s,h=r*a-o*c,u=r*c+o*a;return e.x=l+i.x,e.y=h+i.y,e.z=u+i.z,e}static rotateY(e,t,i,n){const s=t.x-i.x,r=t.y-i.y,o=t.z-i.z,a=Math.cos(n),c=Math.sin(n),l=o*c+s*a,h=r,u=o*a-s*c;return e.x=l+i.x,e.y=h+i.y,e.z=u+i.z,e}static rotateZ(e,t,i,n){const s=t.x-i.x,r=t.y-i.y,o=t.z-i.z,a=Math.cos(n),c=Math.sin(n),l=s*a-r*c,h=s*c+r*a,u=o;return e.x=l+i.x,e.y=h+i.y,e.z=u+i.z,e}static toArray(e,t,i=0){return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e}static fromArray(e,t,i=0){return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e}static strictEquals(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}static equals(e,t,i=Vt){const{x:n,y:s,z:r}=e,{x:o,y:a,z:c}=t;return Math.abs(n-o)<=i*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(s-a)<=i*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(r-c)<=i*Math.max(1,Math.abs(r),Math.abs(c))}static angle(e,t){_i.normalize(di,e),_i.normalize(mi,t);const i=_i.dot(di,mi);return i>1?0:i<-1?Math.PI:Math.acos(i)}static projectOnPlane(e,t,i){return _i.subtract(e,t,_i.project(e,t,i))}static project(e,t,i){const n=_i.lengthSqr(i);return n<1e-6?_i.set(e,0,0,0):_i.multiplyScalar(e,i,_i.dot(t,i)/n)}constructor(e,t,i){super(),e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=i||0)}clone(){return new _i(this.x,this.y,this.z)}set(e,t,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=i||0),this}equals(e,t=Vt){return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))}equals3f(e,t,i,n=Vt){return Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=n*Math.max(1,Math.abs(this.z),Math.abs(i))}strictEquals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}strictEquals3f(e,t,i){return this.x===e&&this.y===t&&this.z===i}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)})`}lerp(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this}add(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this}add3f(e,t,i){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this}subtract(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this}subtract3f(e,t,i){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this}multiplyScalar(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this}multiply(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this}multiply3f(e,t,i){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this}divide(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this}divide3f(e,t,i){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}clampf(e,t){return this.x=jt(this.x,e.x,t.x),this.y=jt(this.y,e.y,t.y),this.z=jt(this.z,e.z,t.z),this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e){const{x:t,y:i,z:n}=this,{x:s,y:r,z:o}=e;return this.x=i*o-n*r,this.y=n*s-t*o,this.z=t*r-i*s,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSqr(){return this.x*this.x+this.y*this.y+this.z*this.z}normalize(){const e=this.x,t=this.y,i=this.z;let n=e*e+t*t+i*i;return n>0&&(n=1/Math.sqrt(n),this.x=e*n,this.y=t*n,this.z=i*n),this}transformMat4(e){const t=this.x,i=this.y,n=this.z;let s=e.m03*t+e.m07*i+e.m11*n+e.m15;return s=s?1/s:1,this.x=(e.m00*t+e.m04*i+e.m08*n+e.m12)*s,this.y=(e.m01*t+e.m05*i+e.m09*n+e.m13)*s,this.z=(e.m02*t+e.m06*i+e.m10*n+e.m14)*s,this}}e("Vec3",_i),_i.UNIT_X=Object.freeze(new _i(1,0,0)),_i.UNIT_Y=Object.freeze(new _i(0,1,0)),_i.UNIT_Z=Object.freeze(new _i(0,0,1)),_i.RIGHT=Object.freeze(new _i(1,0,0)),_i.UP=Object.freeze(new _i(0,1,0)),_i.FORWARD=Object.freeze(new _i(0,0,-1)),_i.ZERO=Object.freeze(new _i(0,0,0)),_i.ONE=Object.freeze(new _i(1,1,1)),_i.NEG_ONE=Object.freeze(new _i(-1,-1,-1));const di=new _i,mi=new _i;function pi(e,t,i){return new _i(e,t,i)}Nt.fastDefine("cc.Vec3",_i,{x:0,y:0,z:0}),i.Vec3=_i,i.v3=pi;class fi extends Qe{static clone(e){return new fi(e.x,e.y,e.z,e.w)}static copy(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}static set(e,t,i,n,s){return e.x=t,e.y=i,e.z=n,e.w=s,e}static add(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}static subtract(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}static multiply(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}static divide(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}static ceil(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}static floor(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}static min(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}static max(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}static round(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}static multiplyScalar(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}static scaleAndAdd(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}static distance(e,t){const i=t.x-e.x,n=t.y-e.y,s=t.z-e.z,r=t.w-e.w;return Math.sqrt(i*i+n*n+s*s+r*r)}static squaredDistance(e,t){const i=t.x-e.x,n=t.y-e.y,s=t.z-e.z,r=t.w-e.w;return i*i+n*n+s*s+r*r}static len(e){const t=e.x,i=e.y,n=e.z,s=e.w;return Math.sqrt(t*t+i*i+n*n+s*s)}static lengthSqr(e){const t=e.x,i=e.y,n=e.z,s=e.w;return t*t+i*i+n*n+s*s}static negate(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}static inverse(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}static inverseSafe(e,t){const i=t.x,n=t.y,s=t.z,r=t.w;return Math.abs(i)<Vt?e.x=0:e.x=1/i,Math.abs(n)<Vt?e.y=0:e.y=1/n,Math.abs(s)<Vt?e.z=0:e.z=1/s,Math.abs(r)<Vt?e.w=0:e.w=1/r,e}static normalize(e,t){const i=t.x,n=t.y,s=t.z,r=t.w;let o=i*i+n*n+s*s+r*r;return o>0&&(o=1/Math.sqrt(o),e.x=i*o,e.y=n*o,e.z=s*o,e.w=r*o),e}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static lerp(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}static random(e,t){t=t||1;const i=2*Zt()*Math.PI,n=2*Zt()-1,s=Math.sqrt(1-n*n);return e.x=s*Math.cos(i)*t,e.y=s*Math.sin(i)*t,e.z=n*t,e.w=0,e}static transformMat4(e,t,i){const n=t.x,s=t.y,r=t.z,o=t.w;return e.x=i.m00*n+i.m04*s+i.m08*r+i.m12*o,e.y=i.m01*n+i.m05*s+i.m09*r+i.m13*o,e.z=i.m02*n+i.m06*s+i.m10*r+i.m14*o,e.w=i.m03*n+i.m07*s+i.m11*r+i.m15*o,e}static transformAffine(e,t,i){const n=t.x,s=t.y,r=t.z,o=t.w;return e.x=i.m00*n+i.m01*s+i.m02*r+i.m03*o,e.y=i.m04*n+i.m05*s+i.m06*r+i.m07*o,e.x=i.m08*n+i.m09*s+i.m10*r+i.m11*o,e.w=t.w,e}static transformQuat(e,t,i){const{x:n,y:s,z:r}=t,o=i.x,a=i.y,c=i.z,l=i.w,h=l*n+a*r-c*s,u=l*s+c*n-o*r,_=l*r+o*s-a*n,d=-o*n-a*s-c*r;return e.x=h*l+d*-o+u*-c-_*-a,e.y=u*l+d*-a+_*-o-h*-c,e.z=_*l+d*-c+h*-a-u*-o,e.w=t.w,e}static toArray(e,t,i=0){return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}static fromArray(e,t,i=0){return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}static strictEquals(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}static equals(e,t,i=Vt){return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}constructor(e,t,i,n){super(),e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||0)}clone(){return new fi(this.x,this.y,this.z,this.w)}set(e,t,i,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||0),this}equals(e,t=Vt){return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}equals4f(e,t,i,n,s=Vt){return Math.abs(this.x-e)<=s*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=s*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=s*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=s*Math.max(1,Math.abs(this.w),Math.abs(n))}strictEquals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}strictEquals4f(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}lerp(e,t){const i=this.x,n=this.y,s=this.z,r=this.w;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this.z=s+t*(e.z-s),this.w=r+t*(e.w-r),this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)}, ${this.w.toFixed(2)})`}clampf(e,t){return this.x=jt(this.x,e.x,t.x),this.y=jt(this.y,e.y,t.y),this.z=jt(this.z,e.z,t.z),this.w=jt(this.w,e.w,t.w),this}add(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this.w=this.w+e.w,this}add4f(e,t,i,n){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this.w=this.w+n,this}subtract(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this.w=this.w-e.w,this}subtract4f(e,t,i,n){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this.w=this.w-n,this}multiplyScalar(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e,this}multiply(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this.w=this.w*e.w,this}multiply4f(e,t,i,n){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this.w=this.w*n,this}divide(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this.w=this.w/e.w,this}divide4f(e,t,i,n){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this.w=this.w/n,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}cross(e){const{x:t,y:i,z:n}=this,{x:s,y:r,z:o}=e;return this.x=i*o-n*r,this.y=n*s-t*o,this.z=t*r-i*s,this}length(){const e=this.x,t=this.y,i=this.z,n=this.w;return Math.sqrt(e*e+t*t+i*i+n*n)}lengthSqr(){const e=this.x,t=this.y,i=this.z,n=this.w;return e*e+t*t+i*i+n*n}normalize(){const e=this.x,t=this.y,i=this.z,n=this.w;let s=e*e+t*t+i*i+n*n;return s>0&&(s=1/Math.sqrt(s),this.x=e*s,this.y=t*s,this.z=i*s,this.w=n*s),this}transformMat4(e){const t=this.x,i=this.y,n=this.z,s=this.w;return this.x=e.m00*t+e.m04*i+e.m08*n+e.m12*s,this.y=e.m01*t+e.m05*i+e.m09*n+e.m13*s,this.z=e.m02*t+e.m06*i+e.m10*n+e.m14*s,this.w=e.m03*t+e.m07*i+e.m11*n+e.m15*s,this}}function gi(e,t,i,n){return new fi(e,t,i,n)}e("Vec4",fi),fi.ZERO=Object.freeze(new fi(0,0,0,0)),fi.ONE=Object.freeze(new fi(1,1,1,1)),fi.NEG_ONE=Object.freeze(new fi(-1,-1,-1,-1)),Nt.fastDefine("cc.Vec4",fi,{x:0,y:0,z:0,w:0}),i.Vec4=fi,i.v4=gi;class vi extends Qe{static clone(e){return new vi(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}static copy(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}static set(e,t,i,n,s,r,o,a,c,l){return e.m00=t,e.m01=i,e.m02=n,e.m03=s,e.m04=r,e.m05=o,e.m06=a,e.m07=c,e.m08=l,e}static identity(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}static transpose(e,t){if(e===t){const i=t.m01,n=t.m02,s=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=i,e.m05=t.m07,e.m06=n,e.m07=s}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e}static invert(e,t){const i=t.m00,n=t.m01,s=t.m02,r=t.m03,o=t.m04,a=t.m05,c=t.m06,l=t.m07,h=t.m08,u=h*o-a*l,_=-h*r+a*c,d=l*r-o*c;let m=i*u+n*_+s*d;return 0===m?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(m=1/m,e.m00=u*m,e.m01=(-h*n+s*l)*m,e.m02=(a*n-s*o)*m,e.m03=_*m,e.m04=(h*i-s*c)*m,e.m05=(-a*i+s*r)*m,e.m06=d*m,e.m07=(-l*i+n*c)*m,e.m08=(o*i-n*r)*m,e)}static determinant(e){const t=e.m00,i=e.m01,n=e.m02,s=e.m03,r=e.m04,o=e.m05,a=e.m06,c=e.m07,l=e.m08;return t*(l*r-o*c)+i*(-l*s+o*a)+n*(c*s-r*a)}static multiply(e,t,i){const n=t.m00,s=t.m01,r=t.m02,o=t.m03,a=t.m04,c=t.m05,l=t.m06,h=t.m07,u=t.m08,_=i.m00,d=i.m01,m=i.m02,p=i.m03,f=i.m04,g=i.m05,v=i.m06,y=i.m07,x=i.m08;return e.m00=_*n+d*o+m*l,e.m01=_*s+d*a+m*h,e.m02=_*r+d*c+m*u,e.m03=p*n+f*o+g*l,e.m04=p*s+f*a+g*h,e.m05=p*r+f*c+g*u,e.m06=v*n+y*o+x*l,e.m07=v*s+y*a+x*h,e.m08=v*r+y*c+x*u,e}static multiplyMat4(e,t,i){const n=t.m00,s=t.m01,r=t.m02,o=t.m03,a=t.m04,c=t.m05,l=t.m06,h=t.m07,u=t.m08,_=i.m00,d=i.m01,m=i.m02,p=i.m04,f=i.m05,g=i.m06,v=i.m08,y=i.m09,x=i.m10;return e.m00=_*n+d*o+m*l,e.m01=_*s+d*a+m*h,e.m02=_*r+d*c+m*u,e.m03=p*n+f*o+g*l,e.m04=p*s+f*a+g*h,e.m05=p*r+f*c+g*u,e.m06=v*n+y*o+x*l,e.m07=v*s+y*a+x*h,e.m08=v*r+y*c+x*u,e}static transfrom(e,t,i){vi.transform(e,t,i)}static transform(e,t,i){const n=t.m00,s=t.m01,r=t.m02,o=t.m03,a=t.m04,c=t.m05,l=t.m06,h=t.m07,u=t.m08,_=i.x,d=i.y;return e.m00=n,e.m01=s,e.m02=r,e.m03=o,e.m04=a,e.m05=c,e.m06=_*n+d*o+l,e.m07=_*s+d*a+h,e.m08=_*r+d*c+u,e}static scale(e,t,i){const n=i.x,s=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=s*t.m03,e.m04=s*t.m04,e.m05=s*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}static rotate(e,t,i){const n=t.m00,s=t.m01,r=t.m02,o=t.m03,a=t.m04,c=t.m05,l=t.m06,h=t.m07,u=t.m08,_=Math.sin(i),d=Math.cos(i);return e.m00=d*n+_*o,e.m01=d*s+_*a,e.m02=d*r+_*c,e.m03=d*o-_*n,e.m04=d*a-_*s,e.m05=d*c-_*r,e.m06=l,e.m07=h,e.m08=u,e}static fromMat4(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}static fromViewUp(e,t,i){return _i.lengthSqr(t)<Vt*Vt?(vi.identity(e),e):(i=i||_i.UNIT_Y,_i.normalize(yi,_i.cross(yi,i,t)),_i.lengthSqr(yi)<Vt*Vt?(vi.identity(e),e):(_i.cross(xi,t,yi),vi.set(e,yi.x,yi.y,yi.z,xi.x,xi.y,xi.z,t.x,t.y,t.z),e))}static fromTranslation(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}static fromScaling(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}static fromRotation(e,t){const i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}static fromQuat(e,t){const i=t.x,n=t.y,s=t.z,r=t.w,o=i+i,a=n+n,c=s+s,l=i*o,h=n*o,u=n*a,_=s*o,d=s*a,m=s*c,p=r*o,f=r*a,g=r*c;return e.m00=1-u-m,e.m03=h-g,e.m06=_+f,e.m01=h+g,e.m04=1-l-m,e.m07=d-p,e.m02=_-f,e.m05=d+p,e.m08=1-l-u,e}static inverseTransposeMat4(e,t){const i=t.m00,n=t.m01,s=t.m02,r=t.m03,o=t.m04,a=t.m05,c=t.m06,l=t.m07,h=t.m08,u=t.m09,_=t.m10,d=t.m11,m=t.m12,p=t.m13,f=t.m14,g=t.m15,v=i*a-n*o,y=i*c-s*o,x=i*l-r*o,S=n*c-s*a,T=n*l-r*a,E=s*l-r*c,A=h*p-u*m,C=h*f-_*m,b=h*g-d*m,R=u*f-_*p,w=u*g-d*p,I=_*g-d*f;let O=v*I-y*w+x*R+S*b-T*C+E*A;return O?(O=1/O,e.m00=(a*I-c*w+l*R)*O,e.m01=(c*b-o*I-l*C)*O,e.m02=(o*w-a*b+l*A)*O,e.m03=(s*w-n*I-r*R)*O,e.m04=(i*I-s*b+r*C)*O,e.m05=(n*b-i*w-r*A)*O,e.m06=(p*E-f*T+g*S)*O,e.m07=(f*x-m*E-g*y)*O,e.m08=(m*T-p*x+g*v)*O,e):null}static toArray(e,t,i=0){return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e}static fromArray(e,t,i=0){return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e}static add(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}static subtract(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}static multiplyScalar(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}static multiplyScalarAndAdd(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e}static strictEquals(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}static equals(e,t,i=Vt){return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}constructor(e=1,t=0,i=0,n=0,s=1,r=0,o=0,a=0,c=1){super(),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=i,this.m03=n,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=c)}clone(){const e=this;return new vi(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}set(e=1,t=0,i=0,n=0,s=1,r=0,o=0,a=0,c=1){return"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=i,this.m03=n,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=c),this}equals(e,t=Vt){return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}strictEquals(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}toString(){const e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"}identity(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}transpose(){const e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this}invert(){const e=this.m00,t=this.m01,i=this.m02,n=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,c=this.m08,l=c*s-r*a,h=-c*n+r*o,u=a*n-s*o;let _=e*l+t*h+i*u;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*t+i*a)*_,this.m02=(r*t-i*s)*_,this.m03=h*_,this.m04=(c*e-i*o)*_,this.m05=(-r*e+i*n)*_,this.m06=u*_,this.m07=(-a*e+t*o)*_,this.m08=(s*e-t*n)*_,this)}determinant(){const e=this.m00,t=this.m01,i=this.m02,n=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,c=this.m08;return e*(c*s-r*a)+t*(-c*n+r*o)+i*(a*n-s*o)}add(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this}subtract(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this}multiply(e){const t=this.m00,i=this.m01,n=this.m02,s=this.m03,r=this.m04,o=this.m05,a=this.m06,c=this.m07,l=this.m08,h=e.m00,u=e.m01,_=e.m02,d=e.m03,m=e.m04,p=e.m05,f=e.m06,g=e.m07,v=e.m08;return this.m00=h*t+u*s+_*a,this.m01=h*i+u*r+_*c,this.m02=h*n+u*o+_*l,this.m03=d*t+m*s+p*a,this.m04=d*i+m*r+p*c,this.m05=d*n+m*o+p*l,this.m06=f*t+g*s+v*a,this.m07=f*i+g*r+v*c,this.m08=f*n+g*o+v*l,this}multiplyScalar(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this}scale(e){const t=e.x,i=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}rotate(e){const t=this.m00,i=this.m01,n=this.m02,s=this.m03,r=this.m04,o=this.m05,a=this.m06,c=this.m07,l=this.m08,h=Math.sin(e),u=Math.cos(e);return this.m00=u*t+h*s,this.m01=u*i+h*r,this.m02=u*n+h*o,this.m03=u*s-h*t,this.m04=u*r-h*i,this.m05=u*o-h*n,this.m06=a,this.m07=c,this.m08=l,this}fromQuat(e){const t=e.x,i=e.y,n=e.z,s=e.w,r=t+t,o=i+i,a=n+n,c=t*r,l=i*r,h=i*o,u=n*r,_=n*o,d=n*a,m=s*r,p=s*o,f=s*a;return this.m00=1-h-d,this.m03=l-f,this.m06=u+p,this.m01=l+f,this.m04=1-c-d,this.m07=_-m,this.m02=u-p,this.m05=_+m,this.m08=1-c-h,this}}e("Mat3",vi),vi.IDENTITY=Object.freeze(new vi);const yi=new _i,xi=new _i;Nt.fastDefine("cc.Mat3",vi,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),i.Mat3=vi;class Si extends Qe{static clone(e){return new Si(e.x,e.y,e.z,e.w)}static copy(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}static set(e,t,i,n,s){return e.x=t,e.y=i,e.z=n,e.w=s,e}static identity(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}static rotationTo(e,t,i){const n=_i.dot(t,i);return n<-.999999?(_i.cross(Ai,_i.UNIT_X,t),Ai.length()<1e-6&&_i.cross(Ai,_i.UNIT_Y,t),_i.normalize(Ai,Ai),Si.fromAxisAngle(e,Ai,Math.PI),e):n>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(_i.cross(Ai,t,i),e.x=Ai.x,e.y=Ai.y,e.z=Ai.z,e.w=1+n,Si.normalize(e,e))}static getAxisAngle(e,t){const i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i}static multiply(e,t,i){const n=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,s=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,r=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,o=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z;return e.x=n,e.y=s,e.z=r,e.w=o,e}static multiplyScalar(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}static scaleAndAdd(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}static rotateX(e,t,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:c}=t;return e.x=r*s+c*n,e.y=o*s+a*n,e.z=a*s-o*n,e.w=c*s-r*n,e}static rotateY(e,t,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:c}=t;return e.x=r*s-a*n,e.y=o*s+c*n,e.z=a*s+r*n,e.w=c*s-o*n,e}static rotateZ(e,t,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:c}=t;return e.x=r*s+o*n,e.y=o*s-r*n,e.z=a*s+c*n,e.w=c*s-a*n,e}static rotateAround(e,t,i,n){return Si.invert(Ti,t),_i.transformQuat(Ai,i,Ti),Si.fromAxisAngle(Ti,Ai,n),Si.multiply(e,t,Ti),e}static rotateAroundLocal(e,t,i,n){return Si.fromAxisAngle(Ti,i,n),Si.multiply(e,t,Ti),e}static calculateW(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static lerp(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}static slerp(e,t,i,n){let s=0,r=0,o=i.x,a=i.y,c=i.z,l=i.w,h=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(h<0&&(h=-h,o=-o,a=-a,c=-c,l=-l),1-h>1e-6){const e=Math.acos(h),t=Math.sin(e);s=Math.sin((1-n)*e)/t,r=Math.sin(n*e)/t}else s=1-n,r=n;return e.x=s*t.x+r*o,e.y=s*t.y+r*a,e.z=s*t.z+r*c,e.w=s*t.w+r*l,e}static sqlerp(e,t,i,n,s,r){return Si.slerp(Ti,t,s,r),Si.slerp(Ei,i,n,r),Si.slerp(e,Ti,Ei,2*r*(1-r)),e}static invert(e,t){const i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,n=i?1/i:0;return e.x=-t.x*n,e.y=-t.y*n,e.z=-t.z*n,e.w=t.w*n,e}static conjugate(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}static len(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}static lengthSqr(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}static normalize(e,t){let i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return i>0&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e}static fromAxes(e,t,i,n){return vi.set(Ci,t.x,t.y,t.z,i.x,i.y,i.z,n.x,n.y,n.z),Si.normalize(e,Si.fromMat3(e,Ci))}static fromViewUp(e,t,i){return vi.fromViewUp(Ci,t,i),Si.normalize(e,Si.fromMat3(e,Ci))}static fromAxisAngle(e,t,i){i*=.5;const n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}static fromMat3(e,t){const{m00:i,m03:n,m06:s,m01:r,m04:o,m07:a,m02:c,m05:l,m08:h}=t,u=i+o+h;if(u>0){const t=.5/Math.sqrt(u+1);e.w=.25/t,e.x=(l-a)*t,e.y=(s-c)*t,e.z=(r-n)*t}else if(i>o&&i>h){const t=2*Math.sqrt(1+i-o-h);e.w=(l-a)/t,e.x=.25*t,e.y=(n+r)/t,e.z=(s+c)/t}else if(o>h){const t=2*Math.sqrt(1+o-i-h);e.w=(s-c)/t,e.x=(n+r)/t,e.y=.25*t,e.z=(a+l)/t}else{const t=2*Math.sqrt(1+h-i-o);e.w=(r-n)/t,e.x=(s+c)/t,e.y=(a+l)/t,e.z=.25*t}return e}static fromEuler(e,t,i,n){t*=bi,i*=bi,n*=bi;const s=Math.sin(t),r=Math.cos(t),o=Math.sin(i),a=Math.cos(i),c=Math.sin(n),l=Math.cos(n);return e.x=s*a*l+r*o*c,e.y=r*o*l+s*a*c,e.z=r*a*c-s*o*l,e.w=r*a*l-s*o*c,e}static toAxisX(e,t){const i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e}static toAxisY(e,t){const i=2*t.x,n=2*t.y,s=2*t.z;return e.x=n*t.x-s*t.w,e.y=1-i*t.x-s*t.z,e.z=s*t.y+i*t.w,e}static toAxisZ(e,t){const i=2*t.x,n=2*t.y,s=2*t.z;return e.x=s*t.x-n*t.w,e.y=s*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e}static toEuler(e,t,i){const{x:n,y:s,z:r,w:o}=t;let a=0,c=0,l=0;const h=n*s+r*o;if(h>.499999)a=0,c=Kt(2*Math.atan2(n,o)),l=90;else if(h<-.499999)a=0,c=-Kt(2*Math.atan2(n,o)),l=-90;else{const e=n*n,t=s*s,u=r*r;a=Kt(Math.atan2(2*n*o-2*s*r,1-2*e-2*u)),c=Kt(Math.atan2(2*s*o-2*n*r,1-2*t-2*u)),l=Kt(Math.asin(2*h)),i&&(a=-180*Math.sign(a+1e-6)+a,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=a,e.y=c,e.z=l,e}static toArray(e,t,i=0){return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}static fromArray(e,t,i=0){return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}static strictEquals(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}static equals(e,t,i=Vt){return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}constructor(e,t,i,n){super(),e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=null!=n?n:1)}clone(){return new Si(this.x,this.y,this.z,this.w)}set(e,t,i,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=null!=n?n:1),this}equals(e,t=Vt){return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}strictEquals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}getEulerAngles(e){return Si.toEuler(e,this)}lerp(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this.w=this.w+t*(e.w-this.w),this}slerp(e,t){return Si.slerp(this,this,e,t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSqr(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}e("Quat",Si),Si.IDENTITY=Object.freeze(new Si);const Ti=new Si,Ei=new Si,Ai=new _i,Ci=new vi,bi=.5*Math.PI/180;function Ri(e=0,t=0,i=0,n=1){return new Si(e,t,i,n)}Nt.fastDefine("cc.Quat",Si,{x:0,y:0,z:0,w:1}),i.Quat=Si,i.quat=Ri;class wi extends Qe{static clone(e){return new wi(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}static copy(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}static set(e,t,i,n,s,r,o,a,c,l,h,u,_,d,m,p,f){return e.m00=t,e.m01=i,e.m02=n,e.m03=s,e.m04=r,e.m05=o,e.m06=a,e.m07=c,e.m08=l,e.m09=h,e.m10=u,e.m11=_,e.m12=d,e.m13=m,e.m14=p,e.m15=f,e}static identity(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static transpose(e,t){if(e===t){const i=t.m01,n=t.m02,s=t.m03,r=t.m06,o=t.m07,a=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=r,e.m11=t.m14,e.m12=s,e.m13=o,e.m14=a}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}static invert(e,t){const i=t.m00,n=t.m01,s=t.m02,r=t.m03,o=t.m04,a=t.m05,c=t.m06,l=t.m07,h=t.m08,u=t.m09,_=t.m10,d=t.m11,m=t.m12,p=t.m13,f=t.m14,g=t.m15,v=i*a-n*o,y=i*c-s*o,x=i*l-r*o,S=n*c-s*a,T=n*l-r*a,E=s*l-r*c,A=h*p-u*m,C=h*f-_*m,b=h*g-d*m,R=u*f-_*p,w=u*g-d*p,I=_*g-d*f;let O=v*I-y*w+x*R+S*b-T*C+E*A;return 0===O?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(O=1/O,e.m00=(a*I-c*w+l*R)*O,e.m01=(s*w-n*I-r*R)*O,e.m02=(p*E-f*T+g*S)*O,e.m03=(_*T-u*E-d*S)*O,e.m04=(c*b-o*I-l*C)*O,e.m05=(i*I-s*b+r*C)*O,e.m06=(f*x-m*E-g*y)*O,e.m07=(h*E-_*x+d*y)*O,e.m08=(o*w-a*b+l*A)*O,e.m09=(n*b-i*w-r*A)*O,e.m10=(m*T-p*x+g*v)*O,e.m11=(u*x-h*T-d*v)*O,e.m12=(a*C-o*R-c*A)*O,e.m13=(i*R-n*C+s*A)*O,e.m14=(p*y-m*S-f*v)*O,e.m15=(h*S-u*y+_*v)*O,e)}static determinant(e){const t=e.m00,i=e.m01,n=e.m02,s=e.m03,r=e.m04,o=e.m05,a=e.m06,c=e.m07,l=e.m08,h=e.m09,u=e.m10,_=e.m11,d=e.m12,m=e.m13,p=e.m14,f=e.m15;return(t*o-i*r)*(u*f-_*p)-(t*a-n*r)*(h*f-_*m)+(t*c-s*r)*(h*p-u*m)+(i*a-n*o)*(l*f-_*d)-(i*c-s*o)*(l*p-u*d)+(n*c-s*a)*(l*m-h*d)}static multiply(e,t,i){const n=t.m00,s=t.m01,r=t.m02,o=t.m03,a=t.m04,c=t.m05,l=t.m06,h=t.m07,u=t.m08,_=t.m09,d=t.m10,m=t.m11,p=t.m12,f=t.m13,g=t.m14,v=t.m15;let y=i.m00,x=i.m01,S=i.m02,T=i.m03;return e.m00=y*n+x*a+S*u+T*p,e.m01=y*s+x*c+S*_+T*f,e.m02=y*r+x*l+S*d+T*g,e.m03=y*o+x*h+S*m+T*v,y=i.m04,x=i.m05,S=i.m06,T=i.m07,e.m04=y*n+x*a+S*u+T*p,e.m05=y*s+x*c+S*_+T*f,e.m06=y*r+x*l+S*d+T*g,e.m07=y*o+x*h+S*m+T*v,y=i.m08,x=i.m09,S=i.m10,T=i.m11,e.m08=y*n+x*a+S*u+T*p,e.m09=y*s+x*c+S*_+T*f,e.m10=y*r+x*l+S*d+T*g,e.m11=y*o+x*h+S*m+T*v,y=i.m12,x=i.m13,S=i.m14,T=i.m15,e.m12=y*n+x*a+S*u+T*p,e.m13=y*s+x*c+S*_+T*f,e.m14=y*r+x*l+S*d+T*g,e.m15=y*o+x*h+S*m+T*v,e}static transform(e,t,i){const n=i.x,s=i.y,r=i.z;if(t===e)e.m12=t.m00*n+t.m04*s+t.m08*r+t.m12,e.m13=t.m01*n+t.m05*s+t.m09*r+t.m13,e.m14=t.m02*n+t.m06*s+t.m10*r+t.m14,e.m15=t.m03*n+t.m07*s+t.m11*r+t.m15;else{const i=t.m00,o=t.m01,a=t.m02,c=t.m03,l=t.m04,h=t.m05,u=t.m06,_=t.m07,d=t.m08,m=t.m09,p=t.m10,f=t.m11;t.m12,t.m13,t.m14,t.m15;e.m00=i,e.m01=o,e.m02=a,e.m03=c,e.m04=l,e.m05=h,e.m06=u,e.m07=_,e.m08=d,e.m09=m,e.m10=p,e.m11=f,e.m12=i*n+l*s+d*r+t.m12,e.m13=o*n+h*s+m*r+t.m13,e.m14=a*n+u*s+p*r+t.m14,e.m15=c*n+_*s+f*r+t.m15}return e}static translate(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}static scale(e,t,i){const n=i.x,s=i.y,r=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*s,e.m05=t.m05*s,e.m06=t.m06*s,e.m07=t.m07*s,e.m08=t.m08*r,e.m09=t.m09*r,e.m10=t.m10*r,e.m11=t.m11*r,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}static rotate(e,t,i,n){let s=n.x,r=n.y,o=n.z,a=Math.sqrt(s*s+r*r+o*o);if(Math.abs(a)<Vt)return null;a=1/a,s*=a,r*=a,o*=a;const c=Math.sin(i),l=Math.cos(i),h=1-l,u=t.m00,_=t.m01,d=t.m02,m=t.m03,p=t.m04,f=t.m05,g=t.m06,v=t.m07,y=t.m08,x=t.m09,S=t.m10,T=t.m11,E=s*s*h+l,A=r*s*h+o*c,C=o*s*h-r*c,b=s*r*h-o*c,R=r*r*h+l,w=o*r*h+s*c,I=s*o*h+r*c,O=r*o*h-s*c,P=o*o*h+l;return e.m00=u*E+p*A+y*C,e.m01=_*E+f*A+x*C,e.m02=d*E+g*A+S*C,e.m03=m*E+v*A+T*C,e.m04=u*b+p*R+y*w,e.m05=_*b+f*R+x*w,e.m06=d*b+g*R+S*w,e.m07=m*b+v*R+T*w,e.m08=u*I+p*O+y*P,e.m09=_*I+f*O+x*P,e.m10=d*I+g*O+S*P,e.m11=m*I+v*O+T*P,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}static rotateX(e,t,i){const n=Math.sin(i),s=Math.cos(i),r=t.m04,o=t.m05,a=t.m06,c=t.m07,l=t.m08,h=t.m09,u=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=r*s+l*n,e.m05=o*s+h*n,e.m06=a*s+u*n,e.m07=c*s+_*n,e.m08=l*s-r*n,e.m09=h*s-o*n,e.m10=u*s-a*n,e.m11=_*s-c*n,e}static rotateY(e,t,i){const n=Math.sin(i),s=Math.cos(i),r=t.m00,o=t.m01,a=t.m02,c=t.m03,l=t.m08,h=t.m09,u=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=r*s-l*n,e.m01=o*s-h*n,e.m02=a*s-u*n,e.m03=c*s-_*n,e.m08=r*n+l*s,e.m09=o*n+h*s,e.m10=a*n+u*s,e.m11=c*n+_*s,e}static rotateZ(e,t,i){const n=Math.sin(i),s=Math.cos(i),r=t.m00,o=t.m01,a=t.m02,c=t.m03,l=t.m04,h=t.m05,u=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=r*s+l*n,e.m01=o*s+h*n,e.m02=a*s+u*n,e.m03=c*s+_*n,e.m04=l*s-r*n,e.m05=h*s-o*n,e.m06=u*s-a*n,e.m07=_*s-c*n,e}static fromTranslation(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}static fromScaling(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static fromRotation(e,t,i){let n=i.x,s=i.y,r=i.z,o=Math.sqrt(n*n+s*s+r*r);if(Math.abs(o)<Vt)return null;o=1/o,n*=o,s*=o,r*=o;const a=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=n*n*l+c,e.m01=s*n*l+r*a,e.m02=r*n*l-s*a,e.m03=0,e.m04=n*s*l-r*a,e.m05=s*s*l+c,e.m06=r*s*l+n*a,e.m07=0,e.m08=n*r*l+s*a,e.m09=s*r*l-n*a,e.m10=r*r*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static fromXRotation(e,t){const i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static fromYRotation(e,t){const i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static fromZRotation(e,t){const i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static fromRT(e,t,i){const n=t.x,s=t.y,r=t.z,o=t.w,a=n+n,c=s+s,l=r+r,h=n*a,u=n*c,_=n*l,d=s*c,m=s*l,p=r*l,f=o*a,g=o*c,v=o*l;return e.m00=1-(d+p),e.m01=u+v,e.m02=_-g,e.m03=0,e.m04=u-v,e.m05=1-(h+p),e.m06=m+f,e.m07=0,e.m08=_+g,e.m09=m-f,e.m10=1-(h+d),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}static getTranslation(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}static getScaling(e,t){const i=Oi.m00=t.m00,n=Oi.m01=t.m01,s=Oi.m02=t.m02,r=Oi.m03=t.m04,o=Oi.m04=t.m05,a=Oi.m05=t.m06,c=Oi.m06=t.m08,l=Oi.m07=t.m09,h=Oi.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+s*s),e.y=Math.sqrt(r*r+o*o+a*a),e.z=Math.sqrt(c*c+l*l+h*h),vi.determinant(Oi)<0&&(e.x*=-1),e}static getRotation(e,t){const i=t.m00+t.m05+t.m10;let n=0;return i>0?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}static toRTS(e,t,i,n){n.x=_i.set(Ii,e.m00,e.m01,e.m02).length(),Oi.m00=e.m00/n.x,Oi.m01=e.m01/n.x,Oi.m02=e.m02/n.x,n.y=_i.set(Ii,e.m04,e.m05,e.m06).length(),Oi.m03=e.m04/n.y,Oi.m04=e.m05/n.y,Oi.m05=e.m06/n.y,n.z=_i.set(Ii,e.m08,e.m09,e.m10).length(),Oi.m06=e.m08/n.z,Oi.m07=e.m09/n.z,Oi.m08=e.m10/n.z;vi.determinant(Oi)<0&&(n.x*=-1,Oi.m00*=-1,Oi.m01*=-1,Oi.m02*=-1),Si.fromMat3(t,Oi),_i.set(i,e.m12,e.m13,e.m14)}static fromRTS(e,t,i,n){const s=t.x,r=t.y,o=t.z,a=t.w,c=s+s,l=r+r,h=o+o,u=s*c,_=s*l,d=s*h,m=r*l,p=r*h,f=o*h,g=a*c,v=a*l,y=a*h,x=n.x,S=n.y,T=n.z;return e.m00=(1-(m+f))*x,e.m01=(_+y)*x,e.m02=(d-v)*x,e.m03=0,e.m04=(_-y)*S,e.m05=(1-(u+f))*S,e.m06=(p+g)*S,e.m07=0,e.m08=(d+v)*T,e.m09=(p-g)*T,e.m10=(1-(u+m))*T,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}static fromRTSOrigin(e,t,i,n,s){const r=t.x,o=t.y,a=t.z,c=t.w,l=r+r,h=o+o,u=a+a,_=r*l,d=r*h,m=r*u,p=o*h,f=o*u,g=a*u,v=c*l,y=c*h,x=c*u,S=n.x,T=n.y,E=n.z,A=s.x,C=s.y,b=s.z;return e.m00=(1-(p+g))*S,e.m01=(d+x)*S,e.m02=(m-y)*S,e.m03=0,e.m04=(d-x)*T,e.m05=(1-(_+g))*T,e.m06=(f+v)*T,e.m07=0,e.m08=(m+y)*E,e.m09=(f-v)*E,e.m10=(1-(_+p))*E,e.m11=0,e.m12=i.x+A-(e.m00*A+e.m04*C+e.m08*b),e.m13=i.y+C-(e.m01*A+e.m05*C+e.m09*b),e.m14=i.z+b-(e.m02*A+e.m06*C+e.m10*b),e.m15=1,e}static fromQuat(e,t){const i=t.x,n=t.y,s=t.z,r=t.w,o=i+i,a=n+n,c=s+s,l=i*o,h=n*o,u=n*a,_=s*o,d=s*a,m=s*c,p=r*o,f=r*a,g=r*c;return e.m00=1-u-m,e.m01=h+g,e.m02=_-f,e.m03=0,e.m04=h-g,e.m05=1-l-m,e.m06=d+p,e.m07=0,e.m08=_+f,e.m09=d-p,e.m10=1-l-u,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static frustum(e,t,i,n,s,r,o){const a=1/(i-t),c=1/(s-n),l=1/(r-o);return e.m00=2*r*a,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*r*c,e.m06=0,e.m07=0,e.m08=(i+t)*a,e.m09=(s+n)*c,e.m10=(o+r)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=o*r*2*l,e.m15=0,e}static perspective(e,t,i,n,s,r=!0,o=-1,a=1){const c=1/Math.tan(t/2),l=1/(n-s);return e.m00=r?c/i:c,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=(r?c:c*i)*a,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(s-o*n)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=s*n*l*(1-o),e.m15=0,e}static ortho(e,t,i,n,s,r,o,a=-1,c=1){const l=1/(t-i),h=1/(n-s),u=1/(r-o);return e.m00=-2*l,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=-2*h*c,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=u*(1-a),e.m11=0,e.m12=(t+i)*l,e.m13=(s+n)*h,e.m14=(r-a*o)*u,e.m15=1,e}static lookAt(e,t,i,n){const s=t.x,r=t.y,o=t.z,a=n.x,c=n.y,l=n.z;let h=s-i.x,u=r-i.y,_=o-i.z,d=1/Math.sqrt(h*h+u*u+_*_);h*=d,u*=d,_*=d;let m=c*_-l*u,p=l*h-a*_,f=a*u-c*h;d=1/Math.sqrt(m*m+p*p+f*f),m*=d,p*=d,f*=d;const g=u*f-_*p,v=_*m-h*f,y=h*p-u*m;return e.m00=m,e.m01=g,e.m02=h,e.m03=0,e.m04=p,e.m05=v,e.m06=u,e.m07=0,e.m08=f,e.m09=y,e.m10=_,e.m11=0,e.m12=-(m*s+p*r+f*o),e.m13=-(g*s+v*r+y*o),e.m14=-(h*s+u*r+_*o),e.m15=1,e}static inverseTranspose(e,t){const i=t.m00,n=t.m01,s=t.m02,r=t.m03,o=t.m04,a=t.m05,c=t.m06,l=t.m07,h=t.m08,u=t.m09,_=t.m10,d=t.m11,m=t.m12,p=t.m13,f=t.m14,g=t.m15,v=i*a-n*o,y=i*c-s*o,x=i*l-r*o,S=n*c-s*a,T=n*l-r*a,E=s*l-r*c,A=h*p-u*m,C=h*f-_*m,b=h*g-d*m,R=u*f-_*p,w=u*g-d*p,I=_*g-d*f;let O=v*I-y*w+x*R+S*b-T*C+E*A;return O?(O=1/O,e.m00=(a*I-c*w+l*R)*O,e.m01=(c*b-o*I-l*C)*O,e.m02=(o*w-a*b+l*A)*O,e.m03=0,e.m04=(s*w-n*I-r*R)*O,e.m05=(i*I-s*b+r*C)*O,e.m06=(n*b-i*w-r*A)*O,e.m07=0,e.m08=(p*E-f*T+g*S)*O,e.m09=(f*x-m*E-g*y)*O,e.m10=(m*T-p*x+g*v)*O,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}static toArray(e,t,i=0){return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e[i+9]=t.m09,e[i+10]=t.m10,e[i+11]=t.m11,e[i+12]=t.m12,e[i+13]=t.m13,e[i+14]=t.m14,e[i+15]=t.m15,e}static fromArray(e,t,i=0){return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e.m09=t[i+9],e.m10=t[i+10],e.m11=t[i+11],e.m12=t[i+12],e.m13=t[i+13],e.m14=t[i+14],e.m15=t[i+15],e}static add(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}static subtract(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}static multiplyScalar(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}static multiplyScalarAndAdd(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}static strictEquals(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}static equals(e,t,i=Vt){return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=i*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=i*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=i*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=i*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=i*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=i*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=i*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}constructor(e=1,t=0,i=0,n=0,s=0,r=1,o=0,a=0,c=0,l=0,h=1,u=0,_=0,d=0,m=0,p=1){super(),this.m00=void 0,this.m01=void 0,this.m02=void 0,this.m03=void 0,this.m04=void 0,this.m05=void 0,this.m06=void 0,this.m07=void 0,this.m08=void 0,this.m09=void 0,this.m10=void 0,this.m11=void 0,this.m12=void 0,this.m13=void 0,this.m14=void 0,this.m15=void 0,"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15):(this.m00=e,this.m01=t,this.m02=i,this.m03=n,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=c,this.m09=l,this.m10=h,this.m11=u,this.m12=_,this.m13=d,this.m14=m,this.m15=p)}clone(){const e=this;return new wi(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}set(e=1,t=0,i=0,n=0,s=0,r=1,o=0,a=0,c=0,l=0,h=1,u=0,_=0,d=0,m=0,p=1){return"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=i,this.m03=n,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=c,this.m09=l,this.m10=h,this.m11=u,this.m12=_,this.m13=d,this.m14=m,this.m15=p,this.m00=e),this}equals(e,t=Vt){return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}strictEquals(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}toString(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"}identity(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}transpose(){const e=this.m01,t=this.m02,i=this.m03,n=this.m06,s=this.m07,r=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=s,this.m14=r,this}invert(){const e=this.m00,t=this.m01,i=this.m02,n=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,c=this.m08,l=this.m09,h=this.m10,u=this.m11,_=this.m12,d=this.m13,m=this.m14,p=this.m15,f=e*r-t*s,g=e*o-i*s,v=e*a-n*s,y=t*o-i*r,x=t*a-n*r,S=i*a-n*o,T=c*d-l*_,E=c*m-h*_,A=c*p-u*_,C=l*m-h*d,b=l*p-u*d,R=h*p-u*m;let w=f*R-g*b+v*C+y*A-x*E+S*T;return 0===w?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(w=1/w,this.m00=(r*R-o*b+a*C)*w,this.m01=(i*b-t*R-n*C)*w,this.m02=(d*S-m*x+p*y)*w,this.m03=(h*x-l*S-u*y)*w,this.m04=(o*A-s*R-a*E)*w,this.m05=(e*R-i*A+n*E)*w,this.m06=(m*v-_*S-p*g)*w,this.m07=(c*S-h*v+u*g)*w,this.m08=(s*b-r*A+a*T)*w,this.m09=(t*A-e*b-n*T)*w,this.m10=(_*x-d*v+p*f)*w,this.m11=(l*v-c*x-u*f)*w,this.m12=(r*E-s*C-o*T)*w,this.m13=(e*C-t*E+i*T)*w,this.m14=(d*g-_*y-m*f)*w,this.m15=(c*y-l*g+h*f)*w,this)}determinant(){const e=this.m00,t=this.m01,i=this.m02,n=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,c=this.m08,l=this.m09,h=this.m10,u=this.m11,_=this.m12,d=this.m13,m=this.m14,p=this.m15;return(e*r-t*s)*(h*p-u*m)-(e*o-i*s)*(l*p-u*d)+(e*a-n*s)*(l*m-h*d)+(t*o-i*r)*(c*p-u*_)-(t*a-n*r)*(c*m-h*_)+(i*a-n*o)*(c*d-l*_)}add(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this.m09=this.m09+e.m09,this.m10=this.m10+e.m10,this.m11=this.m11+e.m11,this.m12=this.m12+e.m12,this.m13=this.m13+e.m13,this.m14=this.m14+e.m14,this.m15=this.m15+e.m15,this}subtract(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this.m09=this.m09-e.m09,this.m10=this.m10-e.m10,this.m11=this.m11-e.m11,this.m12=this.m12-e.m12,this.m13=this.m13-e.m13,this.m14=this.m14-e.m14,this.m15=this.m15-e.m15,this}multiply(e){const t=this.m00,i=this.m01,n=this.m02,s=this.m03,r=this.m04,o=this.m05,a=this.m06,c=this.m07,l=this.m08,h=this.m09,u=this.m10,_=this.m11,d=this.m12,m=this.m13,p=this.m14,f=this.m15;let g=e.m00,v=e.m01,y=e.m02,x=e.m03;return this.m00=g*t+v*r+y*l+x*d,this.m01=g*i+v*o+y*h+x*m,this.m02=g*n+v*a+y*u+x*p,this.m03=g*s+v*c+y*_+x*f,g=e.m04,v=e.m05,y=e.m06,x=e.m07,this.m04=g*t+v*r+y*l+x*d,this.m05=g*i+v*o+y*h+x*m,this.m06=g*n+v*a+y*u+x*p,this.m07=g*s+v*c+y*_+x*f,g=e.m08,v=e.m09,y=e.m10,x=e.m11,this.m08=g*t+v*r+y*l+x*d,this.m09=g*i+v*o+y*h+x*m,this.m10=g*n+v*a+y*u+x*p,this.m11=g*s+v*c+y*_+x*f,g=e.m12,v=e.m13,y=e.m14,x=e.m15,this.m12=g*t+v*r+y*l+x*d,this.m13=g*i+v*o+y*h+x*m,this.m14=g*n+v*a+y*u+x*p,this.m15=g*s+v*c+y*_+x*f,this}multiplyScalar(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this.m09=this.m09*e,this.m10=this.m10*e,this.m11=this.m11*e,this.m12=this.m12*e,this.m13=this.m13*e,this.m14=this.m14*e,this.m15=this.m15*e,this}translate(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this}scale(e){const t=e.x,i=e.y,n=e.z;return this.m00=this.m00*t,this.m01=this.m01*t,this.m02=this.m02*t,this.m03=this.m03*t,this.m04=this.m04*i,this.m05=this.m05*i,this.m06=this.m06*i,this.m07=this.m07*i,this.m08=this.m08*n,this.m09=this.m09*n,this.m10=this.m10*n,this.m11=this.m11*n,this.m12=this.m12,this.m13=this.m13,this.m14=this.m14,this.m15=this.m15,this}rotate(e,t){let i=t.x,n=t.y,s=t.z,r=Math.sqrt(i*i+n*n+s*s);if(Math.abs(r)<Vt)return null;r=1/r,i*=r,n*=r,s*=r;const o=Math.sin(e),a=Math.cos(e),c=1-a,l=this.m00,h=this.m01,u=this.m02,_=this.m03,d=this.m04,m=this.m05,p=this.m06,f=this.m07,g=this.m08,v=this.m09,y=this.m10,x=this.m11,S=i*i*c+a,T=n*i*c+s*o,E=s*i*c-n*o,A=i*n*c-s*o,C=n*n*c+a,b=s*n*c+i*o,R=i*s*c+n*o,w=n*s*c-i*o,I=s*s*c+a;return this.m00=l*S+d*T+g*E,this.m01=h*S+m*T+v*E,this.m02=u*S+p*T+y*E,this.m03=_*S+f*T+x*E,this.m04=l*A+d*C+g*b,this.m05=h*A+m*C+v*b,this.m06=u*A+p*C+y*b,this.m07=_*A+f*C+x*b,this.m08=l*R+d*w+g*I,this.m09=h*R+m*w+v*I,this.m10=u*R+p*w+y*I,this.m11=_*R+f*w+x*I,this}getTranslation(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}getScale(e){const t=Oi.m00=this.m00,i=Oi.m01=this.m01,n=Oi.m02=this.m02,s=Oi.m03=this.m04,r=Oi.m04=this.m05,o=Oi.m05=this.m06,a=Oi.m06=this.m08,c=Oi.m07=this.m09,l=Oi.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+n*n),e.y=Math.sqrt(s*s+r*r+o*o),e.z=Math.sqrt(a*a+c*c+l*l),vi.determinant(Oi)<0&&(e.x*=-1),e}getRotation(e){const t=this.m00+this.m05+this.m10;let i=0;return t>0?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this.m06-this.m09)/i,e.y=(this.m08-this.m02)/i,e.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/i,e.x=.25*i,e.y=(this.m01+this.m04)/i,e.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/i,e.x=(this.m01+this.m04)/i,e.y=.25*i,e.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/i,e.x=(this.m08+this.m02)/i,e.y=(this.m06+this.m09)/i,e.z=.25*i),e}fromRTS(e,t,i){const n=e.x,s=e.y,r=e.z,o=e.w,a=n+n,c=s+s,l=r+r,h=n*a,u=n*c,_=n*l,d=s*c,m=s*l,p=r*l,f=o*a,g=o*c,v=o*l,y=i.x,x=i.y,S=i.z;return this.m00=(1-(d+p))*y,this.m01=(u+v)*y,this.m02=(_-g)*y,this.m03=0,this.m04=(u-v)*x,this.m05=(1-(h+p))*x,this.m06=(m+f)*x,this.m07=0,this.m08=(_+g)*S,this.m09=(m-f)*S,this.m10=(1-(h+d))*S,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}fromQuat(e){const t=e.x,i=e.y,n=e.z,s=e.w,r=t+t,o=i+i,a=n+n,c=t*r,l=i*r,h=i*o,u=n*r,_=n*o,d=n*a,m=s*r,p=s*o,f=s*a;return this.m00=1-h-d,this.m01=l+f,this.m02=u-p,this.m03=0,this.m04=l-f,this.m05=1-c-d,this.m06=_+m,this.m07=0,this.m08=u+p,this.m09=_-m,this.m10=1-c-h,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}e("Mat4",wi),wi.IDENTITY=Object.freeze(new wi);const Ii=new _i,Oi=new vi;function Pi(e,t,i,n,s,r,o,a,c,l,h,u,_,d,m,p){return new wi(e,t,i,n,s,r,o,a,c,l,h,u,_,d,m,p)}Nt.fastDefine("cc.Mat4",wi,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),i.Mat4=wi,i.mat4=Pi;class Mi{static identity(){return new Mi}static clone(e){return new Mi(e.a,e.b,e.c,e.d,e.tx,e.ty)}static concat(e,t,i){const n=t.a,s=t.b,r=t.c,o=t.d,a=t.tx,c=t.ty;e.a=n*i.a+s*i.c,e.b=n*i.b+s*i.d,e.c=r*i.a+o*i.c,e.d=r*i.b+o*i.d,e.tx=a*i.a+c*i.c+i.tx,e.ty=a*i.b+c*i.d+i.ty}static invert(e,t){const i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}static fromMat4(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}static transformVec2(e,t,i,n){let s,r;void 0===n?(n=i,s=t.x,r=t.y):(s=t,r=i),e.x=n.a*s+n.c*r+n.tx,e.y=n.b*s+n.d*r+n.ty}static transformSize(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}static transformRect(e,t,i){const n=t.x+t.width,s=t.y+t.height,r=i.a*t.x+i.c*t.y+i.tx,o=i.b*t.x+i.d*t.y+i.ty,a=i.a*n+i.c*t.y+i.tx,c=i.b*n+i.d*t.y+i.ty,l=i.a*t.x+i.c*s+i.tx,h=i.b*t.x+i.d*s+i.ty,u=i.a*n+i.c*s+i.tx,_=i.b*n+i.d*s+i.ty,d=Math.min(r,a,l,u),m=Math.max(r,a,l,u),p=Math.min(o,c,h,_),f=Math.max(o,c,h,_);e.x=d,e.y=p,e.width=m-d,e.height=f-p}static transformObb(e,t,i,n,s,r){const o=r.a*s.x+r.c*s.y+r.tx,a=r.b*s.x+r.d*s.y+r.ty,c=r.a*s.width,l=r.b*s.width,h=r.c*s.height,u=r.d*s.height;t.x=o,t.y=a,i.x=c+o,i.y=l+a,e.x=h+o,e.y=u+a,n.x=c+h+o,n.y=l+u+a}constructor(e=1,t=0,i=0,n=1,s=0,r=0){this.a=e,this.b=t,this.c=i,this.d=n,this.tx=s,this.ty=r}}e("AffineTransform",Mi),i.AffineTransform=Mi;class Di extends Qe{static lerp(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e}set x(e){this.width=e}get x(){return this.width}set y(e){this.height=e}get y(){return this.height}constructor(e,t){super(),e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0)}clone(){return new Di(this.width,this.height)}set(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this}equals(e){return this.width===e.width&&this.height===e.height}lerp(e,t){return this.width=this.width+(e.width-this.width)*t,this.height=this.height+(e.height-this.height)*t,this}toString(){return`(${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}}function Li(e=0,t=0){return new Di(e,t)}e("Size",Di),Di.ZERO=Object.freeze(new Di(0,0)),Di.ONE=Object.freeze(new Di(1,1)),Nt.fastDefine("cc.Size",Di,{width:0,height:0}),i.size=Li,i.Size=Di;class Bi extends Qe{static fromMinMax(e,t,i){const n=Math.min(t.x,i.x),s=Math.min(t.y,i.y),r=Math.max(t.x,i.x),o=Math.max(t.y,i.y);return e.x=n,e.y=s,e.width=r-n,e.height=o-s,e}static lerp(e,t,i,n){const s=t.x,r=t.y,o=t.width,a=t.height;return e.x=s+(i.x-s)*n,e.y=r+(i.y-r)*n,e.width=o+(i.width-o)*n,e.height=a+(i.height-a)*n,e}static intersection(e,t,i){const n=t.x,s=t.y,r=t.x+t.width,o=t.y+t.height,a=i.x,c=i.y,l=i.x+i.width,h=i.y+i.height;return e.x=Math.max(n,a),e.y=Math.max(s,c),e.width=Math.min(r,l)-e.x,e.height=Math.min(o,h)-e.y,e}static union(e,t,i){const n=t.x,s=t.y,r=t.width,o=t.height,a=i.x,c=i.y,l=i.width,h=i.height;return e.x=Math.min(n,a),e.y=Math.min(s,c),e.width=Math.max(n+r,a+l)-e.x,e.height=Math.max(s+o,c+h)-e.y,e}get xMin(){return this.x}set xMin(e){this.width+=this.x-e,this.x=e}get yMin(){return this.y}set yMin(e){this.height+=this.y-e,this.y=e}get xMax(){return this.x+this.width}set xMax(e){this.width=e-this.x}get yMax(){return this.y+this.height}set yMax(e){this.height=e-this.y}get center(){return new ci(this.x+.5*this.width,this.y+.5*this.height)}set center(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}get origin(){return new i.Vec2(this.x,this.y)}set origin(e){this.x=e.x,this.y=e.y}get size(){return new Di(this.width,this.height)}set size(e){this.width=e.width,this.height=e.height}set z(e){this.width=e}get z(){return this.width}set w(e){this.height=e}get w(){return this.height}constructor(e,t,i,n){super(),e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0)}clone(){return new Bi(this.x,this.y,this.width,this.height)}set(e,t,i,n){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0),this}equals(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}lerp(e,t){const i=this.x,n=this.y,s=this.width,r=this.height;return this.x=i+(e.x-i)*t,this.y=n+(e.y-n)*t,this.width=s+(e.width-s)*t,this.height=r+(e.height-r)*t,this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}intersects(e){const t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,s=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||s<this.y)}contains(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}containsRect(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}transformMat4(e){const t=this.x,i=this.y,n=t+this.width,s=i+this.height,r=e.m00*t+e.m04*i+e.m12,o=e.m01*t+e.m05*i+e.m13,a=e.m00*n+e.m04*i+e.m12,c=e.m01*n+e.m05*i+e.m13,l=e.m00*t+e.m04*s+e.m12,h=e.m01*t+e.m05*s+e.m13,u=e.m00*n+e.m04*s+e.m12,_=e.m01*n+e.m05*s+e.m13,d=Math.min(r,a,l,u),m=Math.max(r,a,l,u),p=Math.min(o,c,h,_),f=Math.max(o,c,h,_);return this.x=d,this.y=p,this.width=m-d,this.height=f-p,this}}function Ni(e=0,t=0,i=0,n=0){return new Bi(e,t,i,n)}e("Rect",Bi),Nt.fastDefine("cc.Rect",Bi,{x:0,y:0,width:0,height:0}),i.Rect=Bi,i.rect=Ni;class Fi extends Qe{static clone(e){const t=new Fi;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}static copy(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}static set(e,t,i,n,s){return e.r=t,e.g=i,e.b=n,e.a=s,e}static fromHEX(e,t){return t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0,e.a=parseInt(t.substr(6,2),16)||255,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e}static add(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}static subtract(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}static multiply(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}static divide(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}static scale(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}static lerp(e,t,i,n){let s=t.r,r=t.g,o=t.b,a=t.a;return s+=(i.r-s)*n,r+=(i.g-r)*n,o+=(i.b-o)*n,a+=(i.a-a)*n,e._val=Math.floor((a<<24>>>0)+(o<<16)+(r<<8)+s),e}static toArray(e,t,i=0){const n=t instanceof Fi||t.a>1?1/255:1;return e[i+0]=t.r*n,e[i+1]=t.g*n,e[i+2]=t.b*n,e[i+3]=t.a*n,e}static fromArray(e,t,i=0){return t.r=255*e[i+0],t.g=255*e[i+1],t.b=255*e[i+2],t.a=255*e[i+3],t}static strictEquals(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}static equals(e,t,i=Vt){return Math.abs(e.r-t.r)<=i*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=i*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=i*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=i*Math.max(1,Math.abs(e.a),Math.abs(t.a))}static hex(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}get r(){return 255&this._val}set r(e){e=~~jt(e,0,255),this._val=(4294967040&this._val|e)>>>0}get g(){return(65280&this._val)>>8}set g(e){e=~~jt(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}get b(){return(16711680&this._val)>>16}set b(e){e=~~jt(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}get a(){return(4278190080&this._val)>>>24}set a(e){e=~~jt(e,0,255),this._val=(16777215&this._val|e<<24>>>0)>>>0}get x(){return this.r*(1/255)}set x(e){this.r=255*e}get y(){return this.g*(1/255)}set y(e){this.g=255*e}get z(){return this.b*(1/255)}set z(e){this.b=255*e}get w(){return this.a*(1/255)}set w(e){this.a=255*e}constructor(e,t,i,n){super(),this._val=0,"string"==typeof e?this.fromHEX(e):void 0!==t?this.set(e,t,i,n):this.set(e)}clone(){const e=new Fi;return e._val=this._val,e}equals(e){return e&&this._val===e._val}lerp(e,t){let i=this.r,n=this.g,s=this.b,r=this.a;return i+=(e.r-i)*t,n+=(e.g-n)*t,s+=(e.b-s)*t,r+=(e.a-r)*t,this._val=Math.floor((r<<24>>>0)+(s<<16)+(n<<8)+i),this}toString(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"}toCSS(e){return"rgba"===e?"rgba("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+","+(this.a*(1/255)).toFixed(2)+")":"rgb"===e?"rgb("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+")":"#"+this.toHEX(e)}fromHEX(e){e=0===e.indexOf("#")?e.substring(1):e;const t=parseInt(e.substr(0,2),16)||0,i=parseInt(e.substr(2,2),16)||0,n=parseInt(e.substr(4,2),16)||0,s=parseInt(e.substr(6,2),16)||255;return this._val=(s<<24>>>0)+(n<<16)+(i<<8)+t,this}toHEX(e){const t=[(this.r<16?"0":"")+(0|this.r).toString(16),(this.g<16?"0":"")+(0|this.g).toString(16),(this.b<16?"0":"")+(0|this.b).toString(16)];let i=-1;if("#rgb"===e)for(i=0;i<t.length;++i)t[i].length>1&&(t[i]=t[i][0]);else if("#rrggbb"===e)for(i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);else"#rrggbbaa"===e&&t.push((this.a<16?"0":"")+(0|this.a).toString(16));return t.join("")}toRGBValue(){return 16777215&this._val}fromHSV(e,t,i){let n=0,s=0,r=0;if(0===t)n=s=r=i;else if(0===i)n=s=r=0;else{1===e&&(e=0),e*=6,t=t,i=i;const o=Math.floor(e),a=e-o,c=i*(1-t),l=i*(1-t*a),h=i*(1-t*(1-a));switch(o){case 0:n=i,s=h,r=c;break;case 1:n=l,s=i,r=c;break;case 2:n=c,s=i,r=h;break;case 3:n=c,s=l,r=i;break;case 4:n=h,s=c,r=i;break;case 5:n=i,s=c,r=l}}return n*=255,s*=255,r*=255,this._val=(this.a<<24>>>0)+(r<<16)+(s<<8)+n,this}toHSV(){const e=this.r*(1/255),t=this.g*(1/255),i=this.b*(1/255),n={h:0,s:0,v:0},s=Math.max(e,t,i),r=Math.min(e,t,i);let o=0;return n.v=s,n.s=s?(s-r)/s:0,n.s?(o=s-r,n.h=e===s?(t-i)/o:t===s?2+(i-e)/o:4+(e-t)/o,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n}set(e,t,i,n){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,i=e.b||0,n="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+e):(e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+e),this}multiply(e){const t=(255&this._val)*e.r>>8,i=(65280&this._val)*e.g>>8,n=(16711680&this._val)*e.b>>8,s=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&s|16711680&n|65280&i|255&t,this}_set_r_unsafe(e){return this._val=(4294967040&this._val|e)>>>0,this}_set_g_unsafe(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}_set_b_unsafe(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}_set_a_unsafe(e){return this._val=(16777215&this._val|e<<24>>>0)>>>0,this}}function zi(e,t,i,n){return new Fi(e,t,i,n)}e("Color",Fi),Fi.WHITE=Object.freeze(new Fi(255,255,255,255)),Fi.GRAY=Object.freeze(new Fi(127,127,127,255)),Fi.BLACK=Object.freeze(new Fi(0,0,0,255)),Fi.TRANSPARENT=Object.freeze(new Fi(0,0,0,0)),Fi.RED=Object.freeze(new Fi(255,0,0,255)),Fi.GREEN=Object.freeze(new Fi(0,255,0,255)),Fi.BLUE=Object.freeze(new Fi(0,0,255,255)),Fi.CYAN=Object.freeze(new Fi(0,255,255,255)),Fi.MAGENTA=Object.freeze(new Fi(255,0,255,255)),Fi.YELLOW=Object.freeze(new Fi(255,255,0,255)),Nt.fastDefine("cc.Color",Fi,{r:0,g:0,b:0,a:255}),i.Color=Fi,i.color=zi;let Ui,Gi,Hi,Vi,ki,Wi,ji=10;let qi=0;const Xi=new Map;Vi=(e,t,i,n,s,r)=>{const o=Xi.get(r);o&&o.logTimes>o.count&&(s("'%s' is deprecated, please use '%s' instead.",`${e}.${t}`,`${i}.${n}`),o.count++)},Ui=e("replaceProperty",(e,t,i)=>{null!=e&&i.forEach(i=>{const n=qi++;Xi.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:ji});const s=null!=i.target?i.target:e,r=null!=i.newName?i.newName:i.name,o=null!=i.targetName?i.targetName:t,a=s==e;if(null!=i.customFunction)e[i.name]=function(){return Vi(t,i.name,o,r,h,n),i.customFunction.call(this,...arguments)};else if(null!=i.customSetter||null!=i.customGetter){const s=null!=i.customSetter,a=null!=i.customGetter;s&&a?Object.defineProperty(e,i.name,{get(){return Vi(t,i.name,o,r,h,n),i.customGetter.call(this)},set(e){Vi(t,i.name,o,r,h,n),i.customSetter.call(this,e)}}):s?Object.defineProperty(e,i.name,{set(e){Vi(t,i.name,o,r,h,n),i.customSetter.call(this,e)}}):a&&Object.defineProperty(e,i.name,{get(){return Vi(t,i.name,o,r,h,n),i.customGetter.call(this)}})}else Object.defineProperty(e,i.name,{get(){return Vi(t,i.name,o,r,h,n),a?this[r]:s[r]},set(e){Vi(t,i.name,o,r,h,n),a?this[r]=e:s[r]=e}})})}),Wi=(e,t,i,n,s)=>{const r=Xi.get(n),o=void 0===s?"":"("+s+")";r&&r.logTimes>r.count&&(i("'%s' has been removed. "+o,`${e}.${t}`),r.count++)},Gi=e("removeProperty",(e,t,i)=>{null!=e&&i.forEach(i=>{const n=qi++;Xi.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:ji}),Object.defineProperty(e,i.name,{get:()=>Wi(t,i.name,u,n,i.suggest),set(){Wi(t,i.name,u,n,i.suggest)}})})}),ki=(e,t,i,n,s)=>{const r=Xi.get(n),o=void 0===s?"":"("+s+")";r&&r.logTimes>r.count&&(i("'%s' is deprecated. "+o,`${e}.${t}`),r.count++)},Hi=e("markAsWarning",(e,t,i)=>{if(null==e)return;const n=(e,t,i,n,s,r)=>{if(e.get){const o=e.get();e.get=function(){return ki(t,i,n,s,r),o.call(this)}}if(e.set){const o=Object.create(e.set);e.set=function(e){ki(t,i,n,s,r),o.call(this,e)}}};i.forEach(i=>{const s=i.name,r=Object.getOwnPropertyDescriptor(e,s);if(!r)return;const o=qi++;if(Xi.set(o,{id:o,count:0,logTimes:void 0!==i.logTimes?i.logTimes:ji}),null!=r.value)if("function"==typeof r.value){const n=r.value;e[s]=function(){return ki(t,s,h,o,i.suggest),n.call(this,...arguments)}}else n(r,t,s,h,o,i.suggest);else n(r,t,s,h,o,i.suggest)})}),Ui(ci,"Vec2",[{name:"sub",newName:"subtract",target:ci,targetName:"Vec2"},{name:"mul",newName:"multiply",target:ci,targetName:"Vec2"},{name:"div",newName:"divide",target:ci,targetName:"Vec2"},{name:"dist",newName:"distance",target:ci,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:ci,targetName:"Vec2"},{name:"mag",newName:"len",target:ci,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:ci,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:ci,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:ci,targetName:"Vec2"}]),Ui(ci.prototype,"Vec2",[{name:"mag",newName:"length",target:ci.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:ci.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:ci.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:ci.prototype,targetName:"Vec2"}]),Gi(ci.prototype,"vmath",[{name:"divide"}]),Ui(_i,"Vec3",[{name:"sub",newName:"subtract",target:_i,targetName:"Vec3"},{name:"mul",newName:"multiply",target:_i,targetName:"Vec3"},{name:"div",newName:"divide",target:_i,targetName:"Vec3"},{name:"dist",newName:"distance",target:_i,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:_i,targetName:"Vec3"},{name:"mag",newName:"len",target:_i,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:_i,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:_i,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:_i,targetName:"Vec3"}]),Ui(_i.prototype,"Vec3",[{name:"mag",newName:"length",target:_i.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:_i.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:_i.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:_i.prototype,targetName:"Vec3"}]),Gi(_i.prototype,"vmath",[{name:"divide"}]),Ui(fi,"Vec4",[{name:"sub",newName:"subtract",target:fi,targetName:"Vec4"},{name:"mul",newName:"multiply",target:fi,targetName:"Vec4"},{name:"div",newName:"divide",target:fi,targetName:"Vec4"},{name:"dist",newName:"distance",target:fi,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:fi,targetName:"Vec4"},{name:"mag",newName:"len",target:fi,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:fi,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:fi,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:fi,targetName:"Vec4"}]),Ui(fi.prototype,"Vec4",[{name:"mag",newName:"length",target:fi.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:fi.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:fi.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:fi.prototype,targetName:"Vec4"}]),Gi(fi.prototype,"vmath",[{name:"divide"}]),Ui(Si,"Quat",[{name:"mag",newName:"len",target:Si,targetName:"Quat"},{name:"mul",newName:"multiply",target:Si,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Si,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Si,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Si,targetName:"Quat"}]),Ui(Si.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Si.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Si.prototype,targetName:"Quat"}]),Ui(Fi,"Color",[{name:"sub",newName:"subtract",target:Fi,targetName:"Color"},{name:"mul",newName:"multiply",target:Fi,targetName:"Color"},{name:"div",newName:"divide",target:Fi,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:Fi,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction(...e){const t=e[1].toString(16);return i.Color.fromHEX(e[0],t)}}]),Ui(vi,"Mat3",[{name:"sub",newName:"subtract",target:vi,targetName:"Mat3"},{name:"mul",newName:"multiply",target:vi,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:vi,targetName:"Mat3"}]),Ui(vi.prototype,"Mat3",[{name:"sub",newName:"subtract",target:vi.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:vi.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:vi.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:vi.prototype,targetName:"Mat3"}]),Ui(wi,"Mat4",[{name:"sub",newName:"subtract",target:wi,targetName:"Mat4"},{name:"mul",newName:"multiply",target:wi,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:wi,targetName:"Mat4"}]),Ui(wi.prototype,"Mat4",[{name:"sub",newName:"subtract",target:wi.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:wi.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:wi.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:wi.prototype,targetName:"Mat4"}]);var Yi=Object.freeze({__proto__:null,bits:X,Vec2:ci,v2:ui,Vec3:_i,v3:pi,Vec4:fi,v4:gi,Quat:Si,quat:Ri,Mat3:vi,Mat4:wi,mat4:Pi,AffineTransform:Mi,Size:Di,size:Li,Rect:Bi,rect:Ni,Color:Fi,color:zi,EPSILON:Vt,equals:kt,approx:Wt,clamp:jt,clamp01:qt,lerp:Xt,toRadian:Yt,toDegree:Kt,random:Zt,randomRange:$t,randomRangeInt:Qt,pseudoRandom:Jt,pseudoRandomRange:ei,pseudoRandomRangeInt:ti,nextPow2:ii,repeat:ni,pingPong:si,inverseLerp:ri,absMaxComponent:oi,absMax:ai});e("math",Yi);const Ki=new _i,Zi=new _i,$i=new _i,Qi=new _i,Ji=new _i,en=new _i,tn=new Array(3),nn=new Array(3);function sn(e,t){return _i.dot(t.n,e)-t.d}function rn(e,t,i){return _i.copy(e,t),_i.subtract(Ji,i.center,i.halfExtents),_i.add(en,i.center,i.halfExtents),e.x=e.x<Ji.x?Ji.x:e.x,e.y=e.y<Ji.x?Ji.y:e.y,e.z=e.z<Ji.x?Ji.z:e.z,e.x=e.x>en.x?en.x:e.x,e.y=e.y>en.x?en.y:e.y,e.z=e.z>en.x?en.z:e.z,e}function on(e,t,i){_i.set(Ki,i.orientation.m00,i.orientation.m01,i.orientation.m02),_i.set(Zi,i.orientation.m03,i.orientation.m04,i.orientation.m05),_i.set($i,i.orientation.m06,i.orientation.m07,i.orientation.m08),tn[0]=Ki,tn[1]=Zi,tn[2]=$i,nn[0]=i.halfExtents.x,nn[1]=i.halfExtents.y,nn[2]=i.halfExtents.z,_i.subtract(Qi,t,i.center),_i.set(e,i.center.x,i.center.y,i.center.z);for(let t=0;t<3;t++){let i=_i.dot(Qi,tn[t]);i>nn[t]&&(i=nn[t]),i<-nn[t]&&(i=-nn[t]),e.x+=i*tn[t].x,e.y+=i*tn[t].y,e.z+=i*tn[t].z}return e}var an=Object.freeze({__proto__:null,point_plane:sn,pt_point_plane:function(e,t,i){const n=sn(t,i);return _i.subtract(e,t,_i.multiplyScalar(e,i.n,n))},pt_point_aabb:rn,pt_point_obb:on,pt_point_line:function(e,t,i,n){_i.subtract(Ki,i,n);const s=Ki,r=_i.lengthSqr(s);if(0==r)_i.copy(e,i);else{_i.subtract(Ki,t,i);const o=_i.dot(Ki,s)/r;o<0?_i.copy(e,i):o>1?_i.copy(e,n):_i.scaleAndAdd(e,i,s,o)}}});class cn{static create(e=0,t=0,i=0,n=0,s=0,r=1){return new cn(e,t,i,n,s,r)}static clone(e){return new cn(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)}static copy(e,t){return _i.copy(e.o,t.o),_i.copy(e.d,t.d),e}static fromPoints(e,t,i){return _i.copy(e.o,t),_i.normalize(e.d,_i.subtract(e.d,i,t)),e}static set(e,t,i,n,s,r,o){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=s,e.d.y=r,e.d.z=o,e}get type(){return this._type}constructor(e=0,t=0,i=0,n=0,s=0,r=-1){this.o=void 0,this.d=void 0,this._type=void 0,this._type=V.SHAPE_RAY,this.o=new _i(e,t,i),this.d=new _i(n,s,r)}computeHit(e,t){_i.normalize(e,this.d),_i.scaleAndAdd(e,this.o,e,t)}}const ln=new _i,hn=new _i,un=new _i,_n=new _i;function dn(e){return Math.max(Math.max(e.x,e.y),e.z)}class mn{static create(e,t,i,n){return new mn(e,t,i,n)}static clone(e){return new mn(e.center.x,e.center.y,e.center.z,e.radius)}static copy(e,t){return _i.copy(e.center,t.center),e.radius=t.radius,e}static fromPoints(e,t,i){return _i.multiplyScalar(e.center,_i.add(ln,t,i),.5),e.radius=.5*_i.subtract(ln,i,t).length(),e}static set(e,t,i,n,s){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=s,e}static mergePoint(e,t,i){if(t.radius<0)return e.center=i,e.radius=0,e;_i.subtract(hn,i,t.center);const n=hn.length();if(n>t.radius){const i=.5*(n-t.radius);e.radius+=i,_i.multiplyScalar(hn,hn,i/n),_i.add(e.center,e.center,hn)}return e}static mergeAABB(e,t,i){return i.getBoundary(un,_n),mn.mergePoint(e,t,un),mn.mergePoint(e,t,_n),e}get type(){return this._type}constructor(e=0,t=0,i=0,n=1){this.center=void 0,this.radius=void 0,this._type=void 0,this._type=V.SHAPE_SPHERE,this.center=new _i(e,t,i),this.radius=n}clone(){return mn.clone(this)}copy(e){return mn.copy(this,e)}getBoundary(e,t){_i.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),_i.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}transform(e,t,i,n,s){_i.transformMat4(s.center,this.center,e),s.radius=this.radius*dn(n)}translateAndRotate(e,t,i){_i.transformMat4(i.center,this.center,e)}setScale(e,t){t.radius=this.radius*dn(e)}}class pn{static create(e=1,t=0,i=0,n=0,s=0,r=0,o=0,a=0,c=1){return new pn(e,t,i,n,s,r,o,a,c)}static clone(e){return new pn(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)}static copy(e,t){return _i.copy(e.a,t.a),_i.copy(e.b,t.b),_i.copy(e.c,t.c),e}static fromPoints(e,t,i,n){return _i.copy(e.a,t),_i.copy(e.b,i),_i.copy(e.c,n),e}static set(e,t,i,n,s,r,o,a,c,l){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=s,e.b.y=r,e.b.z=o,e.c.x=a,e.c.y=c,e.c.z=l,e}get type(){return this._type}constructor(e=0,t=0,i=0,n=1,s=0,r=0,o=0,a=1,c=0){this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=V.SHAPE_TRIANGLE,this.a=new _i(e,t,i),this.b=new _i(n,s,r),this.c=new _i(o,a,c)}}const fn=e("GFX_MAX_VERTEX_ATTRIBUTES",16),gn=e("GFX_MAX_TEXTURE_UNITS",16),vn=e("GFX_MAX_ATTACHMENTS",4),yn=e("GFX_MAX_BUFFER_BINDINGS",24);let xn,Sn,Tn,En,An,Cn,bn,Rn,wn,In,On,Pn,Mn,Dn,Ln,Bn,Nn,Fn,zn,Un,Gn,Hn,Vn,kn,Wn,jn,qn,Xn,Yn,Kn,Zn,$n,Qn,Jn,es;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BUFFER=1]="BUFFER",e[e.TEXTURE=2]="TEXTURE",e[e.RENDER_PASS=3]="RENDER_PASS",e[e.FRAMEBUFFER=4]="FRAMEBUFFER",e[e.SAMPLER=5]="SAMPLER",e[e.SHADER=6]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=9]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=12]="COMMAND_BUFFER",e[e.FENCE=13]="FENCE",e[e.QUEUE=14]="QUEUE",e[e.WINDOW=15]="WINDOW"}(xn||(xn=e("GFXObjectType",{})));class ts{get gfxType(){return this._gfxType}constructor(e){this._gfxType=xn.UNKNOWN,this._gfxType=e}}e("GFXObject",ts),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(Sn||(Sn=e("GFXAttributeName",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.COUNT=32]="COUNT"}(Tn||(Tn=e("GFXType",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.D16=54]="D16",e[e.D16S8=55]="D16S8",e[e.D24=56]="D24",e[e.D24S8=57]="D24S8",e[e.D32F=58]="D32F",e[e.D32F_S8=59]="D32F_S8",e[e.BC1=60]="BC1",e[e.BC1_ALPHA=61]="BC1_ALPHA",e[e.BC1_SRGB=62]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",e[e.BC2=64]="BC2",e[e.BC2_SRGB=65]="BC2_SRGB",e[e.BC3=66]="BC3",e[e.BC3_SRGB=67]="BC3_SRGB",e[e.BC4=68]="BC4",e[e.BC4_SNORM=69]="BC4_SNORM",e[e.BC5=70]="BC5",e[e.BC5_SNORM=71]="BC5_SNORM",e[e.BC6H_UF16=72]="BC6H_UF16",e[e.BC6H_SF16=73]="BC6H_SF16",e[e.BC7=74]="BC7",e[e.BC7_SRGB=75]="BC7_SRGB",e[e.ETC_RGB8=76]="ETC_RGB8",e[e.ETC2_RGB8=77]="ETC2_RGB8",e[e.ETC2_SRGB8=78]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=81]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",e[e.EAC_R11=83]="EAC_R11",e[e.EAC_R11SN=84]="EAC_R11SN",e[e.EAC_RG11=85]="EAC_RG11",e[e.EAC_RG11SN=86]="EAC_RG11SN",e[e.PVRTC_RGB2=87]="PVRTC_RGB2",e[e.PVRTC_RGBA2=88]="PVRTC_RGBA2",e[e.PVRTC_RGB4=89]="PVRTC_RGB4",e[e.PVRTC_RGBA4=90]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=91]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=92]="PVRTC2_4BPP",e[e.ASTC_RGBA_4x4=93]="ASTC_RGBA_4x4",e[e.ASTC_RGBA_5x4=94]="ASTC_RGBA_5x4",e[e.ASTC_RGBA_5x5=95]="ASTC_RGBA_5x5",e[e.ASTC_RGBA_6x5=96]="ASTC_RGBA_6x5",e[e.ASTC_RGBA_6x6=97]="ASTC_RGBA_6x6",e[e.ASTC_RGBA_8x5=98]="ASTC_RGBA_8x5",e[e.ASTC_RGBA_8x6=99]="ASTC_RGBA_8x6",e[e.ASTC_RGBA_8x8=100]="ASTC_RGBA_8x8",e[e.ASTC_RGBA_10x5=101]="ASTC_RGBA_10x5",e[e.ASTC_RGBA_10x6=102]="ASTC_RGBA_10x6",e[e.ASTC_RGBA_10x8=103]="ASTC_RGBA_10x8",e[e.ASTC_RGBA_10x10=104]="ASTC_RGBA_10x10",e[e.ASTC_RGBA_12x10=105]="ASTC_RGBA_12x10",e[e.ASTC_RGBA_12x12=106]="ASTC_RGBA_12x12",e[e.ASTC_SRGBA_4x4=107]="ASTC_SRGBA_4x4",e[e.ASTC_SRGBA_5x4=108]="ASTC_SRGBA_5x4",e[e.ASTC_SRGBA_5x5=109]="ASTC_SRGBA_5x5",e[e.ASTC_SRGBA_6x5=110]="ASTC_SRGBA_6x5",e[e.ASTC_SRGBA_6x6=111]="ASTC_SRGBA_6x6",e[e.ASTC_SRGBA_8x5=112]="ASTC_SRGBA_8x5",e[e.ASTC_SRGBA_8x6=113]="ASTC_SRGBA_8x6",e[e.ASTC_SRGBA_8x8=114]="ASTC_SRGBA_8x8",e[e.ASTC_SRGBA_10x5=115]="ASTC_SRGBA_10x5",e[e.ASTC_SRGBA_10x6=116]="ASTC_SRGBA_10x6",e[e.ASTC_SRGBA_10x8=117]="ASTC_SRGBA_10x8",e[e.ASTC_SRGBA_10x10=118]="ASTC_SRGBA_10x10",e[e.ASTC_SRGBA_12x10=119]="ASTC_SRGBA_12x10",e[e.ASTC_SRGBA_12x12=120]="ASTC_SRGBA_12x12"}(En||(En=e("GFXFormat",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(An||(An=e("GFXBufferUsageBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(Cn||(Cn=e("GFXMemoryUsageBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(bn||(bn=e("GFXBufferFlagBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.READ=1]="READ",e[e.WRITE=2]="WRITE"}(Rn||(Rn=e("GFXBufferAccessBit",{}))),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(wn||(wn=e("GFXPrimitiveMode",{}))),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(In||(In=e("GFXPolygonMode",{}))),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(On||(On=e("GFXShadeModel",{}))),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(Pn||(Pn=e("GFXCullMode",{}))),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Mn||(Mn=e("GFXComparisonFunc",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Dn||(Dn=e("GFXStencilOp",{}))),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Ln||(Ln=e("GFXBlendOp",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Bn||(Bn=e("GFXBlendFactor",{}))),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(Nn||(Nn=e("GFXColorMask",{}))),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(Fn||(Fn=e("GFXFilter",{}))),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(zn||(zn=e("GFXAddress",{}))),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Un||(Un=e("GFXTextureType",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",e[e.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(Gn||(Gn=e("GFXTextureUsageBit",{}))),function(e){e[e.X1=0]="X1",e[e.X2=1]="X2",e[e.X4=2]="X4",e[e.X8=3]="X8",e[e.X16=4]="X16",e[e.X32=5]="X32",e[e.X64=6]="X64"}(Hn||(Hn=e("GFXSampleCount",{}))),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.CUBEMAP=2]="CUBEMAP",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(Vn||(Vn=e("GFXTextureFlagBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(kn||(kn=e("GFXShaderStageFlagBit",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER=16]="SAMPLER"}(Wn||(Wn=e("GFXDescriptorType",{}))),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(jn||(jn=e("GFXCommandBufferType",{}))),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(qn||(qn=e("GFXLoadOp",{}))),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Xn||(Xn=e("GFXStoreOp",{}))),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.GENERAL=1]="GENERAL",e[e.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",e[e.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",e[e.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",e[e.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",e[e.PREINITIALIZED=8]="PREINITIALIZED",e[e.PRESENT_SRC=9]="PRESENT_SRC"}(Yn||(Yn=e("GFXTextureLayout",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Kn||(Kn=e("GFXPipelineBindPoint",{}))),function(e){e[e.NONE=0]="NONE",e[e.VIEWPORT=1]="VIEWPORT",e[e.SCISSOR=2]="SCISSOR",e[e.LINE_WIDTH=4]="LINE_WIDTH",e[e.DEPTH_BIAS=8]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(Zn||(Zn=e("GFXDynamicStateFlagBit",{}))),function(e){e[e.FRONT=0]="FRONT",e[e.BACK=1]="BACK",e[e.ALL=2]="ALL"}($n||($n=e("GFXStencilFace",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(Qn||(Qn=e("GFXQueueType",{})));class is{constructor(e=0,t=0,i=1,n=1){this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0,this.x=e,this.y=t,this.width=i,this.height=n}}e("GFXRect",is);class ns{constructor(e=0,t=0,i=0,n=0,s=0,r=1){this.left=void 0,this.top=void 0,this.width=void 0,this.height=void 0,this.minDepth=void 0,this.maxDepth=void 0,this.left=e,this.top=t,this.width=i,this.height=n,this.minDepth=s,this.maxDepth=r}}e("GFXViewport",ns);class ss{constructor(e=0,t=0,i=0,n=0){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=e,this.g=t,this.b=i,this.a=n}}e("GFXColor",ss),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Jn||(Jn=e("GFXClearFlag",{})));class rs{constructor(e=0,t=0,i=0){this.x=void 0,this.y=void 0,this.z=void 0,this.x=e,this.y=t,this.z=i}}e("GFXOffset",rs);class os{constructor(e=0,t=0,i=1){this.width=void 0,this.height=void 0,this.depth=void 0,this.width=e,this.height=t,this.depth=i}}e("GFXExtent",os);class as{constructor(e=0,t=0,i=1){this.mipLevel=void 0,this.baseArrayLayer=void 0,this.layerCount=void 0,this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=i}}e("GFXTextureSubres",as);class cs{constructor(e=new as,t=new rs,i=new as,n=new rs,s=new os){this.srcSubres=void 0,this.srcOffset=void 0,this.dstSubres=void 0,this.dstOffset=void 0,this.extent=void 0,this.srcSubres=e,this.srcOffset=t,this.dstSubres=i,this.dstOffset=n,this.extent=s}}e("GFXTextureCopy",cs);class ls{constructor(e=0,t=0,i=new rs,n=new os,s=new as){this.buffStride=void 0,this.buffTexHeight=void 0,this.texOffset=void 0,this.texExtent=void 0,this.texSubres=void 0,this.buffStride=e,this.buffTexHeight=t,this.texOffset=i,this.texExtent=n,this.texSubres=s}}e("GFXBufferTextureCopy",ls),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(es||(es=e("GFXFormatType",{})));class hs{constructor(e,t,i,n,s,r,o,a){this.name=void 0,this.size=void 0,this.count=void 0,this.type=void 0,this.hasAlpha=void 0,this.hasDepth=void 0,this.hasStencil=void 0,this.isCompressed=void 0,this.name=e,this.size=t,this.count=i,this.type=n,this.hasAlpha=s,this.hasDepth=r,this.hasStencil=o,this.isCompressed=a}}e("GFXFormatInfo",hs);class us{constructor(){this.bufferSize=0,this.textureSize=0}}e("GFXMemoryStatus",us);const _s=e("GFXFormatInfos",Object.freeze([new hs("UNKNOWN",0,0,es.NONE,!1,!1,!1,!1),new hs("A8",1,1,es.UNORM,!0,!1,!1,!1),new hs("L8",1,1,es.UNORM,!1,!1,!1,!1),new hs("LA8",1,2,es.UNORM,!0,!1,!1,!1),new hs("R8",1,1,es.UNORM,!1,!1,!1,!1),new hs("R8SN",1,1,es.SNORM,!1,!1,!1,!1),new hs("R8UI",1,1,es.UINT,!1,!1,!1,!1),new hs("R8I",1,1,es.INT,!1,!1,!1,!1),new hs("R16F",2,1,es.FLOAT,!1,!1,!1,!1),new hs("R16UI",2,1,es.UINT,!1,!1,!1,!1),new hs("R16I",2,1,es.INT,!1,!1,!1,!1),new hs("R32F",4,1,es.FLOAT,!1,!1,!1,!1),new hs("R32UI",4,1,es.UINT,!1,!1,!1,!1),new hs("R32I",4,1,es.INT,!1,!1,!1,!1),new hs("RG8",2,2,es.UNORM,!1,!1,!1,!1),new hs("RG8SN",2,2,es.SNORM,!1,!1,!1,!1),new hs("RG8UI",2,2,es.UINT,!1,!1,!1,!1),new hs("RG8I",2,2,es.INT,!1,!1,!1,!1),new hs("RG16F",4,2,es.FLOAT,!1,!1,!1,!1),new hs("RG16UI",4,2,es.UINT,!1,!1,!1,!1),new hs("RG16I",4,2,es.INT,!1,!1,!1,!1),new hs("RG32F",8,2,es.FLOAT,!1,!1,!1,!1),new hs("RG32UI",8,2,es.UINT,!1,!1,!1,!1),new hs("RG32I",8,2,es.INT,!1,!1,!1,!1),new hs("RGB8",3,3,es.UNORM,!1,!1,!1,!1),new hs("SRGB8",3,3,es.UNORM,!1,!1,!1,!1),new hs("RGB8SN",3,3,es.SNORM,!1,!1,!1,!1),new hs("RGB8UI",3,3,es.UINT,!1,!1,!1,!1),new hs("RGB8I",3,3,es.INT,!1,!1,!1,!1),new hs("RGB16F",6,3,es.FLOAT,!1,!1,!1,!1),new hs("RGB16UI",6,3,es.UINT,!1,!1,!1,!1),new hs("RGB16I",6,3,es.INT,!1,!1,!1,!1),new hs("RGB32F",12,3,es.FLOAT,!1,!1,!1,!1),new hs("RGB32UI",12,3,es.UINT,!1,!1,!1,!1),new hs("RGB32I",12,3,es.INT,!1,!1,!1,!1),new hs("RGBA8",4,4,es.UNORM,!0,!1,!1,!1),new hs("BGRA8",4,4,es.UNORM,!0,!1,!1,!1),new hs("SRGB8_A8",4,4,es.UNORM,!0,!1,!1,!1),new hs("RGBA8SN",4,4,es.SNORM,!0,!1,!1,!1),new hs("RGBA8UI",4,4,es.UINT,!0,!1,!1,!1),new hs("RGBA8I",4,4,es.INT,!0,!1,!1,!1),new hs("RGBA16F",8,4,es.FLOAT,!0,!1,!1,!1),new hs("RGBA16UI",8,4,es.UINT,!0,!1,!1,!1),new hs("RGBA16I",8,4,es.INT,!0,!1,!1,!1),new hs("RGBA32F",16,4,es.FLOAT,!0,!1,!1,!1),new hs("RGBA32UI",16,4,es.UINT,!0,!1,!1,!1),new hs("RGBA32I",16,4,es.INT,!0,!1,!1,!1),new hs("R5G6B5",2,3,es.UNORM,!1,!1,!1,!1),new hs("R11G11B10F",4,3,es.FLOAT,!1,!1,!1,!1),new hs("RGB5A1",2,4,es.UNORM,!0,!1,!1,!1),new hs("RGBA4",2,4,es.UNORM,!0,!1,!1,!1),new hs("RGB10A2",2,4,es.UNORM,!0,!1,!1,!1),new hs("RGB10A2UI",2,4,es.UINT,!0,!1,!1,!1),new hs("RGB9E5",2,4,es.FLOAT,!0,!1,!1,!1),new hs("D16",2,1,es.UINT,!1,!0,!1,!1),new hs("D16S8",3,2,es.UINT,!1,!0,!0,!1),new hs("D24",3,1,es.UINT,!1,!0,!1,!1),new hs("D24S8",4,2,es.UINT,!1,!0,!0,!1),new hs("D32F",4,1,es.FLOAT,!1,!0,!1,!1),new hs("D32FS8",5,2,es.FLOAT,!1,!0,!0,!1),new hs("BC1",1,3,es.UNORM,!1,!1,!1,!0),new hs("BC1_ALPHA",1,4,es.UNORM,!0,!1,!1,!0),new hs("BC1_SRGB",1,3,es.UNORM,!1,!1,!1,!0),new hs("BC1_SRGB_ALPHA",1,4,es.UNORM,!0,!1,!1,!0),new hs("BC2",1,4,es.UNORM,!0,!1,!1,!0),new hs("BC2_SRGB",1,4,es.UNORM,!0,!1,!1,!0),new hs("BC3",1,4,es.UNORM,!0,!1,!1,!0),new hs("BC3_SRGB",1,4,es.UNORM,!0,!1,!1,!0),new hs("BC4",1,1,es.UNORM,!1,!1,!1,!0),new hs("BC4_SNORM",1,1,es.SNORM,!1,!1,!1,!0),new hs("BC5",1,2,es.UNORM,!1,!1,!1,!0),new hs("BC5_SNORM",1,2,es.SNORM,!1,!1,!1,!0),new hs("BC6H_UF16",1,3,es.UFLOAT,!1,!1,!1,!0),new hs("BC6H_SF16",1,3,es.FLOAT,!1,!1,!1,!0),new hs("BC7",1,4,es.UNORM,!0,!1,!1,!0),new hs("BC7_SRGB",1,4,es.UNORM,!0,!1,!1,!0),new hs("ETC_RGB8",1,3,es.UNORM,!1,!1,!1,!0),new hs("ETC2_RGB8",1,3,es.UNORM,!1,!1,!1,!0),new hs("ETC2_SRGB8",1,3,es.UNORM,!1,!1,!1,!0),new hs("ETC2_RGB8_A1",1,4,es.UNORM,!0,!1,!1,!0),new hs("ETC2_SRGB8_A1",1,4,es.UNORM,!0,!1,!1,!0),new hs("ETC2_RGBA8",2,4,es.UNORM,!0,!1,!1,!0),new hs("ETC2_SRGB8_A8",2,4,es.UNORM,!0,!1,!1,!0),new hs("EAC_R11",1,1,es.UNORM,!1,!1,!1,!0),new hs("EAC_R11SN",1,1,es.SNORM,!1,!1,!1,!0),new hs("EAC_RG11",2,2,es.UNORM,!1,!1,!1,!0),new hs("EAC_RG11SN",2,2,es.SNORM,!1,!1,!1,!0),new hs("PVRTC_RGB2",2,3,es.UNORM,!1,!1,!1,!0),new hs("PVRTC_RGBA2",2,4,es.UNORM,!0,!1,!1,!0),new hs("PVRTC_RGB4",2,3,es.UNORM,!1,!1,!1,!0),new hs("PVRTC_RGBA4",2,4,es.UNORM,!0,!1,!1,!0),new hs("PVRTC2_2BPP",2,4,es.UNORM,!0,!1,!1,!0),new hs("PVRTC2_4BPP",2,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_4x4",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_5x4",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_5x5",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_6x5",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_6x6",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_8x5",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_8x6",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_8x8",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_10x5",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_10x6",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_10x8",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_10x10",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_12x10",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_RGBA_12x12",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_4x4",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_5x4",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_5x5",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_6x5",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_6x6",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_8x5",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_8x6",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_8x8",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_10x5",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_10x6",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_10x8",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_10x10",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_12x10",1,4,es.UNORM,!0,!1,!1,!0),new hs("ASTC_SRGBA_12x12",1,4,es.UNORM,!0,!1,!1,!0)]));function ds(e,t,i,n){if(!_s[e].isCompressed)return t*i*n*_s[e].size;switch(e){case En.BC1:case En.BC1_ALPHA:case En.BC1_SRGB:case En.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case En.BC2:case En.BC2_SRGB:case En.BC3:case En.BC3_SRGB:case En.BC4:case En.BC4_SNORM:case En.BC6H_SF16:case En.BC6H_UF16:case En.BC7:case En.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case En.BC5:case En.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case En.ETC_RGB8:case En.ETC2_RGB8:case En.ETC2_SRGB8:case En.ETC2_RGB8_A1:case En.EAC_R11:case En.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case En.ETC2_RGBA8:case En.ETC2_SRGB8_A1:case En.EAC_RG11:case En.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case En.PVRTC_RGB2:case En.PVRTC_RGBA2:case En.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case En.PVRTC_RGB4:case En.PVRTC_RGBA4:case En.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(i,8)/2)*n;case En.ASTC_RGBA_4x4:case En.ASTC_SRGBA_4x4:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case En.ASTC_RGBA_5x4:case En.ASTC_SRGBA_5x4:return Math.ceil(t/5)*Math.ceil(i/4)*16*n;case En.ASTC_RGBA_5x5:case En.ASTC_SRGBA_5x5:return Math.ceil(t/5)*Math.ceil(i/5)*16*n;case En.ASTC_RGBA_6x5:case En.ASTC_SRGBA_6x5:return Math.ceil(t/6)*Math.ceil(i/5)*16*n;case En.ASTC_RGBA_6x6:case En.ASTC_SRGBA_6x6:return Math.ceil(t/6)*Math.ceil(i/6)*16*n;case En.ASTC_RGBA_8x5:case En.ASTC_SRGBA_8x5:return Math.ceil(t/8)*Math.ceil(i/5)*16*n;case En.ASTC_RGBA_8x6:case En.ASTC_SRGBA_8x6:return Math.ceil(t/8)*Math.ceil(i/6)*16*n;case En.ASTC_RGBA_8x8:case En.ASTC_SRGBA_8x8:return Math.ceil(t/8)*Math.ceil(i/8)*16*n;case En.ASTC_RGBA_10x5:case En.ASTC_SRGBA_10x5:return Math.ceil(t/10)*Math.ceil(i/5)*16*n;case En.ASTC_RGBA_10x6:case En.ASTC_SRGBA_10x6:return Math.ceil(t/10)*Math.ceil(i/6)*16*n;case En.ASTC_RGBA_10x8:case En.ASTC_SRGBA_10x8:return Math.ceil(t/10)*Math.ceil(i/8)*16*n;case En.ASTC_RGBA_10x10:case En.ASTC_SRGBA_10x10:return Math.ceil(t/10)*Math.ceil(i/10)*16*n;case En.ASTC_RGBA_12x10:case En.ASTC_SRGBA_12x10:return Math.ceil(t/12)*Math.ceil(i/10)*16*n;case En.ASTC_RGBA_12x12:case En.ASTC_SRGBA_12x12:return Math.ceil(t/12)*Math.ceil(i/12)*16*n;default:return 0}}function ms(e,t,i,n,s){let r=0;for(let o=0;o<s;++o)r+=ds(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1);return r}const ps=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function fs(e){return ps[e]||0}function gs(e){const t=e.size/e.count;switch(e.type){case es.UNORM:case es.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case es.SNORM:case es.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case es.FLOAT:return Float32Array}return Float32Array}class vs{constructor(e=0,t=0,i=new rs,n=new os,s=new as){this.buffStride=e,this.buffTexHeight=t,this.texOffset=i,this.texExtent=n,this.texSubres=s}copy(e){}}e("BufferTextureCopy",vs);var ys=Object.freeze({__proto__:null,GFX_MAX_VERTEX_ATTRIBUTES:fn,GFX_MAX_TEXTURE_UNITS:gn,GFX_MAX_ATTACHMENTS:vn,GFX_MAX_BUFFER_BINDINGS:yn,get GFXObjectType(){return xn},GFXObject:ts,get GFXAttributeName(){return Sn},get GFXType(){return Tn},get GFXFormat(){return En},get GFXBufferUsageBit(){return An},get GFXMemoryUsageBit(){return Cn},get GFXBufferFlagBit(){return bn},get GFXBufferAccessBit(){return Rn},get GFXPrimitiveMode(){return wn},get GFXPolygonMode(){return In},get GFXShadeModel(){return On},get GFXCullMode(){return Pn},get GFXComparisonFunc(){return Mn},get GFXStencilOp(){return Dn},get GFXBlendOp(){return Ln},get GFXBlendFactor(){return Bn},get GFXColorMask(){return Nn},get GFXFilter(){return Fn},get GFXAddress(){return zn},get GFXTextureType(){return Un},get GFXTextureUsageBit(){return Gn},get GFXSampleCount(){return Hn},get GFXTextureFlagBit(){return Vn},get GFXShaderStageFlagBit(){return kn},get GFXDescriptorType(){return Wn},get GFXCommandBufferType(){return jn},get GFXLoadOp(){return qn},get GFXStoreOp(){return Xn},get GFXTextureLayout(){return Yn},get GFXPipelineBindPoint(){return Kn},get GFXDynamicStateFlagBit(){return Zn},get GFXStencilFace(){return $n},get GFXQueueType(){return Qn},GFXRect:is,GFXViewport:ns,GFXColor:ss,get GFXClearFlag(){return Jn},GFXOffset:rs,GFXExtent:os,GFXTextureSubres:as,GFXTextureCopy:cs,GFXBufferTextureCopy:ls,get GFXFormatType(){return es},GFXFormatInfo:hs,GFXMemoryStatus:us,GFXFormatInfos:_s,GFXFormatSize:ds,GFXFormatSurfaceSize:ms,GFXGetTypeSize:fs,getTypedArrayConstructor:gs,BufferTextureCopy:vs});class xs{constructor(e=0,t=0,i=0,n=0,s=0,r=0,o=0){this.vertexCount=void 0,this.firstVertex=void 0,this.indexCount=void 0,this.firstIndex=void 0,this.vertexOffset=void 0,this.instanceCount=void 0,this.firstInstance=void 0,this.vertexCount=e,this.firstVertex=t,this.indexCount=i,this.firstIndex=n,this.vertexOffset=s,this.instanceCount=r,this.firstInstance=o}}e("GFXDrawInfo",xs);e("GFX_DRAW_INFO_SIZE",28);class Ss extends ts{get usage(){return this._usage}get memUsage(){return this._memUsage}get size(){return this._size}get stride(){return this._stride}get count(){return this._count}get flags(){return this._flags}get backupBuffer(){return this._bakcupBuffer}constructor(e){super(xn.BUFFER),this._device=void 0,this._usage=An.NONE,this._memUsage=Cn.NONE,this._size=0,this._stride=1,this._count=0,this._flags=bn.NONE,this._bakcupBuffer=null,this._indirectBuffer=null,this._isBufferView=!1,this._device=e}}e("GFXBuffer",Ss);class Ts extends ts{get type(){return this._type}get queue(){return this._queue}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}constructor(e){super(xn.COMMAND_BUFFER),this._device=void 0,this._queue=null,this._type=jn.PRIMARY,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._device=e}}let Es,As;e("GFXCommandBuffer",Ts),$e(En),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GL=1]="GL",e[e.GLES2=2]="GLES2",e[e.GLES3=3]="GLES3",e[e.METAL=4]="METAL",e[e.VULKAN=5]="VULKAN",e[e.DX12=6]="DX12",e[e.WEBGL=7]="WEBGL",e[e.WEBGL2=8]="WEBGL2"}(Es||(Es=e("GFXAPI",{}))),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_D16=7]="FORMAT_D16",e[e.FORMAT_D16S8=8]="FORMAT_D16S8",e[e.FORMAT_D24=9]="FORMAT_D24",e[e.FORMAT_D24S8=10]="FORMAT_D24S8",e[e.FORMAT_D32F=11]="FORMAT_D32F",e[e.FORMAT_D32FS8=12]="FORMAT_D32FS8",e[e.FORMAT_ETC1=13]="FORMAT_ETC1",e[e.FORMAT_ETC2=14]="FORMAT_ETC2",e[e.FORMAT_DXT=15]="FORMAT_DXT",e[e.FORMAT_PVRTC=16]="FORMAT_PVRTC",e[e.FORMAT_ASTC=17]="FORMAT_ASTC",e[e.FORMAT_RGB8=18]="FORMAT_RGB8",e[e.MSAA=19]="MSAA",e[e.ELEMENT_INDEX_UINT=20]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=21]="INSTANCED_ARRAYS",e[e.COUNT=22]="COUNT"}(As||(As=e("GFXFeature",{})));class Cs{constructor(){this.bufferOffsets=[],this.samplerOffsets=[]}}e("GFXBindingMappingInfo",Cs);class bs{constructor(){this._canvas=null,this._canvas2D=null,this._gfxAPI=Es.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(As.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=yn,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._uboOffsetAlignment=1,this._depthBits=0,this._stencilBits=0,this._colorFmt=En.UNKNOWN,this._depthStencilFmt=En.UNKNOWN,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus={bufferSize:0,textureSize:0},this._clipSpaceMinZ=-1,this._screenSpaceSignY=1,this._UVSpaceSignY=-1}get canvas(){return this._canvas}get canvas2D(){return this._canvas2D}get gfxAPI(){return this._gfxAPI}get queue(){return this._queue}get devicePixelRatio(){return this._devicePixelRatio}get width(){return this._width}get height(){return this._height}get nativeWidth(){return this._nativeWidth}get nativeHeight(){return this._nativeHeight}get renderer(){return this._renderer}get vendor(){return this._vendor}get maxVertexAttributes(){return this._maxVertexAttributes}get maxVertexUniformVectors(){return this._maxVertexUniformVectors}get maxFragmentUniformVectors(){return this._maxFragmentUniformVectors}get maxTextureUnits(){return this._maxTextureUnits}get maxVertexTextureUnits(){return this._maxVertexTextureUnits}get maxUniformBufferBindings(){return this._maxUniformBufferBindings}get maxUniformBlockSize(){return this._maxUniformBlockSize}get maxTextureSize(){return this._maxTextureSize}get maxCubeMapTextureSize(){return this._maxCubeMapTextureSize}get uboOffsetAlignment(){return this._uboOffsetAlignment}get depthBits(){return this._depthBits}get stencilBits(){return this._stencilBits}get colorFormat(){return this._colorFmt}get depthStencilFormat(){return this._depthStencilFmt}get macros(){return this._macros}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}get memoryStatus(){return this._memoryStatus}get clipSpaceMinZ(){return this._clipSpaceMinZ}get screenSpaceSignY(){return this._screenSpaceSignY}get UVSpaceSignY(){return this._UVSpaceSignY}hasFeature(e){return this._features[e]}genShaderId(){return this._shaderIdGen++}defineMacro(e,t){const i=void 0!==t?t:"";this._macros.set(e,i)}}e("GFXDevice",bs);class Rs extends ts{get renderPass(){return this._renderPass}get colorTextures(){return this._colorTextures}get depthStencilTexture(){return this._depthStencilTexture}constructor(e){super(xn.FRAMEBUFFER),this._device=void 0,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._device=e}}e("GFXFramebuffer",Rs);const ws=String.prototype.charCodeAt;function Is(e){return this[e]}function Os(e,t){let i=e.length,n=t^i,s=0;const r="string"==typeof e?ws:Is;for(;i>=4;){let t=255&r.call(e,s)|(255&r.call(e,++s))<<8|(255&r.call(e,++s))<<16|(255&r.call(e,++s))<<24;t=1540483477*(65535&t)+((1540483477*(t>>>16)&65535)<<16),t^=t>>>24,t=1540483477*(65535&t)+((1540483477*(t>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^t,i-=4,++s}switch(i){case 3:n^=(255&r.call(e,s+2))<<16;case 2:n^=(255&r.call(e,s+1))<<8;case 1:n^=255&r.call(e,s),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)}return n^=n>>>13,n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16),n^=n>>>15,n>>>0}class Ps extends ts{get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get attributes(){return this._attributes}get attributesHash(){return this._attributesHash}get vertexCount(){return this._vertexCount}set vertexCount(e){this._vertexCount=e}get firstVertex(){return this._firstVertex}set firstVertex(e){this._firstVertex=e}get indexCount(){return this._indexCount}set indexCount(e){this._indexCount=e}get firstIndex(){return this._firstIndex}set firstIndex(e){this._firstIndex=e}get vertexOffset(){return this._vertexOffset}set vertexOffset(e){this._vertexOffset=e}get instanceCount(){return this._instanceCount}set instanceCount(e){this._instanceCount=e}get firstInstance(){return this._firstInstance}set firstInstance(e){this._firstInstance=e}get indirectBuffer(){return this._indirectBuffer}constructor(e){super(xn.INPUT_ASSEMBLER),this._device=void 0,this._attributes=[],this._vertexBuffers=[],this._indexBuffer=null,this._vertexCount=0,this._firstVertex=0,this._indexCount=0,this._firstIndex=0,this._vertexOffset=0,this._instanceCount=0,this._firstInstance=0,this._attributesHash=0,this._indirectBuffer=null,this._device=e}getVertexBuffer(e=0){return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}computeAttributesHash(){let e="attrs";for(let t=0;t<this.attributes.length;++t){const i=this.attributes[t];e+=`,${i.name},${i.format},${i.isNormalized},${i.stream},${i.isInstanced}`}return Os(e,666)}}e("GFXInputAssembler",Ps);class Ms{constructor(){this.isDiscard=!1,this.polygonMode=In.FILL,this.shadeModel=On.GOURAND,this.cullMode=Pn.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}compare(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}e("GFXRasterizerState",Ms);class Ds{constructor(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Mn.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Mn.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Dn.KEEP,this.stencilZFailOpFront=Dn.KEEP,this.stencilPassOpFront=Dn.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Mn.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Dn.KEEP,this.stencilZFailOpBack=Dn.KEEP,this.stencilPassOpBack=Dn.KEEP,this.stencilRefBack=1}compare(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}e("GFXDepthStencilState",Ds);class Ls{constructor(){this.blend=!1,this.blendSrc=Bn.ONE,this.blendDst=Bn.ZERO,this.blendEq=Ln.ADD,this.blendSrcAlpha=Bn.ONE,this.blendDstAlpha=Bn.ZERO,this.blendAlphaEq=Ln.ADD,this.blendColorMask=Nn.ALL}compare(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}e("GFXBlendTarget",Ls);class Bs{constructor(){this.isA2C=!1,this.isIndepend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.targets=[new Ls]}}e("GFXBlendState",Bs);class Ns{constructor(){this.attributes=[]}}e("GFXInputState",Ns);class Fs extends ts{get shader(){return this._shader}get pipelineLayout(){return this._pipelineLayout}get primitive(){return this._primitive}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get inputState(){return this._is}get dynamicStates(){return this._dynamicStates}get renderPass(){return this._renderPass}constructor(e){super(xn.PIPELINE_STATE),this._device=void 0,this._shader=null,this._pipelineLayout=null,this._primitive=wn.TRIANGLE_LIST,this._is=null,this._rs=null,this._dss=null,this._bs=null,this._dynamicStates=Zn.NONE,this._renderPass=null,this._device=e}}e("GFXPipelineState",Fs);class zs extends ts{get type(){return this._type}constructor(e){super(xn.QUEUE),this._device=void 0,this._type=Qn.GRAPHICS,this._isAsync=!1,this._device=e}isAsync(){return this._isAsync}}e("GFXQueue",zs);class Us{constructor(){this.format=En.UNKNOWN,this.sampleCount=1,this.loadOp=qn.CLEAR,this.storeOp=Xn.STORE,this.beginLayout=Yn.UNDEFINED,this.endLayout=Yn.PRESENT_SRC}}e("GFXColorAttachment",Us);class Gs{constructor(){this.format=En.UNKNOWN,this.sampleCount=1,this.depthLoadOp=qn.CLEAR,this.depthStoreOp=Xn.STORE,this.stencilLoadOp=qn.CLEAR,this.stencilStoreOp=Xn.STORE,this.beginLayout=Yn.UNDEFINED,this.endLayout=Yn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}e("GFXDepthStencilAttachment",Gs);class Hs extends ts{get colorAttachments(){return this._colorInfos}get depthStencilAttachment(){return this._depthStencilInfo}get subPasses(){return this._subPasses}get hash(){return this._hash}constructor(e){super(xn.RENDER_PASS),this._device=void 0,this._colorInfos=[],this._depthStencilInfo=null,this._subPasses=[],this._hash=0,this._device=e}computeHash(){let e="";if(this._subPasses.length)for(let t=0;t<this._subPasses.length;++t){const i=this._subPasses[t];if(i.inputs.length){e+="ia";for(let t=0;t<i.inputs.length;++t){const n=this._colorInfos[i.inputs[t]];e+=`,${n.format},${n.sampleCount}`}}if(i.colors.length){e+="ca";for(let t=0;t<i.inputs.length;++t){const n=this._colorInfos[i.inputs[t]];e+=`,${n.format},${n.sampleCount}`}}if(void 0!==i.depthStencil){const t=this._colorInfos[i.depthStencil];e+=`ds,${t.format},${t.sampleCount}`}}else{e+="ca";for(let t=0;t<this._colorInfos.length;++t){const i=this._colorInfos[t];e+=`,${i.format},${i.sampleCount}`}const t=this._depthStencilInfo;t&&(e+=`ds,${t.format},${t.sampleCount}`)}return Os(e,666)}}e("GFXRenderPass",Hs);class Vs{constructor(){this.name="",this.minFilter=Fn.LINEAR,this.magFilter=Fn.LINEAR,this.mipFilter=Fn.NONE,this.addressU=zn.WRAP,this.addressV=zn.WRAP,this.addressW=zn.WRAP,this.maxAnisotropy=16,this.cmpFunc=Mn.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}compare(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}e("GFXSamplerState",Vs);class ks extends ts{get state(){return this._state}constructor(e){super(xn.SAMPLER),this._device=void 0,this._state=new Vs,this._device=e,this._state=new Vs}}e("GFXSampler",ks);e("GFXShaderStage",class{constructor(){this.stage=kn.NONE,this.source=""}});e("GFXUniform",class{constructor(){this.name="",this.type=Tn.UNKNOWN,this.count=1}});e("GFXUniformBlock",class{constructor(){this.set=-1,this.binding=-1,this.name="",this.members=[],this.count=1}});e("GFXUniformSampler",class{constructor(){this.set=-1,this.binding=-1,this.name="",this.type=Tn.UNKNOWN,this.count=1}});e("GFXShaderInfo",class{constructor(){this.name="",this.stages=[],this.attributes=[],this.blocks=[],this.samplers=[]}});class Ws extends ts{get id(){return this._id}get name(){return this._name}get attributes(){return this._attributes}get blocks(){return this._blocks}get samplers(){return this._samplers}constructor(e){super(xn.SHADER),this._device=void 0,this._id=void 0,this._name="",this._stages=[],this._attributes=[],this._blocks=[],this._samplers=[],this._device=e,this._id=e.genShaderId()}}function js(e){return e>0&&0==(e&e-1)}e("GFXShader",Ws);class qs extends ts{get type(){return this._type}get usage(){return this._usage}get format(){return this._format}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get layerCount(){return this._layerCount}get levelCount(){return this._levelCount}get samples(){return this._samples}get flags(){return this._flags}get size(){return this._size}get buffer(){return this._buffer}constructor(e){super(xn.TEXTURE),this._device=void 0,this._type=Un.TEX2D,this._usage=Gn.NONE,this._format=En.UNKNOWN,this._width=0,this._height=0,this._depth=1,this._layerCount=1,this._levelCount=1,this._samples=Hn.X1,this._flags=Vn.NONE,this._isPowerOf2=!1,this._size=0,this._buffer=null,this._device=e}}e("GFXTexture",qs);const Xs=e("DESCRIPTOR_BUFFER_TYPE",Wn.UNIFORM_BUFFER|Wn.DYNAMIC_UNIFORM_BUFFER|Wn.STORAGE_BUFFER|Wn.DYNAMIC_STORAGE_BUFFER),Ys=e("DESCRIPTOR_SAMPLER_TYPE",Wn.SAMPLER);class Ks extends ts{get layout(){return this._layout}constructor(e){super(xn.DESCRIPTOR_SET),this._device=void 0,this._layout=null,this._buffers=[],this._textures=[],this._samplers=[],this._isDirty=!1,this._device=e}bindBuffer(e,t,i=0){const n=this._layout.bindings[e],s=this._layout.descriptorIndices[e];n&&n.descriptorType&Xs?this._buffers[s+i]!==t&&(this._buffers[s+i]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.UNIFORM_BUFFER.")}bindSampler(e,t,i=0){const n=this._layout.bindings[e],s=this._layout.descriptorIndices[e];n&&n.descriptorType&Ys?this._samplers[s+i]!==t&&(this._samplers[s+i]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.SAMPLER.")}bindTexture(e,t,i=0){const n=this._layout.bindings[e],s=this._layout.descriptorIndices[e];n&&n.descriptorType&Ys?this._textures[s+i]!==t&&(this._textures[s+i]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.SAMPLER.")}getBuffer(e,t=0){const i=this._layout.descriptorIndices[e];return this._buffers[i+t]}getSampler(e,t=0){const i=this._layout.descriptorIndices[e];return this._samplers[i+t]}getTexture(e,t=0){const i=this._layout.descriptorIndices[e];return this._textures[i+t]}}e("GFXDescriptorSet",Ks);const Zs=e("DESCRIPTOR_DYNAMIC_TYPE",Wn.DYNAMIC_STORAGE_BUFFER|Wn.DYNAMIC_UNIFORM_BUFFER);class $s extends ts{get bindings(){return this._bindings}get descriptorIndices(){return this._descriptorIndices}constructor(e){super(xn.DESCRIPTOR_SET_LAYOUT),this._device=void 0,this._bindings=[],this._descriptorIndices=[],this._device=e}}e("GFXDescriptorSetLayout",$s);class Qs extends ts{get setLayouts(){return this._setLayouts}constructor(e){super(xn.PIPELINE_LAYOUT),this._device=void 0,this._setLayouts=[],this._device=e}}e("GFXPipelineLayout",Qs);class Js extends ts{constructor(e){super(xn.FENCE),this._device=void 0,this._device=e}}let er;e("GFXFence",Js),i.GFXDevice=bs,i.GFXBuffer=Ss,i.GFXTexture=qs,i.GFXSampler=ks,i.GFXShader=Ws,i.GFXInputAssembler=Ps,i.GFXRenderPass=Hs,i.GFXFramebuffer=Rs,i.GFXPipelineState=Fs,i.GFXCommandBuffer=Ts,i.GFXQueue=zs,Object.assign(i,ys),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(er||(er={}));const tr=function(){const e=new _i(0,0,0);return function(t,i){const n=_i.dot(t.d,i.n);if(Math.abs(n)<Number.EPSILON)return 0;_i.multiplyScalar(e,i.n,i.d);const s=_i.dot(_i.subtract(e,e,t.o),i.n)/n;return s<0?0:s}}(),ir=function(){const e=new _i(0,0,0),t=new _i(0,0,0),i=new _i(0,0,0),n=new _i(0,0,0),s=new _i(0,0,0);return function(r,o,a){_i.subtract(e,o.b,o.a),_i.subtract(t,o.c,o.a),_i.cross(i,r.d,t);const c=_i.dot(e,i);if(c<Number.EPSILON&&(!a||c>-Number.EPSILON))return 0;const l=1/c;_i.subtract(n,r.o,o.a);const h=_i.dot(n,i)*l;if(h<0||h>1)return 0;_i.cross(s,n,e);const u=_i.dot(r.d,s)*l;if(u<0||h+u>1)return 0;const _=_i.dot(t,s)*l;return _<0?0:_}}(),nr=function(){const e=new _i(0,0,0);return function(t,i){const n=i.radius,s=i.center,r=t.o,o=t.d,a=n*n;_i.subtract(e,s,r);const c=e.lengthSqr(),l=_i.dot(e,o),h=a-(c-l*l);if(h<0)return 0;const u=Math.sqrt(h),_=c<a?l+u:l-u;return _<0?0:_}}(),sr=function(){const e=new _i,t=new _i;return function(i,n){return _i.subtract(e,n.center,n.halfExtents),_i.add(t,n.center,n.halfExtents),rr(i,e,t)}}();function rr(e,t,i){const n=e.o,s=e.d,r=1/s.x,o=1/s.y,a=1/s.z,c=(t.x-n.x)*r,l=(i.x-n.x)*r,h=(t.y-n.y)*o,u=(i.y-n.y)*o,_=(t.z-n.z)*a,d=(i.z-n.z)*a,m=Math.max(Math.max(Math.min(c,l),Math.min(h,u)),Math.min(_,d)),p=Math.min(Math.min(Math.max(c,l),Math.max(h,u)),Math.max(_,d));return p<0||m>p?0:m>0?m:p}const or=function(){let e=new _i,t=new _i,i=new _i;const n=new _i,s=new _i,r=new _i,o=new _i,a=new Array(3),c=new Array(3),l=new Array(3),h=new Array(6);return function(u,_){a[0]=_.halfExtents.x,a[1]=_.halfExtents.y,a[2]=_.halfExtents.z,e=_.center,t=u.o,i=u.d,_i.set(n,_.orientation.m00,_.orientation.m01,_.orientation.m02),_i.set(s,_.orientation.m03,_.orientation.m04,_.orientation.m05),_i.set(r,_.orientation.m06,_.orientation.m07,_.orientation.m08),_i.subtract(o,e,t),c[0]=_i.dot(n,i),c[1]=_i.dot(s,i),c[2]=_i.dot(r,i),l[0]=_i.dot(n,o),l[1]=_i.dot(s,o),l[2]=_i.dot(r,o);for(let e=0;e<3;++e){if(0===c[e]){if(-l[e]-a[e]>0||-l[e]+a[e]<0)return 0;c[e]=1e-7}h[2*e+0]=(l[e]+a[e])/c[e],h[2*e+1]=(l[e]-a[e])/c[e]}const d=Math.max(Math.max(Math.min(h[0],h[1]),Math.min(h[2],h[3])),Math.min(h[4],h[5])),m=Math.min(Math.min(Math.max(h[0],h[1]),Math.max(h[2],h[3])),Math.max(h[4],h[5]));return m<0||d>m?0:d>0?d:m}}(),ar=function(){const e=new _i,t=new _i,i=new _i,n=new _i,s=new _i,r=new _i,o=new _i,a=new mn;return function(c,l){const h=l.radius*l.radius,u=_i.normalize(e,c.d),_=l.ellipseCenter0,d=l.ellipseCenter1,m=_i.subtract(t,d,_);if(m.equals(_i.ZERO))return a.radius=l.radius,a.center.set(l.ellipseCenter0),zr.ray_sphere(c,a);const p=c.o,f=_i.subtract(i,p,_),g=_i.cross(n,u,m),v=g.lengthSqr();if(0===v){a.radius=l.radius;const e=_i.subtract(s,d,p);return f.lengthSqr()<e.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),zr.ray_sphere(c,a)}const y=_i.cross(s,f,m),x=m.lengthSqr(),S=2*_i.dot(g,y),T=S*S-4*v*(y.lengthSqr()-h*x);if(T<0)return 0;const E=(-S-Math.sqrt(T))/(2*v);if(E<0){a.radius=l.radius;const e=_i.subtract(r,d,p);return f.lengthSqr()<e.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),zr.ray_sphere(c,a)}{const e=_i.scaleAndAdd(r,c.o,u,E),t=_i.subtract(o,e,_),i=_i.dot(t,m)/x;return i>=0&&i<=1?E:i<0?(a.radius=l.radius,a.center.set(l.ellipseCenter0),zr.ray_sphere(c,a)):i>1?(a.radius=l.radius,a.center.set(l.ellipseCenter1),zr.ray_sphere(c,a)):0}}}(),cr=function(){const e=pn.create(),t={distance:1/0,doubleSided:!1,mode:er.ANY};let i=0;const n=(e,t,n,s,r,o)=>{e===er.CLOSEST?(i>t||0===i)&&(i=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:s/3,vertexIndex2:r/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=s/3,o[0].vertexIndex2=r/3))):(i=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:s/3,vertexIndex2:r/3}))};return function(s,r,o){if(i=0,0===r.geometricInfo.positions.length)return i;const a=void 0===o?t:o;if(rr(s,r.geometricInfo.boundingBox.min,r.geometricInfo.boundingBox.max)){const t=r.primitiveMode,{positions:i,indices:o}=r.geometricInfo;((t,i,s,r,o)=>{if(s===wn.TRIANGLE_LIST){const s=i.length;for(let a=0;a<s;a+=3){const s=3*i[a],c=3*i[a+1],l=3*i[a+2];_i.set(e.a,t[s],t[s+1],t[s+2]),_i.set(e.b,t[c],t[c+1],t[c+2]),_i.set(e.c,t[l],t[l+1],t[l+2]);const h=zr.ray_triangle(r,e,o.doubleSided);if(!(0===h||h>o.distance)&&(n(o.mode,h,s,c,l,o.result),o.mode===er.ANY))return h}}else if(s===wn.TRIANGLE_STRIP){const s=i.length-2;let a=0;for(let c=0;c<s;c+=1){const s=3*i[c-a],l=3*i[c+a+1],h=3*i[c+2];_i.set(e.a,t[s],t[s+1],t[s+2]),_i.set(e.b,t[l],t[l+1],t[l+2]),_i.set(e.c,t[h],t[h+1],t[h+2]),a=~a;const u=zr.ray_triangle(r,e,o.doubleSided);if(!(0===u||u>o.distance)&&(n(o.mode,u,s,l,h,o.result),o.mode===er.ANY))return u}}else if(s===wn.TRIANGLE_FAN){const s=i.length-1,a=3*i[0];_i.set(e.a,t[a],t[a+1],t[a+2]);for(let c=1;c<s;c+=1){const s=3*i[c],l=3*i[c+1];_i.set(e.b,t[s],t[s+1],t[s+2]),_i.set(e.c,t[l],t[l+1],t[l+2]);const h=zr.ray_triangle(r,e,o.doubleSided);if(!(0===h||h>o.distance)&&(n(o.mode,h,a,s,l,o.result),o.mode===er.ANY))return h}}})(i,o,t,s,a)}return i}}(),lr=function(){let e=0;const t={distance:1/0,doubleSided:!1,mode:er.ANY};return function(i,n,s){e=0;const r=void 0===s?t:s,o=n.renderingSubMeshes.length,a=n.struct.minPosition,c=n.struct.maxPosition;if(a&&c&&!rr(i,a,c))return e;for(let t=0;t<o;t++){const s=n.renderingSubMeshes[t],o=cr(i,s,r);if(o)if(r.mode===er.CLOSEST)(0===e||e>o)&&(e=o,r.subIndices&&(r.subIndices[0]=t));else if(e=o,r.subIndices&&r.subIndices.push(t),r.mode===er.ANY)return o}return e&&r.mode===er.CLOSEST&&(r.result&&(r.result[0].distance=e,r.result.length=1),r.subIndices&&(r.subIndices.length=1)),e}}(),hr=function(){let e=0;const t={distance:1/0,doubleSided:!1,mode:er.ANY},i=new cn,n=new wi;return function(s,r,o){e=0;const a=void 0===o?t:o,c=r.worldBounds;if(c&&!sr(s,c))return e;cn.copy(i,s),r.node&&(wi.invert(n,r.node.getWorldMatrix(n)),_i.transformMat4(i.o,s.o,n),_i.transformMat4Normal(i.d,s.d,n));const l=r.subModels;for(let t=0;t<l.length;t++){const n=l[t].subMesh,s=cr(i,n,a);if(s)if(a.mode===er.CLOSEST)(0===e||e>s)&&(e=s,a.subIndices&&(a.subIndices[0]=t));else if(e=s,a.subIndices&&a.subIndices.push(t),a.mode===er.ANY)return s}return e&&a.mode===er.CLOSEST&&(a.result&&(a.result[0].distance=e,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),e}}(),ur=function(){const e=new _i(0,0,0);return function(t,i){_i.subtract(e,t.e,t.s);const n=(i.d-_i.dot(t.s,i.n))/_i.dot(e,i.n);return n<0||n>1?0:n}}(),_r=function(){const e=new _i(0,0,0),t=new _i(0,0,0),i=new _i(0,0,0),n=new _i(0,0,0),s=new _i(0,0,0),r=new _i(0,0,0);return function(o,a,c){_i.subtract(e,a.b,a.a),_i.subtract(t,a.c,a.a),_i.subtract(i,o.s,o.e),_i.cross(s,e,t);const l=_i.dot(i,s);if(l<=0)return 0;_i.subtract(n,o.s,a.a);const h=_i.dot(n,s);if(h<0||h>l)return 0;_i.cross(r,i,n);let u=_i.dot(t,r);if(u<0||u>l)return 0;let _=-_i.dot(e,r);if(_<0||u+_>l)return 0;if(c){const e=1/l;u*=e,_*=e;const t=1-u-_;_i.set(c,a.a.x*t+a.b.x*u+a.c.x*_,a.a.y*t+a.b.y*u+a.c.y*_,a.a.z*t+a.b.z*u+a.c.z*_)}return 1}}(),dr=new cn;function mr(e,t){dr.o.set(e.s),_i.subtract(dr.d,e.e,e.s),dr.d.normalize();const i=sr(dr,t);return i<=e.length()?i:0}function pr(e,t){dr.o.set(e.s),_i.subtract(dr.d,e.e,e.s),dr.d.normalize();const i=or(dr,t);return i<=e.length()?i:0}function fr(e,t){dr.o.set(e.s),_i.subtract(dr.d,e.e,e.s),dr.d.normalize();const i=nr(dr,t);return i<=e.length()?i:0}const gr=function(){const e=new _i,t=new _i,i=new _i,n=new _i;return function(s,r){return _i.subtract(e,s.center,s.halfExtents),_i.add(t,s.center,s.halfExtents),_i.subtract(i,r.center,r.halfExtents),_i.add(n,r.center,r.halfExtents),e.x<=n.x&&t.x>=i.x&&e.y<=n.y&&t.y>=i.y&&e.z<=n.z&&t.z>=i.z}}();function vr(e,t,i,n,s,r){_i.set(r[0],e.x+i.x*t.x+n.x*t.y+s.x*t.z,e.y+i.y*t.x+n.y*t.y+s.y*t.z,e.z+i.z*t.x+n.z*t.y+s.z*t.z),_i.set(r[1],e.x-i.x*t.x+n.x*t.y+s.x*t.z,e.y-i.y*t.x+n.y*t.y+s.y*t.z,e.z-i.z*t.x+n.z*t.y+s.z*t.z),_i.set(r[2],e.x+i.x*t.x-n.x*t.y+s.x*t.z,e.y+i.y*t.x-n.y*t.y+s.y*t.z,e.z+i.z*t.x-n.z*t.y+s.z*t.z),_i.set(r[3],e.x+i.x*t.x+n.x*t.y-s.x*t.z,e.y+i.y*t.x+n.y*t.y-s.y*t.z,e.z+i.z*t.x+n.z*t.y-s.z*t.z),_i.set(r[4],e.x-i.x*t.x-n.x*t.y-s.x*t.z,e.y-i.y*t.x-n.y*t.y-s.y*t.z,e.z-i.z*t.x-n.z*t.y-s.z*t.z),_i.set(r[5],e.x+i.x*t.x-n.x*t.y-s.x*t.z,e.y+i.y*t.x-n.y*t.y-s.y*t.z,e.z+i.z*t.x-n.z*t.y-s.z*t.z),_i.set(r[6],e.x-i.x*t.x+n.x*t.y-s.x*t.z,e.y-i.y*t.x+n.y*t.y-s.y*t.z,e.z-i.z*t.x+n.z*t.y-s.z*t.z),_i.set(r[7],e.x-i.x*t.x-n.x*t.y+s.x*t.z,e.y-i.y*t.x-n.y*t.y+s.y*t.z,e.z-i.z*t.x-n.z*t.y+s.z*t.z)}function yr(e,t){let i=_i.dot(t,e[0]),n=i;for(let s=1;s<8;++s){const r=_i.dot(t,e[s]);i=r<i?r:i,n=r>n?r:n}return[i,n]}const xr=function(){const e=new Array(15);for(let t=0;t<15;t++)e[t]=new _i(0,0,0);const t=new Array(8),i=new Array(8);for(let e=0;e<8;e++)t[e]=new _i(0,0,0),i[e]=new _i(0,0,0);const n=new _i,s=new _i;return function(r,o){_i.set(e[0],1,0,0),_i.set(e[1],0,1,0),_i.set(e[2],0,0,1),_i.set(e[3],o.orientation.m00,o.orientation.m01,o.orientation.m02),_i.set(e[4],o.orientation.m03,o.orientation.m04,o.orientation.m05),_i.set(e[5],o.orientation.m06,o.orientation.m07,o.orientation.m08);for(let t=0;t<3;++t)_i.cross(e[6+3*t+0],e[t],e[0]),_i.cross(e[6+3*t+1],e[t],e[1]),_i.cross(e[6+3*t+1],e[t],e[2]);_i.subtract(n,r.center,r.halfExtents),_i.add(s,r.center,r.halfExtents),function(e,t,i){_i.set(i[0],e.x,t.y,t.z),_i.set(i[1],e.x,t.y,e.z),_i.set(i[2],e.x,e.y,t.z),_i.set(i[3],e.x,e.y,e.z),_i.set(i[4],t.x,t.y,t.z),_i.set(i[5],t.x,t.y,e.z),_i.set(i[6],t.x,e.y,t.z),_i.set(i[7],t.x,e.y,e.z)}(n,s,t),vr(o.center,o.halfExtents,e[3],e[4],e[5],i);for(let n=0;n<15;++n){const s=yr(t,e[n]),r=yr(i,e[n]);if(r[0]>s[1]||s[0]>r[1])return 0}return 1}}(),Sr=function(e,t){const i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=_i.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1},Tr=function(e,t){for(let i=0;i<t.planes.length;i++)if(-1===Sr(e,t.planes[i]))return 0;return 1},Er=function(){const e=new Array(8);let t=0,i=0;for(let t=0;t<e.length;t++)e[t]=new _i(0,0,0);return function(n,s){let r=0,o=!1;for(let e=0;e<s.planes.length;e++){if(r=Sr(n,s.planes[e]),-1===r)return 0;1===r&&(o=!0)}if(!o)return 1;for(let t=0;t<s.vertices.length;t++)_i.subtract(e[t],s.vertices[t],n.center);t=0,i=0;for(let r=0;r<s.vertices.length;r++)e[r].x>n.halfExtents.x?t++:e[r].x<-n.halfExtents.x&&i++;if(t===s.vertices.length||i===s.vertices.length)return 0;t=0,i=0;for(let r=0;r<s.vertices.length;r++)e[r].y>n.halfExtents.y?t++:e[r].y<-n.halfExtents.y&&i++;if(t===s.vertices.length||i===s.vertices.length)return 0;t=0,i=0;for(let r=0;r<s.vertices.length;r++)e[r].z>n.halfExtents.z?t++:e[r].z<-n.halfExtents.z&&i++;return t===s.vertices.length||i===s.vertices.length?0:1}}(),Ar=function(){const e=new _i(0,0,0),t=new vi;return function(i,n){return _i.subtract(e,n,i.center),_i.transformMat3(e,e,vi.transpose(t,i.orientation)),s=e,r=i.halfExtents,Math.abs(s.x)<r.x&&Math.abs(s.y)<r.y&&Math.abs(s.z)<r.z;var s,r}}(),Cr=function(){const e=function(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)};return function(t,i){const n=t.halfExtents.x*e(i.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.halfExtents.y*e(i.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.halfExtents.z*e(i.n,t.orientation.m06,t.orientation.m07,t.orientation.m08),s=_i.dot(i.n,t.center);return s+n<i.d?-1:s-n>i.d?0:1}}(),br=function(e,t){for(let i=0;i<t.planes.length;i++)if(-1===Cr(e,t.planes[i]))return 0;return 1},Rr=function(){const e=new Array(8);let t=0,i=0,n=0;for(let t=0;t<e.length;t++)e[t]=new _i(0,0,0);const s=function(e,t,i,n){return e.x*t+e.y*i+e.z*n};return function(r,o){let a=0,c=!1;for(let e=0;e<o.planes.length;e++){if(a=Cr(r,o.planes[e]),-1===a)return 0;1===a&&(c=!0)}if(!c)return 1;for(let t=0;t<o.vertices.length;t++)_i.subtract(e[t],o.vertices[t],r.center);i=0,n=0;for(let a=0;a<o.vertices.length;a++)t=s(e[a],r.orientation.m00,r.orientation.m01,r.orientation.m02),t>r.halfExtents.x?i++:t<-r.halfExtents.x&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(let a=0;a<o.vertices.length;a++)t=s(e[a],r.orientation.m03,r.orientation.m04,r.orientation.m05),t>r.halfExtents.y?i++:t<-r.halfExtents.y&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(let a=0;a<o.vertices.length;a++)t=s(e[a],r.orientation.m06,r.orientation.m07,r.orientation.m08),t>r.halfExtents.z?i++:t<-r.halfExtents.z&&n++;return i===o.vertices.length||n===o.vertices.length?0:1}}(),wr=function(){const e=new Array(15);for(let t=0;t<15;t++)e[t]=new _i(0,0,0);const t=new Array(8),i=new Array(8);for(let e=0;e<8;e++)t[e]=new _i(0,0,0),i[e]=new _i(0,0,0);return function(n,s){_i.set(e[0],n.orientation.m00,n.orientation.m01,n.orientation.m02),_i.set(e[1],n.orientation.m03,n.orientation.m04,n.orientation.m05),_i.set(e[2],n.orientation.m06,n.orientation.m07,n.orientation.m08),_i.set(e[3],s.orientation.m00,s.orientation.m01,s.orientation.m02),_i.set(e[4],s.orientation.m03,s.orientation.m04,s.orientation.m05),_i.set(e[5],s.orientation.m06,s.orientation.m07,s.orientation.m08);for(let t=0;t<3;++t)_i.cross(e[6+3*t+0],e[t],e[0]),_i.cross(e[6+3*t+1],e[t],e[1]),_i.cross(e[6+3*t+1],e[t],e[2]);vr(n.center,n.halfExtents,e[0],e[1],e[2],t),vr(s.center,s.halfExtents,e[3],e[4],e[5],i);for(let n=0;n<15;++n){const s=yr(t,e[n]),r=yr(i,e[n]);if(r[0]>s[1]||s[0]>r[1])return 0}return 1}}(),Ir=function(){const e=new mn,t=new _i,i=new _i,n=new _i,s=new Array(8);for(let e=0;e<8;e++)s[e]=new _i;const r=new Array(8);for(let e=0;e<8;e++)r[e]=new _i;return function(o,a){if(0===_i.squaredDistance(a.ellipseCenter0,a.ellipseCenter1))return e.radius=a.radius,e.center.set(a.ellipseCenter0),zr.sphere_obb(e,o);{t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,i.x=o.orientation.m03,i.y=o.orientation.m04,i.z=o.orientation.m05,n.x=o.orientation.m06,n.y=o.orientation.m07,n.z=o.orientation.m08,vr(o.center,o.halfExtents,t,i,n,s);const e=r,c=_i.copy(e[0],t),l=_i.copy(e[1],i),h=_i.copy(e[2],n);_i.subtract(e[3],a.center,o.center).normalize();const u=_i.subtract(e[4],a.ellipseCenter0,a.ellipseCenter1);u.normalize(),_i.cross(e[5],c,u),_i.cross(e[6],l,u),_i.cross(e[7],h,u);for(let t=0;t<8;++t){const i=yr(s,e[t]),n=_i.dot(e[t],a.ellipseCenter0),r=_i.dot(e[t],a.ellipseCenter1),o=Math.max(n,r),c=Math.min(n,r)-a.radius,l=o+a.radius;if(c>i[1]||i[0]>l)return 0}return 1}}}(),Or=function(e,t){const i=_i.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1},Pr=function(e,t){for(let i=0;i<t.planes.length;i++)if(-1===Or(e,t.planes[i]))return 0;return 1},Mr=function(){const e=new _i(0,0,0),t=[1,-1,1,-1,1,-1];return function(i,n){for(let s=0;s<6;s++){const r=n.planes[s],o=i.radius,a=i.center,c=r.n,l=r.d,h=_i.dot(c,a);if(h+o<l)return 0;if(!(h-o>l)){_i.add(e,a,_i.multiplyScalar(e,c,o));for(let i=0;i<6;i++){if(i===s||i===s+t[s])continue;const r=n.planes[i];if(_i.dot(r.n,e)<r.d)return 0}}}return 1}}(),Dr=function(e,t){const i=e.radius+t.radius;return _i.squaredDistance(e.center,t.center)<i*i},Lr=function(){const e=new _i;return function(t,i){return rn(e,t.center,i),_i.squaredDistance(t.center,e)<t.radius*t.radius}}(),Br=function(){const e=new _i;return function(t,i){return on(e,t.center,i),_i.squaredDistance(t.center,e)<t.radius*t.radius}}(),Nr=function(){const e=new _i,t=new _i;return function(i,n){const s=i.radius+n.radius,r=s*s,o=_i.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===o)return _i.squaredDistance(i.center,n.center)<r;{_i.subtract(e,i.center,n.ellipseCenter0),_i.subtract(t,n.ellipseCenter1,n.ellipseCenter0);const s=_i.dot(e,t)/o;return s<0?_i.squaredDistance(i.center,n.ellipseCenter0)<r:s>1?_i.squaredDistance(i.center,n.ellipseCenter1)<r:(_i.scaleAndAdd(e,n.ellipseCenter0,t,s),_i.squaredDistance(i.center,e)<r)}}}(),Fr=function(){const e=new _i,t=new _i,i=new _i,n=new _i,s=new _i,r=new _i;return function(o,a){const c=_i.subtract(e,o.ellipseCenter1,o.ellipseCenter0),l=_i.subtract(t,a.ellipseCenter1,a.ellipseCenter0),h=_i.subtract(i,o.ellipseCenter0,a.ellipseCenter0),u=_i.dot(c,c),_=_i.dot(c,l),d=_i.dot(l,l),m=_i.dot(c,h),p=_i.dot(l,h),f=u*d-_*_;let g,v,y,x,S=f,T=f;f<Vt?(v=0,S=1,x=p,T=d):(v=_*p-d*m,x=u*p-_*m,v<0?(v=0,x=p,T=d):v>S&&(v=S,x=p+_,T=d)),x<0?(x=0,-m<0?v=0:-m>u?v=S:(v=-m,S=u)):x>T&&(x=T,-m+_<0?v=0:-m+_>u?v=S:(v=-m+_,S=u)),g=Math.abs(v)<Vt?0:v/S,y=Math.abs(x)<Vt?0:x/T;const E=n;E.set(h),E.add(_i.multiplyScalar(s,c,g)),E.subtract(_i.multiplyScalar(r,l,y));const A=o.radius+a.radius;return E.lengthSqr()<A*A}}(),zr={ray_sphere:nr,ray_aabb:sr,ray_obb:or,ray_plane:tr,ray_triangle:ir,ray_capsule:ar,ray_subMesh:cr,ray_mesh:lr,ray_model:hr,line_sphere:fr,line_aabb:mr,line_obb:pr,line_plane:ur,line_triangle:_r,sphere_sphere:Dr,sphere_aabb:Lr,sphere_obb:Br,sphere_plane:Or,sphere_frustum:Pr,sphere_frustum_accurate:Mr,sphere_capsule:Nr,aabb_aabb:gr,aabb_obb:xr,aabb_plane:Sr,aabb_frustum:Tr,aabb_frustum_accurate:Er,obb_obb:wr,obb_plane:Cr,obb_frustum:br,obb_frustum_accurate:Rr,obb_point:Ar,obb_capsule:Ir,capsule_capsule:Fr,resolve(e,t,i=null){const n=e._type,s=t._type,r=this[n|s];return n<s?r(e,t,i):r(t,e,i)}};zr[V.SHAPE_RAY|V.SHAPE_SPHERE]=nr,zr[V.SHAPE_RAY|V.SHAPE_AABB]=sr,zr[V.SHAPE_RAY|V.SHAPE_OBB]=or,zr[V.SHAPE_RAY|V.SHAPE_PLANE]=tr,zr[V.SHAPE_RAY|V.SHAPE_TRIANGLE]=ir,zr[V.SHAPE_RAY|V.SHAPE_CAPSULE]=ar,zr[V.SHAPE_LINE|V.SHAPE_SPHERE]=fr,zr[V.SHAPE_LINE|V.SHAPE_AABB]=mr,zr[V.SHAPE_LINE|V.SHAPE_OBB]=pr,zr[V.SHAPE_LINE|V.SHAPE_PLANE]=ur,zr[V.SHAPE_LINE|V.SHAPE_TRIANGLE]=_r,zr[V.SHAPE_SPHERE]=Dr,zr[V.SHAPE_SPHERE|V.SHAPE_AABB]=Lr,zr[V.SHAPE_SPHERE|V.SHAPE_OBB]=Br,zr[V.SHAPE_SPHERE|V.SHAPE_PLANE]=Or,zr[V.SHAPE_SPHERE|V.SHAPE_FRUSTUM]=Pr,zr[V.SHAPE_SPHERE|V.SHAPE_FRUSTUM_ACCURATE]=Mr,zr[V.SHAPE_SPHERE|V.SHAPE_CAPSULE]=Nr,zr[V.SHAPE_AABB]=gr,zr[V.SHAPE_AABB|V.SHAPE_OBB]=xr,zr[V.SHAPE_AABB|V.SHAPE_PLANE]=Sr,zr[V.SHAPE_AABB|V.SHAPE_FRUSTUM]=Tr,zr[V.SHAPE_AABB|V.SHAPE_FRUSTUM_ACCURATE]=Er,zr[V.SHAPE_OBB]=wr,zr[V.SHAPE_OBB|V.SHAPE_PLANE]=Cr,zr[V.SHAPE_OBB|V.SHAPE_FRUSTUM]=br,zr[V.SHAPE_OBB|V.SHAPE_FRUSTUM_ACCURATE]=Rr,zr[V.SHAPE_OBB|V.SHAPE_CAPSULE]=Ir,zr[V.SHAPE_CAPSULE]=Fr;class Ur{static create(e,t,i,n,s,r){return new Ur(e,t,i,n,s,r)}static clone(e){return new Ur(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)}static copy(e,t){return _i.copy(e.s,t.s),_i.copy(e.e,t.e),e}static fromPoints(e,t,i){return _i.copy(e.s,t),_i.copy(e.e,i),e}static set(e,t,i,n,s,r,o){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=s,e.e.y=r,e.e.z=o,e}static len(e){return _i.distance(e.s,e.e)}get type(){return this._type}constructor(e=0,t=0,i=0,n=0,s=0,r=-1){this.s=void 0,this.e=void 0,this._type=void 0,this._type=V.SHAPE_LINE,this.s=new _i(e,t,i),this.e=new _i(n,s,r)}length(){return _i.distance(this.s,this.e)}}const Gr=new _i(0,0,0),Hr=new _i(0,0,0),Vr=i.mat4(),kr=i.v4();class Wr{static create(e,t,i,n){return new Wr(e,t,i,n)}static clone(e){return new Wr(e.n.x,e.n.y,e.n.z,e.d)}static copy(e,t){return _i.copy(e.n,t.n),e.d=t.d,e}static fromPoints(e,t,i,n){return _i.subtract(Gr,i,t),_i.subtract(Hr,n,t),_i.normalize(e.n,_i.cross(e.n,Gr,Hr)),e.d=_i.dot(e.n,t),e}static set(e,t,i,n,s){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=s,e}static fromNormalAndPoint(e,t,i){return _i.copy(e.n,t),e.d=_i.dot(t,i),e}static normalize(e,t){const i=t.n.length();return _i.normalize(e.n,t.n),i>0&&(e.d=t.d/i),e}get type(){return this._type}constructor(e=0,t=1,i=0,n=0){this.n=void 0,this.d=void 0,this._type=void 0,this._type=V.SHAPE_PLANE,this.n=new _i(e,t,i),this.d=n}transform(e){wi.invert(Vr,e),wi.transpose(Vr,Vr),fi.set(kr,this.n.x,this.n.y,this.n.z,this.d),fi.transformMat4(kr,kr,Vr),_i.set(this.n,kr.x,kr.y,kr.z),this.d=kr.w}}const jr=new _i,qr=new _i,Xr=new _i,Yr=new _i,Kr=new vi,Zr=(e,t,i)=>{Kr.m00=Math.abs(i.m00),Kr.m01=Math.abs(i.m01),Kr.m02=Math.abs(i.m02),Kr.m03=Math.abs(i.m04),Kr.m04=Math.abs(i.m05),Kr.m05=Math.abs(i.m06),Kr.m06=Math.abs(i.m08),Kr.m07=Math.abs(i.m09),Kr.m08=Math.abs(i.m10),_i.transformMat3(e,t,Kr)};class $r{static create(e,t,i,n,s,r){return new $r(e,t,i,n,s,r)}static clone(e){return new $r(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)}static copy(e,t){return _i.copy(e.center,t.center),_i.copy(e.halfExtents,t.halfExtents),e}static fromPoints(e,t,i){return _i.add(jr,i,t),_i.subtract(qr,i,t),_i.multiplyScalar(e.center,jr,.5),_i.multiplyScalar(e.halfExtents,qr,.5),e}static set(e,t,i,n,s,r,o){return _i.set(e.center,t,i,n),_i.set(e.halfExtents,s,r,o),e}static merge(e,t,i){return _i.subtract(jr,t.center,t.halfExtents),_i.subtract(qr,i.center,i.halfExtents),_i.add(Xr,t.center,t.halfExtents),_i.add(Yr,i.center,i.halfExtents),_i.max(Yr,Xr,Yr),_i.min(Xr,jr,qr),$r.fromPoints(e,Xr,Yr)}static transform(e,t,i){return _i.transformMat4(e.center,t.center,i),Zr(e.halfExtents,t.halfExtents,i),e}get type(){return this._type}constructor(e=0,t=0,i=0,n=1,s=1,r=1){this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=V.SHAPE_AABB,this.center=new _i(e,t,i),this.halfExtents=new _i(n,s,r)}getBoundary(e,t){_i.subtract(e,this.center,this.halfExtents),_i.add(t,this.center,this.halfExtents)}transform(e,t,i,n,s){_i.transformMat4(s.center,this.center,e),Zr(s.halfExtents,this.halfExtents,e)}clone(){return $r.clone(this)}copy(e){return $r.copy(this,e)}}const Qr=new _i,Jr=new _i,eo=new vi;class to{static create(e,t,i,n,s,r,o,a,c,l,h,u,_,d,m){return new to(e,t,i,n,s,r,o,a,c,l,h,u,_,d,m)}static clone(e){return new to(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)}static copy(e,t){return _i.copy(e.center,t.center),_i.copy(e.halfExtents,t.halfExtents),vi.copy(e.orientation,t.orientation),e}static fromPoints(e,t,i){return _i.multiplyScalar(e.center,_i.add(Qr,t,i),.5),_i.multiplyScalar(e.halfExtents,_i.subtract(Jr,i,t),.5),vi.identity(e.orientation),e}static set(e,t,i,n,s,r,o,a,c,l,h,u,_,d,m,p){return _i.set(e.center,t,i,n),_i.set(e.halfExtents,s,r,o),vi.set(e.orientation,a,c,l,h,u,_,d,m,p),e}get type(){return this._type}constructor(e=0,t=0,i=0,n=1,s=1,r=1,o=1,a=0,c=0,l=0,h=1,u=0,_=0,d=0,m=1){this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=V.SHAPE_OBB,this.center=new _i(e,t,i),this.halfExtents=new _i(n,s,r),this.orientation=new vi(o,a,c,l,h,u,_,d,m)}getBoundary(e,t){var i,n,s;i=Qr,n=this.halfExtents,s=this.orientation,eo.m00=Math.abs(s.m00),eo.m01=Math.abs(s.m01),eo.m02=Math.abs(s.m02),eo.m03=Math.abs(s.m03),eo.m04=Math.abs(s.m04),eo.m05=Math.abs(s.m05),eo.m06=Math.abs(s.m06),eo.m07=Math.abs(s.m07),eo.m08=Math.abs(s.m08),_i.transformMat3(i,n,eo),_i.subtract(e,this.center,Qr),_i.add(t,this.center,Qr)}transform(e,t,i,n,s){_i.transformMat4(s.center,this.center,e),vi.fromQuat(s.orientation,i),_i.multiply(s.halfExtents,this.halfExtents,n)}translateAndRotate(e,t,i){_i.transformMat4(i.center,this.center,e),vi.fromQuat(i.orientation,t)}setScale(e,t){_i.multiply(t.halfExtents,this.halfExtents,e)}}const io=new Array(8);io[0]=new _i(1,1,1),io[1]=new _i(-1,1,1),io[2]=new _i(-1,-1,1),io[3]=new _i(1,-1,1),io[4]=new _i(1,1,-1),io[5]=new _i(-1,1,-1),io[6]=new _i(-1,-1,-1),io[7]=new _i(1,-1,-1);class no{set accurate(e){this._type=e?V.SHAPE_FRUSTUM_ACCURATE:V.SHAPE_FRUSTUM}static create(){return new no}static clone(e){return no.copy(new no,e)}static copy(e,t){e._type=t._type;for(let i=0;i<6;++i)Wr.copy(e.planes[i],t.planes[i]);for(let i=0;i<8;++i)_i.copy(e.vertices[i],t.vertices[i]);return e}get type(){return this._type}constructor(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=V.SHAPE_FRUSTUM,this.planes=new Array(6);for(let e=0;e<6;++e)this.planes[e]=Wr.create(0,0,0,0);this.vertices=new Array(8);for(let e=0;e<8;++e)this.vertices[e]=new _i}update(e,t){if(_i.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),_i.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),_i.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),_i.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),_i.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),_i.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===V.SHAPE_FRUSTUM_ACCURATE){for(let e=0;e<6;e++){const t=this.planes[e],i=1/t.n.length();_i.multiplyScalar(t.n,t.n,i),t.d*=i}for(let e=0;e<8;e++)_i.transformMat4(this.vertices[e],io[e],t)}}transform(e){if(this._type===V.SHAPE_FRUSTUM_ACCURATE){for(let t=0;t<8;t++)_i.transformMat4(this.vertices[t],this.vertices[t],e);Wr.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),Wr.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),Wr.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),Wr.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),Wr.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),Wr.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}let so,ro;no.createOrtho=(()=>{const e=new _i;return(t,i,n,s,r,o)=>{const a=i/2,c=n/2;_i.set(e,a,c,s),_i.transformMat4(t.vertices[0],e,o),_i.set(e,-a,c,s),_i.transformMat4(t.vertices[1],e,o),_i.set(e,-a,-c,s),_i.transformMat4(t.vertices[2],e,o),_i.set(e,a,-c,s),_i.transformMat4(t.vertices[3],e,o),_i.set(e,a,c,r),_i.transformMat4(t.vertices[4],e,o),_i.set(e,-a,c,r),_i.transformMat4(t.vertices[5],e,o),_i.set(e,-a,-c,r),_i.transformMat4(t.vertices[6],e,o),_i.set(e,a,-c,r),_i.transformMat4(t.vertices[7],e,o),Wr.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),Wr.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),Wr.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),Wr.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),Wr.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),Wr.fromPoints(t.planes[0],t.vertices[7],t.vertices[5],t.vertices[6])}})(),function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(so||(so={})),function(e){e[e.Default=so.Default]="Default",e[e.Normal=so.Normal]="Normal",e[e.Reverse=so.Reverse]="Reverse",e[e.Loop=so.Loop]="Loop",e[e.LoopReverse=so.Loop|so.Reverse]="LoopReverse",e[e.PingPong=so.PingPong]="PingPong",e[e.PingPongReverse=so.PingPong|so.Reverse]="PingPongReverse"}(ro||(ro={})),$e(ro);class oo{constructor(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}set(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}const ao=Ye({Default:so.Default,Normal:so.Normal,Clamp:so.Clamp,Loop:so.Loop,PingPong:so.PingPong});class co{constructor(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}}Nt.fastDefine("cc.Keyframe",co,{time:0,value:0,inTangent:0,outTangent:0});class lo{constructor(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}evaluate(e){return function(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}(e-this.time,this.coefficient)}}class ho{constructor(e=null){this.keyFrames=void 0,this.preWrapMode=ao.Loop,this.postWrapMode=ao.Clamp,this.cachedKey=void 0,this.keyFrames=e||[].concat(ho.defaultKF),this.cachedKey=new lo}addKey(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}evaluate_slow(e){let t=e;const i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,s=this.keyFrames[this.keyFrames.length-1].time;switch(i){case ao.Loop:t=ni(e-n,s-n)+n;break;case ao.PingPong:t=si(e-n,s-n)+n;break;case ao.Clamp:t=jt(e,n,s)}let r=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)r=this.keyFrames.length-2;else for(let e=0;e<this.keyFrames.length-1;e++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[e+1].time){r=e;break}const o=this.keyFrames[r],a=this.keyFrames[r+1],c=ri(o.time,a.time,t),l=a.time-o.time,h=o.outTangent*l,u=a.inTangent*l,_=c*c,d=_*c,m=d-2*_+c,p=d-_,f=-2*d+3*_;return(2*d-3*_+1)*o.value+m*h+p*u+f*a.value}evaluate(e){let t=e;const i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,s=this.keyFrames[this.keyFrames.length-1].time;switch(i){case ao.Loop:t=ni(e-n,s-n)+n;break;case ao.PingPong:t=si(e-n,s-n)+n;break;case ao.Clamp:t=jt(e,n,s)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);{const e=this.findIndex(this.cachedKey,t);let i=e+1;return i===this.keyFrames.length&&(i-=1),this.calcOptimizedKey(this.cachedKey,e,i),this.cachedKey.evaluate(t)}}calcOptimizedKey(e,t,i){const n=this.keyFrames[t],s=this.keyFrames[i];e.index=t,e.time=n.time,e.endTime=s.time;const r=s.time-n.time,o=s.value-n.value,a=1/(r*r),c=n.outTangent*r,l=s.inTangent*r;e.coefficient[0]=(c+l-o-o)*a/r,e.coefficient[1]=(o+o+o-c-c-l)*a,e.coefficient[2]=n.outTangent,e.coefficient[3]=n.value}findIndex(e,t){const i=e.index;if(-1!==i){if(t>this.keyFrames[i].time)for(let e=0;e<3;e++){const n=i+e;if(n+1<this.keyFrames.length&&this.keyFrames[n+1].time>t)return n}else for(let e=0;e<3;e++){const n=i-e;if(n>=0&&this.keyFrames[n-1].time<=t)return n-1}}let n=0,s=this.keyFrames.length,r=Math.floor((n+s)/2);for(;s-n>1;)this.keyFrames[r].time>=t?s=r:n=r+1,r=Math.floor((n+s)/2);return n}}ho.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Nt.fastDefine("cc.AnimationCurve",ho,{preWrapMode:ao.Default,postWrapMode:ao.Default,keyFrames:[]}),Ui(Ur.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),Gi(zr,"intersect",[{name:"line_quad"}]);var uo=Object.freeze({__proto__:null,distance:an,enums:V,intersect:zr,line:Ur,plane:Wr,ray:cn,triangle:pn,sphere:mn,aabb:$r,obb:to,capsule:class{get type(){return this._type}constructor(e=.5,t=.5,i=1){this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=V.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=i,this.center=new _i,this.rotation=new Si,this.ellipseCenter0=new _i(0,t,0),this.ellipseCenter1=new _i(0,-t,0),this.updateCache()}transform(e,t,i,n,s){const r=n,o=oi(r);s.radius=this.radius*Math.abs(o);let a=(this.halfHeight+this.radius)*Math.abs(r.y)-s.radius;a<0&&(a=0),s.halfHeight=a,_i.transformMat4(s.center,this.center,e),Si.multiply(s.rotation,this.rotation,i),s.updateCache()}updateCache(){this.updateLocalCenter(),_i.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),_i.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}updateLocalCenter(){const e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}}},frustum:no,Keyframe:co,AnimationCurve:ho,get ERaycastMode(){return er}});e("geometry",uo);class _o{constructor(e,t){this._ctor=void 0,this._elementsPerBatch=void 0,this._nextAvail=void 0,this._freepool=[],this._ctor=e,this._elementsPerBatch=Math.max(t,1),this._nextAvail=this._elementsPerBatch-1;for(let t=0;t<this._elementsPerBatch;++t)this._freepool.push(e())}alloc(){if(this._nextAvail<0){const e=this._elementsPerBatch;for(let t=0;t<e;t++)this._freepool.push(this._ctor());this._nextAvail=e-1}const e=this._freepool[this._nextAvail--];return this._freepool.length--,e}free(e){this._freepool.push(e),this._nextAvail++}freeArray(e){Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length}destroy(e){if(e)for(let t=0;t<=this._nextAvail;t++)e(this._freepool[t]);this._freepool.length=0,this._nextAvail=-1}}e("Pool",_o);class mo{constructor(e,t){this._fn=void 0,this._count=0,this._data=void 0,this._fn=e,this._data=new Array(t);for(let i=0;i<t;++i)this._data[i]=e()}get length(){return this._count}get data(){return this._data}reset(){this._count=0}resize(e){if(e>this._data.length)for(let t=this._data.length;t<e;++t)this._data[t]=this._fn()}add(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}removeAt(e){if(e>=this._count)return;const t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}e("RecyclePool",mo);class po{constructor(e,t){this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(e),this.length=0,this._compareFn=void 0!==t?t:(e,t)=>e-t}push(e){this.array[this.length++]=e}pop(){return this.array[--this.length]}get(e){return this.array[e]}clear(){this.length=0}destroy(){this.length=0,this.array.length=0}sort(){this.array.length=this.length,this.array.sort(this._compareFn)}concat(e){for(let t=0;t<e.length;++t)this.array[this.length++]=e[t]}fastRemove(e){if(e>=this.length||e<0)return;const t=--this.length;this.array[e]=this.array[t]}indexOf(e){return this.array.indexOf(e)}}e("CachedArray",po),e("memop",Object.freeze({__proto__:null,Pool:_o,RecyclePool:mo,CachedArray:po}));const fo=e("BASELINE_RATIO",.26),go=/([a-zA-Z0-9--]+|\S)/,vo=/^[!,.:;'}\]%\?>]/,yo=/([a-zA-Z0-9--]+|\S)$/,xo=/[a-zA-Z0-9--]+$/,So=/^[a-zA-Z0-9--]/;function To(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function Eo(e){const t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function Ao(e,t){const i=e.measureText(t);return i&&i.width||0}function Co(e,t,i){let n=t,s=i;const r=e[t];if(r>="\udc00"&&r<="\udfff"&&n--,void 0!==i)if(i-1!==t){const t=e[i-1];t>="\ud800"&&t<="\udbff"&&s--}else r>="\ud800"&&r<="\udbff"&&s++;return e.substring(n,s)}function bo(e,t,i,n){const s=[];if(0===e.length||i<0)return s.push(""),s;let r=e;for(;t>i&&r.length>1;){let e=r.length*(i/t)|0,o=Co(r,e),a=t-n(o),c=o,l=0,h=0;const u=10;for(;a>i&&h++<u;)e*=i/a,e|=0,o=Co(r,e),a=t-n(o);for(h=0;a<=i&&h++<u;){if(o){const e=go.exec(o);l=e?e[0].length:1,c=o}e+=l,o=Co(r,e),a=t-n(o)}e-=l,0===e?(e=1,c=Co(r,1)):1===e&&r[0]>="\ud800"&&r[0]<="\udbff"&&(e=2,c=Co(r,2));let _,d=Co(r,0,e);vo.test(c||o)&&(_=yo.exec(d),e-=_?_[0].length:0,0===e&&(e=1),c=Co(r,e),d=Co(r,0,e)),So.test(c)&&(_=xo.exec(d),_&&d!==_[0]&&(e-=_[0].length,c=Co(r,e),d=Co(r,0,e))),0===s.length?s.push(d):(d=d.trim(),d.length>0&&s.push(d)),r=c||o,t=n(r)}return 0===s.length?s.push(r):(r=r.trim(),r.length>0&&s.push(r)),s}const Ro=/^(click)(\s)*=|(param)(\s)*=/,wo=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;class Io{constructor(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}parse(e){this._resultObjectArray.length=0,this._stack.length=0;let t=0;const i=e.length;for(;t<i;){let n=e.indexOf(">",t),s=-1;if(n>=0)s=e.lastIndexOf("<",n),s<t-1&&(s=e.indexOf("<",n+1),n=e.indexOf(">",s+1));if(s<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{let i=e.substring(t,s),r=e.substring(s+1,n);""===r&&(i=e.substring(t,n+1)),this._processResult(i),-1===n?n=s:"/"===e.charAt(s+1)?this._stack.pop():this._addToStack(r),t=n+1}}return this._resultObjectArray}_attributeToObject(e){const t={};let i=(e=e.trim()).match(/^(color|size)(\s)*=/),n="",s=0,r="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(s=e.indexOf(" "),n[0]){case"c":t.color=s>-1?e.substring(0,s).trim():e;break;case"s":t.size=parseInt(e)}return s>-1&&(r=e.substring(s+1).trim(),t.event=this._processEventHandler(r)),t}if(i=e.match(/^(br(\s)*\/)/),i&&i[0].length>0&&(n=i[0].trim(),n.startsWith("br")&&"/"===n[n.length-1]))return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/);let o="";if(i&&i[0].length>0&&(n=i[0].trim(),n.startsWith("img")&&"/"===n[n.length-1])){let r;i=e.match(wo);let a=!1;for(;i;){if(n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),o=e.substring(n.length).trim(),s=o.indexOf(" "),r=s>-1?o.substr(0,s):o,n=n.replace(/[^a-zA-Z]/g,"").trim(),n=n.toLocaleLowerCase(),e=o.substring(s).trim(),r.endsWith("/")&&(r=r.slice(0,-1)),"src"===n){switch(r.charCodeAt(0)){case 34:case 39:a=!0,r=r.slice(1,-1)}t.isImage=!0,t.src=r}else if("height"===n)t.imageHeight=parseInt(r);else if("width"===n)t.imageWidth=parseInt(r);else if("align"===n){switch(r.charCodeAt(0)){case 34:case 39:r=r.slice(1,-1)}t.imageAlign=r.toLocaleLowerCase()}else"offset"===n?t.imageOffset=r:"click"===n&&(t.event=this._processEventHandler(n+"="+r));t.event&&"param"===n&&(t.event[n]=r.replace(/^\"|\"$/g,"")),i=e.match(wo)}return a&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/),i){const r={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){const a=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;let c;for(i=e.match(a);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),o=e.substring(n.length).trim(),s=o.indexOf(" "),c=s>-1?o.substr(0,s):o,n=n.replace(/[^a-zA-Z]/g,"").trim(),n=n.toLocaleLowerCase(),e=o.substring(s).trim(),"click"===n?t.event=this._processEventHandler(n+"="+c):"color"===n?r.color=c:"width"===n&&(r.width=parseInt(c)),t.event&&"param"===n&&(t.event[n]=c.replace(/^\"|\"$/g,"")),i=e.match(a)}t.outline=r}if(i=e.match(/^(on|u|b|i)(\s)*/),i&&i[0].length>0){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}_processEventHandler(e){const t=new Map;let i=0,n=!1,s=e.match(Ro);for(;s;){let r=s[0],o="";if(n=!1,'"'===(e=e.substring(r.length).trim()).charAt(0))i=e.indexOf('"',1),i>-1&&(o=e.substring(1,i).trim(),n=!0),i++;else if("'"===e.charAt(0))i=e.indexOf("'",1),i>-1&&(o=e.substring(1,i).trim(),n=!0),i++;else{const t=e.match(/(\S)+/);o=t?t[0]:"",i=o.length}n&&(r=r.substring(0,r.length-1).trim(),t[r]=o),s=(e=e.substring(i).trim()).match(Ro)}return t}_addToStack(e){const t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;const e=this._stack[this._stack.length-1];for(const i in e)t[i]||(t[i]=e[i]);this._stack.push(t)}}_processResult(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}_escapeSpecialSymbol(e){for(const t of this._specialSymbolArray){const i=t[0],n=t[1];e=e.replace(i,n)}return e}}function Oo(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function Po(e,t,i,n,s){var r={};return Object.keys(n).forEach((function(e){r[e]=n[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),r),s&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(s):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null),r}e("HtmlTextParser",Io);const Mo=()=>{},Do=()=>Mo,Lo=Bo(()=>{});function Bo(e){return function(t){return"function"==typeof t?e(t):function(i){return e(i,t)}}}function No(e,t,i){const n=zo(e);if(n){const e=Uo(n,"proto");Uo(e,"editor")[t]=i}}function Fo(e){return t=>i=>{No(i,e,t)}}function zo(e,t){return Uo(e,"__ccclassCache__")}function Uo(e,t){return e[t]||(e[t]={})}const Go=Bo((e,t)=>{let i=Be.getSuper(e);i===Object&&(i=null);const n={name:t,extends:i,ctor:e,__ES6__:!0},s=e.__ccclassCache__;if(s){const t=s.proto;t&&Be.mixin(n,t),e.__ccclassCache__=void 0}return Nt(n)}),Ho=Fo("requireComponent"),Vo=Fo("executionOrder"),ko=(Wo="disallowMultiple",Bo((e,t)=>{No(e,Wo,void 0!==jo?jo:t)}));var Wo,jo;function qo(e,t,i){let n=null;function s(e,t,i){const s=zo(e.constructor);if(s){const r=Uo(s,"proto"),o=Uo(r,"properties");!function(e,t,i,n,s,r){let o;n&&(o=ft(n),o=o||n);const a=t[i],c=Be.mixin(a||{},o||{});if(s&&(s.get||s.set))s.get&&(c.get=s.get),s.set&&(c.set=s.set);else{let t;if(s)s.initializer&&(t=function(e){let t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(s.initializer));else{const n=r.default||(r.default=function(e){let t;try{t=new e}catch(e){return{}}return t}(e));n.hasOwnProperty(i)&&(t=n[i])}c.default=t}t[i]=c}(e.constructor,o,t,n,i,s)}}return void 0===e?qo({type:void 0}):void 0===t?(n=e,s):void s(e,t,i)}const Xo=(e,t,i)=>qo(Ko({}))(e,t,i);const Yo=(e,t,i)=>qo({editorOnly:!0})(e,t,i);function Ko(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}const Zo=Lo,$o=Do,Qo=Lo,Jo=Do,ea=Do,ta=Do,ia=Mo,na=Do,sa=Do,ra=Do,oa=Do,aa=Do,ca=Do,la=Do,ha=Mo,ua=Do,_a=Do,da=Mo,ma=va(ot),pa=va(at),fa=va(ct),ga=va(lt);function va(e){return qo({type:e})}const ya=(e,t,i)=>qo({__noImplicit:!0,override:!0})(e,t,i);var xa,Sa,Ta,Ea,Aa,Ca,ba;let Ra=e("PrefabInfo",Go("cc.PrefabInfo")((Ta=Po((Sa=class{constructor(){Oo(this,"root",Ta,this),Oo(this,"asset",Ea,this),Oo(this,"fileId",Aa,this),Oo(this,"sync",Ca,this),Oo(this,"_synced",ba,this)}}).prototype,"root",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ea=Po(Sa.prototype,"asset",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Aa=Po(Sa.prototype,"fileId",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ca=Po(Sa.prototype,"sync",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ba=Po(Sa.prototype,"_synced",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),xa=Sa))||xa);i._PrefabInfo=Ra;const wa="undefined"==typeof window?global:window;var Ia;!function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(Ia||(Ia={}));const Oa=e("sys",{NetworkType:Ia,LANGUAGE_ENGLISH:"en",LANGUAGE_CHINESE:"zh",LANGUAGE_FRENCH:"fr",LANGUAGE_ITALIAN:"it",LANGUAGE_GERMAN:"de",LANGUAGE_SPANISH:"es",LANGUAGE_DUTCH:"du",LANGUAGE_RUSSIAN:"ru",LANGUAGE_KOREAN:"ko",LANGUAGE_JAPANESE:"ja",LANGUAGE_HUNGARIAN:"hu",LANGUAGE_PORTUGUESE:"pt",LANGUAGE_ARABIC:"ar",LANGUAGE_NORWEGIAN:"no",LANGUAGE_POLISH:"pl",LANGUAGE_TURKISH:"tr",LANGUAGE_UKRAINIAN:"uk",LANGUAGE_ROMANIAN:"ro",LANGUAGE_BULGARIAN:"bg",LANGUAGE_UNKNOWN:"unknown",OS_IOS:"iOS",OS_ANDROID:"Android",OS_WINDOWS:"Windows",OS_LINUX:"Linux",OS_OSX:"OS X",OS_UNKNOWN:"Unknown",UNKNOWN:-1,WIN32:0,LINUX:1,MACOS:2,ANDROID:3,IPHONE:4,IPAD:5,BLACKBERRY:6,NACL:7,EMSCRIPTEN:8,TIZEN:9,WINRT:10,WP8:11,MOBILE_BROWSER:100,DESKTOP_BROWSER:101,EDITOR_PAGE:102,EDITOR_CORE:103,WECHAT_GAME:104,QQ_PLAY:105,BROWSER_TYPE_WECHAT:"wechat",BROWSER_TYPE_COCOSPLAY:"cocosplay",BROWSER_TYPE_HUAWEI_GAME:"huaweiquickgame",BROWSER_TYPE_OPPO_GAME:"oppogame",BROWSER_TYPE_VIVO_GAME:"vivogame",BROWSER_TYPE_ANDROID:"androidbrowser",BROWSER_TYPE_IE:"ie",BROWSER_TYPE_EDGE:"edge",BROWSER_TYPE_QQ:"qqbrowser",BROWSER_TYPE_MOBILE_QQ:"mqqbrowser",BROWSER_TYPE_UC:"ucbrowser",BROWSER_TYPE_UCBS:"ucbs",BROWSER_TYPE_360:"360browser",BROWSER_TYPE_BAIDU_APP:"baiduboxapp",BROWSER_TYPE_BAIDU:"baidubrowser",BROWSER_TYPE_MAXTHON:"maxthon",BROWSER_TYPE_OPERA:"opera",BROWSER_TYPE_OUPENG:"oupeng",BROWSER_TYPE_MIUI:"miuibrowser",BROWSER_TYPE_FIREFOX:"firefox",BROWSER_TYPE_SAFARI:"safari",BROWSER_TYPE_CHROME:"chrome",BROWSER_TYPE_LIEBAO:"liebao",BROWSER_TYPE_QZONE:"qzone",BROWSER_TYPE_SOUGOU:"sogou",BROWSER_TYPE_UNKNOWN:"unknown",isNative:!0,isBrowser:"object"==typeof window&&"object"==typeof document&&!1,isMobile:!1,isLittleEndian:(()=>{const e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]})(),platform:-1,language:"unknown",os:"Unknown",osVersion:"",osMainVersion:0,browserType:"unknown",browserVersion:"",windowPixelResolution:null,capabilities:null,localStorage:null,__audioSupport:null,getNetworkType:()=>Ia.LAN,getBatteryLevel:()=>1,garbageCollect(){},isObjectValid:e=>null!=e,dump(){let e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",e+="Using "+(i.game.renderType===i.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n",l(e)},openURL(e){jsb.openURL(e)},now:()=>Date.now?Date.now():+new Date,dumpRoot(){},restartVM(){},cleanScript(e){},getSafeAreaRect(){let e=i.view.getVisibleSize();return i.rect(0,0,e.width,e.height)}});if(wa.__globalAdapter&&wa.__globalAdapter.adaptSys)wa.__globalAdapter.adaptSys(Oa);else{const e=Oa.platform=__getPlatform();Oa.isMobile=e===Oa.ANDROID||e===Oa.IPAD||e===Oa.IPHONE||e===Oa.WP8||e===Oa.TIZEN||e===Oa.BLACKBERRY,Oa.os=__getOS(),Oa.language=__getCurrentLanguage(),Oa.osVersion=__getOSVersion(),Oa.osMainVersion=parseInt(Oa.osVersion),Oa.browserType=Oa.BROWSER_TYPE_UNKNOWN,Oa.browserVersion="";const t=window.innerWidth,i=window.innerHeight,n=window.devicePixelRatio||1;let s;Oa.windowPixelResolution={width:n*t,height:n*i},Oa.localStorage=window.localStorage,s=Oa.capabilities={canvas:!1,opengl:!0,webp:!0},Oa.isMobile?(s.accelerometer=!0,s.touches=!0):(s.keyboard=!0,s.mouse=!0,s.touches=!1),Oa.__audioSupport={ONLY_ONE:!1,WEB_AUDIO:!1,DELAY_CREATE_CTX:!1,format:[".mp3"]}}i.sys=Oa;const Pa={[es.UNORM]:"Uint",[es.SNORM]:"Int",[es.UINT]:"Uint",[es.INT]:"Int",[es.UFLOAT]:"Float",[es.FLOAT]:"Float",default:"Uint"};function Ma(e){return(Pa[e.type]||Pa.default)+e.size/e.count*8}function Da(e,t,i=En.R32F,n=0,s=0){const r=_s[i];s||(s=r.size);const o="set"+Ma(r),a=r.size/r.count,c=Math.floor(t.length/r.count),l=Oa.isLittleEndian;for(let i=0;i<c;++i){const c=n+s*i;for(let n=0;n<r.count;++n){const s=c+a*n;e[o](s,t[r.count*i+n],l)}}}function La(e,t=En.R32F,i=0,n=e.byteLength-i,s=0,r=[]){const o=_s[t];s||(s=o.size);const a="get"+Ma(o),c=o.size/o.count,l=Math.floor(n/s),h=Oa.isLittleEndian;for(let t=0;t<l;++t){const n=i+s*t;for(let i=0;i<o.count;++i){const s=n+c*i;r[o.count*t+i]=e[a](s,h)}}return r}function Ba(e,t,i=En.R32F,n=0,s=e.byteLength-n,r=0,o){o||(o=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));const a=_s[i];r||(r=a.size);const c="set"+Ma(a),l="get"+Ma(a),h=a.size/a.count,u=Math.floor(s/r),_=Oa.isLittleEndian;for(let i=0;i<u;++i){const s=n+r*i;for(let i=0;i<a.count;++i){const n=s+h*i,r=e[l](n,_);o[c](n,t(r,i,e),_)}}return o}class Na{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(e){if(0!==e){const t=this._length%e;if(0!==t){const i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}addBuffer(e){const t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}getLength(){return this._length}getCombined(){const e=new Uint8Array(this._length);let t=0;return this._arrayBufferOrPaddings.forEach(i=>{"number"==typeof i?t+=i:(e.set(new Uint8Array(i),t),t+=i.byteLength)}),e.buffer}}class Fa{constructor(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}unuse(){this.type=Fa.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=Fa.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}reuse(e,t){this.type=e,this.bubbles=t||!1}isStopped(){return this.propagationStopped||this.propagationImmediateStopped}getCurrentTarget(){return this.currentTarget}getType(){return this.type}}e("Event",Fa),Fa.NO_TYPE="no_type",Fa.TOUCH="touch",Fa.MOUSE="mouse",Fa.KEYBOARD="keyboard",Fa.ACCELERATION="acceleration",Fa.NONE=0,Fa.CAPTURING_PHASE=1,Fa.AT_TARGET=2,Fa.BUBBLING_PHASE=3,i.Event=Fa;const za=[];class Ua{static _deferredDestroy(){const e=za.length;for(let t=0;t<e;++t){const e=za[t];1&e._objFlags||e._destroyImmediate()}e===za.length?za.length=0:za.splice(0,e)}constructor(e=""){this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}get name(){return this._name}set name(e){this._name=e}get isValid(){return!(1&this._objFlags)}destroy(){return 1&this._objFlags?(y(5e3),!1):!(4&this._objFlags)&&(this._objFlags|=4,za.push(this),!0)}_destruct(){const e=this.constructor;let t=e.__destruct__;t||(t=function(e,t){const n=e instanceof i._BaseNode||e instanceof i.Component,s=n?"_id":null;let r;const o={};for(r in e)if(e.hasOwnProperty(r)){if(r===s)continue;switch(typeof e[r]){case"string":o[r]="";break;case"object":case"function":o[r]=null}}if(Nt._isCCClass(t)){const e=i.Class.Attr.getClassAttrs(t),s=t.__props__;for(let t=0;t<s.length;t++){r=s[t];const a=r+i.Class.Attr.DELIMETER+"default";if(a in e){if(n&&"_id"===r)continue;switch(typeof e[a]){case"string":o[r]="";break;case"object":case"function":o[r]=null;break;case"undefined":o[r]=void 0}}}}{let e="";for(r in o){let t;t=Nt.IDENTIFIER_RE.test(r)?"o."+r+"=":"o["+Nt.escapeForJS(r)+"]=";let i=o[r];""===i&&(i='""'),e+=t+i+";\n"}return Function("o",e)}}(this,e),se(e,"__destruct__",t,!0)),t(this)}_destroyImmediate(){1&this._objFlags?S(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}}e("CCObject",Ua);const Ga=Ua.prototype;function Ha(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}Ga._deserialize=null,Ga._onPreDestroy=null,Nt.fastDefine("cc.Object",Ua,{_name:"",_objFlags:0}),se(Ua,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),i.isValid=Ha,i.Object=Ua;const Va=Le.fastRemoveAt;function ka(){}class Wa{constructor(){this.callback=ka,this.target=void 0,this.once=!1}set(e,t,i){this.callback=e||ka,this.target=t,this.once=!!i}reset(){this.target=void 0,this.callback=ka,this.once=!1}check(){return!(this.target instanceof Ua&&!Ha(this.target,!0))}}const ja=new _o(()=>new Wa,32);class qa{constructor(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}removeByCallback(e){for(let t=0;t<this.callbackInfos.length;++t){const i=this.callbackInfos[t];i&&i.callback===e&&(i.reset(),ja.free(i),Va(this.callbackInfos,t),--t)}}removeByTarget(e){for(let t=0;t<this.callbackInfos.length;++t){const i=this.callbackInfos[t];i&&i.target===e&&(i.reset(),ja.free(i),Va(this.callbackInfos,t),--t)}}cancel(e){const t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Va(this.callbackInfos,e),ja.free(t)),this.containCanceled=!0}cancelAll(){for(let e=0;e<this.callbackInfos.length;e++){const t=this.callbackInfos[e];t&&(t.reset(),ja.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}purgeCanceled(){for(let e=this.callbackInfos.length-1;e>=0;--e){this.callbackInfos[e]||Va(this.callbackInfos,e)}this.containCanceled=!1}clear(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}const Xa=new _o(()=>new qa,16);class Ya{constructor(){this._callbackTable=ce(!0)}on(e,t,i,n){if(!this.hasEventListener(e,t,i)){let s=this._callbackTable[e];s||(s=this._callbackTable[e]=Xa.alloc());const r=ja.alloc();r.set(t,i,n),s.callbackInfos.push(r)}return t}hasEventListener(e,t,i){const n=this._callbackTable[e];if(!n)return!1;const s=n.callbackInfos;if(!t){if(n.isInvoking){for(let e=0;e<s.length;++e)if(s[e])return!0;return!1}return s.length>0}for(let e=0;e<s.length;++e){let n=s[e];if(n&&n.check()&&n.callback===t&&n.target===i)return!0}return!1}removeAll(e){if("string"==typeof e){const t=this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),Xa.free(t),delete this._callbackTable[e]))}else if(e)for(const t in this._callbackTable){const i=this._callbackTable[t];if(i.isInvoking){const t=i.callbackInfos;for(let n=0;n<t.length;++n){const s=t[n];s&&s.target===e&&i.cancel(n)}}else i.removeByTarget(e)}}off(e,t,i){const n=this._callbackTable[e];if(n){const s=n.callbackInfos;if(t)for(let e=0;e<s.length;++e){const r=s[e];if(r&&r.callback===t&&r.target===i){n.cancel(e);break}}else this.removeAll(e)}}emit(e,t,i,n,s,r){const o=this._callbackTable[e];if(o){const a=!o.isInvoking;o.isInvoking=!0;const c=o.callbackInfos;for(let o=0,a=c.length;o<a;++o){const a=c[o];if(a){const o=a.callback,c=a.target;a.once&&this.off(e,o,c),a.check()?c?o.call(c,t,i,n,s,r):o(t,i,n,s,r):this.off(e,o,c)}}a&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}}clear(){for(let e in this._callbackTable){let t=this._callbackTable[e];t&&(t.clear(),Xa.free(t),delete this._callbackTable[e])}}}function Ka(e){class t extends e{constructor(...e){super(...e),this._callbackTable=ce(!0)}once(e,t,i){return this.on(e,t,i,!0)}targetOff(e){this.removeAll(e)}}const i=Ya.prototype,n=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i));for(let e=0;e<n.length;++e){const s=n[e];if(!(s in t.prototype)){const e=Object.getOwnPropertyDescriptor(i,s);e&&Object.defineProperty(t.prototype,s,e)}}return t}const Za=e("EventTarget",Ka(class{}));var $a;i.EventTarget=Za;let Qa=e("RawAsset",Go("cc.RawAsset")($a=class extends Ua{static isRawAssetType(e){return Te(e,i.RawAsset)&&!Te(e,i.Asset)}constructor(...e){super(...e),this._uuid=void 0,Object.defineProperty(this,"_uuid",{value:"",writable:!0})}})||$a);var Ja,ec,tc,ic,nc;i.RawAsset=Qa;let sc=e("Asset",Go("cc.Asset")((nc=ic=class extends(Ka(Qa)){constructor(...e){super(...e),this.loaded=!0,Oo(this,"_native",tc,this),this._file=null}static deserialize(e){return i.deserialize(e)}get nativeUrl(){if(this._native){const e=this._native;if(47===e.charCodeAt(0))return e.slice(1);if(i.AssetLibrary){const t=i.AssetLibrary.getLibUrlNoExt(this._uuid,!0);return 46===e.charCodeAt(0)?t+e:t+"/"+e}S(6400)}return""}get _nativeAsset(){return this._file}set _nativeAsset(e){this._file=e}toString(){return this.nativeUrl}serialize(){}_setRawAsset(e,t=!0){this._native=!1!==t?e||"":"/"+e}},ic.preventDeferredLoadDependents=!1,ic.preventPreloadNativeObject=!1,tc=Po((ec=nc).prototype,"_native",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Po(ec.prototype,"_nativeAsset",[qo],Object.getOwnPropertyDescriptor(ec.prototype,"_nativeAsset"),ec.prototype),Ja=ec))||Ja);sc.prototype.createNode=null,i.Asset=sc;let rc,oc,ac,cc=1024;var lc,hc,uc,_c;!function(e){e[e.RGB565=En.R5G6B5]="RGB565",e[e.RGB5A1=En.RGB5A1]="RGB5A1",e[e.RGBA4444=En.RGBA4]="RGBA4444",e[e.RGB888=En.RGB8]="RGB888",e[e.RGB32F=En.RGB32F]="RGB32F",e[e.RGBA8888=En.RGBA8]="RGBA8888",e[e.RGBA32F=En.RGBA32F]="RGBA32F",e[e.A8=En.A8]="A8",e[e.I8=En.L8]="I8",e[e.AI8=En.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=En.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=En.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=cc++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=En.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=En.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=cc++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=En.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=cc++]="RGBA_ETC1",e[e.RGB_ETC2=En.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=En.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=En.ASTC_RGBA_4x4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=En.ASTC_RGBA_5x4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=En.ASTC_RGBA_5x5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=En.ASTC_RGBA_6x5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=En.ASTC_RGBA_6x6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=En.ASTC_RGBA_8x5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=En.ASTC_RGBA_8x6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=En.ASTC_RGBA_8x8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=En.ASTC_RGBA_10x5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=En.ASTC_RGBA_10x6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=En.ASTC_RGBA_10x8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=En.ASTC_RGBA_10x10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=En.ASTC_RGBA_12x10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=En.ASTC_RGBA_12x12]="RGBA_ASTC_12x12"}(rc||(rc={})),function(e){e[e.REPEAT=zn.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=zn.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=zn.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=zn.BORDER]="CLAMP_TO_BORDER"}(oc||(oc={})),function(e){e[e.NONE=Fn.NONE]="NONE",e[e.LINEAR=Fn.LINEAR]="LINEAR",e[e.NEAREST=Fn.POINT]="NEAREST"}(ac||(ac={}));let dc,mc=e("ImageAsset",Go("cc.ImageAsset")((_c=uc=class e extends sc{get _nativeAsset(){return this._nativeData}set _nativeAsset(e){e instanceof HTMLElement||(e.format=e.format||this._format),this.reset(e)}get data(){return!0!==(e=this._nativeData)._compressed&&(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)?this._nativeData:this._nativeData._data;var e}get width(){return this._nativeData.width||this._width}get height(){return this._nativeData.height||this._height}get format(){return this._format}get isCompressed(){return this._format>=rc.RGB_ETC1&&this._format<=rc.RGBA_ASTC_12x12||this._format>=rc.RGB_A_PVRTC_2BPPV1&&this._format<=rc.RGBA_ETC1}get url(){return this._url}set _texture(e){this._tex=e}get _texture(){if(!this._tex){const e=new i.Texture2D;e.name=this._url,e.image=this,this._tex=e}return this._tex}constructor(e){super(),this._nativeData=void 0,this._tex=void 0,this._url=void 0,this._exportedExts=void 0,this._format=rc.RGBA8888,this._width=0,this._height=0,this._url="",this.loaded=!1,this._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&this.reset(e)}reset(e){e instanceof HTMLElement?(this._nativeData=e,e.complete||e instanceof HTMLCanvasElement?this._onDataComplete():(this.loaded=!1,e.addEventListener("load",()=>{this._onDataComplete()}),e.addEventListener("error",e=>{y(3119,e.message)}))):(this._nativeData=e,this._format=e.format,this._onDataComplete())}destroy(){return this.data&&this.data instanceof HTMLImageElement&&(this.data.src="",this._setRawAsset(""),i.loader.removeItem(this.data.id)),super.destroy()}_serialize(){let t=this._exportedExts;if(!t&&this._native&&(t=[this._native]),!t)return"";const i=[];for(const n of t){const t=n.split("@"),s=e.extnames.indexOf(t[0]);let r=s<0?n:""+s;t[1]&&(r+="@"+t[1]),i.push(r)}return{fmt:i.join("_"),w:this.width,h:this.height}}_deserialize(t,n){let s="";"string"==typeof t?s=t:(this._width=t.w,this._height=t.h,s=t.fmt);const r=i.director.root?i.director.root.device:null,o=s.split("_");let a=Number.MAX_VALUE,c=this._format,l="";const h=i.macro.SUPPORT_TEXTURE_FORMATS;for(const t of o){const n=t.split("@"),s=parseInt(n[0],void 0),o=e.extnames[s]||n.join(),u=h.indexOf(o);if(-1!==u&&u<a){const e=n[1]?parseInt(n[1]):this._format;if(!(".astc"!==o||r&&r.hasFeature(As.FORMAT_ASTC)))continue;if(!(".pvr"!==o||r&&r.hasFeature(As.FORMAT_PVRTC)))continue;if(!(e!==rc.RGB_ETC1&&e!==rc.RGBA_ETC1||r&&r.hasFeature(As.FORMAT_ETC1)))continue;if(!(e!==rc.RGB_ETC2&&e!==rc.RGBA_ETC2||r&&r.hasFeature(As.FORMAT_ETC2)))continue;if(".webp"===o&&!i.sys.capabilities.webp)continue;a=u,l=o,c=e}}l&&(this._setRawAsset(l),this._format=c);const u=n.customEnv,_=u&&u.uuid;_&&(this._uuid=_,this._url=this.nativeUrl)}_onDataComplete(){this.loaded=!0,this.emit("load")}},uc.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Po((hc=_c).prototype,"_nativeAsset",[ya],Object.getOwnPropertyDescriptor(hc.prototype,"_nativeAsset"),hc.prototype),lc=hc))||lc);i.ImageAsset=mc,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.minLOD=8]="minLOD",e[e.maxLOD=9]="maxLOD",e[e.mipLODBias=10]="mipLODBias",e[e.total=11]="total"}(dc||(dc={}));const pc=[Fn.LINEAR,Fn.LINEAR,Fn.NONE,zn.WRAP,zn.WRAP,zn.WRAP,8,Mn.NEVER,0,0,0],fc=yc(pc),gc={r:0,g:0,b:0,a:0},vc={};function yc(e){let t=0,i=0;for(let n=0;n<pc.length;n++)switch(t=e[n]||pc[n],n){case dc.minFilter:i|=t;break;case dc.magFilter:i|=t<<2;break;case dc.mipFilter:i|=t<<4;break;case dc.addressU:i|=t<<6;break;case dc.addressV:i|=t<<8;break;case dc.addressW:i|=t<<10;break;case dc.maxAnisotropy:i|=t<<12;break;case dc.cmpFunc:i|=t<<16;break;case dc.minLOD:i|=t<<20;break;case dc.maxLOD:i|=t<<24;break;case dc.mipLODBias:i|=t<<28}return i}const xc=new class{constructor(){this._cache={}}getSampler(e,t){t||(t=fc);const i=this._cache[t];if(i)return i;vc.minFilter=3&t,vc.magFilter=t>>2&3,vc.mipFilter=t>>4&3,vc.addressU=t>>6&3,vc.addressV=t>>8&3,vc.addressW=t>>10&3,vc.maxAnisotropy=t>>12&15,vc.cmpFunc=t>>16&15,vc.minLOD=t>>20&15,vc.maxLOD=t>>24&15,vc.mipLODBias=t>>28&15,vc.borderColor=gc;return this._cache[t]=e.createSampler(vc)}};var Sc,Tc,Ec,Ac,Cc,bc,Rc,wc,Ic,Oc,Pc,Mc;i.samplerLib=xc;const Dc=new J("Tex");let Lc=Go("cc.TextureBase")((Mc=Pc=class extends sc{get isCompressed(){return this._format>=rc.RGB_ETC1&&this._format<=rc.RGBA_PVRTC_4BPPV1}get width(){return this._width}get height(){return this._height}constructor(){super(),Oo(this,"_format",Ec,this),Oo(this,"_minFilter",Ac,this),Oo(this,"_magFilter",Cc,this),Oo(this,"_mipFilter",bc,this),Oo(this,"_wrapS",Rc,this),Oo(this,"_wrapT",wc,this),Oo(this,"_wrapR",Ic,this),Oo(this,"_anisotropy",Oc,this),this._width=1,this._height=1,this._id=void 0,this._samplerInfo=[],this._samplerHash=0,this._gfxSampler=null,this._gfxDevice=null,this._id=Dc.getNewId(),this.loaded=!1,this._gfxDevice=this._getGFXDevice()}getId(){return this._id}getPixelFormat(){return this._format}getAnisotropy(){return this._anisotropy}setWrapMode(e,t,i){this._wrapS=e,this._samplerInfo[dc.addressU]=e,this._wrapT=t,this._samplerInfo[dc.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[dc.addressW]=i),this._samplerHash=yc(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=xc.getSampler(this._gfxDevice,this._samplerHash))}setFilters(e,t){this._minFilter=e,this._samplerInfo[dc.minFilter]=e,this._magFilter=t,this._samplerInfo[dc.magFilter]=t,this._samplerHash=yc(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=xc.getSampler(this._gfxDevice,this._samplerHash))}setMipFilter(e){this._mipFilter=e,this._samplerInfo[dc.mipFilter]=e,this._samplerInfo[dc.maxLOD]=e===ac.NONE?0:15,this._samplerHash=yc(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=xc.getSampler(this._gfxDevice,this._samplerHash))}setAnisotropy(e){this._anisotropy=e,this._samplerInfo[dc.maxAnisotropy]=e,this._samplerHash=yc(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=xc.getSampler(this._gfxDevice,this._samplerHash))}destroy(){return super.destroy()}getGFXTexture(){return null}getSamplerHash(){return this._samplerHash}getGFXSampler(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=xc.getSampler(this._gfxDevice,this._samplerHash):S(9302)),this._gfxSampler}_serialize(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+this._mipFilter+","+this._anisotropy}_deserialize(e,t){const i=e.split(",");i.unshift(""),i.length>=5&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4]))),i.length>=7&&(this.setMipFilter(parseInt(i[5])),this.setAnisotropy(parseInt(i[6])))}_getGFXDevice(){return i.director.root&&i.director.root.device}_getGFXFormat(){return this._getGFXPixelFormat(this._format)}_setGFXFormat(e){this._format=void 0===e?rc.RGBA8888:e}_getGFXPixelFormat(e){return e===rc.RGBA_ETC1?e=rc.RGB_ETC1:e===rc.RGB_A_PVRTC_4BPPV1?e=rc.RGB_PVRTC_4BPPV1:e===rc.RGB_A_PVRTC_2BPPV1&&(e=rc.RGB_PVRTC_2BPPV1),e}},Pc.PixelFormat=rc,Pc.WrapMode=oc,Pc.Filter=ac,Ec=Po((Tc=Mc).prototype,"_format",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rc.RGBA8888}}),Ac=Po(Tc.prototype,"_minFilter",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ac.LINEAR}}),Cc=Po(Tc.prototype,"_magFilter",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ac.LINEAR}}),bc=Po(Tc.prototype,"_mipFilter",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ac.NONE}}),Rc=Po(Tc.prototype,"_wrapS",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oc.REPEAT}}),wc=Po(Tc.prototype,"_wrapT",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oc.REPEAT}}),Ic=Po(Tc.prototype,"_wrapR",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oc.REPEAT}}),Oc=Po(Tc.prototype,"_anisotropy",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),Sc=Tc))||Sc;i.TextureBase=Lc;const Bc=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0});var Nc;i.macro=Bc;const Fc=[{buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{mipLevel:0,baseArrayLayer:0,layerCount:1}}];function zc(e){return e&&0==(e&e-1)}let Uc=Go("cc.SimpleTexture")(Nc=class extends Lc{constructor(...e){super(...e),this._gfxTexture=null,this._mipmapLevel=1}get mipmapLevel(){return this._mipmapLevel}getGFXTexture(){return this._gfxTexture}destroy(){return this._tryDestroyTexture(),super.destroy()}updateImage(){this.updateMipmaps(0)}updateMipmaps(e=0,t){}uploadData(e,t=0,i=0){if(!this._gfxTexture||this._gfxTexture.levelCount<=t)return;const n=this._getGFXDevice();if(!n)return;const s=Fc[0];s.texExtent.width=this._gfxTexture.width>>t,s.texExtent.height=this._gfxTexture.height>>t,s.texSubres.mipLevel=t,s.texSubres.baseArrayLayer=i,ArrayBuffer.isView(e)?n.copyBuffersToTexture([e],this._gfxTexture,Fc):n.copyTexImagesToTexture([e],this._gfxTexture,Fc)}_assignImage(e,t,n){const s=()=>{const s=e.data;s&&(this.uploadData(s,t,n),this._checkTextureLoaded(),Bc.CLEANUP_IMAGE_CACHE&&i.loader.release(e))};if(e.loaded)s();else{if(e.once("load",()=>{s()}),!this.isCompressed){const e=i.builtinResMgr.get("black-texture").image;this.uploadData(e.data,t,n)}i.textureUtil.postLoadImage(e)}}_checkTextureLoaded(){this._textureReady()}_textureReady(){this.loaded=!0,this.emit("load")}_setMipmapLevel(e){this._mipmapLevel=e<1?1:e}_getGfxTextureCreateInfo(e){return null}_tryReset(){if(this._tryDestroyTexture(),0===this._mipmapLevel)return;const e=this._getGFXDevice();e&&this._createTexture(e)}_createTexture(e){let t=Vn.NONE;this._mipFilter!==ac.NONE&&function(e,t,i){return!(e.gfxAPI===Es.WEBGL)||zc(t)&&zc(i)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){let i=Math.max(e,t),n=0;for(;i;)i>>=1,n++;return n}(this._width,this._height),t=Vn.GEN_MIPMAP);const i=this._getGfxTextureCreateInfo({usage:Gn.SAMPLED|Gn.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(!i)return;const n=e.createTexture(i);this._gfxTexture=n}_tryDestroyTexture(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}})||Nc;var Gc,Hc,Vc,kc,Wc;i.SimpleTexture=Uc;let jc=e("Texture2D",(Gc=Go("cc.Texture2D"),Hc=va([mc]),Gc((Wc=Po((kc=class extends Uc{constructor(...e){super(...e),Oo(this,"_mipmaps",Wc,this)}get mipmaps(){return this._mipmaps}set mipmaps(e){if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const e=this._mipmaps[0];this.reset({width:e.width,height:e.height,format:e.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((e,t)=>{this._assignImage(e,t)})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(e){this.mipmaps=e?[e]:[]}initialize(){this.mipmaps=this._mipmaps}onLoaded(){this.initialize()}reset(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}create(e,t,i=rc.RGBA8888,n=1){this.reset({width:e,height:t,format:i,mipmapLevel:n})}toString(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}updateMipmaps(e=0,t){if(e>=this._mipmaps.length)return;const i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e);for(let t=0;t<i;++t){const i=e+t;this._assignImage(this._mipmaps[i],i)}}getHtmlElementObj(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}destroy(){return this._mipmaps=[],super.destroy()}description(){return`<cc.Texture2D | Name = ${this._mipmaps[0]?this._mipmaps[0].url:""} | Dimension = ${this.width} x ${this.height}>`}releaseTexture(){this.destroy()}_serialize(e){return{base:super._serialize(e),mipmaps:this._mipmaps.map(t=>t&&t._uuid?e?EditorExtends.UuidUtils.compressUuid(t._uuid,!0):t._uuid:null)}}_deserialize(e,t){const i=e;super._deserialize(i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(let e=0;e<i.mipmaps.length;++e){if(this._mipmaps[e]=new mc,!i.mipmaps[e])continue;const n=i.mipmaps[e];t.result.push(this._mipmaps,""+e,n),this._mipmaps[e]._texture=this}}_getGfxTextureCreateInfo(e){return Object.assign({type:Un.TEX2D,width:this._width,height:this._height},e)}_checkTextureLoaded(){let e=!0;for(let t=0;t<this._mipmaps.length;++t){if(!this._mipmaps[t].loaded){e=!1;break}}e&&super._textureReady()}}).prototype,"_mipmaps",[Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vc=kc))||Vc));i.Texture2D=jc;const qc={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295};class Xc{static makeMaskInclude(e){let t=0;for(const i of e)t|=i;return t}static makeMaskExclude(e){return~Xc.makeMaskInclude(e)}static addLayer(e,t){void 0!==t?t>19||t<0?console.warn("maximum layers reached."):(Xc.Enum[e]=1<<t,Xc.Enum[t]=e,Xc.BitMask[e]=1<<t,Xc.BitMask[t]=e):console.warn("bitNum can't be undefined")}static deleteLayer(e){e>19||e<0?console.warn("do not change buildin layers."):(delete Xc.Enum[Xc.Enum[e]],delete Xc.Enum[e],delete Xc.BitMask[Xc.BitMask[e]],delete Xc.BitMask[e])}}e("Layers",Xc),Xc.Enum=Ye(qc),Xc.BitMask=Xe(Object.assign({},qc)),i.Layers=Xc;let Yc,Kc;!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(Yc||(Yc={})),i.RenderPassStage=Yc,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Kc||(Kc={}));const Zc={bindings:[],record:{}},$c={bindings:[],record:{}};let Qc;!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_SHADOW=1]="UBO_SHADOW",e[e.SAMPLER_ENVIRONMENT=2]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.COUNT=4]="COUNT"}(Qc||(Qc={}));const Jc=Qc.SAMPLER_ENVIRONMENT,el=Qc.COUNT-Jc;let tl;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTING_MAP=9]="SAMPLER_LIGHTING_MAP",e[e.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",e[e.COUNT=11]="COUNT"}(tl||(tl={}));const il=tl.SAMPLER_JOINTS,nl=tl.COUNT-il,sl=e=>e!==rl.MATERIAL;let rl;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(rl||(rl={}));const ol=new Cs;ol.bufferOffsets=[0,Jc+il,Jc],ol.samplerOffsets=[0,el+nl,el];class al{}al.TIME_OFFSET=0,al.SCREEN_SIZE_OFFSET=al.TIME_OFFSET+4,al.SCREEN_SCALE_OFFSET=al.SCREEN_SIZE_OFFSET+4,al.NATIVE_SIZE_OFFSET=al.SCREEN_SCALE_OFFSET+4,al.MAT_VIEW_OFFSET=al.NATIVE_SIZE_OFFSET+4,al.MAT_VIEW_INV_OFFSET=al.MAT_VIEW_OFFSET+16,al.MAT_PROJ_OFFSET=al.MAT_VIEW_INV_OFFSET+16,al.MAT_PROJ_INV_OFFSET=al.MAT_PROJ_OFFSET+16,al.MAT_VIEW_PROJ_OFFSET=al.MAT_PROJ_INV_OFFSET+16,al.MAT_VIEW_PROJ_INV_OFFSET=al.MAT_VIEW_PROJ_OFFSET+16,al.CAMERA_POS_OFFSET=al.MAT_VIEW_PROJ_INV_OFFSET+16,al.EXPOSURE_OFFSET=al.CAMERA_POS_OFFSET+4,al.MAIN_LIT_DIR_OFFSET=al.EXPOSURE_OFFSET+4,al.MAIN_LIT_COLOR_OFFSET=al.MAIN_LIT_DIR_OFFSET+4,al.AMBIENT_SKY_OFFSET=al.MAIN_LIT_COLOR_OFFSET+4,al.AMBIENT_GROUND_OFFSET=al.AMBIENT_SKY_OFFSET+4,al.GLOBAL_FOG_COLOR_OFFSET=al.AMBIENT_GROUND_OFFSET+4,al.GLOBAL_FOG_BASE_OFFSET=al.GLOBAL_FOG_COLOR_OFFSET+4,al.GLOBAL_FOG_ADD_OFFSET=al.GLOBAL_FOG_BASE_OFFSET+4,al.COUNT=al.GLOBAL_FOG_ADD_OFFSET+4,al.SIZE=4*al.COUNT,al.BLOCK={stageFlags:kn.ALL,descriptorType:Wn.UNIFORM_BUFFER,count:1,set:rl.GLOBAL,binding:Qc.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:Tn.FLOAT4,count:1},{name:"cc_screenSize",type:Tn.FLOAT4,count:1},{name:"cc_screenScale",type:Tn.FLOAT4,count:1},{name:"cc_nativeSize",type:Tn.FLOAT4,count:1},{name:"cc_matView",type:Tn.MAT4,count:1},{name:"cc_matViewInv",type:Tn.MAT4,count:1},{name:"cc_matProj",type:Tn.MAT4,count:1},{name:"cc_matProjInv",type:Tn.MAT4,count:1},{name:"cc_matViewProj",type:Tn.MAT4,count:1},{name:"cc_matViewProjInv",type:Tn.MAT4,count:1},{name:"cc_cameraPos",type:Tn.FLOAT4,count:1},{name:"cc_exposure",type:Tn.FLOAT4,count:1},{name:"cc_mainLitDir",type:Tn.FLOAT4,count:1},{name:"cc_mainLitColor",type:Tn.FLOAT4,count:1},{name:"cc_ambientSky",type:Tn.FLOAT4,count:1},{name:"cc_ambientGround",type:Tn.FLOAT4,count:1},{name:"cc_fogColor",type:Tn.FLOAT4,count:1},{name:"cc_fogBase",type:Tn.FLOAT4,count:1},{name:"cc_fogAdd",type:Tn.FLOAT4,count:1}]},Zc.record[al.BLOCK.name]=al.BLOCK,Zc.bindings[al.BLOCK.binding]=al.BLOCK;class cl{}cl.MAT_LIGHT_PLANE_PROJ_OFFSET=0,cl.MAT_LIGHT_VIEW_PROJ_OFFSET=cl.MAT_LIGHT_PLANE_PROJ_OFFSET+16,cl.SHADOW_COLOR_OFFSET=cl.MAT_LIGHT_VIEW_PROJ_OFFSET+16,cl.SHADOW_PCF_OFFSET=cl.SHADOW_COLOR_OFFSET+4,cl.SHADOW_SIZE_OFFSET=cl.SHADOW_PCF_OFFSET+4,cl.COUNT=cl.SHADOW_SIZE_OFFSET+4,cl.SIZE=4*cl.COUNT,cl.BLOCK={stageFlags:kn.ALL,descriptorType:Wn.UNIFORM_BUFFER,count:1,set:rl.GLOBAL,binding:Qc.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:Tn.MAT4,count:1},{name:"cc_matLightViewProj",type:Tn.MAT4,count:1},{name:"cc_shadowColor",type:Tn.FLOAT4,count:1},{name:"cc_shadowPCF",type:Tn.FLOAT4,count:1},{name:"cc_shadowSize",type:Tn.FLOAT4,count:1}]},Zc.record[cl.BLOCK.name]=cl.BLOCK,Zc.bindings[cl.BLOCK.binding]=cl.BLOCK;const ll={stageFlags:kn.FRAGMENT,descriptorType:Wn.SAMPLER,count:1,set:rl.GLOBAL,binding:Qc.SAMPLER_SHADOWMAP,name:"cc_shadowMap",type:Tn.SAMPLER2D};Zc.record[ll.name]=ll,Zc.bindings[ll.binding]=ll;const hl={stageFlags:kn.FRAGMENT,descriptorType:Wn.SAMPLER,count:1,set:rl.GLOBAL,binding:Qc.SAMPLER_ENVIRONMENT,name:"cc_environment",type:Tn.SAMPLER_CUBE};Zc.record[hl.name]=hl,Zc.bindings[hl.binding]=hl;class ul{}ul.MAT_WORLD_OFFSET=0,ul.MAT_WORLD_IT_OFFSET=ul.MAT_WORLD_OFFSET+16,ul.LIGHTINGMAP_UVPARAM=ul.MAT_WORLD_IT_OFFSET+16,ul.COUNT=ul.LIGHTINGMAP_UVPARAM+4,ul.SIZE=4*ul.COUNT,ul.BLOCK={stageFlags:kn.VERTEX,descriptorType:Wn.UNIFORM_BUFFER,count:1,set:rl.LOCAL,binding:tl.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:Tn.MAT4,count:1},{name:"cc_matWorldIT",type:Tn.MAT4,count:1},{name:"cc_lightingMapUVParam",type:Tn.FLOAT4,count:1}]},$c.record[ul.BLOCK.name]=ul.BLOCK,$c.bindings[ul.BLOCK.binding]=ul.BLOCK;class _l{}_l.BATCHING_COUNT=10,_l.MAT_WORLDS_OFFSET=0,_l.COUNT=16*_l.BATCHING_COUNT,_l.SIZE=4*_l.COUNT,_l.BLOCK={stageFlags:kn.VERTEX,descriptorType:Wn.UNIFORM_BUFFER,count:1,set:rl.LOCAL,binding:tl.UBO_LOCAL,name:"CCLocalBatched",members:[{name:"cc_matWorlds",type:Tn.MAT4,count:_l.BATCHING_COUNT}]},$c.record[_l.BLOCK.name]=_l.BLOCK,$c.bindings[_l.BLOCK.binding]=_l.BLOCK;class dl{}dl.LIGHTS_PER_PASS=1,dl.LIGHT_POS_OFFSET=0,dl.LIGHT_COLOR_OFFSET=dl.LIGHT_POS_OFFSET+4*dl.LIGHTS_PER_PASS,dl.LIGHT_SIZE_RANGE_ANGLE_OFFSET=dl.LIGHT_COLOR_OFFSET+4*dl.LIGHTS_PER_PASS,dl.LIGHT_DIR_OFFSET=dl.LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*dl.LIGHTS_PER_PASS,dl.COUNT=dl.LIGHT_DIR_OFFSET+4*dl.LIGHTS_PER_PASS,dl.SIZE=4*dl.COUNT,dl.BLOCK={stageFlags:kn.FRAGMENT,descriptorType:Wn.DYNAMIC_UNIFORM_BUFFER,count:1,set:rl.LOCAL,binding:tl.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_lightPos",type:Tn.FLOAT4,count:dl.LIGHTS_PER_PASS},{name:"cc_lightColor",type:Tn.FLOAT4,count:dl.LIGHTS_PER_PASS},{name:"cc_lightSizeRangeAngle",type:Tn.FLOAT4,count:dl.LIGHTS_PER_PASS},{name:"cc_lightDir",type:Tn.FLOAT4,count:dl.LIGHTS_PER_PASS}]},$c.record[dl.BLOCK.name]=dl.BLOCK,$c.bindings[dl.BLOCK.binding]=dl.BLOCK;class ml{}ml.JOINTS_TEXTURE_INFO_OFFSET=0,ml.COUNT=ml.JOINTS_TEXTURE_INFO_OFFSET+4,ml.SIZE=4*ml.COUNT,ml.BLOCK={stageFlags:kn.VERTEX,descriptorType:Wn.UNIFORM_BUFFER,count:1,set:rl.LOCAL,binding:tl.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointTextureInfo",type:Tn.FLOAT4,count:1}]},$c.record[ml.BLOCK.name]=ml.BLOCK,$c.bindings[ml.BLOCK.binding]=ml.BLOCK;class pl{}pl.JOINTS_ANIM_INFO_OFFSET=0,pl.COUNT=pl.JOINTS_ANIM_INFO_OFFSET+4,pl.SIZE=4*pl.COUNT,pl.BLOCK={stageFlags:kn.VERTEX,descriptorType:Wn.UNIFORM_BUFFER,count:1,set:rl.LOCAL,binding:tl.UBO_SKINNING_ANIMATION,name:"CCSkinningAnimation",members:[{name:"cc_jointAnimInfo",type:Tn.FLOAT4,count:1}]},$c.record[pl.BLOCK.name]=pl.BLOCK,$c.bindings[pl.BLOCK.binding]=pl.BLOCK;class fl{}fl.JOINTS_OFFSET=0,fl.COUNT=fl.JOINTS_OFFSET+360,fl.SIZE=4*fl.COUNT,fl.BLOCK={stageFlags:kn.VERTEX,descriptorType:Wn.UNIFORM_BUFFER,count:1,set:rl.LOCAL,binding:tl.UBO_SKINNING_TEXTURE,name:"CCSkinning",members:[{name:"cc_joints",type:Tn.FLOAT4,count:90}]},$c.record[fl.BLOCK.name]=fl.BLOCK,$c.bindings[fl.BLOCK.binding]=fl.BLOCK;class gl{}gl.MAX_MORPH_TARGET_COUNT=60,gl.OFFSET_OF_WEIGHTS=0,gl.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*gl.MAX_MORPH_TARGET_COUNT,gl.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=gl.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH+4,gl.OFFSET_OF_VERTICES_COUNT=gl.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT+4,gl.COUNT_BASE_4_BYTES=4*Math.ceil(gl.MAX_MORPH_TARGET_COUNT/4)+4,gl.SIZE=4*gl.COUNT_BASE_4_BYTES,gl.BLOCK={stageFlags:kn.VERTEX,descriptorType:Wn.UNIFORM_BUFFER,count:1,set:rl.LOCAL,binding:tl.UBO_MORPH,name:"CCMorph",members:[{name:"cc_displacementWeights",type:Tn.FLOAT4,count:gl.MAX_MORPH_TARGET_COUNT/4},{name:"cc_displacementTextureInfo",type:Tn.FLOAT4,count:1}]},$c.record[gl.BLOCK.name]=gl.BLOCK,$c.bindings[gl.BLOCK.binding]=gl.BLOCK;const vl={stageFlags:kn.VERTEX,descriptorType:Wn.SAMPLER,count:1,set:rl.LOCAL,binding:tl.SAMPLER_JOINTS,name:"cc_jointTexture",type:Tn.SAMPLER2D};$c.record[vl.name]=vl,$c.bindings[vl.binding]=vl;const yl={stageFlags:kn.VERTEX,descriptorType:Wn.SAMPLER,count:1,set:rl.LOCAL,binding:tl.SAMPLER_MORPH_POSITION,name:"cc_PositionDisplacements",type:Tn.SAMPLER2D};$c.record[yl.name]=yl,$c.bindings[yl.binding]=yl;const xl={stageFlags:kn.VERTEX,descriptorType:Wn.SAMPLER,count:1,set:rl.LOCAL,binding:tl.SAMPLER_MORPH_NORMAL,name:"cc_NormalDisplacements",type:Tn.SAMPLER2D};$c.record[xl.name]=xl,$c.bindings[xl.binding]=xl;const Sl={stageFlags:kn.VERTEX,descriptorType:Wn.SAMPLER,count:1,set:rl.LOCAL,binding:tl.SAMPLER_MORPH_TANGENT,name:"cc_TangentDisplacements",type:Tn.SAMPLER2D};$c.record[Sl.name]=Sl,$c.bindings[Sl.binding]=Sl;const Tl={stageFlags:kn.FRAGMENT,descriptorType:Wn.SAMPLER,count:1,set:rl.LOCAL,binding:tl.SAMPLER_LIGHTING_MAP,name:"cc_lightingMap",type:Tn.SAMPLER2D};$c.record[Tl.name]=Tl,$c.bindings[Tl.binding]=Tl;const El={stageFlags:kn.FRAGMENT,descriptorType:Wn.SAMPLER,count:1,set:rl.LOCAL,binding:tl.SAMPLER_SPRITE,name:"cc_spriteTexture",type:Tn.SAMPLER2D};$c.record[El.name]=El,$c.bindings[El.binding]=El;const Al=Xc.makeMaskExclude([Xc.BitMask.UI_2D,Xc.BitMask.GIZMOS,Xc.BitMask.EDITOR,Xc.BitMask.SCENE_GIZMO,Xc.BitMask.PROFILER]),Cl=Xc.makeMaskExclude([Xc.BitMask.UI_2D,Xc.BitMask.PROFILER]),bl=Xc.Enum.ALL;var Rl,wl,Il,Ol,Pl,Ml=Object.freeze({__proto__:null,PIPELINE_FLOW_FORWARD:"ForwardFlow",PIPELINE_FLOW_SHADOW:"ShadowFlow",PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Yc},get RenderPriority(){return Kc},globalDescriptorSetLayout:Zc,localDescriptorSetLayout:$c,get PipelineGlobalBindings(){return Qc},get ModelLocalBindings(){return tl},isBuiltinBinding:sl,get SetIndex(){return rl},bindingMappingInfo:ol,UBOGlobal:al,UBOShadow:cl,UNIFORM_SHADOWMAP:ll,UNIFORM_ENVIRONMENT:hl,UBOLocal:ul,INST_MAT_WORLD:"a_matWorld0",UBOLocalBatched:_l,UBOForwardLight:dl,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:ml,UBOSkinningAnimation:pl,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:fl,UBOMorph:gl,UniformJointTexture:vl,UniformPositionMorphTexture:yl,UniformNormalMorphTexture:xl,UniformTangentMorphTexture:Sl,UniformLightingMapSampler:Tl,UniformSpriteSampler:El,CAMERA_DEFAULT_MASK:Al,CAMERA_EDITOR_MASK:Cl,MODEL_ALWAYS_MASK:bl});class Dl{constructor(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,!this._mesh.struct.morph)return;const i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(let e=0;e<i;++e){const i=this._mesh.struct.morph.subMeshMorphs[e];i&&(i.targets.length>gl.MAX_MORPH_TARGET_COUNT?y(10002,gl.MAX_MORPH_TARGET_COUNT,i.targets.length):this._subMeshRenderings[e]=new Ll(this._mesh,e,this._mesh.struct.morph,t))}}createInstance(){const e=this._mesh.struct.primitives.length,t=new Array(e);for(let s=0;s<e;++s){var i,n;t[s]=null!==(i=null===(n=this._subMeshRenderings[s])||void 0===n?void 0:n.createInstance())&&void 0!==i?i:null}return{setWeights:(e,i)=>{var n;null===(n=t[e])||void 0===n||n.setWeights(i)},requiredPatches:e=>{this._mesh.struct.morph;const i=this._mesh.struct.morph.subMeshMorphs[e],n=t[e];if(null===n)return;const s=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(Sn.ATTR_POSITION)&&s.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(Sn.ATTR_NORMAL)&&s.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(Sn.ATTR_TANGENT)&&s.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),s.push(...n.requiredPatches()),s},adaptPipelineState:(e,i)=>{var n;null===(n=t[e])||void 0===n||n.adaptPipelineState(i)},destroy:()=>{for(const e of t)null==e||e.destroy()}}}}class Ll{constructor(e,t,i,n){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=n;const s=i.subMeshMorphs[t];this._subMeshMorph=s,function(e,t,i){e.renderingSubMeshes[t].enableVertexIdChannel(i)}(e,t,n);const r=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=r;const o=s.targets.length,a=function(e,t){let i,n,s,r;e.hasFeature(As.TEXTURE_FLOAT)?(i=t,s=16,n=jc.PixelFormat.RGBA32F,r=Float32Array):(i=4*t,s=4,n=jc.PixelFormat.RGBA8888,r=Uint8Array);const{width:o,height:a}=function(e){e<5&&(e=5);const t=k(j(e)),i=t>>1;return{width:1<<(1&t?i+1:i),height:1<<i}}(i);return{width:o,height:a,create:()=>{const t=new ArrayBuffer(o*a*s),i=new Float32Array(t),c=r===Float32Array?i:new r(t),l=new mc({width:o,height:a,_data:c,_compressed:!1,format:n}),u=new jc;u.setFilters(jc.Filter.NEAREST,jc.Filter.NEAREST),u.setMipFilter(jc.Filter.NONE),u.setWrapMode(jc.WrapMode.CLAMP_TO_EDGE,jc.WrapMode.CLAMP_TO_EDGE,jc.WrapMode.CLAMP_TO_EDGE),u.image=l,u.getGFXTexture()||h("Unexpected: failed to create morph texture?");const _=xc.getSampler(e,u.getSamplerHash());return{get texture(){return u.getGFXTexture()},get sampler(){return _},get valueView(){return i},destroy(){u.destroy()},updatePixels(){u.uploadData(c)}}}}}(n,r*o);this._textureInfo={width:a.width,height:a.height},this._attributes=s.attributes.map((t,i)=>{const n=a.create(),o=n.valueView;return s.targets.forEach((t,n)=>{const s=t.displacements[i],a=new Float32Array(e.data.buffer,e.data.byteOffset+s.offset,s.count),c=r*n*4;for(let e=0;e<r;++e)o[c+4*e+0]=a[3*e+0],o[c+4*e+1]=a[3*e+1],o[c+4*e+2]=a[3*e+2]}),n.updatePixels(),{name:t,morphTexture:n}})}destroy(){for(const e of this._attributes)e.morphTexture.destroy()}createInstance(){const e=new Bl(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:t=>{e.setWeights(t),e.commit()},requiredPatches:()=>[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}],adaptPipelineState:t=>{for(const e of this._attributes){let i;switch(e.name){case Sn.ATTR_POSITION:i=yl.binding;break;case Sn.ATTR_NORMAL:i=xl.binding;break;case Sn.ATTR_TANGENT:i=Sl.binding;break;default:h("Unexpected attribute!")}void 0!==i&&(t.bindSampler(i,e.morphTexture.sampler),t.bindTexture(i,e.morphTexture.texture))}t.bindBuffer(gl.BLOCK.binding,e.buffer),t.update()},destroy:()=>{}}}}class Bl{constructor(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(gl.SIZE)),this._remoteBuffer=e.createBuffer({usage:An.UNIFORM|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:gl.SIZE,stride:gl.SIZE})}destroy(){this._remoteBuffer.destroy()}get buffer(){return this._remoteBuffer}setWeights(e){e.length,this._targetCount;for(let t=0;t<e.length;++t)this._localBuffer.setFloat32(gl.OFFSET_OF_WEIGHTS+4*t,e[t],i.sys.isLittleEndian)}setMorphTextureInfo(e,t){this._localBuffer.setFloat32(gl.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,i.sys.isLittleEndian),this._localBuffer.setFloat32(gl.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,i.sys.isLittleEndian)}setVerticesCount(e){this._localBuffer.setFloat32(gl.OFFSET_OF_VERTICES_COUNT,e,i.sys.isLittleEndian)}commit(){this._remoteBuffer.update(this._localBuffer.buffer,this._localBuffer.byteOffset,this._localBuffer.byteLength)}}function Nl(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}class Fl{get geometricInfo(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:_i.ZERO,max:_i.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:_i.ZERO,max:_i.ZERO}};const e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,Sn.ATTR_POSITION),s=e.readIndices(t),r=new _i,o=new _i,a=this.attributes.find(e=>e.name===i.GFXAttributeName.ATTR_POSITION);if(a){const e=_s[a.format].count;2===e?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(let t=0;t<n.length;t+=e)2===e?(r.x=n[t]>r.x?n[t]:r.x,r.y=n[t+1]>r.y?n[t+1]:r.y,o.x=n[t]<o.x?n[t]:o.x,o.y=n[t+1]<o.y?n[t+1]:o.y):(r.x=n[t]>r.x?n[t]:r.x,r.y=n[t+1]>r.y?n[t+1]:r.y,r.z=n[t+2]>r.z?n[t+2]:r.z,o.x=n[t]<o.x?n[t]:o.x,o.y=n[t+1]<o.y?n[t+1]:o.y,o.z=n[t+2]<o.z?n[t+2]:o.z)}return this._geometricInfo={positions:n,indices:s,boundingBox:{max:r,min:o}},this._geometricInfo}get flatBuffers(){if(this._flatBuffers)return this._flatBuffers;const e=this._flatBuffers=[];if(!this.mesh||void 0===this.subMeshIdx)return e;const t=this.mesh;let i=0;const n=t.struct.primitives[this.subMeshIdx];n.indexView&&(i=n.indexView.count);for(const e of n.vertexBundelIndices){const s=t.struct.vertexBundles[e],r=n.indexView?n.indexView.count:s.view.count,o=s.view.stride,a=o*r,c=new Uint8Array(t.data.buffer,s.view.offset,s.view.length);if(!n.indexView){this._flatBuffers.push({stride:o,count:r,buffer:c});continue}const l=new Uint8Array(a),h=t.readIndices(this.subMeshIdx);for(let e=0;e<i;++e){const t=e*o,i=h[e]*o;for(let e=0;e<o;++e)l[t+e]=c[i+e]}this._flatBuffers.push({stride:o,count:r,buffer:l})}return this._flatBuffers}get jointMappedBuffers(){if(this._jointMappedBuffers)return this._jointMappedBuffers;const e=this._jointMappedBuffers=[],t=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;const n=this.mesh.struct,s=n.primitives[this.subMeshIdx];if(!n.jointMaps||void 0===s.jointMapIndex||!n.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;let r,o;const a=i.director.root.device;for(let i=0;i<s.vertexBundelIndices.length;i++){const c=n.vertexBundles[s.vertexBundelIndices[i]];o=0,r=En.UNKNOWN;for(let e=0;e<c.attributes.length;e++){const t=c.attributes[e];if(t.name===Sn.ATTR_JOINTS){r=t.format;break}o+=_s[t.format].size}if(r){const l=new Uint8Array(this.mesh.data.buffer,c.view.offset,c.view.length),h=new DataView(l.slice().buffer),u=n.jointMaps[s.jointMapIndex];Ba(h,e=>u.indexOf(e),r,o,c.view.length,c.view.stride,h);const _=a.createBuffer({usage:An.VERTEX|An.TRANSFER_DST,memUsage:Cn.DEVICE,size:c.view.length,stride:c.view.stride});_.update(h.buffer),e.push(_),t.push(i)}else e.push(this.vertexBuffers[s.vertexBundelIndices[i]])}return this._vertexIdChannel&&e.push(this._allocVertexIdBuffer(a)),e}constructor(e,t,i){this.vertexBuffers=void 0,this.attributes=void 0,this.primitiveMode=void 0,this.indexBuffer=void 0,this.indirectBuffer=void 0,this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=void 0,this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this.vertexBuffers=e,this.attributes=t,this.primitiveMode=i}destroy(){for(let e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(let e=0;e<this._jointMappedBufferIndices.length;e++)this._jointMappedBuffers[this._jointMappedBufferIndices[e]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this.indirectBuffer&&(this.indirectBuffer.destroy(),this.indirectBuffer=void 0)}enableVertexIdChannel(e){if(this._vertexIdChannel)return;const t=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(e);this.vertexBuffers.push(n),this.attributes.push({name:"a_vertexId",format:En.R32F,stream:t,isNormalized:!1}),this._vertexIdChannel={stream:t,index:i}}_allocVertexIdBuffer(e){const t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(t);for(let e=0;e<t;++e)i[e]=e+.5;const n=e.createBuffer({usage:An.VERTEX|An.TRANSFER_DST,memUsage:Cn.DEVICE,size:i.byteLength,stride:i.BYTES_PER_ELEMENT});return n.update(i),n}}e("RenderingSubMesh",Fl);const zl=new _i,Ul=new _i,Gl=new Uint8Array;let Hl=e("Mesh",Go("cc.Mesh")((Il=Po((wl=class extends sc{get _nativeAsset(){return this._data.buffer}set _nativeAsset(e){this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),i.loader._cache[this.nativeUrl]&&(i.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}get subMeshCount(){const e=this.renderingSubMeshes;return e?e.length:0}get minPosition(){return this.struct.minPosition}get maxPosition(){return this.struct.maxPosition}get struct(){return this._struct}get data(){return this._data}get hash(){return this._hash||(this._hash=Os(this._data,666)),this._hash}get jointBufferIndices(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map(e=>e.jointMapIndex||0)}get renderingSubMeshes(){return this.initialize(),this._renderingSubMeshes}constructor(){super(),Oo(this,"_struct",Il,this),Oo(this,"_dataLength",Ol,this),Oo(this,"_hash",Pl,this),this._data=Gl,this._initialized=!1,this._renderingSubMeshes=null,this._boneSpaceBounds=new Map,this._jointBufferIndices=null,this.morphRendering=null,this.loaded=!1}initialize(){if(this._initialized)return;var e,t;this._initialized=!0,this._data.byteLength!==this._dataLength&&(this._data=new Uint8Array(this._dataLength),(e=this).loaded?t&&t():e.nativeUrl?i.loader.load({url:e.nativeUrl},(i,n)=>{n&&(e.loaded||(e._nativeAsset=n)),t&&t(i)}):t&&t());const n=this._data.buffer,s=i.director.root.device,r=this._createVertexBuffers(s,n),o=[];for(let e=0;e<this._struct.primitives.length;e++){const t=this._struct.primitives[e];if(0===t.vertexBundelIndices.length)continue;let i,a=null;if(t.indexView){const e=t.indexView;let r=e.stride,o=e.length;if(4===r&&!s.hasFeature(As.ELEMENT_INDEX_UINT)){const e=this._struct.vertexBundles[t.vertexBundelIndices[0]].view.count;if(e>=65536){y(10001,e,65536);continue}r>>=1,o>>=1}i=s.createBuffer({usage:An.INDEX|An.TRANSFER_DST,memUsage:Cn.DEVICE,size:o,stride:r}),a=new(Nl(e.stride))(n,e.offset,e.count),e.stride!==r&&(a=Nl(r).from(a)),this.loaded?i.update(a):this.once("load",()=>{i.update(a)})}const c=t.vertexBundelIndices.map(e=>r[e]);let l=[];if(t.vertexBundelIndices.length>0){const e=t.vertexBundelIndices[0];l=this._struct.vertexBundles[e].attributes}const h=new Fl(c,l,t.primitiveMode);h.mesh=this,h.subMeshIdx=e,h.indexBuffer=i,o.push(h)}this._renderingSubMeshes=o,this._struct.morph&&(this.morphRendering=function(e,t){return new Dl(e,t)}(this,s))}destroy(){return this.destroyRenderingMesh(),super.destroy()}destroyRenderingMesh(){if(this._renderingSubMeshes){for(let e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}}assign(e,t){this.reset({struct:e,data:t})}reset(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._dataLength=this.data.byteLength,this._hash=0,this.loaded=!0,this.emit("load")}getBoneSpaceBounds(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);const t=[];this._boneSpaceBounds.set(e.hash,t);const i=[],n=e.bindposes;for(let e=0;e<n.length;e++)t.push(new $r(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);const s=this._struct.primitives;for(let e=0;e<s.length;e++){const s=this.readAttribute(e,Sn.ATTR_JOINTS),r=this.readAttribute(e,Sn.ATTR_WEIGHTS),o=this.readAttribute(e,Sn.ATTR_POSITION);if(!s||!r||!o)continue;const a=Math.min(s.length/4,r.length/4,o.length/3);for(let e=0;e<a;e++){_i.set(zl,o[3*e+0],o[3*e+1],o[3*e+2]);for(let o=0;o<4;++o){const a=4*e+o,c=s[a];if(0===r[a]||c>=n.length)continue;_i.transformMat4(Ul,zl,n[c]),i[c]=!0;const l=t[c];_i.min(l.center,l.center,Ul),_i.max(l.halfExtents,l.halfExtents,Ul)}}}for(let e=0;e<n.length;e++){const n=t[e];i[e]?$r.fromPoints(n,n.center,n.halfExtents):t[e]=null}return t}merge(e,t,i){if(i&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;const n=new _i,s=t&&new Si,r=t&&new $r;if(s&&t.getRotation(s),!this._initialized){const i=JSON.parse(JSON.stringify(e._struct)),o=e._data.slice();if(t){i.maxPosition&&i.minPosition&&(_i.add(r.center,i.maxPosition,i.minPosition),_i.multiplyScalar(r.center,r.center,.5),_i.subtract(r.halfExtents,i.maxPosition,i.minPosition),_i.multiplyScalar(r.halfExtents,r.halfExtents,.5),$r.transform(r,r,t),_i.add(i.maxPosition,r.center,r.halfExtents),_i.subtract(i.minPosition,r.center,r.halfExtents));for(let e=0;e<i.vertexBundles.length;e++){const r=i.vertexBundles[e];for(let e=0;e<r.attributes.length;e++)if(r.attributes[e].name===Sn.ATTR_POSITION||r.attributes[e].name===Sn.ATTR_NORMAL){const i=r.attributes[e].format,a=new DataView(o.buffer,r.view.offset+Vl(r.attributes,e)),c=jl(a,i),l=ql(a,i);if(!c||!l)continue;const h=r.view.count,u=r.view.stride,_=Wl(i);for(let i=0;i<h;i++){const o=i*u,a=o+_,h=a+_;switch(n.set(c(o),c(a),c(h)),r.attributes[e].name){case Sn.ATTR_POSITION:n.transformMat4(t);break;case Sn.ATTR_NORMAL:_i.transformQuat(n,n,s)}l(o,n.x),l(a,n.y),l(h,n.z)}}}}return this.reset({struct:i,data:o}),this.initialize(),!0}const o=new Na;let a,c,l,h,u,_=0,d=0,m=0,p=0,f=0,g=0,v=0,y=0,x=!1;const S=new Array(this._struct.vertexBundles.length);for(let i=0;i<this._struct.vertexBundles.length;++i){const r=this._struct.vertexBundles[i],T=e._struct.vertexBundles[i];m=r.view.offset,p=T.view.offset,d=r.view.stride,_=r.view.count+T.view.count,a=new ArrayBuffer(_*d),c=new Uint8Array(a),l=this._data.subarray(m,m+r.view.length),m+=l.length,h=e._data.subarray(p,p+T.view.length),p+=h.length,c.set(l),f=0;for(const e of r.attributes){v=0,x=!1;for(const t of T.attributes){if(e.name===t.name&&e.format===t.format){x=!0;break}v+=_s[t.format].size}if(x){y=_s[e.format].size,g=r.view.length+f;for(let i=0;i<T.view.count;++i){if(u=h.subarray(v,v+y),c.set(u,g),(e.name===Sn.ATTR_POSITION||e.name===Sn.ATTR_NORMAL)&&t){const i=new Float32Array(c.buffer,g,3);switch(n.set(i[0],i[1],i[2]),e.name){case Sn.ATTR_POSITION:n.transformMat4(t);break;case Sn.ATTR_NORMAL:_i.transformQuat(n,n,s)}i[0]=n.x,i[1]=n.y,i[2]=n.z}g+=r.view.stride,v+=T.view.stride}}f+=_s[e.format].size}S[i]={attributes:r.attributes,view:{offset:o.getLength(),length:a.byteLength,count:_,stride:d}},o.addBuffer(a)}let T,E,A,C=0,b=2,R=0;const w=new Array(this._struct.primitives.length);for(let t=0;t<this._struct.primitives.length;++t){const i=this._struct.primitives[t],n=e._struct.primitives[t];w[t]={primitiveMode:i.primitiveMode,vertexBundelIndices:i.vertexBundelIndices};for(const e of i.vertexBundelIndices)R=Math.max(R,this._struct.vertexBundles[e].view.count);if(i.indexView&&n.indexView){C=i.indexView.count,C+=n.indexView.count,m=i.indexView.offset,p=n.indexView.offset,b=C<256?1:C<65536?2:4;const s=new ArrayBuffer(C*b);if(T=2===b?new Uint16Array(s):1===b?new Uint8Array(s):new Uint32Array(s),E=2===i.indexView.stride?new Uint16Array(this._data.buffer,m,i.indexView.count):1===i.indexView.stride?new Uint8Array(this._data.buffer,m,i.indexView.count):new Uint32Array(this._data.buffer,m,i.indexView.count),b===i.indexView.stride)T.set(E);else for(let e=0;e<i.indexView.count;++e)T[e]=E[e];m+=i.indexView.length,A=2===n.indexView.stride?new Uint16Array(e._data.buffer,p,n.indexView.count):1===n.indexView.stride?new Uint8Array(e._data.buffer,p,n.indexView.count):new Uint32Array(e._data.buffer,p,n.indexView.count);for(let e=0;e<n.indexView.count;++e)T[i.indexView.count+e]=R+A[e];p+=n.indexView.length,w[t].indexView={offset:o.getLength(),length:s.byteLength,count:C,stride:b},o.setNextAlignment(b),o.addBuffer(s)}}const I={vertexBundles:S,primitives:w,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return I.minPosition&&e._struct.minPosition&&I.maxPosition&&e._struct.maxPosition&&(t?(_i.add(r.center,e._struct.maxPosition,e._struct.minPosition),_i.multiplyScalar(r.center,r.center,.5),_i.subtract(r.halfExtents,e._struct.maxPosition,e._struct.minPosition),_i.multiplyScalar(r.halfExtents,r.halfExtents,.5),$r.transform(r,r,t),_i.add(n,r.center,r.halfExtents),_i.max(I.maxPosition,I.maxPosition,n),_i.subtract(n,r.center,r.halfExtents),_i.min(I.minPosition,I.minPosition,n)):(_i.min(I.minPosition,I.minPosition,e._struct.minPosition),_i.max(I.maxPosition,I.maxPosition,e._struct.maxPosition))),this.reset({struct:I,data:new Uint8Array(o.getCombined())}),this.initialize(),!0}validateMergingMesh(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(let t=0;t<this._struct.vertexBundles.length;++t){const i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(let e=0;e<i.attributes.length;++e)if(i.attributes[e].format!==n.attributes[e].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(let t=0;t<this._struct.primitives.length;++t){const i=this._struct.primitives[t],n=e._struct.primitives[t];if(i.vertexBundelIndices.length!==n.vertexBundelIndices.length)return!1;for(let e=0;e<i.vertexBundelIndices.length;++e)if(i.vertexBundelIndices[e]!==n.vertexBundelIndices[e])return!1;if(i.primitiveMode!==n.primitiveMode)return!1;if(i.indexView){if(void 0===n.indexView)return!1}else if(n.indexView)return!1}return!0}readAttribute(e,t){let i=null;return this._accessAttribute(e,t,(e,t)=>{const n=e.view.count,s=e.attributes[t].format,r=gs(_s[s]);if(0===n)return new r;const o=new DataView(this._data.buffer,e.view.offset+Vl(e.attributes,t)),a=_s[s],c=jl(o,s);if(!r||!c)return;const l=a.count,h=new r(n*l),u=e.view.stride;for(let e=0;e<n;++e)for(let t=0;t<l;++t)h[l*e+t]=c(u*e+h.BYTES_PER_ELEMENT*t);i=h}),i}copyAttribute(e,t,i,n,s){let r=!1;return this._accessAttribute(e,t,(e,t)=>{const o=e.view.count;if(0===o)return void(r=!0);const a=e.attributes[t].format,c=new DataView(this._data.buffer,e.view.offset+Vl(e.attributes,t)),l=new DataView(i,s),h=_s[a],u=jl(c,a),_=ql(l,a);if(!u||!_)return;const d=h.count,m=e.view.stride,p=Wl(a),f=n,g=p;for(let e=0;e<o;++e)for(let t=0;t<d;++t){_(f*e+g*t,u(m*e+p*t))}r=!0}),r}readIndices(e){if(e>=this._struct.primitives.length)return null;const t=this._struct.primitives[e];if(!t.indexView)return null;const i=t.indexView.stride;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)}copyIndices(e,t){if(e>=this._struct.primitives.length)return!1;const i=this._struct.primitives[e];if(!i.indexView)return!1;const n=i.indexView.count,s=1===i.indexView.stride?En.R8UI:2===i.indexView.stride?En.R16UI:En.R32UI,r=jl(new DataView(this._data.buffer),s);for(let e=0;e<n;++e)t[e]=r(i.indexView.offset+_s[s].size*e);return!0}_accessAttribute(e,t,i){if(e>=this._struct.primitives.length)return;const n=this._struct.primitives[e];for(const e of n.vertexBundelIndices){const n=this._struct.vertexBundles[e],s=n.attributes.findIndex(e=>e.name===t);if(!(s<0)){i(n,s);break}}}_createVertexBuffers(e,t){return this._struct.vertexBundles.map(i=>{const n=e.createBuffer({usage:An.VERTEX|An.TRANSFER_DST,memUsage:Cn.DEVICE,size:i.view.length,stride:i.view.stride}),s=new Uint8Array(t,i.view.offset,i.view.length);return this.loaded?n.update(s):this.once("load",()=>{n.update(s)}),n})}}).prototype,"_struct",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),Ol=Po(wl.prototype,"_dataLength",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pl=Po(wl.prototype,"_hash",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rl=wl))||Rl);function Vl(e,t){let i=0;for(let n=0;n<t;++n){const t=e[n];i+=_s[t.format].size}return i}i.Mesh=Hl;const kl=Oa.isLittleEndian;function Wl(e){const t=_s[e];return t.size/t.count}function jl(e,t){const i=_s[t],n=i.size/i.count;switch(i.type){case es.UNORM:switch(n){case 1:return t=>e.getUint8(t);case 2:return t=>e.getUint16(t,kl);case 4:return t=>e.getUint32(t,kl)}break;case es.SNORM:case es.INT:switch(n){case 1:return t=>e.getInt8(t);case 2:return t=>e.getInt16(t,kl);case 4:return t=>e.getInt32(t,kl)}break;case es.UINT:switch(n){case 1:return t=>e.getUint8(t);case 2:return t=>e.getUint16(t,kl);case 4:return t=>e.getUint32(t,kl)}break;case es.FLOAT:return t=>e.getFloat32(t,kl)}return null}function ql(e,t){const i=_s[t],n=i.size/i.count;switch(i.type){case es.UNORM:switch(n){case 1:return(t,i)=>e.setUint8(t,i);case 2:return(t,i)=>e.setUint16(t,i,kl);case 4:return(t,i)=>e.setUint32(t,i,kl)}break;case es.SNORM:case es.INT:switch(n){case 1:return(t,i)=>e.setInt8(t,i);case 2:return(t,i)=>e.setInt16(t,i,kl);case 4:return(t,i)=>e.setInt32(t,i,kl)}break;case es.UINT:switch(n){case 1:return(t,i)=>e.setUint8(t,i);case 2:return(t,i)=>e.setUint16(t,i,kl);case 4:return(t,i)=>e.setUint32(t,i,kl)}break;case es.FLOAT:return(t,i)=>e.setFloat32(t,i,kl)}return null}let Xl=0;const Yl={};var Kl={addStage(e){if(void 0!==Yl[e])return;const t=1<<Xl;Yl[e]=t,Xl+=1},stageID(e){const t=Yl[e];return void 0===t?-1:t},stageIDs(e){let t=0;for(const i of e){const e=Yl[i];void 0!==e&&(t|=e)}return t}};let Zl,$l;!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(Zl||(Zl={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}($l||($l={}));let Ql;!function(e){e[e.UBO=0]="UBO",e[e.SAMPLER=1]="SAMPLER"}(Ql||(Ql={}));const Jl=(e,t,i,n,s=0)=>e<<28&4026531840|n<<22&264241152|t<<20&3145728|i<<14&1032192|16383&s,eh=e=>(4026531840&e)>>>28,th=e=>(264241152&e)>>>22,ih=e=>(1032192&e)>>>14,nh=e=>16383&e,sh=(e,t)=>-264241153&e|t<<22&264241152,rh={[Tn.UNKNOWN]:(e,t,i=0)=>console.warn("illegal uniform handle"),[Tn.INT]:(e,t,i=0)=>e[i],[Tn.INT2]:(e,t,i=0)=>ci.fromArray(t,e,i),[Tn.INT3]:(e,t,i=0)=>_i.fromArray(t,e,i),[Tn.INT4]:(e,t,i=0)=>fi.fromArray(t,e,i),[Tn.FLOAT]:(e,t,i=0)=>e[i],[Tn.FLOAT2]:(e,t,i=0)=>ci.fromArray(t,e,i),[Tn.FLOAT3]:(e,t,i=0)=>_i.fromArray(t,e,i),[Tn.FLOAT4]:(e,t,i=0)=>fi.fromArray(t,e,i),[Tn.MAT3]:(e,t,i=0)=>vi.fromArray(t,e,i),[Tn.MAT4]:(e,t,i=0)=>wi.fromArray(t,e,i)},oh={[Tn.UNKNOWN]:(e,t,i=0)=>console.warn("illegal uniform handle"),[Tn.INT]:(e,t,i=0)=>e[i]=t,[Tn.INT2]:(e,t,i=0)=>ci.toArray(e,t,i),[Tn.INT3]:(e,t,i=0)=>_i.toArray(e,t,i),[Tn.INT4]:(e,t,i=0)=>fi.toArray(e,t,i),[Tn.FLOAT]:(e,t,i=0)=>e[i]=t,[Tn.FLOAT2]:(e,t,i=0)=>ci.toArray(e,t,i),[Tn.FLOAT3]:(e,t,i=0)=>_i.toArray(e,t,i),[Tn.FLOAT4]:(e,t,i=0)=>fi.toArray(e,t,i),[Tn.MAT3]:(e,t,i=0)=>vi.toArray(e,t,i),[Tn.MAT4]:(e,t,i=0)=>wi.toArray(e,t,i)},ah=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function ch(e){switch(e){case Tn.BOOL:case Tn.INT:case Tn.UINT:case Tn.FLOAT:return ah[0];case Tn.BOOL2:case Tn.INT2:case Tn.UINT2:case Tn.FLOAT2:return ah[1];case Tn.BOOL4:case Tn.INT4:case Tn.UINT4:case Tn.FLOAT4:return ah[2];case Tn.MAT4:return ah[3];case Tn.SAMPLER2D:return"default-texture";case Tn.SAMPLER_CUBE:return"default-cube-texture"}return ah[0]}function lh(e,t){const i=Object.entries(t);let n=!1;for(let t=0;t<i.length;t++)e[i[t][0]]!==i[t][1]&&(e[i[t][0]]=i[t][1],n=!0);return n}var hh;const uh=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}];let _h=e("SpriteFrame",Go("cc.SpriteFrame")(hh=class e extends sc{static createWithImage(t){const i=t instanceof mc?t:new mc(t),n=new jc;n.image=i;const s=new e;return s.texture=n,s}get insetTop(){return this._capInsets[1]}set insetTop(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}get insetBottom(){return this._capInsets[3]}set insetBottom(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}get insetLeft(){return this._capInsets[0]}set insetLeft(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}get insetRight(){return this._capInsets[2]}set insetRight(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}get rect(){return this._rect}set rect(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}get originalSize(){return this._originalSize}set originalSize(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}get offset(){return this._offset}set offset(e){this._offset.set(e)}get rotated(){return this._rotated}set rotated(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}get texture(){return this._texture}set texture(e){e?this.reset({texture:e},!0):console.warn("Error Texture in "+this.name)}get atlasUuid(){return this._atlasUuid}set atlasUuid(e){this._atlasUuid=e}get width(){return this._texture.width}get height(){return this._texture.height}set _textureSource(e){e&&(this._refreshTexture(e),this._calculateUV())}constructor(){super(),this.vertices=null,this.uv=[],this.uvHash=0,this.uvSliced=[],this._rect=new Bi,this._offset=new ci,this._originalSize=new Di,this._rotated=!1,this._capInsets=[0,0,0,0],this._atlasUuid="",this._texture=void 0,this._flipUv=!1}textureLoaded(){return this.texture&&this.texture.loaded}isRotated(){return this._rotated}setRotated(e){this.rotated=e}getRect(e){return e?(e.set(this._rect),e):this._rect.clone()}setRect(e){this.rect=e}getOriginalSize(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}setOriginalSize(e){this.originalSize=e}getOffset(e){return e?(e.set(this._offset),e):this._offset.clone()}setOffset(e){this.offset=e}getGFXTexture(){return this._texture.getGFXTexture()}getGFXSampler(){return this._texture.getGFXSampler()}reset(e,t=!1){let i=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),e&&(e.texture&&(this.loaded=!1,this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._flipUv=!!e.isFlipUv),i=!0),i&&this.texture&&this._calculateUV()}checkRect(e){const t=this._rect;let i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(S(3300,this.name+"/"+e.name,i,e.width),!1):!(n>e.height)||(S(3301,this.name+"/"+e.name,n,e.height),!1)}onLoaded(){this.loaded=!0,this.emit("load")}destroy(){return super.destroy()}_calculateSlicedUV(){const e=this._rect,t=this.texture,i=t.width,n=t.height,s=this._capInsets[0],r=this._capInsets[2],o=e.width-s-r,a=this._capInsets[1],c=this._capInsets[3],l=e.height-a-c,h=this.uvSliced;if(h.length=0,this._rotated){uh[0].u=(e.x+.5)/i,uh[1].u=(e.x+c)/i,uh[2].u=(e.x+c+l)/i,uh[3].u=(e.x+e.height-.5)/i,uh[3].v=(e.y+.5)/n,uh[2].v=(e.y+s)/n,uh[1].v=(e.y+s+o)/n,uh[0].v=(e.y+e.width-.5)/n;for(let e=0;e<4;++e){const t=uh[e];for(let e=0;e<4;++e){const i=uh[3-e];h.push({u:t.u,v:i.v})}}}else{uh[0].u=(e.x+.5)/i,uh[1].u=(e.x+s)/i,uh[2].u=(e.x+s+o)/i,uh[3].u=(e.x+e.width-.5)/i,uh[3].v=(e.y+.5)/n,uh[2].v=(e.y+a)/n,uh[1].v=(e.y+a+l)/n,uh[0].v=(e.y+e.height-.5)/n;for(let e=0;e<4;++e){const t=uh[e];for(let e=0;e<4;++e){const i=uh[e];h.push({u:i.u,v:t.v})}}}}_calculateUV(){const e=this._rect,t=this.uv,i=this.texture,n=i.width,s=i.height;if(this._rotated){const i=0===n?0:(e.x+.5)/n,r=0===n?0:(e.x+e.height-.5)/n,o=0===s?0:(e.y+.5)/s,a=0===s?0:(e.y+e.width-.5)/s;this._flipUv,t[0]=i,t[1]=o,t[2]=i,t[3]=a,t[4]=r,t[5]=o,t[6]=r,t[7]=a}else{const i=0===n?0:(e.x+.5)/n,r=0===n?0:(e.x+e.width-.5)/n,o=0===s?0:(e.y+e.height-.5)/s,a=0===s?0:(e.y+.5)/s;this._flipUv?(t[0]=i,t[1]=a,t[2]=r,t[3]=a,t[4]=i,t[5]=o,t[6]=r,t[7]=o):(t[0]=i,t[1]=o,t[2]=r,t[3]=o,t[4]=i,t[5]=a,t[6]=r,t[7]=a)}let r="";for(let e=0;e<t.length;e++)r+=t[e];this.uvHash=Os(r,666);const o=this.vertices;if(o){o.nu.length=0,o.nv.length=0;for(let e=0;e<o.u.length;e++)o.nu[e]=o.u[e]/n,o.nv[e]=o.v[e]/s}this._calculateSlicedUV()}_serialize(e){const t=this._rect,i=this._offset,n=this._originalSize;let s,r,o=this._uuid;this._texture&&(s=this._texture._uuid),o&&e&&(o=EditorExtends.UuidUtils.compressUuid(o,!0)),s&&e&&(s=EditorExtends.UuidUtils.compressUuid(s,!0)),this.vertices&&(r={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v});return{name:this._name,atlas:e?void 0:this._atlasUuid,rect:t,offset:i,originalSize:n,rotated:this._rotated,capInsets:this._capInsets,vertices:r,texture:s}}_deserialize(e,t){const i=e,n=i.rect;n&&(this._rect=new Bi(n.x,n.y,n.width,n.height));const s=i.offset;i.offset&&(this._offset=new ci(s.x,s.y));const r=i.originalSize;i.originalSize&&(this._originalSize=new Di(r.width,r.height)),this._rotated=!!i.rotated,this._name=i.name;const o=i.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),i.texture&&t.result.push(this,"_textureSource",i.texture),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}_textureLoaded(){const e=this._texture,t={};let i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new Bi(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(t.originalSize=new Di(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded())}_refreshTexture(e){this._texture=e,e.loaded?this._textureLoaded():e.once("load",this._textureLoaded,this)}})||hh);var dh,mh,ph,fh,gh,vh;i.SpriteFrame=_h,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(vh||(vh={}));let yh=e("TextureCube",Go("cc.TextureCube")((gh=fh=class e extends Uc{constructor(...e){super(...e),Oo(this,"_mipmaps",ph,this)}get mipmaps(){return this._mipmaps}set mipmaps(e){if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const e=this._mipmaps[0].front;this.reset({width:e.width,height:e.height,format:e.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((e,t)=>{xh(e,(e,i)=>{this._assignImage(e,t,i)})})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(e){this.mipmaps=e?[e]:[]}static fromTexture2DArray(t,i){const n=[],s=t.length/6;for(let e=0;e<s;e++){const i=6*e;n.push({front:t[i+vh.front].image,back:t[i+vh.back].image,left:t[i+vh.left].image,right:t[i+vh.right].image,top:t[i+vh.top].image,bottom:t[i+vh.bottom].image})}return(i=i||new e).mipmaps=n,i}onLoaded(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}reset(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}updateMipmaps(e=0,t){if(e>=this._mipmaps.length)return;const i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e);for(let t=0;t<i;++t){const i=e+t;xh(this._mipmaps[i],(e,t)=>{this._assignImage(e,i,t)})}}destroy(){return this._mipmaps=[],super.destroy()}releaseTexture(){this.mipmaps=[]}_serialize(e){return{base:super._serialize(),mipmaps:this._mipmaps.map(t=>e?{front:EditorExtends.UuidUtils.compressUuid(t.front._uuid,!0),back:EditorExtends.UuidUtils.compressUuid(t.back._uuid,!0),left:EditorExtends.UuidUtils.compressUuid(t.left._uuid,!0),right:EditorExtends.UuidUtils.compressUuid(t.right._uuid,!0),top:EditorExtends.UuidUtils.compressUuid(t.top._uuid,!0),bottom:EditorExtends.UuidUtils.compressUuid(t.bottom._uuid,!0)}:{front:t.front._uuid,back:t.back._uuid,left:t.left._uuid,right:t.right._uuid,top:t.top._uuid,bottom:t.bottom._uuid})}}_deserialize(e,t){const i=e;super._deserialize(i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(let e=0;e<i.mipmaps.length;++e){this._mipmaps[e]={front:new mc,back:new mc,left:new mc,right:new mc,top:new mc,bottom:new mc};const n=i.mipmaps[e];t.result.push(this._mipmaps[e],"front",n.front),t.result.push(this._mipmaps[e],"back",n.back),t.result.push(this._mipmaps[e],"left",n.left),t.result.push(this._mipmaps[e],"right",n.right),t.result.push(this._mipmaps[e],"top",n.top),t.result.push(this._mipmaps[e],"bottom",n.bottom)}}_getGfxTextureCreateInfo(e){const t=Object.assign({type:Un.CUBE,width:this._width,height:this._height,layerCount:6},e);return t.flags=(t.flags||0)|Vn.CUBEMAP,t}},fh.FaceIndex=vh,ph=Po((mh=gh).prototype,"_mipmaps",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dh=mh))||dh);function xh(e,t){t(e.front,vh.front),t(e.back,vh.back),t(e.left,vh.left),t(e.right,vh.right),t(e.top,vh.top),t(e.bottom,vh.bottom)}i.TextureCube=yh;var Sh=e("effects",[{name:"builtin-billboard",_uuid:"711ebe11-f673-4cd9-9a83-63c60ba54c5b",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:2143664850,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(set = 1, binding = 1) uniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 3) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 2) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"builtin-graphics",_uuid:"1c02ae6f-4492-4915-b8f8-7492a3b1e4cd",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-graphics|vs:vert|fs:frag"}]}],shaders:[{name:"builtin-graphics|vs:vert|fs:frag",hash:3946667351,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    float aa = fwidth(v_dist);\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    #ifdef GL_OES_standard_derivatives\n      float aa = fwidth(v_dist);\n    #else\n      float aa = 0.05;\n    #endif\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 2) in float a_dist;\nlayout(location = 1) out float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    float aa = fwidth(v_dist);\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"builtin-particle-gpu",_uuid:"971bdb23-3ff6-43eb-b422-1c30165a3663",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:3696836305,glsl3:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord;\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  layout(std140) uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  layout(std140) uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  layout(std140) uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  layout(std140) uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  layout(std140) uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  layout(std140) uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord;\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  uniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  uniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  uniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  uniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  uniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  uniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture2D(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(set = 1, binding = 1) uniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nlayout(set = 1, binding = 2) uniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nlayout(location = 0) in vec4 a_position_starttime;\nlayout(location = 1) in vec4 a_size_uv;\nlayout(location = 2) in vec4 a_rotation_uv;\nlayout(location = 3) in vec4 a_color;\nlayout(location = 4) in vec4 a_dir_life;\nlayout(location = 5) in float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  layout(location = 6) in vec3 a_texCoord;\n  layout(location = 7) in vec3 a_texCoord3;\n  layout(location = 8) in vec3 a_normal;\n  layout(location = 9) in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 10) uniform sampler2D color_over_time_tex0;\n  layout(set = 1, binding = 3) uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 11) uniform sampler2D rotation_over_time_tex0;\n  layout(set = 1, binding = 4) uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 12) uniform sampler2D size_over_time_tex0;\n  layout(set = 1, binding = 5) uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 13) uniform sampler2D force_over_time_tex0;\n  layout(set = 1, binding = 6) uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 14) uniform sampler2D velocity_over_time_tex0;\n  layout(set = 1, binding = 7) uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  layout(set = 1, binding = 15) uniform sampler2D texture_animation_tex0;\n  layout(set = 1, binding = 8) uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 16) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 9) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"builtin-particle-trail",_uuid:"17debcc3-0a6b-4b8a-b00b-dc58b885581e",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:4115155772,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  layout(std140) uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  layout(location = 2) out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  layout(location = 0) in vec2 uv;\n  layout(location = 1) in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    layout(location = 2) in vec3 vBarycentric;\n  #endif\n  layout(set = 1, binding = 2) uniform sampler2D mainTexture;\n  layout(set = 1, binding = 1) uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"builtin-particle",_uuid:"d1346436-ac96-4271-b863-1f4fdead95b0",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:66662317,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\n  in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\n  attribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_RENDER_MODE == 1\n  layout(location = 5) in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  layout(location = 6) in vec3 a_texCoord3;\n  layout(location = 7) in vec3 a_normal;\n  layout(location = 5) in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:5},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"builtin-sprite",_uuid:"60f7195c-ec2a-45eb-ba94-8955f60e81d0",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:2679078392,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture(tex, uv);\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture2D(tex, uv);\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 color;\nlayout(location = 1) out vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture(tex, uv);\n#endif\n}\nlayout(location = 0) in vec4 color;\n#if USE_TEXTURE\n  layout(location = 1) in vec2 uv0;\n  layout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"builtin-standard",_uuid:"1baf0fc9-befa-459c-8bdd-af1a450a0319",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"builtin-standard|standard-vs:vert|standard-fs:frag",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"builtin-standard|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:3803722737,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nout vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if USE_VERTEX_COLOR\n  in vec3 a_color;\n  out vec3 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\nout float v_fog_factor;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  out vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  in vec2 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(std140) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nin vec4 v_shadowPos;\nuniform sampler2D cc_shadowMap;\nfloat CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float closestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  float shadow = step(closestDepth, clipPos.z - 0.001);\n  return shadow;\n}\nfloat CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  float closestDepth = 0.0;\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  return shadow /= 5.0;\n}\nfloat CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 9.0;\n}\nfloat CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 25.0;\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      float pcf = cc_shadowPCF.x + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) {shadowAttenuation = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadowAttenuation = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadowAttenuation = CCGetShadowFactorX5();}\n      else {shadowAttenuation = CCGetShadowFactorX1();}\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor * (1.0 - cc_shadowColor.a);\n      finalColor = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\nin float v_fog_factor;\n#if USE_VERTEX_COLOR\n  in vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nvarying vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if USE_VERTEX_COLOR\n  attribute vec3 a_color;\n  varying vec3 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying float v_fog_factor;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  attribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  varying vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform lowp vec4 cc_shadowColor;\nuniform lowp vec4 cc_shadowPCF;\nuniform lowp vec4 cc_shadowSize;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return texture2DLodEXT(tex, coord, lod);\n    #else\n      return texture2D(tex, coord, lod);\n    #endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return textureCubeLodEXT(tex, coord, lod);\n    #else\n      return textureCube(tex, coord, lod);\n    #endif\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  varying vec2 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nuniform highp vec4 cc_lightPos[1];\nuniform vec4 cc_lightColor[1];\nuniform vec4 cc_lightSizeRangeAngle[1];\nuniform vec4 cc_lightDir[1];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nvarying vec4 v_shadowPos;\nuniform sampler2D cc_shadowMap;\nfloat CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  float shadow = step(closestDepth, clipPos.z - 0.001);\n  return shadow;\n}\nfloat CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  float closestDepth = 0.0;\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  return shadow /= 5.0;\n}\nfloat CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 9.0;\n}\nfloat CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 25.0;\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture2D(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      float pcf = cc_shadowPCF.x + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) {shadowAttenuation = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadowAttenuation = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadowAttenuation = CCGetShadowFactorX5();}\n      else {shadowAttenuation = CCGetShadowFactorX1();}\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor * (1.0 - cc_shadowColor.a);\n      finalColor = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\n  varying vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture2D(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture2D(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nlayout(location = 0) out vec4 v_shadowPos;\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if USE_VERTEX_COLOR\n  layout(location = 13) in vec3 a_color;\n  layout(location = 1) out vec3 v_color;\n#endif\nlayout(location = 2) out vec3 v_position;\nlayout(location = 3) out vec3 v_normal;\nlayout(location = 4) out vec2 v_uv;\nlayout(location = 5) out vec2 v_uv1;\nlayout(location = 6) out float v_fog_factor;\n#if USE_NORMAL_MAP\n  layout(location = 7) out vec3 v_tangent;\n  layout(location = 8) out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  layout(location = 14) in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  layout(location = 9) out vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if CC_USE_IBL\nlayout(set = 0, binding = 3) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  layout(location = 9) in vec2 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(set = 2, binding = 1) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nlayout(location = 0) in vec4 v_shadowPos;\nlayout(set = 0, binding = 4) uniform sampler2D cc_shadowMap;\nfloat CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float closestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  float shadow = step(closestDepth, clipPos.z - 0.001);\n  return shadow;\n}\nfloat CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  float closestDepth = 0.0;\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  return shadow /= 5.0;\n}\nfloat CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 9.0;\n}\nfloat CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 25.0;\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      float pcf = cc_shadowPCF.x + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) {shadowAttenuation = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadowAttenuation = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadowAttenuation = CCGetShadowFactorX5();}\n      else {shadowAttenuation = CCGetShadowFactorX1();}\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor * (1.0 - cc_shadowColor.a);\n      finalColor = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(location = 2) in vec3 v_position;\nlayout(location = 4) in vec2 v_uv;\nlayout(location = 5) in vec2 v_uv1;\nlayout(location = 3) in vec3 v_normal;\nlayout(location = 6) in float v_fog_factor;\n#if USE_VERTEX_COLOR\n  layout(location = 1) in vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  layout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  layout(location = 7) in vec3 v_tangent;\n  layout(location = 8) in vec3 v_bitangent;\n  layout(set = 1, binding = 2) uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  layout(set = 1, binding = 3) uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  layout(set = 1, binding = 4) uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  layout(set = 1, binding = 5) uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  layout(set = 1, binding = 6) uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_shadowMap",defines:["!CC_FORWARD_ADD","CC_RECEIVE_SHADOW"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:15,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:32,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"builtin-standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:868488122,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  in vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  attribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture2D(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  layout(location = 13) in vec2 a_texCoord1;\n#endif\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out vec2 v_uv1;\nlayout(location = 2) out vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in vec2 v_uv1;\nlayout(location = 2) in vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  layout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"builtin-terrain",_uuid:"1d08ef62-a503-4ce2-8b9a-46c90873f7d3",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},lightMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:298856331,glsl3:{vert:"\n  precision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  in vec3 a_position;\n  in vec3 a_normal;\n  in vec2 a_texCoord;\n  out vec2 uvw;\n  out vec2 uv0;\n  out vec2 uv1;\n  out vec2 uv2;\n  out vec2 uv3;\n  out vec2 luv;\n  out vec3 diffuse;\n  out float factor_fog;\n  layout(std140) uniform TexCoords {\n    vec4 UVScale;\n    vec4 lightMapUVParam;\n  };\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  in vec2 luv;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\n  uniform sampler2D lightMap;\n  in float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\n  precision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  attribute vec3 a_position;\n  attribute vec3 a_normal;\n  attribute vec2 a_texCoord;\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec2 luv;\n  varying vec3 diffuse;\n  varying float factor_fog;\n  uniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  varying vec2 luv;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\n  uniform sampler2D lightMap;\n  varying float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture2D(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n  precision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  layout(location = 0) in vec3 a_position;\n  layout(location = 1) in vec3 a_normal;\n  layout(location = 2) in vec2 a_texCoord;\n  layout(location = 0) out vec2 uvw;\n  layout(location = 1) out vec2 uv0;\n  layout(location = 2) out vec2 uv1;\n  layout(location = 3) out vec2 uv2;\n  layout(location = 4) out vec2 uv3;\n  layout(location = 5) out vec2 luv;\n  layout(location = 6) out vec3 diffuse;\n  layout(location = 7) out float factor_fog;\n  layout(set = 1, binding = 0) uniform TexCoords {\n    vec4 UVScale;\n    vec4 lightMapUVParam;\n  };\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  layout(location = 0) in vec2 uvw;\n  layout(location = 1) in vec2 uv0;\n  layout(location = 2) in vec2 uv1;\n  layout(location = 3) in vec2 uv2;\n  layout(location = 4) in vec2 uv3;\n  layout(location = 6) in vec3 diffuse;\n  layout(location = 5) in vec2 luv;\n  layout(set = 1, binding = 1) uniform sampler2D weightMap;\n  layout(set = 1, binding = 2) uniform sampler2D detailMap0;\n  layout(set = 1, binding = 3) uniform sampler2D detailMap1;\n  layout(set = 1, binding = 4) uniform sampler2D detailMap2;\n  layout(set = 1, binding = 5) uniform sampler2D detailMap3;\n  layout(set = 1, binding = 6) uniform sampler2D lightMap;\n  layout(location = 7) in float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"LIGHT_MAP",type:"number",range:[0,3]},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"builtin-unlit",_uuid:"a3cd009f-0ab0-420d-9278-b9fdab939bbc",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:4280240937,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  in lowp vec4 a_color;\n  out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  out vec2 v_uv;\n  layout(std140) uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nout float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  in lowp vec4 v_color;\n#endif\nin float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  attribute lowp vec4 a_color;\n  varying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nvarying float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\n  varying lowp vec4 v_color;\n#endif\nvarying float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  layout(location = 13) in lowp vec4 a_color;\n  layout(location = 0) out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  layout(location = 1) out vec2 v_uv;\n  layout(set = 1, binding = 0) uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nlayout(location = 2) out float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  layout(location = 1) in vec2 v_uv;\n  layout(set = 1, binding = 2) uniform sampler2D mainTexture;\n#endif\nlayout(set = 1, binding = 1) uniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  layout(location = 0) in lowp vec4 v_color;\n#endif\nlayout(location = 2) in float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"pipeline/planar-shadow",_uuid:"9361fd90-ba52-4f84-aa93-6e878fd576ca",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2804795238,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"pipeline/skybox",_uuid:"511d2633-09a7-4bdd-ac42-f778032124b3",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:629379420,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(location = 0) out mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 3) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(location = 0) in mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"util/profiler",_uuid:"871c3b6c-7379-419d-bda3-794b239ab90d",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:4021376818,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\n  vec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform mediump vec4 cc_screenSize;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 offset;\n};\nlayout(set = 1, binding = 1) uniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"util/splash-screen",_uuid:"970b0598-bcb0-4714-91fb-2e81440dccd8",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:2106901053,glsl3:{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nlayout(std140) uniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform float u_precent;\nvec4 frag () {\n  vec4 color = texture2D(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 1) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 0) uniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[{name:"splashFrag",defines:[],binding:0,stageFlags:16,members:[{name:"u_precent",type:13,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]);const Th=e("builtinResMgr",i.builtinResMgr=new class{constructor(){this._device=null,this._resources={}}initBuiltinRes(e){this._device=e;const t=this._resources,n=document.createElement("canvas"),s=n.getContext("2d"),r=new mc(n),o=n.width=n.height=2;s.fillStyle="#000",s.fillRect(0,0,o,o);const a=new jc;a._uuid="black-texture",a.image=r,t[a._uuid]=a,s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,o,o);const c=new Uint8Array(16);for(let e=0;e<c.length;++e)c[e]=0;const l=new jc;l._uuid="empty-texture",l.image=r,l.uploadData(c),t[l._uuid]=l;const h=new yh;h._uuid="black-cube-texture",h.setMipFilter(yh.Filter.LINEAR),h.image={front:new mc(n),back:new mc(n),left:new mc(n),right:new mc(n),top:new mc(n),bottom:new mc(n)},t[h._uuid]=h,s.fillStyle="#777",s.fillRect(0,0,o,o);const u=new jc;u._uuid="grey-texture",u.image=r,t[u._uuid]=u,s.fillStyle="#fff",s.fillRect(0,0,o,o);const _=new jc;_._uuid="white-texture",_.image=r,t[_._uuid]=_;const d=new yh;d._uuid="white-cube-texture",d.setMipFilter(yh.Filter.LINEAR),d.image={front:new mc(n),back:new mc(n),left:new mc(n),right:new mc(n),top:new mc(n),bottom:new mc(n)},t[d._uuid]=d,s.fillStyle="#7f7fff",s.fillRect(0,0,o,o);const m=new jc;m._uuid="normal-texture",m.image=r,t[m._uuid]=m,n.width=n.height=16,s.fillStyle="#ddd",s.fillRect(0,0,16,16),s.fillStyle="#555",s.fillRect(0,0,8,8),s.fillStyle="#555",s.fillRect(8,8,8,8);const p=new jc;p._uuid="default-texture",p.image=r,t[p._uuid]=p;const f=new yh;f.setMipFilter(yh.Filter.LINEAR),f._uuid="default-cube-texture",f.image={front:new mc(n),back:new mc(n),left:new mc(n),right:new mc(n),top:new mc(n),bottom:new mc(n)},t[f._uuid]=f;const g=new _h,v=r._texture;g.texture=v,g._uuid="default-spriteframe",t[g._uuid]=g,Sh.forEach(e=>{Object.assign(new i.EffectAsset,e).onLoaded()});const y=new i.Material;y._uuid="standard-material",y.initialize({effectName:"builtin-standard"}),t[y._uuid]=y;const x=new i.Material;x._uuid="missing-effect-material",x.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),x.setProperty("mainColor",i.color("#ffff00")),t[x._uuid]=x;const S=new i.Material;S._uuid="missing-material",S.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),S.setProperty("mainColor",i.color("#ff00ff")),t[S._uuid]=S;const T=new i.Material;T._uuid="ui-base-material",T.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),t[T._uuid]=T;const E=new i.Material;E._uuid="ui-sprite-material",E.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"builtin-sprite"}),t[E._uuid]=E;const A=new i.Material;A._uuid="ui-sprite-gray-material",A.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"builtin-sprite"}),t[A._uuid]=A;const C=new i.Material;C._uuid="ui-sprite-alpha-sep-material",C.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"builtin-sprite"}),t[C._uuid]=C;const b=new i.Material;b._uuid="ui-sprite-gray-alpha-sep-material",b.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"builtin-sprite"}),t[b._uuid]=b;const R=new i.Material;R._uuid="ui-graphics-material",R.initialize({effectName:"builtin-graphics"}),t[R._uuid]=R;const w=new i.Material;w._uuid="default-particle-material",w.initialize({effectName:"builtin-particle"}),t[w._uuid]=w;const I=new i.Material;I._uuid="default-particle-gpu-material",I.initialize({effectName:"builtin-particle-gpu"}),t[I._uuid]=I;const O=new i.Material;O._uuid="default-trail-material",O.initialize({effectName:"builtin-particle-trail"}),t[O._uuid]=O;const P=new i.Material;P._uuid="default-billboard-material",P.initialize({effectName:"builtin-billboard"}),t[P._uuid]=P}get(e){return this._resources[e]}}),Eh=(()=>{const e=new Map;let t=0;return i=>"number"==typeof i?i:(e.has(i)||(e.set(i,1<<t),t++),e.get(i))})();class Ah{constructor(e,t,i){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=i*(1<<t)}allocateNewChunk(){return new ArrayBuffer(this._chunkSize)}}class Ch{constructor(e,t){}}class bh{constructor(e,t,i,n=8){this._viewCtor=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freelists=[],this._bufferViews=[],this._nativePool=void 0,this._viewCtor=t,this._elementCount=i.COUNT,this._entryBits=n;const s=t.BYTES_PER_ELEMENT||1;this._stride=s*this._elementCount,this._entriesPerChunk=1<<n,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Ah(e,n,this._stride)}alloc(){let e=0;for(;e<this._freelists.length;e++){const t=this._freelists[e];if(t.length){const i=t[t.length-1];return t.length--,(e<<this._entryBits)+i+this._poolFlag}}const t=this._nativePool.allocateNewChunk(),i=[],n=[];for(let e=0;e<this._entriesPerChunk;e++)i.push(new this._viewCtor(t,this._stride*e,this._elementCount)),e&&n.push(e);return this._arrayBuffers.push(t),this._bufferViews.push(i),this._freelists.push(n),(e<<this._entryBits)+this._poolFlag}get(e,t){const i=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return this._bufferViews[i][n][t]}set(e,t,i){const n=(this._chunkMask&e)>>this._entryBits,s=this._entryMask&e;this._bufferViews[n][s][t]=i}free(e){const t=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e;this._bufferViews[t][i].fill(0),this._freelists[t].push(i)}}class Rh{constructor(e,t,i){this._ctor=void 0,this._dtor=void 0,this._indexMask=void 0,this._poolFlag=void 0,this._array=[],this._freelist=[],this._nativePool=void 0,this._ctor=t,i&&(this._dtor=i),this._poolFlag=1<<29,this._indexMask=~this._poolFlag,this._nativePool=new Ch(e,this._array)}alloc(...e){const t=this._freelist;let i=-1;if(t.length&&(i=t[t.length-1],t.length--,this._array[i]=this._ctor(arguments,this._array[i])),i<0){i=this._array.length;const e=this._ctor(arguments);if(!e)return 0;this._array.push(e)}return i+this._poolFlag}get(e){const t=this._indexMask&e;return this._array[t]}free(e){const t=this._indexMask&e;this._dtor&&this._dtor(this._array[t]),this._freelist.push(t)}}var wh;!function(e){e[e.RASTERIZER_STATE=0]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=1]="DEPTH_STENCIL_STATE",e[e.BLEND_STATE=2]="BLEND_STATE",e[e.DESCRIPTOR_SETS=3]="DESCRIPTOR_SETS",e[e.SHADER=4]="SHADER",e[e.INPUT_ASSEMBLER=5]="INPUT_ASSEMBLER",e[e.PIPELINE_LAYOUT=6]="PIPELINE_LAYOUT",e[e.PASS=7]="PASS",e[e.SUB_MODEL=8]="SUB_MODEL"}(wh||(wh={}));const Ih=new Rh(wh.RASTERIZER_STATE,()=>new Ms),Oh=new Rh(wh.DEPTH_STENCIL_STATE,()=>new Ds),Ph=new Rh(wh.BLEND_STATE,()=>new Bs),Mh=new Rh(wh.SHADER,(e,t)=>t?(t.initialize(e[1]),t):e[0].createShader(e[1]),e=>e&&e.destroy()),Dh=new Rh(wh.DESCRIPTOR_SETS,(e,t)=>t?(t.initialize(e[1]),t):e[0].createDescriptorSet(e[1]),e=>e&&e.destroy()),Lh=new Rh(wh.INPUT_ASSEMBLER,(e,t)=>t?(t.initialize(e[1]),t):e[0].createInputAssembler(e[1]),e=>e&&e.destroy()),Bh=new Rh(wh.PIPELINE_LAYOUT,(e,t)=>t?(t.initialize(e[1]),t):e[0].createPipelineLayout(e[1]),e=>e&&e.destroy());let Nh;!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.BATCHING_SCHEME=3]="BATCHING_SCHEME",e[e.PRIMITIVE=4]="PRIMITIVE",e[e.DYNAMIC_STATES=5]="DYNAMIC_STATES",e[e.HASH=6]="HASH",e[e.RASTERIZER_STATE=7]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=8]="DEPTH_STENCIL_STATE",e[e.BLEND_STATE=9]="BLEND_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.PIPELINE_LAYOUT=11]="PIPELINE_LAYOUT",e[e.COUNT=12]="COUNT"}(Nh||(Nh={}));const Fh=new bh(wh.PASS,Uint32Array,Nh);let zh;!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.PASS_COUNT=1]="PASS_COUNT",e[e.PASS_0=2]="PASS_0",e[e.PASS_1=3]="PASS_1",e[e.PASS_2=4]="PASS_2",e[e.PASS_3=5]="PASS_3",e[e.SHADER_0=6]="SHADER_0",e[e.SHADER_1=7]="SHADER_1",e[e.SHADER_2=8]="SHADER_2",e[e.SHADER_3=9]="SHADER_3",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COUNT=12]="COUNT"}(zh||(zh={}));const Uh=new bh(wh.SUB_MODEL,Uint32Array,zh);function Gh(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Hh(e,t){switch(e.type){case"boolean":return("number"==typeof t?t:t?1:0)+"";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn(`unknown define type '${e.type}'`),"-1"}function Vh(e,t){return e+t.reduce((e,t)=>t.isDefault?e:`${e}|${t.name}${t.value}`,"")}function kh(e,t,i){const n=e.builtins[i],s=e.blocks;for(let e=0;e<n.blocks.length;e++){const i=n.blocks[e],r=t.record[i.name];if(!(r&&t.bindings[r.binding].descriptorType&Xs)){console.warn(`builtin UBO '${i.name}' not available!`);continue}const o=Object.assign({size:Wh(r)},r);s.push(o)}const r=e.samplers;for(let e=0;e<n.samplers.length;e++){const i=n.samplers[e],s=t.record[i.name];s&&t.bindings[s.binding].descriptorType&Ys?r.push(s):console.warn(`builtin sampler '${i.name}' not available!`)}}function Wh(e){return e.members.reduce((e,t)=>e+fs(t.type)*t.count,0)}function jh(e,t){for(let i=0;i<e.length;i++){const n=e[i];if("!"===n[0]){if(t[n.slice(1)])return!1}else if(!t[n])return!1}return!0}let qh=null;const Xh=new class{constructor(){this._templates={},this._pipelineLayouts={},this._cache={}}define(e){const t=this._templates[e.name];if(t&&t.hash===e.hash)return;const i=e;let n=0;for(let e=0;e<i.defines.length;e++){const t=i.defines[e];let s=1;if("number"===t.type){const e=t.range;s=Gh(e[1]-e[0]+1),t._map=t=>t-e[0]}else"string"===t.type?(s=Gh(t.options.length),t._map=e=>Math.max(0,t.options.findIndex(t=>t===e))):"boolean"===t.type&&(t._map=e=>e?1:0);t._offset=n,n+=s}n>31&&(i.uber=!0),i.samplerStartBinding=i.blocks.length,i.bindings=i.blocks.concat(i.samplers);for(let e=0;e<i.blocks.length;e++){const t=i.blocks[e];t.count=1,t.size=Wh(t),t.set=rl.MATERIAL,t.descriptorType||(t.descriptorType=Wn.UNIFORM_BUFFER)}for(let e=0;e<i.samplers.length;e++){const t=i.samplers[e];t.set=rl.MATERIAL,t.descriptorType||(t.descriptorType=Wn.SAMPLER)}i.handleMap=function(e){const t={};for(let i=0;i<e.blocks.length;i++){const n=e.blocks[i],s=n.members;let r=0;for(let e=0;e<s.length;e++){const i=s[e];t[i.name]=Jl(Ql.UBO,n.set,n.binding,i.type,r),r+=(fs(i.type)>>2)*i.count}}for(let i=0;i<e.samplers.length;i++){const n=e.samplers[i];t[n.name]=Jl(Ql.SAMPLER,n.set,n.binding,n.type)}return t}(i),this._templates[e.name]=i,this._pipelineLayouts[e.name]={hPipelineLayout:0,setLayouts:[]}}getTemplate(e){return this._templates[e]}getPipelineLayout(e){return this._pipelineLayouts[e]}hasProgram(e){return void 0!==this._templates[e]}getKey(e,t){const i=this._templates[e],n=i.defines;if(i.uber){let e="";for(let i=0;i<n.length;i++){const s=n[i],r=t[s.name];if(!r||!s._map)continue;const o=s._map(r);e+=s._offset+(o+"|")}return e+i.hash}{let e=0;for(let i=0;i<n.length;i++){const s=n[i],r=t[s.name];if(!r||!s._map)continue;e|=s._map(r)<<s._offset}return`${e.toString(16)}|${i.hash}`}}destroyShaderByDefines(e){const t=Object.keys(e);if(!t.length)return;const i=t.map(t=>{let i=e[t];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(t+i)}),n=Object.keys(this._cache).filter(e=>i.every(t=>t.test(Mh.get(this._cache[e]).name)));for(let e=0;e<n.length;e++){const t=n[e],i=Mh.get(this._cache[t]);console.log("destroyed shader "+i.name),i.destroy(),delete this._cache[t]}}getGFXShader(e,t,i,n,s){Object.assign(i,n.macros),s||(s=this.getKey(t,i));const r=this._cache[s];if(r)return r;const o=this._templates[t],a=this._pipelineLayouts[t];a.hPipelineLayout||(kh(o,n.globalDescriptorSetLayout,"globals"),kh(o,n.localDescriptorSetLayout,"locals"),a.setLayouts[rl.GLOBAL]=n.descriptorSetLayout,a.setLayouts[rl.MATERIAL]||(a.setLayouts[rl.MATERIAL]=e.createDescriptorSetLayout({bindings:o.bindings})),a.setLayouts[rl.LOCAL]=qh=qh||e.createDescriptorSetLayout({bindings:n.localDescriptorSetLayout.bindings}),a.hPipelineLayout=Bh.alloc(e,{setLayouts:a.setLayouts}));const c=function(e,t){const i=[];for(let n=0;n<t.length;n++){const s=t[n],r=s.name,o=e[r],a=Hh(s,o),c=!o||"0"===o;i.push({name:r,value:a,isDefault:c})}return i}(i,o.defines),l=c.reduce((e,t)=>`${e}#define ${t.name} ${t.value}\n`,"")+"\n";let h=o.glsl3;switch(e.gfxAPI){case Es.GLES2:case Es.WEBGL:h=o.glsl1;break;case Es.GLES3:case Es.WEBGL2:h=o.glsl3;break;case Es.VULKAN:case Es.METAL:h=o.glsl4;break;default:console.error("Invalid GFX API!")}const u=[];return function(e,t,i){const n=e.attributes;for(let e=0;e<n.length;e++){const s=n[e];jh(s.defines,t)&&i.push(s)}}(o,i,u),this._cache[s]=Mh.alloc(e,{name:Vh(t,c),blocks:o.blocks,samplers:o.samplers,attributes:u,stages:[{stage:kn.VERTEX,source:l+h.vert},{stage:kn.FRAGMENT,source:l+h.frag}]})}};i.programLib=Xh;const Yh={memUsage:Cn.HOST|Cn.DEVICE,usage:An.UNIFORM,size:0},Kh={buffer:null,offset:0,range:0},Zh={layout:null};let $h;!function(e){e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}($h||($h={}));class Qh{static fillPipelineInfo(e,t){void 0!==t.priority&&Fh.set(e,Nh.PRIORITY,t.priority),void 0!==t.primitive&&Fh.set(e,Nh.PRIMITIVE,t.primitive),void 0!==t.stage&&Fh.set(e,Nh.STAGE,t.stage),void 0!==t.dynamicStates&&Fh.set(e,Nh.DYNAMIC_STATES,t.dynamicStates),void 0!==t.phase&&Fh.set(e,Nh.PHASE,Eh(t.phase));const i=Ph.get(Fh.get(e,Nh.BLEND_STATE));if(t.blendState){const e=t.blendState;e.targets&&e.targets.forEach((e,t)=>Object.assign(i.targets[t]||(i.targets[t]=new Ls),e)),void 0!==e.isA2C&&(i.isA2C=e.isA2C),void 0!==e.isIndepend&&(i.isIndepend=e.isIndepend),void 0!==e.blendColor&&Object.assign(i.blendColor,e.blendColor)}Object.assign(Ih.get(Fh.get(e,Nh.RASTERIZER_STATE)),t.rasterizerState),Object.assign(Oh.get(Fh.get(e,Nh.DEPTH_STENCIL_STATE)),t.depthStencilState)}static getPassHash(e,t){let i=t+","+Fh.get(e,Nh.PRIMITIVE)+","+Fh.get(e,Nh.DYNAMIC_STATES);var n;return i+=function(e){let t=`,bs,${e.isA2C},${e.blendColor}`;for(const i of e.targets)t+=`,bt,${i.blend},${i.blendEq},${i.blendAlphaEq},${i.blendColorMask}`,t+=`,${i.blendSrc},${i.blendDst},${i.blendSrcAlpha},${i.blendDstAlpha}`;return t}(Ph.get(Fh.get(e,Nh.BLEND_STATE))),i+=function(e){let t=`,dss,${e.depthTest},${e.depthWrite},${e.depthFunc}`;return t+=`,${e.stencilTestFront},${e.stencilFuncFront},${e.stencilRefFront},${e.stencilReadMaskFront}`,t+=`,${e.stencilFailOpFront},${e.stencilZFailOpFront},${e.stencilPassOpFront},${e.stencilWriteMaskFront}`,t+=`,${e.stencilTestBack},${e.stencilFuncBack},${e.stencilRefBack},${e.stencilReadMaskBack}`,t+=`,${e.stencilFailOpBack},${e.stencilZFailOpBack},${e.stencilPassOpBack},${e.stencilWriteMaskBack}`,t}(Oh.get(Fh.get(e,Nh.DEPTH_STENCIL_STATE))),i+=",rs,"+(n=Ih.get(Fh.get(e,Nh.RASTERIZER_STATE))).cullMode+","+n.depthBias+","+n.isFrontFaceCCW,Os(i,666)}constructor(e){this._rootBuffer=null,this._rootBufferDirty=!1,this._buffers=[],this._descriptorSet=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._root=void 0,this._device=void 0,this._hShaderDefault=0,this._handle=0,this._root=e,this._device=e.device}initialize(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()}getHandle(e,t=0,i=Tn.UNKNOWN){let n=this._propertyHandleMap[e];return n?(i?n=sh(n,i):t&&(n=sh(n,th(n)-t)),n+t):0}getBinding(e){const t=this.getHandle(e);return t?Qh.getBindingFromHandle(t):-1}setUniform(e,t){const i=Qh.getBindingFromHandle(e),n=Qh.getTypeFromHandle(e),s=Qh.getOffsetFromHandle(e),r=this._blocks[i];oh[n](r,t,s),this._rootBufferDirty=!0}getUniform(e,t){const i=Qh.getBindingFromHandle(e),n=Qh.getTypeFromHandle(e),s=Qh.getOffsetFromHandle(e),r=this._blocks[i];return rh[n](r,t,s)}setUniformArray(e,t){const i=Qh.getBindingFromHandle(e),n=Qh.getTypeFromHandle(e),s=fs(n)>>2,r=this._blocks[i];let o=Qh.getOffsetFromHandle(e);for(let e=0;e<t.length;e++,o+=s)null!==t[e]&&oh[n](r,t[e],o);this._rootBufferDirty=!0}bindTexture(e,t,i){this._descriptorSet.bindTexture(e,t,i)}bindSampler(e,t,i){this._descriptorSet.bindSampler(e,t,i)}setDynamicState(e,t){const i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}overridePipelineStates(e,t){console.warn("base pass cannot override states, please use pass instance instead.")}update(){this._rootBufferDirty&&this._rootBuffer&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()}destroy(){for(let e=0;e<this._shaderInfo.blocks.length;e++){const t=this._shaderInfo.blocks[e];sl(t.set)||this._buffers[t.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBlock=null),this._descriptorSet=null,this._handle&&(Ih.free(Fh.get(this._handle,Nh.RASTERIZER_STATE)),Oh.free(Fh.get(this._handle,Nh.DEPTH_STENCIL_STATE)),Ph.free(Fh.get(this._handle,Nh.BLEND_STATE)),Dh.free(Fh.get(this._handle,Nh.DESCRIPTOR_SET)),Fh.free(this._handle),this._handle=0)}resetUniform(e){const t=this.getHandle(e);if(!t)return;const i=Qh.getTypeFromHandle(t),n=Qh.getBindingFromHandle(t),s=Qh.getOffsetFromHandle(t),r=this._blocks[n],o=this._properties[e],a=o&&o.value||ch(i);oh[i](r,a,s),this._rootBufferDirty=!0}resetTexture(e,t){const i=this.getHandle(e);if(!i)return;const n=Qh.getTypeFromHandle(i),s=Qh.getBindingFromHandle(i),r=this._properties[e],o=r&&r.value,a=o?o+"-texture":ch(n),c=Th.get(a),l=c&&c.getGFXTexture(),h=r&&void 0!==r.samplerHash?r.samplerHash:c&&c.getSamplerHash(),u=xc.getSampler(this._device,h);this._descriptorSet.bindSampler(s,u,t),this._descriptorSet.bindTexture(s,l,t)}resetUBOs(){for(let e=0;e<this._shaderInfo.blocks.length;e++){const t=this._shaderInfo.blocks[e];if(sl(t.set))continue;const i=this._blocks[t.binding];let n=0;for(let e=0;e<t.members.length;e++){const s=t.members[e],r=this._properties[s.name],o=r&&r.value,a=o||ch(s.type),c=(fs(s.type)>>2)*s.count;for(let e=0;e+a.length<=c;e+=a.length)i.set(a,n+e);n+=c}}this._rootBufferDirty=!0}resetTextures(){for(let e=0;e<this._shaderInfo.samplers.length;e++){const t=this._shaderInfo.samplers[e];if(!sl(t.set))for(let e=0;e<t.count;e++)this.resetTexture(t.name,e)}}tryCompile(){const e=this._root.pipeline;return e?(this._syncBatchingScheme(),this._hShaderDefault=Xh.getGFXShader(this._device,this._programName,this._defines,e),this._hShaderDefault?(Fh.set(this._handle,Nh.PIPELINE_LAYOUT,Xh.getPipelineLayout(this._programName).hPipelineLayout),Fh.set(this._handle,Nh.HASH,Qh.getPassHash(this._handle,this._hShaderDefault)),!0):(console.warn(`create shader ${this._programName} failed`),!1)):null}getShaderVariant(e=null){if(!this._hShaderDefault&&!this.tryCompile())return console.warn("pass resources incomplete"),0;if(!e)return this._hShaderDefault;const t=this._root.pipeline;for(let t=0;t<e.length;t++){const i=e[t];this._defines[i.name]=i.value}const i=Xh.getGFXShader(this._device,this._programName,this._defines,t);for(let t=0;t<e.length;t++){const i=e[t];delete this._defines[i.name]}return i}beginChangeStatesSilently(){}endChangeStatesSilently(){}_doInit(e,t=!1){const i=this._handle=Fh.alloc();Fh.set(i,Nh.PRIORITY,Kc.DEFAULT),Fh.set(i,Nh.STAGE,Yc.DEFAULT),Fh.set(i,Nh.PHASE,Eh("default")),Fh.set(i,Nh.PRIMITIVE,wn.TRIANGLE_LIST),Fh.set(i,Nh.RASTERIZER_STATE,Ih.alloc()),Fh.set(i,Nh.DEPTH_STENCIL_STATE,Oh.alloc()),Fh.set(i,Nh.BLEND_STATE,Ph.alloc()),this._passIndex=e.passIndex,this._propertyIndex=void 0!==e.propertyIndex?e.propertyIndex:e.passIndex,this._programName=e.program,this._defines=t?Object.assign({},e.defines):e.defines,this._shaderInfo=Xh.getTemplate(e.program),this._properties=e.properties||this._properties;const n=this._device;Qh.fillPipelineInfo(i,e),e.stateOverrides&&Qh.fillPipelineInfo(i,e.stateOverrides);const s=Xh.getPipelineLayout(e.program).setLayouts;s[rl.MATERIAL]||(s[rl.MATERIAL]=n.createDescriptorSetLayout({bindings:this._shaderInfo.bindings})),Zh.layout=s[rl.MATERIAL];const r=Dh.alloc(this._device,Zh);Fh.set(this._handle,Nh.DESCRIPTOR_SET,r),this._descriptorSet=Dh.get(r);const o=this._shaderInfo.blocks,a=n.uboOffsetAlignment,c=[];let l=0,h=0;for(let e=0;e<o.length;e++){const{size:t,set:i}=o[e];sl(i)||(c.push(h),h+=Math.ceil(t/a)*a,l=t)}const u=c[c.length-1]+l;u&&(Yh.size=16*Math.ceil(u/16),this._rootBuffer=n.createBuffer(Yh),this._rootBlock=new ArrayBuffer(u));for(let e=0,t=0;e<o.length;e++){const{size:i,set:s,binding:r}=o[e];if(sl(s))continue;Kh.buffer=this._rootBuffer,Kh.offset=c[t++],Kh.range=16*Math.ceil(i/16);const a=this._buffers[r]=n.createBuffer(Kh);this._blocks[r]=new Float32Array(this._rootBlock,Kh.offset,i/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(r,a)}const _=this._propertyHandleMap=this._shaderInfo.handleMap,d={};for(const e in this._properties){const t=this._properties[e];t.handleInfo&&(d[e]=this.getHandle.apply(this,t.handleInfo))}Object.assign(_,d)}_syncBatchingScheme(){this._defines.USE_INSTANCING?this._device.hasFeature(As.INSTANCED_ARRAYS)?Fh.set(this._handle,Nh.BATCHING_SCHEME,$h.INSTANCING):(this._defines.USE_INSTANCING=!1,Fh.set(this._handle,Nh.BATCHING_SCHEME,0)):this._defines.USE_BATCHING?Fh.set(this._handle,Nh.BATCHING_SCHEME,$h.VB_MERGING):Fh.set(this._handle,Nh.BATCHING_SCHEME,0)}get root(){return this._root}get device(){return this._device}get shaderInfo(){return this._shaderInfo}get setLayouts(){return Xh.getPipelineLayout(this._programName).setLayouts}get program(){return this._programName}get properties(){return this._properties}get defines(){return this._defines}get passIndex(){return this._passIndex}get propertyIndex(){return this._propertyIndex}get dynamics(){return this._dynamics}get blocks(){return this._blocks}get handle(){return this._handle}get priority(){return Fh.get(this._handle,Nh.PRIORITY)}get primitive(){return Fh.get(this._handle,Nh.PRIMITIVE)}get stage(){return Fh.get(this._handle,Nh.STAGE)}get phase(){return Fh.get(this._handle,Nh.PHASE)}get rasterizerState(){return Ih.get(Fh.get(this._handle,Nh.RASTERIZER_STATE))}get depthStencilState(){return Oh.get(Fh.get(this._handle,Nh.DEPTH_STENCIL_STATE))}get blendState(){return Ph.get(Fh.get(this._handle,Nh.BLEND_STATE))}get dynamicStates(){return Fh.get(this._handle,Nh.DYNAMIC_STATES)}get batchingScheme(){return Fh.get(this._handle,Nh.BATCHING_SCHEME)}get descriptorSet(){return this._descriptorSet}get hash(){return Fh.get(this._handle,Nh.HASH)}}function Jh(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function eu(e,t){return Math.ceil(e/t)*t}Qh.PropertyType=Ql,Qh.getPropertyTypeFromHandle=eh,Qh.getTypeFromHandle=th,Qh.getBindingFromHandle=ih,Qh.getOffsetFromHandle=nh;class tu{constructor(e){this._device=void 0,this._format=En.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new ls,this._region1=new ls,this._region2=new ls,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}initialize(e){const t=_s[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=gs(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)}destroy(){for(let e=0;e<this._chunkCount;++e){this._chunks[e].texture.destroy()}this._chunks.length=0,this._handles.length=0}alloc(e,t){e=eu(e,this._alignment);let i=-1,n=-1;if(void 0!==t&&(i=t,n=this._findAvailableSpace(e,i)),n<0)for(let t=0;t<this._chunkCount&&(i=t,n=this._findAvailableSpace(e,i),!(n>=0));++t);if(n>=0){const t=this._chunks[i];t.start+=e;const s={chunkIdx:i,start:n,end:n+e,texture:t.texture};return this._handles.push(s),s}const s=Math.sqrt(e/this._formatSize),r=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,Jh(s)),o=this._chunks[this.createChunk(r)];o.start+=e;const a={chunkIdx:this._chunkCount-1,start:0,end:e,texture:o.texture};return this._handles.push(a),a}free(e){for(let t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}createChunk(e){const t=e*e*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);const i={texture:this._device.createTexture({type:Un.TEX2D,usage:Gn.SAMPLED|Gn.TRANSFER_DST,format:this._format,width:e,height:e,levelCount:1}),size:t,start:0,end:t};return this._chunks[this._chunkCount]=i,this._chunkCount++}update(e,t){const i=[],n=[],s=e.start/this._formatSize;let r=t.byteLength/this._formatSize,o=s%e.texture.width,a=Math.floor(s/e.texture.width),c=Math.min(e.texture.width-o,r),l=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=a,this._region0.texExtent.width=c,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),n.push(this._region0),o=0,a+=1,r-=c,l+=c),r>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=a,r>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(r/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=r,this._region1.texExtent.width=c,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),n.push(this._region1),o=0,a+=this._region1.texExtent.height,r-=c,l+=c),r>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=a,this._region2.texExtent.width=r,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(t,l*this._formatSize,r*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)}_findAvailableSpace(e,t){const i=this._chunks[t];let n=!1,s=i.start;if(s+e<=i.size)n=!0;else{s=0;const r=this._handles.filter(e=>e.chunkIdx===t).sort((e,t)=>e.start-t.start);for(let t=0;t<r.length;t++){const i=r[t];if(s+e<=i.start){n=!0;break}s=i.end}!n&&s+e<=i.size&&(n=!0)}return n?s:-1}_McDonaldAlloc(e){e=eu(e,this._alignment);for(let t=0;t<this._chunkCount;++t){const i=this._chunks[t];let n=!1,s=i.start;if(s+e<=i.end?n=!0:s>i.end?s+e<=i.size?n=!0:e<=i.end&&(i.start=s=0,n=!0):s===i.end&&(i.start=s=0,i.end=i.size,e<=i.end&&(n=!0)),n){i.start+=e;const n={chunkIdx:t,start:s,end:s+e,texture:i.texture};return this._handles.push(n),n}}const t=Math.sqrt(e/this._formatSize),i=this._roundUpFn&&this._roundUpFn(t,this._formatSize)||Math.max(1024,Jh(t)),n=this._chunks[this.createChunk(i)];n.start+=e;const s={chunkIdx:this._chunkCount,start:0,end:e,texture:n.texture};return this._handles.push(s),s}}var iu,nu,su,ru,ou,au,cu;const lu={};let hu=e("EffectAsset",Go("cc.EffectAsset")((cu=au=class e extends sc{constructor(...e){super(...e),Oo(this,"techniques",su,this),Oo(this,"shaders",ru,this),Oo(this,"combinations",ou,this)}static register(e){lu[e.name]=e}static remove(e){if(lu[e])delete lu[e];else for(const t in lu)if(lu[t]._uuid===e)return void delete lu[t]}static get(e){if(lu[e])return lu[e];for(const t in lu)if(lu[t]._uuid===e)return lu[t];return null}static getAll(){return lu}onLoaded(){this.shaders.forEach(e=>Xh.define(e)),i.game.once(i.Game.EVENT_ENGINE_INITED,this._precompile,this),e.register(this)}_precompile(){const e=i.director.root;for(let t=0;t<this.shaders.length;t++){const i=this.shaders[t],n=this.combinations[t];n&&Object.keys(n).reduce((e,t)=>e.reduce((e,i)=>{const s=n[t],r=[i].concat([...Array(s.length-1)].map(()=>Object.assign({},i)));return r.forEach((e,i)=>e[t]=s[i]),e.concat(r)},[]),[{}]).forEach(t=>Xh.getGFXShader(e.device,i.name,t,e.pipeline))}}},au._effects={},su=Po((nu=cu).prototype,"techniques",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ru=Po(nu.prototype,"shaders",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ou=Po(nu.prototype,"combinations",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iu=nu))||iu);var uu,_u,du,mu,pu,fu,gu,vu,yu;i.EffectAsset=hu;const xu=new Us;xu.endLayout=Yn.SHADER_READONLY_OPTIMAL;const Su={colorAttachments:[xu],depthStencilAttachment:new Gs},Tu={width:1,height:1,renderPassInfo:Su};let Eu=e("RenderTexture",(uu=Go("cc.RenderTexture"),_u=aa(),du=ca(),mu=aa(),pu=ca(),uu((vu=Po((gu=class extends sc{constructor(...e){super(...e),Oo(this,"_width",vu,this),Oo(this,"_height",yu,this),this._window=null}get width(){return this._width}get height(){return this._height}get window(){return this._window}initialize(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)}reset(e){this.initialize(e)}destroy(){if(this._window){i.director.root.destroyWindow(this._window),this._window=null}return super.destroy()}resize(e,t){this._width=e,this._height=t,this._window&&this._window.resize(e,t),this.emit("resize",this._window)}getGFXTexture(){return this._window&&this._window.framebuffer.colorTextures[0]}getGFXSampler(){const e=i.director.root;return xc.getSampler(e.device,fc)}onLoaded(){this._initWindow(),this.loaded=!0,this.emit("load")}_initWindow(e){const t=i.director.root;Tu.title=this._name,Tu.width=this._width,Tu.height=this._height,Tu.renderPassInfo=e&&e.passInfo?e.passInfo:Su,this._window?(this._window.destroy(),this._window.initialize(t.device,Tu)):this._window=t.createWindow(Tu)}}).prototype,"_width",[Xo,_u,du],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yu=Po(gu.prototype,"_height",[Xo,mu,pu],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),fu=gu))||fu));var Au,Cu,bu,Ru,wu,Iu,Ou,Pu,Mu;i.RenderTexture=Eu;let Du,Lu=e("Material",(Au=Go("cc.Material"),Cu=va(hu),Au((wu=Po((Ru=class e extends sc{static getHash(e){let t=0;for(const i of e.passes)t^=i.hash;return t}get effectAsset(){return this._effectAsset}get effectName(){return this._effectAsset?this._effectAsset.name:""}get technique(){return this._techIdx}get passes(){return this._passes}get hash(){return this._hash}get parent(){return null}get owner(){return null}constructor(){super(),Oo(this,"_effectAsset",wu,this),Oo(this,"_techIdx",Iu,this),Oo(this,"_defines",Ou,this),Oo(this,"_states",Pu,this),Oo(this,"_props",Mu,this),this._passes=[],this._hash=0,this.loaded=!1}initialize(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=hu.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}reset(e){this.initialize(e)}destroy(){return this._doDestroy(),super.destroy()}recompileShaders(e,t){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}overridePipelineStates(e,t){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}onLoaded(){this._update(),this.loaded=!0,this.emit("load")}resetUniforms(e=!0){this._props.length=this._passes.length;for(let e=0;e<this._props.length;e++)this._props[e]={};if(e)for(const e of this._passes)e.resetUBOs(),e.resetTextures()}setProperty(e,t,i){let n=!1;if(void 0===i){const i=this._passes,s=i.length;for(let r=0;r<s;r++){const s=i[r];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,n=!0)}}else{if(i>=this._passes.length)return void console.warn(`illegal pass index: ${i}.`);const s=this._passes[i];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,n=!0)}n||console.warn(`illegal property name: ${e}.`)}getProperty(e,t){if(void 0===t){const t=this._props,i=t.length;for(let n=0;n<i;n++){const i=t[n];if(e in i)return i[e]}}else{if(t>=this._props.length)return console.warn(`illegal pass index: ${t}.`),null;const i=this._props[this._passes[t].propertyIndex];if(e in i)return i[e]}return null}copy(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(let t=0;t<e._props.length;t++)this._props[t]=Object.assign({},e._props[t]);this._defines.length=e._defines.length;for(let t=0;t<e._defines.length;t++)this._defines[t]=Object.assign({},e._defines[t]);this._states.length=e._states.length;for(let t=0;t<e._states.length;t++)this._states[t]=Object.assign({},e._states[t]);this._effectAsset=e._effectAsset,this._update()}_prepareInfo(e,t){if(!Array.isArray(e)){const t=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(t).fill(e)}for(let i=0;i<e.length;++i)Object.assign(t[i]||(t[i]={}),e[i])}_createPasses(){const e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];const t=e.passes.length,n=[];for(let s=0;s<t;++s){const t=e.passes[s],r=t.passIndex=s,o=t.defines=this._defines[r]||(this._defines[r]={}),a=t.stateOverrides=this._states[r]||(this._states[r]={});if(void 0!==t.propertyIndex&&(Object.assign(o,this._defines[t.propertyIndex]),Object.assign(a,this._states[t.propertyIndex])),void 0!==t.embeddedMacros&&Object.assign(o,t.embeddedMacros),t.switch&&!o[t.switch])continue;const c=new Qh(i.director.root);c.initialize(t),n.push(c)}return n}_update(t=!0){if(this._effectAsset){if(this._passes&&this._passes.length)for(const e of this._passes)e.destroy();this._passes=this._createPasses();const e=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=e,t)this._passes.forEach((e,t)=>{let i=this._props[t];i||(i=this._props[t]={}),i=this._props[e.propertyIndex];for(const t in i)this._uploadProperty(e,t,i[t])});else for(let e=0;e<this._props.length;e++)this._props[e]={}}else{const e=Th.get("missing-effect-material");e&&(this._passes=e._passes.slice())}this._hash=e.getHash(this)}_uploadProperty(e,t,i){const n=e.getHandle(t);if(!n)return!1;const s=Qh.getPropertyTypeFromHandle(n);if(s===Ql.UBO)Array.isArray(i)?e.setUniformArray(n,i):null!==i?e.setUniform(n,i):e.resetUniform(t);else if(s===Ql.SAMPLER)if(Array.isArray(i))for(let t=0;t<i.length;t++)this._bindTexture(e,n,i[t],t);else i?this._bindTexture(e,n,i):e.resetTexture(t);return!0}_bindTexture(e,t,i,n){const s=Qh.getBindingFromHandle(t);if(i instanceof qs)e.bindTexture(s,i,n);else if(i instanceof Lc||i instanceof _h||i instanceof Eu){const t=i.getGFXTexture();if(!t||!t.width||!t.height)return!1;e.bindTexture(s,t,n),e.bindSampler(s,i.getGFXSampler(),n)}}_doDestroy(){if(this._passes&&this._passes.length)for(const e of this._passes)e.destroy();this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0}}).prototype,"_effectAsset",[Cu],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Iu=Po(Ru.prototype,"_techIdx",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ou=Po(Ru.prototype,"_defines",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pu=Po(Ru.prototype,"_states",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mu=Po(Ru.prototype,"_props",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bu=Ru))||bu));i.Material=Lu;class Bu extends Qh{get parent(){return this._parent}constructor(e,t){super(e.root),this._parent=void 0,this._owner=void 0,this._dontNotify=!1,this._parent=e,this._owner=t,this._doInit(this._parent,!0);for(let e=0;e<this._shaderInfo.blocks.length;e++){const t=this._shaderInfo.blocks[e];if(sl(t.set))continue;const i=this._blocks[t.binding],n=this._parent.blocks[t.binding];i.set(n)}this._rootBufferDirty=!0;const i=this._parent;for(let e=0;e<this._shaderInfo.samplers.length;e++){const t=this._shaderInfo.samplers[e];if(!sl(t.set))for(let e=0;e<t.count;e++){const n=i._descriptorSet.getSampler(t.binding,e),s=i._descriptorSet.getTexture(t.binding,e);this._descriptorSet.bindSampler(t.binding,n,e),this._descriptorSet.bindTexture(t.binding,s,e)}}super.tryCompile()}overridePipelineStates(e,t){Ph.free(Fh.get(this._handle,Nh.BLEND_STATE)),Ih.free(Fh.get(this._handle,Nh.RASTERIZER_STATE)),Oh.free(Fh.get(this._handle,Nh.DEPTH_STENCIL_STATE)),Fh.set(this._handle,Nh.BLEND_STATE,Ph.alloc()),Fh.set(this._handle,Nh.RASTERIZER_STATE,Ih.alloc()),Fh.set(this._handle,Nh.DEPTH_STENCIL_STATE,Oh.alloc()),Qh.fillPipelineInfo(this._handle,e),Qh.fillPipelineInfo(this._handle,t),this._onStateChange()}tryCompile(e){if(e&&!lh(this._defines,e))return!1;const t=super.tryCompile();return this._onStateChange(),t}beginChangeStatesSilently(){this._dontNotify=!0}endChangeStatesSilently(){this._dontNotify=!1}_syncBatchingScheme(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,Fh.set(this._handle,Nh.BATCHING_SCHEME,0)}_onStateChange(){Fh.set(this._handle,Nh.HASH,Qh.getPassHash(this._handle,this._hShaderDefault)),this._owner.onPassStateChange(this._dontNotify)}}class Nu extends Lu{get parent(){return this._parent}get owner(){return this._owner}constructor(e){super(),this._passes=[],this._parent=void 0,this._owner=void 0,this._subModelIdx=0,this._parent=e.parent,this._owner=e.owner||null,this._subModelIdx=e.subModelIdx||0,this.copy(this._parent)}recompileShaders(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(const t of this._passes)t.tryCompile(e);else this._passes[t].tryCompile(e)}overridePipelineStates(e,t){if(!this._passes||!this.effectAsset)return;const i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(let t=0;t<this._passes.length;t++){const n=this._passes[t],s=this._states[t]||(this._states[t]={});for(const t in e)s[t]=e[t];n.overridePipelineStates(i[n.passIndex],s)}else{const n=this._states[t]||(this._states[t]={});for(const t in e)n[t]=e[t];this._passes[t].overridePipelineStates(i[t],n)}}destroy(){return this._doDestroy(),!0}onPassStateChange(e){this._hash=Lu.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}_createPasses(){const e=[],t=this._parent.passes;if(!t)return e;for(let i=0;i<t.length;++i)e.push(new Bu(t[i],this));return e}}!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed"}(Du||(Du=e("SystemEventType",{}))),$e(Du),i.SystemEventType=Du;let Fu=new ci;class zu extends Fa{constructor(e,t,i){super(Fa.MOUSE,t),this.movementX=0,this.movementY=0,this.eventType=void 0,this._button=zu.BUTTON_MISSING,this._x=0,this._y=0,this._prevX=0,this._prevY=0,this._scrollX=0,this._scrollY=0,this.eventType=e,i&&(this._prevX=i.x,this._prevY=i.y)}setScrollData(e,t){this._scrollX=e,this._scrollY=t}getScrollX(){return this._scrollX}getScrollY(){return this._scrollY}setLocation(e,t){this._x=e,this._y=t}getLocation(e){return e||(e=new ci),ci.set(e,this._x,this._y),e}getLocationInView(e){return e||(e=new ci),ci.set(e,this._x,i.view._designResolutionSize.height-this._y),e}getUILocation(e){return e||(e=new ci),ci.set(e,this._x,this._y),i.view._convertPointWithScale(e),e}getPreviousLocation(e){return e||(e=new ci),ci.set(e,this._prevX,this._prevY),e}getUIPreviousLocation(e){return e||(e=new ci),ci.set(e,this._prevX,this._prevY),i.view._convertPointWithScale(e),e}getDelta(e){return e||(e=new ci),ci.set(e,this._x-this._prevX,this._y-this._prevY),e}getDeltaX(){return this._x-this._prevX}getDeltaY(){return this._y-this._prevY}getUIDelta(e){return e||(e=new ci),ci.set(e,(this._x-this._prevX)/i.view.getScaleX(),(this._y-this._prevY)/i.view.getScaleY()),e}getUIDeltaX(){return(this._x-this._prevX)/i.view.getScaleX()}getUIDeltaY(){return(this._y-this._prevY)/i.view.getScaleY()}setButton(e){this._button=e}getButton(){return this._button}getLocationX(){return this._x}getLocationY(){return this._y}getUILocationX(){const e=i.view.getViewportRect();return(this._x-e.x)/i.view.getScaleX()}getUILocationY(){const e=i.view.getViewportRect();return(this._y-e.y)/i.view.getScaleY()}}e("EventMouse",zu),zu.NONE=0,zu.DOWN=1,zu.UP=2,zu.MOVE=3,zu.SCROLL=4,zu.BUTTON_MISSING=-1,zu.BUTTON_LEFT=0,zu.BUTTON_RIGHT=2,zu.BUTTON_MIDDLE=1,zu.BUTTON_4=3,zu.BUTTON_5=4,zu.BUTTON_6=5,zu.BUTTON_7=6,zu.BUTTON_8=7;class Uu extends Fa{constructor(e,t,i,n){super(Fa.TOUCH,t),this.touch=null,this.simulate=!1,this._eventCode=void 0,this._touches=void 0,this._allTouches=void 0,this._eventCode=i||0,this._touches=e||[],this._allTouches=n||[]}getEventCode(){return this._eventCode}getTouches(){return this._touches}getAllTouches(){return this._allTouches}setLocation(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}getLocation(e){return this.touch?this.touch.getLocation(e):new ci}getUILocation(e){return this.touch?this.touch.getUILocation(e):new ci}getLocationInView(e){return this.touch?this.touch.getLocationInView(e):new ci}getPreviousLocation(e){return this.touch?this.touch.getPreviousLocation(e):new ci}getStartLocation(e){return this.touch?this.touch.getStartLocation(e):new ci}getUIStartLocation(e){return this.touch?this.touch.getUIStartLocation(e):new ci}getID(){return this.touch?this.touch.getID():null}getDelta(e){return this.touch?this.touch.getDelta(e):new ci}getUIDelta(e){return this.touch?this.touch.getUIDelta(e):new ci}getDeltaX(){return this.touch?this.touch.getDelta(Fu).x:0}getDeltaY(){return this.touch?this.touch.getDelta(Fu).y:0}getLocationX(){return this.touch?this.touch.getLocationX():0}getLocationY(){return this.touch?this.touch.getLocationY():0}}e("EventTouch",Uu),Uu.MAX_TOUCHES=5,Uu.BEGAN=0,Uu.MOVED=1,Uu.ENDED=2,Uu.CANCELLED=3;class Gu extends Fa{constructor(e,t){super(Fa.ACCELERATION,t),this.acc=void 0,this.acc=e}}e("EventAcceleration",Gu);class Hu extends Fa{constructor(e,t,i){super(Fa.KEYBOARD,i),this.keyCode=void 0,this.rawEvent=void 0,this.isPressed=void 0,"number"==typeof e?this.keyCode=e:(this.keyCode=e.keyCode,this.rawEvent=e),this.isPressed=t}}e("EventKeyboard",Hu),Fa.EventMouse=zu,Fa.EventTouch=Uu,Fa.EventAcceleration=Gu,Fa.EventKeyboard=Hu;class Vu{static create(e){E(e&&e.event,1900);const t=e.event;delete e.event;let n=null;if(t===i.EventListener.TOUCH_ONE_BY_ONE?n=new ju:t===i.EventListener.TOUCH_ALL_AT_ONCE?n=new qu:t===i.EventListener.MOUSE?n=new Wu:t===i.EventListener.KEYBOARD?n=new Yu:t===i.EventListener.ACCELERATION&&(n=new Xu(e.callback),delete e.callback),n)for(const t of Object.keys(e))n[t]=e[t];return n}get onEvent(){return this._onEvent}constructor(e,t,i){this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=e||0,this._listenerID=t||""}_setPaused(e){this._paused=e}_isPaused(){return this._paused}_setRegistered(e){this._registered=e}_isRegistered(){return this._registered}_getType(){return this._type}_getListenerID(){return this._listenerID}_setFixedPriority(e){this._fixedPriority=e}_getFixedPriority(){return this._fixedPriority}_setSceneGraphPriority(e){this._target=e,this._node=e}_getSceneGraphPriority(){return this._node}checkAvailable(){return null!==this._onEvent}clone(){return null}setEnabled(e){this._isEnabled=e}isEnabled(){return this._isEnabled}}Vu.UNKNOWN=0,Vu.TOUCH_ONE_BY_ONE=1,Vu.TOUCH_ALL_AT_ONCE=2,Vu.KEYBOARD=3,Vu.MOUSE=4,Vu.ACCELERATION=6,Vu.CUSTOM=8,Vu.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};const ku=Vu.ListenerID;class Wu extends Vu{constructor(){super(Vu.MOUSE,ku.MOUSE,null),this.onMouseDown=null,this.onMouseUp=null,this.onMouseMove=null,this.onMouseScroll=null,this._onEvent=e=>this._callback(e)}_callback(e){const t=i.Event.EventMouse;switch(e.eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}clone(){const e=new Wu;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}checkAvailable(){return!0}}class ju extends Vu{constructor(){super(Vu.TOUCH_ONE_BY_ONE,ku.TOUCH_ONE_BY_ONE,null),this.swallowTouches=!1,this.onTouchBegan=null,this.onTouchMoved=null,this.onTouchEnded=null,this.onTouchCancelled=null,this._claimedTouches=[]}setSwallowTouches(e){this.swallowTouches=e}isSwallowTouches(){return this.swallowTouches}clone(){const e=new ju;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}checkAvailable(){return!!this.onTouchBegan||(g(1801),!1)}}class qu extends Vu{constructor(){super(Vu.TOUCH_ALL_AT_ONCE,ku.TOUCH_ALL_AT_ONCE,null),this.onTouchesBegan=null,this.onTouchesMoved=null,this.onTouchesEnded=null,this.onTouchesCancelled=null}clone(){const e=new qu;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}checkAvailable(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(g(1802),!1)}}class Xu extends Vu{constructor(e){super(Vu.ACCELERATION,ku.ACCELERATION,null),this._onAccelerationEvent=null,this._onEvent=e=>this._callback(e),this._onAccelerationEvent=e}_callback(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}checkAvailable(){return E(this._onAccelerationEvent,1803),!0}clone(){return new Xu(this._onAccelerationEvent)}}class Yu extends Vu{constructor(){super(Vu.KEYBOARD,ku.KEYBOARD,null),this.onKeyPressed=null,this.onKeyReleased=null,this._onEvent=e=>this._callback(e)}_callback(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}clone(){const e=new Yu;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}checkAvailable(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(g(1800),!1)}}i.EventListener=Vu;const Ku=Vu.ListenerID;class Zu{constructor(){this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}size(){return this._fixedListeners.length+this._sceneGraphListeners.length}empty(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}push(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}clearSceneGraphListeners(){this._sceneGraphListeners.length=0}clearFixedListeners(){this._fixedListeners.length=0}clear(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}getFixedPriorityListeners(){return this._fixedListeners}getSceneGraphPriorityListeners(){return this._sceneGraphListeners}}const $u=e("eventManager",new class{constructor(){this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}pauseTarget(e,t=!1){if(!(e instanceof i._BaseNode))return void y(3506);const n=this._nodeListenersMap[e.uuid];if(n)for(let e=0;e<n.length;++e){n[e]._setPaused(!0)}if(!0===t){const t=e.children;if(t)for(let e=0;e<t.length;++e){const i=t[e];this.pauseTarget(i,!0)}}}resumeTarget(e,t=!1){if(!(e instanceof i._BaseNode))return void y(3506);const n=this._nodeListenersMap[e.uuid];if(n)for(let e=0;e<n.length;++e){n[e]._setPaused(!1)}if(this._setDirtyForNode(e),!0===t&&e.children.length>0){const t=e.children;if(t)for(let e=0;e<t.length;++e){const i=t[e];this.resumeTarget(i,!0)}}}frameUpdateListeners(){const e=this._listenersMap,t=this._priorityDirtyFlagMap;for(const i in e)e[i].empty()&&(delete t[i],delete e[i]);const i=this._toAddedListeners;if(0!==i.length){for(let e=0,t=i.length;e<t;e++)this._forceAddEventListener(i[e]);i.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}hasEventListener(e){return!!this._getListeners(e)}addListener(e,t){if(E(e&&t,3503),i.js.isNumber(t)||t instanceof i._BaseNode){if(e instanceof i.EventListener){if(e._isRegistered())return void g(3505)}else E(!i.js.isNumber(t),3504),e=i.EventListener.create(e);if(e.checkAvailable()){if(i.js.isNumber(t)){if(0===t)return void g(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!(n=t)||!n.getComponent("cc.UITransform"))return void g(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}var n;return e}}else y(3506)}addCustomListener(e,t){const n=Vu.create({event:i.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(n,1),n}removeListener(e){if(null==e)return;let t=!1;const n=this._listenersMap;for(const i in n){const s=n[i],r=s.getFixedPriorityListeners(),o=s.getSceneGraphPriorityListeners();if(t=this._removeListenerInVector(o,e),t?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(r,e),t&&this._setDirty(e._getListenerID(),1)),s.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete n[i]),t)break}if(!t){const t=this._toAddedListeners;for(let n=t.length-1;n>=0;n--){const s=t[n];if(s===e){i.js.array.removeAt(t,n),s._setRegistered(!1);break}}}}removeListeners(e,t=!1){if(i.js.isNumber(e)||e instanceof i._BaseNode)if(void 0!==e._id){const n=this._nodeListenersMap[e._id];if(n){const t=i.js.array.copy(n);for(let e=0;e<t.length;++e){const i=t[e];this.removeListener(i)}delete this._nodeListenersMap[e._id]}const s=this._toAddedListeners;for(let t=0;t<s.length;){const i=s[t];i._getSceneGraphPriority()===e?(i._setSceneGraphPriority(null),i._setRegistered(!1),s.splice(t,1)):++t}if(!0===t){const t=e.getChildren();for(let e=0;e<t.length;++e){const i=t[e];this.removeListeners(i,!0)}}}else e===i.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(Ku.TOUCH_ONE_BY_ONE):e===i.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(Ku.TOUCH_ALL_AT_ONCE):e===i.EventListener.MOUSE?this._removeListenersForListenerID(Ku.MOUSE):e===i.EventListener.ACCELERATION?this._removeListenersForListenerID(Ku.ACCELERATION):e===i.EventListener.KEYBOARD?this._removeListenersForListenerID(Ku.KEYBOARD):g(3501);else y(3506)}removeCustomListeners(e){this._removeListenersForListenerID(e)}removeAllListeners(){const e=this._listenersMap,t=this._internalCustomListenerIDs;for(const i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}setPriority(e,t){if(null==e)return;const i=this._listenersMap;for(const n in i){const s=i[n].getFixedPriorityListeners();if(s){if(-1!==s.indexOf(e))return null!=e._getSceneGraphPriority()&&g(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}}setEnabled(e){this._isEnabled=e}isEnabled(){return this._isEnabled}dispatchEvent(e){if(!this._isEnabled)return;if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,!e||!e.getType)return void S(3511);if(e.getType().startsWith(i.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;const t=function(e){const t=Fa,i=e.type;return i===t.ACCELERATION?Ku.ACCELERATION:i===t.KEYBOARD?Ku.KEYBOARD:i.startsWith(t.MOUSE)?Ku.MOUSE:(i.startsWith(t.TOUCH)&&g(2e3),"")}(e);this._sortEventListeners(t);const n=this._listenersMap[t];null!=n&&(this._dispatchEventToListeners(n,this._onListenerCallback,e),this._onUpdateListeners(n)),this._inDispatch--}_onListenerCallback(e,t){t.currentTarget=e._target;const i=e.onEvent;return i&&i(t),t.isStopped()}dispatchCustomEvent(e,t){const n=new i.Event.EventCustom(e);n.setUserData(t),this.dispatchEvent(n)}_setDirtyForNode(e){const t=this._nodeListenersMap[e._id];if(void 0!==t)for(let e=0,i=t.length;e<i;e++){const i=t[e]._getListenerID();null==this._dirtyListeners[i]&&(this._dirtyListeners[i]=!0)}if(e.children.length>0){const t=e.children;for(let e=0,i=t?t.length:0;e<i;e++)this._setDirtyForNode(t[e])}}_addListener(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}_forceAddEventListener(e){const t=e._getListenerID();let i=this._listenersMap[t];if(i||(i=new Zu,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);const i=e._getSceneGraphPriority();null===i&&g(3507),this._associateNodeAndEventListener(i,e),i.activeInHierarchy&&this.resumeTarget(i)}else this._setDirty(t,1)}_getListeners(e){return this._listenersMap[e]}_updateDirtyFlagForSceneGraph(){const e=this._dirtyListeners;for(const t in e)this._setDirty(t,2);this._dirtyListeners.length=0}_removeAllListenersInVector(e){if(!e)return;let t;for(let n=e.length-1;n>=0;n--)t=e[n],t._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&i.js.array.removeAt(e,n)}_removeListenersForListenerID(e){const t=this._listenersMap[e];if(t){const i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}const n=this._toAddedListeners;for(let t=n.length-1;t>=0;t--){const s=n[t];s&&s._getListenerID()===e&&i.js.array.removeAt(n,t)}}_sortEventListeners(e){let t=0;const n=this._priorityDirtyFlagMap;if(n[e]&&(t=n[e]),0!==t&&(n[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t)){i.director.getScene()&&this._sortListenersOfSceneGraphPriority(e)}}_sortListenersOfSceneGraphPriority(e){const t=this._getListeners(e);if(!t)return;const i=t.getSceneGraphPriorityListeners();i&&0!==i.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}_sortEventListenersOfSceneGraphPriorityDes(e,t){const i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(e&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return 1;let s=i,r=n,o=!1,a=i._uiProps.uiTransformComp,c=n._uiProps.uiTransformComp;if(a.visibility!==c.visibility)return c.visibility-a.visibility;for(;s.parent._id!==r.parent._id;)s=null===s.parent.parent?(o=!0)&&n:s.parent,r=null===r.parent.parent?(o=!0)&&i:r.parent;if(s._id===r._id){if(s._id===n._id)return-1;if(s._id===i._id)return 1}const l=s.getSiblingIndex(),h=r.getSiblingIndex();return o?l-h:h-l}_sortListenersOfFixedPriority(e){const t=this._listenersMap[e];if(!t)return;const i=t.getFixedPriorityListeners();if(!i||0===i.length)return;i.sort(this._sortListenersOfFixedPriorityAsc);let n=0;for(const e=i.length;n<e&&!(i[n]._getFixedPriority()>=0);)++n;t.gt0Index=n}_sortListenersOfFixedPriorityAsc(e,t){return e._getFixedPriority()-t._getFixedPriority()}_onUpdateListeners(e){const t=e.getFixedPriorityListeners(),n=e.getSceneGraphPriorityListeners(),s=this._toRemovedListeners;if(n)for(let e=n.length-1;e>=0;e--){const t=n[e];if(!t._isRegistered()){i.js.array.removeAt(n,e);const r=s.indexOf(t);-1!==r&&s.splice(r,1)}}if(t)for(let e=t.length-1;e>=0;e--){const n=t[e];if(!n._isRegistered()){i.js.array.removeAt(t,e);const r=s.indexOf(n);-1!==r&&s.splice(r,1)}}n&&0===n.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}_updateTouchListeners(e){const t=this._inDispatch;if(E(t>0,3508),t>1)return;let i;i=this._listenersMap[Ku.TOUCH_ONE_BY_ONE],i&&this._onUpdateListeners(i),i=this._listenersMap[Ku.TOUCH_ALL_AT_ONCE],i&&this._onUpdateListeners(i),E(1===t,3509);const n=this._toAddedListeners;if(0!==n.length){for(let e=0,t=n.length;e<t;e++)this._forceAddEventListener(n[e]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}_cleanToRemovedListeners(){const e=this._toRemovedListeners;for(let t=0;t<e.length;++t){const i=e[t],n=this._listenersMap[i._getListenerID()];if(!n)continue;const s=n.getFixedPriorityListeners(),r=n.getSceneGraphPriorityListeners();if(r){const e=r.indexOf(i);-1!==e&&r.splice(e,1)}if(s){const e=s.indexOf(i);-1!==e&&s.splice(e,1)}}e.length=0}_onTouchEventCallback(e,t){if(!e._isRegistered())return!1;const i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();let s=!1,r=-1;const o=i.getEventCode();if(o===Uu.BEGAN){if(!Bc.ENABLE_MULTI_TOUCH&&$u._currentTouch){const e=$u._currentTouchListener._node;if(!e||e.activeInHierarchy)return!1}e.onTouchBegan&&(s=e.onTouchBegan(n,i),s&&e._isRegistered()&&(e._claimedTouches.push(n),!Bc.ENABLE_MULTI_TOUCH&&$u._currentTouch||($u._currentTouch=n),$u._currentTouchListener=e))}else if(e._claimedTouches.length>0&&(r=e._claimedTouches.indexOf(n),-1!==r)){if(s=!0,!Bc.ENABLE_MULTI_TOUCH&&$u._currentTouch&&$u._currentTouch!==n)return!1;o===Uu.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):o===Uu.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(r,1),(Bc.ENABLE_MULTI_TOUCH||$u._currentTouch===n)&&($u._currentTouch=null),$u._currentTouchListener=null):o===Uu.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(r,1),(Bc.ENABLE_MULTI_TOUCH||$u._currentTouch===n)&&($u._currentTouch=null),$u._currentTouchListener=null)}return i.isStopped()?($u._updateTouchListeners(i),!0):!!(s&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)}_dispatchTouchEvent(e){this._sortEventListeners(Ku.TOUCH_ONE_BY_ONE),this._sortEventListeners(Ku.TOUCH_ALL_AT_ONCE);const t=this._getListeners(Ku.TOUCH_ONE_BY_ONE),n=this._getListeners(Ku.TOUCH_ALL_AT_ONCE);if(null===t&&null===n)return;const s=e.getTouches(),r=i.js.array.copy(s),o={event:e,needsMutableSet:t&&n,touches:r,selTouch:null};if(t)for(let i=0;i<s.length;++i){const n=s[i];e.touch=n,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,o)}n&&r.length>0&&(this._dispatchEventToListeners(n,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}_onTouchesEventCallback(e,t){if(!e._isRegistered())return!1;const i=t.event,n=t.touches,s=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),s===Uu.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):s===Uu.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):s===Uu.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):s===Uu.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&($u._updateTouchListeners(i),!0)}_associateNodeAndEventListener(e,t){let i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}_dissociateNodeAndEventListener(e,t){const n=this._nodeListenersMap[e.uuid];n&&(i.js.array.remove(n,t),0===n.length&&delete this._nodeListenersMap[e.uuid])}_dispatchEventToListeners(e,t,i){let n=!1;const s=e.getFixedPriorityListeners(),r=e.getSceneGraphPriorityListeners();let o=0;if(s&&0!==s.length)for(;o<e.gt0Index;++o){const e=s[o];if(e.isEnabled()&&!e._isPaused()&&e._isRegistered()&&t(e,i)){n=!0;break}}if(r&&!n)for(let e=0;e<r.length;++e){const s=r[e];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&t(s,i)){n=!0;break}}if(s&&!n)for(;o<s.length;++o){const e=s[o];if(e.isEnabled()&&!e._isPaused()&&e._isRegistered()&&t(e,i)){n=!0;break}}}_setDirty(e,t){const i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]}_sortNumberAsc(e,t){return e-t}_removeListenerInCallback(e,t){if(null==e)return!1;for(let n=e.length-1;n>=0;n--){const s=e[n];if(s._onCustomEvent===t||s.onEvent===t)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?i.js.array.removeAt(e,n):this._toRemovedListeners.push(s),!0}return!1}_removeListenerInVector(e,t){if(null==e)return!1;for(let n=e.length-1;n>=0;n--){const s=e[n];if(s===t)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?i.js.array.removeAt(e,n):this._toRemovedListeners.push(s),!0}return!1}});var Qu,Ju,e_;i.eventManager=$u;let t_=e("Script",Go("cc.Script")(Qu=class extends sc{})||Qu);i._Script=t_;let i_=e("JavaScript",Go("cc.JavaScript")(Ju=class extends t_{})||Ju);i._JavaScript=i_;let n_=e("TypeScript",Go("cc.TypeScript")(e_=class extends t_{})||e_);var s_,r_,o_,a_,c_,l_,h_,u_,__,d_;i._TypeScript=n_;const m_=new J("Comp"),p_=(Ua.Flags.IsOnEnableCalled,Ua.Flags.IsOnLoadCalled);let f_=e("Component",(s_=Go("cc.Component"),r_=sa(),o_=va(t_),a_=ra(),s_((d_=__=class extends Ua{constructor(...e){super(...e),Oo(this,"node",h_,this),Oo(this,"_enabled",u_,this),this._sceneGetter=null,this._id=m_.getNewId()}get name(){if(this._name)return this._name;let e=le(this);const t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node.name+"<"+e+">"}set name(e){this._name=e}get uuid(){return this._id}get __scriptAsset(){return null}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){const t=i.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}get enabledInHierarchy(){return this._enabled&&this.node&&this.node.activeInHierarchy}get _isOnLoadCalled(){return this._objFlags&p_}_getRenderScene(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}addComponent(e){return this.node.addComponent(e)}getComponent(e){return this.node.getComponent(e)}getComponents(e){return this.node.getComponents(e)}getComponentInChildren(e){return this.node.getComponentInChildren(e)}getComponentsInChildren(e){return this.node.getComponentsInChildren(e)}destroy(){return!!super.destroy()&&(this._enabled&&this.node.activeInHierarchy&&i.director._compScheduler.disableComp(this),!0)}_onPreDestroy(){this.unscheduleAllCallbacks(),i.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}_instantiate(e){return e||(e=i.instantiate._clone(this,this)),e.node=null,e}schedule(e,t=0,n=i.macro.REPEAT_FOREVER,s=0){E(e,1619),E(t>=0,1620),t=t||0,n=isNaN(n)?i.macro.REPEAT_FOREVER:n,s=s||0;const r=i.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(e,this,t,n,s,o)}scheduleOnce(e,t=0){this.schedule(e,0,0,t)}unschedule(e){e&&i.director.getScheduler().unschedule(e,this)}unscheduleAllCallbacks(){i.director.getScheduler().unscheduleAllForTarget(this)}},__.system=null,Po((l_=d_).prototype,"__scriptAsset",[r_,o_,a_],Object.getOwnPropertyDescriptor(l_.prototype,"__scriptAsset"),l_.prototype),h_=Po(l_.prototype,"node",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),u_=Po(l_.prototype,"_enabled",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),c_=l_))||c_));const g_=f_.prototype;g_.update=null,g_.lateUpdate=null,g_.__preload=null,g_.onLoad=null,g_.start=null,g_.onEnable=null,g_.onDisable=null,g_.onDestroy=null,g_.onFocusInEditor=null,g_.onLostFocusInEditor=null,g_.resetInEditor=null,g_._getLocalBounds=null,g_.onRestore=null,f_._requireComponent=null,f_._executionOrder=0,se(f_,"_registerEditorProps",(function(e,t){const i=t.requireComponent;i&&(e._requireComponent=i);const n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)})),i.Component=f_;Ua.Flags.Destroying;const v_=new Array(16);let y_=null,x_=new ci;const S_=[Du.TOUCH_START.toString(),Du.TOUCH_MOVE.toString(),Du.TOUCH_END.toString(),Du.TOUCH_CANCEL.toString()],T_=[Du.MOUSE_DOWN.toString(),Du.MOUSE_ENTER.toString(),Du.MOUSE_MOVE.toString(),Du.MOUSE_LEAVE.toString(),Du.MOUSE_UP.toString(),Du.MOUSE_WHEEL.toString()];function E_(e,t){const i=this.owner;return!(!i||!i._uiProps.uiTransformComp)&&(e.getUILocation(x_),!!i._uiProps.uiTransformComp.isHit(x_,this)&&(t.type=Du.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),!0))}function A_(e,t){const i=this.owner;if(!i||!i._uiProps.uiTransformComp)return!1;t.type=Du.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function C_(e,t){const i=this.owner;i&&i._uiProps.uiTransformComp&&(e.getUILocation(x_),i._uiProps.uiTransformComp.isHit(x_,this)?t.type=Du.TOUCH_END.toString():t.type=Du.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function b_(e,t){const i=this.owner;i&&i._uiProps.uiTransformComp&&(t.type=Du.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function R_(e){const t=this.owner;t&&t._uiProps.uiTransformComp&&(x_=e.getUILocation(),t._uiProps.uiTransformComp.isHit(x_,this)&&(e.type=Du.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function w_(e){const t=this.owner;if(!t||!t._uiProps.uiTransformComp)return;x_=e.getUILocation();if(t._uiProps.uiTransformComp.isHit(x_,this))this._previousIn||(y_&&y_.eventProcessor.mouseListener&&(e.type=Du.MOUSE_LEAVE,y_.dispatchEvent(e),y_.eventProcessor.mouseListener&&(y_.eventProcessor.mouseListener._previousIn=!1)),y_=t,e.type=Du.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=Du.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=Du.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,y_=null}e.propagationStopped=!0}function I_(e){const t=this.owner;t&&t._uiProps.uiTransformComp&&(x_=e.getUILocation(),t._uiProps.uiTransformComp.isHit(x_,this)&&(e.type=Du.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function O_(e){const t=this.owner;t&&t._uiProps.uiTransformComp&&(x_=e.getUILocation(),t._uiProps.uiTransformComp.isHit(x_,this)&&(e.type=Du.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function P_(e){const t=i.Mask;if(t){let n=0;for(let s=e;s&&i.Node.isNode(s);s=s.parent,++n)if(s.getComponent(t))return{index:n,node:s}}return null}function M_(e,t){if(!e._persistNode){if(e.eventProcessor.bubblingTargets)for(let i=0;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(let i=0;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}return!0}class D_{get node(){return this._node}constructor(e){this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}reattach(){if(this.touchListener){const e=this.touchListener.mask=P_(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=P_(this._node))}destroy(){y_===this._node&&(y_=null),(this.touchListener||this.mouseListener)&&($u.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()}on(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new Ya),this.bubblingTargets.on(e,t,i))}once(e,t,i,n){let s;s=this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new Ya:this.bubblingTargets=this.bubblingTargets||new Ya,s.on(e,t,i,!0),s.on(e,()=>{this.off(e,t,i)},void 0,!0)}off(e,t,i,n){const s=-1!==S_.indexOf(e),r=!s&&-1!==T_.indexOf(e);s||r?(this._offDispatch(e,t,i,n),s?this.touchListener&&!M_(this._node,S_)&&($u.removeListener(this.touchListener),this.touchListener=null):r&&this.mouseListener&&!M_(this._node,T_)&&($u.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}emit(e,t,i,n,s,r){this.bubblingTargets&&this.bubblingTargets.emit(e,t,i,n,s,r)}dispatchEvent(e){!function(e,t){let i,n=0;for(t.target=e,v_.length=0,e.eventProcessor.getCapturingTargets(t.type,v_),t.eventPhase=1,n=v_.length-1;n>=0;--n)if(i=v_[n],i.eventProcessor.capturingTargets&&(t.currentTarget=i,i.eventProcessor.capturingTargets.emit(t.type,t,v_),t.propagationStopped))return void(v_.length=0);if(v_.length=0,t.eventPhase=2,t.currentTarget=e,e.eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,v_),t.eventPhase=3,n=0;n<v_.length;++n)if(i=v_[n],i.eventProcessor.bubblingTargets&&(t.currentTarget=i,i.eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(v_.length=0);v_.length=0}(this._node,e),v_.length=0}hasEventListener(e,t,i){let n=!1;return this.bubblingTargets&&(n=this.bubblingTargets.hasEventListener(e,t,i)),!n&&this.capturingTargets&&(n=this.capturingTargets.hasEventListener(e,t,i)),n}targetOff(e){this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e),this.touchListener&&!M_(this.node,S_)&&($u.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!M_(this.node,T_)&&($u.removeListener(this.mouseListener),this.mouseListener=null)}getCapturingTargets(e,t){let i=this._node.parent;for(;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}getBubblingTargets(e,t){let i=this._node.parent;for(;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}_checknSetupSysEvent(e){let t=!1,n=!1;return-1!==S_.indexOf(e)?(this.touchListener||(this.touchListener=i.EventListener.create({event:i.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:P_(this._node),onTouchBegan:E_,onTouchMoved:A_,onTouchEnded:C_,onTouchCancelled:b_}),$u.addListener(this.touchListener,this._node),t=!0),n=!0):-1!==T_.indexOf(e)&&(this.mouseListener||(this.mouseListener=i.EventListener.create({event:i.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:P_(this._node),onMouseDown:R_,onMouseMove:w_,onMouseUp:I_,onMouseScroll:O_}),$u.addListener(this.mouseListener,this._node),t=!0),n=!0),t&&!this._node.activeInHierarchy&&i.director.getScheduler().schedule(()=>{this._node.activeInHierarchy||$u.pauseTarget(this._node)},this._node,0,0,0,!1),n}_onDispatch(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,!t)return void S(6800);let s=null;return s=n?this.capturingTargets=this.capturingTargets||new Ya:this.bubblingTargets=this.bubblingTargets||new Ya,s.hasEventListener(e,t,i)||s.on(e,t,i),t}_offDispatch(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){const s=n?this.capturingTargets:this.bubblingTargets;s&&s.off(e,t,i)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}var L_,B_,N_,F_,z_,U_,G_,H_,V_;i.NodeEventProcessor=D_;const k_=Ua.Flags.Destroying,W_=Ua.Flags.DontDestroy,j_=Ua.Flags.Deactivating,q_=(Ua.Flags.Activating,new J("Node"));function X_(e){return e?"string"==typeof e?Pe(e):e:(S(3804),null)}let Y_,K_,Z_=e("BaseNode",Go("cc.BaseNode")((V_=H_=class e extends Ua{get components(){return this._components}get _persistNode(){return(this._objFlags&W_)>0}set _persistNode(e){e?this._objFlags|=W_:this._objFlags&=~W_}get name(){return this._name}set name(e){this._name=e}get uuid(){return this._id}get children(){return this._children}get active(){return this._active}set active(e){if(this._active!==e){this._active=e;const t=this._parent;if(t){t._activeInHierarchy&&i.director._nodeActivator.activateNode(this,e)}}}get activeInHierarchy(){return this._activeInHierarchy}get parent(){return this._parent}set parent(e){this.setParent(e)}get scene(){return this._scene}get eventProcessor(){return this._eventProcessor}static _setScene(e){e instanceof i.Scene?e._scene=e:null==e._parent?u("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}static _findComponent(e,t){const i=t,n=e._components;if(i._sealed)for(let e=0;e<n.length;++e){const i=n[e];if(i.constructor===t)return i}else for(let e=0;e<n.length;++e){const i=n[e];if(i instanceof t)return i}return null}static _findComponents(e,t,i){const n=t,s=e._components;if(n._sealed)for(let e=0;e<s.length;++e){const n=s[e];n.constructor===t&&i.push(n)}else for(let e=0;e<s.length;++e){const n=s[e];n instanceof t&&i.push(n)}}static _findChildComponent(t,i){for(let n=0;n<t.length;++n){const s=t[n];let r=e._findComponent(s,i);if(r)return r;if(s._children.length>0&&(r=e._findChildComponent(s._children,i),r))return r}return null}static _findChildComponents(t,i,n){for(let s=0;s<t.length;++s){const r=t[s];e._findComponents(r,i,n),r._children.length>0&&e._findChildComponents(r._children,i,n)}}constructor(e){super(e),Oo(this,"_parent",N_,this),Oo(this,"_children",F_,this),Oo(this,"_active",z_,this),Oo(this,"_components",U_,this),Oo(this,"_prefab",G_,this),this._scene=null,this._activeInHierarchy=!1,this._id=q_.getNewId(),this._name=void 0,this._eventProcessor=new D_(this),this._eventMask=0,this._siblingIndex=0,this._registerIfAttached=void 0,this._name=void 0!==e?e:"New Node"}attr(e){ye(this,e)}getParent(){return this._parent}setParent(e,t=!1){if(this._parent===e)return;const i=this._parent,n=e;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,t),this.emit&&this.emit(Du.PARENT_CHANGED,i),i&&!(i._objFlags&k_)){const e=i._children.indexOf(this);i._children.splice(e,1),i._updateSiblingIndex(),i.emit&&i.emit(Du.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(Du.CHILD_ADDED,this)),this._onHierarchyChanged(i)}getChildByUuid(e){if(!e)return l("Invalid uuid"),null;const t=this._children;for(let i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}getChildByName(e){if(!e)return l("Invalid name"),null;const t=this._children;for(let i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}getChildByPath(e){const t=e.split("/");let i=this;for(let e=0;e<t.length;++e){const n=t[e];if(0===n.length)continue;const s=i.children.find(e=>e.name===n);if(!s)return null;i=s}return i}addChild(e){E(e,1606),E(null===e._parent,1605),e.setParent(this)}insertChild(e,t){e.parent=this,e.setSiblingIndex(t)}getSiblingIndex(){return this._siblingIndex}setSiblingIndex(e){if(!this._parent)return;if(this._parent._objFlags&j_)return void S(3821);const t=this._parent._children;e=-1!==e?e:t.length-1;const i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}walk(t,i){let n=1,s=null,r=null,o=0,a=e._stacks[e._stackId];a||(a=[],e._stacks.push(a)),e._stackId++,a.length=0,a[0]=this;let c=null,l=!1;for(;n;)if(n--,r=a[n],r)if(!l&&t?t(r):l&&i&&i(r),a[n]=null,l){if(l=!1,s)if(o++,s[o])a[n]=s[o],n++;else if(c&&(a[n]=c,n++,l=!0,c._parent?(s=c._parent._children,o=s.indexOf(c),c=c._parent):(c=null,s=null),o<0))break}else r._children.length>0?(c=r,s=r._children,o=0,a[n]=s[o],n++):(a[n]=r,n++,l=!0);a.length=0,e._stackId--}removeFromParent(){this._parent&&this._parent.removeChild(this)}removeChild(e){this._children.indexOf(e)>-1&&(e.parent=null)}removeAllChildren(){const e=this._children;for(let t=e.length-1;t>=0;t--){const i=e[t];i&&(i.parent=null)}this._children.length=0}isChildOf(e){let t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}getComponent(t){const i=X_(t);return i?e._findComponent(this,i):null}getComponents(t){const i=X_(t),n=[];return i&&e._findComponents(this,i,n),n}getComponentInChildren(t){const i=X_(t);return i?e._findChildComponent(this._children,i):null}getComponentsInChildren(t){const i=X_(t),n=[];return i&&(e._findComponents(this,i,n),e._findChildComponents(this._children,i,n)),n}addComponent(e){let t;if("string"==typeof e){if(t=Pe(e),!t)throw i._RF.peek()&&S(3808,e),TypeError(C(3807,e))}else{if(!e)throw TypeError(C(3804));t=e}if("function"!=typeof t)throw TypeError(C(3809));if(!Te(t,i.Component))throw TypeError(C(3810));const n=t._requireComponent;n&&!this.getComponent(n)&&this.addComponent(n);const s=new t;return s.node=this,this._components.push(s),this._activeInHierarchy&&i.director._nodeActivator.activateComp(s),s}removeComponent(e){if(!e)return void S(3813);let t=null;t=e instanceof f_?e:this.getComponent(e),t&&t.destroy()}on(e,t,i,n=!1){switch(e){case Du.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}off(e,t,i,n=!1){this._eventProcessor.off(e,t,i,n);if(!this._eventProcessor.hasEventListener(e))switch(e){case Du.TRANSFORM_CHANGED:this._eventMask&=-2}}once(e,t,i,n){this._eventProcessor.once(e,t,i,n)}emit(e,t,i,n,s,r){this._eventProcessor.emit(e,t,i,n,s,r)}dispatchEvent(e){this._eventProcessor.dispatchEvent(e)}hasEventListener(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)}targetOff(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(Du.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}destroy(){return!!super.destroy()&&(this._activeInHierarchy&&this._disableChildComps(),!0)}destroyAllChildren(){const e=this._children;for(let t=0;t<e.length;++t)e[t].destroy()}_removeComponent(e){if(e){if(!(this._objFlags&k_)){const t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&S(3815)}}else S(3814)}_updateSiblingIndex(){for(let e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}_onSetParent(t,i=!1){this._parent&&(null!=t&&t._scene===this._parent._scene||null==this._parent._scene||this.walk(t=>{e._setScene(t)}))}_onPostActivated(e){}_onBatchRestored(){}_onBatchCreated(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}_onPreDestroy(){this._onPreDestroyBase()}_onHierarchyChanged(e){return this._onHierarchyChangedBase(e)}_instantiate(e){e||(e=i.instantiate._clone(this,this));const t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}_onHierarchyChangedBase(e){const t=this._parent;!this._persistNode||t instanceof i.Scene||i.game.removePersistRootNode(this);const n=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==n&&i.director._nodeActivator.activateNode(this,n)}_onPreDestroyBase(){this._objFlags|=k_;const e=this._parent,t=!!e&&0!=(e._objFlags&k_);if(this._persistNode&&i.game.removePersistRootNode(this),!t&&e){this.emit(Du.PARENT_CHANGED,this);const t=e._children.indexOf(this);e._children.splice(t,1),this._siblingIndex=0,e.emit&&e.emit(Du.CHILD_REMOVED,this)}this.emit(Du.NODE_DESTROYED,this),this._eventProcessor.destroy();const n=this._children;for(let e=0;e<n.length;++e)n[e]._destroyImmediate();const s=this._components;for(let e=0;e<s.length;++e)s[e]._destroyImmediate();return t}_disableChildComps(){const e=this._components;for(let t=0;t<e.length;++t){const n=e[t];n._enabled&&i.director._compScheduler.disableComp(n)}const t=this._children;for(let e=0;e<t.length;++e){const i=t[e];i._active&&i._disableChildComps()}}},H_.idGenerator=q_,H_._stacks=[[]],H_._stackId=0,Po((B_=V_).prototype,"_persistNode",[qo],Object.getOwnPropertyDescriptor(B_.prototype,"_persistNode"),B_.prototype),Po(B_.prototype,"name",[ia],Object.getOwnPropertyDescriptor(B_.prototype,"name"),B_.prototype),Po(B_.prototype,"children",[ia],Object.getOwnPropertyDescriptor(B_.prototype,"children"),B_.prototype),Po(B_.prototype,"active",[ia],Object.getOwnPropertyDescriptor(B_.prototype,"active"),B_.prototype),Po(B_.prototype,"activeInHierarchy",[ia],Object.getOwnPropertyDescriptor(B_.prototype,"activeInHierarchy"),B_.prototype),Po(B_.prototype,"parent",[ia],Object.getOwnPropertyDescriptor(B_.prototype,"parent"),B_.prototype),N_=Po(B_.prototype,"_parent",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F_=Po(B_.prototype,"_children",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),z_=Po(B_.prototype,"_active",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),U_=Po(B_.prototype,"_components",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),G_=Po(B_.prototype,"_prefab",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L_=B_))||L_);var $_,Q_,J_,ed,td,id,nd,sd,rd,od,ad,cd,ld,hd,ud,_d;i._BaseNode=Z_,function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(Y_||(Y_={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(K_||(K_={})),i.internal.TransformBit=K_;const dd=new ci,md=new ci,pd=new wi,fd=new wi,gd=new wi,vd=new wi(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),yd=new Bi;let xd=($_=Go("cc.UITransform"),Q_=ta(),J_=Vo(110),ed=$o(),td=ua(),id=ra(),nd=ua(),sd=ra(),rd=ra(),Sd=$_(od=Q_(od=J_(od=ed(od=Zo((_d=ud=class e extends f_{constructor(...e){super(...e),Oo(this,"_priority",cd,this),this._canvas=null,Oo(this,"_contentSize",ld,this),Oo(this,"_anchorPoint",hd,this)}get contentSize(){return this._contentSize}set contentSize(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(Du.SIZE_CHANGED))}get width(){return this._contentSize.width}set width(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(Du.SIZE_CHANGED))}get height(){return this._contentSize.height}set height(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(Du.SIZE_CHANGED))}get anchorPoint(){return this._anchorPoint}set anchorPoint(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(Du.ANCHOR_CHANGED,this._anchorPoint))}get anchorX(){return this._anchorPoint.x}set anchorX(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(Du.ANCHOR_CHANGED,this._anchorPoint))}get anchorY(){return this._anchorPoint.y}set anchorY(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(Du.ANCHOR_CHANGED,this._anchorPoint))}get priority(){return this._priority}set priority(e){this._priority!==e&&(this._canvas&&this._canvas.node===this.node?y(9200):(this._priority=e,this._sortSiblings()))}get visibility(){return this._canvas?this._canvas.visibility:-1}__preload(){this.node._uiProps.uiTransformComp=this}onEnable(){this._updateVisibility(),this.node.on(Du.PARENT_CHANGED,this._parentChanged,this),this._sortSiblings()}onDisable(){this.node.off(Du.PARENT_CHANGED,this._parentChanged,this),this._canvas=null}onDestroy(){this.node._uiProps.uiTransformComp=null}setContentSize(e,t){const i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;i.width=e,i.height=t}this.node.emit(Du.SIZE_CHANGED)}setAnchorPoint(e,t){const i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(Du.ANCHOR_CHANGED,this._anchorPoint)}isHit(e,t){const n=this._contentSize.width,s=this._contentSize.height,r=dd,o=md,a=this._canvas;if(!a)return;a.node.getWorldRT(pd);const c=pd.m12,l=pd.m13,h=i.visibleRect.center;if(pd.m12=h.x-(pd.m00*c+pd.m04*l),pd.m13=h.y-(pd.m01*c+pd.m05*l),wi.invert(pd,pd),ci.transformMat4(r,e,pd),this.node.getWorldMatrix(gd),wi.invert(pd,gd),wi.strictEquals(pd,vd))return!1;if(ci.transformMat4(o,r,pd),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*s,o.x>=0&&o.y>=0&&o.x<=n&&o.y<=s){if(t&&t.mask){const e=t.mask;let n=this.node;for(let t=0;n&&t<e.index;++t,n=n.parent);if(n===e.node){const e=n.getComponent(i.Mask);return!e||!e.enabledInHierarchy||e.isHit(r)}return t.mask=null,!0}return!0}return!1}convertToNodeSpaceAR(e,t){return this.node.getWorldMatrix(gd),wi.invert(pd,gd),t||(t=new _i),_i.transformMat4(t,e,pd)}convertToWorldSpaceAR(e,t){return this.node.getWorldMatrix(gd),t||(t=new _i),_i.transformMat4(t,e,gd)}getBoundingBox(){wi.fromRTS(fd,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const e=this._contentSize.width,t=this._contentSize.height,i=new Bi(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(fd),i}getBoundingBoxToWorld(){return this.node.parent?(this.node.parent.getWorldMatrix(gd),this.getBoundingBoxTo(gd)):this.getBoundingBox()}getBoundingBoxTo(t){wi.fromRTS(fd,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const i=this._contentSize.width,n=this._contentSize.height,s=new Bi(-this._anchorPoint.x*i,-this._anchorPoint.y*n,i,n);if(wi.multiply(gd,t,fd),s.transformMat4(gd),!this.node.children)return s;const r=this.node.children;for(const i of r)if(i&&i.active){const n=i.getComponent(e);if(n){const e=n.getBoundingBoxTo(t);e&&Bi.union(s,s,e)}}return s}getComputeAABB(e){const t=this._contentSize.width,i=this._contentSize.height;yd.set(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i),yd.transformMat4(this.node.worldMatrix);const n=yd.x+.5*yd.width,s=yd.y+.5*yd.height,r=this.node.worldPosition.z,o=yd.width/2,a=yd.height/2;if(null==e)return new $r(n,s,r,o,a,.001);$r.set(e,n,s,r,o,a,.001)}_updateVisibility(){let e=this.node;for(;e;){if(e){const t=e.getComponent("cc.Canvas");if(t){this._canvas=t;break}}e=e.parent}}_parentChanged(e){this._canvas&&this._canvas.node===this.node||this._sortSiblings()}_sortSiblings(){const e=this.node.parent&&this.node.parent.children;e&&(e.sort((e,t)=>{const i=e._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp,s=(i?i.priority:0)-(n?n.priority:0);return 0===s?e.getSiblingIndex()-t.getSiblingIndex():s}),this.node.parent._updateSiblingIndex())}},ud.EventType=Du,Po((ad=_d).prototype,"contentSize",[td,id],Object.getOwnPropertyDescriptor(ad.prototype,"contentSize"),ad.prototype),Po(ad.prototype,"anchorPoint",[nd,sd],Object.getOwnPropertyDescriptor(ad.prototype,"anchorPoint"),ad.prototype),Po(ad.prototype,"priority",[rd],Object.getOwnPropertyDescriptor(ad.prototype,"priority"),ad.prototype),cd=Po(ad.prototype,"_priority",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ld=Po(ad.prototype,"_contentSize",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(100,100)}}),hd=Po(ad.prototype,"_anchorPoint",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ci(.5,.5)}}),od=ad))||od)||od)||od)||od)||od,e({UITransform:Sd,UITransformComponent:Sd}),Sd);var Sd,Td,Ed,Ad,Cd,bd,Rd,wd,Id,Od,Pd,Md;class Dd{get uiTransformComp(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent(xd)),this._uiTransformComp}set uiTransformComp(e){this._uiTransformComp=e}constructor(e){this.uiComp=null,this.opacity=1,this._uiTransformComp=null,this._node=void 0,this._node=e}}const Ld=new _i,Bd=new Si,Nd=new Si,Fd=new Array(10),zd=new Si,Ud=new vi,Gd=new vi,Hd=new wi,Vd=new Map;let kd=e("Node",(Td=Go("cc.Node"),Ed=va(_i),Td((Md=Pd=class e extends Z_{constructor(...e){super(...e),this._uiProps=new Dd(this),this._static=!1,this._pos=new _i,this._rot=new Si,this._scale=new _i(1,1,1),this._mat=new wi,Oo(this,"_lpos",bd,this),Oo(this,"_lrot",Rd,this),Oo(this,"_lscale",wd,this),Oo(this,"_layer",Id,this),Oo(this,"_euler",Od,this),this._dirtyFlags=K_.NONE,this._eulerDirty=!1}static isNode(t){return t instanceof e&&(t.constructor===e||!(t instanceof i.Scene))}get position(){return this._lpos}set position(e){this.setPosition(e)}get worldPosition(){return this.updateWorldTransform(),this._pos}set worldPosition(e){this.setWorldPosition(e)}get rotation(){return this._lrot}set rotation(e){this.setRotation(e)}set eulerAngles(e){this.setRotationFromEuler(e.x,e.y,e.z)}get eulerAngles(){return this._eulerDirty&&(Si.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}get worldRotation(){return this.updateWorldTransform(),this._rot}set worldRotation(e){this.setWorldRotation(e)}get scale(){return this._lscale}set scale(e){this.setScale(e)}get worldScale(){return this.updateWorldTransform(),this._scale}set worldScale(e){this.setWorldScale(e)}set matrix(e){wi.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(K_.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.TRS)}get worldMatrix(){return this.updateWorldTransform(),this._mat}get forward(){return _i.transformQuat(new _i,_i.FORWARD,this.worldRotation)}set forward(e){const t=e.length();_i.multiplyScalar(Ld,e,-1/t),Si.fromViewUp(Bd,Ld),this.setWorldRotation(Bd)}set layer(e){this._layer=e}get layer(){return this._layer}get hasChangedFlags(){return Vd.get(this._id)||0}set hasChangedFlags(e){Vd.set(this._id,e)}setParent(e,t=!1){t&&this.updateWorldTransform(),super.setParent(e,t)}_onSetParent(e,t){if(super._onSetParent(e,t),t){const e=this._parent;e?(e.updateWorldTransform(),wi.multiply(Hd,wi.invert(Hd,e._mat),this._mat),wi.toRTS(Hd,this._lrot,this._lpos,this._lscale)):(_i.copy(this._lpos,this._pos),Si.copy(this._lrot,this._rot),_i.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(K_.TRS)}_onBatchCreated(){super._onBatchCreated(),Vd.set(this._id,K_.TRS),this._dirtyFlags=K_.TRS;const e=this._children.length;for(let t=0;t<e;++t)this._children[t]._onBatchCreated()}_onBatchRestored(){this._onBatchCreated()}_onBeforeSerialize(){this.eulerAngles}_onPostActivated(e){e?($u.resumeTarget(this),this.eventProcessor.reattach(),this.invalidateChildren(K_.TRS)):$u.pauseTarget(this)}translate(e,t){const i=t||Y_.LOCAL;if(i===Y_.LOCAL)_i.transformQuat(Ld,e,this._lrot),this._lpos.x+=Ld.x,this._lpos.y+=Ld.y,this._lpos.z+=Ld.z;else if(i===Y_.WORLD)if(this._parent){Si.invert(Bd,this._parent.worldRotation),_i.transformQuat(Ld,e,Bd);const t=this.worldScale;this._lpos.x+=Ld.x/t.x,this._lpos.y+=Ld.y/t.y,this._lpos.z+=Ld.z/t.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(K_.POSITION),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.POSITION)}rotate(e,t){const i=t||Y_.LOCAL;if(Si.normalize(Bd,e),i===Y_.LOCAL)Si.multiply(this._lrot,this._lrot,Bd);else if(i===Y_.WORLD){const e=this.worldRotation;Si.multiply(Nd,Bd,e),Si.invert(Bd,e),Si.multiply(Nd,Bd,Nd),Si.multiply(this._lrot,this._lrot,Nd)}this._eulerDirty=!0,this.invalidateChildren(K_.ROTATION),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.ROTATION)}lookAt(e,t){this.getWorldPosition(Ld),_i.subtract(Ld,Ld,e),_i.normalize(Ld,Ld),Si.fromViewUp(Bd,Ld,t),this.setWorldRotation(Bd)}invalidateChildren(e){if((this._dirtyFlags&this.hasChangedFlags&e)===e)return;this._dirtyFlags|=e,Vd.set(this._id,this.hasChangedFlags|e),e|=K_.POSITION;const t=this._children.length;for(let i=0;i<t;++i){const t=this._children[i];t.isValid&&t.invalidateChildren(e)}}updateWorldTransform(){if(!this._dirtyFlags)return;let e,t=this,i=0;for(;t&&t._dirtyFlags;)Fd[i++]=t,t=t._parent;let n=0;for(;i;)e=Fd[--i],n|=e._dirtyFlags,t?(n&K_.POSITION&&(_i.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&K_.RS&&(wi.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),wi.multiply(e._mat,t._mat,e._mat),n&K_.ROTATION&&Si.multiply(e._rot,t._rot,e._lrot),vi.fromQuat(Ud,Si.conjugate(zd,e._rot)),vi.multiplyMat4(Ud,Ud,e._mat),e._scale.x=Ud.m00,e._scale.y=Ud.m04,e._scale.z=Ud.m08)):(n&K_.POSITION&&(_i.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&K_.RS&&(n&K_.ROTATION&&Si.copy(e._rot,e._lrot),n&K_.SCALE&&_i.copy(e._scale,e._lscale),wi.fromRTS(e._mat,e._rot,e._pos,e._scale))),e._dirtyFlags=K_.NONE,t=e}setPosition(e,t,i){void 0===t||void 0===i?_i.copy(this._lpos,e):_i.set(this._lpos,e,t,i),this.invalidateChildren(K_.POSITION),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.POSITION)}getPosition(e){return e?_i.set(e,this._lpos.x,this._lpos.y,this._lpos.z):_i.copy(new _i,this._lpos)}setRotation(e,t,i,n){void 0===t||void 0===i||void 0===n?Si.copy(this._lrot,e):Si.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(K_.ROTATION),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.ROTATION)}setRotationFromEuler(e,t,i){_i.set(this._euler,e,t,i),Si.fromEuler(this._lrot,e,t,i),this._eulerDirty=!1,this.invalidateChildren(K_.ROTATION),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.ROTATION)}getRotation(e){return e?Si.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Si.copy(new Si,this._lrot)}setScale(e,t,i){void 0===t||void 0===i?_i.copy(this._lscale,e):_i.set(this._lscale,e,t,i),this.invalidateChildren(K_.SCALE),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.SCALE)}getScale(e){return e?_i.set(e,this._lscale.x,this._lscale.y,this._lscale.z):_i.copy(new _i,this._lscale)}inverseTransformPoint(e,t){_i.copy(e,t);let i=this,n=0;for(;i._parent;)Fd[n++]=i,i=i._parent;for(;n>=0;)_i.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=Fd[--n];return e}setWorldPosition(e,t,i){void 0===t||void 0===i?_i.copy(this._pos,e):_i.set(this._pos,e,t,i);const n=this._parent,s=this._lpos;n?(n.updateWorldTransform(),_i.transformMat4(s,this._pos,wi.invert(Hd,n._mat))):_i.copy(s,this._pos),this.invalidateChildren(K_.POSITION),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.POSITION)}getWorldPosition(e){return this.updateWorldTransform(),e?_i.copy(e,this._pos):_i.copy(new _i,this._pos)}setWorldRotation(e,t,i,n){void 0===t||void 0===i||void 0===n?Si.copy(this._rot,e):Si.set(this._rot,e,t,i,n),this._parent?(this._parent.updateWorldTransform(),Si.multiply(this._lrot,Si.conjugate(this._lrot,this._parent._rot),this._rot)):Si.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(K_.ROTATION),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.ROTATION)}setWorldRotationFromEuler(e,t,i){Si.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),Si.multiply(this._lrot,Si.conjugate(this._lrot,this._parent._rot),this._rot)):Si.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(K_.ROTATION),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.ROTATION)}getWorldRotation(e){return this.updateWorldTransform(),e?Si.copy(e,this._rot):Si.copy(new Si,this._rot)}setWorldScale(e,t,i){void 0===t||void 0===i?_i.copy(this._scale,e):_i.set(this._scale,e,t,i);const n=this._parent;n?(n.updateWorldTransform(),vi.fromQuat(Ud,Si.conjugate(zd,n._rot)),vi.multiplyMat4(Ud,Ud,n._mat),Gd.m00=this._scale.x,Gd.m04=this._scale.y,Gd.m08=this._scale.z,vi.multiply(Ud,Gd,vi.invert(Ud,Ud)),this._lscale.x=_i.set(Ld,Ud.m00,Ud.m01,Ud.m02).length(),this._lscale.y=_i.set(Ld,Ud.m03,Ud.m04,Ud.m05).length(),this._lscale.z=_i.set(Ld,Ud.m06,Ud.m07,Ud.m08).length()):_i.copy(this._lscale,this._scale),this.invalidateChildren(K_.SCALE),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,K_.SCALE)}getWorldScale(e){return this.updateWorldTransform(),e?_i.copy(e,this._scale):_i.copy(new _i,this._scale)}getWorldMatrix(e){return this.updateWorldTransform(),e||(e=new wi),wi.copy(e,this._mat)}getWorldRS(e){return this.updateWorldTransform(),e||(e=new wi),wi.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}getWorldRT(e){return this.updateWorldTransform(),e||(e=new wi),wi.fromRT(e,this._rot,this._pos)}setRTS(e,t,i){let n=0;e&&(n|=K_.ROTATION,void 0!==e.w?(Si.copy(this._lrot,e),this._eulerDirty=!0):(_i.copy(this._euler,e),Si.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(_i.copy(this._lpos,t),n|=K_.POSITION),i&&(_i.copy(this._lscale,i),n|=K_.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(Du.TRANSFORM_CHANGED,n))}pauseSystemEvents(e){$u.pauseTarget(this,e)}resumeSystemEvents(e){$u.resumeTarget(this,e)}},Pd.bookOfChange=Vd,Pd.EventType=Du,Pd.NodeSpace=Y_,Pd.TransformDirtyBit=K_,Pd.TransformBit=K_,bd=Po((Cd=Md).prototype,"_lpos",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _i}}),Rd=Po(Cd.prototype,"_lrot",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Si}}),wd=Po(Cd.prototype,"_lscale",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _i(1,1,1)}}),Id=Po(Cd.prototype,"_layer",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xc.Enum.DEFAULT}}),Od=Po(Cd.prototype,"_euler",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _i}}),Po(Cd.prototype,"eulerAngles",[Ed],Object.getOwnPropertyDescriptor(Cd.prototype,"eulerAngles"),Cd.prototype),Po(Cd.prototype,"layer",[ia],Object.getOwnPropertyDescriptor(Cd.prototype,"layer"),Cd.prototype),Ad=Cd))||Ad));var Wd,jd,qd,Xd,Yd,Kd;function Zd(e){return"string"==typeof e||"number"==typeof e}function $d(e,t){return e instanceof t}i.Node=kd;let Qd=Go("cc.animation.HierarchyPath")((qd=Po((jd=class{constructor(e){Oo(this,"path",qd,this),this.path=e||""}get(e){if(!(e instanceof kd))return h("Target of hierarchy path should be of type Node."),null;const t=e.getChildByPath(this.path);return t||(h(`Node "${e.name}" has no path "${this.path}"`),null)}}).prototype,"path",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Wd=jd))||Wd,Jd=Go("cc.animation.ComponentPath")((Kd=Po((Yd=class{constructor(e){Oo(this,"component",Kd,this),this.component=e||""}get(e){if(!(e instanceof kd))return h("Target of component path should be of type Node."),null;const t=e.getComponent(this.component);return t||(h(`Node "${e.name}" has no component "${this.component}"`),null)}}).prototype,"component",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Xd=Yd))||Xd;function em(e,...t){let i=e;for(let e=0;e<t.length;++e){const n=t[e];if(Zd(n)){if(!(n in i))return h(`Target object has no property "${n}"`),null;i=i[n]}else i=n.get(i);if(null===i)break}return i}class tm{static getOrExtract(e){let t=tm.pool.get(e);return t&&t.info.sample===e.sample||(t&&i.director.root.dataPoolManager.releaseAnimationClip(e),t=function(e){const t={};e.curves.forEach(e=>{if(!e.valueAdapter&&$d(e.modifiers[0],Qd)&&Zd(e.modifiers[1])){const i=e.modifiers[0].path;let n=t[i];n||(n=t[i]={});n[e.modifiers[1]]={values:e.data.values,keys:e.data.keys}}});const i=Math.ceil(e.sample*e.duration)+1;for(const n of Object.keys(t)){const s=t[n];s&&Object.defineProperty(s,"worldMatrix",{get:()=>{if(!s._worldMatrix){const{position:r,rotation:o,scale:a}=s;im(e,r,i),im(e,o,i),im(e,a,i),nm(t,n,s)}return s._worldMatrix}})}return{info:{frames:i,sample:e.sample},data:t}}(e),tm.pool.set(e,t)),t}static destroy(e){tm.pool.delete(e)}}function im(e,t,i){const n=e.keys[t.keys],s=[];if(n&&1!==n.length){const r=t.values[0]instanceof Si;for(let o=0,a=0;o<i;o++){let i=o/e.sample;for(;n[a]<=i;)a++;a>n.length-1?(a=n.length-1,i=n[a]):0===a&&(a=1);const c=t.values[a-1].clone(),l=n[a]-n[a-1],h=l?qt((i-n[a-1])/l):1;r?c.slerp(t.values[a],h):c.lerp(t.values[a],h),s[o]=c}}else for(let e=0;e<i;e++)s[e]=t.values[0].clone();t.values=s}function nm(e,t,i){const n=i.position.values,s=i.rotation.values,r=i.scale.values,o=n.map(()=>new wi),a=t.lastIndexOf("/");let c=null;if(a>0){const i=e[t.substring(0,a)];if(!i)return void console.warn("no data for parent bone?");c=i.worldMatrix.values}for(let e=0;e<n.length;e++){const t=n[e],i=s[e],a=r[e],l=o[e];wi.fromRTS(l,i,t,a),c&&wi.multiply(l,c[e],l)}Object.keys(i).forEach(e=>delete i[e]),i._worldMatrix={keys:0,interpolate:!1,values:o}}e("SkelAnimDataHub",tm),tm.pool=new Map;const sm=new wi;function rm(e,t,i){for(wi.identity(i);e!==t;)wi.fromRTS(sm,e.rotation,e.position,e.scale),wi.multiply(i,sm,i),e=e.parent;return i}const om=function(e,t,i,n){e[t+0]=i.m00,e[t+1]=i.m01,e[t+2]=i.m02,e[t+3]=i.m12,e[t+4]=i.m04,e[t+5]=i.m05,e[t+6]=i.m06,e[t+7]=i.m13,e[t+8]=i.m08,e[t+9]=i.m09,e[t+10]=i.m10,e[t+11]=i.m14};function am(e){return e.hasFeature(As.TEXTURE_FLOAT)?En.RGBA32F:En.RGBA8}new Si,new Si,new _i,new Si,new _i;function cm(e,t){const i=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*i,e)/12)}const lm=yc([Fn.POINT,Fn.POINT,Fn.NONE,zn.CLAMP,zn.CLAMP,zn.CLAMP]),hm=new _i,um=new _i,_m=new _i,dm=new _i,mm=new wi,pm=new wi,fm=new $r,gm=Number.MAX_SAFE_INTEGER;class vm{get pixelsPerJoint(){return this._pixelsPerJoint}constructor(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;const t=am(this._device);this._formatSize=_s[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new tu(e),this._pool.initialize({format:t,roundUpFn:cm}),this._customPool=new tu(e),this._customPool.initialize({format:t,roundUpFn:cm})}clear(){this._pool.destroy(),this._textureBuffers.clear()}registerCustomTextureLayouts(e){for(let t=0;t<e.length;t++){const i=e[t],n=this._customPool.createChunk(i.textureLength);for(let e=0;e<i.contents.length;e++){const t=i.contents[e],s=t.skeleton;this._chunkIdxMap.set(s,n);for(let e=0;e<t.clips.length;e++){const i=t.clips[e];this._chunkIdxMap.set(s^i,n)}}}}getDefaultPoseTexture(e,t,i){const n=0^e.hash;let s=this._textureBuffers.get(n)||null;if(s&&s.bounds.has(t.hash))return s.refCount++,s;const{joints:r,bindposes:o}=e;let a=null,c=!1;const l=r.length;if(s)s.refCount++;else{const t=12*l,i=this._chunkIdxMap.get(n),r=void 0!==i?this._customPool.alloc(t*Float32Array.BYTES_PER_ELEMENT,i):this._pool.alloc(t*Float32Array.BYTES_PER_ELEMENT);if(!r)return s;s={pixelOffset:r.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:r},a=new Float32Array(t),c=!0}_i.set(_m,gm,gm,gm),_i.set(dm,-gm,-gm,-gm);const h=t.getBoneSpaceBounds(e);for(let t=0,n=0;t<l;t++,n+=12){const s=i.getChildByPath(r[t]),l=s?rm(s,i,mm):e.inverseBindposes[t],u=h[t];u&&($r.transform(fm,u,l),fm.getBoundary(hm,um),_i.min(_m,_m,hm),_i.max(dm,dm,um)),c&&(s&&wi.multiply(l,l,o[t]),om(a,n,s?l:wi.IDENTITY))}const u=[new $r];return s.bounds.set(t.hash,u),$r.fromPoints(u[0],_m,dm),c&&(this._pool.update(s.handle,a.buffer),this._textureBuffers.set(n,s)),s}getSequencePoseTexture(e,t,i,n){const s=e.hash^t.hash;let r=this._textureBuffers.get(s)||null;if(r&&r.bounds.has(i.hash))return r.refCount++,r;const{joints:o,bindposes:a}=e,c=tm.getOrExtract(t).info.frames;let l=null,h=!1;const u=o.length;if(r)r.refCount++;else{const i=12*u*c,o=this._chunkIdxMap.get(s),a=void 0!==o?this._customPool.alloc(i*Float32Array.BYTES_PER_ELEMENT,o):this._pool.alloc(i*Float32Array.BYTES_PER_ELEMENT);if(!a)return null;const _=this._createAnimInfos(e,t,n);r={pixelOffset:a.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:a,animInfos:_},l=new Float32Array(i),h=!0}const _=i.getBoneSpaceBounds(e),d=[];r.bounds.set(i.hash,d);for(let e=0;e<c;e++)d.push(new $r(gm,gm,gm,-gm,-gm,-gm));for(let t=0,i=0;t<c;t++){const n=d[t];for(let s=0;s<u;s++,i+=12){const{curveData:o,downstream:c,bindposeIdx:u,bindposeCorrection:d}=r.animInfos[s];let m,p=!0;o&&c?m=wi.multiply(mm,o[t],c):o?m=o[t]:c?m=c:(m=e.inverseBindposes[u],p=!1);const f=_[s];if(f){const e=d?wi.multiply(pm,m,d):m;$r.transform(fm,f,e),fm.getBoundary(hm,um),_i.min(n.center,n.center,hm),_i.max(n.halfExtents,n.halfExtents,um)}h&&(p&&wi.multiply(mm,m,a[u]),om(l,i,p?mm:wi.IDENTITY))}$r.fromPoints(n,n.center,n.halfExtents)}return h&&(this._pool.update(r.handle,l.buffer),this._textureBuffers.set(s,r)),r}releaseHandle(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){const t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}}releaseSkeleton(e){const t=this._textureBuffers.values();let i=t.next();for(;!i.done;){const n=i.value;n.skeletonHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}}releaseAnimationClip(e){const t=this._textureBuffers.values();let i=t.next();for(;!i.done;){const n=i.value;n.clipHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}}_createAnimInfos(e,t,i){const n=[],{joints:s,bindposes:r}=e,o=s.length,a=tm.getOrExtract(t);for(let t=0;t<o;t++){let c,l,h=s[t],u=a.data[h],_=i.getChildByPath(h);for(;!u;){const e=h.lastIndexOf("/");if(h=h.substring(0,e),u=a.data[h],_?(c||(c=new wi),wi.fromRTS(mm,_.rotation,_.position,_.scale),wi.multiply(c,mm,c),_=_.parent):l=h,e<0)break}let d,m=t;if(void 0!==l&&u){m=t-1;for(let i=0;i<o;i++)if(s[i]===l){m=i,d=new wi,wi.multiply(d,r[i],e.inverseBindposes[t]);break}}n.push({curveData:u&&u.worldMatrix.values,downstream:c,bindposeIdx:m,bindposeCorrection:d})}return n}}class ym{constructor(e){this._pool=new Map,this._device=void 0,this._device=e}getData(e="-1"){const t=this._pool.get(e);if(t)return t;const i=this._device.createBuffer({usage:An.UNIFORM|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:pl.SIZE,stride:pl.SIZE}),n=new Float32Array([0,0,0,0]);i.update(n);const s={buffer:i,data:n,dirty:!1};return this._pool.set(e,s),s}destroy(e){const t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))}switchClip(e,t){return e.data[0]=0,e.buffer.update(e.data),e.dirty=!1,e}clear(){for(const e of this._pool.values())e.buffer.destroy();this._pool.clear()}}const xm={layout:null};class Sm{constructor(){this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=0,this._priority=Kc.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}set passes(e){this._passes=e,this._flushPassInfo()}get passes(){return this._passes}set subMesh(e){this._subMesh=e,this._inputAssembler.destroy(),this._inputAssembler.initialize(e)}get subMesh(){return this._subMesh}set priority(e){this._priority=e,Uh.set(this._handle,zh.PRIORITY,e)}get priority(){return this._priority}get handle(){return this._handle}get inputAssembler(){return this._inputAssembler}get descriptorSet(){return this._descriptorSet}initialize(e,t,n=null){this._device=i.director.root.device,this._subMesh=e,this._patches=n,this._passes=t,this._handle=Uh.alloc(),this._flushPassInfo(),xm.layout=t[0].setLayouts[rl.LOCAL];const s=Dh.alloc(this._device,xm),r=Lh.alloc(this._device,e);Uh.set(this._handle,zh.PRIORITY,Kc.DEFAULT),Uh.set(this._handle,zh.INPUT_ASSEMBLER,r),Uh.set(this._handle,zh.DESCRIPTOR_SET,s),this._inputAssembler=Lh.get(r),this._descriptorSet=Dh.get(s)}destroy(){Dh.free(Uh.get(this._handle,zh.DESCRIPTOR_SET)),Lh.free(Uh.get(this._handle,zh.INPUT_ASSEMBLER)),Uh.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=Kc.DEFAULT,this._handle=0,this._patches=null,this._subMesh=null,this._passes=null}update(){for(let e=0;e<this._passes.length;++e){this._passes[e].update()}this._descriptorSet.update()}onPipelineStateChanged(){const e=this._passes;if(e){for(let t=0;t<e.length;t++){const i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}onMacroPatchesStateChanged(e){this._patches=e;const t=this._passes;if(t){for(let e=0;e<t.length;e++){const i=t[e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}_flushPassInfo(){const e=this._passes;if(e){Uh.set(this._handle,zh.PASS_COUNT,e.length);for(let t=0;t<e.length;t++)Uh.set(this._handle,zh.PASS_0+t,e[t].handle),Uh.set(this._handle,zh.SHADER_0+t,e[t].getShaderVariant(this._patches))}}}class Tm{static get(e,t=0){const i=Tm._buffers;i.has(e)||i.set(e,{});const n=i.get(e);return n[t]||(n[t]=new Tm(e))}constructor(e){this.instances=[],this.hPass=0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.hPass=e.handle}destroy(){for(let e=0;e<this.instances.length;++e){const t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0}merge(e,t,i,n=null){const s=t.buffer.length;if(!s)return;const r=e.inputAssembler,o=e.descriptorSet.getTexture(Tl.binding),a=n||Uh.get(e.handle,zh.SHADER_0+i),c=Uh.get(e.handle,zh.DESCRIPTOR_SET);for(let e=0;e<this.instances.length;++e){const i=this.instances[e];if(!(i.ia.indexBuffer!==r.indexBuffer||i.count>=1024)&&i.lightingMap===o){if(i.stride!==s)return;if(i.count>=i.capacity){i.capacity<<=1;const e=i.stride*i.capacity,t=i.data;i.data=new Uint8Array(e),i.data.set(t),i.vb.resize(e)}return i.hShader!==a&&(i.hShader=a),i.hDescriptorSet!==c&&(i.hDescriptorSet=c),i.data.set(t.buffer,i.stride*i.count++),void(this.hasPendingModels=!0)}}const l=this._device.createBuffer({usage:An.VERTEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:32*s,stride:s}),h=new Uint8Array(32*s),u=r.vertexBuffers.slice(),_=r.attributes.slice(),d=r.indexBuffer||void 0;for(let e=0;e<t.list.length;e++){const i=t.list[e],n={name:i.name,format:i.format,stream:u.length,isInstanced:!0};void 0!==i.isNormalized&&(n.isNormalized=i.isNormalized),_.push(n)}h.set(t.buffer),u.push(l);const m=this._device.createInputAssembler({attributes:_,vertexBuffers:u,indexBuffer:d});this.instances.push({count:1,capacity:32,vb:l,data:h,ia:m,stride:s,hShader:a,hDescriptorSet:c,lightingMap:o}),this.hasPendingModels=!0}uploadBuffers(){for(let e=0;e<this.instances.length;++e){const t=this.instances[e];t.count&&(t.ia.instanceCount=t.count,t.vb.update(t.data))}}clear(){for(let e=0;e<this.instances.length;++e){this.instances[e].count=0}this.hasPendingModels=!1}}Tm._buffers=new Map;const Em=new wi,Am=new _o(()=>new Sm,32),Cm=[{name:"CC_RECEIVE_SHADOW",value:!0}];let bm;!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.UI_BATCH=3]="UI_BATCH",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(bm||(bm={}));const Rm=yc([Fn.LINEAR,Fn.LINEAR,Fn.NONE,zn.CLAMP,zn.CLAMP,zn.CLAMP]),wm=yc([Fn.LINEAR,Fn.LINEAR,Fn.LINEAR,zn.CLAMP,zn.CLAMP,zn.CLAMP]);class Im{get subModels(){return this._subModels}get inited(){return this._inited}get worldBounds(){return this._worldBounds}get modelBounds(){return this._modelBounds}get localBuffer(){return this._localBuffer}get updateStamp(){return this._updateStamp}get isInstancingEnabled(){return this._instMatWorldIdx>=0}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){this._receiveShadow=e,this.onMacroPatchesStateChanged()}constructor(){this.type=bm.DEFAULT,this.scene=null,this.node=null,this.transform=null,this.enabled=!0,this.visFlags=Xc.Enum.NONE,this.castShadow=!1,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,list:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._localData=new Float32Array(ul.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new fi,this._receiveShadow=!0,this._device=i.director.root.device}initialize(e){this.transform=this.node=e,this._receiveShadow=!0,this.castShadow=!1}destroy(){const e=this._subModels;for(let t=0;t<e.length;t++){const e=this._subModels[t];e.destroy(),Am.free(e)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this.isDynamicBatching=!1}attachToScene(e){this.scene=e}detachFromScene(){this.scene=null}updateTransform(e){const t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0,this._modelBounds&&this._worldBounds&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds))}updateUBOs(e){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].update();if(this._updateStamp=e,!this._transformUpdated)return;this._transformUpdated=!1;const i=this.transform._mat,n=this._instMatWorldIdx;if(n>=0){const e=this.instancedAttributes.list;!function(e,t,i,n){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,i[0]=e.m04,i[1]=e.m05,i[2]=e.m06,i[3]=e.m13,n[0]=e.m08,n[1]=e.m09,n[2]=e.m10,n[3]=e.m14}(i,e[n].view,e[n+1].view,e[n+2].view)}else wi.toArray(this._localData,i,ul.MAT_WORLD_OFFSET),wi.inverseTranspose(Em,i),wi.toArray(this._localData,Em,ul.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData)}createBoundingShape(e,t){e&&t&&(this._modelBounds=$r.fromPoints($r.create(),e,t),this._worldBounds=$r.clone(this._modelBounds))}initSubModel(e,t,i){null==this._subModels[e]?this._subModels[e]=Am.alloc():this._subModels[e].destroy(),this._subModels[e].initialize(t,i.passes,this.getMacroPatches(e)),this._updateAttributesAndBinding(e),this._inited=!0}setSubModelMesh(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)}setSubModelMaterial(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))}onGlobalPipelineStateChanged(){const e=this._subModels;for(let t=0;t<e.length;t++)e[t].onPipelineStateChanged()}onMacroPatchesStateChanged(){const e=this._subModels;for(let t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))}updateLightingmap(e,t){fi.toArray(this._localData,t,ul.LIGHTINGMAP_UVPARAM),this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=Th.get("empty-texture"));const i=e.getGFXTexture();if(null!==i){const t=xc.getSampler(this._device,e.mipmaps.length>1?wm:Rm),n=this._subModels;for(let e=0;e<n.length;e++){const s=n[e].descriptorSet;s.bindTexture(Tl.binding,i),s.bindSampler(Tl.binding,t),s.update()}}}getMacroPatches(e){return this.receiveShadow?Cm:null}_updateAttributesAndBinding(e){const t=this._subModels[e];if(!t)return;this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet);const i=Mh.get(Uh.get(t.handle,zh.SHADER_0));this._updateInstancedAttributes(i.attributes,t.passes[0])}_getInstancedAttributeIndex(e){const t=this.instancedAttributes.list;for(let i=0;i<t.length;i++)if(t[i].name===e)return i;return-1}_updateInstancedAttributes(e,t){if(!t.device.hasFeature(As.INSTANCED_ARRAYS))return;let i=0;for(let t=0;t<e.length;t++){const n=e[t];n.isInstanced&&(i+=_s[n.format].size)}const n=this.instancedAttributes;n.buffer=new Uint8Array(i),n.list.length=0;let s=0;const r=n.buffer.buffer;for(let t=0;t<e.length;t++){const i=e[t];if(!i.isInstanced)continue;const o=i.format,a=_s[o],c=new(gs(a))(r,s,a.count),l=i.isNormalized;s+=a.size,n.list.push({name:i.name,format:o,isNormalized:l,view:c})}t.batchingScheme===$h.INSTANCING&&Tm.get(t).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex("a_matWorld0"),this._transformUpdated=!0}_initLocalDescriptors(e){this._localBuffer||(this._localBuffer=this._device.createBuffer({usage:An.UNIFORM|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:ul.SIZE,stride:ul.SIZE}))}_updateLocalDescriptors(e,t){t.bindBuffer(ul.BLOCK.binding,this._localBuffer)}}class Om extends Im{constructor(...e){super(...e),this._morphRenderingInstance=null,this._usedMaterials=new Set}getMacroPatches(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):void 0}initSubModel(e,t,i){return super.initSubModel(e,t,this._launderMaterial(i))}setSubModelMaterial(e,t){return super.setSubModelMaterial(e,this._launderMaterial(t))}_updateLocalDescriptors(e,t){super._updateLocalDescriptors(e,t),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,t)}_launderMaterial(e){return e}destroy(){super.destroy(),this._morphRenderingInstance=null}setMorphRendering(e){this._morphRenderingInstance=e}}const Pm=[],Mm=new Map,Dm=[{name:"CC_USE_SKINNING",value:!0}];function Lm(e,t){let i=0,n=wi.IDENTITY;for(;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){n=e.world,e.stamp=t;break}e.stamp=t,Pm[i++]=e,e=e.parent}for(;i>0;){const t=(e=Pm[--i]).node;wi.fromRTS(e.local,t.rotation,t.position,t.scale),n=wi.multiply(e.world,n,e.local)}return n}function Bm(e,t){let i,n=null,s=0;for(;e!==t;){const t=e.uuid;if(Mm.has(t)){n=Mm.get(t);break}n={node:e,local:new wi,world:new wi,stamp:-1,parent:null},Mm.set(t,n),Pm[s++]=n,e=e.parent,n=null}for(;s>0;)i=Pm[--s],i.parent=n,n=i;return n}function Nm(e){let t=Mm.get(e.uuid)||null;for(;t;)Mm.delete(t.node.uuid),t=t.parent}function Fm(e,t,i,n){for(let s=0;s<i.length;s++){const r=i[s];let o=-1;for(let e=0;e<r.length;e++)if(r[e]===n){o=e;break}o>=0&&(t.push(s),e.push(o))}}const zm=new _i,Um=new _i,Gm=new _i,Hm=new _i,Vm=new wi,km=new $r;class Wm extends Om{constructor(){super(),this.uploadAnimation=null,this._buffers=[],this._dataArray=[],this._joints=[],this._bufferIndices=null,this.type=bm.SKINNING}destroy(){if(this.bindSkeleton(),this._buffers.length){for(let e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}super.destroy()}bindSkeleton(e=null,t=null,i=null){for(let e=0;e<this._joints.length;e++)Nm(this._joints[e].target);if(this._bufferIndices=null,this._joints.length=0,!e||!t||!i)return;this.transform=t;const n=i.getBoneSpaceBounds(e),s=i.struct.jointMaps;this._ensureEnoughBuffers(s&&s.length||1),this._bufferIndices=i.jointBufferIndices;for(let i=0;i<e.joints.length;i++){const r=n[i],o=t.getChildByPath(e.joints[i]);if(!r||!o)continue;const a=Bm(o,t),c=e.bindposes[i],l=[],h=[];s?Fm(l,h,s,i):(l.push(i),h.push(0)),this._joints.push({indices:l,buffers:h,bound:r,target:o,bindpose:c,transform:a})}}updateTransform(e){const t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0),_i.set(zm,1/0,1/0,1/0),_i.set(Um,-1/0,-1/0,-1/0);for(let t=0;t<this._joints.length;t++){const{bound:i,transform:n}=this._joints[t],s=Lm(n,e);$r.transform(km,i,s),km.getBoundary(Gm,Hm),_i.min(zm,zm,Gm),_i.max(Um,Um,Hm)}this._modelBounds&&this._worldBounds&&($r.fromPoints(this._modelBounds,zm,Um),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds))}updateUBOs(e){super.updateUBOs(e);for(let e=0;e<this._joints.length;e++){const{indices:t,buffers:i,transform:n,bindpose:s}=this._joints[e];wi.multiply(Vm,n.world,s);for(let e=0;e<i.length;e++)om(this._dataArray[i[e]],12*t[e],Vm)}for(let e=0;e<this._buffers.length;e++)this._buffers[e].update(this._dataArray[e]);return!0}initSubModel(e,t,i){const n=t.vertexBuffers;t.vertexBuffers=t.jointMappedBuffers,super.initSubModel(e,t,i),t.vertexBuffers=n}getMacroPatches(e){const t=super.getMacroPatches(e);return t?Dm.concat(t):Dm}_updateLocalDescriptors(e,t){super._updateLocalDescriptors(e,t);const i=this._buffers[this._bufferIndices[e]];i&&t.bindBuffer(fl.BLOCK.binding,i)}_ensureEnoughBuffers(e){for(let t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer({usage:An.UNIFORM|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:fl.SIZE,stride:fl.SIZE})),this._dataArray[t]||(this._dataArray[t]=new Float32Array(fl.COUNT))}}const jm=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}];class qm extends Om{constructor(){super(),this.uploadedAnim=void 0,this._jointsMedium=void 0,this._skeleton=null,this._mesh=null,this._dataPoolManager=void 0,this._instAnimInfoIdx=-1,this.type=bm.BAKED_SKINNING,this._dataPoolManager=i.director.root.dataPoolManager;const e=new Float32Array(4),t=this._dataPoolManager.jointAnimationInfo.getData();this._jointsMedium={buffer:null,jointTextureInfo:e,animInfo:t,texture:null,boundsInfo:null}}destroy(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),super.destroy()}bindSkeleton(e=null,t=null,i=null){if(this._skeleton=e,this._mesh=i,!e||!t||!i)return;this.transform=t;const n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer({usage:An.UNIFORM|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:ml.SIZE,stride:ml.SIZE}))}updateTransform(e){if(super.updateTransform(e),!this.uploadedAnim)return;const{animInfo:t,boundsInfo:i}=this._jointsMedium,n=i[t.data[0]],s=this.transform;this._worldBounds&&n&&n.transform(s._mat,s._pos,s._rot,s._scale,this._worldBounds)}updateUBOs(e){super.updateUBOs(e);const t=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;if(i>=0){this.instancedAttributes.list[i].view[0]=t.data[0]}else t.dirty&&(t.buffer.update(t.data),t.dirty=!1);return!0}createBoundingShape(e,t){e&&t&&(this._worldBounds=new $r)}uploadAnimation(e){if(!this._skeleton||!this._mesh||this.uploadedAnim===e)return;this.uploadedAnim=e;const t=this._dataPoolManager;let i=null;e?(i=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._modelBounds=null):(i=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._modelBounds=i&&i.bounds.get(this._mesh.hash)[0]),this._applyJointTexture(i)}_applyJointTexture(e=null){const t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,!e)return;const{buffer:i,jointTextureInfo:n}=this._jointsMedium;n[0]=e.handle.texture.width,n[1]=this._skeleton.joints.length,n[2]=e.pixelOffset+.1,n[3]=1/n[0],this.updateInstancedJointTextureInfo(),i&&i.update(n);const s=e.handle.texture;for(let e=0;e<this._subModels.length;++e){this._subModels[e].descriptorSet.bindTexture(vl.binding,s)}}getMacroPatches(e){const t=super.getMacroPatches(e);return t?t.concat(jm):jm}_updateLocalDescriptors(e,t){super._updateLocalDescriptors(e,t);const{buffer:i,texture:n,animInfo:s}=this._jointsMedium;if(t.bindBuffer(ml.BLOCK.binding,i),t.bindBuffer(pl.BLOCK.binding,s.buffer),n){const e=xc.getSampler(this._device,lm);t.bindTexture(vl.binding,n.handle.texture),t.bindSampler(vl.binding,e)}}_updateInstancedAttributes(e,t){super._updateInstancedAttributes(e,t),this._instAnimInfoIdx=this._getInstancedAttributeIndex("a_jointAnimInfo"),this.updateInstancedJointTextureInfo()}updateInstancedJointTextureInfo(){const{jointTextureInfo:e,animInfo:t}=this._jointsMedium,i=this._instAnimInfoIdx;if(i>=0){const n=this.instancedAttributes.list[i].view;n[0]=t.data[0],n[1]=e[1],n[2]=e[2]}}}var Xm=Object.freeze({__proto__:null,uploadJointData:om,MINIMUM_JOINT_TEXTURE_SIZE:480,selectJointsMediumFormat:am,jointTextureSamplerHash:lm,JointTexturePool:vm,JointAnimationInfo:ym,getWorldMatrix:Lm,getTransform:Bm,deleteTransform:Nm,SkinningModel:Wm,BakedSkinningModel:qm,MorphModel:Om});class Ym{constructor(){this._enabled=!0,this._skyColor=new Fi(51,128,204,1),this._skyIllum=Ym.SKY_ILLUM,this._groundAlbedo=new Fi(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1])}get colorArray(){return this._colorArray}get albedoArray(){return this._albedoArray}set enabled(e){this._enabled!==e&&(this._enabled=e,this.activate())}get enabled(){return this._enabled}get skyColor(){return this._skyColor}set skyColor(e){this._skyColor=e,Fi.toArray(this._colorArray,this._skyColor)}get skyIllum(){return this._skyIllum}set skyIllum(e){this._skyIllum=e}get groundAlbedo(){return this._groundAlbedo}set groundAlbedo(e){this._groundAlbedo=e,_i.toArray(this._albedoArray,this._groundAlbedo)}activate(){Fi.toArray(this._colorArray,this._skyColor),_i.toArray(this._albedoArray,this._groundAlbedo)}}let Km,Zm,$m,Qm,Jm;Ym.SUN_ILLUM=65e3,Ym.SKY_ILLUM=2e4,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Km||(Km={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(Zm||(Zm={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}($m||($m={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(Qm||(Qm={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Jm||(Jm={}));const ep=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],tp=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],ip=[100,200,400,800],np=new _i,sp=new _i,rp=new wi,op=new wi,ap=Jn.STENCIL<<1;class cp{constructor(e){this.isWindowSize=!0,this.screenScale=void 0,this.clearStencil=0,this.clearDepth=1,this.clearFlag=Jn.NONE,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._width=void 0,this._height=void 0,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Km.VERTICAL,this._fov=Yt(45),this._nearClip=1,this._farClip=1e3,this._clearColor={r:.2,g:.2,b:.2,a:1},this._viewport=new Bi(0,0,1,1),this._isProjDirty=!0,this._matView=new wi,this._matViewInv=null,this._matProj=new wi,this._matProjInv=new wi,this._matViewProj=new wi,this._matViewProjInv=new wi,this._frustum=new no,this._forward=new _i,this._position=new _i,this._view=null,this._visibility=Al,this._priority=0,this._aperture=$m.F16_0,this._apertureValue=void 0,this._shutter=Jm.D125,this._shutterValue=0,this._iso=Qm.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._device=e,this._apertureValue=ep[this._aperture],this._shutterValue=tp[this._shutter],this._isoValue=ip[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this.screenScale=1}initialize(e){this._name=e.name,this._node=e.node,this._proj=e.projection,this._priority=e.priority||0,this._view=i.director.root.createView({camera:this,name:this._name,priority:this._priority,flows:e.flows}),i.director.root.attachCamera(this),this.changeTargetWindow(e.window),console.log("Created Camera: "+this._name+" "+this._width+"x"+this._height)}destroy(){i.director.root.detachCamera(this),this._view&&(this._view.destroy(),this._view=null),this._name=null}attachToScene(e){this._scene=e,this._view&&this._view.enable(!0)}detachFromScene(){this._scene=null,this._view&&this._view.enable(!1)}resize(e,t){this._width=e,this._height=t,this._aspect=this._width*this._viewport.width/(this._height*this._viewport.height),this._isProjDirty=!0}setFixedSize(e,t){this._width=e,this._height=t,this._aspect=this._width*this._viewport.width/(this._height*this._viewport.height),this.isWindowSize=!1}update(e=!1){if(this._node){if((this._node.hasChangedFlags||e)&&(wi.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty){let e=this._device.screenSpaceSignY;if(this._view&&this._view.window.hasOffScreenAttachments&&(e*=this._device.UVSpaceSignY),this._proj===Zm.PERSPECTIVE)wi.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Km.VERTICAL,this._device.clipSpaceMinZ,e);else{const t=this._orthoHeight*this._aspect,i=this._orthoHeight;wi.ortho(this._matProj,-t,t,-i,i,this._nearClip,this._farClip,this._device.clipSpaceMinZ,e)}wi.invert(this._matProjInv,this._matProj)}(this._node.hasChangedFlags||this._isProjDirty||e)&&(wi.multiply(this._matViewProj,this._matProj,this._matView),wi.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}getSplitFrustum(e,t,i){if(this._node){if(t=Math.max(t,this._nearClip),i=Math.min(i,this._farClip),wi.invert(this._matView,this._node.worldMatrix),this._proj===Zm.PERSPECTIVE)wi.perspective(rp,this._fov,this._aspect,t,i,this._fovAxis===Km.VERTICAL,this._device.clipSpaceMinZ,this._device.screenSpaceSignY);else{const e=this._orthoHeight*this._aspect,n=this._orthoHeight;wi.ortho(rp,-e,e,-n,n,t,i,this._device.clipSpaceMinZ,this._device.screenSpaceSignY)}wi.multiply(op,rp,this._matView),wi.invert(rp,op),e.update(op,rp)}}set node(e){this._node=e}get node(){return this._node}set enabled(e){this._enabled=e,this._view&&this._view.enable(e)}get enabled(){return this._enabled}get view(){return this._view}set orthoHeight(e){this._orthoHeight=e,this._isProjDirty=!0}get orthoHeight(){return this._orthoHeight}set projectionType(e){this._proj=e,this._isProjDirty=!0}get projectionType(){return this._proj}set fovAxis(e){this._fovAxis=e,this._isProjDirty=!0}get fovAxis(){return this._fovAxis}set fov(e){this._fov=e,this._isProjDirty=!0}get fov(){return this._fov}set nearClip(e){this._nearClip=e,this._isProjDirty=!0}get nearClip(){return this._nearClip}set farClip(e){this._farClip=e,this._isProjDirty=!0}get farClip(){return this._farClip}set clearColor(e){this._clearColor.r=e.r,this._clearColor.g=e.g,this._clearColor.b=e.b,this._clearColor.a=e.a}get clearColor(){return this._clearColor}get viewport(){return this._viewport}set viewport(e){const t=this._device.screenSpaceSignY;this._viewport.x=e.x,this._viewport.y=t>0?e.y:1-e.y-e.height,this._viewport.width=e.width,this._viewport.height=e.height,this.resize(this._width,this._height)}get scene(){return this._scene}get name(){return this._name}get width(){return this._width}get height(){return this._height}get aspect(){return this._aspect}set matView(e){this._matView=e}get matView(){return this._matView}set matViewInv(e){this._matViewInv=e}get matViewInv(){return this._matViewInv||this._node.worldMatrix}set matProj(e){this._matProj=e}get matProj(){return this._matProj}set matProjInv(e){this._matProjInv=e}get matProjInv(){return this._matProjInv}set matViewProj(e){this._matViewProj=e}get matViewProj(){return this._matViewProj}set matViewProjInv(e){this._matViewProjInv=e}get matViewProjInv(){return this._matViewProjInv}set frustum(e){this._frustum=e}get frustum(){return this._frustum}set forward(e){this._forward=e}get forward(){return this._forward}set position(e){this._position=e}get position(){return this._position}set visibility(e){this._visibility=e,this._view&&(this._view.visibility=e)}get visibility(){return this._visibility}get priority(){return this._view?this._view.priority:-1}set priority(e){this._priority=e,this._view&&(this._view.priority=this._priority)}set aperture(e){this._aperture=e,this._apertureValue=ep[this._aperture],this.updateExposure()}get aperture(){return this._aperture}get apertureValue(){return this._apertureValue}set shutter(e){this._shutter=e,this._shutterValue=tp[this._shutter],this.updateExposure()}get shutter(){return this._shutter}get shutterValue(){return this._shutterValue}set iso(e){this._iso=e,this._isoValue=ip[this._iso],this.updateExposure()}get iso(){return this._iso}get isoValue(){return this._isoValue}set ec(e){this._ec=e}get ec(){return this._ec}get exposure(){return this._exposure}set flows(e){this._view&&this._view.setExecuteFlows(e)}changeTargetWindow(e=null){const t=e||i.director.root.mainWindow;t&&this._view&&(this._view.window=t,this.resize(t.width,t.height))}screenPointToRay(e,t,i){const n=this._viewport.x*this._width,s=this._viewport.y*this._height,r=this._viewport.width*this._width,o=this._viewport.height*this._height;return _i.set(np,(t-n)/r*2-1,(i-s)/o*2-1,1),np.y*=this._device.screenSpaceSignY,_i.transformMat4(np,np,this._matViewProjInv),this._proj===Zm.PERSPECTIVE?this._node&&this._node.getWorldPosition(sp):(_i.set(sp,(t-n)/r*2-1,(i-s)/o*2-1,-1),sp.y*=this._device.screenSpaceSignY,_i.transformMat4(sp,sp,this._matViewProjInv)),cn.fromPoints(e,sp,np)}screenToWorld(e,t){const i=this._viewport.x*this._width,n=this._viewport.y*this._height,s=this._viewport.width*this._width,r=this._viewport.height*this._height;return this._proj===Zm.PERSPECTIVE?(_i.set(e,(t.x-i)/s*2-1,(t.y-n)/r*2-1,1),_i.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(np),_i.lerp(e,np,e,Xt(this._nearClip/this._farClip,1,t.z))):(_i.set(e,(t.x-i)/s*2-1,(t.y-n)/r*2-1,2*t.z-1),_i.transformMat4(e,e,this.matViewProjInv)),e}worldToScreen(e,t){const i=this._viewport.x*this._width,n=this._viewport.y*this._height,s=this._viewport.width*this._width,r=this._viewport.height*this._height;return _i.transformMat4(e,t,this.matViewProj),e.x=i+.5*(e.x+1)*s,e.y=n+.5*(e.y+1)*r,e.z=.5*e.z+.5,e}updateExposure(){const e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}}class lp{get root(){return this._root}get name(){return this._name}get cameras(){return this._cameras}get mainLight(){return this._mainLight}get sphereLights(){return this._sphereLights}get spotLights(){return this._spotLights}get models(){return this._models}get rayResultCanvas(){return yp}get rayResultModels(){return fp}get rayResultAll(){return xp}get rayResultSingleModel(){return Sp}static registerCreateFunc(e){e._createSceneFun=e=>new lp(e)}constructor(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e}initialize(e){return this._name=e.name,!0}update(e){const t=this._mainLight;t&&t.update();const i=this._sphereLights;for(let e=0;e<i.length;e++){i[e].update()}const n=this._spotLights;for(let e=0;e<n.length;e++){n[e].update()}const s=this._models;for(let t=0;t<s.length;t++){const i=s[t];i.enabled&&(i.updateTransform(e),i.updateUBOs(e))}}destroy(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels()}addCamera(e){e.attachToScene(this),this._cameras.push(e)}removeCamera(e){for(let t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()}removeCameras(){for(const e of this._cameras)e.detachFromScene();this._cameras.splice(0)}setMainLight(e){this._mainLight=e}unsetMainLight(e){if(this._mainLight===e){const e=this._directionalLights;e.length?(this._mainLight=e[e.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=K_.ROTATION)):this._mainLight=null}}addDirectionalLight(e){e.attachToScene(this),this._directionalLights.push(e)}removeDirectionalLight(e){for(let t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)}addSphereLight(e){e.attachToScene(this),this._sphereLights.push(e)}removeSphereLight(e){for(let t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)}addSpotLight(e){e.attachToScene(this),this._spotLights.push(e)}removeSpotLight(e){for(let t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)}removeSphereLights(){for(let e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0}removeSpotLights(){for(let e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]}addModel(e){e.attachToScene(this),this._models.push(e)}removeModel(e){const t=i.director.root.pipeline;for(let i=0;i<this._models.length;++i)if(this._models[i]===e)return t.shadows.destroyShadowData(e),e.detachFromScene(),void this._models.splice(i,1)}removeModels(){const e=i.director.root.pipeline;for(const t of this._models)e.shadows.destroyShadowData(t),t.detachFromScene(),t.destroy();this._models.length=0}onGlobalPipelineStateChanged(){for(const e of this._models)e.onGlobalPipelineStateChanged()}generateModelId(){return this._modelId++}raycastAll(e,t=Xc.Enum.DEFAULT|Xc.Enum.UI_2D,i=1/0){const n=this.raycastAllModels(e,t,i),s=this.raycastAllCanvas(e,t,i),r=n||s;return xp.length=0,r&&(Array.prototype.push.apply(xp,fp),Array.prototype.push.apply(xp,yp)),r}raycastAllModels(e,t=Xc.Enum.DEFAULT,i=1/0){pp.reset();for(const n of this._models){const s=n.transform;if(!(s&&n.enabled&&n.node.layer&t&~Xc.Enum.IGNORE_RAYCAST&&n.worldBounds))continue;let r=zr.ray_aabb(e,n.worldBounds);if(!(r<=0||r>=i)){if(n.type===bm.DEFAULT){wi.invert(_p,s.getWorldMatrix(_p)),_i.transformMat4(hp.o,e.o,_p),_i.normalize(hp.d,_i.transformMat4Normal(hp.d,e.d,_p)),r=1/0;const t=n.subModels;for(let e=0;e<t.length;++e){const n=t[e].subMesh;if(n&&n.geometricInfo){const{positions:e,indices:t,doubleSided:o}=n.geometricInfo;Tp(e,t,n.primitiveMode,o,i),r=Math.min(r,dp*_i.multiply(up,hp.d,s.worldScale).length())}}}if(r<i){const e=pp.add();e.node=n.node,e.distance=r,fp[pp.length-1]=e}}}return fp.length=pp.length,fp.length>0}raycastSingleModel(e,t,i=Xc.Enum.DEFAULT,n=1/0){pp.reset();const s=t,r=s.transform;if(!(r&&s.enabled&&s.node.layer&i&~Xc.Enum.IGNORE_RAYCAST&&s.worldBounds))return!1;let o=zr.ray_aabb(e,s.worldBounds);if(o<=0||o>=n)return!1;if(s.type===bm.DEFAULT){wi.invert(_p,r.getWorldMatrix(_p)),_i.transformMat4(hp.o,e.o,_p),_i.normalize(hp.d,_i.transformMat4Normal(hp.d,e.d,_p)),o=1/0;const t=s.subModels;for(let e=0;e<t.length;++e){const i=t[e].subMesh;if(i&&i.geometricInfo){const{positions:e,indices:t,doubleSided:s}=i.geometricInfo;Tp(e,t,i.primitiveMode,s,n),o=Math.min(o,dp*_i.multiply(up,hp.d,r.worldScale).length())}}}if(o<n){const e=pp.add();e.node=s.node,e.distance=o,Sp[pp.length-1]=e}return Sp.length=pp.length,Sp.length>0}raycastAllCanvas(e,t=Xc.Enum.UI_2D,n=1/0){vp.reset();const s=i.director.getScene().getComponentsInChildren(i.Canvas);if(null!=s&&s.length>0)for(let i=0;i<s.length;i++){const r=s[i].node;null!=r&&r.active&&this._raycastUI2DNodeRecursiveChildren(e,r,t,n)}return yp.length=vp.length,yp.length>0}_raycastUI2DNode(e,t,i=Xc.Enum.UI_2D,n=1/0){const s=t._uiProps.uiTransformComp;if(null==s||t.layer&Xc.Enum.IGNORE_RAYCAST||!(t.layer&i))return;s.getComputeAABB(gp);const r=zr.ray_aabb(e,gp);if(!(r<=0)&&r<n){const e=vp.add();return e.node=t,e.distance=r,e}}_raycastUI2DNodeRecursiveChildren(e,t,i=Xc.Enum.UI_2D,n=1/0){const s=this._raycastUI2DNode(e,t,i,n);null!=s&&(yp[vp.length-1]=s);for(const s of t.children)null!=s&&s.active&&this._raycastUI2DNodeRecursiveChildren(e,s,i,n)}}const hp=cn.create(),up=new _i,_p=new wi;let dp=1/0;const mp=pn.create(),pp=new mo(()=>({node:null,distance:1/0}),8),fp=[],gp=new $r,vp=new mo(()=>({node:null,distance:1/0}),8),yp=[],xp=[],Sp=[],Tp=(e,t,i,n,s=1/0)=>{if(dp=s,i===wn.TRIANGLE_LIST){const i=t.length;for(let s=0;s<i;s+=3){const i=3*t[s],r=3*t[s+1],o=3*t[s+2];_i.set(mp.a,e[i],e[i+1],e[i+2]),_i.set(mp.b,e[r],e[r+1],e[r+2]),_i.set(mp.c,e[o],e[o+1],e[o+2]);const a=zr.ray_triangle(hp,mp,n);a<=0||a>=dp||(dp=a)}}else if(i===wn.TRIANGLE_STRIP){const i=t.length-2;let s=0;for(let r=0;r<i;r+=1){const i=3*t[r-s],o=3*t[r+s+1],a=3*t[r+2];_i.set(mp.a,e[i],e[i+1],e[i+2]),_i.set(mp.b,e[o],e[o+1],e[o+2]),_i.set(mp.c,e[a],e[a+1],e[a+2]),s=~s;const c=zr.ray_triangle(hp,mp,n);c<=0||c>=dp||(dp=c)}}else if(i===wn.TRIANGLE_FAN){const i=t.length-1,s=3*t[0];_i.set(mp.a,e[s],e[s+1],e[s+2]);for(let s=1;s<i;s+=1){const i=3*t[s],r=3*t[s+1];_i.set(mp.b,e[i],e[i+1],e[i+2]),_i.set(mp.c,e[r],e[r+1],e[r+2]);const o=zr.ray_triangle(hp,mp,n);o<=0||o>=dp||(dp=o)}}};Ui(lp.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastAllCanvas"},{name:"raycastUI2D",newName:"raycastAllCanvas"},{name:"raycast",newName:"raycastAllModels"},{name:"raycastModels",newName:"raycastAllModels"},{name:"raycastModel",newName:"raycastSingleModel"}]),Gi(lp.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Hi(lp.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect in geometry"},{name:"raycastAllModels",suggest:"using intersect in geometry"},{name:"raycastSingleModel",suggest:"using intersect in geometry"},{name:"raycastAllCanvas",suggest:"using intersect in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);const Ep={};Gi(Ep,"CameraVisFlags",[{name:"GENERAL"}]),Ui(Ep,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Xc.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Xc.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Xc.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Xc.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Xc.BitMask,targetName:"UI_2D"}]),i.CameraVisFlags=Ep;const Ap={};function Cp(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);const i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),s=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),r=2*n-8*s+4,o=3*n/r,a=2*s/r,c=1/a*o,l=1/a*(1-o-a);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}let bp;Gi(Ap,"VisibilityFlags",[{name:"GENERAL"}]),Ui(Ap,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Xc.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Xc.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Xc.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Xc.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Xc.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Xc.Enum,targetName:"UI_2D"}]),i.VisibilityFlags=Ap,Ui(Qh.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(bp||(bp={}));const Rp=e=>4*Math.PI*Math.PI*e*e;class wp{set color(e){this._color.set(e)}get color(){return this._color}set useColorTemperature(e){this._useColorTemp=e}get useColorTemperature(){return this._useColorTemp}set colorTemperature(e){this._colorTemp=e,Cp(this._colorTempRGB,this._colorTemp)}get colorTemperature(){return this._colorTemp}get colorTemperatureRGB(){return this._colorTempRGB}set node(e){this._node=e,this._node&&(this._node.hasChangedFlags|=K_.ROTATION)}get node(){return this._node}get type(){return this._type}get name(){return this._name}get scene(){return this._scene}constructor(){this._color=new _i(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new _i(1,1,1),this._scene=null,this._node=null,this._type=void 0,this._name=null,this._type=bp.UNKNOWN}initialize(e,t){this._name=e,this._type=bp.UNKNOWN,this._node=t}attachToScene(e){this._scene=e}detachFromScene(){this._scene=null}destroy(){this._name=null,this._type=bp.UNKNOWN,this._node=null}update(){}}const Ip=new _i(0,0,-1),Op=new _i,Pp=new Si;class Mp extends wp{set shadowRange(e){this._shadowRange=e}get shadowRange(){return this._shadowRange}set shadowIntensitywRange(e){this._shadowIntensity=e}get shadowIntensity(){return this._shadowIntensity}set shadowFadeDistance(e){this._shadowFadeDistance=e}get shadowFadeDistance(){return this._shadowFadeDistance}set shadowDistance(e){this._shadowDistance=e}get shadowDistance(){return this._shadowDistance}set fadeStart(e){this._fadeStart=e}get fadeStart(){return this._fadeStart}set splits(e){this._splits=e}get splits(){return this._splits}set biasAutoAdjust(e){this._biasAutoAdjust=e}get biasAutoAdjust(){return this._biasAutoAdjust}set direction(e){this._dir=e,_i.normalize(this._dir,this._dir)}get direction(){return this._dir}set illuminance(e){this._illum=e}get illuminance(){return this._illum}constructor(){super(),this._dir=new _i(1,-1,-1),this._illum=Ym.SUN_ILLUM,this._shadowRange=1e3,this._shadowIntensity=0,this._shadowFadeDistance=0,this._shadowDistance=0,this._fadeStart=.8,this._splits=new fi(1,0,0,0),this._biasAutoAdjust=1,this._type=bp.DIRECTIONAL}update(){this._node&&this._node.hasChangedFlags&&(this._dir=_i.transformQuat(Op,Ip,this._node.getWorldRotation(Pp)),_i.normalize(this._dir,this._dir))}}class Dp{static getOrCreatePipelineState(e,t,i,n,s){const r=Fh.get(t,Nh.HASH)^n.hash^s.attributesHash^i.id;let o=this._PSOHashMap.get(r);if(!o){const a=Bh.get(Fh.get(t,Nh.PIPELINE_LAYOUT)),c=new Ns;c.attributes=s.attributes,o=e.createPipelineState({primitive:Fh.get(t,Nh.PRIMITIVE),rasterizerState:Ih.get(Fh.get(t,Nh.RASTERIZER_STATE)),depthStencilState:Oh.get(Fh.get(t,Nh.DEPTH_STENCIL_STATE)),blendState:Ph.get(Fh.get(t,Nh.BLEND_STATE)),dynamicStates:Fh.get(t,Nh.DYNAMIC_STATES),inputState:c,renderPass:n,shader:i,pipelineLayout:a}),this._PSOHashMap.set(r,o)}return o}}Dp._PSOHashMap=new Map;const Lp=new _i(0,0,-1),Bp=new _i,Np=new $r,Fp=new Si,zp=(new _i(0,1,0),new _i),Up=new _i,Gp=new wi,Hp=Ye({Planar:0,ShadowMap:1}),Vp=Ye({HARD:0,FILTER_X5:1,FILTER_X9:2,FILTER_X25:3});class kp{constructor(){this._enabled=!1,this._type=Hp.Planar,this._normal=new _i(0,1,0),this._distance=0,this._shadowColor=new Fi(0,0,0,76),this._matLight=new wi,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._record=new Map,this._pendingModels=[],this._material=null,this._instancingMaterial=null,this._device=null,this._globalDescriptorSet=null,this._dirty=!0,this._sphere=new mn(0,0,0,.01),this.near=1,this.far=30,this.aspect=1,this.orthoSize=1,this.size=new ci(512,512),this.pcf=Vp.HARD}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._dirty=!0,this._enabled?this.activate():this._updatePipeline())}get normal(){return this._normal}set normal(e){_i.copy(this._normal,e),this._dirty=!0}get distance(){return this._distance}set distance(e){this._distance=e,this._dirty=!0}get shadowColor(){return this._shadowColor}set shadowColor(e){this._shadowColor=e,this._enabled&&(Fi.toArray(this._data,e,cl.SHADOW_COLOR_OFFSET),this._globalDescriptorSet&&this._globalDescriptorSet.getBuffer(cl.BLOCK.binding).update(this.data)),this._dirty=!0}get type(){return this._enabled?this._type:-1}set type(e){this._type=e,this._updatePipeline(),this._updatePlanarInfo()}get matLight(){return this._matLight}get data(){return this._data}get sphere(){return this._sphere}activate(){const e=i.director.root.pipeline;this._globalDescriptorSet=e.descriptorSet,this._data=e.shadowUBO,Fi.toArray(this._data,this._shadowColor,cl.SHADOW_COLOR_OFFSET),this._globalDescriptorSet.getBuffer(cl.BLOCK.binding).update(this._data),this._type===Hp.ShadowMap?this._updatePipeline():this._updatePlanarInfo()}getWorldMatrix(e,t){_i.negate(zp,t);const i=Math.sqrt(2)*this._sphere.radius;return _i.multiplyScalar(Up,zp,i),_i.add(Up,Up,this._sphere.center),wi.fromRT(Gp,e,Up),Gp}_updatePlanarInfo(){this._dirty=!0,this._material||(this._material=new Lu,this._material.initialize({effectName:"pipeline/planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Lu,this._instancingMaterial.initialize({effectName:"pipeline/planar-shadow",defines:{USE_INSTANCING:!0}}))}_updatePipeline(){const e=i.director.root,t=e.pipeline;this._enabled&&this._type===Hp.ShadowMap?delete t.macros.CC_RECEIVE_SHADOW:t.macros.CC_RECEIVE_SHADOW=!1,e.onGlobalPipelineStateChanged()}updateSphereLight(e){if(!e.node.hasChangedFlags&&!this._dirty)return;this._dirty=!1,e.node.getWorldPosition(Bp);const t=this._normal,i=this._distance+.001,n=_i.dot(t,Bp),s=Bp.x,r=Bp.y,o=Bp.z,a=t.x,c=t.y,l=t.z,h=this._matLight;h.m00=n-i-s*a,h.m01=-r*a,h.m02=-o*a,h.m03=-a,h.m04=-s*c,h.m05=n-i-r*c,h.m06=-o*c,h.m07=-c,h.m08=-s*l,h.m09=-r*l,h.m10=n-i-o*l,h.m11=-l,h.m12=s*i,h.m13=r*i,h.m14=o*i,h.m15=n,wi.toArray(this._data,this._matLight,cl.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalDescriptorSet.getBuffer(cl.BLOCK.binding).update(this.data)}updateDirLight(e){if(!e.node.hasChangedFlags&&!this._dirty)return;this._dirty=!1,e.node.getWorldRotation(Fp),_i.transformQuat(Bp,Lp,Fp);const t=this._normal,i=this._distance+.001,n=1/_i.dot(t,Bp),s=Bp.x*n,r=Bp.y*n,o=Bp.z*n,a=t.x,c=t.y,l=t.z,h=this._matLight;h.m00=1-a*s,h.m01=-a*r,h.m02=-a*o,h.m03=0,h.m04=-c*s,h.m05=1-c*r,h.m06=-c*o,h.m07=0,h.m08=-l*s,h.m09=-l*r,h.m10=1-l*o,h.m11=0,h.m12=s*i,h.m13=r*i,h.m14=o*i,h.m15=1,wi.toArray(this._data,this._matLight,cl.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalDescriptorSet.getBuffer(cl.BLOCK.binding).update(this.data)}updateShadowList(e,t,i=!1){if(this._pendingModels.length=0,!e.mainLight||!i)return;const n=e.models;for(let e=0;e<n.length;e++){const i=n[e];if(!i.enabled||!i.node||!i.castShadow)continue;if(i.worldBounds&&($r.transform(Np,i.worldBounds,this._matLight),!zr.aabb_frustum(Np,t)))continue;let s=this._record.get(i);s&&!!s.instancedBuffer!==i.isInstancingEnabled&&(this.destroyShadowData(i),s=void 0),s||(s=this.createShadowData(i),this._record.set(i,s)),this._pendingModels.push(s)}}recordCommandBuffer(e,t,i){this._device=e;const n=this._pendingModels,s=n.length;if(!s)return;const r=Tm.get(this._instancingMaterial.passes[0]);r&&r.clear();const o=this._material.passes[0].handle;let a=Dh.get(Fh.get(o,Nh.DESCRIPTOR_SET));i.bindDescriptorSet(rl.MATERIAL,a);for(let r=0;r<s;r++){const{model:s,hShaders:a,instancedBuffer:c}=n[r];for(let n=0;n<a.length;n++){const r=s.subModels[n],l=a[n];if(c)c.merge(r,s.instancedAttributes,0,l);else{const n=r.inputAssembler,s=Mh.get(l),a=Dp.getOrCreatePipelineState(e,o,s,t,n);i.bindPipelineState(a),i.bindDescriptorSet(rl.LOCAL,r.descriptorSet),i.bindInputAssembler(n),i.draw(n)}}}if(r&&r.hasPendingModels){r.uploadBuffers(),a=Dh.get(Fh.get(r.hPass,Nh.DESCRIPTOR_SET)),i.bindDescriptorSet(rl.MATERIAL,a);let n=null;for(let s=0;s<r.instances.length;++s){const o=r.instances[s];if(!o.count)continue;const a=Mh.get(o.hShader),c=Dp.getOrCreatePipelineState(e,r.hPass,a,t,o.ia);n!==c&&(i.bindPipelineState(c),i.bindDescriptorSet(rl.LOCAL,Dh.get(o.hDescriptorSet)),n=c),i.bindInputAssembler(o.ia),i.draw(o.ia)}}}createShadowData(e){const t=[],i=e.isInstancingEnabled?this._instancingMaterial:this._material,n=e.isInstancingEnabled?Tm.get(i.passes[0]):null,s=e.subModels;for(let n=0;n<s.length;n++){const s=i.passes[0].getShaderVariant(e.getMacroPatches(n));t.push(s)}return{model:e,hShaders:t,instancedBuffer:n}}destroyShadowData(e){this._record.delete(e)}destroy(){this._record.clear(),this._material&&this._material.destroy()}}function Wp(e,t){if(!t){const e=i.director.getScene();if(!e)return null;t=e}return t.getChildByPath(e)}var jp;i.find=Wp,function(e){e[e.positions=Sn.ATTR_POSITION]="positions",e[e.normals=Sn.ATTR_NORMAL]="normals",e[e.uvs=Sn.ATTR_TEX_COORD]="uvs",e[e.colors=Sn.ATTR_COLOR]="colors"}(jp||(jp={}));const qp=[{name:Sn.ATTR_POSITION,format:En.RGB32F},{name:Sn.ATTR_NORMAL,format:En.RGB32F},{name:Sn.ATTR_TEX_COORD,format:En.RG32F},{name:Sn.ATTR_TANGENT,format:En.RGBA32F},{name:Sn.ATTR_COLOR,format:En.RGBA32F}],Xp=new _i;function Yp(e,t,i){i=i||{};const n=[];let s=0;const r=[];let o,a=0;const c=e.positions.slice();if(c.length>0){if(o=null,e.attributes)for(const t of e.attributes)if(t.name===Sn.ATTR_POSITION){o=t;break}o||(o=qp[0]),n.push(o);const t=_s[o.format];a=Math.max(a,Math.floor(c.length/t.count)),r.push({offset:s,data:c,attribute:o}),s+=t.size}if(e.normals&&e.normals.length>0){if(o=null,e.attributes)for(const t of e.attributes)if(t.name===Sn.ATTR_NORMAL){o=t;break}o||(o=qp[1]);const t=_s[o.format];n.push(o),a=Math.max(a,Math.floor(e.normals.length/t.count)),r.push({offset:s,data:e.normals,attribute:o}),s+=t.size}if(e.uvs&&e.uvs.length>0){if(o=null,e.attributes)for(const t of e.attributes)if(t.name===Sn.ATTR_TEX_COORD){o=t;break}o||(o=qp[2]);const t=_s[o.format];n.push(o),a=Math.max(a,Math.floor(e.uvs.length/t.count)),r.push({offset:s,data:e.uvs,attribute:o}),s+=t.size}if(e.tangents&&e.tangents.length>0){if(o=null,e.attributes)for(const t of e.attributes)if(t.name===Sn.ATTR_TANGENT){o=t;break}o||(o=qp[3]);const t=_s[o.format];n.push(o),a=Math.max(a,Math.floor(e.tangents.length/t.count)),r.push({offset:s,data:e.tangents,attribute:o}),s+=t.size}if(e.colors&&e.colors.length>0){if(o=null,e.attributes)for(const t of e.attributes)if(t.name===Sn.ATTR_COLOR){o=t;break}o||(o=qp[4]);const t=_s[o.format];n.push(o),a=Math.max(a,Math.floor(e.colors.length/t.count)),r.push({offset:s,data:e.colors,attribute:o}),s+=t.size}if(e.customAttributes)for(const t of e.customAttributes){const e=_s[t.attr.format];n.push(t.attr),a=Math.max(a,Math.floor(t.values.length/e.count)),r.push({offset:s,data:t.values,attribute:t.attr}),s+=e.size}const l=new Na,h=new ArrayBuffer(a*s),u=new DataView(h);for(const e of r)Da(u,e.data,e.attribute.format,e.offset,s);l.setNextAlignment(0);const _={attributes:n,view:{offset:l.getLength(),length:h.byteLength,count:a,stride:s}};l.addBuffer(h);let d=null,m=0;if(e.indices){const{indices:t}=e;m=t.length,d=new ArrayBuffer(2*m);Da(new DataView(d),t,En.R16UI)}const p={primitiveMode:e.primitiveMode||wn.TRIANGLE_LIST,vertexBundelIndices:[0]};d&&(l.setNextAlignment(2),p.indexView={offset:l.getLength(),length:d.byteLength,count:m,stride:2},l.addBuffer(d));let f=e.minPos;if(!f&&i.calculateBounds){f=_i.set(new _i,1/0,1/0,1/0);for(let e=0;e<a;++e)_i.set(Xp,c[3*e+0],c[3*e+1],c[3*e+2]),_i.min(f,f,Xp)}let g=e.maxPos;if(!g&&i.calculateBounds){g=_i.set(new _i,-1/0,-1/0,-1/0);for(let e=0;e<a;++e)_i.set(Xp,c[3*e+0],c[3*e+1],c[3*e+2]),_i.max(g,g,Xp)}const v={vertexBundles:[_],primitives:[p]};return f&&(v.minPosition=new _i(f.x,f.y,f.z)),g&&(v.maxPosition=new _i(g.x,g.y,g.z)),t||(t=new Hl),t.reset({struct:v,data:new Uint8Array(l.getCombined())}),t}var Kp=Object.freeze({__proto__:null,find:Wp,toPPM:function(e,t,i){return`P3 ${t} ${i} 255\n${e.filter((e,t)=>t%4<3).toString()}\n`},readMesh:function(e,t=0){const i={positions:[]},n=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),s=e.struct,r=s.primitives[t];for(const e of r.vertexBundelIndices){const t=s.vertexBundles[e];let r=t.view.offset;const{length:o,stride:a}=t.view;for(const e of t.attributes){const t=jp[e.name];t&&(i[t]=(i[t]||[]).concat(La(n,e.format,r,o,a))),r+=_s[e.format].size}}const o=r.indexView;return i.indices=La(n,En[`R${8*o.stride}UI`],o.offset,o.length),i},createMesh:Yp,readBuffer:La,writeBuffer:Da,mapBuffer:Ba});function Zp(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function $p(e){const t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,s=(e.width||1)/2,r=(e.height||1)/2,o=(e.length||1)/2,a=[_i.set(nf,-s,-r,o),_i.set(sf,s,-r,o),_i.set(rf,s,r,o),_i.set(of,-s,r,o),_i.set(af,s,-r,-o),_i.set(cf,-s,-r,-o),_i.set(lf,-s,r,-o),_i.set(hf,s,r,-o)],c=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],h=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],u=[],_=[],d=[],m=[],p=[],f=new _i(-s,-r,-o),g=new _i(s,r,o),v=Math.sqrt(s*s+r*r+o*o);function y(e,t,i){let n,s,r,o;const f=u.length/3,g=c[e],v=l[e],y=h[e];for(o=0;o<=i;o++)for(r=0;r<=t;r++)if(n=r/t,s=o/i,_i.lerp(Qp,a[g[0]],a[g[1]],n),_i.lerp(Jp,a[g[0]],a[g[2]],s),_i.subtract(ef,Jp,a[g[0]]),_i.add(tf,Qp,ef),u.push(tf.x,tf.y,tf.z),_.push(v[0],v[1],v[2]),d.push(n,s),m.push(y[0],y[1],y[2],y[3]),r<t&&o<i){const e=t+1,i=r+o*e,n=r+(o+1)*e,s=r+1+(o+1)*e,a=r+1+o*e;p.push(f+i,f+a,f+n),p.push(f+n,f+a,f+s)}}return y(0,t,i),y(4,n,i),y(1,t,i),y(5,n,i),y(3,t,n),y(2,t,n),{positions:u,normals:_,uvs:d,tangents:m,indices:p,minPos:f,maxPos:g,boundingRadius:v}}e("utils",Kp);const Qp=new _i,Jp=new _i,ef=new _i,tf=new _i,nf=new _i,sf=new _i,rf=new _i,of=new _i,af=new _i,cf=new _i,lf=new _i,hf=new _i,uf=new _i(0,0,0),_f=new _i(0,0,0);function df(e=.5,t=.5,i=2,n={}){const s=.5*i,r=n.radialSegments||32,o=n.heightSegments||1,a=void 0===n.capped||n.capped,c=n.arc||2*Math.PI;let l=0;a||(e>0&&l++,t>0&&l++);let h=(r+1)*(o+1);a&&(h+=(r+1)*l+r*l);let u=r*o*2*3;a&&(u+=r*l*3);const _=new Array(u),d=new Array(3*h),m=new Array(3*h),p=new Array(2*h),f=Math.max(e,t),g=new _i(-f,-s,-f),v=new _i(f,s,f),y=Math.sqrt(f*f+s*s);let x=0,S=0;return function(){const n=[],a=e-t,l=a*a/i*Math.sign(a);for(let e=0;e<=o;e++){const h=[],u=e/o,_=u*a+t;for(let e=0;e<=r;++e){const t=e/r,n=t*c,o=Math.sin(n),a=Math.cos(n);d[3*x]=_*o,d[3*x+1]=u*i-s,d[3*x+2]=_*a,_i.normalize(uf,_i.set(_f,o,-l,a)),m[3*x]=uf.x,m[3*x+1]=uf.y,m[3*x+2]=uf.z,p[2*x]=2*(1-t)%1,p[2*x+1]=u,h.push(x),++x}n.push(h)}for(let e=0;e<o;++e)for(let t=0;t<r;++t){const i=n[e][t],s=n[e+1][t],r=n[e+1][t+1],o=n[e][t+1];_[S]=i,++S,_[S]=o,++S,_[S]=s,++S,_[S]=o,++S,_[S]=r,++S,_[S]=s,++S}}(),a&&(t>0&&T(!1),e>0&&T(!0)),{positions:d,normals:m,uvs:p,indices:_,minPos:g,maxPos:v,boundingRadius:y};function T(i){const n=i?e:t,o=i?1:-1,a=x;for(let e=1;e<=r;++e)d[3*x]=0,d[3*x+1]=s*o,d[3*x+2]=0,m[3*x]=0,m[3*x+1]=o,m[3*x+2]=0,p[2*x]=.5,p[2*x+1]=.5,++x;const l=x;for(let e=0;e<=r;++e){const t=e/r*c,i=Math.cos(t),a=Math.sin(t);d[3*x]=n*a,d[3*x+1]=s*o,d[3*x+2]=n*i,m[3*x]=0,m[3*x+1]=o,m[3*x+2]=0,p[2*x]=.5-.5*a*o,p[2*x+1]=.5+.5*i,++x}for(let e=0;e<r;++e){const t=a+e,n=l+e;i?(_[S]=n+1,++S,_[S]=t,++S,_[S]=n,++S):(_[S]=t,++S,_[S]=n+1,++S,_[S]=n,++S)}}}const mf=new _i(0,0,0),pf=new _i(0,0,0),ff=new _i(0,0,0),gf=new _i(0,0,0),vf=new _i(0,0,0),yf=new _i(0,0,0),xf=new _i(0,0,0);const Sf=new _i(0,0,0),Tf=new _i(0,0,0);var Ef=Object.freeze({__proto__:null,box:$p,cone:function(e=.5,t=1,i={}){return df(0,e,t,i)},cylinder:df,plane:function(e){const t=function(e){return(e=Zp(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),{width:i,length:n,widthSegments:s,lengthSegments:r}=t,o=.5*i,a=.5*n,c=[],l=[],h=[],u=new _i(-o,0,-a),_=new _i(o,0,a),d=Math.sqrt(i*i+n*n);_i.set(vf,-o,0,a),_i.set(yf,o,0,a),_i.set(xf,-o,0,-a);for(let e=0;e<=r;e++)for(let i=0;i<=s;i++){const n=i/s,o=e/r;if(_i.lerp(mf,vf,yf,n),_i.lerp(pf,vf,xf,o),_i.subtract(ff,pf,vf),_i.add(gf,mf,ff),c.push(gf.x,gf.y,gf.z),t.includeUV&&l.push(n,o),i<s&&e<r){const t=s+1,n=i+e*t,r=i+(e+1)*t,o=i+1+(e+1)*t,a=i+1+e*t;h.push(n,a,r),h.push(a,o,r)}}const m={positions:c,indices:h,minPos:u,maxPos:_,boundingRadius:d};if(t.includeNormal){const e=(r+1)*(s+1),t=new Array(3*e);m.normals=t;for(let i=0;i<e;++i)t[3*i+0]=0,t[3*i+1]=1,t[3*i+2]=0}return t.includeUV&&(m.uvs=l),m},quad:function(e){const t=Zp(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},sphere:function(e=.5,t={}){const i=void 0!==t.segments?t.segments:32,n=[],s=[],r=[],o=[],a=new _i(-e,-e,-e),c=new _i(e,e,e),l=e;for(let t=0;t<=i;++t){const a=t*Math.PI/i,c=Math.sin(a),l=-Math.cos(a);for(let a=0;a<=i;++a){const h=2*a*Math.PI/i-Math.PI/2,u=Math.sin(h)*c,_=l,d=Math.cos(h)*c,m=a/i,p=t/i;if(n.push(u*e,_*e,d*e),s.push(u,_,d),r.push(m,p),t<i&&a<i){const e=i+1,n=e*t+a,s=e*(t+1)+a,r=e*(t+1)+a+1,c=e*t+a+1;o.push(n,c,s),o.push(c,r,s)}}}return{positions:n,indices:o,normals:s,uvs:r,minPos:a,maxPos:c,boundingRadius:l}},torus:function(e=.4,t=.1,i={}){const n=i.radialSegments||32,s=i.tubularSegments||32,r=i.arc||2*Math.PI,o=[],a=[],c=[],l=[],h=new _i(-e-t,-t,-e-t),u=new _i(e+t,t,e+t),_=e+t;for(let i=0;i<=n;i++)for(let h=0;h<=s;h++){const u=h/s,_=i/n,d=u*r,m=_*Math.PI*2,p=(e+t*Math.cos(m))*Math.sin(d),f=t*Math.sin(m),g=(e+t*Math.cos(m))*Math.cos(d),v=Math.sin(d)*Math.cos(m),y=Math.sin(m),x=Math.cos(d)*Math.cos(m);if(o.push(p,f,g),a.push(v,y,x),c.push(u,_),h<s&&i<n){const e=s+1,t=e*i+h,n=e*(i+1)+h,r=e*(i+1)+h+1,o=e*i+h+1;l.push(t,o,n),l.push(o,r,n)}}return{positions:o,normals:a,uvs:c,indices:l,minPos:h,maxPos:u,boundingRadius:_}},capsule:function(e=.5,t=.5,i=2,n={}){const s=i-e-t,r=n.sides||32,o=n.heightSegments||32,a=t/i,c=s/i,l=e/i,h=Math.floor(o*a),u=Math.floor(o*l),_=Math.floor(o*c),d=s+t-i/2,m=t-i/2,p=t-i/2,f=n.arc||2*Math.PI,g=[],v=[],y=[],x=[],S=Math.max(e,t),T=new _i(-S,-i/2,-S),E=new _i(S,i/2,S),A=i/2;let C=0;const b=[];return function(){for(let e=0;e<=h;++e){const i=e*Math.PI/h/2,n=Math.sin(i),s=-Math.cos(i);for(let i=0;i<=r;++i){const a=2*i*Math.PI/r-Math.PI/2,c=Math.sin(a),l=Math.cos(a),u=c*n,_=s,d=l*n,m=i/r,f=e/o;if(g.push(u*t,_*t+p,d*t),v.push(u,_,d),y.push(m,f),e<h&&i<r){const t=r+1,n=t*e+i,s=t*(e+1)+i,o=t*(e+1)+i+1,a=t*e+i+1;x.push(n,a,s),x.push(a,o,s)}++C}}}(),function(){const i=(e-t)/s;for(let n=0;n<=_;n++){const o=[],l=n/_,h=l*(e-t)+t;for(let e=0;e<=r;++e){const t=e/r,n=l*c+a,u=t*f-f/4,_=Math.sin(u),d=Math.cos(u);g.push(h*_),g.push(l*s+m),g.push(h*d),_i.normalize(Sf,_i.set(Tf,_,-i,d)),v.push(Sf.x),v.push(Sf.y),v.push(Sf.z),y.push(t,n),o.push(C),++C}b.push(o)}for(let e=0;e<_;++e)for(let t=0;t<r;++t){const i=b[e][t],n=b[e+1][t],s=b[e+1][t+1],r=b[e][t+1];x.push(i),x.push(r),x.push(n),x.push(r),x.push(s),x.push(n)}}(),function(){for(let t=0;t<=u;++t){const i=t*Math.PI/u/2+Math.PI/2,n=Math.sin(i),s=-Math.cos(i);for(let i=0;i<=r;++i){const a=2*i*Math.PI/r-Math.PI/2,c=Math.sin(a),h=Math.cos(a),m=c*n,p=s,f=h*n,S=i/r,T=t/o+(1-l);if(g.push(m*e,p*e+d,f*e),v.push(m,p,f),y.push(S,T),t<u&&i<r){const e=r+1,n=e*t+i+b[_][r]+1,s=e*(t+1)+i+b[_][r]+1,o=e*(t+1)+i+1+b[_][r]+1,a=e*t+i+1+b[_][r]+1;x.push(n,a,s),x.push(a,o,s)}}}}(),{positions:g,normals:v,uvs:y,indices:x,minPos:T,maxPos:E,boundingRadius:A}},circle:function(e){const t=function(e){return(e=Zp(e)).segments=64,e}(e).segments,i=new Array(3*(t+1));i[0]=0,i[1]=0,i[2]=0;const n=new Array(1+2*t);n[0]=0;const s=2*Math.PI/t;for(let e=0;e<t;++e){const t=s*e,r=Math.cos(t),o=Math.sin(t),a=3*(e+1);i[a+0]=r,i[a+1]=o,i[a+2]=0;const c=2*e;n[1+c]=e+1,n[1+(c+1)]=e+2}return t>0&&(n[n.length-1]=1),{positions:i,indices:n,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:wn.TRIANGLE_FAN}},translate:function(e,t){const i=t.x||0,n=t.y||0,s=t.z||0,r=Math.floor(e.positions.length/3);for(let t=0;t<r;++t){const r=3*t,o=3*t+1,a=3*t+2;e.positions[r]=e.positions[r]+i,e.positions[o]=e.positions[o]+n,e.positions[a]=e.positions[a]+s}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=n,e.minPos.z+=s),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=n,e.maxPos.z+=s),e},scale:function(e,t){const i=t.x||0,n=t.y||0,s=t.z||0,r=Math.floor(e.positions.length/3);for(let t=0;t<r;++t){const r=3*t,o=3*t+1,a=3*t+2;e.positions[r]*=i,e.positions[o]*=n,e.positions[a]*=s}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=n,e.minPos.z*=s),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=n,e.maxPos.z*=s),e.boundingRadius=Math.max(Math.max(i,n),s),e},wireframed:function(e){const{indices:t}=e;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==wn.TRIANGLE_LIST)return e;const i=[[0,1],[1,2],[2,0]],n=[],s={};for(let e=0;e<t.length;e+=3)for(let r=0;r<3;++r){const o=t[e+i[r][0]],a=t[e+i[r][1]],c=o>a?a<<16|o:o<<16|a;void 0===s[c]&&(s[c]=0,n.push(o,a))}return e.indices=n,e.primitiveMode=wn.LINE_LIST,e},wireframe:function(e){const t=[[0,1],[1,2],[2,0]],i=[],n={};for(let s=0;s<e.length;s+=3)for(let r=0;r<3;++r){const o=e[s+t[r][0]],a=e[s+t[r][1]],c=o>a?a<<16|o:o<<16|a;void 0===n[c]&&(n[c]=0,i.push(o,a))}return i},invWinding:function(e){const t=[];for(let i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t},toWavefrontOBJ:function(e,t=1){if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==wn.TRIANGLE_LIST)return"";const i=e.positions,n=e.uvs,s=e.normals,r=e.indices,o=e=>`${r[e]+1}/${r[e]+1}/${r[e]+1}`;let a="";for(let e=0;e<i.length;e+=3)a+=`v ${i[e]*t} ${i[e+1]*t} ${i[e+2]*t}\n`;for(let e=0;e<n.length;e+=2)a+=`vt ${n[e]} ${n[e+1]}\n`;for(let e=0;e<s.length;e+=3)a+=`vn ${s[e]} ${s[e+1]} ${s[e+2]}\n`;for(let e=0;e<r.length;e+=3)a+=`f ${o(e)} ${o(e+1)} ${o(e+2)}\n`;return a},normals:function(e,t,i=1){const n=new Array(2*e.length);for(let s=0;s<e.length/3;++s){const r=3*s,o=6*s;n[o+0]=e[r+0],n[o+1]=e[r+1],n[o+2]=e[r+2],n[o+3]=e[r+0]+t[r+0]*i,n[o+4]=e[r+1]+t[r+1]*i,n[o+5]=e[r+2]+t[r+2]*i}return n},applyDefaultGeometryOptions:Zp});e("primitives",Ef);let Af=null,Cf=null;class bf{constructor(){this._enabled=!1,this._isRGBE=!1,this._useIBL=!1,this._envmap=null,this._globalDescriptorSet=null,this._model=null,this._default=null}get model(){return this._model}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._enabled?this.activate():this._updatePipeline())}get useIBL(){return this._useIBL}set useIBL(e){this._useIBL=e,this._updatePipeline()}get isRGBE(){return this._isRGBE}set isRGBE(e){this._isRGBE=e,this._enabled&&(Cf&&Cf.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this._model&&this._model.setSubModelMaterial(0,Cf)),this._updatePipeline()}get envmap(){return this._envmap}set envmap(e){this._envmap=e||this._default,this._envmap&&(i.director.root.pipeline.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}activate(){const e=i.director.root.pipeline;if(this._globalDescriptorSet=e.descriptorSet,this._default=Th.get("default-cube-texture"),this._model||(this._model=new Im),Cf)Cf.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE});else{const e=new Lu;e.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:this._isRGBE}}),Cf=new Nu({parent:e})}Af||(Af=Yp($p({width:2,height:2,length:2}))),this._model.initSubModel(0,Af.renderingSubMeshes[0],Cf),this.envmap=this._envmap,this._updatePipeline()}_updatePipeline(){const e=this._useIBL?this._isRGBE?2:1:0,t=i.director.root,n=t.pipeline;n.macros.CC_USE_IBL!==e&&(n.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())}_updateGlobalBinding(){const e=this.envmap.getGFXTexture(),t=xc.getSampler(i.director._device,this.envmap.getSamplerHash());this._globalDescriptorSet.bindSampler(hl.binding,t),this._globalDescriptorSet.bindTexture(hl.binding,e)}}class Rf extends wp{get position(){return this._pos}set size(e){this._size=e}get size(){return this._size}set range(e){this._range=e,this._needUpdate=!0}get range(){return this._range}set luminance(e){this._luminance=e}get luminance(){return this._luminance}get aabb(){return this._aabb}constructor(){super(),this._needUpdate=!1,this._size=.15,this._range=1,this._luminance=1700/Rp(this._size),this._pos=void 0,this._aabb=void 0,this._type=bp.SPHERE,this._aabb=$r.create(),this._pos=new _i}update(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),$r.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._needUpdate=!1)}}const wf=new _i(0,0,-1),If=new Si,Of=new wi,Pf=new wi,Mf=new wi,Df=new wi;class Lf extends wp{get position(){return this._pos}set size(e){this._size=e}get size(){return this._size}set range(e){this._range=e,this._needUpdate=!0}get range(){return this._range}set luminance(e){this._luminance=e}get luminance(){return this._luminance}get direction(){return this._dir}get spotAngle(){return this._spotAngle}set spotAngle(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}get aabb(){return this._aabb}get frustum(){return this._frustum}constructor(){super(),this._dir=new _i(1,-1,-1),this._size=.15,this._range=5,this._luminance=1700/Rp(this._size),this._spotAngle=Math.cos(Math.PI/6),this._pos=void 0,this._aabb=void 0,this._frustum=void 0,this._angle=0,this._needUpdate=!1,this._type=bp.SPOT,this._aabb=$r.create(),this._frustum=no.create(),this._pos=new _i}update(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),_i.transformQuat(this._dir,wf,this._node.getWorldRotation(If)),_i.normalize(this._dir,this._dir),$r.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Of),wi.invert(Of,Of),wi.perspective(Pf,this._angle,1,.001,this._range),wi.multiply(Mf,Pf,Of),this._frustum.update(Mf,Df),this._needUpdate=!1)}}var Bf=Object.freeze({__proto__:null,Ambient:Ym,get CameraFOVAxis(){return Km},get CameraProjection(){return Zm},get CameraAperture(){return $m},get CameraISO(){return Qm},get CameraShutter(){return Jm},SKYBOX_FLAG:ap,Camera:cp,CameraVisFlags:Ep,VisibilityFlags:Ap,DirectionalLight:Mp,ColorTemperatureToRGB:Cp,get LightType(){return bp},nt2lm:Rp,Light:wp,get ModelType(){return bm},Model:Im,ShadowType:Hp,PCFType:Vp,Shadows:kp,RenderScene:lp,Skybox:bf,SphereLight:Rf,SpotLight:Lf,SubModel:Sm});class Nf{constructor(){this.material=null,this.vertexCount=0,this.indicesCount=0}}class Ff extends Nf{constructor(...e){super(...e),this.vData=null,this.uvDirty=!0,this.vertDirty=!0,this._data=[],this._indices=[],this._pivotX=0,this._pivotY=0,this._width=0,this._height=0}get dataLength(){return this._data.length}set dataLength(e){const t=this._data;if(t.length!==e){const i=t.length;let n=0;for(n=e;n<i;n++)Uf.free(t[n]);for(n=i;n<e;n++)t[n]=Uf.alloc();t.length=e}}get data(){return this._data}static add(){return Gf.add()}static remove(e){const t=Gf.data.indexOf(e);-1!==t&&(Gf.data[t].clear(),Gf.removeAt(t))}updateSizeNPivot(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}clear(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0}}class zf extends Nf{constructor(...e){super(...e),this.vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),this.iData=new Uint16Array(1536),this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.byteCount=0,this._formatByte=9*Float32Array.BYTES_PER_ELEMENT}request(e,t){const i=this.byteCount+e*this._formatByte,n=this.indicesCount+t;if(e+this.vertexCount>65535)return!1;let s=this.vData.byteLength,r=this.iData.length,o=this.vData.length,a=this.iData.length;if(i>s||n>r){for(;s<i||r<n;)o*=2,a*=2,s=4*o,r=a;const e=new Float32Array(this.vData.buffer);this.vData=new Float32Array(o),this.vData.set(e,0);const t=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(a),this.iData.set(t,0)}return this.vertexCount+=e,this.indicesCount+=t,this.byteCount=i,!0}reset(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0}}const Uf=new _o(()=>({x:0,y:0,z:0,u:0,v:0,color:Fi.WHITE.clone()}),128),Gf=new mo(()=>new Ff,32),Hf=Kl.addStage;var Vf,kf,Wf,jf,qf,Xf,Yf,Kf,Zf=Object.freeze({__proto__:null,addStage:Hf,scene:Bf,models:Xm,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;const i=[],n=t.positions.length/3;for(let e=0;e<n;++e)i.push(t.positions[3*e],t.positions[3*e+1],t.positions[3*e+2]),t.normals&&i.push(t.normals[3*e],t.normals[3*e+1],t.normals[3*e+2]),t.uvs&&i.push(t.uvs[2*e],t.uvs[2*e+1]),t.colors&&i.push(t.colors[3*e],t.uvs[3*e+1],t.colors[3*e+2]);const s=[];s.push({name:Sn.ATTR_POSITION,format:En.RGB32F}),t.normals&&s.push({name:Sn.ATTR_NORMAL,format:En.RGB32F}),t.uvs&&s.push({name:Sn.ATTR_TEX_COORD,format:En.RG32F}),t.colors&&s.push({name:Sn.ATTR_COLOR,format:En.RGB32F});const r=e.createBuffer({usage:An.VERTEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:4*i.length,stride:4*i.length/n});r.update(new Float32Array(i));const o=e.createBuffer({usage:An.INDEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:2*t.indices.length,stride:2});return o.update(new Uint16Array(t.indices)),e.createInputAssembler({attributes:s,vertexBuffers:[r],indexBuffer:o})},get RenderQueue(){return Zl},get PassStage(){return $l},get PropertyType(){return Ql},genHandle:Jl,getPropertyTypeFromHandle:eh,getTypeFromHandle:th,getSetIndexFromHandle:e=>(3145728&e)>>>20,getBindingFromHandle:ih,getOffsetFromHandle:nh,customizeType:sh,type2reader:rh,type2writer:oh,getDefaultFromType:ch,overrideMacros:lh,get BatchingSchemes(){return $h},Pass:Qh,programLib:Xh,get SamplerInfoIndex(){return dc},defaultSamplerHash:fc,genSamplerHash:yc,samplerLib:xc,nearestPOT:Jh,TextureBufferPool:tu,MaterialInstance:Nu,PassInstance:Bu});e("renderer",Zf);const $f={parent:null,owner:null,subModelIdx:0};let Qf=e("RenderableComponent",(Vf=Go("cc.RenderableComponent"),kf=va([Lu]),Wf=va(Lu),jf=sa(),Vf((Yf=Po((Xf=class extends f_{constructor(...e){super(...e),Oo(this,"_materials",Yf,this),Oo(this,"_visFlags",Kf,this),this._materialInstances=[],this._models=[]}get visibility(){return this._visFlags}set visibility(e){this._visFlags=e,this._onVisibilityChange(e)}get sharedMaterials(){return this._materials}set sharedMaterials(e){for(let t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(let t=e.length;t<this._materials.length;t++)this.setMaterial(null,t);this._materials.splice(e.length)}}get materials(){for(let e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances}set materials(e){const t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(let e=this._materials.length-t;e<this._materials.length;++e)this.setMaterialInstance(e,null);for(let t=0;t<this._materialInstances.length;t++)this._materialInstances[t]!=e[t]&&this.setMaterialInstance(t,e[t])}get sharedMaterial(){return this.getMaterial(0)}getMaterial(e){return e<0||e>=this._materials.length?null:this._materials[e]}setMaterial(e,t){e&&e instanceof Nu&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;const i=this._materialInstances[t];i?i.parent!==this._materials[t]&&(i.destroy(),this._materialInstances[t]=null,this._onMaterialModified(t,this._materials[t])):this._onMaterialModified(t,this._materials[t])}get material(){return this.getMaterialInstance(0)}set material(e){1===this._materials.length&&this._materials[0]===e||this.setMaterialInstance(0,e)}getMaterialInstance(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){$f.parent=this._materials[e],$f.owner=this,$f.subModelIdx=e;const t=new Nu($f);this.setMaterialInstance(e,t)}return this._materialInstances[e]}setMaterialInstance(e,t){t&&t.parent?t!==this._materialInstances[e]&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):t!==this._materials[e]&&this.setMaterial(t,e)}getRenderMaterial(e){return this._materialInstances[e]||this._materials[e]}_collectModels(){return this._models}_attachToScene(){}_detachFromScene(){}_onMaterialModified(e,t){}_onRebuildPSO(e,t){}_clearMaterials(){}_onVisibilityChange(e){}}).prototype,"_materials",[kf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kf=Po(Xf.prototype,"_visFlags",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xc.Enum.NONE}}),Po(Xf.prototype,"sharedMaterials",[Wf,jf],Object.getOwnPropertyDescriptor(Xf.prototype,"sharedMaterials"),Xf.prototype),qf=Xf))||qf));var Jf,eg,tg,ig,ng,sg,rg,og,ag,cg,lg,hg,ug,_g,dg,mg,pg,fg,gg,vg,yg,xg,Sg,Tg,Eg,Ag,Cg,bg,Rg,wg;i.RenderableComponent=Qf;const Ig=Ye({OFF:0,ON:1}),Og=Ye({OFF:0,ON:1});let Pg=(Jf=Go("cc.ModelLightmapSettings"),eg=qo(Ko({formerlySerializedAs:"_recieveShadow"})),Jf((ng=Po((ig=class{constructor(){Oo(this,"texture",ng,this),Oo(this,"uvParam",sg,this),Oo(this,"_bakeable",rg,this),Oo(this,"_castShadow",og,this),Oo(this,"_receiveShadow",ag,this),Oo(this,"_lightmapSize",cg,this)}get bakeable(){return this._bakeable}set bakeable(e){this._bakeable=e}get castShadow(){return this._castShadow}set castShadow(e){this._castShadow=e}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){this._receiveShadow=e}get lightmapSize(){return this._lightmapSize}set lightmapSize(e){this._lightmapSize=e}}).prototype,"texture",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sg=Po(ig.prototype,"uvParam",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi}}),rg=Po(ig.prototype,"_bakeable",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),og=Po(ig.prototype,"_castShadow",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ag=Po(ig.prototype,"_receiveShadow",[eg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cg=Po(ig.prototype,"_lightmapSize",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Po(ig.prototype,"bakeable",[ia],Object.getOwnPropertyDescriptor(ig.prototype,"bakeable"),ig.prototype),Po(ig.prototype,"castShadow",[ia],Object.getOwnPropertyDescriptor(ig.prototype,"castShadow"),ig.prototype),Po(ig.prototype,"receiveShadow",[ia],Object.getOwnPropertyDescriptor(ig.prototype,"receiveShadow"),ig.prototype),Po(ig.prototype,"lightmapSize",[ia],Object.getOwnPropertyDescriptor(ig.prototype,"lightmapSize"),ig.prototype),tg=ig))||tg);let Mg=function(t){return e({MeshRenderer:t,ModelComponent:t}),t}((lg=Go("cc.MeshRenderer"),hg=ta(),ug=Vo(100),_g=$o(),dg=va(Ig),mg=ra(),pg=va(Og),fg=ra(),gg=va(Hl),vg=ra(),yg=na(),lg(xg=hg(xg=ug(xg=_g(xg=Zo((wg=Rg=class extends Qf{get shadowCastingMode(){return this._shadowCastingMode}set shadowCastingMode(e){this._shadowCastingMode=e,this._updateCastShadow()}get receiveShadow(){return this._shadowReceivingMode}set receiveShadow(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}get mesh(){return this._mesh}set mesh(e){var t;const i=this._mesh;this._mesh=e,null===(t=this._mesh)||void 0===t||t.initialize(),this._watchMorphInMesh(),this._onMeshChanged(i),this._updateModels(),this.enabledInHierarchy&&this._attachToScene()}get model(){return this._model}get enableMorph(){return this._enableMorph}set enableMorph(e){this._enableMorph=e}constructor(){super(),Oo(this,"lightmapSettings",Tg,this),Oo(this,"_mesh",Eg,this),Oo(this,"_shadowCastingMode",Ag,this),Oo(this,"_shadowReceivingMode",Cg,this),this._modelType=void 0,this._model=null,this._morphInstance=null,Oo(this,"_enableMorph",bg,this),this._modelType=Im}onLoad(){var e;null===(e=this._mesh)||void 0===e||e.initialize(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}onRestore(){this._updateModels()}onEnable(){this._model||this._updateModels(),this._attachToScene()}onDisable(){this._model&&this._detachFromScene()}onDestroy(){this._model&&(i.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}setWeights(e,t){this._morphInstance&&this._morphInstance.setWeights(t,e)}setInstancedAttribute(e,t){if(!this.model)return;const i=this.model.instancedAttributes.list;for(let n=0;n<i.length;n++)if(i[n].name===e){i[n].view.set(t);break}}_updateLightmap(e,t,i,n,s){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=s,this._onUpdateLightingmap()}_updateModels(){this.enabledInHierarchy&&this._mesh&&(this._model?(this._model.destroy(),this._model.initialize(this.node)):this._createModel(),this._updateModelParams(),this._onUpdateLightingmap())}_createModel(){const e=!!this._morphInstance&&this._modelType===Im?Om:this._modelType;this._model=i.director.root.createModel(e),this._model.visFlags=this.visibility,this._model.initialize(this.node),this._models.length=0,this._models.push(this._model),this._morphInstance&&this._model instanceof Om&&this._model.setMorphRendering(this._morphInstance)}_attachToScene(){if(!this.node.scene||!this._model)return;const e=this._getRenderScene();null!=this._model.scene&&this._detachFromScene(),e.addModel(this._model)}_detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}_updateModelParams(){if(!this._mesh||!this._model)return;this.node.hasChangedFlags|=K_.POSITION,this._model.transform.hasChangedFlags|=K_.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();const e=this._mesh?this._mesh.subMeshCount:0,t=this._mesh.renderingSubMeshes;if(t)for(let i=0;i<e;++i){const e=this.getRenderMaterial(i),n=t[i];n&&this._model.initSubModel(i,n,e||this._getBuiltinMaterial())}this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._model.enabled=!0}_onUpdateLightingmap(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}_onMaterialModified(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}_onRebuildPSO(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())}_onMeshChanged(e){}_clearMaterials(){if(!this._model)return;const e=this._model.subModels;for(let t=0;t<e.length;++t)this._onMaterialModified(t,null)}_getBuiltinMaterial(){return Th.get("missing-material")}_onVisibilityChange(e){this._model&&(this._model.visFlags=e)}_updateCastShadow(){this._model&&(this._shadowCastingMode===Ig.OFF?this._model.castShadow=!1:(this._shadowCastingMode,Ig.ON,this._shadowCastingMode,this._model.castShadow=!0))}_updateReceiveShadow(){this._model&&(this._shadowReceivingMode===Og.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}_isBatchingEnabled(){for(let e=0;e<this._materials.length;++e){const t=this._materials[e];if(t)for(let e=0;e<t.passes.length;++e){if(t.passes[e].batchingScheme)return!0}}return!1}_watchMorphInMesh(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),!this._enableMorph)return;if(!this._mesh||!this._mesh.struct.morph||!this._mesh.morphRendering)return;const{morph:e}=this._mesh.struct;this._morphInstance=this._mesh.morphRendering.createInstance();const t=this._mesh.struct.primitives.length;for(let i=0;i<t;++i){const t=e.subMeshMorphs[i];if(!t)continue;const n=t.weights||e.weights,s=n?n.slice():new Array(t.targets.length).fill(0);this._morphInstance.setWeights(i,s)}this._model&&this._model instanceof Om&&this._model.setMorphRendering(this._morphInstance)}_syncMorphWeights(e){if(!this._morphInstance)return;const t=this._morphInstance[e];t&&t.renderResources&&t.renderResources.setWeights(t.weights)}},Rg.ShadowCastingMode=Ig,Rg.ShadowReceivingMode=Og,Tg=Po((Sg=wg).prototype,"lightmapSettings",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pg}}),Eg=Po(Sg.prototype,"_mesh",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ag=Po(Sg.prototype,"_shadowCastingMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ig.OFF}}),Cg=Po(Sg.prototype,"_shadowReceivingMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Og.ON}}),Po(Sg.prototype,"shadowCastingMode",[dg,mg],Object.getOwnPropertyDescriptor(Sg.prototype,"shadowCastingMode"),Sg.prototype),Po(Sg.prototype,"receiveShadow",[pg,fg],Object.getOwnPropertyDescriptor(Sg.prototype,"receiveShadow"),Sg.prototype),Po(Sg.prototype,"mesh",[gg,vg],Object.getOwnPropertyDescriptor(Sg.prototype,"mesh"),Sg.prototype),Po(Sg.prototype,"enableMorph",[yg],Object.getOwnPropertyDescriptor(Sg.prototype,"enableMorph"),Sg.prototype),bg=Po(Sg.prototype,"_enableMorph",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xg=Sg))||xg)||xg)||xg)||xg)||xg));function Dg(e,t){const i=e.sharedMaterials.length;if(i!==t.sharedMaterials.length)return!1;for(let n=0;n<i;n++)if(e.getRenderMaterial(n)!==t.getRenderMaterial(n))return!1;return!0}e("BatchingUtility",class{static batchStaticModel(e,t){const i=e.getComponentsInChildren(Mg);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(let e=1;e<i.length;e++){if(!i[0].mesh.validateMergingMesh(i[e].mesh))return console.error("the meshes of "+i[0].node.name+" and "+i[e].node.name+" can't be merged"),!1;if(!Dg(i[0],i[e]))return console.error("the materials of "+i[0].node.name+" and "+i[e].node.name+" can't be merged"),!1}const n=new Hl,s=new wi,r=new wi;e.getWorldMatrix(r),wi.invert(r,r);for(let e=0;e<i.length;e++){const t=i[e];t.node.getWorldMatrix(s),wi.multiply(s,r,s),n.merge(i[e].mesh,s),t.enabled=!1}const o=t.addComponent(Mg);return o.mesh=n,o.sharedMaterials=i[0].sharedMaterials,!0}static unbatchStaticModel(e,t){const i=e.getComponentsInChildren(Mg);for(let e=0;e<i.length;e++){i[e].enabled=!0}const n=t.getComponent(Mg);return n&&n.destroy(),!0}});const Lg=new _i;function Bg(e,t,i,n){n||(n=new _i),e.convertToUINode(t,i,n);const s=i.position;return n.add(s),n}function Ng(e,t,n){return n||(n=new _i),e.worldToScreen(t,n),n.x=n.x/i.view.getScaleX(),n.y=n.y/i.view.getScaleY(),n}const Fg=e("convertUtils",{WorldNode3DToLocalNodeUI:Bg,WorldNode3DToWorldNodeUI:Ng});i.pipelineUtils=Fg,Ui(i.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(...e){const t=e[0],i=e[3]||Lg;return t.convertToUINode(e[1],e[2],i),i.add(e[2].position),e[3]||i.clone()}}]);var zg,Ug,Gg,Hg,Vg,kg,Wg,jg=Object.freeze({__proto__:null,ccclass:Go,property:qo,requireComponent:Ho,executionOrder:Vo,disallowMultiple:ko,executeInEditMode:Zo,menu:$o,playOnFocus:Qo,inspector:Jo,icon:ea,help:ta,type:va,integer:ma,float:pa,boolean:fa,string:ga});e("_decorator",jg);let qg=Go("cc.MissingClass")((Gg=Po((Ug=class{constructor(){Oo(this,"_$erialized",Gg,this)}}).prototype,"_$erialized",[Xo,Yo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zg=Ug))||zg,Xg=e("MissingScript",Go("cc.MissingScript")(Hg=Jo()((kg=Po((Vg=class e extends f_{static safeFindClass(t,n){const s=Oe(t);return s||(t?(i.deserialize.reportMissingClass(t),e.getMissingWrapper(t,n)):null)}static getMissingWrapper(t,i){return i.node&&(/^[0-9a-zA-Z+/]{23}$/.test(t)||Ne.test(t))?e:qg}constructor(){super(),Oo(this,"compiled",kg,this),Oo(this,"_$erialized",Wg,this)}onLoad(){y(4600,this.node.name)}}).prototype,"compiled",[ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wg=Po(Vg.prototype,"_$erialized",[Xo,Yo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hg=Vg))||Hg)||Hg);i._MissingScript=Xg;class Yg{constructor(){this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=ce(!0)}reset(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,Ee(this._stillUseUrl)}push(e,t,i,n){n&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(i),this.uuidObjList.push(e),this.uuidPropList.push(t)}}function Kg(e,t,n,s,r,o){if(t instanceof i.ValueType){r||e.push("if(prop){");const i=le(t);e.push(`s._deserializeTypedObject(o${n},prop,${i});`),r||e.push("}else o"+n+"=null;")}else e.push("if(prop){"),e.push("s._deserializeObjField(o,prop,"+s+",null,"+!!o+");"),e.push("}else o"+n+"=null;")}Yg.pool=void 0,Yg.pool=new De(e=>{e.reset()},10),Yg.pool.get=function(){return this._get()||new Yg};function Zg(e,t,n,s,r){let o;s.hasOwnProperty("__deserialize__")?o=s.__deserialize__:(o=((e,t)=>{const n=it(t),s=t.__values__,r=["var prop;"],o=Ne.test(Me(t));for(let e=0;e<s.length;e++){const t=s[e];let a,c;Nt.IDENTIFIER_RE.test(t)?(c='"'+t+'"',a="."+t):(c=Nt.escapeForJS(t),a="["+c+"]");let l=a;if(n[t+"$_$formerlySerializedAs"]){const e=n[t+"$_$formerlySerializedAs"];l=Nt.IDENTIFIER_RE.test(e)?"."+e:"["+Nt.escapeForJS(e)+"]"}r.push("prop=d"+l+";"),r.push('if(typeof (prop)!=="undefined"){');const h=n[t+"$_$saveUrlAsAsset"],u=Nt.getDefault(n[t+"$_$default"]);if(o){let e;const s=n[t+"$_$type"];if(void 0===u&&s)e=s===i.String||s===i.Integer||s===i.Float||s===i.Boolean;else{const t=typeof u;e="string"===t&&!h||"number"===t||"boolean"===t}e?r.push(`o${a}=prop;`):Kg(r,u,a,c,!0,h)}else r.push('if(typeof (prop)!=="object"){o'+a+"=prop;}else{"),Kg(r,u,a,c,!1,h),r.push("}");r.push("}")}return(i.js.isChildClassOf(t,i._BaseNode)||i.js.isChildClassOf(t,i.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===s[s.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._deserializePrimitiveObject(o._$erialized,d);")),Function("s","o","d","k","t",r.join(""))})(0,s),se(s,"__deserialize__",o,!0)),o(e,t,n,s,r)}class $g{constructor(e,t,i,n,s){this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=e,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=i,this._idList=[],this._idObjList=[],this._idPropList=[]}deserialize(e){if(Array.isArray(e)){const t=e,i=t.length;this.deserializedList.length=i;for(let e=0;e<i;e++)t[e]&&(this.deserializedList[e]=this._deserializeObject(t[e],!1));this.deserializedData=i>0?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){const t=e.deserializedList,i=e._idPropList,n=e._idList,s=e._idObjList;let r,o,a;for(e._classFinder&&e._classFinder.onDereferenced,r=0;r<n.length;r++)o=i[r],a=n[r],s[r][o]=t[a]}(this),this.deserializedData}_deserializeObject(e,t,n,s,r){let o,a=null,c=null;const l=e.__type__;if("TypedArray"===l){const t=e.array;a=new window[e.ctor](t.length);for(let e=0;e<t.length;++e)a[e]=t[e];return a}if(l){if(c=this._classFinder(l,e,s,r),!c){return this._classFinder===Oe&&i.deserialize.reportMissingClass(l),null}const t=this;a=new c,a._deserialize?a._deserialize(e.content,t):i.Class._isCCClass(c)?Zg(t,a,e,c,n):t._deserializeTypedObject(a,e,c)}else if(Array.isArray(e)){a=new Array(e.length);for(let i=0;i<e.length;i++)o=e[i],"object"==typeof o&&o?this._deserializeObjField(a,o,""+i,null,t):a[i]=o}else a={},this._deserializePrimitiveObject(a,e);return a}_deserializeObjField(e,t,i,n,s){const r=t.__id__;if(void 0===r){const n=t.__uuid__;n?this.result.push(e,i,n,s):e[i]=this._deserializeObject(t,s)}else{const t=this.deserializedList[r];t?e[i]=t:(this._idList.push(r),this._idObjList.push(e),this._idPropList.push(i))}}_deserializePrimitiveObject(e,t){const i=this;for(const n in t)if(t.hasOwnProperty(n)){const s=t[n];"object"!=typeof s?"__type__"!==n&&(e[n]=s):s?i._deserializeObjField(e,s,n):e[n]=null}}_deserializeTypedObject(e,t,n){if(n===i.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===i.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n===i.Color){e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;const i=t.a;return void(e.a=void 0===i?255:i)}if(n===i.Size)return e.width=t.width||0,void(e.height=t.height||0);const s=it(n),r=n.__props__||Object.keys(e);for(let i=0;i<r.length;i++){const n=r[i];let o=t[n];void 0!==o&&t.hasOwnProperty(n)||(o=Nt.getDefault(s[n+"$_$default"])),"object"!=typeof o?e[n]=o:o?this._deserializeObjField(e,o,n):e[n]=null}}}function Qg(e,t,n){const s=(n=n||{}).classFinder||Oe,r=n.createAssetRefs||i.sys.platform===i.sys.EDITOR_CORE,o=n.customEnv,a=n.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));const c=!t;t=t||Yg.pool.get();const l=$g.pool.get(t,!1,s,o,a);i.game._isCloning=!0;const h=l.deserialize(e);return i.game._isCloning=!1,$g.pool.put(l),r&&t.assignAssetsBy(EditorExtends.serialize.asAsset),c&&Yg.pool.put(t),h}$g.pool=void 0,$g.pool=new De(e=>{e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0},1),$g.pool.get=function(e,t,i,n,s){const r=this._get();return r?(r.result=e,r.customEnv=n,r._classFinder=i,r):new $g(e,t,i,n,s)},Qg.Details=Yg,Qg.reportMissingClass=e=>{y(5302,e)},i.deserialize=Qg;const Jg=Ua.Flags.Destroyed,ev=Ua.Flags.PersistentMask,tv=[];function iv(e,t){let n;if(e instanceof Ua){if(e._instantiate)return i.game._isCloning=!0,n=e._instantiate(),i.game._isCloning=!1,n;if(e instanceof i.Asset)throw new TypeError(C(6903))}return i.game._isCloning=!0,n=nv(e),i.game._isCloning=!1,n}function nv(e,t){let i;if(e._iN$t)i=e._iN$t;else if(e.constructor){i=new(0,e.constructor)}else i=Object.create(null);sv(e,i,t);for(let e=0,t=tv.length;e<t;++e)tv[e]._iN$t=null;return tv.length=0,i}function sv(e,t,n){se(e,"_iN$t",t,!0),tv.push(e);const s=e.constructor;if(i.Class._isCCClass(s))!function(e,t,i,n){const s=e.__values__;for(let e=0;e<s.length;e++){const r=s[e],o=t[r];if("object"==typeof o&&o){const e=i[r];e instanceof Qe&&e.constructor===o.constructor?e.set(o):i[r]=o._iN$t||rv(o,n)}else i[r]=o}}(s,e,t,n);else for(const i in e){if(!e.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1)&&"__type__"!==i)continue;const s=e[i];if("object"==typeof s&&s){if(s===t)continue;t[i]=s._iN$t||rv(s,n)}else t[i]=s}e instanceof Ua&&(t._objFlags&=ev)}function rv(e,t){if(e instanceof Qe)return e.clone();if(e instanceof i.Asset)return e;let n;if(Array.isArray(e)){const i=e.length;n=new Array(i),e._iN$t=n;for(let s=0;s<i;++s){const i=e[s];n[s]="object"==typeof i&&i?i._iN$t||rv(i,t):i}return tv.push(e),n}if(e._objFlags&Jg)return null;const s=e.constructor;if(i.Class._isCCClass(s)){if(t)if(t instanceof i.Component){if(e instanceof i._BaseNode||e instanceof i.Component)return e}else if(t instanceof i._BaseNode)if(e instanceof i._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof i.Component&&!e.node.isChildOf(t))return e;n=new s}else if(s===Object)n={};else{if(s)return e;n=Object.create(null)}return sv(e,n,t),n}var ov,av,cv,lv,hv,uv,_v,dv;let mv,pv;iv._clone=nv,i.instantiate=iv,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(mv||(mv={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(pv||(pv={}));function fv(e,t){return(t<<3)+e}let gv=e("CompactValueTypeArray",Go("cc.CompactValueTypeArray")((dv=_v=class e{constructor(){Oo(this,"_byteOffset",cv,this),Oo(this,"_unitCount",lv,this),Oo(this,"_unitElement",hv,this),Oo(this,"_length",uv,this)}static lengthFor(e,t,i){return vv(t).requiredUnits*e.length*yv(i).BYTES_PER_ELEMENT}static compress(t,i,n,s,r,o){const a=vv(i),c=yv(n),l=a.requiredUnits*t.length,h=new c(s,r,l);for(let e=0;e<t.length;++e)a.compress(h,e,t[e]);const u=new e;return u._unitElement=fv(n,i),u._byteOffset=o,u._unitCount=l,u._length=t.length,u}decompress(e){const{storageUnit:t,elementType:i}={storageUnit:7&(n=this._unitElement),elementType:n>>3};var n;const s=vv(i),r=new(yv(t))(e,this._byteOffset,this._unitCount),o=new Array(this._length);for(let e=0;e<this._length;++e)o[e]=s.decompress(r,e);return o}},_v.StorageUnit=mv,_v.ElementType=pv,cv=Po((av=dv).prototype,"_byteOffset",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lv=Po(av.prototype,"_unitCount",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hv=Po(av.prototype,"_unitElement",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fv(mv.Uint8,pv.Scalar)}}),uv=Po(av.prototype,"_length",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ov=av))||ov);function vv(e){return xv[e]}function yv(e){switch(e){case mv.Uint8:return Uint8Array;case mv.Uint16:return Uint16Array;case mv.Uint32:return Uint32Array;case mv.Int8:return Int8Array;case mv.Int16:return Int16Array;case mv.Int32:return Int32Array;case mv.Float32:return Float32Array;case mv.Float64:return Float64Array}}const xv={[pv.Scalar]:{requiredUnits:1,compress(e,t,i){e[t]=i},decompress:(e,t)=>e[t]},[pv.Vec2]:{requiredUnits:2,compress(e,t,i){e[2*t]=i.x,e[2*t+1]=i.y},decompress:(e,t)=>new _i(e[2*t],e[2*t+1])},[pv.Vec3]:{requiredUnits:3,compress(e,t,i){e[3*t]=i.x,e[3*t+1]=i.y,e[3*t+2]=i.z},decompress:(e,t)=>new _i(e[3*t],e[3*t+1],e[3*t+2])},[pv.Vec4]:{requiredUnits:4,compress(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:(e,t)=>new fi(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])},[pv.Quat]:{requiredUnits:4,compress(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:(e,t)=>new Si(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])},[pv.Mat4]:{requiredUnits:16,compress(e,t,i){wi.toArray(e,i,16*t)},decompress:(e,t)=>wi.fromArray(new wi,e,16*t)}};function Sv(e){const t=[];return function e(t,i){for(const n of i)Array.isArray(n)?e(t,n):t.push(n)}(t,e),t.join("")}i._decorator=jg;const Tv=Ua.Flags.Destroyed,Ev=Ua.Flags.PersistentMask,Av=Nt.IDENTIFIER_RE,Cv={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},bv=Nt.escapeForJS;class Rv{constructor(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}toString(){return"var "+this.varName+"="+this.expression+";"}}function wv(e,t){return t instanceof Rv?new Rv(t.varName,e+t.expression):e+t}function Iv(e,t,i){Array.isArray(i)?(i[0]=wv(t,i[0]),e.push(i)):e.push(wv(t,i)+";")}class Ov{constructor(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}append(e,t){this._exps.push([e,t])}writeCode(e){let t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(let i=0;i<this._exps.length;i++){const n=this._exps[i];Iv(e,t+Pv(n[0])+"=",n[1])}}}function Pv(e){return Av.test(e)?"."+e:"["+bv(e)+"]"}Ov.pool=void 0,Ov.pool=new De(e=>{e._exps.length=0,e._targetExp=null},1),Ov.pool.get=function(e){const t=this._get()||new Ov;return t._targetExp=e,t};class Mv{constructor(e,t){let i;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=ce(),ye(this.funcModuleCache,Cv),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(i="var "+this.globalVariables.join(",")+";");const n=Sv(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(let e=0,t=this.objsToClear_iN$t.length;e<t;++e)this.objsToClear_iN$t[e]._iN$t=null;this.objsToClear_iN$t.length=0}getFuncModule(e,t){const i=le(e);if(i){const t=this.funcModuleCache[i];if(t)return t;if(void 0===t){let t=-1!==i.indexOf(".");if(t)try{if(t=e===Function("return "+i)(),t)return this.funcModuleCache[i]=i,i}catch(e){}}}let n=this.funcs.indexOf(e);n<0&&(n=this.funcs.length,this.funcs.push(e));let s="F["+n+"]";return t&&(s="("+s+")"),this.funcModuleCache[i]=s,s}getObjRef(e){let t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}setValueType(e,t,i,n){const s=Ov.pool.get(n);let r=t.constructor.__props__;r||(r=Object.keys(t));for(let e=0;e<r.length;e++){const n=r[e],o=i[n];if(t[n]===o)continue;const a=this.enumerateField(i,n,o);s.append(n,a)}s.writeCode(e),Ov.pool.put(s)}enumerateCCClass(e,t,n){const s=n.__values__,r=it(n);for(let n=0;n<s.length;n++){const o=s[n],a=t[o];let c=r[o+"$_$default"];if(!Dv(c,a))if("object"==typeof a&&a instanceof i.ValueType&&(c=Nt.getDefault(c),c&&c.constructor===a.constructor)){const t="o"+Pv(o);this.setValueType(e,c,a,t)}else this.setObjProp(e,t,o,a)}}instantiateArray(e){if(0===e.length)return"[]";const t="a"+ ++this.localVariableId,i=[new Rv(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(let n=0;n<e.length;++n){Iv(i,t+"["+n+"]=",this.enumerateField(e,n,e[n]))}return i}enumerateField(e,t,i){if("object"==typeof i&&i){const e=i._iN$t;if(e){let t=e.globalVar;if(!t){t=e.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(t);const i=e.source[0];e.source[0]=wv(t+"=",i)}return t}return Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?bv(i):("_objFlags"===t&&e instanceof Ua&&(i&=Ev),i)}setObjProp(e,t,i,n){Iv(e,"o"+Pv(i)+"=",this.enumerateField(t,i,n))}enumerateObject(e,t){const n=t.constructor;if(i.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(const i in t){if(!t.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1)&&"__type__"!==i)continue;const n=t[i];"object"==typeof n&&n&&n===t._iN$t||this.setObjProp(e,t,i,n)}}instantiateObj(e){if(e instanceof i.ValueType)return Nt.getNewValueTypeCode(e);if(e instanceof i.Asset)return this.getObjRef(e);if(e._objFlags&Tv)return null;let t;const n=e.constructor;if(i.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof i.Component){if(e instanceof i._BaseNode||e instanceof i.Component)return this.getObjRef(e)}else if(this.parent instanceof i._BaseNode)if(e instanceof i._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof i.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new Rv("o","new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new Rv("o","{}");else{if(n)return this.getObjRef(e);t=new Rv("o","Object.create(null)")}const s=[t];return e._iN$t={globalVar:"",source:s},this.objsToClear_iN$t.push(e),this.enumerateObject(s,e),["(function(){",s,"return o;})();"]}}function Dv(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof i.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}var Lv,Bv,Nv,Fv,zv,Uv,Gv;const Hv=Ye({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2});let Vv=e("Prefab",Go("cc.Prefab")((Gv=Uv=class e extends sc{constructor(){super(),Oo(this,"data",Nv,this),Oo(this,"optimizationPolicy",Fv,this),Oo(this,"asyncLoadAssets",zv,this),this._createFunction=void 0,this._instantiatedTimes=void 0,this._createFunction=null,this._instantiatedTimes=0}createNode(e){const t=i.instantiate(this);t.name=this.name,e(null,t)}compileCreateFunction(){this._createFunction=function(e){const t=e instanceof i._BaseNode&&e;return new Mv(e,t).result}(this.data)}_doInstantiate(e){return this.data._prefab?this.data._prefab._synced=!0:y(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}_instantiate(){let t,i=!1;return i=this.optimizationPolicy!==Hv.SINGLE_INSTANCE&&(this.optimizationPolicy===Hv.MULTI_INSTANCE||this._instantiatedTimes+1>=e.OptimizationPolicyThreshold),i?(t=this._doInstantiate(),this.data._instantiate(t)):(this.data._prefab._synced=!0,t=this.data._instantiate()),++this._instantiatedTimes,t}},Uv.OptimizationPolicy=Hv,Uv.OptimizationPolicyThreshold=3,Nv=Po((Bv=Gv).prototype,"data",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fv=Po(Bv.prototype,"optimizationPolicy",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hv.AUTO}}),zv=Po(Bv.prototype,"asyncLoadAssets",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lv=Bv))||Lv);var kv,Wv,jv,qv;i.Prefab=Vv,he(i,"cc._Prefab","Prefab");let Xv=e("SceneAsset",Go("cc.SceneAsset")((jv=Po((Wv=class extends sc{constructor(...e){super(...e),Oo(this,"scene",jv,this),Oo(this,"asyncLoadAssets",qv,this)}}).prototype,"scene",[ia,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qv=Po(Wv.prototype,"asyncLoadAssets",[ia,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kv=Wv))||kv);var Yv,Kv,Zv;i.SceneAsset=Xv;let $v=e("SpriteAtlas",Go("cc.SpriteAtlas")((Zv=Po((Kv=class extends sc{constructor(...e){super(...e),Oo(this,"spriteFrames",Zv,this)}getTexture(){const e=Object.keys(this.spriteFrames);if(e.length>0){const t=this.spriteFrames[e[0]];return t&&t.texture}return null}getSpriteFrame(e){const t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}getSpriteFrames(){const e=[],t=this.spriteFrames;for(const i of Object.keys(t))e.push(t[i]);return e}_serialize(e){const t=[];for(const i of Object.keys(this.spriteFrames)){const n=this.spriteFrames[i];let s=n?n._uuid:"";s&&e&&(s=EditorExtends.UuidUtils.compressUuid(s,!0)),t.push(i),t.push(s)}return{name:this._name,spriteFrames:t}}_deserialize(e,t){const i=e;this._name=i.name;const n=i.spriteFrames;this.spriteFrames=ce();for(let e=0;e<n.length;e+=2)t.result.push(this.spriteFrames,n[e],n[e+1])}}).prototype,"spriteFrames",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ce()}}),Yv=Kv))||Yv);var Qv,Jv,ey;i.SpriteAtlas=$v;let ty=e("TextAsset",Go("cc.TextAsset")((ey=Po((Jv=class extends sc{constructor(...e){super(...e),Oo(this,"text",ey,this)}toString(){return this.text}}).prototype,"text",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Qv=Jv))||Qv);var iy,ny,sy;i.TextAsset=ty;let ry=e("JsonAsset",Go("cc.JsonAsset")((sy=Po((ny=class extends sc{constructor(...e){super(...e),Oo(this,"json",sy,this)}}).prototype,"json",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iy=ny))||iy);i.JsonAsset=ry;const oy="0123456789abcdef".split(""),ay=["","","",""],cy=ay.concat(ay,"-",ay,"-",ay,"-",ay,"-",ay,ay,ay),ly=cy.map((e,t)=>"-"===e?NaN:t).filter(isFinite);function hy(e){const t=e.split("@")[0];if(22!==t.length)return e;cy[0]=e[0],cy[1]=e[1];for(let t=2,i=2;t<22;t+=2){const n=ze[e.charCodeAt(t)],s=ze[e.charCodeAt(t+1)];cy[ly[i++]]=oy[n>>2],cy[ly[i++]]=oy[(3&n)<<2|s>>4],cy[ly[i++]]=oy[15&s]}return e.replace(t,cy.join(""))}let uy=e("url",{_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=i.loader._getResUuid(e.slice(10),i.Asset,null,!0);if(t)return i.AssetLibrary.getLibUrlNoExt(t,!0)+D(e)}else S(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=G(e)+"/"}});i.url=uy;class _y{constructor(e,t){this.uuid=void 0,this.type=void 0,this.uuid=e,this.type=t}}function dy(e,t){if(e.length>t.length){return 47===e.charCodeAt(t.length)}return!0}class my{constructor(){this._pathToUuid=void 0,this._pathToUuid=ce(!0)}getUuid(e,t){e=uy.normalize(e);let i=this._pathToUuid[e];if(i)if(Array.isArray(i)){if(!t)return i[0].uuid;for(let e=0;e<i.length;e++){let n=i[e];if(Te(n.type,t))return n.uuid}}else if(!t||Te(i.type,t))return i.uuid;return""}getUuidArray(e,t,i){"/"===(e=uy.normalize(e))[e.length-1]&&(e=e.slice(0,-1));let n=this._pathToUuid,s=[];for(let r in n)if(r.startsWith(e)&&dy(r,e)||!e){let e=n[r];if(Array.isArray(e))for(let n=0;n<e.length;n++){let o=e[n];t&&!Te(o.type,t)||(s.push(o.uuid),i&&i.push(r))}else t&&!Te(e.type,t)||(s.push(e.uuid),i&&i.push(r))}return s}add(e,t,i,n){n&&(e=e.substring(0,e.length-D(e).length));let s=new _y(t,i);Ge(this._pathToUuid,e,s,n)}_getInfo_DEBUG(e,t){let i=this._pathToUuid,n=Object.keys(i);for(let s=0;s<n.length;++s){let r=n[s],o=i[r];if(Array.isArray(o))for(let i=0;i<o.length;i++){let n=o[i];if(n.uuid===e)return t.path=r,t.type=n.type,!0}else if(o.uuid===e)return t.path=r,t.type=o.type,!0}return!1}reset(){this._pathToUuid=ce(!0)}}let py=0|998*Math.random(),fy=ce(!0),gy=[];var vy;!function(e){e[e.WORKING=0]="WORKING",e[e.COMPLETE=1]="COMPLETE",e[e.ERROR=2]="ERROR"}(vy||(vy={}));let yy=ce(!0);function xy(e){if(!e)return;let t=e.split("?");if(!t||!t[0]||!t[1])return;let i={};return t[1].split("&").forEach((function(e){let t=e.split("=");i[t[0]]=t[1]})),i}function Sy(e,t){let n="object"==typeof e?e.url:e,s={queueId:t,id:n,url:n,rawUrl:void 0,urlParam:xy(n),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:e.uuid&&i.game._sceneInfos.find(t=>t.uuid===e.uuid)};if("object"==typeof e&&(ye(s,e),e.skips))for(let t=0;t<e.skips.length;t++){let i=e.skips[t];s.states[i]=vy.COMPLETE}return s.rawUrl=s.url,n&&!s.type&&(s.type=D(n).toLowerCase().substr(1)),s}let Ty=[];function Ey(e,t,i){if(!e||!t)return!1;let n=!1;if(Ty.push(t.id),t.deps){let i,s,r=t.deps;for(i=0;i<r.length;i++){if(s=r[i],s.id===e.id){n=!0;break}if(!(Ty.indexOf(s.id)>=0)&&(s.deps&&Ey(e,s,!0))){n=!0;break}}}return i||(Ty.length=0),n}class Ay extends Ya{constructor(e,t,i,n){super(),this.onProgress=void 0,this.onComplete=void 0,this.map=ce(!0),this.completed={},this.totalCount=0,this.completedCount=0,this.active=void 0,this._id=void 0,this._pipeline=void 0,this._errorUrls=[],this._appending=!1,this._ownerQueue=null,this._id=++py,fy[this._id]=this,this._pipeline=e,this.onProgress=i,this.onComplete=n,this._pipeline?this.active=!0:this.active=!1,t&&(t.length>0?this.append(t):this.allComplete())}static create(e,t,i,n){void 0===i?"function"==typeof t&&(n=t,t=i=null):void 0===n&&("function"==typeof t?(n=i,i=t,t=null):(n=i,i=null));let s=gy.pop();return s?(s._pipeline=e,s.onProgress=i,s.onComplete=n,fy[s._id]=s,s._pipeline&&(s.active=!0),t&&s.append(t)):s=new Ay(e,t,i,n),s}static getQueue(e){return e.queueId?fy[e.queueId]:null}static itemComplete(e){let t=fy[e.queueId];t&&t.itemComplete(e.id)}static initQueueDeps(e){let t=yy[e._id];t?(t.completed.length=0,t.deps.length=0):t=yy[e._id]={completed:[],deps:[]}}static registerQueueDep(e,t){let i=e.queueId||e;if(!i)return!1;let n=yy[i];if(n)-1===n.deps.indexOf(t)&&n.deps.push(t);else if(e.id)for(let i in yy){let n=yy[i];-1!==n.deps.indexOf(e.id)&&-1===n.deps.indexOf(t)&&n.deps.push(t)}}static finishDep(e){for(let t in yy){let i=yy[t];-1!==i.deps.indexOf(e)&&-1===i.completed.indexOf(e)&&i.completed.push(e)}}append(e,t){if(!this.active)return[];t&&!t.deps&&(t.deps=[]),this._appending=!0;let i,n,s,r=[];for(i=0;i<e.length;++i){if(n=e[i],n.queueId&&!this.map[n.id]){if(this.map[n.id]=n,t&&t.deps.push(n),n.complete||Ey(t,n)){this.totalCount++,this.itemComplete(n.id);continue}{let e=this,i=fy[n.queueId];i&&(this.totalCount++,Ay.registerQueueDep(t||this._id,n.id),i.addListener(n.id,(function(t){e.itemComplete(t.id)})));continue}}if("string"==typeof((o=n).url||o)){s=Sy(n,this._id);let e=s.id;this.map[e]||(this.map[e]=s,this.totalCount++,t&&t.deps.push(s),Ay.registerQueueDep(t||this._id,e),r.push(s))}}var o;return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(r),r}_childOnProgress(e){if(this.onProgress){let t=yy[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}allComplete(){let e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}isCompleted(){return this.completedCount>=this.totalCount}isItemCompleted(e){return!!this.completed[e]}exists(e){return!!this.map[e]}getContent(e){let t=this.map[e],i=null;return t&&(t.content?i=t.content:t.alias&&(i=t.alias.content)),i}getError(e){let t=this.map[e],i=null;return t&&(t.error?i=t.error:t.alias&&(i=t.alias.error)),i}removeItem(e){let t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}itemComplete(e){let t=this.map[e];if(!t)return;let i=this._errorUrls.indexOf(e);if(t.error&&-1===i?this._errorUrls.push(e):t.error||-1===i||this._errorUrls.splice(i,1),Ay.finishDep(t.id),this.emit(e,t),this.removeAll(e),this.completed[e]=t,this.completedCount++,this.onProgress){let e=yy[this._id];this.onProgress(e?e.completed.length:this.completedCount,e?e.deps.length:this.totalCount,t)}!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}destroy(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=void 0,this.onComplete=void 0,this.map=ce(!0),this.completed={},this.totalCount=0,this.completedCount=0,this.clear(),fy[this._id]=null,yy[this._id]&&(yy[this._id].completed.length=0,yy[this._id].deps.length=0),-1===gy.indexOf(this)&&gy.length<10&&gy.push(this)}addListener(e,t,i){return super.on(e,t,i)}hasListener(e,t,i){return super.hasEventListener(e,t,i)}removeListener(e,t,i){return super.off(e,t,i)}removeAllListeners(e){super.removeAll(e)}}e("LoadingItems",Ay),Ay.ItemState=new i.Enum(vy),i.LoadingItems=Ay;const Cy=Ay.ItemState;function by(e,t){let i=e.id,n=t.states[i],s=e.next,r=e.pipeline;if(!t.error&&n!==Cy.WORKING&&n!==Cy.ERROR)if(n===Cy.COMPLETE)s?by(s,t):r.flowOut(t);else{t.states[i]=Cy.WORKING;let n=e.handle(t,(function(e,n){e?(t.error=e,t.states[i]=Cy.ERROR,r.flowOut(t)):(n&&(t.content=n),t.states[i]=Cy.COMPLETE,s?by(s,t):r.flowOut(t))}));n instanceof Error?(t.error=n,t.states[i]=Cy.ERROR,r.flowOut(t)):void 0!==n&&(null!==n&&(t.content=n),t.states[i]=Cy.COMPLETE,s?by(s,t):r.flowOut(t))}}class Ry{constructor(e){this._pipes=void 0,this._cache=ce(!0),this._pipes=e;for(let t=0;t<e.length;++t){let i=e[t];i.handle&&i.id&&(i.pipeline=this,i.next=t<e.length-1?e[t+1]:null)}}insertPipe(e,t){if(!e.handle||!e.id||t>this._pipes.length)return void y(4921);if(this._pipes.indexOf(e)>0)return void y(4922);e.pipeline=this;let i=null;t<this._pipes.length&&(i=this._pipes[t]);let n=null;t>0&&(n=this._pipes[t-1]),n&&(n.next=e),e.next=i,this._pipes.splice(t,0,e)}insertPipeAfter(e,t){let i=this._pipes.indexOf(e);i<0||this.insertPipe(t,i+1)}appendPipe(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,this._pipes.length>0&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}flowIn(e){let t,i,n=this._pipes[0];if(n){for(t=0;t<e.length;t++)i=e[t],i.isScene||(this._cache[i.id]=i);for(t=0;t<e.length;t++)i=e[t],by(n,i)}else for(t=0;t<e.length;t++)this.flowOut(e[t])}flowInDeps(e,t,i){return Ay.create(this,(function(e,t){i(e,t),t.destroy()})).append(t,e)}flowOut(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,Ay.itemComplete(e)}copyItemStates(e,t){if(t instanceof Array)for(let i=0;i<t.length;++i)t[i].states=e.states;else t.states=e.states}getItem(e){let t=this._cache[e];return t?(t.alias&&(t=t.alias),t):t}removeItem(e){let t=this._cache[e];return t&&t.complete&&delete this._cache[e],t}clear(){for(let e in this._cache){let t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}e("Pipeline",Ry),Ry.ItemState=Cy,i.Pipeline=Ry;const wy="MD5Pipe",Iy=/(\.[^.\n\\/]*)$/,Oy=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;class Py{constructor(e,t,i){this.id=wy,this.async=!1,this.pipeline=null,this.md5AssetsMap=void 0,this.md5NativeAssetsMap=void 0,this.libraryBase=void 0,this.id=wy,this.async=!1,this.pipeline=null,this.md5AssetsMap=e,this.md5NativeAssetsMap=t,this.libraryBase=i}handle(e){let t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}transformURL(e,t){let n=function(e){let t=e.match(Oy);return t?t[1]:""}(e);if(n){let s=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[n];if(s)if(t){let t=i.path.dirname(e),n=i.path.basename(e);e=`${t}.${s}/${n}`}else{let t=!1;e=e.replace(Iy,(function(e,i){return t=!0,"."+s+i})),t||(e=e+"."+s)}}return e}}Py.ID=wy,Ry.MD5Pipe=Py;class My{constructor(){this.jsons={}}load(e,t){t.length!==e.length&&S(4915);for(let i=0;i<e.length;i++){let n=e[i],s=t[i];this.jsons[n]=s}}retrieve(e){return this.jsons[e]||null}}class Dy{constructor(){this.contents={}}load(e,t){let i=t.data;i.length!==e.length&&S(4915);for(let t=0;t<e.length;t++)this.contents[e[t]]={base:i[t][0],mipmaps:i[t][1]}}retrieve(e){let t=this.contents[e];return t?{__type__:Be._getClassId(jc),content:t}:null}}let Ly=/\?/;function By(e){return i.game.config.noCache&&"string"==typeof e&&(Ly.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function Ny(e,t){if(Array.isArray(e))for(let i=0,n=e.length;i<n;i++)Ny(e[i],t);else if("object"==typeof e)for(let i in e)Ny(e[i],t),Number.isNaN(Number(i))||(e[t[i]]=e[i],delete e[i]);return null}var Fy;!function(e){e[e.Invalid=0]="Invalid",e[e.Removed=1]="Removed",e[e.Downloading=2]="Downloading",e[e.Loaded=3]="Loaded"}(Fy||(Fy={}));class zy{constructor(){this.unpacker=void 0,this.state=void 0,this.unpacker=null,this.state=Fy.Invalid}}let Uy={},Gy={},Hy={};function Vy(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function ky(e){for(var t in Gy=e,e)for(var i=e[t],n=0;n<i.length;n++){var s=i[n],r=1===i.length;Ge(Uy,s,t,r)}}function Wy(e,t,n){var s=i.AssetLibrary.getLibUrlNoExt(t)+".json";i.loader.load({url:s,ignoreMaxConcurrency:!0},(function(i,s){if(i)return S(4916,e),n(i);var r=jy(e,t,s);r?n(null,r):n(Vy(e,t))}))}function jy(e,t,i){var n=Hy[t];if(n.state!==Fy.Loaded){if("string"==typeof i&&(i=JSON.parse(i)),i.keys&&i.data){var s=i.keys;Ny(i=i.data,s)}Array.isArray(i)?n.unpacker=new My:i.type===Me(jc)&&(n.unpacker=new Dy),n.unpacker.load(Gy[t],i),n.state=Fy.Loaded}return n.unpacker.retrieve(e)}function qy(e){for(var t=Fy.Invalid,i="",n=0;n<e.length;n++){var s=e[n],r=Hy[s];if(r){var o=r.state;if(o===Fy.Loaded)return s;o>t&&(t=o,i=s)}}return t!==Fy.Invalid?i:e[0]}function Xy(e,t){var i=e.uuid,n=Uy[i];if(n){Array.isArray(n)&&(n=qy(n));var s=Hy[n];if(s&&s.state===Fy.Loaded){var r=s.unpacker.retrieve(i);return r||Vy(i,n)}return s||(console.log("Create unpacker %s for %s",n,i),(s=Hy[n]=new zy).state=Fy.Downloading),Wy(i,n,t),null}}var Yy=Object.freeze({__proto__:null,initPacks:ky,_loadNewPack:Wy,_doPreload:function(e,t){var i=Hy[e];i||((i=Hy[e]=new zy).state=Fy.Downloading),i.state!==Fy.Loaded&&(i.unpacker=new My,i.unpacker.load(Gy[e],t),i.state=Fy.Loaded)},_doLoadNewPack:jy,_selectLoadedPack:qy,load:Xy});const Ky=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;let Zy=Object.create(null);class $y{constructor(e){this.id="SubPackPipe",this.async=!1,this.pipeline=null;for(let t in e){let i=e[t];i.uuids&&i.uuids.forEach((function(e){let t=hy(e);const n=t.split("@").map(e=>encodeURIComponent(e));t=n.join("@"),Zy[t]=i.path}))}}handle(e){return e.url=this.transformURL(e.url),null}transformURL(e){let t=function(e){let t=e.match(Ky);return t?t[1]:""}(e);if(t){let i=Zy[t];if(i)return e.replace("res/raw-assets/",i+"raw-assets/")}return e}}$y.ID="SubPackPipe",Ry.SubPackPipe=$y;let Qy="",Jy="";const ex=ce(!0);function tx(e,t){this.url=e,this.type=t}const ix=e("AssetLibrary",{_uuidToAsset:{},loadAsset(e,t,n){if("string"!=typeof e)return ke(t,new Error("[AssetLibrary] uuid must be string"),null);const s={uuid:e,type:"uuid"};n&&n.existingAsset&&(s.existingAsset=n.existingAsset),i.loader.load(s,(e,n)=>{e||!n?e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(e?e.message:"Unknown error")):(n.constructor,i.SceneAsset),t&&t(e,n)})},getLibUrlNoExt(e,t){const i=(e=hy(e)).split("@").map(e=>encodeURIComponent(e));e=i.join("@");return(t?Jy+"assets/":Qy)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor(e,t){t(new Error("Unable to load resource: EditorExtends is not defined."))},_getAssetInfoInRuntime(e,t){t=t||{url:null,raw:!1};const n=ex[e];return n&&!Te(n.type,i.Asset)?(t.url=Jy+n.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:e=>e in ex,queryAssetInfo(e,t){{const i=this._getAssetInfoInRuntime(e);t(null,i.url,i.raw)}},parseUuidInEditor(e){},loadJson(e,t){const n=""+((new Date).getTime()+Math.random()),s={uuid:n,type:"uuid",content:e,skips:[i.loader.assetLoader.id,i.loader.downloader.id]};i.loader.load(s,(e,s)=>{if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else if(function(e){return e&&(e.constructor===i.SceneAsset||e instanceof i.Scene)}(s)){const e=i.loader._getReferenceKey(n);i.loader.removeItem(e)}s._uuid="",t&&t(e,s)})},getAssetByUuid:e=>ix._uuidToAsset[e]||null,init(e){let t=e.libraryPath;t=t.replace(/\\/g,"/"),Qy=i.path.stripSep(t)+"/",Jy=e.rawAssetsBase;const n=e.md5AssetsMap;if(n&&n.import){let e=0,t="";const s=ce(!0);let r=n.import;for(e=0;e<r.length;e+=2){t=hy(r[e]);const i=t.split("@").map(e=>encodeURIComponent(e));t=i.join("@"),s[t]=r[e+1]}const o=ce(!0);for(r=n["raw-assets"],e=0;e<r.length;e+=2){t=hy(r[e]);const i=t.split("@").map(e=>encodeURIComponent(e));t=i.join("@"),o[t]=r[e+1]}const a=new Py(s,o,Qy);i.loader.insertPipeAfter(i.loader.assetLoader,a),i.loader.md5Pipe=a}const s=e.subPackages;if(s){i.loader.downloader.setSubPackages(s);const e=new $y(s);i.loader.insertPipeAfter(i.loader.assetLoader,e),i.loader.subPackPipe=e}const r=i.loader._assetTables;for(const e in r)r[e].reset();const o=e.rawAssets;if(o)for(const e in o){const t=o[e];for(const i in t){const n=t[i],s=n[0],o=n[1],a=Oe(o);if(!a){u("Cannot get",o);continue}ex[i]=new tx(e+"/"+s,a);const c=1===n[2];r[e]||(r[e]=new my),r[e].add(s,i,a,!c)}}e.packedAssets&&ky(e.packedAssets),i.url._init(e.mountPaths&&e.mountPaths.assets||Jy+"assets")}});var nx;i.AssetLibrary=ix;let sx=e("Font",Go("cc.Font")(nx=class extends sc{})||nx);var rx,ox,ax;i.Font=sx;let cx=e("TTFFont",Go("cc.TTFFont")((ax=Po((ox=class extends sx{constructor(...e){super(...e),Oo(this,"_fontFamily",ax,this)}get _nativeAsset(){return this._fontFamily}set _nativeAsset(e){this._fontFamily=e||"Arial"}}).prototype,"_fontFamily",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Po(ox.prototype,"_nativeAsset",[ya,ga],Object.getOwnPropertyDescriptor(ox.prototype,"_nativeAsset"),ox.prototype),rx=ox))||rx);var lx,hx,ux,_x,dx,mx,px,fx;i.TTFFont=cx;let gx=e("BitmapFont",(lx=Go("cc.BitmapFont"),hx=va(_h),lx((dx=Po((_x=class extends sx{constructor(...e){super(...e),Oo(this,"fntDataStr",dx,this),Oo(this,"spriteFrame",mx,this),Oo(this,"fontSize",px,this),Oo(this,"fntConfig",fx,this)}}).prototype,"fntDataStr",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mx=Po(_x.prototype,"spriteFrame",[hx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),px=Po(_x.prototype,"fontSize",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),fx=Po(_x.prototype,"fntConfig",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ux=_x))||ux));var vx;i.BitmapFont=gx;let yx=e("LabelAtlas",Go("cc.LabelAtlas")(vx=class extends gx{})||vx);i.LabelAtlas=yx;let xx=[];class Sx{constructor(){this.id="AssetLoader",this.async=!0,this.pipeline=null}handle(e,t){let n=e.uuid;if(!n)return e.content||null;i.AssetLibrary.queryAssetInfo(n,(i,s,r)=>{if(i)t(i);else if(e.url=e.rawUrl=s,e.isRawAsset=r,r){let i=D(s).toLowerCase();if(!i)return void t(new Error(C(4931,n,s)));i=i.substr(1);let r=Ay.getQueue(e);xx[0]={queueId:e.queueId,id:s,url:s,type:i,error:null,alias:e,complete:!0},r&&r.append(xx),e.type=i,t(null,e.content)}else e.type="uuid",t(null,e.content)})}}function Tx(e,t){let n=i.loader.getItem(e);if(n){let e=n.dependKeys;if(e)for(let i=0;i<e.length;i++){let n=e[i];t[n]||(t[n]=!0,Tx(n,t))}}}function Ex(e,t){if(!e._uuid)return;let n=i.loader._getReferenceKey(e);t[n]||(t[n]=!0,Tx(n,t))}function Ax(e,t){let i=Object.getOwnPropertyNames(e);for(let n=0;n<i.length;n++){let s=e[i[n]];if("object"==typeof s&&s)if(Array.isArray(s))for(let e=0;e<s.length;e++){let i=s[e];i instanceof Qa&&Ex(i,t)}else if(s.constructor&&s.constructor!==Object)s instanceof Qa&&Ex(s,t);else{let e=Object.getOwnPropertyNames(s);for(let i=0;i<e.length;i++){let n=s[e[i]];n instanceof Qa&&Ex(n,t)}}}}function Cx(e,t){for(let i=0;i<e._components.length;i++)Ax(e._components[i],t);for(let i=0;i<e._children.length;i++)Cx(e._children[i],t)}function bx(e){let t={};return Tx(e,t),Object.keys(t)}function Rx(e,t){var n=e.url,s=i.loader.getXMLHttpRequest(),r="Load binary data failed: "+n;s.open("GET",n,!0),s.responseType="arraybuffer",s.onload=function(){var e=s.response;e?t(null,e):t({status:s.status,errorMessage:r+"(no response)"})},s.onerror=function(){t({status:s.status,errorMessage:r+"(error)"})},s.ontimeout=function(){t({status:s.status,errorMessage:r+"(time out)"})},s.send(null)}function wx(e,t){let n=e.url;n=By(n);let s=i.loader.getXMLHttpRequest(),r="Load text file failed: "+n;s.open("GET",n,!0),s.overrideMimeType&&s.overrideMimeType("text/plain; charset=utf-8"),s.onload=function(){4===s.readyState?200===s.status||0===s.status?t(null,s.responseText):t({status:s.status,errorMessage:r+"(wrong status)"}):t({status:s.status,errorMessage:r+"(wrong readyState)"})},s.onerror=function(){t({status:s.status,errorMessage:r+"(error)"})},s.ontimeout=function(){t({status:s.status,errorMessage:r+"(time out)"})},s.send(null)}Sx.ID="AssetLoader",Ry.AssetLoader=Sx;const Ix={INITIALIZING:0,PLAYING:1,STOPPED:2};class Ox{constructor(e){this._state=Ix.STOPPED,this._duration=0,this._eventTarget=void 0,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._blocking=!1,this._duration=e.duration,this._eventTarget=e.eventTarget,this._onHide=()=>{this._blocking=!0,this._state===Ix.PLAYING&&(this.pause(),this._interrupted=!0)},this._onShow=()=>{this._blocking=!1,this._interrupted&&(this.play(),this._interrupted=!1)},i.game.on(i.Game.EVENT_HIDE,this._onHide),i.game.on(i.Game.EVENT_SHOW,this._onShow)}getState(){return this._state}getDuration(){return this._duration}destroy(){i.game.off(i.Game.EVENT_HIDE,this._onHide),i.game.off(i.Game.EVENT_SHOW,this._onShow)}}i.internal.AudioPlayer=Ox;class Px extends Ox{constructor(e){super(e),this._volume=1,this._loop=!1,this._oneShotOngoing=!1,this._audio=void 0,this._cbRegistered=!1,this._remove_cb=void 0,this._post_play=void 0,this._on_gesture=void 0,this._post_gesture=void 0,this._audio=e.clip,this._remove_cb=()=>{this._cbRegistered&&(i.game.canvas.removeEventListener("touchend",this._on_gesture),i.game.canvas.removeEventListener("mouseup",this._on_gesture),this._cbRegistered=!1)},this._post_play=()=>{this._state=Ix.PLAYING,this._eventTarget.emit("started"),this._remove_cb()},this._post_gesture=()=>{this._interrupted?(this._post_play(),this._interrupted=!1):(this._audio.pause(),this._audio.currentTime=0)},this._on_gesture=()=>{if(!this._audio)return;const e=this._audio.play();if(!e)return this._state=Ix.PLAYING,void i.director.once(i.Director.EVENT_AFTER_UPDATE,this._post_gesture);e.then(this._post_gesture),this._remove_cb()},this._audio.volume=this._volume,this._audio.loop=this._loop,this._audio.addEventListener("ended",()=>{this._oneShotOngoing||(this._state=Ix.STOPPED,this._audio.currentTime=0,this._eventTarget.emit("ended"))}),i.game.canvas.addEventListener("touchend",this._on_gesture),i.game.canvas.addEventListener("mouseup",this._on_gesture),this._cbRegistered=!0}play(){if(!this._audio||this._state===Ix.PLAYING)return;if(this._blocking)return void(this._interrupted=!0);const e=this._audio.play();if(!e)return this._state=Ix.PLAYING,void i.director.once(i.Director.EVENT_AFTER_UPDATE,this._post_play);e.then(this._post_play).catch(()=>{this._interrupted=!0})}pause(){this._audio&&this._state===Ix.PLAYING&&(this._audio.pause(),this._state=Ix.STOPPED,this._oneShotOngoing=!1)}stop(){this._audio&&(this._audio.currentTime=0,this._state===Ix.PLAYING&&(this._audio.pause(),this._state=Ix.STOPPED,this._oneShotOngoing=!1))}playOneShot(e=1){const t=this._audio;t&&(t.currentTime=0,t.volume=e,this._oneShotOngoing||(t.loop=!1,this._oneShotOngoing=!0,t.play().then(()=>{t.addEventListener("ended",()=>{t.currentTime=0,t.volume=this._volume,t.loop=this._loop,this._oneShotOngoing=!1},{once:!0})}).catch(()=>{this._oneShotOngoing=!1})))}setCurrentTime(e){this._audio&&(this._audio.currentTime=jt(e,0,this._duration))}getCurrentTime(){return this._audio?this._audio.currentTime:0}setVolume(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}getVolume(){return this._audio?this._audio.volume:this._volume}setLoop(e){this._loop=e,this._audio&&(this._audio.loop=e)}getLoop(){return this._loop}destroy(){this._audio&&(this._audio.src=""),super.destroy()}}const Mx=Oa.__audioSupport;class Dx extends Ox{constructor(e){super(e),this._startTime=0,this._offset=0,this._volume=1,this._loop=!1,this._currentTimer=0,this._audio=void 0,this._context=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._startInvoked=!1,this._onEndedCB=void 0,this._onGestureCB=void 0,this._onGestureProceedCB=void 0,this._audio=e.clip,this._context=Mx.context,this._sourceNode=this._context.createBufferSource(),this._gainNode=this._context.createGain(),this._gainNode.connect(this._context.destination),this._onEndedCB=this._onEnded.bind(this),this._onGestureCB=this._onGesture.bind(this),this._onGestureProceedCB=this._onGestureProceed.bind(this),"running"!==this._context.state&&this._context.resume&&(i.game.canvas.addEventListener("touchend",this._onGestureCB),i.game.canvas.addEventListener("mouseup",this._onGestureCB))}play(){if(this._audio&&this._state!==Ix.PLAYING)return this._blocking||"running"!==this._context.state?(this._interrupted=!0,void("interrupted"===this._context.state&&this._context.resume&&this._onGesture())):void this._doPlay()}pause(){this._state===Ix.PLAYING&&(this._doStop(),this._offset+=this._context.currentTime-this._startTime,this._state=Ix.STOPPED,clearInterval(this._currentTimer))}stop(){this._offset=0,this._state===Ix.PLAYING&&(this._doStop(),this._state=Ix.STOPPED,clearInterval(this._currentTimer))}playOneShot(e=1){if(!this._audio)return;const t=this._context.createGain();t.connect(this._context.destination),t.gain.value=e;const i=this._context.createBufferSource();i.buffer=this._audio,i.loop=!1,i.connect(t),i.start()}setCurrentTime(e){this._offset=jt(e,0,this._audio&&this._audio.duration||this._duration),this._state===Ix.PLAYING&&(this._doStop(),this._doPlay())}getCurrentTime(){return this._state!==Ix.PLAYING?this._offset:this._context.currentTime-this._startTime+this._offset}setVolume(e,t){this._volume=e,!t&&this._gainNode.gain.setTargetAtTime?this._gainNode.gain.setTargetAtTime(e,this._context.currentTime,.01):this._gainNode.gain.value=e}getVolume(){return this._volume}setLoop(e){this._loop=e,this._sourceNode.loop=e}getLoop(){return this._loop}destroy(){super.destroy()}_doPlay(){this._state=Ix.PLAYING,this._sourceNode=this._context.createBufferSource(),this._sourceNode.buffer=this._audio,this._sourceNode.loop=this._loop,this._sourceNode.connect(this._gainNode),this._startTime=this._context.currentTime,this._startInvoked=!1,i.director.once(i.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this),clearInterval(this._currentTimer),this._currentTimer=window.setInterval(()=>{this._onEnded(),clearInterval(this._currentTimer),this._sourceNode.loop&&(this._currentTimer=window.setInterval(this._onEndedCB,1e3*this._audio.duration))},1e3*(this._audio.duration-this._offset))}_doStop(){this._startInvoked?this._sourceNode.stop():i.director.off(i.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this)}_playAndEmit(){this._sourceNode.start(0,this._offset),this._eventTarget.emit("started"),this._startInvoked=!0}_onEnded(){this._offset=0,this._startTime=this._context.currentTime,this._sourceNode.loop||(this._eventTarget.emit("ended"),this._state=Ix.STOPPED)}_onGestureProceed(){this._interrupted&&(this._doPlay(),this._interrupted=!1),i.game.canvas.removeEventListener("touchend",this._onGestureCB),i.game.canvas.removeEventListener("mouseup",this._onGestureCB)}_onGesture(){"running"!==this._context.state?this._context.resume().then(this._onGestureProceedCB):this._onGestureProceed()}}var Lx,Bx,Nx,Fx,zx,Ux,Gx,Hx;const Vx=Ye({WEB_AUDIO:0,DOM_AUDIO:1,JSB_AUDIO:2,UNKNOWN_AUDIO:3});let kx=(Lx=Go("cc.AudioClip"),Bx=va(Vx),Lx((Hx=Gx=class extends sc{constructor(){super(),Oo(this,"_duration",zx,this),Oo(this,"_loadMode",Ux,this),this._audio=null,this._player=null,this.loaded=!1}destroy(){return this._player&&this._player.destroy(),super.destroy()}set _nativeAsset(e){if(this._audio=e,e){const t=this._getPlayer(e);this._player=new t({clip:e,duration:this._duration,eventTarget:this}),this.loaded=!0,this.emit("load")}else this._player=null,this._loadMode=Vx.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1}get _nativeAsset(){return this._audio}get loadMode(){return this._loadMode}get state(){return this._player?this._player.getState():Ix.INITIALIZING}play(){this._player&&this._player.play()}pause(){this._player&&this._player.pause()}stop(){this._player&&this._player.stop()}playOneShot(e){this._player&&this._player.playOneShot(e)}setCurrentTime(e){this._player&&this._player.setCurrentTime(e)}getCurrentTime(){return this._player?this._player.getCurrentTime():0}getDuration(){return this._player?this._player.getDuration():this._duration}setVolume(e,t){this._player&&this._player.setVolume(e,t||!1)}getVolume(){return this._player?this._player.getVolume():1}setLoop(e){this._player&&this._player.setLoop(e)}getLoop(){return!!this._player&&this._player.getLoop()}_getPlayer(e){let t;return"undefined"!=typeof AudioBuffer&&e instanceof AudioBuffer?(t=Dx,this._loadMode=Vx.WEB_AUDIO):(t=Px,this._loadMode=Vx.DOM_AUDIO),t}},Gx.PlayingState=Ix,Gx.AudioType=Vx,Gx.preventDeferredLoadDependents=!0,zx=Po((Fx=Hx).prototype,"_duration",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ux=Po(Fx.prototype,"_loadMode",[Bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vx.UNKNOWN_AUDIO}}),Nx=Fx))||Nx);i.AudioClip=kx;const Wx=Oa.__audioSupport,jx=Wx.format;function qx(e,t){const i=document.createElement("audio");i.src=e.url;const n=()=>{clearTimeout(s),i.removeEventListener("canplaythrough",r,!1),i.removeEventListener("error",o,!1),Wx.USE_LOADER_EVENT&&i.removeEventListener(Wx.USE_LOADER_EVENT,r,!1)},s=setTimeout(()=>{0===i.readyState?o():r()},8e3),r=()=>{n(),t(null,i)},o=()=>{n();const i="load audio failure - "+e.url;l(i),t(i)};i.addEventListener("canplaythrough",r,!1),i.addEventListener("error",o,!1),Wx.USE_LOADER_EVENT&&i.addEventListener(Wx.USE_LOADER_EVENT,r,!1)}function Xx(e,t){const n=Wx.context;n||t(new Error(C(4926)));const s=i.loader.getXMLHttpRequest();s.open("GET",e.url,!0),s.responseType="arraybuffer",s.onload=()=>{n.decodeAudioData(s.response,e=>{t(null,e)},()=>{t("decode error - "+e.id,null)})},s.onerror=()=>{t("request error - "+e.id,null)},s.send()}function Yx(e,t){if(0===jx.length)return new Error(C(4927));let i;if(Wx.WEB_AUDIO){i=e._owner instanceof kx?e._owner.loadMode===Vx.WEB_AUDIO?Xx:qx:e.urlParam&&e.urlParam.useDom?qx:Xx}else i=qx;i(e,t)}function Kx(){return null}function Zx(e,t,i){let n=e.url,s=document,r=document.createElement("script");function o(){r.parentNode&&r.parentNode.removeChild(r),r.removeEventListener("load",o,!1),r.removeEventListener("error",a,!1),t(null,n)}function a(){r.parentNode&&r.parentNode.removeChild(r),r.removeEventListener("load",o,!1),r.removeEventListener("error",a,!1),t(new Error(C(4928,n)))}r.async=!!i,r.src=By(n),r.addEventListener("load",o,!1),r.addEventListener("error",a,!1),s.body.appendChild(r)}function $x(e,t,i,n){void 0===i&&(i=!0);let s=By(e.url);function r(){n.removeEventListener("load",r),n.removeEventListener("error",o),n.id=e.id,t(null,n)}function o(){n.removeEventListener("load",r),n.removeEventListener("error",o),"https:"!==window.location.protocol&&n.crossOrigin&&"anonymous"===n.crossOrigin.toLowerCase()?$x(e,t,!1,n):t(new Error(C(4930,s)))}if(n=n||new Image,i&&"file:"!==window.location.protocol?n.crossOrigin="anonymous":n.crossOrigin=null,n.complete&&n.naturalWidth>0&&n.src===s)return n;n.addEventListener("load",r),n.addEventListener("error",o),n.src=s}let Qx={js:Zx,png:$x,jpg:$x,bmp:$x,jpeg:$x,gif:$x,ico:$x,tiff:$x,webp:$x,image:$x,pvr:Rx,pkm:Rx,astc:Rx,mp3:Yx,ogg:Yx,wav:Yx,m4a:Yx,txt:wx,xml:wx,vsh:wx,fsh:wx,atlas:wx,tmx:wx,tsx:wx,json:wx,ExportJson:wx,plist:wx,fnt:wx,font:Kx,eot:Kx,ttf:Kx,woff:Kx,svg:Kx,ttc:Kx,uuid:function(e,t){let i=Xy(e,t);return void 0===i?this.extMap.json(e,t):i||void 0},binary:Rx,bin:Rx,default:wx};class Jx{constructor(e){this.id="Downloader",this.async=!0,this.pipeline=null,this.extMap=void 0,this._curConcurrent=0,this._loadQueue=[],this._subPackages={},this.extMap=ye(e,Qx)}setSubPackages(e){this._subPackages=e}addHandlers(e){ye(this.extMap,e)}_handleLoadQueue(){for(;this._curConcurrent<i.macro.DOWNLOAD_MAX_CONCURRENT;){let e=this._loadQueue.shift();if(!e)break;let t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}handle(e,t){let n=this,s=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<i.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,r=s.call(this,e,(function(e,i){n._curConcurrent=Math.max(0,n._curConcurrent-1),n._handleLoadQueue(),t&&t(e,i)})),void 0!==r)return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(r=s.call(this,e,t),void 0!==r)return r}else this._loadQueue.push({item:e,callback:t})}loadSubpackage(e,t){let i=this._subPackages[e];i?i.loaded?t&&t():Zx({url:i.path},(function(e){e||(i.loaded=!0),t&&t(e)})):t&&t(new Error("Can't find subpackage "+e))}}e("Downloader",Jx),Jx.ID="Downloader",Jx.PackDownloader=Yy,Ry.Downloader=Jx;let eS=new class extends class{constructor(){this._isSupportDOMParser=void 0,this._parser=void 0,window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}parse(e){return this._parseXML(e)}_parseXML(e){let t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):(t=new ActiveXObject("Microsoft.XMLDOM"),t.async="false",t.loadXML(e)),t}}{parse(e){let t=this._parseXML(e),i=t.documentElement;if("plist"!==i.tagName)return y(5100),{};let n=null;for(let e=0,t=i.childNodes.length;e<t&&(n=i.childNodes[e],1!==n.nodeType);e++);return t=null,this._parseNode(n)}_parseNode(e){let t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(let i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}_parseArray(e){let t=[];for(let i=0,n=e.childNodes.length;i<n;i++){let n=e.childNodes[i];1===n.nodeType&&t.push(this._parseNode(n))}return t}_parseDict(e){let t={},i=null;for(let n=0,s=e.childNodes.length;n<s;n++){let s=e.childNodes[n];1===s.nodeType&&("key"===s.tagName?i=s.firstChild.nodeValue:t[i]=this._parseNode(s))}return t}};function tS(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function iS(e,t){let n,s;if("string"==typeof e.content)try{if(n=JSON.parse(e.content),n.keys&&n.data){let e=n.keys;n=n.data,Ny(n,e)}}catch(t){return new Error(C(4923,e.id,t.stack))}else{if("object"!=typeof e.content)return new Error(C(4924));n=e.content}if(null==n)return new Error(C(4923,e.id));let r=tS(n);s=r?i._MissingScript.safeFindClass:function(e){let t=Oe(e);return t||(y(4903,e),Object)};let o,a=i.deserialize.Details.pool.get();try{o=i.deserialize(n,a,{classFinder:s,target:e.existingAsset,customEnv:e})}catch(t){return i.deserialize.Details.pool.put(a),console.error(t),new Error(`Failed to load asset ${e.id}, exception occurs during deserialization: ${t+"\n"+t.stack}.`)}o._uuid=e.uuid;let c=function(e,t,n,s){let r,o,a,c=n.uuidList,l=n.uuidObjList,h=n.uuidPropList,u=n._stillUseUrl,_=e.dependKeys=[];if(s)for(r=[],o=0;o<c.length;o++){a=c[o];let e=l[o],t=h[o],n=i.AssetLibrary._getAssetInfoInRuntime(a);if(n.raw){let i=n.url;e[t]=i,_.push(i)}else r.push({type:"uuid",uuid:a,deferredLoadRaw:!0,_owner:e,_ownerProp:t,_stillUseUrl:u[o]})}else{for(r=new Array(c.length),o=0;o<c.length;o++)a=c[o],r[o]={type:"uuid",uuid:a,_owner:l[o],_ownerProp:h[o],_stillUseUrl:u[o]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(e,o,a,function(e,t,n){let s=t.deferredLoadRaw;return s?e instanceof i.Asset&&e.constructor.preventDeferredLoadDependents&&(s=!1):n&&(e instanceof i.SceneAsset||e instanceof i.Prefab)&&(s=e.asyncLoadAssets),s}(o,e,r));i.deserialize.Details.pool.put(a);let l=function(e,i){if(!e&&i.onLoaded)try{i.onLoaded()}catch(t){e=t}t(e,i)};if(0===c.length)return l(null,o);!function(e,t,n,s,r){t.content=n;let o=t.dependKeys;e.flowInDeps(t,s,(function(e,t){let a,c=t.map;for(let e in c)a=c[e],a.uuid&&a.content&&(a.content._uuid=a.uuid);for(let e=0;e<s.length;e++){let t=s[e],r=t.uuid,h=t.url;t._owner,t._ownerProp;if(a=c[h],!a)continue;let u=t;function l(e){let t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==n._uuid&&o.indexOf(e.id)<0&&o.push(e.id)}if(a.complete||a.content)a.error?i._throw(a.error):l.call(u,a);else{let e=Ay.getQueue(a);e&&e.addListener(r,l,u)}}if(n instanceof i.SceneAsset&&n.scene){const e=Object.create(null);for(let t=0,i=o.length;t<i;t++)e[o[t]]=!0,bx(o[t]).forEach(t=>{e[t]=!0});n.scene.dependAssets=Object.keys(e)}r(e,n)}))}(this.pipeline,e,o,c,l)}iS.isSceneObj=tS;let nS=null;let sS={},rS=-1,oS=[],aS=function(){let e;return function(){if(!e)if(window.FontFace){var t=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),i=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);e=t?parseInt(t[1],10)>42:!i}else e=!1;return e}}();function cS(){let e=!0,t=Date.now();for(let i=oS.length-1;i>=0;i--){let n=oS[i],s=n.fontFamilyName;if(t-n.startTime>3e3){y(4933,s),n.callback(null,s),oS.splice(i,1);continue}let r=n.refWidth;nS.font="40px "+s,r!==Ao(nS,"BES bswy:->@123")?(oS.splice(i,1),n.callback(null,s)):e=!1}e&&(clearInterval(rS),rS=-1)}function lS(e,t){let i=e.url,n=function(e){let t=e.lastIndexOf(".ttf");if(-1===t)return e;let i,n=e.lastIndexOf("/");i=-1===n?e.substring(0,t)+"_LABEL":e.substring(n+1,t)+"_LABEL";-1!==i.indexOf(" ")&&(i='"'+i+'"');return i}(i);if(sS[n])return n;if(!nS){let e=document.createElement("canvas");e.width=100,e.height=100,nS=e.getContext("2d")}let s="40px "+n;nS.font=s;let r=Ao(nS,"BES bswy:->@123"),o=document.createElement("style");o.type="text/css";let a="";isNaN(n-0)?a+="@font-face { font-family:"+n+"; src:":a+="@font-face { font-family:'"+n+"'; src:",a+="url('"+i+"');",o.textContent=a+"}",document.body.appendChild(o);let c=document.createElement("div"),l=c.style;if(l.fontFamily=n,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),aS())!function(e,t,i){var n=new Promise((function(i,n){var s=function(){Date.now()-e>=3e3?n():document.fonts.load("40px "+t).then((function(e){e.length>=1?i():setTimeout(s,100)}),(function(){n()}))};s()}));let s,r=new Promise((function(e,t){s=setTimeout(t,3e3)}));Promise.race([r,n]).then((function(){s&&(clearTimeout(s),s=null),i(null,t)}),(function(){y(4933,t),i(null,t)}))}(Date.now(),n,t);else{let e={fontFamilyName:n,refWidth:r,callback:t,startTime:Date.now()};oS.push(e),-1===rS&&(rS=setInterval(cS,100))}sS[n]=o}function hS(e){if("string"!=typeof e.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(e.content)}catch(t){return new Error("JSON Loader: Parse json ["+e.id+"] failed : "+t)}}function uS(e){if(e._owner instanceof i.Asset)return null;let t=e.content;if(i.sys.platform!==i.sys.FB_PLAYABLE_ADS&&!(t instanceof Image))return new Error("Image Loader: Input item doesn't contain Image content");let n=e.rawUrl,s=e.imageAsset||new mc;return s._uuid=e.uuid,s._url=n,s._setRawAsset(n,!1),s._nativeAsset=t,s}function _S(e,t){if(e._owner instanceof i.Asset)return null;let n=new i.AudioClip;return n._setRawAsset(e.rawUrl,!1),n._nativeAsset=e.content,n}function dS(e){return e.load?e.load(e.content):e.content}function mS(e,t){return e[t]<<8|e[t+1]}let pS={png:uS,jpg:uS,bmp:uS,jpeg:uS,gif:uS,ico:uS,tiff:uS,webp:uS,image:uS,pvr:function(e){let t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Int32Array(t,0,13);if(55727696===i[0]){let e=i[7],n=i[6],s=i[12]+52;return t=t.slice(s,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:e,height:n}}if(559044176===i[11]){let e=i[0],n=i[1],s=i[2];return t=t.slice(e,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:s,height:n}}return new Error("Invalid magic number in PVR header")},pkm:function(e){let t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t),n=mS(i,6);if(0!==n&&1!==n&&3!==n)return new Error("Invalid magic number in ETC header");let s=mS(i,12),r=mS(i,14);return mS(i,8),mS(i,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:s,height:r}},astc:function(e){let t=e.content instanceof ArrayBuffer?e.content:e.content.buffer;const i=new Uint8Array(t);if(1554098963!==i[0]+(i[1]<<8)+(i[2]<<16)+(i[3]<<24))return new Error("Invalid magic number in ASTC header");const n=i[4],s=i[5],r=i[6];if((n<3||n>6||s<3||s>6||r<3||r>6)&&(n<4||7===n||9===n||11===n||n>12||s<4||7===s||9===s||11===s||s>12||1!==r))return new Error("Invalid block number in ASTC header");const o=function(e,t){return 4===e?rc.RGBA_ASTC_4x4:5===e?4===t?rc.RGBA_ASTC_5x4:rc.RGBA_ASTC_5x5:6===e?5===t?rc.RGBA_ASTC_6x5:rc.RGBA_ASTC_6x6:8===e?5===t?rc.RGBA_ASTC_8x5:6===t?rc.RGBA_ASTC_8x6:rc.RGBA_ASTC_8x8:10===e?5===t?rc.RGBA_ASTC_10x5:6===t?rc.RGBA_ASTC_10x6:8===t?rc.RGBA_ASTC_10x8:rc.RGBA_ASTC_10x10:10===t?rc.RGBA_ASTC_12x10:rc.RGBA_ASTC_12x12}(n,s),a=i[7]+(i[8]<<8)+(i[9]<<16),c=i[10]+(i[11]<<8)+(i[12]<<16);return t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:a,height:c,format:o}},mp3:_S,ogg:_S,wav:_S,m4a:_S,json:hS,ExportJson:hS,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");let t=eS.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:iS,prefab:iS,fire:iS,scene:iS,binary:dS,bin:dS,font:lS,eot:lS,ttf:lS,woff:lS,svg:lS,ttc:lS,default:function(){return null}};class fS{constructor(e){this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=void 0,this.extMap=ye(e,pS)}addHandlers(e){this.extMap=ye(this.extMap,e)}handle(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}e("Loader",fS),fS.ID="Loader",Ry.Loader=fS;const gS=Object.create(null);function vS(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}gS.assets=new my,gS.internal=new my;const yS={url:null,raw:!1};function xS(e){let t,n,s;if("object"==typeof e){if(n=e,e.url)return n;t=e.uuid}else n={},t=e;return s=n.type?"uuid"===n.type:i.AssetLibrary._uuidInSettings(t),i.AssetLibrary._getAssetInfoInRuntime(t,yS),n.url=s?yS.url:t,yS.url&&"uuid"===n.type&&yS.raw?(n.type=null,n.isRawAsset=!0):s||(n.isRawAsset=!0),n}const SS=[],TS=[];const ES=e("loader",i.loader=new class extends Ry{constructor(){const e=new Sx,t=new Jx,i=new fS;super([e,t,i]),this.getXMLHttpRequest=void 0,this.assetLoader=void 0,this.md5Pipe=void 0,this.downloader=void 0,this.loader=void 0,this.onProgress=void 0,this._assetTables=void 0,this._autoReleaseSetting=void 0,this._releasedAssetChecker_DEBUG=void 0,this.getXMLHttpRequest=vS,this.assetLoader=e,this.md5Pipe=null,this.downloader=t,this.loader=i,this.onProgress=null,this._assetTables=gS,this._autoReleaseSetting=ce(!0)}init(e){}addDownloadHandlers(e){this.downloader.addHandlers(e)}addLoadHandlers(e){this.loader.addHandlers(e)}load(e,t,i){void 0===i&&(i=t,t=this.onProgress||null);const n=this;let s,r,o=!1;e instanceof Array?s=e:e?(o=!0,s=[e]):s=[],SS.length=0;for(let e=0;e<s.length;++e){const t=s[e];if(t&&t.id&&(y(4920,t.id),t.uuid||t.url||(t.url=t.id)),r=xS(t),!r.url&&!r.uuid)continue;const i=this._cache[r.url];SS.push(i||r)}const a=Ay.create(this,t,(e,t)=>{ke(()=>{if(i){if(o){const e=r.url;i.call(n,t.getError(e),t.getContent(e))}else i.call(n,e,t);i=null}t.destroy()})});Ay.initQueueDeps(a),a.append(SS),SS.length=0}flowInDeps(e,t,i){TS.length=0;for(let e=0;e<t.length;++e){const i=xS(t[e]);if(!i.url&&!i.uuid)continue;const n=this._cache[i.url];n?TS.push(n):TS.push(i)}const n=Ay.create(this,e?(e,t,i)=>{n._ownerQueue&&n._ownerQueue.onProgress&&n._ownerQueue._childOnProgress(i)}:null,(t,n)=>{i(t,n),e&&e.deps&&(e.deps.length=0),n.destroy()});if(e){const t=Ay.getQueue(e);n._ownerQueue=t&&t._ownerQueue||t}const s=n.append(TS,e);return TS.length=0,s}loadRes(e,t,i,n,s){5!==arguments.length&&(s=n,n=i,i="assets");const r=this._parseLoadResArgs(t,n,s);t=r.type,n=r.onProgress,s=r.onComplete;const o=this,a=o._getResUuid(e,t,i,!0);a?this.load({type:"uuid",uuid:a},n,(e,t)=>{t&&o.setAutoReleaseRecursively(a,!1),s&&s(e,t)}):o._urlNotFound(e,t,s)}loadResDir(e,t,i,n,s){if(5!==arguments.length&&(s=n,n=i,i="assets"),!gS[i])return;const r=this._parseLoadResArgs(t,n,s);t=r.type,n=r.onProgress,s=r.onComplete;const o=[],a=gS[i].getUuidArray(e,t,o);this._loadResUuids(a,n,(e,t,i)=>{const n=t.length;for(let e=0;e<n;++e)if(t[e]instanceof $v){const n=t[e].getSpriteFrames();for(const s in n){const r=n[s];t.push(r),i&&i.push(`${i[e]}/${r.name}`)}}s&&s(e,t,i)},o)}loadResArray(e,t,i,n,s){5!==arguments.length&&(s=n,n=i,i="assets");const r=this._parseLoadResArgs(t,n,s);t=r.type,n=r.onProgress,s=r.onComplete;const o=[];for(let n=0;n<e.length;n++){const r=e[n],a=this._getResUuid(r,t,i,!0);if(!a)return void this._urlNotFound(r,t,s);o.push(a)}this._loadResUuids(o,n,s)}getRes(e,t){let i=this._cache[e];if(!i){const n=this._getResUuid(e,t,null,!0);if(!n)return null;{const e=this._getReferenceKey(n);i=this._cache[e]}}return i&&i.alias&&(i=i.alias),i&&i.complete?i.content:null}getResCount(){return Object.keys(this._cache).length}getDependsRecursively(e){if(e){const t=this._getReferenceKey(e),i=bx(t);return i.push(t),i}return[]}release(e){if(Array.isArray(e))for(let t=0;t<e.length;t++){const i=e[t];this.release(i)}else if(e){const t=this._getReferenceKey(e),i=this.getItem(t);if(i){this.removeItem(t);if((e=i.content)instanceof sc){const t=e.nativeUrl;t&&this.release(t),e.destroy()}}}}releaseAsset(e){const t=e._uuid;t&&this.release(t)}releaseRes(e,t,i){const n=this._getResUuid(e,t,i,!0);n?this.release(n):S(4914,e)}releaseResDir(e,t,i){if(!gS[i=i||"assets"])return;const n=gS[i].getUuidArray(e,t);for(let e=0;e<n.length;e++){const t=n[e];this.release(t)}}releaseAll(){for(const e in this._cache)this.release(e)}removeItem(e){const t=Ry.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}setAutoRelease(e,t){const i=this._getReferenceKey(e);i&&(this._autoReleaseSetting[i]=!!t)}setAutoReleaseRecursively(e,t){t=!!t;const i=this._getReferenceKey(e);if(i){this._autoReleaseSetting[i]=t;const e=bx(i);for(let i=0;i<e.length;i++){const n=e[i];this._autoReleaseSetting[n]=t}}}isAutoRelease(e){const t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}_getResUuid(e,t,i,n){let s="";{const r=gS[i=i||"assets"];if(e&&r){const i=e.indexOf("?");if(-1!==i&&(e=e.substr(0,i)),s=r.getUuid(e,t),!s){const i=D(e);i&&(e=e.slice(0,-i.length),s=r.getUuid(e,t),s&&!n&&y(4901,e,i))}}}return!s&&t&&(Te(t,_h)||Te(t,jc)||Te(t,yh))&&y(4934),s}_getReferenceKey(e){let t;return"object"==typeof e?t=e._uuid||null:"string"==typeof e&&(t=this._getResUuid(e,void 0,void 0,!0)||e),t?(i.AssetLibrary._getAssetInfoInRuntime(t,yS),this._cache[yS.url]?yS.url:t):(y(4800,e),t)}_urlNotFound(e,t,n){ke(()=>{e=i.url.normalize(e);const s=`${t?le(t):"Asset"} in "resources/${e}" does not exist.`;n&&n(new Error(s),[])})}_parseLoadResArgs(e,t,n){if(void 0===n){const s=Te(e,i.RawAsset);t?(n=t,s&&(t=this.onProgress||null)):void 0!==t||s||(n=e,t=this.onProgress||null,e=null),void 0===t||s||(t=e,e=null)}return{type:e,onProgress:t,onComplete:n}}_loadResUuids(e,t,i,n){if(e.length>0){const s=this,r=e.map(e=>({type:"uuid",uuid:e}));this.load(r,t,(e,t)=>{if(i){const o=[],a=n&&[];for(let e=0;e<r.length;++e){const i=r[e].uuid,c=s._getReferenceKey(i),l=t.getContent(c);l&&(s.setAutoReleaseRecursively(i,!1),o.push(l),a&&a.push(n[e]))}n?i(e,o,a):i(e,o)}})}else i&&ke(()=>{n?i(null,[],[]):i(null,[])})}});var AS,CS,bS,RS,wS,IS,OS,PS,MS=Object.freeze({__proto__:null,loadImage:function(e,t,i){E(!!e,3103);let n=ES.getRes(e);return n?n.loaded?(t&&t.call(i,null,n),n):(n.once("load",()=>{t&&t.call(i,null,n)},i),n):(n=new mc,ES.load({url:e,imageAsset:n},(e,s)=>{if(e)return t&&t.call(i,e||new Error("Unknown error")),n;t&&t.call(i,null,s)}),n)},cacheImage:function(e,t){if(e&&t){const i=new mc(t),n={id:e,url:e,error:null,content:i,complete:!1};return ES.flowOut(n),i}},postLoadImage:function(e,t){e.loaded?t&&t():e.nativeUrl?ES.load({url:e.nativeUrl,skips:e.isCompressed?void 0:["Loader"]},(i,n)=>{n&&(e.loaded||(e._nativeAsset=n)),t&&t(i)}):t&&t()}});e("textureUtil",MS);let DS=e("Skeleton",(AS=Go("cc.Skeleton"),CS=va([lt]),bS=va([wi]),AS((IS=Po((wS=class extends sc{constructor(...e){super(...e),Oo(this,"_joints",IS,this),Oo(this,"_bindposes",OS,this),Oo(this,"_hash",PS,this),this._invBindposes=null}get joints(){return this._joints}set joints(e){this._joints=e}get bindposes(){return this._bindposes}set bindposes(e){this._bindposes=e}get inverseBindposes(){if(!this._invBindposes){this._invBindposes=[];for(let e=0;e<this._bindposes.length;e++){const t=new wi;wi.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}get hash(){if(!this._hash){let e="";for(let t=0;t<this._bindposes.length;t++){const i=this._bindposes[t];e+=i.m00.toPrecision(2)+" "+i.m01.toPrecision(2)+" "+i.m02.toPrecision(2)+" "+i.m03.toPrecision(2)+" "+i.m04.toPrecision(2)+" "+i.m05.toPrecision(2)+" "+i.m06.toPrecision(2)+" "+i.m07.toPrecision(2)+" "+i.m08.toPrecision(2)+" "+i.m09.toPrecision(2)+" "+i.m10.toPrecision(2)+" "+i.m11.toPrecision(2)+" "+i.m12.toPrecision(2)+" "+i.m13.toPrecision(2)+" "+i.m14.toPrecision(2)+" "+i.m15.toPrecision(2)+"\n"}this._hash=Os(e,666)}return this._hash}destroy(){return i.director.root.dataPoolManager.releaseSkeleton(this),super.destroy()}}).prototype,"_joints",[CS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OS=Po(wS.prototype,"_bindposes",[bS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PS=Po(wS.prototype,"_hash",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RS=wS))||RS));i.Skeleton=DS,Ui(Hl.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),Gi(Hl.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]),Gi(Lc.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),Ui(Eu.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction(){return this._window}}]),i.textureUtil=MS;const LS={topLeft:i.v2(0,0),topRight:i.v2(0,0),top:i.v2(0,0),bottomLeft:i.v2(0,0),bottomRight:i.v2(0,0),bottom:i.v2(0,0),center:i.v2(0,0),left:i.v2(0,0),right:i.v2(0,0),width:0,height:0,init(e){const t=this.width=e.width,i=this.height=e.height,n=e.x,s=e.y,r=s+i,o=n+t;this.topLeft.x=n,this.topLeft.y=r,this.topRight.x=o,this.topRight.y=r,this.top.x=n+t/2,this.top.y=r,this.bottomLeft.x=n,this.bottomLeft.y=s,this.bottomRight.x=o,this.bottomRight.y=s,this.bottom.x=n+t/2,this.bottom.y=s,this.center.x=n+t/2,this.center.y=s+i/2,this.left.x=n,this.left.y=s+i/2,this.right.x=o,this.right.y=s+i/2}};var BS,NS,FS,zS,US,GS,HS,VS,kS;i.visibleRect=LS;let WS=e("RenderStage",(BS=Go("RenderStage"),NS=ua(),FS=ua(),zS=ua(),BS((HS=Po((GS=class{constructor(){Oo(this,"_name",HS,this),Oo(this,"_priority",VS,this),Oo(this,"_tag",kS,this)}get name(){return this._name}get priority(){return this._priority}get tag(){return this._tag}initialize(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0}activate(e,t){this._pipeline=e,this._flow=t}}).prototype,"_name",[NS,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),VS=Po(GS.prototype,"_priority",[FS,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kS=Po(GS.prototype,"_tag",[zS,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),US=GS))||US));var jS,qS,XS,YS,KS,ZS,$S,QS,JS,eT,tT,iT;i.RenderStage=WS;let nT=e("RenderFlow",(jS=Go("RenderFlow"),qS=ua(),XS=ua(),YS=ua(),KS=ua(),ZS=va([WS]),jS((JS=Po((QS=class{constructor(){Oo(this,"_name",JS,this),Oo(this,"_priority",eT,this),Oo(this,"_tag",tT,this),Oo(this,"_stages",iT,this)}get name(){return this._name}get priority(){return this._priority}get tag(){return this._tag}get stages(){return this._stages}initialize(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0}activate(e){this._pipeline=e,this._stages.sort((e,t)=>e.priority-t.priority);for(let t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)}render(e){for(let t=0,i=this._stages.length;t<i;t++)this._stages[t].render(e)}destroy(){for(let e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0}}).prototype,"_name",[qS,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),eT=Po(QS.prototype,"_priority",[XS,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tT=Po(QS.prototype,"_tag",[YS,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iT=Po(QS.prototype,"_stages",[KS,ZS,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$S=QS))||$S));var sT,rT,oT,aT,cT,lT,hT,uT;i.RenderFlow=nT;let _T=e("RenderPipeline",(sT=Go("cc.RenderPipeline"),rT=ua(),oT=ua(),aT=va([nT]),sT((hT=Po((lT=class extends sc{constructor(...e){super(...e),Oo(this,"_tag",hT,this),Oo(this,"_flows",uT,this),this._globalDescriptorSetLayout={bindings:[],record:{}},this._localDescriptorSetLayout={bindings:[],record:{}},this._macros={},this._commandBuffers=[]}get globalDescriptorSetLayout(){return this._globalDescriptorSetLayout}get localDescriptorSetLayout(){return this._localDescriptorSetLayout}get macros(){return this._macros}get tag(){return this._tag}get flows(){return this._flows}get device(){return this._device}get descriptorSetLayout(){return this._descriptorSetLayout}get descriptorSet(){return this._descriptorSet}get commandBuffers(){return this._commandBuffers}initialize(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0}activate(){this._device=i.director.root.device,this._descriptorSetLayout=this._device.createDescriptorSetLayout({bindings:Zc.bindings}),this._descriptorSet=this._device.createDescriptorSet({layout:this._descriptorSetLayout});for(let e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0}render(e){for(let t=0;t<e.length;t++){const i=e[t];for(let e=0;e<i.flows.length;e++)i.flows[e].render(i)}}destroy(){for(let e=0;e<this._flows.length;e++)this._flows[e].destroy();this._flows.length=0,this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null);for(let e=0;e<this._commandBuffers.length;e++)this._commandBuffers[e].destroy();return this._commandBuffers.length=0,super.destroy()}}).prototype,"_tag",[rT,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uT=Po(lT.prototype,"_flows",[oT,aT,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cT=lT))||cT));var dT,mT,pT,fT,gT,vT,yT,xT,ST,TT,ET,AT,CT,bT,RT,wT,IT,OT,PT,MT,DT,LT,BT,NT,FT,zT,UT,GT,HT,VT,kT,WT,jT,qT,XT,YT,KT,ZT,$T,QT,JT,eE,tE,iE,nE,sE,rE,oE,aE,cE,lE,hE,uE,_E,dE,mE,pE,fE,gE,vE,yE,xE,SE,TE,EE,AE,CE,bE,RE,wE,IE,OE,PE,ME,DE,LE,BE,NE,FE,zE,UE,GE;let HE;i.RenderPipeline=_T,$e(Un),$e(Gn),$e(Xn),$e(qn),$e(Yn),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(HE||(HE={})),$e(HE);dT=Go("RenderTextureDesc"),mT=va(Un),pT=va(Gn),fT=va(En),dT((yT=Po((vT=class{constructor(){Oo(this,"name",yT,this),Oo(this,"type",xT,this),Oo(this,"usage",ST,this),Oo(this,"format",TT,this),Oo(this,"width",ET,this),Oo(this,"height",AT,this)}}).prototype,"name",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xT=Po(vT.prototype,"type",[mT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Un.TEX2D}}),ST=Po(vT.prototype,"usage",[pT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gn.COLOR_ATTACHMENT}}),TT=Po(vT.prototype,"format",[fT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return En.UNKNOWN}}),ET=Po(vT.prototype,"width",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),AT=Po(vT.prototype,"height",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),gT=vT));let VE,kE=(CT=Go("RenderTextureConfig"),bT=va(Eu),CT((IT=Po((wT=class{constructor(){Oo(this,"name",IT,this),Oo(this,"texture",OT,this)}}).prototype,"name",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),OT=Po(wT.prototype,"texture",[bT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RT=wT))||RT),WE=(PT=Go("MaterialConfig"),MT=va(Lu),PT((BT=Po((LT=class{constructor(){Oo(this,"name",BT,this),Oo(this,"material",NT,this)}}).prototype,"name",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),NT=Po(LT.prototype,"material",[MT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DT=LT))||DT),jE=(FT=Go("FrameBufferDesc"),zT=va([lt]),UT=va(Eu),FT((VT=Po((HT=class{constructor(){Oo(this,"name",VT,this),Oo(this,"renderPass",kT,this),Oo(this,"colorTextures",WT,this),Oo(this,"depthStencilTexture",jT,this),Oo(this,"texture",qT,this)}}).prototype,"name",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kT=Po(HT.prototype,"renderPass",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WT=Po(HT.prototype,"colorTextures",[zT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jT=Po(HT.prototype,"depthStencilTexture",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qT=Po(HT.prototype,"texture",[UT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GT=HT)),XT=Go("ColorDesc"),YT=va(En),KT=va(qn),ZT=va(Xn),$T=va(Yn),QT=va(Yn),XT((tE=Po((eE=class{constructor(){Oo(this,"format",tE,this),Oo(this,"loadOp",iE,this),Oo(this,"storeOp",nE,this),Oo(this,"sampleCount",sE,this),Oo(this,"beginLayout",rE,this),Oo(this,"endLayout",oE,this)}}).prototype,"format",[YT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return En.UNKNOWN}}),iE=Po(eE.prototype,"loadOp",[KT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qn.CLEAR}}),nE=Po(eE.prototype,"storeOp",[ZT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xn.STORE}}),sE=Po(eE.prototype,"sampleCount",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rE=Po(eE.prototype,"beginLayout",[$T],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yn.UNDEFINED}}),oE=Po(eE.prototype,"endLayout",[QT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yn.PRESENT_SRC}}),JT=eE))||JT),qE=(aE=Go("DepthStencilDesc"),cE=va(En),lE=va(qn),hE=va(Xn),uE=va(qn),_E=va(Xn),dE=va(Yn),mE=va(Yn),aE((gE=Po((fE=class{constructor(){Oo(this,"format",gE,this),Oo(this,"depthLoadOp",vE,this),Oo(this,"depthStoreOp",yE,this),Oo(this,"stencilLoadOp",xE,this),Oo(this,"stencilStoreOp",SE,this),Oo(this,"sampleCount",TE,this),Oo(this,"beginLayout",EE,this),Oo(this,"endLayout",AE,this)}}).prototype,"format",[cE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return En.UNKNOWN}}),vE=Po(fE.prototype,"depthLoadOp",[lE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qn.CLEAR}}),yE=Po(fE.prototype,"depthStoreOp",[hE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xn.STORE}}),xE=Po(fE.prototype,"stencilLoadOp",[uE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qn.CLEAR}}),SE=Po(fE.prototype,"stencilStoreOp",[_E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xn.STORE}}),TE=Po(fE.prototype,"sampleCount",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),EE=Po(fE.prototype,"beginLayout",[dE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yn.UNDEFINED}}),AE=Po(fE.prototype,"endLayout",[mE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),pE=fE))||pE);CE=Go("RenderPassDesc"),bE=va([jE]),RE=va(qE),CE((OE=Po((IE=class{constructor(){Oo(this,"index",OE,this),Oo(this,"colorAttachments",PE,this),Oo(this,"depthStencilAttachment",ME,this)}}).prototype,"index",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),PE=Po(IE.prototype,"colorAttachments",[bE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ME=Po(IE.prototype,"depthStencilAttachment",[RE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qE}}),wE=IE));!function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(VE||(VE={})),$e(VE);let XE,YE,KE,ZE=(DE=Go("RenderQueueDesc"),LE=va(VE),BE=va([lt]),DE((zE=Po((FE=class{constructor(){Oo(this,"isTransparent",zE,this),Oo(this,"sortMode",UE,this),Oo(this,"stages",GE,this)}}).prototype,"isTransparent",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UE=Po(FE.prototype,"sortMode",[LE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VE.FRONT_TO_BACK}}),GE=Po(FE.prototype,"stages",[BE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NE=FE))||NE);!function(e){e[e.GENERAL=100]="GENERAL"}(XE||(XE={}));class $E{get name(){return this._name}get window(){return this._window}set window(e){this._window=e}get priority(){return this._priority}set priority(e){this._priority=e,i.director.root&&i.director.root.sortViews()}set visibility(e){this._visibility=e}get visibility(){return this._visibility}get camera(){return this._camera}get isEnable(){return this._isEnable}get flows(){return this._flows}constructor(){this._name="",this._window=null,this._priority=0,this._visibility=Al,this._isEnable=!1,this._flows=[]}initialize(e){return this._camera=e.camera,this._name=e.name,this.priority=e.priority,this.setExecuteFlows(e.flows),!0}destroy(){this._window=null,this._priority=0}enable(e){this._isEnable=e}setExecuteFlows(e){this._flows.length=0;const t=i.director.root.pipeline.flows;if(e&&1===e.length&&"UIFlow"===e[0]){for(let e=0;e<t.length;e++)if("UIFlow"===t[e].name){this._flows.push(t[e]);break}}else for(let i=0;i<t.length;++i){const n=t[i];(n.tag===HE.SCENE||e&&-1!==e.indexOf(n.name))&&this._flows.push(n)}}onGlobalPipelineStateChanged(){const e=i.director.root.pipeline.flows;for(let t=0;t<this._flows.length;++t){const i=this._flows[t];for(let n=0;n<e.length;n++)if(e[n].name===i.name){this._flows[t]=e[n];break}}}}e("RenderView",$E);class QE{get width(){return this._width}get height(){return this._height}get framebuffer(){return this._framebuffer}get shouldSyncSizeWithSwapchain(){return this._shouldSyncSizeWithSwapchain}get hasOnScreenAttachments(){return this._hasOnScreenAttachments}get hasOffScreenAttachments(){return this._hasOffScreenAttachments}static registerCreateFunc(e){e._createWindowFun=e=>new QE(e)}constructor(e){this._title="",this._width=1,this._height=1,this._nativeWidth=1,this._nativeHeight=1,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._framebuffer=null,this._swapchainBufferIndices=0,this._shouldSyncSizeWithSwapchain=!1,this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1}initialize(e,t){void 0!==t.title&&(this._title=t.title),void 0!==t.swapchainBufferIndices&&(this._swapchainBufferIndices=t.swapchainBufferIndices),void 0!==t.shouldSyncSizeWithSwapchain&&(this._shouldSyncSizeWithSwapchain=t.shouldSyncSizeWithSwapchain),this._width=t.width,this._height=t.height,this._nativeWidth=this._width,this._nativeHeight=this._height;const{colorAttachments:i,depthStencilAttachment:n}=t.renderPassInfo;for(let t=0;t<i.length;t++)i[t].format===En.UNKNOWN&&(i[t].format=e.colorFormat);n&&n.format===En.UNKNOWN&&(n.format=e.depthStencilFormat),this._renderPass=e.createRenderPass(t.renderPassInfo);for(let t=0;t<i.length;t++){let n=null;this._swapchainBufferIndices&1<<t?this._hasOnScreenAttachments=!0:(n=e.createTexture({type:Un.TEX2D,usage:Gn.COLOR_ATTACHMENT|Gn.SAMPLED,format:i[t].format,width:this._width,height:this._height}),this._hasOffScreenAttachments=!0),this._colorTextures.push(n)}return n&&(this._swapchainBufferIndices>=0?(this._depthStencilTexture=e.createTexture({type:Un.TEX2D,usage:Gn.DEPTH_STENCIL_ATTACHMENT|Gn.SAMPLED,format:n.format,width:this._width,height:this._height}),this._hasOffScreenAttachments=!0):this._hasOnScreenAttachments=!0),this._framebuffer=e.createFramebuffer({renderPass:this._renderPass,colorTextures:this._colorTextures,depthStencilTexture:this._depthStencilTexture}),!0}destroy(){this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(let e=0;e<this._colorTextures.length;e++){const t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null)}resize(e,t){if(this._width=e,this._height=t,e>this._nativeWidth||t>this._nativeHeight){this._nativeWidth=e,this._nativeHeight=t;let i=!1;this._depthStencilTexture&&(this._depthStencilTexture.resize(e,t),i=!0);for(let n=0;n<this._colorTextures.length;n++){const s=this._colorTextures[n];s&&(s.resize(e,t),i=!0)}i&&this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorTextures:this._colorTextures,depthStencilTexture:this._depthStencilTexture}))}}}function JE(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function eA(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}e("RenderWindow",QE),function(e){e[e.FORWARD=10]="FORWARD",e[e.UI=20]="UI"}(YE||(YE={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(KE||(KE={}));class tA{constructor(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new mo(()=>({hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}),64),this.queue=new po(64,this._passDesc.sortFunc)}clear(){this.queue.clear(),this._passPool.reset()}insertRenderPass(e,t,i){const n=e.model.subModels[t],s=Uh.get(n.handle,zh.PASS_0+i);if(Ph.get(Fh.get(s,Nh.BLEND_STATE)).targets[0].blend!==this._passDesc.isTransparent||!(Fh.get(s,Nh.PHASE)&this._passDesc.phases))return!1;const r=0|Fh.get(s,Nh.PRIORITY)<<16|n.priority<<8|i,o=this._passPool.add();return o.hash=r,o.depth=e.depth||0,o.shaderId=Uh.get(n.handle,zh.SHADER_0+i),o.subModel=n,o.passIdx=i,this.queue.push(o),!0}sort(){this.queue.sort()}recordCommandBuffer(e,t,i){for(let n=0;n<this.queue.length;++n){const{subModel:s,passIdx:r}=this.queue.array[n],{inputAssembler:o,handle:a}=s,c=Uh.get(a,zh.PASS_0+r),l=Mh.get(Uh.get(a,zh.SHADER_0+r)),h=Dp.getOrCreatePipelineState(e,c,l,t,o);i.bindPipelineState(h),i.bindDescriptorSet(rl.MATERIAL,Dh.get(Fh.get(c,Nh.DESCRIPTOR_SET))),i.bindDescriptorSet(rl.LOCAL,Dh.get(Uh.get(a,zh.DESCRIPTOR_SET))),i.bindInputAssembler(o),i.draw(o)}}}var iA,nA,sA,rA,oA,aA,cA,lA;const hA=[];let uA=e("UIStage",(iA=Go("UIStage"),nA=va([ZE]),sA=ua(),iA((lA=cA=class extends WS{constructor(...e){super(...e),Oo(this,"renderQueues",aA,this),this._renderQueues=[],this._renderArea={x:0,y:0,width:0,height:0}}initialize(e){return super.initialize(e),this.renderQueues=[{isTransparent:!0,stages:["default"],sortMode:VE.BACK_TO_FRONT}],!0}activate(e,t){super.activate(e,t);for(let e=0;e<this.renderQueues.length;e++){let t=0;for(let i=0;i<this.renderQueues[e].stages.length;i++)t|=Eh(this.renderQueues[e].stages[i]);let i=JE;switch(this.renderQueues[e].sortMode){case VE.BACK_TO_FRONT:i=eA;break;case VE.FRONT_TO_BACK:i=JE}this._renderQueues[e]=new tA({isTransparent:this.renderQueues[e].isTransparent,phases:t,sortFunc:i})}}destroy(){}render(e){const t=this._pipeline,i=t.isHDR;t.isHDR=!1;const n=t.device;this._renderQueues[0].clear();const s=t.renderObjects;for(let e=0;e<s.length;e++){const t=s[e],i=t.model.subModels;for(let e=0;e<i.length;e++){const n=i[e].passes;for(let i=0;i<n.length;i++)this._renderQueues[0].insertRenderPass(t,e,i)}}this._renderQueues[0].sort();const r=e.camera,o=r.viewport;this._renderArea.x=o.x*r.width,this._renderArea.y=o.y*r.height,this._renderArea.width=o.width*r.width,this._renderArea.height=o.height*r.height,hA[0]=r.clearColor;const a=t.commandBuffers[0],c=e.window.framebuffer,l=c.colorTextures[0]?c.renderPass:t.getRenderPass(r.clearFlag);a.begin(),a.beginRenderPass(l,c,this._renderArea,[r.clearColor],r.clearDepth,r.clearStencil),a.bindDescriptorSet(rl.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,l,a),a.endRenderPass(),a.end(),n.queue.submit(t.commandBuffers),t.isHDR=i}},cA.initInfo={name:"UIStage",priority:YE.UI},aA=Po((oA=lA).prototype,"renderQueues",[nA,Xo,sA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rA=oA))||rA));var _A,dA,mA;let pA=e("UIFlow",Go("UIFlow")((mA=dA=class extends nT{initialize(e){super.initialize(e);const t=new uA;return t.initialize(uA.initInfo),this._stages.push(t),!0}destroy(){super.destroy()}render(e){this._pipeline.updateUBOs(e),super.render(e)}},dA.initInfo={name:"UIFlow",priority:KE.UI,tag:HE.UI},_A=mA))||_A);class fA{constructor(){this.queue=new Set}clear(){const e=this.queue.values();let t=e.next();for(;!t.done;)t.value.clear(),t=e.next();this.queue.clear()}recordCommandBuffer(e,t,i){let n=this.queue.values(),s=n.next();for(;!s.done;){for(let e=0;e<s.value.batches.length;++e){const t=s.value.batches[e];if(t.mergeCount){for(let e=0;e<t.vbs.length;++e)t.vbs[e].update(t.vbDatas[e]);t.vbIdx.update(t.vbIdxData.buffer),t.ubo.update(t.uboData)}}s=n.next()}for(n=this.queue.values(),s=n.next();!s.done;){let r=!1;for(let n=0;n<s.value.batches.length;++n){const o=s.value.batches[n];if(o.mergeCount){if(!r){const n=Mh.get(o.hShader),s=Dp.getOrCreatePipelineState(e,o.hPass,n,t,o.ia);i.bindPipelineState(s),i.bindDescriptorSet(rl.MATERIAL,Dh.get(Fh.get(o.hPass,Nh.DESCRIPTOR_SET))),r=!0}i.bindDescriptorSet(rl.LOCAL,o.descriptorSet,s.value.dynamicOffsets),i.bindInputAssembler(o.ia),i.draw(o.ia)}}s=n.next()}}}class gA{constructor(){this.queue=new Set}clear(){const e=this.queue.values();let t=e.next();for(;!t.done;)t.value.clear(),t=e.next();this.queue.clear()}recordCommandBuffer(e,t,i){let n=this.queue.values(),s=n.next();for(;!s.done;)s.value.hasPendingModels&&s.value.uploadBuffers(),s=n.next();for(n=this.queue.values(),s=n.next();!s.done;){const{instances:r,hPass:o,hasPendingModels:a}=s.value;if(a){i.bindDescriptorSet(rl.MATERIAL,Dh.get(Fh.get(o,Nh.DESCRIPTOR_SET)));let n=null;for(let a=0;a<r.length;++a){const c=r[a];if(!c.count)continue;const l=Mh.get(c.hShader),h=Dp.getOrCreatePipelineState(e,o,l,t,c.ia);n!==h&&(i.bindPipelineState(h),n=h),i.bindDescriptorSet(rl.LOCAL,Dh.get(c.hDescriptorSet),s.value.dynamicOffsets),i.bindInputAssembler(c.ia),i.draw(c.ia)}}s=n.next()}}}class vA{static get(e,t=0){const i=vA._buffers;i.has(e)||i.set(e,{});const n=i.get(e);return n[t]||(n[t]=new vA(e))}constructor(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}destroy(){for(let e=0;e<this.batches.length;++e){const t=this.batches[e];for(let e=0;e<t.vbs.length;++e)t.vbs[e].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0}merge(e,t,i){const n=e.subMesh.flatBuffers;if(0===n.length)return;let s=0,r=0;const o=n[0].count,a=Uh.get(e.handle,zh.PASS_0+t),c=Uh.get(e.handle,zh.SHADER_0+t),l=e.descriptorSet;let h=!1;for(let e=0;e<this.batches.length;++e){const t=this.batches[e];if(t.vbs.length===n.length&&t.mergeCount<_l.BATCHING_COUNT){h=!0;for(let e=0;e<t.vbs.length;++e){if(t.vbs[e].stride!==n[e].stride){h=!1;break}}if(h){for(let e=0;e<t.vbs.length;++e){const i=n[e],r=t.vbs[e],a=t.vbDatas[e];s=(o+t.vbCount)*i.stride,s>r.size&&(r.resize(s),t.vbDatas[e]=new Uint8Array(s),t.vbDatas[e].set(a)),t.vbDatas[e].set(i.buffer,t.vbCount*i.stride)}let e=t.vbIdxData;r=4*(o+t.vbCount),r>t.vbIdx.size&&(t.vbIdx.resize(r),t.vbIdxData=new Float32Array(r/Float32Array.BYTES_PER_ELEMENT),t.vbIdxData.set(e),e=t.vbIdxData);const h=t.vbCount,u=h+o,_=t.mergeCount;if(e[h]!==_||e[u-1]!==_)for(let t=h;t<u;t++)e[t]=_+.1;return wi.toArray(t.uboData,i.model.transform.worldMatrix,_l.MAT_WORLDS_OFFSET+16*t.mergeCount),t.mergeCount||(l.bindBuffer(_l.BLOCK.binding,t.ubo),l.update(),t.hPass=a,t.hShader=c,t.descriptorSet=l),++t.mergeCount,t.vbCount+=o,void(t.ia.vertexCount+=o)}}}const u=[],_=[],d=[];for(let e=0;e<n.length;++e){const t=n[e],i=this._device.createBuffer({usage:An.VERTEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:t.count*t.stride,stride:t.stride});i.update(t.buffer.buffer),u.push(i),_.push(new Uint8Array(i.size)),d.push(i)}const m=this._device.createBuffer({usage:An.VERTEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:4*o,stride:4}),p=new Float32Array(o);p.fill(0),m.update(p),d.push(m);const f=e.inputAssembler.attributes,g=new Array(f.length+1);for(let e=0;e<f.length;++e)g[e]=f[e];g[f.length]={name:"a_dyn_batch_id",format:En.R32F,stream:n.length};const v=this._device.createInputAssembler({attributes:g,vertexBuffers:d}),y=this._device.createBuffer({usage:An.UNIFORM|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:_l.SIZE});l.bindBuffer(_l.BLOCK.binding,y),l.update();const x=new Float32Array(_l.COUNT);wi.toArray(x,i.model.transform.worldMatrix,_l.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:u,vbDatas:_,vbIdx:m,vbIdxData:p,vbCount:o,ia:v,ubo:y,uboData:x,hPass:a,hShader:c,descriptorSet:l})}clear(){for(let e=0;e<this.batches.length;++e){const t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}}vA._buffers=new Map;const yA=new _o(()=>({subModel:null,passIdx:-1,dynamicOffsets:[]}),16),xA=new Float32Array(4),SA=mn.create(0,0,0,1),TA=[],EA=[];function AA(e,t){return!(!t.worldBounds||zr.aabb_aabb(t.worldBounds,e.aabb))}function CA(e,t){return!(!t.worldBounds||zr.aabb_aabb(t.worldBounds,e.aabb)&&zr.aabb_frustum(t.worldBounds,e.frustum))}const bA=Eh("forward-add");function RA(e){for(let t=0;t<e.length;t++){const i=e[t].passes;for(let e=0;e<i.length;e++)if(i[e].phase===bA)return e}return-1}class wA{constructor(e){this._device=void 0,this._validLights=[],this._lightPasses=[],this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstlightBufferView=void 0,this._lightBufferData=void 0,this._isHDR=void 0,this._fpScale=void 0,this._renderObjects=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._device=e.device,this._isHDR=e.isHDR,this._fpScale=e.fpScale,this._renderObjects=e.renderObjects,this._instancedQueue=new gA,this._batchedQueue=new fA,this._lightBufferStride=Math.ceil(dl.SIZE/this._device.uboOffsetAlignment)*this._device.uboOffsetAlignment,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer({memUsage:Cn.HOST|Cn.DEVICE,usage:An.UNIFORM,stride:this._lightBufferStride,size:this._lightBufferStride*this._lightBufferCount}),this._firstlightBufferView=this._device.createBuffer({buffer:this._lightBuffer,offset:0,range:dl.SIZE}),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}gatherLightPasses(e){const t=this._validLights,i=e.camera.scene.sphereLights;this._instancedQueue.clear(),this._batchedQueue.clear(),t.length=0;for(let e=0;e<this._lightPasses.length;e++){this._lightPasses[e].dynamicOffsets.length=0}yA.freeArray(this._lightPasses),this._lightPasses.length=0;for(let n=0;n<i.length;n++){const s=i[n];mn.set(SA,s.position.x,s.position.y,s.position.z,s.range),zr.sphere_frustum(SA,e.camera.frustum)&&t.push(s)}const n=e.camera.scene.spotLights;for(let i=0;i<n.length;i++){const s=n[i];mn.set(SA,s.position.x,s.position.y,s.position.z,s.range),zr.sphere_frustum(SA,e.camera.frustum)&&t.push(s)}if(t.length){this._updateUBOs(e);for(let e=0;e<this._renderObjects.length;e++){const i=this._renderObjects[e],n=i.model,s=n.subModels,r=RA(s);if(!(r<0)){EA.length=0;for(let e=0;e<t.length;e++){const i=t[e];let s=!1;switch(i.type){case bp.SPHERE:s=AA(i,n);break;case bp.SPOT:s=CA(i,n)}s||EA.push(e)}if(EA.length)for(let e=0;e<s.length;e++){const t=s[e],o=t.passes[r],a=o.batchingScheme;if(t.descriptorSet.bindBuffer(dl.BLOCK.binding,this._firstlightBufferView),t.descriptorSet.update(),a===$h.INSTANCING)for(let e=0;e<EA.length;e++){const i=EA[e],s=Tm.get(o,i);s.merge(t,n.instancedAttributes,r),s.dynamicOffsets[0]=this._lightBufferStride*i,this._instancedQueue.queue.add(s)}else if(a===$h.VB_MERGING)for(let e=0;e<EA.length;e++){const n=EA[e],s=vA.get(o,n);s.merge(t,r,i),s.dynamicOffsets[0]=this._lightBufferStride*n,this._batchedQueue.queue.add(s)}else{const e=yA.alloc();e.subModel=t,e.passIdx=r;for(let t=0;t<EA.length;t++)e.dynamicOffsets.push(this._lightBufferStride*EA[t]);this._lightPasses.push(e)}}}}}}recordCommandBuffer(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(let n=0;n<this._lightPasses.length;n++){const{subModel:s,passIdx:r,dynamicOffsets:o}=this._lightPasses[n],a=Mh.get(Uh.get(s.handle,zh.SHADER_0+r)),c=s.passes[r],l=s.inputAssembler,h=Dp.getOrCreatePipelineState(e,c.handle,a,t,l),u=Dh.get(Fh.get(c.handle,Nh.DESCRIPTOR_SET)),_=s.descriptorSet;i.bindPipelineState(h),i.bindDescriptorSet(rl.MATERIAL,u),i.bindInputAssembler(l);for(let e=0;e<o.length;++e)TA[0]=o[e],i.bindDescriptorSet(rl.LOCAL,_,TA),i.draw(l)}}_updateUBOs(e){const t=e.camera.exposure;this._validLights.length>this._lightBufferCount&&(this._firstlightBufferView.destroy(),this._lightBufferCount=ii(this._validLights.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstlightBufferView.initialize({buffer:this._lightBuffer,offset:0,range:dl.SIZE}));for(let e=0,i=0;e<this._validLights.length;e++,i+=this._lightBufferElementCount){const n=this._validLights[e];switch(n.type){case bp.SPHERE:const e=n;if(_i.toArray(xA,e.position),xA[3]=0,this._lightBufferData.set(xA,i+dl.LIGHT_POS_OFFSET),xA[0]=e.size,xA[1]=e.range,xA[2]=0,this._lightBufferData.set(xA,i+dl.LIGHT_SIZE_RANGE_ANGLE_OFFSET),_i.toArray(xA,n.color),n.useColorTemperature){const e=n.colorTemperatureRGB;xA[0]*=e.x,xA[1]*=e.y,xA[2]*=e.z}this._isHDR?xA[3]=e.luminance*this._fpScale*this._lightMeterScale:xA[3]=e.luminance*t*this._lightMeterScale,this._lightBufferData.set(xA,i+dl.LIGHT_COLOR_OFFSET);break;case bp.SPOT:const s=n;if(_i.toArray(xA,s.position),xA[3]=1,this._lightBufferData.set(xA,i+dl.LIGHT_POS_OFFSET),xA[0]=s.size,xA[1]=s.range,xA[2]=s.spotAngle,this._lightBufferData.set(xA,i+dl.LIGHT_SIZE_RANGE_ANGLE_OFFSET),_i.toArray(xA,s.direction),this._lightBufferData.set(xA,i+dl.LIGHT_DIR_OFFSET),_i.toArray(xA,n.color),n.useColorTemperature){const e=n.colorTemperatureRGB;xA[0]*=e.x,xA[1]*=e.y,xA[2]*=e.z}this._isHDR?xA[3]=s.luminance*this._fpScale*this._lightMeterScale:xA[3]=s.luminance*t*this._lightMeterScale,this._lightBufferData.set(xA,i+dl.LIGHT_COLOR_OFFSET)}}this._lightBuffer.update(this._lightBufferData)}}var IA,OA,PA,MA,DA,LA,BA,NA;const FA=[{r:0,g:0,b:0,a:1}];let zA=e("ForwardStage",(IA=Go("ForwardStage"),OA=va([ZE]),PA=ua(),IA((NA=BA=class extends WS{constructor(){super(),Oo(this,"renderQueues",LA,this),this._renderQueues=[],this._renderArea={x:0,y:0,width:0,height:0},this._batchedQueue=void 0,this._instancedQueue=void 0,this._phaseID=Eh("default"),this._batchedQueue=new fA,this._instancedQueue=new gA}initialize(e){return super.initialize(e),this.renderQueues=[{isTransparent:!1,sortMode:VE.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:VE.BACK_TO_FRONT,stages:["default","planarShadow"]}],!0}activate(e,t){super.activate(e,t);for(let e=0;e<this.renderQueues.length;e++){let t=0;for(let i=0;i<this.renderQueues[e].stages.length;i++)t|=Eh(this.renderQueues[e].stages[i]);let i=JE;switch(this.renderQueues[e].sortMode){case VE.BACK_TO_FRONT:i=eA;break;case VE.FRONT_TO_BACK:i=JE}this._renderQueues[e]=new tA({isTransparent:this.renderQueues[e].isTransparent,phases:t,sortFunc:i})}this._additiveLightQueue=new wA(this._pipeline)}destroy(){}render(e){this._instancedQueue.clear(),this._batchedQueue.clear();const t=this._pipeline,i=t.device;this._renderQueues.forEach(this.renderQueueClearFunc);const n=t.renderObjects;let s=0,r=0,o=0;for(let e=0;e<n.length;++e){const t=n[e],i=t.model.subModels;for(s=0;s<i.length;++s){const e=i[s],n=e.passes;for(r=0;r<n.length;++r){const i=n[r];if(i.phase!==this._phaseID)continue;const a=i.batchingScheme;if(a===$h.INSTANCING){const n=Tm.get(i);n.merge(e,t.model.instancedAttributes,r),this._instancedQueue.queue.add(n)}else if(a===$h.VB_MERGING){const n=vA.get(i);n.merge(e,r,t),this._batchedQueue.queue.add(n)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(t,s,r)}}}this._renderQueues.forEach(this.renderQueueSortFunc),this._additiveLightQueue.gatherLightPasses(e);const a=e.camera,c=t.commandBuffers[0],l=a.viewport;if(this._renderArea.x=l.x*a.width,this._renderArea.y=l.y*a.height,this._renderArea.width=l.width*a.width*t.shadingScale,this._renderArea.height=l.height*a.height*t.shadingScale,a.clearFlag&Jn.COLOR)if(t.isHDR){h=FA[0],u=a.clearColor,h.r=u.r*u.r,h.g=u.g*u.g,h.b=u.b*u.b;const e=t.fpScale/a.exposure;FA[0].r*=e,FA[0].g*=e,FA[0].b*=e}else FA[0].r=a.clearColor.r,FA[0].g=a.clearColor.g,FA[0].b=a.clearColor.b;var h,u;FA[0].a=a.clearColor.a;const _=e.window.framebuffer,d=_.colorTextures[0]?_.renderPass:t.getRenderPass(a.clearFlag);c.begin(),c.beginRenderPass(d,_,this._renderArea,FA,a.clearDepth,a.clearStencil),c.bindDescriptorSet(rl.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,d,c),this._instancedQueue.recordCommandBuffer(i,d,c),this._batchedQueue.recordCommandBuffer(i,d,c),this._additiveLightQueue.recordCommandBuffer(i,d,c),t.shadows.type===Hp.Planar&&t.shadows.recordCommandBuffer(i,d,c),this._renderQueues[1].recordCommandBuffer(i,d,c),c.endRenderPass(),c.end(),i.queue.submit(t.commandBuffers)}renderQueueClearFunc(e){e.clear()}renderQueueSortFunc(e){e.sort()}},BA.initInfo={name:"ForwardStage",priority:YE.FORWARD},LA=Po((DA=NA).prototype,"renderQueues",[OA,Xo,PA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MA=DA))||MA));var UA,GA,HA;let VA=e("ForwardFlow",Go("ForwardFlow")((HA=GA=class extends nT{initialize(e){super.initialize(e);const t=new zA;return t.initialize(zA.initInfo),this._stages.push(t),!0}activate(e){super.activate(e)}render(e){this._pipeline.updateUBOs(e),super.render(e)}destroy(){super.destroy()}},GA.initInfo={name:"ForwardFlow",priority:KE.FORWARD},UA=HA))||UA);class kA{constructor(){this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._shadowMapBuffer=null,this._phaseID=Eh("shadow-add"),this._instancedQueue=new gA,this._batchedQueue=new fA}clear(e){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear(),this._shadowMapBuffer=e}add(e,t,i){const n=e.model.subModels[t],s=n.passes[i];if(s.phase===this._phaseID)if(this._shadowMapBuffer)if(s.batchingScheme===$h.INSTANCING){const t=Tm.get(s);t.merge(n,e.model.instancedAttributes,i),this._instancedQueue.queue.add(t)}else if(s.batchingScheme===$h.VB_MERGING){const t=vA.get(s);t.merge(n,i,e),this._batchedQueue.queue.add(t)}else{const e=Mh.get(Uh.get(n.handle,zh.SHADER_0+i));this._subModelsArray.push(n),this._shaderArray.push(e),this._passArray.push(s.handle)}else this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()}recordCommandBuffer(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(let n=0;n<this._subModelsArray.length;++n){const s=this._subModelsArray[n],r=this._shaderArray[n],o=this._passArray[n],a=s.inputAssembler,c=Dp.getOrCreatePipelineState(e,o,r,t,a),l=Dh.get(Fh.get(o,Nh.DESCRIPTOR_SET));i.bindPipelineState(c),i.bindDescriptorSet(rl.MATERIAL,l),i.bindDescriptorSet(rl.LOCAL,s.descriptorSet),i.bindInputAssembler(a),i.draw(a)}}}var WA,jA,qA;const XA=[{r:1,g:1,b:1,a:1}],YA=[];let KA=e("ShadowStage",Go("ShadowStage")((qA=jA=class extends WS{setShadowFrameBuffer(e){this._shadowFrameBuffer=e}constructor(){super(),this._additiveShadowQueue=void 0,this._shadowFrameBuffer=null,this._renderArea={x:0,y:0,width:0,height:0},this._additiveShadowQueue=new kA}destroy(){}render(e){var t;const i=this._pipeline,n=i.shadows;if(this._additiveShadowQueue.clear(i.descriptorSet.getBuffer(cl.BLOCK.binding)),null===(t=e.camera.scene)||void 0===t?void 0:t.mainLight){const e=i.shadowObjects;let t=0,n=0;for(let i=0;i<e.length;++i){const s=e[i],r=s.model.subModels;for(t=0;t<r.length;t++){const e=r[t].passes;for(n=0;n<e.length;n++)this._additiveShadowQueue.add(s,t,n)}}}const s=e.camera,r=i.commandBuffers[0],o=s.viewport,a=n.size;this._renderArea.x=o.x*a.x,this._renderArea.y=o.y*a.y,this._renderArea.width=o.width*a.x*i.shadingScale,this._renderArea.height=o.height*a.y*i.shadingScale;const c=i.device,l=this._shadowFrameBuffer.renderPass;r.begin(),r.beginRenderPass(l,this._shadowFrameBuffer,this._renderArea,XA,s.clearDepth,s.clearStencil),r.bindDescriptorSet(rl.GLOBAL,i.descriptorSet),this._additiveShadowQueue.recordCommandBuffer(c,l,r),r.endRenderPass(),r.end(),YA[0]=r,c.queue.submit(YA)}},jA.initInfo={name:"ShadowStage",priority:YE.FORWARD},WA=qA))||WA);var ZA,$A,QA;const JA=[Fn.LINEAR,Fn.LINEAR,Fn.NONE,zn.CLAMP,zn.CLAMP,zn.CLAMP];let eC=e("ShadowFlow",Go("ShadowFlow")((QA=$A=class extends nT{constructor(...e){super(...e),this._shadowRenderPass=null,this._shadowRenderTargets=[],this._shadowFrameBuffer=null,this._depth=null,this._width=0,this._height=0}get shadowFrameBuffer(){return this._shadowFrameBuffer}initialize(e){super.initialize(e);const t=new KA;return t.initialize(KA.initInfo),this._stages.push(t),!0}activate(e){super.activate(e);const t=e.device,i=e.shadows.size;this._width=i.x,this._height=i.y,this._shadowRenderPass||(this._shadowRenderPass=t.createRenderPass({colorAttachments:[{format:En.RGBA8,loadOp:qn.CLEAR,storeOp:Xn.STORE,sampleCount:1,beginLayout:Yn.UNDEFINED,endLayout:Yn.PRESENT_SRC}],depthStencilAttachment:{format:t.depthStencilFormat,depthLoadOp:qn.CLEAR,depthStoreOp:Xn.STORE,stencilLoadOp:qn.CLEAR,stencilStoreOp:Xn.STORE,sampleCount:1,beginLayout:Yn.UNDEFINED,endLayout:Yn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}})),this._shadowRenderTargets.length<1&&this._shadowRenderTargets.push(t.createTexture({type:Un.TEX2D,usage:Gn.COLOR_ATTACHMENT|Gn.SAMPLED,format:En.RGBA8,width:this._width,height:this._height})),this._depth||(this._depth=t.createTexture({type:Un.TEX2D,usage:Gn.DEPTH_STENCIL_ATTACHMENT,format:t.depthStencilFormat,width:this._width,height:this._height})),this._shadowFrameBuffer||(this._shadowFrameBuffer=t.createFramebuffer({renderPass:this._shadowRenderPass,colorTextures:this._shadowRenderTargets,depthStencilTexture:this._depth}));for(let e=0;e<this._stages.length;++e)this._stages[e].setShadowFrameBuffer(this._shadowFrameBuffer);const n=yc(JA),s=xc.getSampler(t,n);e.descriptorSet.bindSampler(ll.binding,s),e.descriptorSet.bindTexture(ll.binding,this._shadowRenderTargets[0])}render(e){const t=this._pipeline,i=t.shadows;if(i.type!==Hp.ShadowMap)return;const n=i.size;this._width===n.x&&this._height===n.y||(this.resizeShadowMap(n.x,n.y),this._width=n.x,this._height=n.y),t.updateUBOs(e),super.render(e)}resizeShadowMap(e,t){if(this._depth&&this._depth.resize(e,t),this._shadowRenderTargets.length>0)for(let i=0;i<this._shadowRenderTargets.length;i++){const n=this._shadowRenderTargets[i];n&&n.resize(e,t)}this._shadowFrameBuffer&&(this._shadowFrameBuffer.destroy(),this._shadowFrameBuffer.initialize({renderPass:this._shadowRenderPass,colorTextures:this._shadowRenderTargets,depthStencilTexture:this._depth}))}},$A.initInfo={name:"ShadowFlow",priority:KE.SHADOW,tag:HE.SCENE},ZA=QA))||ZA);const tC=Ye({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3});class iC{constructor(){this._type=tC.LINEAR,this._fogColor=new Fi("#C8C8C8"),this._enabled=!1,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2,this._currType=0,this._colorArray=new Float32Array([.2,.2,.2,1])}set enabled(e){this._enabled!==e&&(this._enabled=e,this._currType=e?this._type+1:0,this._enabled?this.activate():this._updatePipeline())}get enabled(){return this._enabled}set fogColor(e){this._fogColor.set(e),Fi.toArray(this._colorArray,this._fogColor)}get fogColor(){return this._fogColor}get type(){return this._type}set type(e){this._type=e,this._enabled&&(this._currType=e+1,this._updatePipeline())}get fogDensity(){return this._fogDensity}set fogDensity(e){this._fogDensity=e}get fogStart(){return this._fogStart}set fogStart(e){this._fogStart=e}get fogEnd(){return this._fogEnd}set fogEnd(e){this._fogEnd=e}get fogAtten(){return this._fogAtten}set fogAtten(e){this._fogAtten=e}get fogTop(){return this._fogTop}set fogTop(e){this._fogTop=e}get fogRange(){return this._fogRange}set fogRange(e){this._fogRange=e}get currType(){return this._currType}get colorArray(){return this._colorArray}activate(){Fi.toArray(this._colorArray,this._fogColor),this._currType=this._enabled?this._type+1:0,this._updatePipeline()}_updatePipeline(){const e=i.director.root,t=this._currType,n=e.pipeline;n.macros.CC_USE_FOG!==t&&(n.macros.CC_USE_FOG=t,e.onGlobalPipelineStateChanged())}}const nC=new _i,sC=new _o(()=>({model:null,depth:0}),128),rC=new _o(()=>({model:null,depth:0}),128);function oC(e,t){let i=0;e.node&&(_i.subtract(nC,e.node.worldPosition,t.position),i=_i.dot(nC,t.forward));const n=sC.alloc();return n.model=e,n.depth=i,n}function aC(e,t){let i=0;e.node&&(_i.subtract(nC,e.node.worldPosition,t.position),i=_i.dot(nC,t.forward));const n=rC.alloc();return n.model=e,n.depth=i,n}function cC(e,t){const i=t.camera,n=i.scene,s=e.renderObjects;sC.freeArray(s),s.length=0;const r=e.shadowObjects;rC.freeArray(r),r.length=0;const o=n.mainLight,a=e.shadows,c=a.sphere;c.center.set(0,0,0),c.radius=.01,o&&(o.update(),a.type===Hp.Planar&&a.updateDirLight(o)),e.skybox.enabled&&e.skybox.model&&i.clearFlag&ap&&s.push(oC(e.skybox.model,i));const l=n.models;for(let e=0;e<l.length;e++){const n=l[e];if(n.enabled){if(t.visibility&Xc.BitMask.UI_2D)(n.node&&t.visibility===n.node.layer||t.visibility===n.visFlags)&&s.push(oC(n,i));else if(n.node&&(t.visibility&n.node.layer)===n.node.layer||t.visibility&n.visFlags){if(n.castShadow&&(mn.mergeAABB(c,c,n.worldBounds),r.push(aC(n,i))),n.worldBounds&&!zr.aabb_frustum(n.worldBounds,i.frustum))continue;s.push(oC(n,i))}}}a.type===Hp.Planar&&a.updateShadowList(n,i.frustum,0!=(i.visibility&Xc.BitMask.DEFAULT))}var lC,hC,uC,_C,dC,mC,pC,fC,gC;const vC=new wi,yC=new wi,xC=new fi;let SC=e("ForwardPipeline",(lC=Go("ForwardPipeline"),hC=va([kE]),uC=ua(),_C=va([WE]),dC=ua(),lC((fC=Po((pC=class extends _T{constructor(...e){super(...e),Oo(this,"renderTextures",fC,this),Oo(this,"materials",gC,this),this.fog=new iC,this.ambient=new Ym,this.skybox=new bf,this.shadows=new kp,this.renderObjects=[],this.shadowObjects=[],this._isHDR=!1,this._shadingScale=1,this._fpScale=1/1024,this._renderPasses=new Map,this._globalUBO=new Float32Array(al.COUNT),this._shadowUBO=new Float32Array(cl.COUNT)}get isHDR(){return this._isHDR}set isHDR(e){if(this._isHDR===e)return;this._isHDR=e;this._globalUBO[al.EXPOSURE_OFFSET+2]=this._isHDR?1:0}get shadingScale(){return this._shadingScale}get fpScale(){return this._fpScale}get shadowUBO(){return this._shadowUBO}initialize(e){super.initialize(e);const t=new eC;t.initialize(eC.initInfo),this._flows.push(t);const i=new VA;i.initialize(VA.initInfo),this._flows.push(i);const n=new pA;return n.initialize(pA.initInfo),this._flows.push(n),!0}activate(){return this._globalDescriptorSetLayout=Zc,this._localDescriptorSetLayout=$c,this._macros={},!!super.activate()&&(!!this._activeRenderer()||(console.error("ForwardPipeline startup failed!"),!1))}render(e){for(let t=0;t<e.length;t++){const i=e[t];cC(this,i);for(let e=0;e<i.flows.length;e++)i.flows[e].render(i)}}getRenderPass(e){let t=this._renderPasses.get(e);if(t)return t;const i=this.device,n=new Us,s=new Gs;return n.format=i.colorFormat,s.format=i.depthStencilFormat,e&Jn.COLOR||(e&ap?n.loadOp=qn.DISCARD:(n.loadOp=qn.LOAD,n.beginLayout=Yn.PRESENT_SRC)),(e&Jn.DEPTH_STENCIL)!==Jn.DEPTH_STENCIL&&(e&Jn.DEPTH||(s.depthLoadOp=qn.LOAD),e&Jn.STENCIL||(s.stencilLoadOp=qn.LOAD),s.beginLayout=Yn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL),t=i.createRenderPass({colorAttachments:[n],depthStencilAttachment:s}),this._renderPasses.set(e,t),t}updateUBOs(e){this._updateUBO(e);const t=e.camera.scene.mainLight,i=this.device,n=this.shadows;if(t&&n.type===Hp.ShadowMap){const e=t.node.getWorldMatrix();wi.invert(vC,e);const s=n.orthoSize*n.aspect,r=n.orthoSize,o=i.screenSpaceSignY*i.UVSpaceSignY;wi.ortho(yC,-s,s,-r,r,n.near,n.far,i.clipSpaceMinZ,o),wi.multiply(yC,yC,vC),wi.toArray(this._shadowUBO,yC,cl.MAT_LIGHT_VIEW_PROJ_OFFSET),xC.set(n.pcf),fi.toArray(this._shadowUBO,xC,cl.SHADOW_PCF_OFFSET),xC.set(n.size.x,n.size.y),fi.toArray(this._shadowUBO,xC,cl.SHADOW_SIZE_OFFSET)}this._descriptorSet.getBuffer(al.BLOCK.binding).update(this._globalUBO),this._descriptorSet.getBuffer(cl.BLOCK.binding).update(this._shadowUBO)}_activeRenderer(){const e=this.device;this._commandBuffers.push(e.createCommandBuffer({type:jn.PRIMARY,queue:this._device.queue}));const t=e.createBuffer({usage:An.UNIFORM|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:al.SIZE});this._descriptorSet.bindBuffer(al.BLOCK.binding,t);const i=e.createBuffer({usage:An.UNIFORM|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:cl.SIZE});return this._descriptorSet.bindBuffer(cl.BLOCK.binding,i),this.macros.CC_USE_HDR=this._isHDR,this.macros.CC_SUPPORT_FLOAT_TEXTURE=this.device.hasFeature(As.TEXTURE_FLOAT),!0}_updateUBO(e){this._descriptorSet.update();const t=i.director.root,n=e.camera,s=n.scene.mainLight,r=this.ambient,o=this.fog,a=this._globalUBO,c=this.device,l=Math.floor(c.width),h=Math.floor(c.height);a[al.TIME_OFFSET]=t.cumulativeTime,a[al.TIME_OFFSET+1]=t.frameTime,a[al.TIME_OFFSET+2]=i.director.getTotalFrames(),a[al.SCREEN_SIZE_OFFSET]=c.width,a[al.SCREEN_SIZE_OFFSET+1]=c.height,a[al.SCREEN_SIZE_OFFSET+2]=1/a[al.SCREEN_SIZE_OFFSET],a[al.SCREEN_SIZE_OFFSET+3]=1/a[al.SCREEN_SIZE_OFFSET+1],a[al.SCREEN_SCALE_OFFSET]=n.width/l*this.shadingScale,a[al.SCREEN_SCALE_OFFSET+1]=n.height/h*this.shadingScale,a[al.SCREEN_SCALE_OFFSET+2]=1/a[al.SCREEN_SCALE_OFFSET],a[al.SCREEN_SCALE_OFFSET+3]=1/a[al.SCREEN_SCALE_OFFSET+1],a[al.NATIVE_SIZE_OFFSET]=l,a[al.NATIVE_SIZE_OFFSET+1]=h,a[al.NATIVE_SIZE_OFFSET+2]=1/a[al.NATIVE_SIZE_OFFSET],a[al.NATIVE_SIZE_OFFSET+3]=1/a[al.NATIVE_SIZE_OFFSET+1],wi.toArray(a,n.matView,al.MAT_VIEW_OFFSET),wi.toArray(a,n.node.worldMatrix,al.MAT_VIEW_INV_OFFSET),wi.toArray(a,n.matProj,al.MAT_PROJ_OFFSET),wi.toArray(a,n.matProjInv,al.MAT_PROJ_INV_OFFSET),wi.toArray(a,n.matViewProj,al.MAT_VIEW_PROJ_OFFSET),wi.toArray(a,n.matViewProjInv,al.MAT_VIEW_PROJ_INV_OFFSET),_i.toArray(a,n.position,al.CAMERA_POS_OFFSET);let u=c.screenSpaceSignY;e.window.hasOffScreenAttachments&&(u*=c.UVSpaceSignY),a[al.CAMERA_POS_OFFSET+3]=u;const _=n.exposure;if(a[al.EXPOSURE_OFFSET]=_,a[al.EXPOSURE_OFFSET+1]=1/_,a[al.EXPOSURE_OFFSET+2]=this._isHDR?1:0,a[al.EXPOSURE_OFFSET+3]=this._fpScale/_,s){if(_i.toArray(a,s.direction,al.MAIN_LIT_DIR_OFFSET),_i.toArray(a,s.color,al.MAIN_LIT_COLOR_OFFSET),s.useColorTemperature){const e=s.colorTemperatureRGB;a[al.MAIN_LIT_COLOR_OFFSET]*=e.x,a[al.MAIN_LIT_COLOR_OFFSET+1]*=e.y,a[al.MAIN_LIT_COLOR_OFFSET+2]*=e.z}this._isHDR?a[al.MAIN_LIT_COLOR_OFFSET+3]=s.illuminance*this._fpScale:a[al.MAIN_LIT_COLOR_OFFSET+3]=s.illuminance*_}else _i.toArray(a,_i.UNIT_Z,al.MAIN_LIT_DIR_OFFSET),fi.toArray(a,fi.ZERO,al.MAIN_LIT_COLOR_OFFSET);const d=r.colorArray;this._isHDR?d[3]=r.skyIllum*this._fpScale:d[3]=r.skyIllum*_,a.set(d,al.AMBIENT_SKY_OFFSET),a.set(r.albedoArray,al.AMBIENT_GROUND_OFFSET),o.enabled&&(a.set(o.colorArray,al.GLOBAL_FOG_COLOR_OFFSET),a[al.GLOBAL_FOG_BASE_OFFSET]=o.fogStart,a[al.GLOBAL_FOG_BASE_OFFSET+1]=o.fogEnd,a[al.GLOBAL_FOG_BASE_OFFSET+2]=o.fogDensity,a[al.GLOBAL_FOG_ADD_OFFSET]=o.fogTop,a[al.GLOBAL_FOG_ADD_OFFSET+1]=o.fogRange,a[al.GLOBAL_FOG_ADD_OFFSET+2]=o.fogAtten)}destroyUBOs(){this._descriptorSet&&(this._descriptorSet.getBuffer(al.BLOCK.binding).destroy(),this._descriptorSet.getBuffer(cl.BLOCK.binding).destroy())}destroy(){this.destroyUBOs();const e=this._renderPasses.values();let t=e.next();for(;!t.done;)t.value.destroy(),t=e.next();return super.destroy()}}).prototype,"renderTextures",[hC,Xo,uC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gC=Po(pC.prototype,"materials",[_C,Xo,dC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mC=pC))||mC));e("pipeline",Ml);const TC=new ci;class EC{get lastModified(){return this._lastModified}constructor(e,t,i=0){this._point=new ci,this._prevPoint=new ci,this._lastModified=0,this._id=0,this._startPoint=new ci,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}getLocation(e){return e||(e=new ci),e.set(this._point.x,this._point.y),e}getLocationX(){return this._point.x}getLocationY(){return this._point.y}getUILocation(e){return e||(e=new ci),e.set(this._point.x,this._point.y),i.view._convertPointWithScale(e),e}getUILocationX(){const e=i.view.getViewportRect();return(this._point.x-e.x)/i.view.getScaleX()}getUILocationY(){const e=i.view.getViewportRect();return(this._point.y-e.y)/i.view.getScaleY()}getPreviousLocation(e){return e||(e=new ci),e.set(this._prevPoint.x,this._prevPoint.y),e}getUIPreviousLocation(e){return e||(e=new ci),e.set(this._prevPoint.x,this._prevPoint.y),i.view._convertPointWithScale(e),e}getStartLocation(e){return e||(e=new ci),e.set(this._startPoint.x,this._startPoint.y),e}getUIStartLocation(e){return e||(e=new ci),e.set(this._startPoint.x,this._startPoint.y),i.view._convertPointWithScale(e),e}getDelta(e){return e||(e=new ci),e.set(this._point),e.subtract(this._prevPoint),e}getUIDelta(e){return e||(e=new ci),TC.set(this._point),TC.subtract(this._prevPoint),e.set(i.view.getScaleX(),i.view.getScaleY()),ci.divide(e,TC,e),e}getLocationInView(e){return e||(e=new ci),e.set(this._point.x,i.view._designResolutionSize.height-this._point.y),e}getPreviousLocationInView(e){return e||(e=new ci),e.set(this._prevPoint.x,i.view._designResolutionSize.height-this._prevPoint.y),e}getStartLocationInView(e){return e||(e=new ci),e.set(this._startPoint.x,i.view._designResolutionSize.height-this._startPoint.y),e}getID(){return this._id}setTouchInfo(e=0,t,i){this._prevPoint=this._point,this._point=new ci(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new ci(this._point),this._startPointCaptured=!0)}setPoint(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=i.director.getCurrentTime()}setPrevPoint(e,t){this._prevPoint="object"==typeof e?new ci(e.x,e.y):new ci(e||0,t||0),this._lastModified=i.director.getCurrentTime()}}e("Touch",EC),i.Touch=EC;const AC=Bc.TOUCH_TIMEOUT;let CC;const bC=new ci,RC=new ci;class wC{constructor(e=0,t=0,i=0,n=0){this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=n}}e("Acceleration",wC),i.internal.Acceleration=wC;const IC=new class{constructor(){this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new ci,this._prevMousePoint=new ci,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._pointLocked=!1}handleTouchesBegin(e){const t=[],i=this._touchesIntegerDict;for(let n=0;n<e.length;++n){const s=e[n],r=s.getID();if(null===r)continue;if(void 0===i[r]){const e=this._getUnUsedIndex();if(-1===e){g(2300,e);continue}s.getLocation(bC);const n=new EC(bC.x,bC.y,r);this._touches[e]=n,s.getPreviousLocation(bC),n.setPrevPoint(bC),i[r]=e,t.push(n)}}if(t.length>0){const e=new Uu(t,!1,Uu.BEGAN,Bc.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);$u.dispatchEvent(e)}}handleTouchesMove(e){const t=[],i=this._touches;for(let n=0;n<e.length;++n){const s=e[n],r=s.getID();if(null===r)continue;const o=this._touchesIntegerDict[r];void 0!==o&&(i[o]&&(s.getLocation(bC),i[o].setPoint(bC),s.getPreviousLocation(bC),i[o].setPrevPoint(bC),t.push(i[o])))}if(t.length>0){const e=new Uu(t,!1,Uu.MOVED,Bc.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);$u.dispatchEvent(e)}}handleTouchesEnd(e){const t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){const e=new Uu(t,!1,Uu.ENDED,Bc.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);$u.dispatchEvent(e)}this._preTouchPool.length=0}handleTouchesCancel(e){const t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){const e=new Uu(t,!1,Uu.CANCELLED,Bc.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);$u.dispatchEvent(e)}this._preTouchPool.length=0}getSetOfTouchesEndOrCancel(e){const t=[],i=this._touches,n=this._touchesIntegerDict;for(let s=0;s<e.length;++s){const r=e[s],o=r.getID();if(null===o)continue;const a=n[o];void 0!==a&&(i[a]&&(r.getLocation(bC),i[a].setPoint(bC),r.getPreviousLocation(bC),i[a].setPrevPoint(bC),t.push(i[a]),this._removeUsedIndexBit(a),delete n[o]))}return t}getHTMLElementPosition(e){const t=document.documentElement;let i=Oa.os===Oa.OS_IOS&&Oa.isBrowser?window.screenLeft:window.pageXOffset;i-=t.clientLeft;let n=Oa.os===Oa.OS_IOS&&Oa.isBrowser?window.screenTop:window.pageYOffset;if(n-=t.clientTop,e.getBoundingClientRect){const t=e.getBoundingClientRect();return{left:t.left+i,top:t.top+n,width:t.width,height:t.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}getPreTouch(e){let t=null;const i=this._preTouchPool,n=e.getID();for(let e=i.length-1;e>=0;e--)if(i[e].getID()===n){t=i[e];break}return t||(t=e),t}setPreTouch(e){let t=!1;const i=this._preTouchPool,n=e.getID();for(let s=i.length-1;s>=0;s--)if(i[s].getID()===n){i[s]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}getTouchByXY(e,t,i,n){const s=this._preTouchPoint,r=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(r.x=s.x+e.movementX,r.y=s.y-e.movementY);const o=new EC(r.x,r.y,0);return o.setPrevPoint(s.x,s.y),s.x=r.x,s.y=r.y,o}getMouseEvent(e,t,i){const n=this._prevMousePoint,s=new zu(i,!1,n);return n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),s.setLocation(n.x,n.y),s}getPointByEvent(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop,{x:e.clientX,y:e.clientY})}getTouchesByEvent(e,t){const i=[],n=this._glView,s=this._preTouchPoint,r=e.changedTouches.length;for(let o=0;o<r;o++){const r=e.changedTouches[o];if(!r)continue;let a,c;if(a=Oa.BROWSER_TYPE_FIREFOX===Oa.browserType?n.convertToLocationInView(r.pageX,r.pageY,t,bC):n.convertToLocationInView(r.clientX,r.clientY,t,bC),null!=r.identifier?(c=new EC(a.x,a.y,r.identifier),this.getPreTouch(c).getLocation(RC),c.setPrevPoint(RC.x,RC.y),this.setPreTouch(c)):(c=new EC(a.x,a.y),c.setPrevPoint(s.x,s.y)),s.x=a.x,s.y=a.y,i.push(c),!Bc.ENABLE_MULTI_TOUCH)break}return i}registerSystemEvent(e){if(this._isRegisterEvent||!e)return;this._glView=i.view;let t=Oa.isMobile,n="mouse"in Oa.capabilities,s="touches"in Oa.capabilities;n&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),s&&this._registerTouchEvents(e),this._registerKeyboardEvent(),this._isRegisterEvent=!0}setAccelerometerEnabled(e){if(this._accelEnabled===e)return;this._accelEnabled=e;const t=i.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this)),jsb.device.setMotionEnabled(e)}didAccelerate(e){if(!this._accelEnabled)return;const t=this._acceleration;let n=0,s=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){const t=e.accelerationIncludingGravity;t&&(n=this._accelMinus*(t.x||0)*.1,s=this._accelMinus*(t.y||0)*.1,r=.1*(t.z||0))}else{const t=e;n=(t.gamma||0)/90*.981,s=-(t.beta||0)/90*.981,r=(t.alpha||0)/90*.981}if(i.view._isRotated){const e=n;n=-s,s=e}t.x=n,t.y=s,t.z=r,t.timestamp=e.timeStamp||Date.now();const o=t.x;90===window.orientation?(t.x=-t.y,t.y=o):-90===window.orientation?(t.x=t.y,t.y=-o):180===window.orientation&&(t.x=-t.x,t.y=-t.y),i.sys.os===i.sys.OS_ANDROID&&i.sys.browserType!==i.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}update(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,$u.dispatchEvent(new Gu(this._acceleration))),this._accelCurTime+=e}setAccelerometerInterval(e){this._accelInterval!==e&&(this._accelInterval=e,jsb.device&&jsb.device.setMotionInterval&&jsb.device.setMotionInterval(e))}_getUnUsedIndex(){let e=this._indexBitsUsed;const t=i.director.getCurrentTime();for(let i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;{const e=this._touches[i];if(t-e.lastModified>AC){this._removeUsedIndexBit(i);const t=e.getID();return null!==t&&delete this._touchesIntegerDict[t],i}}e>>=1}return-1}_removeUsedIndexBit(e){if(e<0||e>=this._maxTouches)return;let t=1<<e;t=~t,this._indexBitsUsed&=t}_registerMouseEvents(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}_registerPointerLockEvent(){const e=()=>{const e=i.game.canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?this._pointLocked=!0:this._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)}_registerWindowMouseEvents(e){window.addEventListener("mousedown",()=>{this._mousePressed=!0},!1),window.addEventListener("mouseup",t=>{if(!this._mousePressed)return;this._mousePressed=!1;const i=this.getHTMLElementPosition(e),n=this.getPointByEvent(t,i);if(!Ni(i.left,i.top,i.width,i.height).contains(new ci(n.x,n.y))){this.handleTouchesEnd([this.getTouchByXY(t,n.x,n.y,i)]);const e=this.getMouseEvent(n,i,zu.UP);e.setButton(t.button),$u.dispatchEvent(e)}},!1)}_registerElementMouseEvents(e,t){const i=(t,i,n)=>{e.addEventListener(t,t=>{const s=this.getHTMLElementPosition(e),r=this.getPointByEvent(t,s),o=this.getMouseEvent(r,s,i);o.setButton(t.button),n(t,o,r,s),$u.dispatchEvent(o),t.stopPropagation(),t.preventDefault()})};t||(i("mousedown",zu.DOWN,(t,i,n,s)=>{this._mousePressed=!0,this.handleTouchesBegin([this.getTouchByXY(t,n.x,n.y,s)]),e.focus()}),i("mouseup",zu.UP,(e,t,i,n)=>{this._mousePressed=!1,this.handleTouchesEnd([this.getTouchByXY(e,i.x,i.y,n)])}),i("mousemove",zu.MOVE,(e,t,i,n)=>{this.handleTouchesMove([this.getTouchByXY(e,i.x,i.y,n)]),this._mousePressed||t.setButton(zu.BUTTON_MISSING),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)})),i("mousewheel",zu.SCROLL,(e,t,i,n)=>{t.setScrollData(0,e.wheelDelta)}),i("DOMMouseScroll",zu.SCROLL,(e,t,i,n)=>{t.setScrollData(0,-120*e.detail)})}_registerMousePointerEvents(e){const t={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel};for(const i in t){const n=t[i];e.addEventListener(i,t=>{const i=this.getHTMLElementPosition(e);i.left-=document.documentElement.scrollLeft,i.top-=document.documentElement.scrollTop,n.call(this,[this.getTouchByXY(t,t.clientX,t.clientY,i)]),t.stopPropagation()},!1)}}_registerTouchEvents(e){const t=t=>i=>{if(!i.changedTouches)return;const n=this.getHTMLElementPosition(e),s=document.body;n.left-=s.scrollLeft||0,n.top-=s.scrollTop||0,t(this.getTouchesByEvent(i,n)),i.stopPropagation(),i.preventDefault()};e.addEventListener("touchstart",t(t=>{this.handleTouchesBegin(t),e.focus()}),!1),e.addEventListener("touchmove",t(e=>{this.handleTouchesMove(e)}),!1),e.addEventListener("touchend",t(e=>{this.handleTouchesEnd(e)}),!1),e.addEventListener("touchcancel",t(e=>{this.handleTouchesCancel(e)}),!1)}_registerKeyboardEvent(){const e=i.game.canvas;e.addEventListener("keydown",e=>{$u.dispatchEvent(new Hu(e,!0)),e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("keyup",e=>{$u.dispatchEvent(new Hu(e,!1)),e.stopPropagation(),e.preventDefault()},!1)}_registerAccelerometerEvent(){this._acceleration=new wC,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,i.sys.browserType===i.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);const e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";CC=(...e)=>this.didAccelerate(...e),window.addEventListener(e,CC,!1)}_unregisterAccelerometerEvent(){const e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";CC&&window.removeEventListener(e,CC,!1)}_getUsefulTouches(){const e=[],t=this._touchesIntegerDict;for(const i in t){const n=t[parseInt(i)];if(null==n)continue;const s=this._touches[n];e.push(s)}return e}};i.internal.inputManager=IC;class OC extends Za{constructor(...e){super(...e),this.frame=null,this.container=null,this.canvas=null,this.renderType=-1,this.eventTargetOn=super.on,this.eventTargetOnce=super.once,this.config={},this.onStart=null,this._persistRootNodes={},this._paused=!0,this._configLoaded=!1,this._isCloning=!1,this._inited=!1,this._rendererInitialized=!1,this._gfxDevice=null,this._intervalId=null,this._lastTime=null,this._frameTime=null,this._sceneInfos=[],this.collisionMatrix=[],this.groupList=[]}get inited(){return this._inited}setFrameRate(e){const t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}getFrameRate(){return this.config.frameRate||0}step(){i.director.mainLoop()}pause(){if(!this._paused){this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0);{let e=3;const t=()=>{--e>1&&window.rAF(t);const n=i.director.root;n.frameMove(0),n.device.present()};window.rAF(t)}}}resume(){this._paused&&(this._paused=!1,this._runMainLoop())}isPaused(){return this._paused}restart(){i.director.once(i.Director.EVENT_AFTER_DRAW,()=>{for(const e in i.game._persistRootNodes)i.game.removePersistRootNode(i.game._persistRootNodes[e]);i.director.getScene().destroy(),i.Object._deferredDestroy(),i.director.reset(),i.game.pause(),i.game._loadRenderPipeline(()=>{i.game.resume(),i.game._safeEmit(i.Game.EVENT_RESTART)})})}end(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}on(e,t,i,n){this._inited&&e===OC.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOn(e,t,i,n)}once(e,t,i){this._inited&&e===OC.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOnce(e,t,i)}init(e){return this._initConfig(e),this.config.assetOptions&&ix.init(this.config.assetOptions),this._initEngine(),this._initEvents(),i.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),this._inited}run(e,t){if(this._initEvents(),"function"!=typeof e&&t){const e=this.onStart;this.init(e),this.onStart=t}else this.onStart=e;this._setAnimFrame(),this._runMainLoop(),PC.config.registerSystemEvent&&IC.registerSystemEvent(PC.canvas),this._loadRenderPipeline(null)}addPersistRootNode(e){if(!i.Node.isNode(e)||!e.uuid)return void y(3800);const t=e.uuid;if(!this._persistRootNodes[t]){const n=i.director._scene;if(i.isValid(n))if(e.parent){if(!(e.parent instanceof i.Scene))return void y(3801);if(e.parent!==n)return void y(3802)}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0}}removePersistRootNode(e){const t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}isPersistRootNode(e){return e._persistNode}_initEngine(){this._initDevice(),i.director._init(),console.log("Cocos Creator 3D v"+i.ENGINE_VERSION),this.emit(OC.EVENT_ENGINE_INITED),this._inited=!0}_setAnimFrame(){this._lastTime=new Date;const e=i.game.config.frameRate;this._frameTime=1e3/e,jsb.setPreferredFramesPerSecond(e),window.rAF=window.requestAnimationFrame,window.cAF=window.cancelAnimationFrame}_stTime(e){const t=(new Date).getTime(),n=Math.max(0,t-i.game._lastTime),s=Math.max(0,i.game._frameTime-n),r=window.setTimeout(e,s);return i.game._lastTime=t+s,r}_ctTime(e){window.clearTimeout(e)}_runMainLoop(){let e;const t=this.config,n=i.director;t.frameRate;R(!!t.showFPS),n.startAnimation(),e=t=>{this._paused||(this._intervalId=window.rAF(e),n.mainLoop(t))},this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(e),this._paused=!1}_initConfig(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);const t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],d(e.debugMode),this.config=e,this._configLoaded=!0}_determineRenderType(){const e=this.config,t=parseInt(e.renderMode);this.renderType=OC.RENDER_TYPE_CANVAS;let n=!1;if(0===t?i.sys.capabilities.opengl?(this.renderType=OC.RENDER_TYPE_WEBGL,n=!0):i.sys.capabilities.canvas&&(this.renderType=OC.RENDER_TYPE_CANVAS,n=!0):1===t&&i.sys.capabilities.canvas?(this.renderType=OC.RENDER_TYPE_CANVAS,n=!0):2===t&&i.sys.capabilities.opengl&&(this.renderType=OC.RENDER_TYPE_WEBGL,n=!0),!n)throw new Error(C(3820,t))}_initDevice(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===OC.RENDER_TYPE_WEBGL){const e=[];if(window.gfx)gfx.CCVKDevice&&e.push(gfx.CCVKDevice),gfx.CCMTLDevice&&e.push(gfx.CCMTLDevice),gfx.GLES3Device&&e.push(gfx.GLES3Device),gfx.GLES2Device&&e.push(gfx.GLES2Device);else{let t=!!window.WebGL2RenderingContext;const n=window.navigator.userAgent.toLowerCase();(-1!==n.indexOf("safari")&&-1===n.indexOf("chrome")||Oa.browserType===Oa.BROWSER_TYPE_UC)&&(t=!1),t&&i.WebGL2Device&&e.push(i.WebGL2Device),i.WebGLDevice&&e.push(i.WebGLDevice)}const t={canvasElm:this.canvas,debug:!0,isAntialias:Bc.ENABLE_WEBGL_ANTIALIAS,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*window.devicePixelRatio),nativeHeight:Math.floor(screen.height*window.devicePixelRatio),bindingMappingInfo:ol};for(let i=0;i<e.length&&(this._gfxDevice=new e[i],!this._gfxDevice.initialize(t));i++);}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=OC.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=()=>{if(!i._isContextMenuEnable)return!1}}}_initEvents(){const e=window;let t;void 0!==document.hidden?t="hidden":void 0!==document.mozHidden?t="mozHidden":void 0!==document.msHidden?t="msHidden":void 0!==document.webkitHidden&&(t="webkitHidden");let n=!1;function s(){n||(n=!0,i.game.emit(OC.EVENT_HIDE))}function r(){n&&(n=!1,i.game.emit(OC.EVENT_SHOW))}if(t){const e=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"];for(let i=0;i<e.length;i++)document.addEventListener(e[i],e=>{let i=document[t];i=i||e.hidden,i?s():r()})}else e.addEventListener("blur",s),e.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(e.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(e.addEventListener("pagehide",s),e.addEventListener("pageshow",r),document.addEventListener("pagehide",s),document.addEventListener("pageshow",r)),this.on(OC.EVENT_HIDE,()=>{i.game.pause()}),this.on(OC.EVENT_SHOW,()=>{i.game.resume()})}_loadRenderPipeline(e){const t=i.internal.SplashScreen,n=this.config.renderPipeline;if(n)i.loader.load({uuid:n},(s,r)=>{if(!s&&r instanceof _T)try{this._setRenderPipeline(r)}catch(e){console.warn(e),console.warn(`Failed load renderpipeline: ${n}, engine failed to initialize, will fallback to default pipeline`),this._setRenderPipeline()}else console.warn(`Failed load renderpipeline: ${n}, engine failed to initialize, will fallback to default pipeline`),console.warn(s),this._setRenderPipeline();if(this._safeEmit(OC.EVENT_GAME_INITED),t){const t=i.internal.SplashScreen.instance;t.main(i.director.root),t.setOnFinish(()=>{this.onStart&&this.onStart(),e&&e()}),t.loadFinish=!0}else this.onStart&&this.onStart(),e&&e()});else if(this._setRenderPipeline(),this._safeEmit(OC.EVENT_GAME_INITED),t){const t=i.internal.SplashScreen.instance;t.main(i.director.root),t.setOnFinish(()=>{this.onStart&&this.onStart(),e&&e()}),t.loadFinish=!0}else this.onStart&&this.onStart(),e&&e()}_setRenderPipeline(e){i.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(OC.EVENT_RENDERER_INITED)}_safeEmit(e){this.emit(e)}}e("Game",OC),OC.EVENT_HIDE="game_on_hide",OC.EVENT_SHOW="game_on_show",OC.EVENT_GAME_INITED="game_inited",OC.EVENT_ENGINE_INITED="engine_inited",OC.EVENT_RENDERER_INITED="renderer_inited",OC.EVENT_RESTART="game_on_restart",OC.RENDER_TYPE_CANVAS=0,OC.RENDER_TYPE_WEBGL=1,OC.RENDER_TYPE_OPENGL=2,i.Game=OC;const PC=e("game",i.game=new OC);const MC=new class{constructor(){this.html=void 0,this.meta={width:"device-width"},this.adaptationType=i.sys.browserType}init(){this.html=document.getElementsByTagName("html")[0]}availWidth(e){return i.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth}availHeight(e){return i.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight}};switch(i.sys.os===i.sys.OS_IOS&&(MC.adaptationType=i.sys.BROWSER_TYPE_SAFARI),MC.adaptationType){case i.sys.BROWSER_TYPE_SAFARI:MC.meta["minimal-ui"]="true";case i.sys.BROWSER_TYPE_SOUGOU:case i.sys.BROWSER_TYPE_UC:MC.availWidth=e=>e.clientWidth,MC.availHeight=e=>e.clientHeight}class DC extends Za{constructor(){super(),this._resizeWithBrowserSize=void 0,this._designResolutionSize=void 0,this._originalDesignResolutionSize=void 0,this._frameSize=void 0,this._scaleX=void 0,this._scaleY=void 0,this._viewportRect=void 0,this._visibleRect=void 0,this._autoFullScreen=void 0,this._devicePixelRatio=void 0,this._maxPixelRatio=void 0,this._retinaEnabled=void 0,this._resizeCallback=void 0,this._resizing=void 0,this._orientationChanging=void 0,this._isRotated=void 0,this._orientation=void 0,this._isAdjustViewport=void 0,this._antiAliasEnabled=void 0,this._resolutionPolicy=void 0,this._rpExactFit=void 0,this._rpShowAll=void 0,this._rpNoBorder=void 0,this._rpFixedHeight=void 0,this._rpFixedWidth=void 0;const e=LC,t=BC;this._frameSize=new Di(0,0),this._designResolutionSize=new Di(0,0),this._originalDesignResolutionSize=new Di(0,0),this._scaleX=1,this._scaleY=1,this._viewportRect=new Bi(0,0,0,0),this._visibleRect=new Bi(0,0,0,0),this._autoFullScreen=!1,this._devicePixelRatio=1,this._maxPixelRatio=4,this._retinaEnabled=!1,this._resizeCallback=null,this._resizing=!1,this._resizeWithBrowserSize=!1,this._orientationChanging=!0,this._isRotated=!1,this._orientation=i.macro.ORIENTATION_AUTO,this._isAdjustViewport=!0,this._antiAliasEnabled=!1,this._rpExactFit=new NC(e.EQUAL_TO_FRAME,t.EXACT_FIT),this._rpShowAll=new NC(e.EQUAL_TO_FRAME,t.SHOW_ALL),this._rpNoBorder=new NC(e.EQUAL_TO_FRAME,t.NO_BORDER),this._rpFixedHeight=new NC(e.EQUAL_TO_FRAME,t.FIXED_HEIGHT),this._rpFixedWidth=new NC(e.EQUAL_TO_FRAME,t.FIXED_WIDTH),this._resolutionPolicy=this._rpShowAll,i.game.once(i.Game.EVENT_ENGINE_INITED,this.init,this)}init(){MC.init(),this._initFrameSize(),this.enableAntiAlias(!0);const e=i.game.canvas.width,t=i.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,i.winSize.width=this._visibleRect.width,i.winSize.height=this._visibleRect.height,i.visibleRect&&i.visibleRect.init(this._visibleRect)}resizeWithBrowserSize(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}setResizeCallback(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}setOrientation(e){(e&=i.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}adjustViewportMeta(e){this._isAdjustViewport=e}enableRetina(e){this._retinaEnabled=!!e}isRetinaEnabled(){return this._retinaEnabled}enableAntiAlias(e){if(this._antiAliasEnabled!==e)if(this._antiAliasEnabled=e,i.game.renderType===i.Game.RENDER_TYPE_WEBGL){const t=i.loader._cache;for(const n in t){const s=t[n],r=s&&s.content instanceof i.Texture2D?s.content:null;if(r){const t=i.Texture2D.Filter;e?r.setFilters(t.LINEAR,t.LINEAR):r.setFilters(t.NEAREST,t.NEAREST)}}}else if(i.game.renderType===i.Game.RENDER_TYPE_CANVAS){const t=i.game.canvas.getContext("2d");t.imageSmoothingEnabled=e,t.mozImageSmoothingEnabled=e}}isAntiAliasEnabled(){return this._antiAliasEnabled}enableAutoFullScreen(e){e&&e!==this._autoFullScreen&&i.sys.isMobile&&i.sys.browserType!==i.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,i.screen.autoFullScreen(i.game.frame)):this._autoFullScreen=!1}isAutoFullScreenEnabled(){return this._autoFullScreen}setCanvasSize(e,t){const n=i.game.canvas,s=i.game.container;this._devicePixelRatio=window.devicePixelRatio,n.width=e*this._devicePixelRatio,n.height=t*this._devicePixelRatio,n.style.width=e+"px",n.style.height=t+"px",s.style.width=e+"px",s.style.height=t+"px",this._resizeEvent()}getCanvasSize(){return new Di(i.game.canvas.width,i.game.canvas.height)}getFrameSize(){return new Di(this._frameSize.width,this._frameSize.height)}setFrameSize(e,t){this._frameSize.width=e,this._frameSize.height=t,i.frame.style.width=e+"px",i.frame.style.height=t+"px",this._resizeEvent()}getVisibleSize(){return new Di(this._visibleRect.width,this._visibleRect.height)}getVisibleSizeInPixel(){return new Di(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}getVisibleOrigin(){return new ci(this._visibleRect.x,this._visibleRect.y)}getVisibleOriginInPixel(){return new ci(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}getResolutionPolicy(){return this._resolutionPolicy}setResolutionPolicy(e){const t=this;if(e instanceof NC)t._resolutionPolicy=e;else{const i=NC;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}}setDesignResolutionSize(e,t,n){if(!(e>0||t>0))return void S(2200);this.setResolutionPolicy(n);const s=this._resolutionPolicy;if(s&&s.preApply(this),i.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),!s)return void g(2201);this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;const r=s.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){const e=this._viewportRect,t=this._visibleRect,i=r.viewport;e.x=i.x,e.y=i.y,e.width=i.width,e.height=i.height,t.x=0,t.y=0,t.width=i.width/this._scaleX,t.height=i.height/this._scaleY}s.postApply(this),i.winSize.width=this._visibleRect.width,i.winSize.height=this._visibleRect.height,LS&&LS.init(this._visibleRect),this.emit("design-resolution-changed")}getDesignResolutionSize(){return new Di(this._designResolutionSize.width,this._designResolutionSize.height)}setRealPixelResolution(e,t,i){this.setDesignResolutionSize(e,t,i)}getViewportRect(){return this._viewportRect}getScaleX(){return this._scaleX}getScaleY(){return this._scaleY}getDevicePixelRatio(){return this._devicePixelRatio}convertToLocationInView(e,t,n,s){const r=s||new ci,o=this._devicePixelRatio*(e-n.left),a=this._devicePixelRatio*(n.top+n.height-t);return this._isRotated?(r.x=i.game.canvas.width-a,r.y=o):(r.x=o,r.y=a),r}_convertPointWithScale(e){const t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}_resizeEvent(){const e=i.view;e._frameSize.width,e._frameSize.height,e._isRotated;if(i.sys.isMobile){const t=i.game.container.style,n=t.margin;t.margin="0",t.display="none",e._initFrameSize(),t.margin=n,t.display="block"}else e._initFrameSize();const t=e._originalDesignResolutionSize.width,n=e._originalDesignResolutionSize.height;e._resizing=!0,t>0&&e.setDesignResolutionSize(t,n,e._resolutionPolicy),e._resizing=!1,e.emit("canvas-resize"),e._resizeCallback&&e._resizeCallback.call()}_orientationChange(){i.view._orientationChanging=!0,i.view._resizeEvent()}_initFrameSize(){const e=this._frameSize,t=MC.availWidth(i.game.frame),n=MC.availHeight(i.game.frame),s=t>=n;!i.sys.isMobile||s&&this._orientation&i.macro.ORIENTATION_LANDSCAPE||!s&&this._orientation&i.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=n,i.game.container.style["-webkit-transform"]="rotate(0deg)",i.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=n,e.height=t,i.game.container.style["-webkit-transform"]="rotate(90deg)",i.game.container.style.transform="rotate(90deg)",i.game.container.style["-webkit-transform-origin"]="0px 0px 0px",i.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,i.game.canvas.style["-webkit-transform"]="translateZ(0px)",i.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout(()=>{i.view._orientationChanging=!1},1e3)}_adjustSizeKeepCanvasSize(){const e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;e>0&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)}_setViewportMeta(e,t){let i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);const n=document.getElementsByName("viewport"),s=n?n[0]:null;let r,o,a;for(o in r=s?s.content:"",i=i||document.createElement("meta"),i.id="cocosMetaElement",i.name="viewport",i.content="",e)-1===r.indexOf(o)?r+=","+o+"="+e[o]:t&&(a=new RegExp(o+"s*=s*[^,]+"),r.replace(a,o+"="+e[o]));/^,/.test(r)&&(r=r.substr(1)),i.content=r,s&&(s.content=r),document.head.appendChild(i)}_adjustViewportMeta(){this._isAdjustViewport,0}_convertMouseToLocation(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y)}_convertTouchWidthScale(e){const t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n}_convertTouchesWithScale(e){const t=this._viewportRect,i=this._scaleX,n=this._scaleY;let s,r;for(let o=0;o<e.length;o++){const a=e[o];s=a._point,r=a._prevPoint,s.x=(s.x-t.x)/i,s.y=(s.y-t.y)/n,r.x=(r.x-t.x)/i,r.y=(r.y-t.y)/n}}}e("View",DC),DC.instance=void 0;class LC{constructor(){this.name="ContainerStrategy"}preApply(e){}apply(e,t){}postApply(e){}_setupContainer(e,t,n){const s=i.game.canvas,r=i.game.container;i.sys.os===i.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?n:t)+"px",document.body.style.height=(e._isRotated?t:n)+"px"),r.style.width=s.style.width=t+"px",r.style.height=s.style.height=n+"px";let o=e._devicePixelRatio=1;e.isRetinaEnabled()&&(o=e._devicePixelRatio=Math.min(e._maxPixelRatio,window.devicePixelRatio||1)),s.width=t*o,s.height=n*o}_fixContainer(){document.body.insertBefore(i.game.container,document.body.firstChild);const e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";const t=i.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}LC.EQUAL_TO_FRAME=void 0,LC.PROPORTION_TO_FRAME=void 0;class BC{constructor(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}preApply(e){}apply(e,t){return{scale:[1,1]}}postApply(e){}_buildResult(e,t,i,n,s,r){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);const o=new Bi(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[s,r],this._result.viewport=o,this._result}}BC.EXACT_FIT=void 0,BC.SHOW_ALL=void 0,BC.NO_BORDER=void 0,BC.FIXED_HEIGHT=void 0,BC.FIXED_WIDTH=void 0,(()=>{const e=("undefined"==typeof window?global:window).__globalAdapter;e&&(e.adaptContainerStrategy&&e.adaptContainerStrategy(LC.prototype),e.adaptView&&e.adaptView(DC.prototype)),LC.EQUAL_TO_FRAME=new class extends LC{constructor(...e){super(...e),this.name="EqualToFrame"}apply(e){const t=e._frameSize.height,n=i.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?n.margin="0 0 0 "+t+"px":n.margin="0px",n.padding="0px"}},LC.PROPORTION_TO_FRAME=new class extends LC{constructor(...e){super(...e),this.name="ProportionalToFrame"}apply(e,t){const n=e._frameSize.width,s=e._frameSize.height,r=i.game.container.style,o=t.width,a=t.height,c=n/o,l=s/a;let h,u;c<l?(h=n,u=a*c):(h=o*l,u=s);const _=Math.round((n-h)/2),d=Math.round((s-u)/2);h=n-2*_,u=s-2*d,this._setupContainer(e,h,u),e._isRotated?r.margin="0 0 0 "+s+"px":r.margin="0px",r.paddingLeft=_+"px",r.paddingRight=_+"px",r.paddingTop=d+"px",r.paddingBottom=d+"px"}};BC.EXACT_FIT=new class extends BC{constructor(...e){super(...e),this.name="ExactFit"}apply(e,t){const n=i.game.canvas.width,s=i.game.canvas.height,r=n/t.width,o=s/t.height;return this._buildResult(n,s,n,s,r,o)}},BC.SHOW_ALL=new class extends BC{constructor(...e){super(...e),this.name="ShowAll"}apply(e,t){const n=i.game.canvas.width,s=i.game.canvas.height,r=t.width,o=t.height,a=n/r,c=s/o;let l,h,u=0;return a<c?(u=a,l=n,h=o*u):(u=c,l=r*u,h=s),this._buildResult(n,s,l,h,u,u)}},BC.NO_BORDER=new class extends BC{constructor(...e){super(...e),this.name="NoBorder"}apply(e,t){const n=i.game.canvas.width,s=i.game.canvas.height,r=t.width,o=t.height,a=n/r,c=s/o;let l,h,u;return a<c?(l=c,h=r*l,u=s):(l=a,h=n,u=o*l),this._buildResult(n,s,h,u,l,l)}},BC.FIXED_HEIGHT=new class extends BC{constructor(...e){super(...e),this.name="FixedHeight"}apply(e,t){const n=i.game.canvas.width,s=i.game.canvas.height,r=s/t.height,o=n,a=s;return this._buildResult(n,s,o,a,r,r)}},BC.FIXED_WIDTH=new class extends BC{constructor(...e){super(...e),this.name="FixedWidth"}apply(e,t){const n=i.game.canvas.width,s=i.game.canvas.height,r=n/t.width,o=n,a=s;return this._buildResult(n,s,o,a,r,r)}}})();class NC{constructor(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}get canvasSize(){return i.v2(i.game.canvas.width,i.game.canvas.height)}preApply(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}apply(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}postApply(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}setContainerStrategy(e){e instanceof LC&&(this._containerStrategy=e)}setContentStrategy(e){e instanceof BC&&(this._contentStrategy=e)}}e("ResolutionPolicy",NC),NC.EXACT_FIT=0,NC.NO_BORDER=1,NC.SHOW_ALL=2,NC.FIXED_HEIGHT=3,NC.FIXED_WIDTH=4,NC.UNKNOWN=5,NC.ContainerStrategy=LC,NC.ContentStrategy=BC,i.ResolutionPolicy=NC;const FC=e("view",DC.instance=i.view=new DC);i.winSize=new Di;let zC=null,UC=null,GC=null,HC=null;class VC extends Za{constructor(){super()}setAccelerometerEnabled(e){e&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then(e=>{console.log("Device Motion Event request permission: "+e),IC.setAccelerometerEnabled("granted"===e)}):IC.setAccelerometerEnabled(e)}setAccelerometerInterval(e){IC.setAccelerometerInterval(e)}on(e,t,n,s){return super.on(e,t,n,s),e!==Du.KEY_DOWN&&e!==Du.KEY_UP||zC||(zC=Vu.create({event:Vu.KEYBOARD,onKeyPressed(e,t){t.type=Du.KEY_DOWN,kC.emit(t.type,t)},onKeyReleased(e,t){t.type=Du.KEY_UP,kC.emit(t.type,t)}}),$u.addListener(zC,256)),e===Du.DEVICEMOTION&&(UC||(UC=Vu.create({event:Vu.ACCELERATION,callback(e,t){t.type=Du.DEVICEMOTION,i.systemEvent.emit(t.type,t)}}),$u.addListener(UC,256))),e!==Du.TOUCH_START&&e!==Du.TOUCH_MOVE&&e!==Du.TOUCH_END&&e!==Du.TOUCH_CANCEL||GC||(GC=Vu.create({event:Vu.TOUCH_ONE_BY_ONE,onTouchBegan:(e,t)=>(t.type=Du.TOUCH_START,i.systemEvent.emit(t.type,e,t),!0),onTouchMoved(e,t){t.type=Du.TOUCH_MOVE,i.systemEvent.emit(t.type,e,t)},onTouchEnded(e,t){t.type=Du.TOUCH_END,i.systemEvent.emit(t.type,e,t)},onTouchCancelled(e,t){t.type=Du.TOUCH_CANCEL,i.systemEvent.emit(t.type,e,t)}}),$u.addListener(GC,256)),e!==Du.MOUSE_DOWN&&e!==Du.MOUSE_MOVE&&e!==Du.MOUSE_UP&&e!==Du.MOUSE_WHEEL||HC||(HC=Vu.create({event:Vu.MOUSE,onMouseDown(e){e.type=Du.MOUSE_DOWN,i.systemEvent.emit(e.type,e)},onMouseMove(e){e.type=Du.MOUSE_MOVE,i.systemEvent.emit(e.type,e)},onMouseUp(e){e.type=Du.MOUSE_UP,i.systemEvent.emit(e.type,e)},onMouseScroll(e){e.type=Du.MOUSE_WHEEL,i.systemEvent.emit(e.type,e)}}),$u.addListener(HC,256)),t}off(e,t,i){if(super.off(e,t,i),zC&&(e===Du.KEY_DOWN||e===Du.KEY_UP)){const e=this.hasEventListener(Du.KEY_DOWN),t=this.hasEventListener(Du.KEY_UP);e||t||($u.removeListener(zC),zC=null)}if(UC&&e===Du.DEVICEMOTION&&($u.removeListener(UC),UC=null),GC&&(e===Du.TOUCH_START||e===Du.TOUCH_MOVE||e===Du.TOUCH_END||e===Du.TOUCH_CANCEL)){const e=this.hasEventListener(Du.TOUCH_START),t=this.hasEventListener(Du.TOUCH_MOVE),i=this.hasEventListener(Du.TOUCH_END),n=this.hasEventListener(Du.TOUCH_CANCEL);e||t||i||n||($u.removeListener(GC),GC=null)}if(HC&&(e===Du.MOUSE_DOWN||e===Du.MOUSE_MOVE||e===Du.MOUSE_UP||e===Du.MOUSE_WHEEL)){const e=this.hasEventListener(Du.MOUSE_DOWN),t=this.hasEventListener(Du.MOUSE_MOVE),i=this.hasEventListener(Du.MOUSE_UP),n=this.hasEventListener(Du.MOUSE_WHEEL);e||t||i||n||($u.removeListener(HC),HC=null)}}}e("SystemEvent",VC),VC.EventType=Du,i.SystemEvent=VC;const kC=e("systemEvent",new VC);i.systemEvent=kC,Ui(Du,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]);const WC=e("screen",{_supportsFullScreen:!1,_preOnFullScreenChange:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init(){this._fn={};let e,t,i,n,s=this._fnMap;for(e=0,t=s.length;e<t;e++)if(i=s[e],i&&void 0!==document[i[1]]){for(e=0,n=i.length;e<n;e++)this._fn[s[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},fullScreen(){return!!this._supportsFullScreen&&(void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement])},requestFullScreen(e,t){if(this._supportsFullScreen){if(e=e||document.documentElement,t){const e=this._fn.fullscreenchange;this._preOnFullScreenChange&&document.removeEventListener(e,this._preOnFullScreenChange),this._preOnFullScreenChange=t,document.addEventListener(e,t,!1)}return e[this._fn.requestFullscreen]()}},exitFullScreen(){return!this._supportsFullScreen||document[this._fn.exitFullscreen]()},autoFullScreen(e,t){e=e||document.body;const n=i.game.canvas||e,s=this;this.requestFullScreen(e,t),n.addEventListener(this._touchEvent,(function i(){n.removeEventListener(s._touchEvent,i),s.requestFullScreen(e,t)}))}});var jC,qC,XC,YC,KC,ZC,$C,QC,JC,eb,tb,ib,nb,sb,rb,ob,ab;let cb;WC.init(),i.screen=WC,$e(Bn),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(cb||(cb=e("InstanceMaterialType",{})));const lb={parent:null,owner:null,subModelIdx:0};let hb=function(t){return e({UIRenderable:t,RenderComponent:t}),t}((jC=Go("cc.UIRenderable"),qC=Ho(xd),XC=va(Bn),YC=ua(),KC=ra(),ZC=va(Bn),$C=ua(),QC=ra(),JC=ua(),eb=ra(),jC(tb=qC(tb=ko(tb=Zo((ab=ob=class e extends Qf{constructor(...e){super(...e),this._uiMaterial=null,this._uiMaterialIns=null,this._uiMaterialDirty=!1,this._uiMatInsDirty=!1,Oo(this,"_srcBlendFactor",nb,this),Oo(this,"_dstBlendFactor",sb,this),Oo(this,"_color",rb,this),this._assembler=null,this._postAssembler=null,this._renderData=null,this._renderDataFlag=!0,this._renderFlag=!0,this._delegateSrc=null,this._instanceMaterialType=cb.ADD_COLOR_AND_TEXTURE,this._blendTemplate={blendState:{targets:[{blendSrc:Bn.SRC_ALPHA,blendDst:Bn.ONE_MINUS_SRC_ALPHA}]}},this._lastParent=null}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}get color(){return this._color}set color(e){this._color.equals(e)||(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}getUIRenderMaterial(){return this._uiMaterialIns||this._uiMaterial}getUIMaterialInstance(){return this._uiMaterialIns&&!this._uiMatInsDirty||(lb.owner=this,lb.parent=this._uiMaterial,this._uiMaterialIns=new Nu(lb),this._uiMatInsDirty=!1),this._uiMaterialIns}get uiMaterial(){return this._uiMaterial}set uiMaterial(e){this._uiMaterial=e}get renderData(){return this._renderData}set delegateSrc(e){this._delegateSrc=e}__preload(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}onEnable(){this.node.on(Du.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(Du.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=this._canRender()}onDisable(){this.node.off(Du.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(Du.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}onDestroy(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(let e=0;e<this._materialInstances.length;e++)this._materialInstances[e].destroy();this._uiMaterialIns&&this._uiMaterialIns.destroy(),this._renderData=null}markForUpdateRenderData(e=!0){if(this._renderFlag=this._canRender(),e&&this._renderFlag){const t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else e||(this._renderDataFlag=e)}requestRenderData(){const e=Ff.add();return this._renderData=e,e}destroyRenderData(){this._renderData&&(Ff.remove(this._renderData),this._renderData=null)}updateAssembler(e){this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))}postUpdateAssembler(e){this._renderFlag&&this._postRender(e)}_render(e){}_postRender(e){}_checkAndUpdateRenderData(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}_canRender(){return this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)}_postCanRender(){}_updateColor(){this._assembler&&this._assembler.updateColor&&this._assembler.updateColor(this)}_updateBlendFunc(){let e=this.getMaterial(0);const t=this._blendTemplate.blendState.targets[0];return e?(t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(e=this.material,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,e.overridePipelineStates(this._blendTemplate,0)),e):((null!==this._uiMaterialIns&&this._uiMatInsDirty||t.blendDst!==this._dstBlendFactor||t.blendSrc!==this._srcBlendFactor)&&(e=this.getUIMaterialInstance(),t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,e.overridePipelineStates(this._blendTemplate,0)),e||this.getUIRenderMaterial())}_nodeStateChange(t){this._renderData&&this.markForUpdateRenderData();for(const t of this.node.children){const i=t.getComponent(e);i&&i.markForUpdateRenderData()}}_updateBuiltinMaterial(){let e=!1;if(this._uiMaterial||(e=!0),this._uiMaterial&&!this._uiMaterialDirty)return this._uiMaterial;switch(this._instanceMaterialType){case cb.ADD_COLOR:this._uiMaterial=Th.get("ui-base-material");break;case cb.ADD_COLOR_AND_TEXTURE:this._uiMaterial=Th.get("ui-sprite-material");break;case cb.GRAYSCALE:this._uiMaterial=Th.get("ui-sprite-gray-material");break;case cb.USE_ALPHA_SEPARATED:this._uiMaterial=Th.get("ui-sprite-alpha-sep-material");break;case cb.USE_ALPHA_SEPARATED_AND_GRAY:this._uiMaterial=Th.get("ui-sprite-gray-alpha-sep-material");break;default:this._uiMaterial=Th.get("ui-sprite-material")}return this._uiMaterialDirty=!1,e||(this._uiMatInsDirty=!0),this._uiMaterial}},ob.BlendState=Bn,ob.Assembler=null,ob.PostAssembler=null,Po((ib=ab).prototype,"srcBlendFactor",[XC,YC,KC],Object.getOwnPropertyDescriptor(ib.prototype,"srcBlendFactor"),ib.prototype),Po(ib.prototype,"dstBlendFactor",[ZC,$C,QC],Object.getOwnPropertyDescriptor(ib.prototype,"dstBlendFactor"),ib.prototype),Po(ib.prototype,"color",[JC,eb],Object.getOwnPropertyDescriptor(ib.prototype,"color"),ib.prototype),nb=Po(ib.prototype,"_srcBlendFactor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bn.SRC_ALPHA}}),sb=Po(ib.prototype,"_dstBlendFactor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bn.ONE_MINUS_SRC_ALPHA}}),rb=Po(ib.prototype,"_color",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fi.WHITE.clone()}}),tb=ib))||tb)||tb)||tb)||tb));var ub,_b,db,mb,pb,fb,gb,vb,yb,xb,Sb,Tb,Eb,Ab,Cb,bb,Rb,wb,Ib,Ob,Pb,Mb,Db,Lb,Bb,Nb,Fb,zb,Ub,Gb,Hb,Vb,kb,Wb,jb,qb,Xb,Yb,Kb,Zb,$b,Qb,Jb;!function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(Zb||(Zb={})),$e(Zb),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}($b||($b={})),$e($b),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(Qb||(Qb={})),$e(Qb),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(Jb||(Jb={}));let eR=function(t){return e({Sprite:t,SpriteComponent:t}),t}((ub=Go("cc.Sprite"),_b=ta(),db=Vo(110),mb=$o(),pb=va($v),fb=ua(),gb=ra(),vb=va(_h),yb=ua(),xb=ra(),Sb=va(Zb),Tb=ua(),Eb=ra(),Ab=va($b),Cb=ra(),bb=ra(),Rb=oa(),wb=ra(),Ib=oa(),Ob=ra(),Pb=ua(),Mb=ra(),Db=va(Qb),Lb=ua(),Bb=ra(),ub(Nb=_b(Nb=db(Nb=mb((Kb=Yb=class e extends hb{constructor(...e){super(...e),Oo(this,"_spriteFrame",zb,this),Oo(this,"_type",Ub,this),Oo(this,"_fillType",Gb,this),Oo(this,"_sizeMode",Hb,this),Oo(this,"_fillCenter",Vb,this),Oo(this,"_fillStart",kb,this),Oo(this,"_fillRange",Wb,this),Oo(this,"_isTrimmedMode",jb,this),Oo(this,"_useGrayscale",qb,this),Oo(this,"_atlas",Xb,this)}get spriteAtlas(){return this._atlas}set spriteAtlas(e){this._atlas!==e&&(this._atlas=e)}get spriteFrame(){return this._spriteFrame}set spriteFrame(e){if(this._spriteFrame===e)return;const t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}get type(){return this._type}set type(e){this._type!==e&&(this._type=e,this._flushAssembler())}get fillType(){return this._fillType}set fillType(e){this._fillType!==e&&(e===$b.RADIAL||this._fillType===$b.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}get fillCenter(){return this._fillCenter}set fillCenter(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===Zb.FILLED&&this._renderData&&this.markForUpdateRenderData()}get fillStart(){return this._fillStart}set fillStart(e){this._fillStart=jt(e,-1,1),this._type===Zb.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get fillRange(){return this._fillRange}set fillRange(e){this._fillRange=jt(e,-1,1),this._type===Zb.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get trim(){return this._isTrimmedMode}set trim(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===Zb.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}get grayscale(){return this._useGrayscale}set grayscale(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?cb.GRAYSCALE:cb.ADD_COLOR_AND_TEXTURE,this._uiMaterialDirty=!0)}get sizeMode(){return this._sizeMode}set sizeMode(e){this._sizeMode!==e&&(this._sizeMode=e,e!==Qb.CUSTOM&&this._applySpriteSize())}__preload(){this.changeMaterialForDefine(),super.__preload(),this._spriteFrame&&(this._spriteFrame.on("load",this._markForUpdateUvDirty,this),this._markForUpdateUvDirty())}onEnable(){super.onEnable(),this._activateMaterial(),this.getMaterial(0)&&this._updateBlendFunc()}onDestroy(){super.onDestroy(),this.destroyRenderData(),this._spriteFrame&&this._spriteFrame.off("load")}changeSpriteFrameFromAtlas(e){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}changeMaterialForDefine(){let e;this._spriteFrame&&(e=this._spriteFrame.texture);let t=!1;if(e instanceof Lc){const i=e.getPixelFormat();t=i===rc.RGBA_ETC1||i===rc.RGB_A_PVRTC_4BPPV1||i===rc.RGB_A_PVRTC_2BPPV1}t&&this.grayscale?this._instanceMaterialType=cb.USE_ALPHA_SEPARATED_AND_GRAY:t?this._instanceMaterialType=cb.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=cb.GRAYSCALE:this._instanceMaterialType=cb.ADD_COLOR_AND_TEXTURE,this._uiMaterialDirty=!0}_render(e){e.commitComp(this,this._spriteFrame.getGFXTexture(),this._assembler,this._spriteFrame.texture.getGFXSampler())}_canRender(){if(!super._canRender())return!1;const e=this._spriteFrame;return!(!e||!e.textureLoaded())}_flushAssembler(){const t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this._updateColor())}_applySpriteSize(){if(this._spriteFrame){if(Qb.RAW===this._sizeMode){const e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(Qb.TRIMMED===this._sizeMode){const e=this._spriteFrame.getRect();this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height)}this._activateMaterial()}}_resized(){}_activateMaterial(){const e=this._spriteFrame,t=this.getRenderMaterial(0);i.game.renderType!==i.game.RENDER_TYPE_CANVAS?(e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)):this.markForUpdateRenderData()}_onTextureLoaded(){this.isValid&&(this.changeMaterialForDefine(),this._applySpriteSize())}_applySpriteFrame(e){const t=this._spriteFrame;this._renderData&&(e&&e.off("load",this._markForUpdateUvDirty),t&&t.on("load",this._markForUpdateUvDirty,this),this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty),t&&(e&&t===e||(t.loaded?this._onTextureLoaded():t.once("load",this._onTextureLoaded,this)))}_markForUpdateUvDirty(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},Yb.FillType=$b,Yb.Type=Zb,Yb.SizeMode=Qb,Yb.EventType=Jb,Po((Fb=Kb).prototype,"spriteAtlas",[pb,fb,gb],Object.getOwnPropertyDescriptor(Fb.prototype,"spriteAtlas"),Fb.prototype),Po(Fb.prototype,"spriteFrame",[vb,yb,xb],Object.getOwnPropertyDescriptor(Fb.prototype,"spriteFrame"),Fb.prototype),Po(Fb.prototype,"type",[Sb,Tb,Eb],Object.getOwnPropertyDescriptor(Fb.prototype,"type"),Fb.prototype),Po(Fb.prototype,"fillType",[Ab,Cb],Object.getOwnPropertyDescriptor(Fb.prototype,"fillType"),Fb.prototype),Po(Fb.prototype,"fillCenter",[bb],Object.getOwnPropertyDescriptor(Fb.prototype,"fillCenter"),Fb.prototype),Po(Fb.prototype,"fillStart",[Rb,wb],Object.getOwnPropertyDescriptor(Fb.prototype,"fillStart"),Fb.prototype),Po(Fb.prototype,"fillRange",[Ib,Ob],Object.getOwnPropertyDescriptor(Fb.prototype,"fillRange"),Fb.prototype),Po(Fb.prototype,"trim",[Pb,Mb],Object.getOwnPropertyDescriptor(Fb.prototype,"trim"),Fb.prototype),Po(Fb.prototype,"grayscale",[ia],Object.getOwnPropertyDescriptor(Fb.prototype,"grayscale"),Fb.prototype),Po(Fb.prototype,"sizeMode",[Db,Lb,Bb],Object.getOwnPropertyDescriptor(Fb.prototype,"sizeMode"),Fb.prototype),zb=Po(Fb.prototype,"_spriteFrame",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ub=Po(Fb.prototype,"_type",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zb.SIMPLE}}),Gb=Po(Fb.prototype,"_fillType",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $b.HORIZONTAL}}),Hb=Po(Fb.prototype,"_sizeMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qb.TRIMMED}}),Vb=Po(Fb.prototype,"_fillCenter",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ci(0,0)}}),kb=Po(Fb.prototype,"_fillStart",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wb=Po(Fb.prototype,"_fillRange",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jb=Po(Fb.prototype,"_isTrimmedMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qb=Po(Fb.prototype,"_useGrayscale",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Xb=Po(Fb.prototype,"_atlas",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nb=Fb))||Nb)||Nb)||Nb)||Nb));var tR,iR,nR,sR,rR,oR,aR,cR,lR,hR,uR,_R,dR,mR,pR,fR,gR,vR,yR,xR,SR,TR,ER,AR,CR,bR,RR,wR,IR,OR,PR,MR,DR,LR,BR,NR,FR,zR,UR,GR,HR,VR,kR,WR,jR,qR,XR,YR,KR,ZR,$R,QR,JR,ew,tw,iw,nw,sw,rw,ow,aw,cw,lw,hw,uw,_w,dw,mw,pw,fw,gw,vw,yw,xw,Sw,Tw,Ew,Aw,Cw,bw,Rw,ww,Iw,Ow,Pw,Mw,Dw,Lw,Bw,Nw,Fw,zw,Uw,Gw;const Hw=new _i(0,1,0),Vw=new _i,kw=new Si;let Ww=(tR=Go("cc.AmbientInfo"),iR=va(at),tR((rR=Po((sR=class{constructor(){Oo(this,"_skyColor",rR,this),Oo(this,"_skyIllum",oR,this),Oo(this,"_groundAlbedo",aR,this),this._resource=null}set skyColor(e){this._skyColor.set(e),this._resource&&(this._resource.skyColor=this._skyColor)}get skyColor(){return this._skyColor}set skyIllum(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)}get skyIllum(){return this._skyIllum}set groundAlbedo(e){this._groundAlbedo.set(e),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)}get groundAlbedo(){return this._groundAlbedo}activate(e){this._resource=e,this._resource.skyColor=this._skyColor,this._resource.skyIllum=this._skyIllum,this._resource.groundAlbedo=this._groundAlbedo}}).prototype,"_skyColor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(51,128,204,1)}}),oR=Po(sR.prototype,"_skyIllum",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ym.SKY_ILLUM}}),aR=Po(sR.prototype,"_groundAlbedo",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(51,51,51,255)}}),Po(sR.prototype,"skyColor",[ia],Object.getOwnPropertyDescriptor(sR.prototype,"skyColor"),sR.prototype),Po(sR.prototype,"skyIllum",[ia,iR],Object.getOwnPropertyDescriptor(sR.prototype,"skyIllum"),sR.prototype),Po(sR.prototype,"groundAlbedo",[ia],Object.getOwnPropertyDescriptor(sR.prototype,"groundAlbedo"),sR.prototype),nR=sR))||nR);i.AmbientInfo=Ww;let jw=(cR=Go("cc.SkyboxInfo"),lR=va(yh),hR=va(yh),cR((dR=Po((_R=class{constructor(){Oo(this,"_envmap",dR,this),Oo(this,"_isRGBE",mR,this),Oo(this,"_enabled",pR,this),Oo(this,"_useIBL",fR,this),this._resource=null}set enabled(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)}get enabled(){return this._enabled}set useIBL(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}get useIBL(){return this._useIBL}set envmap(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)}get envmap(){return this._envmap}set isRGBE(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)}get isRGBE(){return this._isRGBE}activate(e){this._resource=e,this._resource.activate(),this._resource.enabled=this._enabled,this._resource.isRGBE=this._isRGBE,this._resource.envmap=this._envmap,this._resource.useIBL=this._useIBL}}).prototype,"_envmap",[lR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mR=Po(_R.prototype,"_isRGBE",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pR=Po(_R.prototype,"_enabled",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fR=Po(_R.prototype,"_useIBL",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Po(_R.prototype,"enabled",[ia],Object.getOwnPropertyDescriptor(_R.prototype,"enabled"),_R.prototype),Po(_R.prototype,"useIBL",[ia],Object.getOwnPropertyDescriptor(_R.prototype,"useIBL"),_R.prototype),Po(_R.prototype,"envmap",[ia,hR],Object.getOwnPropertyDescriptor(_R.prototype,"envmap"),_R.prototype),Po(_R.prototype,"isRGBE",[ia],Object.getOwnPropertyDescriptor(_R.prototype,"isRGBE"),_R.prototype),uR=_R))||uR);i.SkyboxInfo=jw;let qw=(gR=Go("cc.FogInfo"),vR=va(tC),yR=na(),xR=va(at),SR=oa(),TR=la(),ER=ua(),AR=na(),CR=va(at),bR=la(),RR=ua(),wR=na(),IR=va(at),OR=la(),PR=ua(),MR=na(),DR=va(at),LR=aa(),BR=la(),NR=ua(),FR=na(),zR=va(at),UR=la(),GR=ua(),HR=na(),VR=va(at),kR=la(),WR=ua(),gR((nw=iw=class{constructor(){Oo(this,"_type",XR,this),Oo(this,"_fogColor",YR,this),Oo(this,"_enabled",KR,this),Oo(this,"_fogDensity",ZR,this),Oo(this,"_fogStart",$R,this),Oo(this,"_fogEnd",QR,this),Oo(this,"_fogAtten",JR,this),Oo(this,"_fogTop",ew,this),Oo(this,"_fogRange",tw,this),this._resource=null}set enabled(e){this._enabled=e,this._resource&&(this._resource.enabled=e)}get enabled(){return this._enabled}set fogColor(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}get fogColor(){return this._fogColor}get type(){return this._type}set type(e){this._type=e,this._resource&&(this._resource.type=e)}get fogDensity(){return this._fogDensity}set fogDensity(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}get fogStart(){return this._fogStart}set fogStart(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}get fogEnd(){return this._fogEnd}set fogEnd(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}get fogAtten(){return this._fogAtten}set fogAtten(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}get fogTop(){return this._fogTop}set fogTop(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}get fogRange(){return this._fogRange}set fogRange(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}activate(e){this._resource=e,this._resource.enabled=this._enabled,this._resource.fogColor=this._fogColor,this._resource.type=this._type,this._resource.fogDensity=this._fogDensity,this._resource.fogStart=this._fogStart,this._resource.fogEnd=this._fogEnd,this._resource.fogAtten=this._fogAtten,this._resource.fogTop=this._fogTop,this._resource.fogRange=this._fogRange}},iw.FogType=tC,XR=Po((qR=nw).prototype,"_type",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tC.LINEAR}}),YR=Po(qR.prototype,"_fogColor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi("#C8C8C8")}}),KR=Po(qR.prototype,"_enabled",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZR=Po(qR.prototype,"_fogDensity",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),$R=Po(qR.prototype,"_fogStart",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),QR=Po(qR.prototype,"_fogEnd",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),JR=Po(qR.prototype,"_fogAtten",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),ew=Po(qR.prototype,"_fogTop",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),tw=Po(qR.prototype,"_fogRange",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Po(qR.prototype,"enabled",[ia],Object.getOwnPropertyDescriptor(qR.prototype,"enabled"),qR.prototype),Po(qR.prototype,"fogColor",[ia],Object.getOwnPropertyDescriptor(qR.prototype,"fogColor"),qR.prototype),Po(qR.prototype,"type",[ia,vR],Object.getOwnPropertyDescriptor(qR.prototype,"type"),qR.prototype),Po(qR.prototype,"fogDensity",[yR,xR,SR,TR,ha,ER],Object.getOwnPropertyDescriptor(qR.prototype,"fogDensity"),qR.prototype),Po(qR.prototype,"fogStart",[AR,CR,bR,RR],Object.getOwnPropertyDescriptor(qR.prototype,"fogStart"),qR.prototype),Po(qR.prototype,"fogEnd",[wR,IR,OR,PR],Object.getOwnPropertyDescriptor(qR.prototype,"fogEnd"),qR.prototype),Po(qR.prototype,"fogAtten",[MR,DR,LR,BR,NR],Object.getOwnPropertyDescriptor(qR.prototype,"fogAtten"),qR.prototype),Po(qR.prototype,"fogTop",[FR,zR,UR,GR],Object.getOwnPropertyDescriptor(qR.prototype,"fogTop"),qR.prototype),Po(qR.prototype,"fogRange",[HR,VR,kR,WR],Object.getOwnPropertyDescriptor(qR.prototype,"fogRange"),qR.prototype),jR=qR))||jR),Xw=(sw=Go("cc.ShadowsInfo"),rw=va(Hp),ow=na(),aw=va(at),cw=na(),lw=va(Vp),hw=na(),uw=va(at),_w=na(),dw=va(at),mw=na(),pw=va(at),fw=na(),gw=na(),vw=va(at),yw=na(),sw((Tw=Po((Sw=class{constructor(){Oo(this,"_type",Tw,this),Oo(this,"_enabled",Ew,this),Oo(this,"_normal",Aw,this),Oo(this,"_distance",Cw,this),Oo(this,"_shadowColor",bw,this),Oo(this,"_pcf",Rw,this),Oo(this,"_near",ww,this),Oo(this,"_far",Iw,this),Oo(this,"_aspect",Ow,this),Oo(this,"_orthoSize",Pw,this),Oo(this,"_size",Mw,this),this._resource=null}set enabled(e){this._enabled=e,this._resource&&(this._resource.enabled=e)}get enabled(){return this._enabled}set type(e){this._type=e,this._resource&&(this._resource.type=e)}get type(){return this._type}set shadowColor(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}get shadowColor(){return this._shadowColor}set normal(e){_i.copy(this._normal,e),this._resource&&(this._resource.normal=e)}get normal(){return this._normal}set distance(e){this._distance=e,this._resource&&(this._resource.distance=e)}get distance(){return this._distance}set pcf(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}get pcf(){return this._pcf}set near(e){this._near=e,this._resource&&(this._resource.near=e)}get near(){return this._near}set far(e){this._far=e,this._resource&&(this._resource.far=e)}get far(){return this._far}set orthoSize(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}get orthoSize(){return this._orthoSize}set shadowMapSize(e){this._size.set(e),this._resource&&(this._resource.size=e)}get shadowMapSize(){return this._size}set aspect(e){this._aspect=e,this._resource&&(this._resource.aspect=e)}get aspect(){return this._aspect}setPlaneFromNode(e){e.getWorldRotation(kw),this.normal=_i.transformQuat(Vw,Hw,kw),e.getWorldPosition(Vw),this.distance=_i.dot(this._normal,Vw)}activate(e){this._resource=e,this._resource.type=this._type,this._resource.near=this._near,this._resource.far=this._far,this._resource.orthoSize=this._orthoSize,this._resource.size=this._size,this._resource.normal=this._normal,this._resource.distance=this._distance,this._resource.shadowColor=this._shadowColor,this._resource.pcf=this._pcf,this._resource.enabled=this._enabled}}).prototype,"_type",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hp.Planar}}),Ew=Po(Sw.prototype,"_enabled",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Aw=Po(Sw.prototype,"_normal",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _i(0,1,0)}}),Cw=Po(Sw.prototype,"_distance",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bw=Po(Sw.prototype,"_shadowColor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0,76)}}),Rw=Po(Sw.prototype,"_pcf",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vp.HARD}}),ww=Po(Sw.prototype,"_near",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Iw=Po(Sw.prototype,"_far",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),Ow=Po(Sw.prototype,"_aspect",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Pw=Po(Sw.prototype,"_orthoSize",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Mw=Po(Sw.prototype,"_size",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ci(512,512)}}),Po(Sw.prototype,"enabled",[ia],Object.getOwnPropertyDescriptor(Sw.prototype,"enabled"),Sw.prototype),Po(Sw.prototype,"type",[ia,rw],Object.getOwnPropertyDescriptor(Sw.prototype,"type"),Sw.prototype),Po(Sw.prototype,"shadowColor",[ia],Object.getOwnPropertyDescriptor(Sw.prototype,"shadowColor"),Sw.prototype),Po(Sw.prototype,"normal",[ow],Object.getOwnPropertyDescriptor(Sw.prototype,"normal"),Sw.prototype),Po(Sw.prototype,"distance",[aw,cw],Object.getOwnPropertyDescriptor(Sw.prototype,"distance"),Sw.prototype),Po(Sw.prototype,"pcf",[lw,hw],Object.getOwnPropertyDescriptor(Sw.prototype,"pcf"),Sw.prototype),Po(Sw.prototype,"near",[uw,_w],Object.getOwnPropertyDescriptor(Sw.prototype,"near"),Sw.prototype),Po(Sw.prototype,"far",[dw,mw],Object.getOwnPropertyDescriptor(Sw.prototype,"far"),Sw.prototype),Po(Sw.prototype,"orthoSize",[pw,fw],Object.getOwnPropertyDescriptor(Sw.prototype,"orthoSize"),Sw.prototype),Po(Sw.prototype,"shadowMapSize",[gw],Object.getOwnPropertyDescriptor(Sw.prototype,"shadowMapSize"),Sw.prototype),Po(Sw.prototype,"aspect",[vw,yw],Object.getOwnPropertyDescriptor(Sw.prototype,"aspect"),Sw.prototype),xw=Sw))||xw);i.ShadowsInfo=Xw;let Yw=(Dw=Go("cc.SceneGlobals"),Lw=va(jw),Dw((Fw=Po((Nw=class{constructor(){Oo(this,"ambient",Fw,this),Oo(this,"shadows",zw,this),Oo(this,"_skybox",Uw,this),Oo(this,"fog",Gw,this)}get skybox(){return this._skybox}set skybox(e){this._skybox=e}activate(){const e=i.director.root.pipeline;this.ambient.activate(e.ambient),this.skybox.activate(e.skybox),this.shadows.activate(e.shadows),this.fog.activate(e.fog)}}).prototype,"ambient",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ww}}),zw=Po(Nw.prototype,"shadows",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xw}}),Uw=Po(Nw.prototype,"_skybox",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jw}}),Gw=Po(Nw.prototype,"fog",[ia,Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qw}}),Po(Nw.prototype,"skybox",[ia,Lw],Object.getOwnPropertyDescriptor(Nw.prototype,"skybox"),Nw.prototype),Bw=Nw))||Bw);var Kw,Zw,$w,Qw;i.SceneGlobals=Yw;let Jw=e("Scene",Go("cc.Scene")((Po((Zw=class extends Z_{get renderScene(){return this._renderScene}get globals(){return this._globals}constructor(e){super(e),Oo(this,"autoReleaseAssets",$w,this),Oo(this,"_globals",Qw,this),this._renderScene=null,this.dependAssets=null,this._inited=void 0,this._prefabSyncedInLiveReload=!1,this._pos=_i.ZERO,this._rot=Si.IDENTITY,this._scale=_i.ONE,this._mat=wi.IDENTITY,this._dirtyFlags=0,this._activeInHierarchy=!1,i.director&&i.director.root&&(this._renderScene=i.director.root.createScene({})),this._inited=!i.game||!i.game._isCloning}destroy(){const e=super.destroy();return i.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}addComponent(e){throw new Error(C(3822))}_onHierarchyChanged(){}_onBatchCreated(){super._onBatchCreated();const e=this._children.length;for(let t=0;t<e;++t)this._children[t]._onBatchCreated()}_onBatchRestored(){this._onBatchCreated()}getPosition(e){return _i.copy(e||new _i,_i.ZERO)}getRotation(e){return Si.copy(e||new Si,Si.IDENTITY)}getScale(e){return _i.copy(e||new _i,_i.ONE)}getWorldPosition(e){return _i.copy(e||new _i,_i.ZERO)}getWorldRotation(e){return Si.copy(e||new Si,Si.IDENTITY)}getWorldScale(e){return _i.copy(e||new _i,_i.ONE)}getWorldMatrix(e){return wi.copy(e||new wi,wi.IDENTITY)}getWorldRS(e){return wi.copy(e||new wi,wi.IDENTITY)}getWorldRT(e){return wi.copy(e||new wi,wi.IDENTITY)}get position(){return _i.ZERO}get worldPosition(){return _i.ZERO}get rotation(){return Si.IDENTITY}get worldRotation(){return Si.IDENTITY}get scale(){return _i.ONE}get worldScale(){return _i.ONE}get eulerAngles(){return _i.ZERO}get worldMatrix(){return wi.IDENTITY}updateWorldTransform(){}_instantiate(){}_load(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(Z_._setScene)}_activate(e){e=!1!==e,i.director._nodeActivator.activateNode(this,e),this._globals.activate()}}).prototype,"globals",[ia],Object.getOwnPropertyDescriptor(Zw.prototype,"globals"),Zw.prototype),$w=Po(Zw.prototype,"autoReleaseAssets",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qw=Po(Zw.prototype,"_globals",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yw}}),Kw=Zw))||Kw);var eI;i.Scene=Jw;const tI=Ua.Flags.HideInHierarchy;let iI=e("PrivateNode",Go("cc.PrivateNode")(eI=class extends kd{constructor(e){super(e),this._objFlags|=tI}})||eI);i.PrivateNode=iI;const nI=Le.fastRemoveAt,sI=Ua.Flags.IsStartCalled,rI=Ua.Flags.IsOnEnableCalled;Ua.Flags.IsEditorOnEnableCalled;function oI(e,t){const i=t.constructor._executionOrder,n=t._id;let s=0;for(let t=e.length-1,r=t>>>1;s<=t;r=s+t>>>1){const o=e[r],a=o.constructor._executionOrder;if(a>i)t=r-1;else if(a<i)s=r+1;else{const e=o._id;if(e>n)t=r-1;else{if(!(e<n))return r;s=r+1}}}return~s}function aI(e,t){const i=e.array;let n=e.i+1;for(;n<i.length;){const s=i[n];s._enabled&&s.node._activeInHierarchy?++n:(e.removeAt(n),t&&(s._objFlags&=~t))}}class cI{constructor(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;const t=Y;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e}}function lI(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}cI.stableRemoveInactive=aI;class hI extends cI{add(e){const t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}remove(e){const t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}cancelInactive(e){aI(this._zero,e),aI(this._neg,e),aI(this._pos,e)}invoke(){const e=this._neg;e.array.length>0&&(e.array.sort(lI),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;const t=this._pos;t.array.length>0&&(t.array.sort(lI),this._invoke(t),t.array.length=0)}}class uI extends cI{add(e){const t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{const i=t<0?this._neg.array:this._pos.array,n=oI(i,e);n<0&&i.splice(~n,0,e)}}remove(e){const t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{const i=t<0?this._neg:this._pos,n=oI(i.array,e);n>=0&&i.removeAt(n)}}invoke(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)}}function _I(e,t,n){const s="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}";let r=t?Function("it","dt",s):Function("it",s);return function(e,t,n){return(s,r)=>{try{t(s,r)}catch(t){i._throw(t);var o=s.array;for(n&&(o[s.i]._objFlags|=n),++s.i;s.i<o.length;++s.i)try{e(o[s.i],r)}catch(e){i._throw(e),n&&(o[s.i]._objFlags|=n)}}}}(Function("c","dt",e),r,n)}const dI=_I("c.start();c._objFlags|="+sI,!1,sI),mI=_I("c.update(dt)",!0),pI=_I("c.lateUpdate(dt)",!0),fI=e=>{const t=i.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){const i=n[e.i];if(i._enabled){i.onEnable();!i.node._activeInHierarchy||t._onEnabled(i)}}};class gI{constructor(){this._deferredComps=[],this.unscheduleAll()}unscheduleAll(){this.startInvoker=new hI(dI),this.updateInvoker=new uI(mI),this.lateUpdateInvoker=new uI(pI),this._updating=!1}_onEnabled(e){i.director.getScheduler().resumeTarget(e),e._objFlags|=rI,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)}_onDisabled(e){i.director.getScheduler().pauseTarget(e),e._objFlags&=~rI;const t=this._deferredComps.indexOf(e);t>=0?nI(this._deferredComps,t):(!e.start||e._objFlags&sI||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}enableComp(e,t){if(!(e._objFlags&rI)){if(e.onEnable){if(t)return void t.add(e);e.onEnable();if(!e.node._activeInHierarchy)return}this._onEnabled(e)}}disableComp(e){e._objFlags&rI&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}startPhase(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}updatePhase(e){this.updateInvoker.invoke(e)}lateUpdatePhase(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()}_startForNewComps(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}_scheduleImmediate(e){"function"!=typeof e.start||e._objFlags&sI||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)}_deferredSchedule(){const e=this._deferredComps;for(let t=0,i=e.length;t<i;t++)this._scheduleImmediate(e[t]);e.length=0}}const vI=Ua.Flags.IsPreloadStarted,yI=Ua.Flags.IsOnLoadStarted,xI=Ua.Flags.IsOnLoadCalled,SI=Ua.Flags.Deactivating;class TI extends cI{add(e){this._zero.array.push(e)}remove(e){this._zero.fastRemove(e)}cancelInactive(e){cI.stableRemoveInactive(this._zero,e)}invoke(){this._invoke(this._zero),this._zero.array.length=0}}const EI=_I("c.__preload();"),AI=_I("c.onLoad();c._objFlags|="+xI,!1,xI),CI=new De(4);function bI(e,t,i){t?e._removeComponent(t):Le.removeAt(e._components,i)}CI.get=function(){const e=this._get()||{preload:new TI(EI),onLoad:new hI(AI),onEnable:new hI(fI)};e.preload._zero.i=-1;let t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,t=e.onEnable,t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};class RI{constructor(){this.resetComp=void 0,this.reset()}reset(){this._activatingStack=[]}activateNode(e,t){if(t){const t=CI.get();this._activatingStack.push(t),this._activateNodeRecursively(e,t.preload,t.onLoad,t.onEnable),t.preload.invoke(),t.onLoad.invoke(),t.onEnable.invoke(),this._activatingStack.pop(),CI.put(t)}else{this._deactivateNodeRecursively(e);const t=this._activatingStack;for(const e of t)e.preload.cancelInactive(vI),e.onLoad.cancelInactive(yI),e.onEnable.cancelInactive()}e.emit("active-in-hierarchy-changed",e)}activateComp(e,t,n,s){if(e._objFlags&vI||(e._objFlags|=vI,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&yI||(e._objFlags|=yI,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=xI):e._objFlags|=xI),e._enabled){if(!e.node._activeInHierarchy)return;i.director._compScheduler.enableComp(e,s)}}destroyComp(e){i.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&xI&&e.onDestroy()}_activateNodeRecursively(e,t,n,s){if(e._objFlags&SI)return void S(3816,e.name);e._activeInHierarchy=!0;let r=e._components.length;for(let o=0;o<r;++o){const a=e._components[o];a instanceof i.Component?this.activateComp(a,t,n,s):(bI(e,a,o),--o,--r)}e._childArrivalOrder=e._children.length;for(let i=0,r=e._children.length;i<r;++i){const r=e._children[i];r._active&&this._activateNodeRecursively(r,t,n,s)}e._onPostActivated(!0)}_deactivateNodeRecursively(e){e._objFlags|=SI,e._activeInHierarchy=!1;const t=e._components.length;for(let n=0;n<t;++n){const t=e._components[n];if(t._enabled&&(i.director._compScheduler.disableComp(t),e._activeInHierarchy))return void(e._objFlags&=~SI)}for(let t=0,i=e._children.length;t<i;++t){const i=e._children[t];if(i._activeInHierarchy&&(this._deactivateNodeRecursively(i),e._activeInHierarchy))return void(e._objFlags&=~SI)}e._onPostActivated(!1),e._objFlags&=~SI}}var wI,II,OI,PI,MI,DI,LI,BI,NI;e("NodeActivator",RI),Ui(Z_.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),Ui(kd.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new ci),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Di),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setContentSize(e,t)}}]),Gi(kd.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),Gi(Xc,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),Ui(Xc,"Layers",[{name:"Default",newName:"DEFAULT",target:Xc.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Xc.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Xc.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Xc.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Xc.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Xc.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Xc.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Xc.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Xc,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Xc,targetName:"Layers"}]),Gi(Xc.Enum,"Layers.Enum",[{name:"ALWAYS"}]),Gi(Xc.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);let FI=e("SubContextView",(wI=Go("cc.SubContextView"),II=ta(),OI=Vo(110),PI=Ho(xd),MI=$o(),DI=ra(),wI(LI=II(LI=OI(LI=PI(LI=MI((Po((BI=class extends f_{get fps(){return this._fps}set fps(e){this._fps!==e&&(this._fps=e,this._updateInterval=1/e,this._updateSubContextFrameRate())}constructor(){super(),Oo(this,"_fps",NI,this),this._sprite=void 0,this._imageAsset=void 0,this._context=void 0,this._updatedTime=0,this._updateInterval=0,this._firstlyEnabled=!0,this._sprite=null,this._imageAsset=new mc,this._context=null,this._updatedTime=performance.now()}onLoad(){if(window.__globalAdapter&&__globalAdapter.getOpenDataContext){this._updateInterval=1e3/this._fps,this._context=__globalAdapter.getOpenDataContext(),this.reset();const e=this._imageAsset,t=this._context.canvas;if(e.reset(t),e._texture.create(t.width,t.height),this._sprite=this.node.getComponent(eR),this._sprite||(this._sprite=this.node.addComponent(eR)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._imageAsset._texture;else{const e=new _h;e.texture=this._imageAsset._texture,this._sprite.spriteFrame=e}}else this.enabled=!1}onEnable(){this._firstlyEnabled&&this._context?(this._context.postMessage({fromEngine:!0,event:"boot"}),this._firstlyEnabled=!1):this._runSubContextMainLoop(),this._registerNodeEvent(),this._updateSubContextFrameRate(),this.updateSubContextViewport()}onDisable(){this._unregisterNodeEvent(),this._stopSubContextMainLoop()}update(e){if(void 0===e)return this._context&&this._context.postMessage({fromEngine:!0,event:"step"}),void this._updateSubContextTexture();performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())}reset(){if(this._context){this.updateSubContextViewport();let e=this._context.canvas;const t=this.node.getComponent(xd);e&&(e.width=t.width,e.height=t.height)}}updateSubContextViewport(){if(this._context){let e=this.node.getComponent(xd).getBoundingBoxToWorld(),t=FC.getScaleX(),i=FC.getScaleY();const n=FC.getViewportRect();this._context.postMessage({fromEngine:!0,event:"viewport",x:e.x*t+n.x,y:e.y*i+n.y,width:e.width*t,height:e.height*i})}}_updateSubContextTexture(){const e=this._imageAsset;if(!e||!this._context)return;if(e.width<=0||e.height<=0)return;const t=this._context.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._imageAsset._texture.create(t.width,t.height),this._imageAsset._texture.uploadData(t)}_registerNodeEvent(){this.node.on(kd.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.on(kd.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}_unregisterNodeEvent(){this.node.off(kd.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.off(kd.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}_runSubContextMainLoop(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!0})}_stopSubContextMainLoop(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!1})}_updateSubContextFrameRate(){this._context&&this._context.postMessage({fromEngine:!0,event:"frameRate",value:this._fps})}}).prototype,"fps",[DI],Object.getOwnPropertyDescriptor(BI.prototype,"fps"),BI.prototype),NI=Po(BI.prototype,"_fps",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),LI=BI))||LI)||LI)||LI)||LI)||LI));i.SubContextView=FI;class zI{constructor(){this._id="",this._priority=0,this._executeInEditMode=!1}set priority(e){this._priority=e}get priority(){return this._priority}set id(e){this._id=e}get id(){return this._id}static sortByPriority(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}init(){}update(e){}postUpdate(e){}}e("System",zI);const UI=new J("Scheduler");class GI{constructor(e,t,i,n){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=i,this.markedForDeletion=n}}GI.get=(e,t,i,n)=>{let s=GI._listEntries.pop();return s?(s.target=e,s.priority=t,s.paused=i,s.markedForDeletion=n):s=new GI(e,t,i,n),s},GI.put=e=>{GI._listEntries.length<20&&(e.target=null,GI._listEntries.push(e))},GI._listEntries=[];class HI{constructor(e,t,i,n){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=i,this.callback=n}}HI.get=(e,t,i,n)=>{let s=HI._hashUpdateEntries.pop();return s?(s.list=e,s.entry=t,s.target=i,s.callback=n):s=new HI(e,t,i,n),s},HI.put=e=>{HI._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,HI._hashUpdateEntries.push(e))},HI._hashUpdateEntries=[];class VI{constructor(e,t,i,n,s,r){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=s,this.paused=r}}VI.get=(e,t,i,n,s,r)=>{let o=VI._hashTimerEntries.pop();return o?(o.timers=e,o.target=t,o.timerIndex=i,o.currentTimer=n,o.currentTimerSalvaged=s,o.paused=r):o=new VI(e,t,i,n,s,r),o},VI.put=e=>{VI._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,VI._hashTimerEntries.push(e))},VI._hashTimerEntries=[];class kI{constructor(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}initWithCallback(e,t,n,s,r,o){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=s,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===i.macro.REPEAT_FOREVER,!0}getInterval(){return this._interval}setInterval(e){this._interval=e}update(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}getCallback(){return this._callback}trigger(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}cancel(){this._scheduler.unschedule(this._callback,this._target)}}kI._timers=[],kI.get=()=>kI._timers.pop()||new kI,kI.put=e=>{kI._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,kI._timers.push(e))};class WI extends zI{static enableForTarget(e){let t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?y(1513):e.id=UI.getNewId())}constructor(){super(),this._timeScale=void 0,this._updatesNegList=void 0,this._updates0List=void 0,this._updatesPosList=void 0,this._hashForUpdates=void 0,this._hashForTimers=void 0,this._currentTarget=void 0,this._currentTargetSalvaged=void 0,this._updateHashLocked=void 0,this._arrayForTimers=void 0,this._timeScale=1,this._updatesNegList=[],this._updates0List=[],this._updatesPosList=[],this._hashForUpdates=ce(!0),this._hashForTimers=ce(!0),this._currentTarget=null,this._currentTargetSalvaged=!1,this._updateHashLocked=!1,this._arrayForTimers=[]}setTimeScale(e){this._timeScale=e}getTimeScale(){return this._timeScale}update(e){let t,i,n,s,r;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=this._updatesNegList,n=i.length;t<n;t++)s=i[t],s.paused||s.markedForDeletion||s.target.update(e);for(t=0,i=this._updates0List,n=i.length;t<n;t++)s=i[t],s.paused||s.markedForDeletion||s.target.update(e);for(t=0,i=this._updatesPosList,n=i.length;t<n;t++)s=i[t],s.paused||s.markedForDeletion||s.target.update(e);const o=this._arrayForTimers;for(t=0;t<o.length;t++){if(r=o[t],this._currentTarget=r,this._currentTargetSalvaged=!1,!r.paused)for(r.timerIndex=0;r.timerIndex<r.timers.length;++r.timerIndex)r.currentTimer=r.timers[r.timerIndex],r.currentTimerSalvaged=!1,r.currentTimer.update(e),r.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)s=i[t],s.markedForDeletion?this._removeUpdateFromHash(s):t++;for(t=0,i=this._updates0List;t<i.length;)s=i[t],s.markedForDeletion?this._removeUpdateFromHash(s):t++;for(t=0,i=this._updatesPosList;t<i.length;)s=i[t],s.markedForDeletion?this._removeUpdateFromHash(s):t++;this._updateHashLocked=!1,this._currentTarget=null}schedule(e,t,n,s,r,o){if("function"!=typeof e){const i=e;e=t,t=i}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!s,s=i.macro.REPEAT_FOREVER,r=0),E(t,1502);let a=t.uuid||t.id;if(!a)return void S(1510);let c,l,h=this._hashForTimers[a];if(h?h.paused!==o&&y(1511):(h=VI.get(null,t,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[a]=h),null==h.timers)h.timers=[];else for(l=0;l<h.timers.length;++l)if(c=h.timers[l],c&&e===c._callback)return g(1507,c.getInterval(),n),void(c._interval=n);c=kI.get(),c.initWithCallback(this,e,t,n,s,r),h.timers.push(c),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}scheduleUpdate(e,t,i){let n=e.uuid||e.id;if(!n)return void S(1510);const s=this._hashForUpdates[n];if(s&&s.entry){if(s.entry.priority===t)return s.entry.markedForDeletion=!1,void(s.entry.paused=i);if(this._updateHashLocked)return g(1506),s.entry.markedForDeletion=!1,void(s.entry.paused=i);this.unscheduleUpdate(e)}const r=GI.get(e,t,i,!1);let o;0===t?(o=this._updates0List,this._appendIn(o,r)):(o=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,r,t)),this._hashForUpdates[n]=HI.get(o,r,e,null)}unschedule(e,t){if(!t||!e)return;let i=t.uuid||t.id;if(!i)return void S(1510);const n=this,s=n._hashForTimers[i];if(s){const t=s.timers;for(let i=0,r=t.length;i<r;i++){const r=t[i];if(e===r._callback)return r!==s.currentTimer||s.currentTimerSalvaged||(s.currentTimerSalvaged=!0),t.splice(i,1),kI.put(r),s.timerIndex>=i&&s.timerIndex--,void(0===t.length&&(n._currentTarget===s?n._currentTargetSalvaged=!0:n._removeHashElement(s)))}}}unscheduleUpdate(e){if(!e)return;let t=e.uuid||e.id;if(!t)return void S(1510);const i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}unscheduleAllForTarget(e){if(!e)return;let t=e.uuid||e.id;if(!t)return void S(1510);const i=this._hashForTimers[t];if(i){const e=i.timers;e.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(let t=0,i=e.length;t<i;t++)kI.put(e[t]);e.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}unscheduleAll(){this.unscheduleAllWithMinPriority(i.Scheduler.PRIORITY_SYSTEM)}unscheduleAllWithMinPriority(e){let t,i;const n=this._arrayForTimers;for(t=n.length-1;t>=0;t--)i=n[t],this.unscheduleAllForTarget(i.target);let s,r=0;if(e<0)for(t=0;t<this._updatesNegList.length;)r=this._updatesNegList.length,s=this._updatesNegList[t],s&&s.priority>=e&&this.unscheduleUpdate(s.target),r===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)r=this._updates0List.length,s=this._updates0List[t],s&&this.unscheduleUpdate(s.target),r===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)r=this._updatesPosList.length,s=this._updatesPosList[t],s&&s.priority>=e&&this.unscheduleUpdate(s.target),r===this._updatesPosList.length&&t++}isScheduled(e,t){E(e,1508),E(t,1509);let i=t.uuid||t.id;if(!i)return void S(1510);const n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;{const t=n.timers;for(let i=0;i<t.length;++i){if(e===t[i]._callback)return!0}return!1}}pauseAllTargets(){return this.pauseAllTargetsWithMinPriority(i.Scheduler.PRIORITY_SYSTEM)}pauseAllTargetsWithMinPriority(e){const t=[];let i;const n=this._arrayForTimers;let s,r,o;for(s=0,r=n.length;s<r;s++)i=n[s],i&&(i.paused=!0,t.push(i.target));if(e<0)for(s=0;s<this._updatesNegList.length;s++)o=this._updatesNegList[s],o&&o.priority>=e&&(o.paused=!0,t.push(o.target));if(e<=0)for(s=0;s<this._updates0List.length;s++)o=this._updates0List[s],o&&(o.paused=!0,t.push(o.target));for(s=0;s<this._updatesPosList.length;s++)o=this._updatesPosList[s],o&&o.priority>=e&&(o.paused=!0,t.push(o.target));return t}resumeTargets(e){if(e)for(let t=0;t<e.length;t++)this.resumeTarget(e[t])}pauseTarget(e){E(e,1503);let t=e.uuid||e.id;if(!t)return void S(1510);const i=this._hashForTimers[t];i&&(i.paused=!0);const n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}resumeTarget(e){E(e,1504);let t=e.uuid||e.id;if(!t)return void S(1510);const i=this._hashForTimers[t];i&&(i.paused=!1);const n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}isTargetPaused(e){E(e,1505);let t=e.uuid||e.id;if(!t)return S(1510),!1;const i=this._hashForTimers[t];if(i)return i.paused;const n=this._hashForUpdates[t];return!!n&&n.entry.paused}_removeHashElement(e){let t=e.target.uuid||e.target.id;delete this._hashForTimers[t];const i=this._arrayForTimers;for(let t=0,n=i.length;t<n;t++)if(i[t]===e){i.splice(t,1);break}VI.put(e)}_removeUpdateFromHash(e){const t=e.target.uuid||e.target.id,i=this,n=i._hashForUpdates[t];if(n){const e=n.list,s=n.entry;for(let t=0,i=e.length;t<i;t++)if(e[t]===s){e.splice(t,1);break}delete i._hashForUpdates[t],GI.put(s),HI.put(n)}}_priorityIn(e,t,i){for(let n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}_appendIn(e,t){e.push(t)}}e("Scheduler",WI),WI.PRIORITY_SYSTEM=1<<31,WI.PRIORITY_NON_SYSTEM=WI.PRIORITY_SYSTEM+1,WI.ID="scheduler",i.Scheduler=WI;class jI{constructor(e){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new vm(e),this.jointAnimationInfo=new ym(e)}releaseSkeleton(e){this.jointTexturePool.releaseSkeleton(e)}releaseAnimationClip(e){this.jointTexturePool.releaseAnimationClip(e)}clear(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()}}class qI{constructor(e){this.vData=null,this.iData=null,this.attributes=null,this.vertexBuffers=[],this.indexBuffer=null,this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this._batcher=void 0,this._dirty=!1,this._vertexFormatBytes=9*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes,this._initIDataCount=1536,this._outOfCallback=null,this._hInputAssemblers=[],this._nextFreeIAHandle=0,this._batcher=e}initialize(e,t){this._outOfCallback=t;const i=9*Float32Array.BYTES_PER_ELEMENT;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer({usage:An.VERTEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:i,stride:i}));const n=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this.indexBuffer=this._batcher.device.createBuffer({usage:An.INDEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:n,stride:n})),this.attributes=e,this._reallocBuffer()}request(e=4,t=6){this.lastByteOffset=this.byteOffset;const i=this.byteOffset+e*this._vertexFormatBytes,n=this.indicesOffset+t;if(e+this.vertexOffset>65535)return this._batcher.autoMergeBatches(),this._outOfCallback&&this._outOfCallback.call(this._batcher,e,t),!1;let s=this.vData.byteLength,r=this.iData.length;if(i>s||n>r){for(;s<i||r<n;)this._initVDataCount*=2,this._initIDataCount*=2,s=4*this._initVDataCount,r=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indicesOffset+=t,this.byteOffset=i,this._dirty=!0,!0}reset(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1}destroy(){this.attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this.indexBuffer=null;for(let e=0;e<this._hInputAssemblers.length;e++)Lh.free(this._hInputAssemblers[e]);this._hInputAssemblers.length=0}recordBatch(){const e=this.indicesOffset-this.indicesStart;if(!e)return 0;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push(Lh.alloc(this._batcher.device,this));const t=this._hInputAssemblers[this._nextFreeIAHandle++],i=Lh.get(t);return i.firstIndex=this.indicesStart,i.indexCount=e,t}uploadData(){if(0===this.byteOffset||!this._dirty)return;const e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(e),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(t)}_reallocBuffer(){this._reallocVData(!0),this._reallocIData(!0)}_reallocVData(e){let t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e){const e=new Uint8Array(this.vData.buffer);for(let i=0,n=t.length;i<n;i++)e[i]=t[i]}}_reallocIData(e){const t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e){const e=this.iData;for(let i=0,n=t.length;i<n;i++)e[i]=t[i]}}}let XI;e("MeshBuffer",qI),qI.OPACITY_OFFSET=8,function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL"}(XI||(XI={}));class YI{constructor(){this.stage=XI.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Mn.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Dn.KEEP,zFailOp:Dn.KEEP,passOp:Dn.KEEP,ref:1}}get pattern(){return this._stencilPattern}pushMask(e){this._maskStack.push(e)}clear(){this.stage=XI.CLEAR}enterLevel(){this.stage=XI.ENTER_LEVEL}enableMask(){this.stage=XI.ENABLED}exitMask(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=XI.DISABLED:this.stage=XI.ENABLED)}handleMaterial(e){const t=this._stencilPattern;if(this.stage===XI.DISABLED)t.stencilTest=!1,t.func=Mn.ALWAYS,t.failOp=Dn.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1;else if(t.stencilTest=!0,this.stage===XI.ENABLED)t.func=Mn.EQUAL,t.failOp=Dn.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask();else if(this.stage===XI.CLEAR){const e=this._maskStack[this._maskStack.length-1];t.func=Mn.NEVER,t.failOp=e.inverted?Dn.REPLACE:Dn.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()}else if(this.stage===XI.ENTER_LEVEL){const e=this._maskStack[this._maskStack.length-1];t.func=Mn.NEVER,t.failOp=e.inverted?Dn.ZERO:Dn.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()}return this._changed(e.passes[0])}getWriteMask(){return 1<<this._maskStack.length-1}getExitWriteMask(){return 1<<this._maskStack.length}getStencilRef(){let e=0;for(let t=0;t<this._maskStack.length;++t)e+=1<<t;return e}reset(){this._maskStack.length=0,this.stage=XI.DISABLED}_changed(e){const t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}}e("StencilManager",YI),YI.sharedManager=null,YI.sharedManager=new YI;class KI extends Im{constructor(){super(),this._subModel=void 0,this.type=bm.UI_BATCH,this._subModel=new ZI,this._subModel.initialize(),this._subModels[0]=this._subModel}updateTransform(){}updateUBOs(e){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].update();this._updateStamp=e,this._transformUpdated&&(this._transformUpdated=!1)}directInitialize(e){this._subModel.directInitialize(e.material.passes,e.hInputAssembler,e.hDescriptorSet)}destroy(){this._subModel.destroy()}}class ZI extends Sm{initialize(){this._handle=Uh.alloc(),Uh.set(this._handle,zh.PRIORITY,Kc.DEFAULT)}directInitialize(e,t,i){this._passes=e,this._flushPassInfo(),Uh.set(this._handle,zh.INPUT_ASSEMBLER,t),Uh.set(this._handle,zh.DESCRIPTOR_SET,i),this._inputAssembler=Lh.get(t),this._descriptorSet=Dh.get(i)}destroy(){Uh.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=Kc.DEFAULT,this._handle=0,this._patches=null,this._subMesh=null,this._passes=null}}const $I={layout:null};class QI{constructor(){this.bufferBatch=null,this.camera=null,this.model=null,this.material=null,this.texture=null,this.sampler=null,this.hInputAssembler=0,this.hDescriptorSet=0,this.useLocalData=null,this.isStatic=!1;const e=i.director.root,t=hu.get("builtin-sprite").shaders[0].name;Xh.getGFXShader(e.device,t,{USE_TEXTURE:!0},e.pipeline),$I.layout=Xh.getPipelineLayout(t).setLayouts[rl.LOCAL],this.hDescriptorSet=Dh.alloc(e.device,$I)}destroy(e){this.hDescriptorSet&&(Dh.free(this.hDescriptorSet),this.hDescriptorSet=0)}clear(){this.bufferBatch=null,this.hInputAssembler=0,this.camera=null,this.material=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1}}class JI{constructor(){this._material=null,this._pass=null,this._hDescriptorSet=0,this._refCount=0}get material(){return this._material}get pass(){return this._pass}get hDescriptorSet(){return this._hDescriptorSet}initialize(e){return!!e.material&&(this._material=new Lu,this._material.copy(e.material),this._pass=this._material.passes[0],this._pass.update(),this._hDescriptorSet=Fh.get(this._pass.handle,Nh.DESCRIPTOR_SET),!0)}increase(){return this._refCount++,this._refCount}decrease(){return this._refCount--,0===this._refCount&&this.destroy(),this._refCount}destroy(){this._material&&(this._material.destroy(),this._material=null),this._refCount=0}}const eO=[{name:Sn.ATTR_POSITION,format:En.RGB32F},{name:Sn.ATTR_TEX_COORD,format:En.RG32F},{name:Sn.ATTR_COLOR,format:En.RGBA32F}];var tO=Object.freeze({__proto__:null,vfmt:eO});e("UIVertexFormat",tO);class iO{get renderScene(){return this._scene}get currBufferBatch(){return this._currMeshBuffer}set currBufferBatch(e){e&&(this._currMeshBuffer=e)}set currStaticRoot(e){this._currStaticRoot=e}constructor(e){this.device=void 0,this._screens=[],this._bufferBatchPool=new mo(()=>new qI(this),128),this._drawBatchPool=void 0,this._scene=void 0,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._canvasMaterials=new Map,this._batches=void 0,this._uiModelPool=null,this._modelInUse=void 0,this._emptyMaterial=new Lu,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currCanvas=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._parentOpacity=1,this._root=e,this.device=e.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new _o(()=>{const e=i.director.root.createModel(KI);return e.enabled=!0,e.visFlags|=Xc.Enum.UI_3D,e},2),this._modelInUse=new po(10),this._batches=new po(64),this._drawBatchPool=new _o(()=>new QI,128),i.director.on(i.Director.EVENT_BEFORE_DRAW,this.update,this)}initialize(){return this._attributes=eO,this._requireBufferBatch(),!0}destroy(){for(let e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy();for(let e=0;e<this._meshBuffers.length;e++)this._meshBuffers[e].destroy();this._drawBatchPool&&this._drawBatchPool.destroy(e=>{e.destroy(this)}),this._uiModelPool&&this._uiModelPool.destroy(e=>{e.destroy()}),this._meshBuffers.splice(0),i.director.root.destroyScene(this._scene),i.director.off(i.Director.EVENT_BEFORE_DRAW,this.update,this)}getRenderSceneGetter(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}_getUIMaterial(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);{const t=new JI;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}}_removeUIMaterial(e){this._uiMaterials.has(e)&&0===this._uiMaterials.get(e).decrease()&&this._uiMaterials.delete(e)}addScreen(e){const t=this._screens;for(let e=0;e<t.length;e++){const i=t[e];if(i.camera){const e=i.camera.view.visibility,t=this._canvasMaterials.get(e);if(t){const e=t.keys();let i=e.next();for(;!i.done;)this._removeUIMaterial(i.value),i=e.next();t.clear()}}}this._screens.push(e),this._screens.sort(this._screenSort);for(let e=0;e<t.length;e++){const i=t[e];i.camera&&(i.camera.view.visibility=Xc.BitMask.UI_2D|e+1,this._canvasMaterials.has(i.camera.view.visibility)||this._canvasMaterials.set(i.camera.view.visibility,new Map))}}getScreen(e){const t=this._screens;for(let i=0;i<t.length;++i){const n=t[i];if(n.camera&&n.camera.view.visibility===e)return n}return null}removeScreen(e){const t=this._screens.indexOf(e);if(-1===t)return;if(this._screens.splice(t,1),e.camera){const t=this._canvasMaterials.get(e.camera.view.visibility),i=t.keys();let n=i.next();for(;!n.done;)this._removeUIMaterial(n.value),n=i.next();t.clear()}let i;for(let e=t;e<this._screens.length;e++)if(i=this._screens[e].camera,i){const t=this._canvasMaterials.get(i.view.visibility);i.view.visibility=Xc.BitMask.UI_2D|e+1;const n=this._canvasMaterials.get(i.view.visibility);t.forEach((e,t)=>{n.set(t,e)}),t.clear()}}update(e){if(this._renderScreens(),this._batches.length>0){const e=this._meshBuffers;for(let t=0;t<e.length;++t){const i=e[t];i.uploadData(),i.reset()}}this.render(),this._reset()}sortScreens(){this._screens.sort(this._screenSort)}render(){let e=0;for(let e=0;e<this._modelInUse.length;e++)this._scene.removeModel(this._modelInUse.get(e)),this._uiModelPool.free(this._modelInUse.get(e));if(this._modelInUse.clear(),this._batches.length)for(let t=0;t<this._batches.length;++t){const i=this._batches.array[t];if(i.model){if(i.camera){const e=i.camera.view.visibility;i.model.visFlags=e,i.model.node.layer=e}const t=i.model.subModels;for(let i=0;i<t.length;i++)t[i].priority=e++}else{const t=Dh.get(i.hDescriptorSet),n=tl.SAMPLER_SPRITE;t.bindTexture(n,i.texture),t.bindSampler(n,i.sampler),t.update();const s=this._uiModelPool.alloc();s.directInitialize(i),this._scene.addModel(s),s.subModels[0].priority=e++,i.camera&&(s.visFlags=i.camera.view.visibility,null==this._canvasMaterials.get(i.camera.view.visibility).get(i.material.hash)&&this._canvasMaterials.get(i.camera.view.visibility).set(i.material.hash,1)),this._modelInUse.push(s)}}}commitComp(e,t=null,i,n=null){const s=e,r=t,o=n;let a=s.getRenderMaterial(0);a||(a=s._updateBuiltinMaterial(),a=s._updateBlendFunc()),this._currMaterial===a&&this._currTexture===r&&this._currSampler===o||(this.autoMergeBatches(this._currComponent),this._currComponent=s,this._currMaterial=a,this._currTexture=r,this._currSampler=o),i&&(i.fillBuffers(s,this),this._applyOpacity(s))}commitModel(e,t,i){if(this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i){let e=!1;if(YI.sharedManager.handleMaterial(i)){const t=YI.sharedManager.pattern;i.overridePipelineStates({depthStencilState:{stencilTestFront:t.stencilTest,stencilFuncFront:t.func,stencilReadMaskFront:t.stencilMask,stencilWriteMaskFront:t.writeMask,stencilFailOpFront:t.failOp,stencilZFailOpFront:t.zFailOp,stencilPassOpFront:t.passOp,stencilRefFront:t.ref,stencilTestBack:t.stencilTest,stencilFuncBack:t.func,stencilReadMaskBack:t.stencilMask,stencilWriteMaskBack:t.writeMask,stencilFailOpBack:t.failOp,stencilZFailOpBack:t.zFailOp,stencilPassOpBack:t.passOp,stencilRefBack:t.ref}}),e=!0}if(e&&t)for(let e=0;e<t.subModels.length;e++)t.setSubModelMaterial(e,i)}const n=this._currCanvas,s=this._drawBatchPool.alloc();s.camera=n&&n.camera,s.model=t,s.bufferBatch=null,s.material=i,s.texture=null,s.sampler=null,this._currMaterial=this._emptyMaterial,this._currComponent=null,this._currTexture=null,this._currSampler=null,this._batches.push(s)}commitStaticBatch(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()}autoMergeBatches(e){const t=this._currMeshBuffer,i=this._currCanvas,n=t.recordBatch();let s=this._currMaterial;if(!n||!s)return;if(e&&YI.sharedManager.handleMaterial(s)){this._currMaterial=s=e.getUIMaterialInstance();const t=YI.sharedManager.pattern;s.overridePipelineStates({depthStencilState:{stencilTestFront:t.stencilTest,stencilFuncFront:t.func,stencilReadMaskFront:t.stencilMask,stencilWriteMaskFront:t.writeMask,stencilFailOpFront:t.failOp,stencilZFailOpFront:t.zFailOp,stencilPassOpFront:t.passOp,stencilRefFront:t.ref,stencilTestBack:t.stencilTest,stencilFuncBack:t.func,stencilReadMaskBack:t.stencilMask,stencilWriteMaskBack:t.writeMask,stencilFailOpBack:t.failOp,stencilZFailOpBack:t.zFailOp,stencilPassOpBack:t.passOp,stencilRefBack:t.ref}})}const r=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();r.camera=i&&i.camera,r.bufferBatch=t,r.material=s,r.texture=this._currTexture,r.sampler=this._currSampler,r.hInputAssembler=n,this._batches.push(r),t.vertexStart=t.vertexOffset,t.indicesStart=t.indicesOffset,t.byteStart=t.byteOffset}forceMergeBatches(e,t){this._currMaterial=e,this._currTexture=t,this.autoMergeBatches()}finishMergeBatches(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null}_destroyUIMaterials(){const e=this._uiMaterials.values();let t=e.next();for(;!t.done;){t.value.destroy(),t=e.next()}this._uiMaterials.clear()}_walk(e,t=0){const i=e.children.length,n=this._parentOpacity;if(this._parentOpacity*=e._uiProps.opacity,this._preprocess(e),i>0&&!e._static){const i=e.children;for(let e=0;e<i.length;++e){const n=i[e];this._walk(n,t)}}this._postprocess(e),this._parentOpacity=n,t+=1}_renderScreens(){const e=this._screens;for(let t=0;t<e.length;++t){const i=e[t];i.enabledInHierarchy&&(this._currCanvas=i,this._recursiveScreenNode(i.node))}}_preprocess(e){if(!e._uiProps.uiTransformComp)return;e._uiProps.uiTransformComp._canvas=this._currCanvas;const t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.updateAssembler(this)}_postprocess(e){const t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}_recursiveScreenNode(e){this._walk(e),this.autoMergeBatches(this._currComponent)}_reset(){for(let e=0;e<this._batches.length;++e){const t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._parentOpacity=1,this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=null,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._meshBufferUseCount=0,this._requireBufferBatch(),YI.sharedManager.reset()}_createMeshBuffer(){const e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}_requireBufferBatch(){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(arguments[0],arguments[1])}_screenSort(e,t){const i=e.priority-t.priority;return 0===i?e.node.getSiblingIndex()-t.node.getSiblingIndex():i}_applyOpacity(e){const t=e.color.a/255,i=this._parentOpacity=this._parentOpacity*t,n=this._currMeshBuffer.byteOffset>>2,s=this._currMeshBuffer.vData;for(let e=this._currMeshBuffer.lastByteOffset>>2;e<n;e+=9)s[e+qI.OPACITY_OFFSET]=i;this._currMeshBuffer.lastByteOffset=this._currMeshBuffer.byteOffset}}class nO{get device(){return this._device}get mainWindow(){return this._mainWindow}set curWindow(e){this._curWindow=e}get curWindow(){return this._curWindow}set tempWindow(e){this._tempWindow=e}get tempWindow(){return this._tempWindow}get windows(){return this._windows}get pipeline(){return this._pipeline}get ui(){return this._ui}get scenes(){return this._scenes}get cumulativeTime(){return this._time}get frameTime(){return this._frameTime}get frameCount(){return this._frameCount}get fps(){return this._fps}set fixedFPS(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}get fixedFPS(){return this._fixedFPS}get dataPoolManager(){return this._dataPoolMgr}constructor(e){this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._ui=null,this._dataPoolMgr=void 0,this._scenes=[],this._cameras=[],this._views=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._time=0,this._frameTime=0,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._device=e,this._dataPoolMgr=new jI(e),lp.registerCreateFunc(this),QE.registerCreateFunc(this),this._cameraPool=new _o(()=>new cp(this._device),4)}initialize(e){const t=new Us,n=new Gs;return n.depthStoreOp=Xn.DISCARD,n.stencilStoreOp=Xn.DISCARD,this._mainWindow=this.createWindow({title:"rootMainWindow",width:this._device.width,height:this._device.height,renderPassInfo:{colorAttachments:[t],depthStencilAttachment:n},swapchainBufferIndices:-1}),this._curWindow=this._mainWindow,Th.initBuiltinRes(this._device),i.view.on("design-resolution-changed",()=>{const e=i.game.canvas.width,t=i.game.canvas.height;this.resize(e,t)},this),!0}destroy(){this.clearCameras(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear()}resize(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);for(const i of this._windows)i.shouldSyncSizeWithSwapchain&&i.resize(e,t);for(const i of this._cameras)i.isWindowSize&&i.resize(e,t)}setRenderPipeline(e){if(e||(e=new SC).initialize({flows:[]}),this._pipeline=e,!this._pipeline.activate())return!1;const t=i.director.getScene();return t&&t.globals.activate(),this.onGlobalPipelineStateChanged(),this._ui&&this._ui.destroy(),this._ui=new iO(this),!!this._ui.initialize()||(this.destroy(),!1)}onGlobalPipelineStateChanged(){for(let e=0;e<this._cameras.length;e++)this._cameras[e].view.onGlobalPipelineStateChanged();for(let e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged()}activeWindow(e){this._curWindow=e}resetCumulativeTime(){this._time=0}frameMove(e){if(this._frameTime=e,++this._frameCount,this._time+=this._frameTime,this._fpsTime+=this._frameTime,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),this._pipeline){this._device.acquire(),this._views.length=0;const e=this._cameras,t=i.director.getTotalFrames();for(let i=0;i<e.length;i++){const e=this._cameras[i],n=e.view;n.isEnable&&n.window&&(e.update(),e.scene.update(t),this._views.push(n))}this._pipeline.render(this._views),this._device.present()}}createWindow(e){const t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t}destroyWindow(e){for(let t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}destroyWindows(){for(const e of this._windows)e.destroy();this._windows=[]}createScene(e){const t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}destroyScene(e){for(let t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}destroyScenes(){for(const e of this._scenes)e.destroy();this._scenes=[]}createView(e){const t=new $E;return t.initialize(e),t}attachCamera(e){for(let t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortViews()}detachCamera(e){for(let t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)}clearCameras(){this._cameras.length=0}createModel(e){let t=this._modelPools.get(e);return t||(this._modelPools.set(e,new _o(()=>new e,10)),t=this._modelPools.get(e)),t.alloc()}destroyModel(e){const t=this._modelPools.get(e.constructor);t?(t.free(e),e.destroy(),e.scene&&e.scene.removeModel(e)):console.warn(`'${e.constructor.name}'is not in the model pool and cannot be destroyed by destroyModel.`)}createCamera(){return this._cameraPool.alloc()}destroyCamera(e){this._cameraPool.free(e),e.destroy(),e.scene&&e.scene.removeCamera(e),e.isWindowSize=!0}createLight(e){let t=this._lightPools.get(e);return t||(this._lightPools.set(e,new _o(()=>new e,4)),t=this._lightPools.get(e)),t.alloc()}destroyLight(e){const t=this._lightPools.get(e.constructor);if(e.destroy(),t&&(t.free(e),e.scene))switch(e.type){case bp.SPHERE:e.scene.removeSphereLight(e);break;case bp.SPOT:e.scene.removeSpotLight(e)}}sortViews(){this._cameras.sort((e,t)=>e.view.priority-t.view.priority)}}class sO extends Za{constructor(){super(),this._compScheduler=void 0,this._nodeActivator=void 0,this._invalid=void 0,this._paused=void 0,this._purgeDirectorInNextLoop=void 0,this._root=void 0,this._loadingScene=void 0,this._scene=void 0,this._totalFrames=void 0,this._lastUpdate=void 0,this._deltaTime=void 0,this._scheduler=void 0,this._systems=void 0,this._invalid=!1,this._paused=!1,this._purgeDirectorInNextLoop=!1,this._root=null,this._loadingScene="",this._scene=null,this._totalFrames=0,this._lastUpdate=0,this._deltaTime=0,this._scheduler=new WI,this._compScheduler=new gI,this._nodeActivator=new RI,this._systems=[],i.game.once(OC.EVENT_RENDERER_INITED,this._initOnRendererInitialized,this)}calculateDeltaTime(){const e=performance.now();this._deltaTime=(e-this._lastUpdate)/1e3,this._lastUpdate=e}convertToGL(e){const t=i.game.container,n=i.view,s=t.getBoundingClientRect(),r=s.left+window.pageXOffset-t.clientLeft,o=s.top+window.pageYOffset-t.clientTop,a=n._devicePixelRatio*(e.x-r),c=n._devicePixelRatio*(o+s.height-e.y);return n._isRotated?ui(n._viewportRect.width-c,a):ui(a,c)}convertToUI(e){const t=i.game.container,n=i.view,s=t.getBoundingClientRect(),r=s.left+window.pageXOffset-t.clientLeft,o=s.top+window.pageYOffset-t.clientTop,a=ui(0,0);return n._isRotated?(a.x=r+e.y/n._devicePixelRatio,a.y=o+s.height-(n._viewportRect.width-e.x)/n._devicePixelRatio):(a.x=r+e.x*n._devicePixelRatio,a.y=o+s.height-e.y*n._devicePixelRatio),a}end(){this._purgeDirectorInNextLoop=!0}getWinSize(){return Li(i.winSize)}getWinSizeInPixels(){return Li(i.winSize)}pause(){this._paused||(this._paused=!0)}purgeCachedData(){i.loader.releaseAll()}purgeDirector(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),$u&&$u.setEnabled(!1),i.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),i.loader.releaseAll()}reset(){this.purgeDirector(),this.emit(sO.EVENT_RESET),$u&&$u.setEnabled(!0),this.startAnimation()}runSceneImmediate(e,t,n){E(e instanceof i.Scene,1216);const s=i.loader._getReferenceKey(e.uuid);i.loader.removeItem(s),e._load();const r=Object.keys(i.game._persistRootNodes).map(e=>i.game._persistRootNodes[e]);for(let t=0;t<r.length;t++){const n=r[t];n.emit(i.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);const s=e.getChildByUuid(n.uuid);if(s){const t=s.getSiblingIndex();s._destroyImmediate(),e.insertChild(n,t)}else n.parent=e}const o=this._scene;!function(e,t,n){let s=i.loader._autoReleaseSetting,r=ce();if(t)for(let e=0;e<t.length;e++)r[t[e]]=!0;for(let e=0;e<n.length;e++)Cx(n[e],r);if(e)for(let t=0;t<e.length;t++){let n=e[t];!1===s[n]||r[n]||i.loader.release(n)}let o=Object.keys(s);for(let e=0;e<o.length;e++){let t=o[e];!0!==s[t]||r[t]||i.loader.release(t)}}(o&&o.autoReleaseAssets&&o.dependAssets,e.dependAssets,r);i.isValid(o)&&o.destroy(),this._scene=null,Ua._deferredDestroy(),t&&t(),this.emit(i.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(i.Director.EVENT_AFTER_SCENE_LAUNCH,e)}runScene(e,t,n){E(e,1205),E(e instanceof i.Scene,1216),e._load(),this.once(i.Director.EVENT_AFTER_DRAW,()=>{this.runSceneImmediate(e,t,n)})}_getSceneUuid(e){const t=i.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(let i=0;i<t.length;i++){const n=t[i];if(n.url.endsWith(e))return n}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];S(1206,e)}else S(1207,e);return null}loadScene(e,t,n){if(this._loadingScene)return S(1208,e,this._loadingScene),!1;const s=this._getSceneUuid(e);if(s){const r=s.uuid;return this.emit(i.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(r,t,n),!0}return S(1209,e),!1}preloadScene(e,t,n){let s,r;void 0===n?(r=t,s=void 0):(r=n,s=t);const o=this._getSceneUuid(e);if(o)this.emit(i.Director.EVENT_BEFORE_SCENE_LOADING,e),i.loader.load({uuid:o.uuid,type:"uuid"},s,(t,i)=>{t&&S(1210,e,t.message),r&&r(t,i)});else{const t='Can not preload the scene "'+e+'" because it is not in the build settings.';r&&r(new Error(t)),u("preloadScene: "+t)}}_loadSceneByUuid(e,t,n,s){let r,o;r=t,o=n,console.time("LoadScene "+e),i.AssetLibrary.loadAsset(e,(t,n)=>{console.timeEnd("LoadScene "+e);const s=rO;if(s._loadingScene="",t)u(t="Failed to load scene: "+t);else{if(n instanceof i.SceneAsset){const e=n.scene;return e._id=n._uuid,e._name=n._name,void s.runSceneImmediate(e,o,r)}u(t="The asset "+e+" is not a scene")}r&&r(t)})}resume(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||g(1200),this._paused=!1,this._deltaTime=0)}setDepthTest(e){i.Camera.main&&(i.Camera.main.depth=!!e)}setClearColor(e){i.Camera.main&&(i.Camera.main.backgroundColor=e)}get root(){return this._root}getRunningScene(){return this._scene}getScene(){return this._scene}getAnimationInterval(){return 1e3/i.game.getFrameRate()}setAnimationInterval(e){i.game.setFrameRate(Math.round(1e3/e))}getDeltaTime(){return this._deltaTime}getCurrentTime(){return this._lastUpdate}getTotalFrames(){return this._totalFrames}isPaused(){return this._paused}getScheduler(){return this._scheduler}setScheduler(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(WI.ID,e,200))}registerSystem(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(zI.sortByPriority)}unregisterSystem(e){Le.fastRemove(this._systems,e),this._systems.sort(zI.sortByPriority)}getSystem(e){return this._systems.find(t=>t.id===e)}getAnimationManager(){return this.getSystem(i.AnimationManager.ID)}startAnimation(){this._invalid=!1,this._lastUpdate=performance.now()}stopAnimation(){this._invalid=!0}mainLoop(e){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this._invalid){this.calculateDeltaTime();const e=this._deltaTime;if(!this._paused){this.emit(sO.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(let t=0;t<this._systems.length;++t)this._systems[t].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(sO.EVENT_AFTER_UPDATE),Ua._deferredDestroy();for(let t=0;t<this._systems.length;++t)this._systems[t].postUpdate(e)}this.emit(sO.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this.emit(sO.EVENT_AFTER_DRAW),$u.frameUpdateListeners(),kd.bookOfChange.clear(),this._totalFrames++}}_initOnRendererInitialized(){this._totalFrames=0,this._lastUpdate=performance.now(),this._paused=!1,this._purgeDirectorInNextLoop=!1,$u&&$u.setEnabled(!0),this.registerSystem(WI.ID,this._scheduler,200),this.emit(sO.EVENT_INIT)}_init(){i.loader.init(this),this._root=new nO(i.game._gfxDevice);return!!this._root.initialize({})||(S(1217),!1)}}e("Director",sO),sO.EVENT_INIT="director_init",sO.EVENT_RESET="director_reset",sO.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",sO.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",sO.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",sO.EVENT_BEFORE_UPDATE="director_before_update",sO.EVENT_AFTER_UPDATE="director_after_update",sO.EVENT_BEFORE_DRAW="director_before_draw",sO.EVENT_AFTER_DRAW="director_after_draw",sO.EVENT_BEFORE_PHYSICS="director_before_physics",sO.EVENT_AFTER_PHYSICS="director_after_physics",sO.instance=void 0,i.Director=sO;const rO=e("director",sO.instance=i.director=new sO);var oO,aO,cO,lO,hO,uO,_O,dO,mO;let pO=e("EventHandler",(oO=Go("cc.ClickEvent"),aO=va(i.Node),oO((hO=Po((lO=class e{constructor(){Oo(this,"target",hO,this),Oo(this,"component",uO,this),Oo(this,"_componentId",_O,this),Oo(this,"handler",dO,this),Oo(this,"customEventData",mO,this)}get _componentName(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)}set _componentName(e){this._componentId=this._compName2Id(e)}static emitEvents(t,...i){for(let n=0,s=t.length;n<s;n++){const s=t[n];s instanceof e&&s.emit(i)}}emit(e){const t=this.target;if(!i.isValid(t))return;this._genCompIdIfNeeded();const n=i.js._getClassById(this._componentId),s=t.getComponent(n);if(!i.isValid(s))return;const r=s[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(s,e))}_compName2Id(e){const t=i.js.getClassByName(e);return i.js._getClassId(t)}_compId2Name(e){const t=i.js._getClassById(e);return i.js.getClassName(t)}_genCompIdIfNeeded(){this._componentId||(this._componentName=this.component,this.component="")}}).prototype,"target",[aO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uO=Po(lO.prototype,"component",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_O=Po(lO.prototype,"_componentId",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dO=Po(lO.prototype,"handler",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mO=Po(lO.prototype,"customEventData",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cO=lO))||cO));var fO,gO,vO,yO,xO,SO,TO,EO,AO,CO,bO,RO,wO;i.Component.EventHandler=pO;let IO=function(t){return e({SkinnedMeshRenderer:t,SkinningModelComponent:t}),t}((fO=Go("cc.SkinnedMeshRenderer"),gO=ta(),vO=Vo(100),yO=$o(),xO=va(DS),SO=va(kd),TO=va(DS),EO=va(kd),AO=ra(),fO(CO=gO(CO=vO(CO=Zo(CO=yO((RO=Po((bO=class extends Mg{get skeleton(){return this._skeleton}set skeleton(e){e!==this._skeleton&&(this._skeleton=e,this._update())}get skinningRoot(){return this._skinningRoot}set skinningRoot(e){e!==this._skinningRoot&&(this._skinningRoot=e,this._updateModelType(),this._update())}get model(){return this._model}constructor(){super(),Oo(this,"_skeleton",RO,this),Oo(this,"_skinningRoot",wO,this),this._clip=null,this._modelType=qm}__preload(){this._updateModelType()}uploadAnimation(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)}setUseBakedAnimation(e=!0){const t=e?qm:Wm;this._modelType!==t&&(this._modelType=t,this._model&&(i.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))}setMaterial(e,t){super.setMaterial(e,t),this._modelType===Wm&&this.getMaterialInstance(t)}_updateModelParams(){this._update(),super._updateModelParams()}_updateModelType(){if(!this._skinningRoot)return;const e=this._skinningRoot.getComponent("cc.SkeletalAnimation");e&&this.setUseBakedAnimation(e.useBakedAnimation)}_update(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))}}).prototype,"_skeleton",[xO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wO=Po(bO.prototype,"_skinningRoot",[SO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Po(bO.prototype,"skeleton",[TO],Object.getOwnPropertyDescriptor(bO.prototype,"skeleton"),bO.prototype),Po(bO.prototype,"skinningRoot",[EO,AO],Object.getOwnPropertyDescriptor(bO.prototype,"skinningRoot"),bO.prototype),CO=bO))||CO)||CO)||CO)||CO)||CO));var OO,PO,MO,DO,LO,BO,NO,FO,zO,UO,GO,HO,VO,kO,WO,jO,qO,XO,YO,KO,ZO,$O,QO,JO,eP,tP,iP,nP,sP;const rP={name:Sn.ATTR_BATCH_ID,format:En.R32F,isNormalized:!1},oP={name:Sn.ATTR_BATCH_UV,format:En.RG32F,isNormalized:!1},aP=_s[rP.format].size+_s[oP.format].size;let cP=function(t){return e({SkinnedMeshUnit:t,SkinningModelUnit:t}),t}((OO=Go("cc.SkinnedMeshUnit"),PO=va(Hl),MO=va(DS),DO=va(Lu),LO=va(IO),OO((FO=Po((NO=class{constructor(){Oo(this,"mesh",FO,this),Oo(this,"skeleton",zO,this),Oo(this,"material",UO,this),Oo(this,"_localTransform",GO,this),Oo(this,"_offset",HO,this),Oo(this,"_size",VO,this)}set offset(e){ci.copy(this._offset,e)}get offset(){return this._offset}set size(e){ci.copy(this._size,e)}get size(){return this._size}set copyFrom(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&rm(e.node,e.skinningRoot,this._localTransform))}get copyFrom(){return null}}).prototype,"mesh",[PO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zO=Po(NO.prototype,"skeleton",[MO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UO=Po(NO.prototype,"material",[DO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GO=Po(NO.prototype,"_localTransform",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wi}}),HO=Po(NO.prototype,"_offset",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ci(0,0)}}),VO=Po(NO.prototype,"_size",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ci(1,1)}}),Po(NO.prototype,"offset",[ia],Object.getOwnPropertyDescriptor(NO.prototype,"offset"),NO.prototype),Po(NO.prototype,"size",[ia],Object.getOwnPropertyDescriptor(NO.prototype,"size"),NO.prototype),Po(NO.prototype,"copyFrom",[LO],Object.getOwnPropertyDescriptor(NO.prototype,"copyFrom"),NO.prototype),BO=NO))||BO));const lP=new wi,hP=(new wi,new _i);let uP=function(t){return e({SkinnedMeshBatchRenderer:t,BatchedSkinningModelComponent:t}),t}((kO=Go("cc.SkinnedMeshBatchRenderer"),WO=ta(),jO=Vo(100),qO=$o(),XO=ra(),YO=va([lt]),KO=ra(),ZO=va([cP]),$O=ra(),QO=na(),JO=na(),kO(eP=WO(eP=jO(eP=Zo(eP=qO((iP=Po((tP=class extends IO{constructor(...e){super(...e),Oo(this,"atlasSize",iP,this),Oo(this,"batchableTextureNames",nP,this),Oo(this,"units",sP,this),this._textures={},this._batchMaterial=null}get mesh(){return super.mesh}set mesh(e){super.mesh=e}get skeleton(){return super.skeleton}set skeleton(e){super.skeleton=e}onLoad(){super.onLoad(),this.cook()}onDestroy(){for(const e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),super.onDestroy()}_onMaterialModified(e,t){this.cookMaterials(),super._onMaterialModified(e,this.getMaterialInstance(e))}cook(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}cookMaterials(){this._batchMaterial||(this._batchMaterial=this.getMaterial(0));const e=this.getMaterialInstance(0);if(!e||!this._batchMaterial||!this._batchMaterial.effectAsset)return void console.warn("incomplete batch material!");e.copy(this._batchMaterial),this.resizeAtlases();const t=e.effectAsset.techniques[e.technique];for(let i=0;i<t.passes.length;i++){const n=t.passes[i];if(n.properties)for(const t in n.properties)if(n.properties[t].type>=Tn.SAMPLER1D){let n=null;this.batchableTextureNames.find(e=>e===t)?(n=this._textures[t],n||(n=this.createTexture(t)),this.cookTextures(n,t,i)):this.units.some(e=>n=e.material&&e.material.getProperty(t,i)),n&&e.setProperty(t,n,i)}else{const n=[];for(let e=0;e<this.units.length;e++){const s=this.units[e];s.material&&n.push(s.material.getProperty(t.slice(0,-3),i))}e.setProperty(t,n,i)}}}cookSkeletons(){if(!this._skinningRoot)return void console.warn("no skinning root specified!");const e=[],t=[];for(let i=0;i<this.units.length;i++){const n=this.units[i];if(!n||!n.skeleton)continue;const s=n.skeleton;wi.invert(lP,n._localTransform);for(let i=0;i<s.joints.length;i++){const n=s.joints[i];e.findIndex(e=>e===n)>=0||(e.push(n),t.push(wi.multiply(new wi,s.bindposes[i]||wi.IDENTITY,lP)))}}const i=Array.from(Array(e.length).keys()).sort((t,i)=>e[t]>e[i]?1:e[t]<e[i]?-1:0),n=new DS;n.joints=e.map((e,t,n)=>n[i[t]]),n.bindposes=t.map((e,t,n)=>n[i[t]]),this._skeleton&&this._skeleton.destroy(),this.skeleton=n}cookMeshes(){let e=!1;for(let t=0;t<this.units.length;t++){if(this.units[t].mesh){e=!0;break}}if(!e||!this._skinningRoot)return;this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new Hl;let t=0,i=En.UNKNOWN,n=0,s=En.UNKNOWN,r=0,o=En.UNKNOWN,a=0,c=En.UNKNOWN,l=0,h=En.UNKNOWN;const u=new Array(this.units.length),_=this.units.length;for(let e=0;e<_;e++){const t=this.units[e];t&&t.skeleton&&(u[e]=t.skeleton.joints.map(e=>this._skeleton.joints.findIndex(t=>e===t)))}for(let e=0;e<_;e++){const _=this.units[e];if(!_||!_.mesh||!_.mesh.data)continue;const d=this._createUnitMesh(e,_.mesh),m=new DataView(d.data.buffer);wi.inverseTranspose(lP,_._localTransform);const p=_.offset,f=_.size;for(let g=0;g<d.struct.vertexBundles.length;g++){const v=d.struct.vertexBundles[g];t=v.view.offset,i=En.UNKNOWN;for(let e=0;e<v.attributes.length;e++){const n=v.attributes[e];if(n.name===Sn.ATTR_POSITION){i=n.format;break}t+=_s[n.format].size}if(i){const e=La(m,i,t,v.view.length,v.view.stride);for(let t=0;t<e.length;t+=3)_i.fromArray(hP,e,t),_i.transformMat4(hP,hP,_._localTransform),_i.toArray(e,hP,t);Da(m,e,i,t,v.view.stride)}n=v.view.offset,s=En.UNKNOWN;for(let e=0;e<v.attributes.length;e++){const t=v.attributes[e];if(t.name===Sn.ATTR_NORMAL){s=t.format;break}n+=_s[t.format].size}if(s){const e=La(m,s,n,v.view.length,v.view.stride);for(let t=0;t<e.length;t+=3)_i.fromArray(hP,e,t),_i.transformMat4Normal(hP,hP,lP),_i.toArray(e,hP,t);Da(m,e,s,n,v.view.stride)}r=v.view.offset,o=En.UNKNOWN;for(let e=0;e<v.attributes.length;e++){const t=v.attributes[e];if(t.name===Sn.ATTR_TANGENT){o=t.format;break}r+=_s[t.format].size}if(o){const e=La(m,o,r,v.view.length,v.view.stride);for(let t=0;t<e.length;t+=3)_i.fromArray(hP,e,t),_i.transformMat4Normal(hP,hP,lP),_i.toArray(e,hP,t);Da(m,e,o,r,v.view.stride)}a=v.view.offset,c=En.UNKNOWN;for(let e=0;e<v.attributes.length;e++){const t=v.attributes[e];if(t.name===Sn.ATTR_BATCH_UV){c=t.format;break}a+=_s[t.format].size}c&&Ba(m,(e,t)=>{var i;const n=0===t?"x":"y";return(e=(i=e)-Math.floor(i))*f[n]+p[n]},c,a,v.view.length,v.view.stride,m);const y=u[e];if(y){l=v.view.offset,h=En.UNKNOWN;for(let e=0;e<v.attributes.length;e++){const t=v.attributes[e];if(t.name===Sn.ATTR_JOINTS){h=t.format;break}l+=_s[t.format].size}h&&Ba(m,e=>y[e],h,l,v.view.length,v.view.stride,m)}}this._mesh.merge(d)}this._onMeshChanged(this._mesh),this._updateModels()}cookTextures(e,t,n){const s=[],r=[],o=[],a=[];for(let e=0;e<this.units.length;e++){const i=this.units[e];if(!i.material)continue;const c=i.material.getProperty(t,n);if(c&&c.image&&c.image.data){const e=new ls;e.texOffset.x=i.offset.x*this.atlasSize,e.texOffset.y=i.offset.y*this.atlasSize,e.texExtent.width=i.size.x*this.atlasSize,e.texExtent.height=i.size.y*this.atlasSize;const t=c.image.data;t instanceof HTMLCanvasElement||t instanceof HTMLImageElement?(s.push(t),r.push(e)):(o.push(t),a.push(e))}}const c=e.getGFXTexture(),l=i.director.root.device;o.length>0&&l.copyBuffersToTexture(o,c,a),s.length>0&&l.copyTexImagesToTexture(s,c,r)}createTexture(e){const t=new jc;return t.setFilters(ac.LINEAR,ac.LINEAR),t.setMipFilter(ac.LINEAR),t.reset({width:this.atlasSize,height:this.atlasSize,format:rc.RGBA8888}),t.loaded=!0,this._textures[e]=t,t}resizeAtlases(){for(const e in this._textures){this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:rc.RGBA8888})}}_createUnitMesh(e,t){const n=JSON.parse(JSON.stringify(t.struct)),s={};for(let e=0;e<t.struct.primitives.length;e++){const i=t.struct.primitives[e];let r=0,o=En.UNKNOWN,a=0;for(;a<i.vertexBundelIndices.length;a++){const e=t.struct.vertexBundles[i.vertexBundelIndices[a]];r=e.view.offset,o=En.UNKNOWN;for(let t=0;t<e.attributes.length;t++){const i=e.attributes[t];if(i.name===Sn.ATTR_TEX_COORD){o=i.format;break}r+=_s[i.format].size}if(o)break}if(void 0!==s[a])continue;s[a]=[o,r];const c=n.vertexBundles[a];c.attributes.push(rP),c.attributes.push(oP),c.view.offset=0,c.view.length+=c.view.count*aP,c.view.stride+=aP}let r=0;for(let e=0;e<n.vertexBundles.length;e++)r+=n.vertexBundles[e].view.length;for(let e=0;e<n.primitives.length;e++){const t=n.primitives[e];t.indexView&&(t.indexView.offset=r,r+=t.indexView.length)}const o=new Uint8Array(r),a=t.data,c=new DataView(o.buffer),l=new DataView(a.buffer),h=i.sys.isLittleEndian;for(const i in s){const r=n.vertexBundles[i],u=t.struct.vertexBundles[i],[_,d]=s[i],m=La(l,_,d,u.view.length,u.view.stride),p=u.view,f=r.view,g=p.stride,v=f.stride;let y=p.offset,x=f.offset;for(let t=0;t<f.count;t++){const i=a.subarray(y,y+g);o.set(i,x),c.setFloat32(x+g,e),c.setFloat32(x+g+4,m[2*t],h),c.setFloat32(x+g+8,m[2*t+1],h),x+=v,y+=g}}for(let e=0;e<n.primitives.length;e++){const i=t.struct.primitives[e],s=n.primitives[e];if(i.indexView&&s.indexView){const e=i.indexView.stride,t=s.indexView.stride;let n=i.indexView.offset,r=s.indexView.offset;for(let i=0;i<s.indexView.count;i++){const i=a.subarray(n,n+e);o.set(i,r),r+=t,n+=e}}}const u=new Hl;return u.reset({struct:n,data:o}),u}}).prototype,"atlasSize",[Xo,XO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),nP=Po(tP.prototype,"batchableTextureNames",[YO,Xo,KO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sP=Po(tP.prototype,"units",[ZO,Xo,$O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Po(tP.prototype,"mesh",[ya,QO],Object.getOwnPropertyDescriptor(tP.prototype,"mesh"),tP.prototype),Po(tP.prototype,"skeleton",[ya,JO],Object.getOwnPropertyDescriptor(tP.prototype,"skeleton"),tP.prototype),eP=tP))||eP)||eP)||eP)||eP)||eP));var _P,dP,mP,pP,fP,gP,vP,yP,xP,SP,TP,EP,AP,CP,bP,RP,wP,IP,OP,PP,MP,DP,LP,BP,NP,FP,zP,UP,GP,HP,VP,kP,WP,jP,qP,XP,YP,KP,ZP,$P,QP,JP,eM,tM,iM,nM,sM,rM,oM,aM,cM,lM,hM,uM,_M,dM,mM,pM,fM,gM,vM,yM,xM,SM,TM,EM,AM;const CM=new _i,bM=Ye(Zm),RM=Ye(Km),wM=Ye($m),IM=Ye(Jm),OM=Ye(Qm),PM=Ye({SKYBOX:ap|Jn.DEPTH_STENCIL,SOLID_COLOR:Jn.ALL,DEPTH_ONLY:Jn.DEPTH_STENCIL,DONT_CLEAR:Jn.NONE});let MM=function(t){return e({Camera:t,CameraComponent:t}),t}((_P=Go("cc.Camera"),dP=ta(),mP=$o(),pP=ua(),fP=ra(),gP=va(Xc.BitMask),vP=ua(),yP=ra(),xP=va(PM),SP=ua(),TP=ra(),EP=ua(),AP=ra(),CP=ua(),bP=ra(),RP=ua(),wP=ra(),IP=va(bM),OP=ua(),PP=ra(),MP=va(RM),DP=ua(),LP=ra(),BP=ua(),NP=ra(),FP=ua(),zP=ra(),UP=ua(),GP=ra(),HP=ua(),VP=ra(),kP=va(wM),WP=ua(),jP=ra(),qP=va(IM),XP=ua(),YP=ra(),KP=va(OM),ZP=ua(),$P=ra(),QP=ua(),JP=ra(),eM=va(Eu),tM=ua(),iM=ra(),_P(nM=dP(nM=mP(nM=Zo((AM=EM=class extends f_{constructor(...e){super(...e),Oo(this,"_projection",rM,this),Oo(this,"_priority",oM,this),Oo(this,"_fov",aM,this),Oo(this,"_fovAxis",cM,this),Oo(this,"_orthoHeight",lM,this),Oo(this,"_near",hM,this),Oo(this,"_far",uM,this),Oo(this,"_color",_M,this),Oo(this,"_depth",dM,this),Oo(this,"_stencil",mM,this),Oo(this,"_clearFlags",pM,this),Oo(this,"_rect",fM,this),Oo(this,"_aperture",gM,this),Oo(this,"_shutter",vM,this),Oo(this,"_iso",yM,this),Oo(this,"_screenScale",xM,this),Oo(this,"_visibility",SM,this),Oo(this,"_targetTexture",TM,this),this._camera=null,this._inEditorMode=!1,this._flows=void 0}get camera(){return this._camera}get priority(){return this._priority}set priority(e){this._priority=e,this._camera&&(this._camera.priority=e)}get visibility(){return this._visibility}set visibility(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}get clearFlags(){return this._clearFlags}set clearFlags(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}get clearColor(){return this._color}set clearColor(e){this._color.set(e),this._camera&&(this._camera.clearColor.r=this._color.x,this._camera.clearColor.g=this._color.y,this._camera.clearColor.b=this._color.z,this._camera.clearColor.a=this._color.w)}get clearDepth(){return this._depth}set clearDepth(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}get clearStencil(){return this._stencil}set clearStencil(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}get projection(){return this._projection}set projection(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}get fovAxis(){return this._fovAxis}set fovAxis(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===Km.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}get fov(){return this._fov}set fov(e){this._fov=e,this._camera&&(this._camera.fov=Yt(e))}get orthoHeight(){return this._orthoHeight}set orthoHeight(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}get near(){return this._near}set near(e){this._near=e,this._camera&&(this._camera.nearClip=e)}get far(){return this._far}set far(e){this._far=e,this._camera&&(this._camera.farClip=e)}get aperture(){return this._aperture}set aperture(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}get shutter(){return this._shutter}set shutter(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}get iso(){return this._iso}set iso(e){this._iso=e,this._camera&&(this._camera.iso=e)}get rect(){return this._rect}set rect(e){this._rect=e,this._camera&&(this._camera.viewport=e)}get targetTexture(){return this._targetTexture}set targetTexture(e){if(this._targetTexture===e)return;const t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}get screenScale(){return this._screenScale}set screenScale(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}get inEditorMode(){return this._inEditorMode}set inEditorMode(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow)}set flows(e){this._camera&&(this._camera.flows=e),this._flows=e}onLoad(){this._createCamera()}onEnable(){this.node.hasChangedFlags|=K_.POSITION,this._camera&&this._attachToScene()}onDisable(){this._camera&&this._detachFromScene()}onDestroy(){this._camera&&(i.director.root.destroyCamera(this._camera),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}screenPointToRay(e,t,i){return i||(i=cn.create()),this._camera&&this._camera.screenPointToRay(i,e,t),i}worldToScreen(e,t){return t||(t=new _i),this._camera&&this._camera.worldToScreen(t,e),t}screenToWorld(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t}convertToUINode(e,t,n){if(n||(n=new _i),!this._camera)return n;this.worldToScreen(e,CM);const s=t.getComponent("cc.UITransform"),r=FC.getVisibleSize(),o=CM.x-.5*this._camera.width,a=CM.y-.5*this._camera.height;return CM.x=o/i.view.getScaleX()+.5*r.width,CM.y=a/i.view.getScaleY()+.5*r.height,s&&s.convertToNodeSpaceAR(CM,n),n}_createCamera(){if(this._camera=i.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow,priority:this._priority,flows:this._flows}),this._camera){this._camera.viewport=this._rect,this._camera.fovAxis=this._fovAxis,this._camera.fov=Yt(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far;const e=this._color.x,t=this._color.y,i=this._color.z,n=this._color.w;this._camera.clearColor={r:e,g:t,b:i,a:n},this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso}this._updateTargetTexture()}_attachToScene(){if(!this.node.scene||!this._camera)return;this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera);this._getRenderScene().addCamera(this._camera)}_detachFromScene(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}_chechTargetTextureEvent(e){const t=e=>{this._camera&&this._camera.setFixedSize(e.width,e.height)};e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",t,this)}_updateTargetTexture(){if(this._camera&&this._targetTexture){const e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}},EM.ProjectionType=bM,EM.FOVAxis=RM,EM.ClearFlag=PM,EM.Aperture=wM,EM.Shutter=IM,EM.ISO=OM,rM=Po((sM=AM).prototype,"_projection",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bM.PERSPECTIVE}}),oM=Po(sM.prototype,"_priority",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aM=Po(sM.prototype,"_fov",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),cM=Po(sM.prototype,"_fovAxis",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RM.VERTICAL}}),lM=Po(sM.prototype,"_orthoHeight",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),hM=Po(sM.prototype,"_near",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),uM=Po(sM.prototype,"_far",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),_M=Po(sM.prototype,"_color",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi("#333333")}}),dM=Po(sM.prototype,"_depth",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mM=Po(sM.prototype,"_stencil",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pM=Po(sM.prototype,"_clearFlags",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PM.SOLID_COLOR}}),fM=Po(sM.prototype,"_rect",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bi(0,0,1,1)}}),gM=Po(sM.prototype,"_aperture",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wM.F16_0}}),vM=Po(sM.prototype,"_shutter",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return IM.D125}}),yM=Po(sM.prototype,"_iso",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OM.ISO100}}),xM=Po(sM.prototype,"_screenScale",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),SM=Po(sM.prototype,"_visibility",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Al}}),TM=Po(sM.prototype,"_targetTexture",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Po(sM.prototype,"priority",[pP,fP],Object.getOwnPropertyDescriptor(sM.prototype,"priority"),sM.prototype),Po(sM.prototype,"visibility",[gP,vP,yP],Object.getOwnPropertyDescriptor(sM.prototype,"visibility"),sM.prototype),Po(sM.prototype,"clearFlags",[xP,SP,TP],Object.getOwnPropertyDescriptor(sM.prototype,"clearFlags"),sM.prototype),Po(sM.prototype,"clearColor",[EP,AP],Object.getOwnPropertyDescriptor(sM.prototype,"clearColor"),sM.prototype),Po(sM.prototype,"clearDepth",[CP,bP],Object.getOwnPropertyDescriptor(sM.prototype,"clearDepth"),sM.prototype),Po(sM.prototype,"clearStencil",[RP,wP],Object.getOwnPropertyDescriptor(sM.prototype,"clearStencil"),sM.prototype),Po(sM.prototype,"projection",[IP,OP,PP],Object.getOwnPropertyDescriptor(sM.prototype,"projection"),sM.prototype),Po(sM.prototype,"fovAxis",[MP,DP,LP],Object.getOwnPropertyDescriptor(sM.prototype,"fovAxis"),sM.prototype),Po(sM.prototype,"fov",[BP,NP],Object.getOwnPropertyDescriptor(sM.prototype,"fov"),sM.prototype),Po(sM.prototype,"orthoHeight",[FP,zP],Object.getOwnPropertyDescriptor(sM.prototype,"orthoHeight"),sM.prototype),Po(sM.prototype,"near",[UP,GP],Object.getOwnPropertyDescriptor(sM.prototype,"near"),sM.prototype),Po(sM.prototype,"far",[HP,VP],Object.getOwnPropertyDescriptor(sM.prototype,"far"),sM.prototype),Po(sM.prototype,"aperture",[kP,WP,jP],Object.getOwnPropertyDescriptor(sM.prototype,"aperture"),sM.prototype),Po(sM.prototype,"shutter",[qP,XP,YP],Object.getOwnPropertyDescriptor(sM.prototype,"shutter"),sM.prototype),Po(sM.prototype,"iso",[KP,ZP,$P],Object.getOwnPropertyDescriptor(sM.prototype,"iso"),sM.prototype),Po(sM.prototype,"rect",[QP,JP],Object.getOwnPropertyDescriptor(sM.prototype,"rect"),sM.prototype),Po(sM.prototype,"targetTexture",[eM,tM,iM],Object.getOwnPropertyDescriptor(sM.prototype,"targetTexture"),sM.prototype),nM=sM))||nM)||nM)||nM)||nM));var DM,LM,BM,NM,FM,zM,UM,GM,HM,VM,kM,WM,jM,qM,XM,YM,KM,ZM,$M;i.Camera=MM;const QM=Ye({LUMINOUS_POWER:0,LUMINANCE:1});let JM=Go("cc.StaticLightSettings")((BM=Po((LM=class{constructor(){Oo(this,"_editorOnly",BM,this),Oo(this,"_bakeable",NM,this),Oo(this,"_castShadow",FM,this)}get editorOnly(){return this._editorOnly}set editorOnly(e){this._editorOnly=e}get bakeable(){return this._bakeable}set bakeable(e){this._bakeable=e}get castShadow(){return this._castShadow}set castShadow(e){this._castShadow=e}}).prototype,"_editorOnly",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NM=Po(LM.prototype,"_bakeable",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FM=Po(LM.prototype,"_castShadow",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Po(LM.prototype,"editorOnly",[ia],Object.getOwnPropertyDescriptor(LM.prototype,"editorOnly"),LM.prototype),Po(LM.prototype,"bakeable",[ia],Object.getOwnPropertyDescriptor(LM.prototype,"bakeable"),LM.prototype),Po(LM.prototype,"castShadow",[ia],Object.getOwnPropertyDescriptor(LM.prototype,"castShadow"),LM.prototype),DM=LM))||DM,eD=function(t){return e({Light:t,LightComponent:t}),t}((zM=Go("cc.Light"),UM=ra(),GM=ra(),HM=oa(),VM=ra(),kM=va(JM),zM(($M=ZM=class extends f_{get color(){return this._color}set color(e){this._color=e,this._light&&(this._light.color.x=e.r/255,this._light.color.y=e.g/255,this._light.color.z=e.b/255)}get useColorTemperature(){return this._useColorTemperature}set useColorTemperature(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}get colorTemperature(){return this._colorTemperature}set colorTemperature(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}get staticSettings(){return this._staticSettings}set staticSettings(e){this._staticSettings=e}get type(){return this._type}constructor(){super(),Oo(this,"_color",qM,this),Oo(this,"_useColorTemperature",XM,this),Oo(this,"_colorTemperature",YM,this),Oo(this,"_staticSettings",KM,this),this._type=bp.UNKNOWN,this._lightType=void 0,this._light=null,this._lightType=wp}onLoad(){this._createLight()}onEnable(){this._attachToScene()}onDisable(){this._detachFromScene()}onDestroy(){this._destroyLight()}_createLight(){this._light||(this._light=i.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node}_destroyLight(){this._light&&(i.director.root.destroyLight(this),this._light=null)}_attachToScene(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){const e=this._getRenderScene();switch(this._type){case bp.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case bp.SPHERE:e.addSphereLight(this._light);break;case bp.SPOT:e.addSpotLight(this._light)}}}_detachFromScene(){if(this._light&&this._light.scene){const e=this._light.scene;switch(this._type){case bp.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case bp.SPHERE:e.removeSphereLight(this._light);break;case bp.SPOT:e.removeSpotLight(this._light)}}}},ZM.Type=bp,ZM.PhotometricTerm=QM,qM=Po((jM=$M).prototype,"_color",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fi.WHITE.clone()}}),XM=Po(jM.prototype,"_useColorTemperature",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YM=Po(jM.prototype,"_colorTemperature",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),KM=Po(jM.prototype,"_staticSettings",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new JM}}),Po(jM.prototype,"color",[UM],Object.getOwnPropertyDescriptor(jM.prototype,"color"),jM.prototype),Po(jM.prototype,"useColorTemperature",[GM],Object.getOwnPropertyDescriptor(jM.prototype,"useColorTemperature"),jM.prototype),Po(jM.prototype,"colorTemperature",[ha,HM,VM],Object.getOwnPropertyDescriptor(jM.prototype,"colorTemperature"),jM.prototype),Po(jM.prototype,"staticSettings",[kM],Object.getOwnPropertyDescriptor(jM.prototype,"staticSettings"),jM.prototype),WM=jM))||WM));var tD,iD,nD,sD,rD,oD,aD,cD;let lD=function(t){return e({DirectionalLight:t,DirectionalLightComponent:t}),t}((tD=Go("cc.DirectionalLight"),iD=ta(),nD=$o(),sD=_a(),rD=ra(),tD(oD=iD(oD=nD(oD=Zo((cD=Po((aD=class extends eD{get illuminance(){return this._illuminance}set illuminance(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}constructor(){super(),Oo(this,"_illuminance",cD,this),this._type=bp.DIRECTIONAL,this._light=null,this._lightType=Mp}_createLight(){super._createLight(),this._light&&(this.illuminance=this._illuminance)}}).prototype,"_illuminance",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),Po(aD.prototype,"illuminance",[sD,rD],Object.getOwnPropertyDescriptor(aD.prototype,"illuminance"),aD.prototype),oD=aD))||oD)||oD)||oD)||oD));var hD,uD,_D,dD,mD,pD,fD,gD,vD,yD,xD,SD,TD,ED,AD,CD,bD;let RD=function(t){return e({SphereLight:t,SphereLightComponent:t}),t}((hD=Go("cc.SphereLight"),uD=ta(),_D=$o(),dD=_a(),mD=ra(),pD=_a(),fD=ra(),gD=va(QM),vD=ra(),yD=ra(),xD=ra(),hD(SD=uD(SD=_D(SD=Zo((ED=Po((TD=class extends eD{get luminousPower(){return this._luminance*Rp(this._size)}set luminousPower(e){this._luminance=e/Rp(this._size),this._light&&(this._light.luminance=this._luminance)}get luminance(){return this._luminance}set luminance(e){this._luminance=e,this._light&&(this._light.luminance=e)}get term(){return this._term}set term(e){this._term=e}get size(){return this._size}set size(e){this._size=e,this._light&&(this._light.size=e)}get range(){return this._range}set range(e){this._range=e,this._light&&(this._light.range=e)}constructor(){super(),Oo(this,"_size",ED,this),Oo(this,"_luminance",AD,this),Oo(this,"_term",CD,this),Oo(this,"_range",bD,this),this._type=bp.SPHERE,this._light=null,this._lightType=Rf}_createLight(){super._createLight(),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range)}}).prototype,"_size",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),AD=Po(TD.prototype,"_luminance",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Rp(.15)}}),CD=Po(TD.prototype,"_term",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QM.LUMINOUS_POWER}}),bD=Po(TD.prototype,"_range",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Po(TD.prototype,"luminousPower",[dD,mD],Object.getOwnPropertyDescriptor(TD.prototype,"luminousPower"),TD.prototype),Po(TD.prototype,"luminance",[pD,fD],Object.getOwnPropertyDescriptor(TD.prototype,"luminance"),TD.prototype),Po(TD.prototype,"term",[gD,vD],Object.getOwnPropertyDescriptor(TD.prototype,"term"),TD.prototype),Po(TD.prototype,"size",[yD],Object.getOwnPropertyDescriptor(TD.prototype,"size"),TD.prototype),Po(TD.prototype,"range",[xD],Object.getOwnPropertyDescriptor(TD.prototype,"range"),TD.prototype),SD=TD))||SD)||SD)||SD)||SD));var wD,ID,OD,PD,MD,DD,LD,BD,ND,FD,zD,UD,GD,HD,VD,kD,WD,jD,qD,XD;let YD=function(t){return e({SpotLight:t,SpotLightComponent:t}),t}((wD=Go("cc.SpotLight"),ID=ta(),OD=$o(),PD=_a(),MD=ra(),DD=_a(),LD=ra(),BD=va(QM),ND=ra(),FD=ra(),zD=ra(),UD=oa(),GD=ra(),wD(HD=ID(HD=OD(HD=Zo((kD=Po((VD=class extends eD{get luminousPower(){return this._luminance*Rp(this._size)}set luminousPower(e){this._luminance=e/Rp(this._size),this._light&&(this._light.luminance=this._luminance)}get luminance(){return this._luminance}set luminance(e){this._luminance=e,this._light&&(this._light.luminance=e)}get term(){return this._term}set term(e){this._term=e}get size(){return this._size}set size(e){this._size=e,this._light&&(this._light.size=e)}get range(){return this._range}set range(e){this._range=e,this._light&&(this._light.range=e)}get spotAngle(){return this._spotAngle}set spotAngle(e){this._spotAngle=e,this._light&&(this._light.spotAngle=Yt(e))}constructor(){super(),Oo(this,"_size",kD,this),Oo(this,"_luminance",WD,this),Oo(this,"_term",jD,this),Oo(this,"_range",qD,this),Oo(this,"_spotAngle",XD,this),this._type=bp.SPOT,this._light=null,this._lightType=Lf}_createLight(){super._createLight(),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle)}}).prototype,"_size",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),WD=Po(VD.prototype,"_luminance",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Rp(.15)}}),jD=Po(VD.prototype,"_term",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QM.LUMINOUS_POWER}}),qD=Po(VD.prototype,"_range",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),XD=Po(VD.prototype,"_spotAngle",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Po(VD.prototype,"luminousPower",[PD,MD],Object.getOwnPropertyDescriptor(VD.prototype,"luminousPower"),VD.prototype),Po(VD.prototype,"luminance",[DD,LD],Object.getOwnPropertyDescriptor(VD.prototype,"luminance"),VD.prototype),Po(VD.prototype,"term",[BD,ND],Object.getOwnPropertyDescriptor(VD.prototype,"term"),VD.prototype),Po(VD.prototype,"size",[FD],Object.getOwnPropertyDescriptor(VD.prototype,"size"),VD.prototype),Po(VD.prototype,"range",[zD],Object.getOwnPropertyDescriptor(VD.prototype,"range"),VD.prototype),Po(VD.prototype,"spotAngle",[ha,UD,GD],Object.getOwnPropertyDescriptor(VD.prototype,"spotAngle"),VD.prototype),HD=VD))||HD)||HD)||HD)||HD));var KD,ZD,$D,QD,JD;Gi(Mg.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),Ui(MM,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),Ui(MM.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),i.CameraComponent=MM,Be.setClassAlias(MM,"cc.CameraComponent"),i.LightComponent=eD,Be.setClassAlias(eD,"cc.LightComponent"),i.DirectionalLightComponent=lD,Be.setClassAlias(lD,"cc.DirectionalLightComponent"),i.SphereLightComponent=RD,Be.setClassAlias(RD,"cc.SphereLightComponent"),i.SpotLightComponent=YD,Be.setClassAlias(YD,"cc.SpotLightComponent"),i.ModelComponent=Mg,Be.setClassAlias(Mg,"cc.ModelComponent"),i.SkinningModelComponent=IO,Be.setClassAlias(IO,"cc.SkinningModelComponent"),i.SkinningModelUnit=cP,Be.setClassAlias(cP,"cc.SkinningModelUnit"),i.BatchedSkinningModelComponent=uP,Be.setClassAlias(uP,"cc.BatchedSkinningModelComponent"),i.utils=Kp;let eL=Go("cc.animation.UniformProxyFactory")(($D=Po((ZD=class{constructor(e,t){Oo(this,"passIndex",$D,this),Oo(this,"uniformName",QD,this),Oo(this,"channelIndex",JD,this),this.passIndex=t||0,this.uniformName=e||""}forTarget(e){const t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error(`Material "${e.name}" has no uniform "${this.uniformName}"`);const s=Qh.getPropertyTypeFromHandle(n);if(s===Ql.UBO){const i=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,Tn.FLOAT);if(!i)throw new Error(`Uniform "${this.uniformName} (in material ${e.name}) has no channel ${this.channelIndex}"`);return function(e,t){for(const i of e.shaderInfo.blocks)for(const e of i.members)if(e.name===t)return e.count>1;return!1}(t,this.uniformName)?{set:e=>{t.setUniformArray(i,e)}}:{set:e=>{t.setUniform(i,e)}}}if(s===Ql.SAMPLER){const e=Qh.getBindingFromHandle(n),s=t.properties[this.uniformName],r=s&&s.value?s.value+"-texture":ch(s.type);let o=Th.get(r);return o||(h(`Illegal texture default value: ${r}.`),o=Th.get("default-texture")),{set:n=>{n||(n=o);const s=n.getGFXTexture();s&&s.width&&s.height&&(t.bindTexture(e,s),n instanceof Lc&&t.bindSampler(e,xc.getSampler(i.game._gfxDevice,n.getSamplerHash())))}}}throw new Error(`Animations are not available for uniforms with property type ${s}.`)}}).prototype,"passIndex",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QD=Po(ZD.prototype,"uniformName",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),JD=Po(ZD.prototype,"channelIndex",[pa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),KD=ZD))||KD;var tL,iL,nL,sL;let rL=Go("cc.animation.MorphWeightsValueProxy")((nL=Po((iL=class{constructor(){Oo(this,"subMeshIndex",nL,this)}forTarget(e){return{set:t=>{e.setWeights(t,this.subMeshIndex)}}}}).prototype,"subMeshIndex",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tL=iL))||tL,oL=Go("cc.animation.MorphWeightsAllValueProxy")(sL=class{forTarget(e){return{set:t=>{var i,n;const s=null!==(i=null===(n=e.mesh)||void 0===n?void 0:n.struct.primitives.length)&&void 0!==i?i:0;for(let i=0;i<s;++i)e.setWeights(t,i)}}}})||sL;var aL,cL,lL,hL,uL;function _L(e,t,i,n){var s,r,o,a,c;let l=new t,h=new t,u=new t,_=Go(e)((o=Po((r=class{constructor(e,i,n){Oo(this,"dataPoint",o,this),Oo(this,"inTangent",a,this),Oo(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=i||new t,this.outTangent=n||new t}lerp(e,t,s){const r=this.dataPoint,o=e.dataPoint;h=i(h,this.inTangent,s),u=i(u,e.outTangent,s);const a=t*t*t,c=t*t,_=a-2*c+t,d=-2*a+3*c,m=a-c;return l=i(l,r,2*a-3*c+1),l=n(l,l,h,_),l=n(l,l,o,d),l=n(l,l,u,m),l}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),a=Po(r.prototype,"inTangent",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=Po(r.prototype,"outTangent",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=r))||s;if(t===Si){const e=_.prototype.lerp;_.prototype.lerp=function(t,i,n){const s=e.call(this,t,i,n);return Si.normalize(s,s),s}}return _}const dL=e("CubicSplineVec2Value",_L("cc.CubicSplineVec2Value",ci,ci.multiplyScalar,ci.scaleAndAdd));i.CubicSplineVec2Value=dL;const mL=e("CubicSplineVec3Value",_L("cc.CubicSplineVec3Value",_i,_i.multiplyScalar,_i.scaleAndAdd));i.CubicSplineVec3Value=mL;const pL=e("CubicSplineVec4Value",_L("cc.CubicSplineVec4Value",fi,fi.multiplyScalar,fi.scaleAndAdd));i.CubicSplineVec4Value=pL;const fL=e("CubicSplineQuatValue",_L("cc.CubicSplineQuatValue",Si,Si.multiplyScalar,Si.scaleAndAdd));i.CubicSplineQuatValue=fL;let gL=e("CubicSplineNumberValue",Go("cc.CubicSplineNumberValue")((lL=Po((cL=class{constructor(e,t,i){Oo(this,"dataPoint",lL,this),Oo(this,"inTangent",hL,this),Oo(this,"outTangent",uL,this),this.dataPoint=e,this.inTangent=t,this.outTangent=i}lerp(e,t,i){const n=this.dataPoint,s=e.dataPoint,r=t*t*t,o=t*t;return n*(2*r-3*o+1)+this.outTangent*i*(r-2*o+t)+s*(-2*r+3*o)+e.inTangent*i*(r-o)}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hL=Po(cL.prototype,"inTangent",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uL=Po(cL.prototype,"outTangent",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aL=cL))||aL);function vL(e){return e*e}function yL(e){return e*(2-e)}function xL(e){return e*e*e}function SL(e){return--e*e*e+1}function TL(e){return e*e*e*e}function EL(e){return 1- --e*e*e*e}function AL(e){return e*e*e*e*e}function CL(e){return--e*e*e*e*e+1}function bL(e){return 1-Math.cos(e*Math.PI/2)}function RL(e){return Math.sin(e*Math.PI/2)}function wL(e){return 0===e?0:Math.pow(1024,e-1)}function IL(e){return 1===e?1:1-Math.pow(2,-10*e)}function OL(e){return 1-Math.sqrt(1-e*e)}function PL(e){return Math.sqrt(1- --e*e)}function ML(e){let t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))}function DL(e){let t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)}function LL(e){const t=1.70158;return e*e*((t+1)*e-t)}function BL(e){const t=1.70158;return--e*e*((t+1)*e+t)+1}function NL(e){return 1-FL(1-e)}function FL(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}i.CubicSplineNumberValue=gL,e("animation",Object.freeze({__proto__:null,UniformProxyFactory:eL,MorphWeightsValueProxy:rL,MorphWeightsAllValueProxy:oL,isPropertyPath:Zd,isCustomPath:$d,HierarchyPath:Qd,ComponentPath:Jd,evaluatePath:em,CubicSplineVec2Value:dL,CubicSplineVec3Value:mL,CubicSplineVec4Value:pL,CubicSplineQuatValue:fL,CubicSplineNumberValue:gL}));const zL=YL(vL,yL),UL=YL(xL,SL),GL=YL(TL,EL),HL=YL(AL,CL),VL=YL(bL,RL),kL=YL(wL,IL),WL=YL(OL,PL),jL=YL(ML,DL),qL=YL(LL,BL),XL=YL(NL,FL);function YL(e,t){return i=>i<.5?t(2*i)/2:e(2*i-1)/2+.5}var KL=Object.freeze({__proto__:null,constant:function(){return 0},linear:function(e){return e},quadIn:vL,quadOut:yL,quadInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:xL,cubicOut:SL,cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quartIn:TL,quartOut:EL,quartInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quintIn:AL,quintOut:CL,quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sineIn:bL,sineOut:RL,sineInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},expoIn:wL,expoOut:IL,expoInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circIn:OL,circOut:PL,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:ML,elasticOut:DL,elasticInOut:function(e){let t,i=.1;const n=.4;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=n*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)*.5+1)},backIn:LL,backOut:BL,backInOut:function(e){const t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)},bounceIn:NL,bounceOut:FL,bounceInOut:function(e){return e<.5?.5*NL(2*e):.5*FL(2*e-1)+.5},smooth:function(e){return e<=0?0:e>=1?1:e*e*(3-2*e)},fade:function(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)},quadOutIn:zL,cubicOutIn:UL,quartOutIn:GL,quintOutIn:HL,sineOutIn:VL,expoOutIn:kL,circOutIn:WL,elasticOutIn:jL,backOutIn:qL,bounceOutIn:XL});e("easing",KL);function ZL(e,t){let i=0,n=e.length-1,s=n>>>1;for(;i<=n;s=i+n>>>1){const r=e[s];if(r>t+1e-6)n=s-1;else{if(!(r<t-1e-6))return s;i=s+1}}return~i}function $L(e,t,i,n,s){const r=1-s;return e*r*r*r+3*t*r*r*s+3*i*r*s*s+n*s*s*s}i.bezier=$L;const QL=Math.cos,JL=Math.acos,eB=Math.max,tB=2*Math.PI,iB=Math.sqrt;function nB(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function sB(e,t){const i=function(e,t){const i=t-0,n=t-e[0],s=3*i,r=3*n,o=3*(t-e[2]),a=1/(-i+r-o+(t-1)),c=(s-6*n+o)*a,l=c*(1/3),h=(-s+r)*a,u=1/3*(3*h-c*c),_=u*(1/3),d=(2*c*c*c-9*c*h+27*(i*a))/27,m=d/2,p=m*m+_*_*_;let f,g,v,y,x;if(p<0){const e=1/3*-u,t=iB(e*e*e),i=-d/(2*t),n=JL(i<-1?-1:i>1?1:i),s=2*nB(t);return v=s*QL(n*(1/3))-l,y=s*QL((n+tB)*(1/3))-l,x=s*QL((n+2*tB)*(1/3))-l,0<=v&&v<=1?0<=y&&y<=1?0<=x&&x<=1?eB(v,y,x):eB(v,y):0<=x&&x<=1?eB(v,x):v:0<=y&&y<=1?0<=x&&x<=1?eB(y,x):y:x}if(0===p)return f=m<0?nB(-m):-nB(m),v=2*f-l,y=-f-l,0<=v&&v<=1?0<=y&&y<=1?eB(v,y):v:y;{const e=iB(p);return f=nB(-m+e),g=nB(m+e),v=f-g-l,v}}(e,t),n=1-i;return 0*n*n*n+3*e[1]*i*n*n+3*e[3]*i*i*n+1*i*i*i}i.bezierByTime=sB;class rB{constructor(e){let t,i;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;let n=!0;for(let s=1,r=e.length;s<r;s++)if(t=e[s]-e[s-1],1===s)i=t;else if(Math.abs(t-i)>1e-6){n=!1;break}this._findRatio=n?lB:ZL}sample(e){return this._findRatio(this.ratios,e)}}e("RatioSampler",rB),i.RatioSampler=rB;class oB{static Bezier(e){return e}constructor(e,t){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=t,this._values=e.values;const i=e=>"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?oB.Linear:oB.Bezier(e):oB.Linear;if(void 0!==e.easingMethod)this.type=i(e.easingMethod);else if(Array.isArray(e.easingMethods))this.types=e.easingMethods.map(i);else if(void 0!==e.easingMethods){this.types=new Array(this._values.length).fill(null);for(const t of Object.keys(e.easingMethods))this.types[t]=i(e.easingMethods[t])}else this.type=null;const n=e.values[0];(void 0===e.interpolate||e.interpolate)&&(this._lerp=hB(n)),void 0!==e._arrayLength&&(this._array=new Array(e._arrayLength))}hasLerp(){return!!this._lerp}valueAt(e){if(void 0===this._array){const t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(let t=0;t<this._array.length;++t)this._array[t]=this._values[this._array.length*e+t];return this._array}valueBetween(e,t,i,n,s){if(this._lerp){const r=this.types?this.types[t]:this.type,o=s-i;let a=(e-i)/o;if(r&&(a=cB(a,r)),void 0===this._array){const e=this._values[t],i=this._values[n];return this._lerp(e,i,a,o*this._duration)}for(let e=0;e<this._array.length;++e){const i=this._values[this._array.length*t+e],s=this._values[this._array.length*n+e];this._array[e]=this._lerp(i,s,a,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(let e=0;e<this._array.length;++e)this._array[e]=this._values[this._array.length*t+e];return this._array}empty(){return 0===this._values.length}constant(){return 1===this._values.length}}e("AnimCurve",oB),oB.Linear=null,i.AnimCurve=oB;function aB(e,t,i){let n=t.sample(i);if(n<0)if(n=~n,n<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function cB(e,t){if("string"==typeof t){const i=KL[t];i?e=i(e):S(3906,t)}else Array.isArray(t)&&(e=sB(t,e));return e}function lB(e,t){const i=e.length-1;if(0===i)return 0;const n=e[0];if(t<n)return 0;const s=e[i];if(t>s)return i;const r=(t=(t-n)/(s-n))/(1/i),o=0|r;return r-o<1e-6?o:o+1-r<1e-6?o+1:~(o+1)}e("EventInfo",class{constructor(){this.events=[]}add(e,t){this.events.push({func:e||"",params:t||[]})}}),i.sampleAnimationCurve=aB;const hB=(()=>{function e(e,t,i,n){return e.lerp(t,i,n)}return t=>{if(null!==t){if("number"==typeof t)return Xt;if("object"==typeof t&&t.constructor){if(t instanceof Si)return function(){const e=new Si;return(t,i,n,s)=>Si.slerp(e,t,i,n)}();if(t instanceof Qe)return function(e){const t=new e;return(i,n,s)=>(e.lerp(t,i,n,s),t)}(t.constructor);if(t.constructor===Number)return Xt;if("function"==typeof t.lerp)return e}}}})();var uB,_B,dB,mB,pB,fB,gB,vB,yB,xB,SB,TB,EB,AB;let CB=e("AnimationClip",Go("cc.AnimationClip")((AB=EB=class e extends sc{constructor(...e){super(...e),Oo(this,"sample",dB,this),Oo(this,"speed",mB,this),Oo(this,"wrapMode",pB,this),Oo(this,"events",fB,this),Oo(this,"_duration",gB,this),Oo(this,"_keys",vB,this),Oo(this,"_stepness",yB,this),Oo(this,"_curves",xB,this),Oo(this,"_commonTargets",SB,this),Oo(this,"_hash",TB,this),this.frameRate=0,this._ratioSamplers=[],this._runtimeCurves=void 0,this._runtimeEvents=void 0,this._data=null}static createWithSpriteFrames(t,i){if(!Array.isArray(t))return S(3905),null;const n=new e;n.sample=i||n.sample,n.duration=t.length/n.sample;const s=1/n.sample,r=new Array(t.length),o=new Array(r.length);for(let e=0;e<t.length;e++)r[e]=e*s,o[e]=t[e];return n.keys=[r],n.curves=[{modifiers:[new Jd("cc.Sprite"),"spriteFrame"],data:{keys:0,values:o}}],n}get duration(){return this._duration}set duration(e){this._duration=e}get keys(){return this._keys}set keys(e){this._keys=e}get eventGroups(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}get stepness(){return this._stepness}set stepness(e){this._stepness=e,this._applyStepness()}get hash(){if(this._hash)return this._hash;const e=this._nativeAsset,t=new Uint8Array(ArrayBuffer.isView(e)?e.buffer:e);return this._hash=Os(t,666)}get curves(){return this._curves}set curves(e){this._curves=e,delete this._runtimeCurves}get data(){return this._data}get commonTargets(){return this._commonTargets}set commonTargets(e){this._commonTargets=e}onLoaded(){this.frameRate=this.sample,this._decodeCVTAs()}getPropertyCurves(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}updateEventDatas(){delete this._runtimeEvents}getEventGroupIndexAtRatio(e){this._runtimeEvents||this._createRuntimeEvents();return function(e,t){let i=0;for(let n=e.length-1,s=n>>>1;i<=n;s=i+n>>>1){const r=e[s];if(r>t+1e-6)n=s-1;else{if(!(r<t-1e-6))return s;i=s+1}}return~i}(this._runtimeEvents.ratios,e)}hasEvents(){return 0!==this.events.length}destroy(){return i.director.root.dataPoolManager.releaseAnimationClip(this),tm.destroy(this),super.destroy()}_createPropertyCurves(){this._ratioSamplers=this._keys.map(e=>new rB(e.map(e=>e/this._duration))),this._runtimeCurves=this._curves.map(e=>({curve:new oB(e.data,this._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:this._ratioSamplers[e.data.keys],commonTarget:e.commonTarget})),this._applyStepness()}_createRuntimeEvents(){const e=[],t=[],i=this.events.sort((e,t)=>e.frame-t.frame);for(const n of i){const i=n.frame/this._duration;let s=e.findIndex(e=>e===i);s<0&&(s=e.length,e.push(i),t.push({events:[]})),t[s].events.push({functionName:n.func,parameters:n.params})}this._runtimeEvents={ratios:e,eventGroups:t}}_applyStepness(){this._runtimeCurves}_decodeCVTAs(){const e=ArrayBuffer.isView(this._nativeAsset)?this._nativeAsset.buffer:this._nativeAsset;if(!e)return;const t=this._keys;for(let i=0;i<t.length;++i){const n=t[i];n instanceof gv&&(t[i]=n.decompress(e))}for(let t=0;t<this._curves.length;++t){const i=this._curves[t];i.data.values instanceof gv&&(i.data.values=i.data.values.decompress(e))}}},EB.preventDeferredLoadDependents=!0,EB.WrapMode=ro,dB=Po((_B=AB).prototype,"sample",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),mB=Po(_B.prototype,"speed",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pB=Po(_B.prototype,"wrapMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ro.Normal}}),fB=Po(_B.prototype,"events",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gB=Po(_B.prototype,"_duration",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vB=Po(_B.prototype,"_keys",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yB=Po(_B.prototype,"_stepness",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xB=Po(_B.prototype,"_curves",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SB=Po(_B.prototype,"_commonTargets",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TB=Po(_B.prototype,"_hash",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uB=_B))||uB);function bB(e,t,i){let n;const s=t[t.length-1];if(0!==t.length&&Zd(s)&&!i){const i=em(e,...t.slice(0,t.length-1));if(null===i)return null;n={isProxy:!1,object:i,property:s}}else{if(!i)return u("Empty animation curve."),null;{const s=em(e,...t);if(null===s)return null;n={isProxy:!0,proxy:i.forTarget(s)}}}return{setValue:e=>{n.isProxy?n.proxy.set(e):n.object[n.property]=e},getValue:()=>n.isProxy?n.proxy.get?n.proxy.get():(u("Target doesn't provide a get method."),null):n.object[n.property]}}function RB(e,t,i){const n=bB(e,t,i);if(null===n)return null;const s=n.getValue(),r=wB(s);if(!r)return u("Value is not copyable!"),null;const o=r.createBuffer(),a=r.copy;return Object.assign(n,{peek:()=>o,pull:()=>{const e=n.getValue();a(o,e)},push:()=>{n.setValue(o)}})}i.AnimationClip=CB;const wB=(()=>{const e=new Map;return e.set(ci,{createBuffer:()=>new ci,copy:ci.copy}),e.set(_i,{createBuffer:()=>new _i,copy:_i.copy}),e.set(fi,{createBuffer:()=>new fi,copy:fi.copy}),e.set(Fi,{createBuffer:()=>new Fi,copy:Fi.copy}),t=>e.get(null==t?void 0:t.constructor)})();class IB{constructor(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get isMotionless(){return!this.isPlaying||this.isPaused}play(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(C(3912)):(this._isPlaying=!0,this.onPlay())}stop(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}pause(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}resume(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}step(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}update(e){}onPlay(){}onPause(){}onResume(){}onStop(){}onError(e){}}class OB{constructor(){this._nodeBlendStates=new Map,this._states=new Set}ref(e,t){let i=this._nodeBlendStates.get(e);i||(i={dirty:!1,properties:{}},this._nodeBlendStates.set(e,i));let n=i.properties[t];return n||(n=i.properties[t]=new MB(i,PB(t)?new _i:new Si)),++n.refCount,n}deRef(e,t){const i=this._nodeBlendStates.get(e);if(!i)return;const n=i.properties[t];n&&(--n.refCount,n.refCount>0||(delete i.properties[t],function(e){return!(e.properties.position||e.properties.rotation||e.properties.eulerAngles||e.properties.scale)}(i)&&this._nodeBlendStates.delete(e)))}apply(){this._nodeBlendStates.forEach((e,t)=>{if(!e.dirty)return;e.dirty=!1;const{position:i,scale:n,rotation:s,eulerAngles:r}=e.properties;let o,a,c,l=!1;i&&0!==i.weight&&(i.weight=0,o=i.value,l=!0),n&&0!==n.weight&&(n.weight=0,a=n.value,l=!0),s&&0!==s.weight&&(s.weight=0,c=s.value,l=!0),r&&0!==r.weight&&(r.weight=0,c=r.value,l=!0),l&&t.setRTS(c,o,a)}),this._states.forEach(e=>{e.onBlendFinished()})}bindState(e){this._states.add(e)}unbindState(e){this._states.delete(e)}}function PB(e){return!function(e){return"rotation"===e}(e)}class MB{constructor(e,t){this.weight=0,this.value=void 0,this.refCount=0,this._node=void 0,this._node=e,this.value=t}markAsDirty(){this._node.dirty=!0}}function DB(e,t,i){return 0===i.weight&&_i.zero(i.value),0===t?i.value:1===t?_i.copy(i.value,e):_i.scaleAndAdd(i.value,i.value,e,t)}function LB(e,t,i){if(0===i.weight&&Si.identity(i.value),0===t)return i.value;if(1===t)return Si.copy(i.value,e);const n=t/(i.weight+t);return Si.slerp(i.value,i.value,e,n)}let BB;!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(BB||(BB={})),$e(BB);class NB{constructor(e,t,i){this.commonTargetIndex=void 0,this._curve=void 0,this._boundTarget=void 0,this._rootTargetProperty=void 0,this._curveDetail=void 0,this._curve=e.curve,this._curveDetail=e,this._boundTarget=i}applySample(e,t,i,n,s){if(this._curve.empty())return;let r;r=this._curve.hasLerp()&&i?this._curve.valueBetween(e,n.from,n.fromRatio,n.to,n.toRatio):this._curve.valueAt(t),this._setValue(r,s)}_setValue(e,t){this._boundTarget.setValue(e)}get propertyName(){return this._rootTargetProperty||""}get curveDetail(){return this._curveDetail}}class FB extends IB{get clip(){return this._clip}get name(){return this._name}get length(){return this.duration}get wrapMode(){return this._wrapMode}set wrapMode(e){this._wrapMode=e,this.time=0,e&so.Loop?this.repeatCount=1/0:this.repeatCount=1}get repeatCount(){return this._repeatCount}set repeatCount(e){this._repeatCount=e;const t=this._wrapMode&so.ShouldWrap,i=(this.wrapMode&so.Reverse)===so.Reverse;this._process=e!==1/0||t||i?this.process:this.simpleProcess}get delay(){return this._delay}set delay(e){this._delayTime=this._delay=e}constructor(e,t=""){super(),this.duration=1,this.speed=1,this.time=0,this.weight=0,this.frameRate=0,this._wrapMode=ro.Normal,this._repeatCount=1,this._currentFramePlayed=!1,this._delay=0,this._delayTime=0,this._wrappedInfo=new oo,this._lastWrapInfo=null,this._lastWrapInfoEvent=null,this._process=this.process,this._target=null,this._targetNode=null,this._clip=void 0,this._name=void 0,this._lastIterations=void 0,this._samplerSharedGroups=[],this._commonTargetStatuses=[],this._curveLoaded=!1,this._ignoreIndex=-1,this._blendStateBuffer=null,this._blendStateWriters=[],this._allowLastFrame=!1,this._blendStateWriterHost={weight:0,enabled:!1},this._clip=e,this._name=t||e&&e.name}get curveLoaded(){return this._curveLoaded}initialize(e,t){var n,s;if(this._curveLoaded)return;this._curveLoaded=!0,this._destroyBlendStateWriters(),this._samplerSharedGroups.length=0,this._blendStateBuffer=null!==(n=null===(s=i.director.getAnimationManager())||void 0===s?void 0:s.blendState)&&void 0!==n?n:null,this._blendStateBuffer&&this._blendStateBuffer.bindState(this),this._targetNode=e;const r=this._clip;this.duration=r.duration,this.speed=r.speed,this.wrapMode=r.wrapMode,this.frameRate=r.sample,(this.wrapMode&so.Loop)===so.Loop?this.repeatCount=1/0:this.repeatCount=1;const o=(e,t,i,n,s)=>{if(!function(e){let t;if(1===e.length&&"string"==typeof e[0])t=e[0];else if(e.length>1){for(let t=0;t<e.length-1;++t)if(!(e[t]instanceof Qd))return!1;t=e[e.length-1]}switch(t){case"position":case"scale":case"rotation":case"eulerAngles":return!0;default:return!1}}(i)||!this._blendStateBuffer)return e(t,i,n);{const n=em(t,...i.slice(0,i.length-1));if(null!==n&&n instanceof kd){const r=i[i.length-1],o=function(e,t,i,n,s){const r=PB(i)?DB:LB;let o=e.ref(t,i),a=!1,c=-1;return{destroy(){o&&(e.deRef(t,i),o=null)},forTarget:()=>({get:()=>t[i],set:e=>{if(!o||!n.enabled)return;const t=n.weight;if(s)if(1!==t||t!==c)a=!1;else if(a)return;r(e,t,o),o.weight+=t,o.markAsDirty(),a=!0,c=t}})}}(this._blendStateBuffer,n,r,this._blendStateWriterHost,s);return this._blendStateWriters.push(o),e(t,[],o)}}return null};this._commonTargetStatuses=r.commonTargets.map((t,i)=>{const n=o(RB,e,t.modifiers,t.valueAdapter,!1);return null===n?null:{target:n,changed:!1}}),t||(t=r.getPropertyCurves());for(let i=0;i<t.length;++i){const n=t[i];let s,r=this._samplerSharedGroups.find(e=>e.sampler===n.sampler);if(r||(r={sampler:n.sampler,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}},this._samplerSharedGroups.push(r)),void 0===n.commonTarget)s=e;else{const e=this._commonTargetStatuses[n.commonTarget];if(!e)continue;s=e.target.peek()}const a=o(bB,s,n.modifiers,n.valueAdapter,n.curve.constant());if(null===a);else{const e=new NB(n,s,a);e.commonTargetIndex=n.commonTarget,r.curves.push(e)}}}destroy(){this._destroyBlendStateWriters()}onBlendFinished(){this._blendStateWriterHost.enabled=!1}emit(...e){i.director.getAnimationManager().pushDelayEvent(this._emit,this,e)}on(e,t,i){return this._target&&this._target.isValid?this._target.on(e,t,i):null}once(e,t,i){return this._target&&this._target.isValid?this._target.once(e,t,i):null}off(e,t,i){this._target&&this._target.isValid&&this._target.off(e,t,i)}allowLastFrameEvent(e){this._allowLastFrame=e}_setEventTarget(e){this._target=e}setTime(e){this._currentFramePlayed=!1,this.time=e||0;{this._lastWrapInfoEvent=null,this._ignoreIndex=-1;const t=this.getWrappedInfo(e,this._wrappedInfo),i=t.direction;let n=this._clip.getEventGroupIndexAtRatio(t.ratio);n<0&&(n=~n-1,i<0&&(n+=1),this._ignoreIndex=n)}}update(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}_needReverse(e){const t=this.wrapMode;let i=!1;if((t&so.PingPong)===so.PingPong){e-(0|e)==0&&e>0&&(e-=1);1&e&&(i=!i)}return(t&so.Reverse)===so.Reverse&&(i=!i),i}getWrappedInfo(e,t){t=t||new oo;let i=!1;const n=this.duration,s=this.repeatCount;let r=e>0?e/n:-e/n;if(r>=s){r=s,i=!0;let t=s-(0|s);0===t&&(t=1),e=t*n*(e>0?1:-1)}if(e>n){const t=e%n;e=0===t?n:t}else e<0&&0!==(e%=n)&&(e+=n);let o=!1;const a=this._wrapMode&so.ShouldWrap;a&&(o=this._needReverse(r));let c=o?-1:1;return this.speed<0&&(c*=-1),a&&o&&(e=n-e),t.ratio=e/n,t.time=e,t.direction=c,t.stopped=i,t.iterations=r,t}sample(){const e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e}process(){const e=this.sample();if(this._allowLastFrame){let t;t=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new oo(e),this.repeatCount>1&&(0|e.iterations)>(0|t.iterations)&&this.emit(BB.LASTFRAME,this),t.set(e)}e.stopped&&(this.stop(),this.emit(BB.FINISHED,this))}simpleProcess(){const e=this.duration;let t=this.time%e;t<0&&(t+=e);const i=t/e;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(void 0===this._lastIterations&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(BB.LASTFRAME,this),this._lastIterations=i)}cache(e){}onPlay(){this.setTime(0),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(BB.PLAY,this)}onStop(){this.isPaused||this._onPauseOrStop(),this.emit(BB.STOP,this)}onResume(){this._onReplayOrResume(),this.emit(BB.RESUME,this)}onPause(){this._onPauseOrStop(),this.emit(BB.PAUSE,this)}_sampleCurves(e){this._blendStateWriterHost.weight=this.weight,this._blendStateWriterHost.enabled=!0;for(let e=0;e<this._commonTargetStatuses.length;++e){const t=this._commonTargetStatuses[e];t&&(t.target.pull(),t.changed=!1)}for(let t=0,i=this._samplerSharedGroups.length;t<i;++t){const i=this._samplerSharedGroups[t],n=i.sampler,{samplerResultCache:s}=i;let r=0,o=!1;n?(r=n.sample(e),r<0&&(r=~r,r<=0?r=0:r>=n.ratios.length?r=n.ratios.length-1:(o=!0,s.from=r-1,s.fromRatio=n.ratios[s.from],s.to=r,s.toRatio=n.ratios[s.to],r=s.from))):r=0;for(let t=0,n=i.curves.length;t<n;++t){const n=i.curves[t];if(n.applySample(e,r,o,s,this.weight),void 0!==n.commonTargetIndex){const e=this._commonTargetStatuses[n.commonTargetIndex];e&&(e.changed=!0)}}}for(let e=0;e<this._commonTargetStatuses.length;++e){const t=this._commonTargetStatuses[e];t&&(t.changed&&t.target.push())}}_sampleEvents(e){const t=this._clip.eventGroups.length;let n=e.direction,s=this._clip.getEventGroupIndexAtRatio(e.ratio);if(s<0&&(s=~s-1,n<0&&(s+=1)),this._ignoreIndex!==s&&(this._ignoreIndex=-1),e.frameIndex=s,!this._lastWrapInfoEvent)return this._fireEvent(s),void(this._lastWrapInfoEvent=new oo(e));const r=this.wrapMode,o=zB(e.iterations),a=this._lastWrapInfoEvent;let c=zB(a.iterations),l=a.frameIndex;const h=a.direction,u=-1!==c&&o!==c;if(l===s&&u&&1===t)this._fireEvent(0);else if(l!==s||u){n=h;do{if(l!==s){if(-1===n&&0===l&&s>0?((r&so.PingPong)===so.PingPong?n*=-1:l=t,c++):1===n&&l===t-1&&s<t-1&&((r&so.PingPong)===so.PingPong?n*=-1:l=-1,c++),l===s)break;if(c>o)break}l+=n,i.director.getAnimationManager().pushDelayEvent(this._fireEvent,this,[l])}while(l!==s&&l>-1&&l<t)}this._lastWrapInfoEvent.set(e)}_emit(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}_fireEvent(e){if(!this._targetNode||!this._targetNode.isValid)return;const{eventGroups:t}=this._clip;if(e<0||e>=t.length||this._ignoreIndex===e)return;const i=t[e],n=this._targetNode.components;for(const e of i.events){const{functionName:t}=e;for(const i of n){const n=i[t];"function"==typeof n&&n.apply(i,e.parameters)}}}_onReplayOrResume(){i.director.getAnimationManager().addAnimation(this)}_onPauseOrStop(){i.director.getAnimationManager().removeAnimation(this)}_destroyBlendStateWriters(){for(let e=0;e<this._blendStateWriters.length;++e)this._blendStateWriters[e].destroy();this._blendStateWriters.length=0,this._blendStateBuffer&&(this._blendStateBuffer.unbindState(this),this._blendStateBuffer=null),this._blendStateWriterHost.enabled=!1}}function zB(e){return e-(0|e)==0&&(e-=1),0|e}e("AnimationState",FB),i.AnimationState=FB;class UB extends IB{constructor(){super(),this._managedStates=[],this._fadings=[]}update(e){if(this.isMotionless)return;for(let e=0;e<this._managedStates.length;++e){const t=this._managedStates[e].state;t&&(t.weight=0)}let t=1,i=this._fadings.length;for(let n=0;n<this._fadings.length;++n){const s=this._fadings[n];s.easeTime+=e;const r=0===s.easeDuration?1:qt(s.easeTime/s.easeDuration),o=r*t;if(t*=1-r,s.target.state&&(s.target.state.weight+=o),s.easeTime>=s.easeDuration){i=n+1,s.easeTime=s.easeDuration;break}}if(i!==this._fadings.length){for(let e=i;e<this._fadings.length;++e){const t=this._fadings[e];--t.target.reference,t.target.reference<=0&&(t.target.state&&t.target.state.stop(),Z(this._managedStates,t.target))}this._fadings.splice(i)}for(let e=0;e<this._managedStates.length;++e){const t=this._managedStates[e].state;t&&t.isMotionless&&t.sample()}}crossFade(e,t){var i;0===this._managedStates.length&&(t=0),0===t&&this.clear();let n=this._managedStates.find(t=>t.state===e);n?(null===(i=n.state)||void 0===i?void 0:i.isMotionless)&&n.state.play():(n={state:e,reference:0},e&&e.play(),this._managedStates.push(n)),++n.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:n})}clear(){for(let e=0;e<this._managedStates.length;++e){const t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}onPlay(){super.onPlay(),i.director.getAnimationManager().addCrossFade(this)}onPause(){super.onPause(),i.director.getAnimationManager().removeCrossFade(this);for(let e=0;e<this._managedStates.length;++e){const t=this._managedStates[e].state;t&&t.pause()}}onResume(){super.onResume(),i.director.getAnimationManager().addCrossFade(this);for(let e=0;e<this._managedStates.length;++e){const t=this._managedStates[e].state;t&&t.resume()}}onStop(){super.onStop(),i.director.getAnimationManager().removeCrossFade(this),this.clear()}}var GB,HB,VB,kB,WB,jB,qB,XB,YB,KB,ZB,$B,QB,JB,eN,tN,iN;let nN=function(t){return e({AnimationComponent:t,Animation:t}),t}((GB=Go("cc.Animation"),HB=ta(),VB=Vo(99),kB=$o(),WB=va([CB]),jB=ra(),qB=va(CB),XB=ra(),YB=ra(),KB=va([CB]),GB(ZB=HB(ZB=VB(ZB=Zo(ZB=kB((iN=tN=class extends(Ka(f_)){constructor(...e){super(...e),Oo(this,"playOnLoad",QB,this),this._crossFade=new UB,this._nameToState=ce(!0),Oo(this,"_clips",JB,this),Oo(this,"_defaultClip",eN,this),this._hasBeenPlayed=!1}get clips(){return this._clips}set clips(e){this._crossFade&&this._crossFade.clear();for(const e of this._clips)e&&this._removeStateOfAutomaticClip(e);for(const t of e)t&&this.createState(t);const t=e.find(e=>sN(e,this._defaultClip));this._defaultClip=t||null,this._clips=e}get defaultClip(){return this._defaultClip}set defaultClip(e){if(this._defaultClip=e,!e)return;this._clips.findIndex(t=>sN(t,e))>=0||(this._clips.push(e),this.createState(e))}onLoad(){this.clips=this._clips;for(const e in this._nameToState){this._nameToState[e].initialize(this.node)}}start(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}onEnable(){this._crossFade.resume()}onDisable(){this._crossFade.pause()}onDestroy(){this._crossFade.stop();for(const e in this._nameToState){this._nameToState[e].destroy()}this._nameToState=ce(!0)}play(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}crossFade(e,t=.3){this._hasBeenPlayed=!0;const i=this._nameToState[e];i&&(this._crossFade.play(),this._crossFade.crossFade(i,t))}pause(){this._crossFade.pause()}resume(){this._crossFade.resume()}stop(){this._crossFade.stop()}getAnimationState(e){return this.getState(e)}getState(e){const t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}createState(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}removeState(e){const t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])}addClip(e,t){return $(this._clips,e)||this._clips.push(e),this.createState(e,t)}removeClip(e,t){let i;for(const t in this._nameToState){const n=this._nameToState[t];if(n.clip===e){i=n;break}}if(e===this._defaultClip){if(!t)return void y(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!t)return void y(3903);i.stop()}this._clips=this._clips.filter(t=>t!==e),i&&delete this._nameToState[i.name]}on(e,t,i,n){const s=super.on(e,t,i,n);return e===BB.LASTFRAME&&this._syncAllowLastFrameEvent(),s}once(e,t,i){const n=super.once(e,t,i);return e===BB.LASTFRAME&&this._syncAllowLastFrameEvent(),n}off(e,t,i){super.off(e,t,i),e===BB.LASTFRAME&&this._syncDisallowLastFrameEvent()}_createState(e,t){return new FB(e,t)}_doCreateState(e,t){const i=this._createState(e,t);return i._setEventTarget(this),i.allowLastFrameEvent(this.hasEventListener(BB.LASTFRAME)),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i}_getStateByNameOrDefaultClip(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}const t=this._nameToState[e];return t||null}_removeStateOfAutomaticClip(e){for(const t in this._nameToState){const i=this._nameToState[t];sN(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}_syncAllowLastFrameEvent(){if(this.hasEventListener(BB.LASTFRAME))for(const e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)}_syncDisallowLastFrameEvent(){if(!this.hasEventListener(BB.LASTFRAME))for(const e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)}},tN.EventType=BB,Po(($B=iN).prototype,"clips",[WB,jB],Object.getOwnPropertyDescriptor($B.prototype,"clips"),$B.prototype),Po($B.prototype,"defaultClip",[qB,XB],Object.getOwnPropertyDescriptor($B.prototype,"defaultClip"),$B.prototype),QB=Po($B.prototype,"playOnLoad",[Xo,YB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JB=Po($B.prototype,"_clips",[KB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eN=Po($B.prototype,"_defaultClip",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZB=$B))||ZB)||ZB)||ZB)||ZB)||ZB));function sN(e,t){return e===t||!(!e||!t||e.name!==t.name&&e._uuid!==t._uuid)}const rN=new wi,oN=new wi,aN=[];class cN extends FB{constructor(e,t=""){super(e,t),this._frames=1,this._bakedDuration=0,this._animInfo=null,this._sockets=[],this._animInfoMgr=void 0,this._comps=[],this._parent=null,this._curvesInited=!1,this._animInfoMgr=i.director.root.dataPoolManager.jointAnimationInfo}initialize(e){if(this._curveLoaded)return;this._comps.length=0;const t=e.getComponentsInChildren(IO);for(let i=0;i<t.length;++i){const n=t[i];n.skinningRoot===e&&this._comps.push(n)}this._parent=e.getComponent("cc.SkeletalAnimation");const i=this._parent.useBakedAnimation;super.initialize(e,i?aN:void 0),this._curvesInited=!i;const n=tm.getOrExtract(this.clip).info;this._frames=n.frames-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/n.sample}onPlay(){super.onPlay();if(this._parent.useBakedAnimation){this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this._clip);for(let e=0;e<this._comps.length;++e)this._comps[e].uploadAnimation(this.clip)}else this._sampleCurves=super._sampleCurves,this.duration=this._clip.duration,this._curvesInited||(this._curveLoaded=!1,super.initialize(this._targetNode),this._curvesInited=!0)}rebuildSocketCurves(e){if(this._sockets.length=0,!this._targetNode)return null;const t=this._targetNode;for(let i=0;i<e.length;++i){const n=e[i],s=t.getChildByPath(n.path);if(!n.target)continue;const r=tm.getOrExtract(this.clip);let o,a=n.path,c=r.data[a],l=s;for(;!c;){const e=a.lastIndexOf("/");if(a=a.substring(0,e),c=r.data[a],l&&(o||(o=wi.identity(oN)),wi.fromRTS(rN,l.rotation,l.position,l.scale),wi.multiply(o,rN,o),l=l.parent),e<0)break}const h=c&&c.worldMatrix.values,u=r.info.frames,_=[];for(let e=0;e<u;e++){let t;t=h&&o?wi.multiply(rN,h[e],o):h?h[e]:o||wi.IDENTITY;const i={pos:new _i,rot:new Si,scale:new _i};wi.toRTS(t,i.rot,i.pos,i.scale),_.push(i)}this._sockets.push({target:n.target,frames:_})}}_sampleCurvesBaked(e){const t=this._animInfo,i=e*this._frames+.5|0;if(i!==t.data[0]){t.data[0]=i,t.dirty=!0;for(let e=0;e<this._sockets.length;++e){const{target:t,frames:n}=this._sockets[e],{pos:s,rot:r,scale:o}=n[i];t.setRTS(r,s,o)}}}}var lN,hN,uN,_N,dN,mN,pN,fN,gN,vN,yN,xN,SN,TN,EN,AN,CN,bN,RN,wN;e("SkeletalAnimationState",cN);let IN=e("Socket",(lN=Go("cc.SkeletalAnimation.Socket"),hN=va(kd),lN((dN=Po((_N=class{constructor(e="",t=null){Oo(this,"path",dN,this),Oo(this,"target",mN,this),this.path=e,this.target=t}}).prototype,"path",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mN=Po(_N.prototype,"target",[hN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uN=_N))||uN));Be.setClassAlias(IN,"cc.SkeletalAnimationComponent.Socket");const ON=new wi,PN=new wi;function MN(e,t="",i=[]){for(let n=0;n<e.children.length;n++){const s=e.children[n];if(!s)continue;const r=t?`${t}/${s.name}`:s.name;i.push(r),MN(s,r,i)}return i}let DN=function(t){return e({SkeletalAnimationComponent:t,SkeletalAnimation:t}),t}((pN=Go("cc.SkeletalAnimation"),fN=ta(),gN=Vo(99),vN=$o(),yN=va([IN]),xN=ra(),SN=ra(),TN=va([IN]),pN(EN=fN(EN=gN(EN=Zo(EN=vN((wN=RN=class extends nN{constructor(...e){super(...e),Oo(this,"_useBakedAnimation",CN,this),Oo(this,"_sockets",bN,this)}get sockets(){return this._sockets}set sockets(e){if(!this._useBakedAnimation){const t=i.director.getAnimationManager();t.removeSockets(this.node,this._sockets),t.addSockets(this.node,e)}this._sockets=e,this.rebuildSocketAnimations()}get useBakedAnimation(){return this._useBakedAnimation}set useBakedAnimation(e){this._useBakedAnimation=e;const t=this.node.getComponentsInChildren(IO);for(let e=0;e<t.length;++e){const i=t[e];i.skinningRoot===this.node&&i.setUseBakedAnimation(this._useBakedAnimation)}this._useBakedAnimation?i.director.getAnimationManager().removeSockets(this.node,this._sockets):i.director.getAnimationManager().addSockets(this.node,this._sockets)}onDestroy(){super.onDestroy(),i.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),i.director.getAnimationManager().removeSockets(this.node,this._sockets)}start(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,super.start()}querySockets(){const e=this._defaultClip&&Object.keys(tm.getOrExtract(this._defaultClip).data).sort().reduce((e,t)=>(t.startsWith(e[e.length-1])||e.push(t),e),[])||[];if(!e.length)return["please specify a valid default animation clip first"];const t=[];for(let i=0;i<e.length;i++){const n=e[i],s=this.node.getChildByPath(n);s&&(t.push(n),MN(s,n,t))}return t}rebuildSocketAnimations(){for(const e of this._sockets){const t=this.node.getChildByPath(e.path),i=e.target;t&&i&&(i.name=e.path.substring(e.path.lastIndexOf("/")+1)+" Socket",i.parent=this.node,rm(t,this.node,ON),wi.fromRTS(PN,i.rotation,i.position,i.scale),wi.equals(PN,ON)||(i.matrix=ON))}for(const e of Object.keys(this._nameToState)){this._nameToState[e].rebuildSocketCurves(this._sockets)}}createSocket(e){const t=this._sockets.find(t=>t.path===e);if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;const i=new kd;return i.parent=this.node,this._sockets.push(new IN(e,i)),this.rebuildSocketAnimations(),i}_createState(e,t){return new cN(e,t)}_doCreateState(e,t){const i=super._doCreateState(e,t);return i.rebuildSocketCurves(this._sockets),i}},RN.Socket=IN,Po((AN=wN).prototype,"sockets",[yN,xN],Object.getOwnPropertyDescriptor(AN.prototype,"sockets"),AN.prototype),Po(AN.prototype,"useBakedAnimation",[SN],Object.getOwnPropertyDescriptor(AN.prototype,"useBakedAnimation"),AN.prototype),CN=Po(AN.prototype,"_useBakedAnimation",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bN=Po(AN.prototype,"_sockets",[TN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EN=AN))||EN)||EN)||EN)||EN)||EN));var LN,BN,NN;Ui(nN.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(...e){let t=e[0];return nN.prototype.removeState.call(this,t.name)}}]),i.AnimationComponent=nN,Be.setClassAlias(nN,"cc.AnimationComponent"),i.SkeletalAnimationComponent=DN,Be.setClassAlias(DN,"cc.SkeletalAnimationComponent");let FN=e("AnimationManager",Go((NN=BN=class extends zI{constructor(...e){super(...e),this._anims=new Y([]),this._delayEvents=[],this._blendStateBuffer=new OB,this._crossFades=[],this._sockets=[]}get blendState(){return this._blendStateBuffer}addCrossFade(e){this._crossFades.push(e)}removeCrossFade(e){Z(this._crossFades,e)}update(e){const{_delayEvents:t,_crossFades:n,_sockets:s}=this;for(let t=0,i=n.length;t<i;t++)n[t].update(e);const r=this._anims,o=r.array;for(r.i=0;r.i<o.length;++r.i){const t=o[r.i];t.isMotionless||t.update(e)}this._blendStateBuffer.apply();const a=i.director.getTotalFrames();for(let e=0,t=s.length;e<t;e++){const{target:t,transform:i}=s[e];t.matrix=Lm(i,a)}for(let e=0,i=t.length;e<i;e++){const i=t[e];i.fn.apply(i.thisArg,i.args)}t.length=0}destruct(){}addAnimation(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)}removeAnimation(e){const t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):S(3907)}pushDelayEvent(e,t,i){this._delayEvents.push({fn:e,thisArg:t,args:i})}addSockets(e,t){for(let i=0;i<t.length;++i){const n=t[i];if(this._sockets.find(e=>e.target===n.target))continue;const s=e.getChildByPath(n.path),r=n.target&&s&&Bm(s,e);r&&this._sockets.push({target:n.target,transform:r})}}removeSockets(e,t){for(let e=0;e<t.length;++e){const i=t[e];for(let e=0;e<this._sockets.length;++e){const t=this._sockets[e];if(t.target===i.target){Nm(t.transform.node),this._sockets[e]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}}},BN.ID="animation",LN=NN))||LN);var zN,UN,GN,HN;rO.on(sO.EVENT_INIT,()=>{const e=new FN;rO.registerSystem(FN.ID,e,WI.PRIORITY_SYSTEM)}),i.AnimationManager=FN,i.easing=KL;let VN=e("HierachyModifier",Go("cc.HierachyModifier")(zN=class extends Qd{})||zN);i.HierachyModifier=VN;let kN=e("ComponentModifier",Go("cc.ComponentModifier")(UN=class extends Jd{})||UN);i.ComponentModifier=kN;let WN=e("CurveValueAdapter",Go("cc.CurveValueAdapter")(GN=class{forTarget(e){return{set:()=>{}}}})||GN);i.CurveValueAdapter=WN;let jN=e("UniformCurveValueAdapter",Go("cc.UniformCurveValueAdapter")(HN=class extends eL{})||HN);function qN(e){return"string"==typeof e}function XN(e){return"number"==typeof e}function YN(e,t){return e instanceof t}i.UniformCurveValueAdapter=jN,i.isPropertyModifier=qN,i.isElementModifier=XN,i.isCustomTargetModifier=YN;var KN;let ZN=Go("cc.PerfCounter")(KN=class extends class{get value(){return this._value}set value(e){this._value=e}constructor(e,t,i){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=i}sample(e){this._average(this._value,e)}human(){const{average:e,isInteger:t}=this._opts,i=e?this._averageValue:this._value;return t?Math.round(i):Math.round(100*i)/100}alarm(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}_average(e,t=0){if(this._opts.average){this._accumValue+=e,++this._accumSamples;const i=t;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}{constructor(e,t,i){super(e,t,i),this._time=void 0,this._time=i}start(e=0){this._time=e}end(e=0){this._value=e-this._time,this._average(this._value)}tick(){this.end(),this.start()}frame(e){const t=e,i=t-this._time;this._total++;i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}})||KN;const $N={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},QN={frame:{desc:"Frame time (ms)",min:0,max:50,average:500},fps:{desc:"Framerate (FPS)",below:30,average:500,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},JN={fontSize:23,quadHeight:.4,segmentsPerLine:8,textureWidth:256,textureHeight:256};class eF{constructor(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new ls,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=JN.textureHeight/(Object.keys(QN).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}isShowingStats(){return this._showFPS}hideStats(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),i.game.off(i.Game.EVENT_RESTART,this.generateNode,this),i.director.off(i.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),i.director.off(i.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),i.director.off(i.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),i.director.off(i.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),i.director.off(i.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),i.director.off(i.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)}showStats(){this._showFPS||(this._device||(this._device=i.director.root.device),this.generateCanvas(),this.generateStats(),i.game.once(i.Game.EVENT_ENGINE_INITED,this.generateNode,this),i.game.on(i.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),i.director.on(i.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),i.director.on(i.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),i.director.on(i.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),i.director.on(i.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),i.director.on(i.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),i.director.on(i.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)}generateCanvas(){if(this._canvasDone)return;const{textureWidth:e,textureHeight:t}=JN;this._ctx&&this._canvas&&(this._canvas.width=e,this._canvas.height=t,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font=JN.fontSize+"px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture({type:Un.TEX2D,usage:Gn.SAMPLED|Gn.TRANSFER_DST,format:En.RGBA8,width:e,height:t}),this._region.texExtent.width=e,this._region.texExtent.height=t)}generateStats(){if(this._statsDone||!this._ctx||!this._canvas)return;this._stats=null;const e=performance.now();this._ctx.textAlign="left";let t=0;for(const i in QN){const n=QN[i];this._ctx.fillText(n.desc,0,t*this._lineHeight),n.counter=new ZN(i,n,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(let e=0;e<"0123456789. ".length;++e){const t=this._ctx.measureText("0123456789. "[e]).width;this._eachNumWidth=Math.max(this._eachNumWidth,t)}for(let e=0;e<"0123456789. ".length;++e)this._ctx.fillText("0123456789. "[e],e*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=QN,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}generateNode(){if(this._rootNode&&this._rootNode.isValid)return;this._rootNode=new kd("PROFILER_NODE"),i.game.addPersistRootNode(this._rootNode);const e=new kd("Profiler_Camera");e.setPosition(0,0,1.5),e.parent=this._rootNode;const t=e.addComponent("cc.Camera");t.projection=MM.ProjectionType.ORTHO,t.near=1,t.far=2,t.orthoHeight=this._device.height,t.visibility=Xc.BitMask.PROFILER,t.clearFlags=Jn.NONE,t.priority=4294967295,t.flows=["UIFlow"];const n=new kd("Profiler_Root");n.parent=this._rootNode;const s=JN.quadHeight,r=s/this._totalLines,o=s/this._wordHeight,a=r/JN.fontSize,c=this._eachNumWidth*this._canvas.width*a,l=[0,s,0,o,s,0,o,0,0,0,0,0],h=[0,2,1,0,3,2],u=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0];let _=0;for(let e=0;e<this._totalLines;e++)for(let t=0;t<JN.segmentsPerLine;t++){l.push(o+t*c,s-e*r,0),l.push(o+(t+1)*c,s-e*r,0),l.push(o+(t+1)*c,s-(e+1)*r,0),l.push(o+t*c,s-(e+1)*r,0),_=4*(e*JN.segmentsPerLine+t+1),h.push(0+_,2+_,1+_,0+_,3+_,2+_);const i=e*JN.segmentsPerLine+t,n=Math.floor(i/4),a=i-4*n;u.push(0,this._wordHeight,n,a),u.push(this._eachNumWidth,this._wordHeight,n,a),u.push(this._eachNumWidth,1,n,a),u.push(0,1,n,a)}const d=this._device.screenSpaceSignY;for(let e=1;e<l.length;e+=3)l[e]*=d;const m=n.addComponent(Mg);m.mesh=Yp({positions:l,indices:h,colors:u});const p=new Lu;p.initialize({effectName:"util/profiler"}),p.setProperty("offset",new fi(-.9,-.9*d,this._eachNumWidth,0));const f=this.pass=p.passes[0],g=f.getBinding("mainTexture"),v=f.getBinding("digits");f.bindTexture(g,this._texture),this.digitsData=f.blocks[v],m.material=p,m.node.layer=Xc.Enum.PROFILER,this._inited=!0}beforeUpdate(){if(!this._stats)return;const e=performance.now();this._stats.frame.counter.end(e),this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}afterUpdate(){if(!this._stats)return;const e=performance.now();i.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}beforePhysics(){if(!this._stats)return;const e=performance.now();this._stats.physics.counter.start(e)}afterPhysics(){if(!this._stats)return;const e=performance.now();this._stats.physics.counter.end(e)}beforeDraw(){if(!this._stats)return;const e=performance.now();this._stats.render.counter.start(e)}afterDraw(){if(!this._stats||!this._inited)return;const e=performance.now();if(this._stats.fps.counter.frame(e),this._stats.render.counter.end(e),e-this.lastTime<500)return;this.lastTime=e;const t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;let i=0;const n=this.digitsData;for(const t in this._stats){const s=this._stats[t];s.counter.sample(e);const r=s.counter.human().toString();for(let e=JN.segmentsPerLine-1;e>=0;e--){const t=i*JN.segmentsPerLine+e,s=r[r.length-(JN.segmentsPerLine-e)];let o=$N[s];void 0===o&&(o=11),n[t]=o}i++}this.pass._rootBufferDirty=!0}}e("Profiler",eF);const tF=e("profiler",new eF);i.profiler=tF;class iF{set splashFinish(e){this._splashFinish=e,this._tryToStart()}set loadFinish(e){this._loadFinish=e,this._tryToStart()}main(e){if(null==e)return console.error("RENDER ROOT IS NULL.");if(window._CCSettings&&window._CCSettings.splashScreen?(this.setting=window._CCSettings.splashScreen,this.setting.totalTime=null!=this.setting.totalTime?this.setting.totalTime:3e3,this.setting.base64src=this.setting.base64src||"",this.setting.effect=this.setting.effect||"FADE-INOUT",this.setting.clearColor=this.setting.clearColor||{r:.88,g:.88,b:.88,a:1},this.setting.displayRatio=null!=this.setting.displayRatio?this.setting.displayRatio:.4,this.setting.displayWatermark=null==this.setting.displayWatermark||this.setting.displayWatermark):this.setting={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:{r:.88,g:.88,b:.88,a:1},displayRatio:.4,displayWatermark:!0},""===this.setting.base64src||this.setting.totalTime<=0)return this.callBack&&this.callBack(),this.callBack=null,this.setting=null,void(this._directCall=!0);{i.view.enableRetina(!0);const t=window._CCSettings.designResolution;t?i.view.setDesignResolutionSize(t.width,t.height,t.policy):i.view.setDesignResolutionSize(960,640,4),this.root=e,this.device=e.device,i.game.once(i.Game.EVENT_GAME_INITED,()=>{i.director._lateUpdate=performance.now()},i.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.clearColors=[this.setting.clearColor],this.screenWidth=this.device.width,this.screenHeight=this.device.height,this.image=new Image,this.image.onload=this.init.bind(this),this.image.src=this.setting.base64src}}setOnFinish(e){if(this._directCall&&e)return delete iF._ins,e();this.callBack=e}_tryToStart(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide())}init(){if(Oa.os===i.sys.OS_OSX||Oa.os===i.sys.OS_IOS){const e=screen.width*devicePixelRatio,t=screen.height*devicePixelRatio;this.device.resize(e,t),this.screenWidth=this.device.width,this.screenHeight=this.device.height}this.initCMD(),this.initIA(),this.initPSO(),this.setting.displayWatermark&&this.initText();const e=t=>{if(this.cancelAnimate)return;this.startTime<0&&(this.startTime=t);const i=t-this.startTime;let n=SL(qt(i/this.setting.totalTime));"NONE"===this.setting.effect&&(n=1),this.material.setProperty("u_precent",n),this.material.passes[0].update(),this.setting.displayWatermark&&this.textMaterial&&(this.textMaterial.setProperty("u_precent",n),this.textMaterial.passes[0].update()),this.frame(t),i>this.setting.totalTime&&(this.splashFinish=!0),requestAnimationFrame(e)};this.handle=requestAnimationFrame(e)}hide(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))}frame(e){if(this.cancelAnimate)return;const t=this.device;t.acquire();const i=this.cmdBuff,n=this.framebuffer,s=this.renderArea;i.begin(),i.beginRenderPass(n.renderPass,n,s,this.clearColors,1,0);const r=this.material.passes[0].handle,o=Dp.getOrCreatePipelineState(t,r,this.shader,n.renderPass,this.assmebler);if(i.bindPipelineState(o),i.bindDescriptorSet(rl.MATERIAL,Dh.get(Fh.get(r,Nh.DESCRIPTOR_SET))),i.bindInputAssembler(this.assmebler),i.draw(this.assmebler),this.setting.displayWatermark&&this.textShader&&this.textAssmebler){const e=this.textMaterial.passes[0].handle,s=Dp.getOrCreatePipelineState(t,e,this.textShader,n.renderPass,this.textAssmebler);i.bindPipelineState(s),i.bindDescriptorSet(rl.MATERIAL,Dh.get(Fh.get(e,Nh.DESCRIPTOR_SET))),i.bindInputAssembler(this.textAssmebler),i.draw(this.textAssmebler)}i.endRenderPass(),i.end(),t.queue.submit([i]),t.present()}initText(){this.textImg=document.createElement("canvas"),this.textImg.width=330,this.textImg.height=30,this.textImg.style.width=""+this.textImg.width,this.textImg.style.height=""+this.textImg.height;const e=this.textImg.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";const t="Powered by Cocos Creator 3D",i=e.measureText(t);e.fillText(t,(330-i.width)/2,6),this.textRegion=new ls,this.textRegion.texExtent.width=this.textImg.width,this.textRegion.texExtent.height=this.textImg.height,this.textRegion.texExtent.depth=1,this.textTexture=this.device.createTexture({type:Un.TEX2D,usage:Gn.SAMPLED|Gn.TRANSFER_DST,format:En.RGBA8,width:this.textImg.width,height:this.textImg.height}),this.device.copyTexImagesToTexture([this.textImg],this.textTexture,[this.textRegion]),this.textMaterial=new Lu,this.textMaterial.initialize({effectName:"util/splash-screen"});const n=this.textMaterial.passes[0],s=n.getBinding("mainTexture");n.bindTexture(s,this.textTexture),this.textShader=Mh.get(n.getShaderVariant()),Dh.get(Fh.get(n.handle,Nh.DESCRIPTOR_SET)).update();const r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.textVB=this.device.createBuffer({usage:An.VERTEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:o,stride:r});const a=new Float32Array(16);let c=-this.textImg.width/2,l=-this.textImg.height/2;this.screenWidth<this.screenHeight?(c=-this.screenWidth/2*.5,l=c/(this.textImg.width/this.textImg.height)):(c=-this.screenHeight/2*.5,l=c/(this.textImg.width/this.textImg.height));let h=0;a[h++]=c,a[h++]=l,a[h++]=0,a[h++]=1,a[h++]=-c,a[h++]=l,a[h++]=1,a[h++]=1,a[h++]=c,a[h++]=-l,a[h++]=0,a[h++]=0,a[h++]=-c,a[h++]=-l,a[h++]=1,a[h++]=0;for(let e=0;e<a.length;e+=4)a[e]=a[e]+this.screenWidth/2,a[e+1]=a[e+1]+.1*this.screenHeight;const u=this.device.screenSpaceSignY;for(let e=0;e<a.length;e+=4)a[e]=a[e]/this.screenWidth*2-1,a[e+1]=(a[e+1]/this.screenHeight*2-1)*u;this.textVB.update(a);const _=Uint16Array.BYTES_PER_ELEMENT,d=6*_;this.textIB=this.device.createBuffer({usage:An.INDEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:d,stride:_});const m=new Uint16Array(6);m[0]=0,m[1]=1,m[2]=2,m[3]=1,m[4]=3,m[5]=2,this.textIB.update(m);const p=[{name:"a_position",format:En.RG32F},{name:"a_texCoord",format:En.RG32F}];this.textAssmebler=this.device.createInputAssembler({attributes:p,vertexBuffers:[this.textVB],indexBuffer:this.textIB})}initCMD(){const e=this.device;this.renderArea={x:0,y:0,width:e.width,height:e.height},this.framebuffer=this.root.mainWindow.framebuffer,this.cmdBuff=e.createCommandBuffer({queue:e.queue,type:jn.PRIMARY})}initIA(){const e=this.device,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t;this.vertexBuffers=e.createBuffer({usage:An.VERTEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:i,stride:t});const n=new Float32Array(16);let s=-this.image.width/2,r=-this.image.height/2;this.screenWidth<this.screenHeight?(s=-this.screenWidth/2*this.setting.displayRatio,r=s/(this.image.width/this.image.height)):(s=-this.screenHeight/2*this.setting.displayRatio,r=s/(this.image.width/this.image.height));let o=0;n[o++]=s,n[o++]=r,n[o++]=0,n[o++]=1,n[o++]=-s,n[o++]=r,n[o++]=1,n[o++]=1,n[o++]=s,n[o++]=-r,n[o++]=0,n[o++]=0,n[o++]=-s,n[o++]=-r,n[o++]=1,n[o++]=0;for(let e=0;e<n.length;e+=4)n[e]=n[e]+this.screenWidth/2,n[e+1]=n[e+1]+this.screenHeight/2;const a=e.screenSpaceSignY;for(let e=0;e<n.length;e+=4)n[e]=n[e]/this.screenWidth*2-1,n[e+1]=(n[e+1]/this.screenHeight*2-1)*a;this.vertexBuffers.update(n);const c=Uint16Array.BYTES_PER_ELEMENT,l=6*c;this.indicesBuffers=e.createBuffer({usage:An.INDEX|An.TRANSFER_DST,memUsage:Cn.HOST|Cn.DEVICE,size:l,stride:c});const h=new Uint16Array(6);h[0]=0,h[1]=1,h[2]=2,h[3]=1,h[4]=3,h[5]=2,this.indicesBuffers.update(h);const u=[{name:"a_position",format:En.RG32F},{name:"a_texCoord",format:En.RG32F}];this.assmebler=e.createInputAssembler({attributes:u,vertexBuffers:[this.vertexBuffers],indexBuffer:this.indicesBuffers})}initPSO(){const e=this.device;this.material=new Lu,this.material.initialize({effectName:"util/splash-screen"}),this.sampler=e.createSampler({addressU:zn.CLAMP,addressV:zn.CLAMP}),this.texture=e.createTexture({type:Un.TEX2D,usage:Gn.SAMPLED|Gn.TRANSFER_DST,format:En.RGBA8,width:this.image.width,height:this.image.height});const t=this.material.passes[0],i=t.getBinding("mainTexture");t.bindTexture(i,this.texture),this.shader=Mh.get(t.getShaderVariant());const n=Dh.get(Fh.get(t.handle,Nh.DESCRIPTOR_SET));n.bindSampler(i,this.sampler),n.update(),this.region=new ls,this.region.texExtent.width=this.image.width,this.region.texExtent.height=this.image.height,this.region.texExtent.depth=1,e.copyTexImagesToTexture([this.image],this.texture,[this.region])}destroy(){this.callBack=null,this.clearColors=null,this.device=null,this.image=null,this.framebuffer=null,this.renderArea=null,this.region=null,this.cmdBuff.destroy(),this.cmdBuff=null,this.shader=null,this.material.destroy(),this.material=null,this.texture.destroy(),this.texture=null,this.assmebler.destroy(),this.assmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler.destroy(),this.sampler=null,this.setting.displayWatermark&&this.textImg&&(this.textImg=null,this.textRegion=null,this.textShader=null,this.textMaterial.destroy(),this.textMaterial=null,this.textTexture.destroy(),this.textTexture=null,this.textAssmebler.destroy(),this.textAssmebler=null,this.textVB.destroy(),this.textVB=null,this.textIB.destroy(),this.textIB=null),this.setting=null,delete iF._ins}static get instance(){return iF._ins||(iF._ins=new iF),iF._ins}constructor(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}}iF._ins=void 0,i.internal.SplashScreen=iF;const nF={};Ui(nF,"vmath",[{name:"vec2",newName:"Vec2",target:Yi,targetName:"math"},{name:"vec3",newName:"Vec3",target:Yi,targetName:"math"},{name:"vec4",newName:"Vec4",target:Yi,targetName:"math"},{name:"quat",newName:"Quat",target:Yi,targetName:"math"},{name:"mat3",newName:"Mat3",target:Yi,targetName:"math"},{name:"mat4",newName:"Mat4",target:Yi,targetName:"math"},{name:"color4",newName:"Color",target:Yi,targetName:"math"},{name:"rect",newName:"Rect",target:Yi,targetName:"math"},{name:"approx",newName:"approx",target:Yi,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:Yi,targetName:"math"},{name:"equals",newName:"equals",target:Yi,targetName:"math"},{name:"clamp",newName:"clamp",target:Yi,targetName:"math"},{name:"clamp01",newName:"clamp01",target:Yi,targetName:"math"},{name:"lerp",newName:"lerp",target:Yi,targetName:"math"},{name:"toRadian",newName:"toRadian",target:Yi,targetName:"math"},{name:"toDegree",newName:"toDegree",target:Yi,targetName:"math"},{name:"random",newName:"random",target:Yi,targetName:"math"},{name:"randomRange",newName:"randomRange",target:Yi,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:Yi,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:Yi,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:Yi,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:Yi,targetName:"math"},{name:"repeat",newName:"repeat",target:Yi,targetName:"math"},{name:"pingPong",newName:"pingPong",target:Yi,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:Yi,targetName:"math"}]),i.vmath=nF,Ui(WI.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:WI,targetName:"Scheduler"}]),Ui(Uu.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:Uu,targetName:"EventTouch"}]),Ui(i,"cc",[{name:"GFXDynamicState",newName:"GFXDynamicStateFlagBit"},{name:"GFXBindingType",newName:"GFXDescriptorType"},{name:"GFXBindingLayout",newName:"GFXDescriptorSet"}]),Gi(Ts.prototype,"GFXCommandBuffer.prototype",[{name:"bindBindingLayout",suggest:"Use `bindDescriptorSet` instead"}]),Ui(Sm.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),Gi(Sm.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),i.math=Yi,i.geometry=uo;class sF{constructor(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}size(){return this._pool.length}clear(){const e=this._pool.length;for(let t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}put(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();const t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}get(...e){const t=this._pool.length-1;if(t<0)return null;{const e=this._pool[t];this._pool.length=t;const i=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;return i&&i.reuse&&i.reuse(arguments),e}}}var rF,oF,aF,cF,lF,hF,uF,_F,dF;e("NodePool",sF),i.NodePool=sF,function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(dF||(dF={})),$e(dF);let mF,pF=e("Primitive",(rF=Go("cc.Primitive"),oF=va(dF),rF((_F=uF=class extends Hl{constructor(e=dF.BOX){super(),Oo(this,"type",lF,this),Oo(this,"info",hF,this),this.type=e}onLoaded(){Yp(Ef[dF[this.type].toLowerCase()](this.info),this)}},uF.PrimitiveType=dF,lF=Po((cF=_F).prototype,"type",[oF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dF.BOX}}),hF=Po(cF.prototype,"info",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),aF=cF))||aF));i.Primitive=pF,i.renderer=Zf,i.primitives=Ef;class fF extends Ks{constructor(...e){super(...e),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(e){this._layout=e.layout;const{bindings:t,descriptorCount:i,descriptorIndices:n}=e.layout.gpuDescriptorSetLayout;this._buffers=Array(i).fill(null),this._textures=Array(i).fill(null),this._samplers=Array(i).fill(null);const s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:n};for(let e=0;e<t.length;++e){const i=t[e];for(let e=0;e<i.count;e++)s.push({type:i.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}return!0}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const e=this._gpuDescriptorSet.gpuDescriptors;for(let t=0;t<e.length;++t)if(e[t].type&Xs){const i=this._buffers[t];i&&(e[t].gpuBuffer=i.gpuBuffer||i.gpuBufferView)}else e[t].type&Ys&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}}function gF(e,t){switch(e){case En.R8:return t.UNSIGNED_BYTE;case En.R8SN:return t.BYTE;case En.R8UI:return t.UNSIGNED_BYTE;case En.R8I:return t.BYTE;case En.R16F:return mF.HALF_FLOAT_OES;case En.R16UI:return t.UNSIGNED_SHORT;case En.R16I:return t.SHORT;case En.R32F:return t.FLOAT;case En.R32UI:return t.UNSIGNED_INT;case En.R32I:return t.INT;case En.RG8:return t.UNSIGNED_BYTE;case En.RG8SN:return t.BYTE;case En.RG8UI:return t.UNSIGNED_BYTE;case En.RG8I:return t.BYTE;case En.RG16F:return mF.HALF_FLOAT_OES;case En.RG16UI:return t.UNSIGNED_SHORT;case En.RG16I:return t.SHORT;case En.RG32F:return t.FLOAT;case En.RG32UI:return t.UNSIGNED_INT;case En.RG32I:return t.INT;case En.RGB8:case En.SRGB8:return t.UNSIGNED_BYTE;case En.RGB8SN:return t.BYTE;case En.RGB8UI:return t.UNSIGNED_BYTE;case En.RGB8I:return t.BYTE;case En.RGB16F:return mF.HALF_FLOAT_OES;case En.RGB16UI:return t.UNSIGNED_SHORT;case En.RGB16I:return t.SHORT;case En.RGB32F:return t.FLOAT;case En.RGB32UI:return t.UNSIGNED_INT;case En.RGB32I:return t.INT;case En.BGRA8:case En.RGBA8:case En.SRGB8_A8:return t.UNSIGNED_BYTE;case En.RGBA8SN:return t.BYTE;case En.RGBA8UI:return t.UNSIGNED_BYTE;case En.RGBA8I:return t.BYTE;case En.RGBA16F:return mF.HALF_FLOAT_OES;case En.RGBA16UI:return t.UNSIGNED_SHORT;case En.RGBA16I:return t.SHORT;case En.RGBA32F:return t.FLOAT;case En.RGBA32UI:return t.UNSIGNED_INT;case En.RGBA32I:return t.INT;case En.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case En.R11G11B10F:return t.FLOAT;case En.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case En.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case En.RGB10A2:return t.UNSIGNED_BYTE;case En.RGB10A2UI:return t.UNSIGNED_INT;case En.RGB9E5:return t.UNSIGNED_BYTE;case En.D16:return t.UNSIGNED_SHORT;case En.D16S8:return mF.UNSIGNED_INT_24_8_WEBGL;case En.D24:return t.UNSIGNED_INT;case En.D24S8:return mF.UNSIGNED_INT_24_8_WEBGL;case En.D32F:return t.UNSIGNED_INT;case En.D32F_S8:return mF.UNSIGNED_INT_24_8_WEBGL;case En.BC1:case En.BC1_SRGB:case En.BC2:case En.BC2_SRGB:case En.BC3:case En.BC3_SRGB:case En.BC4:return t.UNSIGNED_BYTE;case En.BC4_SNORM:return t.BYTE;case En.BC5:return t.UNSIGNED_BYTE;case En.BC5_SNORM:return t.BYTE;case En.BC6H_SF16:case En.BC6H_UF16:return t.FLOAT;case En.BC7:case En.BC7_SRGB:case En.ETC_RGB8:case En.ETC2_RGB8:case En.ETC2_SRGB8:case En.ETC2_RGB8_A1:case En.ETC2_SRGB8_A1:case En.ETC2_RGB8:case En.ETC2_SRGB8:case En.EAC_R11:return t.UNSIGNED_BYTE;case En.EAC_R11SN:return t.BYTE;case En.EAC_RG11:return t.UNSIGNED_BYTE;case En.EAC_RG11SN:return t.BYTE;case En.PVRTC_RGB2:case En.PVRTC_RGBA2:case En.PVRTC_RGB4:case En.PVRTC_RGBA4:case En.PVRTC2_2BPP:case En.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case En.ASTC_RGBA_4x4:case En.ASTC_RGBA_5x4:case En.ASTC_RGBA_5x5:case En.ASTC_RGBA_6x5:case En.ASTC_RGBA_6x6:case En.ASTC_RGBA_8x5:case En.ASTC_RGBA_8x6:case En.ASTC_RGBA_8x8:case En.ASTC_RGBA_10x5:case En.ASTC_RGBA_10x6:case En.ASTC_RGBA_10x8:case En.ASTC_RGBA_10x10:case En.ASTC_RGBA_12x10:case En.ASTC_RGBA_12x12:case En.ASTC_SRGBA_4x4:case En.ASTC_SRGBA_5x4:case En.ASTC_SRGBA_5x5:case En.ASTC_SRGBA_6x5:case En.ASTC_SRGBA_6x6:case En.ASTC_SRGBA_8x5:case En.ASTC_SRGBA_8x6:case En.ASTC_SRGBA_8x8:case En.ASTC_SRGBA_10x5:case En.ASTC_SRGBA_10x6:case En.ASTC_SRGBA_10x8:case En.ASTC_SRGBA_10x10:case En.ASTC_SRGBA_12x10:case En.ASTC_SRGBA_12x12:default:return t.UNSIGNED_BYTE}}function vF(e,t){switch(e){case En.A8:return t.ALPHA;case En.L8:return t.LUMINANCE;case En.LA8:return t.LUMINANCE_ALPHA;case En.RGB8:case En.RGB16F:case En.RGB32F:return t.RGB;case En.BGRA8:case En.RGBA8:case En.RGBA16F:case En.RGBA32F:return t.RGBA;case En.R5G6B5:return t.RGB565;case En.RGB5A1:return t.RGB5_A1;case En.RGBA4:return t.RGBA4;case En.D16:return t.DEPTH_COMPONENT;case En.D16S8:return t.DEPTH_STENCIL;case En.D24:return t.DEPTH_COMPONENT;case En.D24S8:return t.DEPTH_STENCIL;case En.D32F:return t.DEPTH_COMPONENT;case En.D32F_S8:return t.DEPTH_STENCIL;case En.BC1:return mF.COMPRESSED_RGB_S3TC_DXT1_EXT;case En.BC1_ALPHA:return mF.COMPRESSED_RGBA_S3TC_DXT1_EXT;case En.BC1_SRGB:return mF.COMPRESSED_SRGB_S3TC_DXT1_EXT;case En.BC1_SRGB_ALPHA:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case En.BC2:return mF.COMPRESSED_RGBA_S3TC_DXT3_EXT;case En.BC2_SRGB:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case En.BC3:return mF.COMPRESSED_RGBA_S3TC_DXT5_EXT;case En.BC3_SRGB:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case En.ETC_RGB8:return mF.COMPRESSED_RGB_ETC1_WEBGL;case En.ETC2_RGB8:return mF.COMPRESSED_RGB8_ETC2;case En.ETC2_SRGB8:return mF.COMPRESSED_SRGB8_ETC2;case En.ETC2_RGB8_A1:return mF.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case En.ETC2_SRGB8_A1:return mF.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case En.ETC2_RGBA8:return mF.COMPRESSED_RGBA8_ETC2_EAC;case En.ETC2_SRGB8_A8:return mF.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case En.EAC_R11:return mF.COMPRESSED_R11_EAC;case En.EAC_R11SN:return mF.COMPRESSED_SIGNED_R11_EAC;case En.EAC_RG11:return mF.COMPRESSED_RG11_EAC;case En.EAC_RG11SN:return mF.COMPRESSED_SIGNED_RG11_EAC;case En.PVRTC_RGB2:return mF.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case En.PVRTC_RGBA2:return mF.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case En.PVRTC_RGB4:return mF.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case En.PVRTC_RGBA4:return mF.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case En.ASTC_RGBA_4x4:return mF.COMPRESSED_RGBA_ASTC_4x4_KHR;case En.ASTC_RGBA_5x4:return mF.COMPRESSED_RGBA_ASTC_5x4_KHR;case En.ASTC_RGBA_5x5:return mF.COMPRESSED_RGBA_ASTC_5x5_KHR;case En.ASTC_RGBA_6x5:return mF.COMPRESSED_RGBA_ASTC_6x5_KHR;case En.ASTC_RGBA_6x6:return mF.COMPRESSED_RGBA_ASTC_6x6_KHR;case En.ASTC_RGBA_8x5:return mF.COMPRESSED_RGBA_ASTC_8x5_KHR;case En.ASTC_RGBA_8x6:return mF.COMPRESSED_RGBA_ASTC_8x6_KHR;case En.ASTC_RGBA_8x8:return mF.COMPRESSED_RGBA_ASTC_8x8_KHR;case En.ASTC_RGBA_10x5:return mF.COMPRESSED_RGBA_ASTC_10x5_KHR;case En.ASTC_RGBA_10x6:return mF.COMPRESSED_RGBA_ASTC_10x6_KHR;case En.ASTC_RGBA_10x8:return mF.COMPRESSED_RGBA_ASTC_10x8_KHR;case En.ASTC_RGBA_10x10:return mF.COMPRESSED_RGBA_ASTC_10x10_KHR;case En.ASTC_RGBA_12x10:return mF.COMPRESSED_RGBA_ASTC_12x10_KHR;case En.ASTC_RGBA_12x12:return mF.COMPRESSED_RGBA_ASTC_12x12_KHR;case En.ASTC_SRGBA_4x4:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case En.ASTC_SRGBA_5x4:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case En.ASTC_SRGBA_5x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case En.ASTC_SRGBA_6x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case En.ASTC_SRGBA_6x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case En.ASTC_SRGBA_8x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case En.ASTC_SRGBA_8x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case En.ASTC_SRGBA_8x8:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case En.ASTC_SRGBA_10x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case En.ASTC_SRGBA_10x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case En.ASTC_SRGBA_10x8:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case En.ASTC_SRGBA_10x10:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case En.ASTC_SRGBA_12x10:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case En.ASTC_SRGBA_12x12:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function yF(e,t){switch(e){case En.A8:return t.ALPHA;case En.L8:return t.LUMINANCE;case En.LA8:return t.LUMINANCE_ALPHA;case En.RGB8:case En.RGB16F:case En.RGB32F:return t.RGB;case En.BGRA8:case En.RGBA8:case En.RGBA16F:case En.RGBA32F:return t.RGBA;case En.R5G6B5:return t.RGB;case En.RGB5A1:case En.RGBA4:return t.RGBA;case En.D16:return t.DEPTH_COMPONENT;case En.D16S8:return t.DEPTH_STENCIL;case En.D24:return t.DEPTH_COMPONENT;case En.D24S8:return t.DEPTH_STENCIL;case En.D32F:return t.DEPTH_COMPONENT;case En.D32F_S8:return t.DEPTH_STENCIL;case En.BC1:return mF.COMPRESSED_RGB_S3TC_DXT1_EXT;case En.BC1_ALPHA:return mF.COMPRESSED_RGBA_S3TC_DXT1_EXT;case En.BC1_SRGB:return mF.COMPRESSED_SRGB_S3TC_DXT1_EXT;case En.BC1_SRGB_ALPHA:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case En.BC2:return mF.COMPRESSED_RGBA_S3TC_DXT3_EXT;case En.BC2_SRGB:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case En.BC3:return mF.COMPRESSED_RGBA_S3TC_DXT5_EXT;case En.BC3_SRGB:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case En.ETC_RGB8:return mF.COMPRESSED_RGB_ETC1_WEBGL;case En.ETC2_RGB8:return mF.COMPRESSED_RGB8_ETC2;case En.ETC2_SRGB8:return mF.COMPRESSED_SRGB8_ETC2;case En.ETC2_RGB8_A1:return mF.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case En.ETC2_SRGB8_A1:return mF.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case En.ETC2_RGBA8:return mF.COMPRESSED_RGBA8_ETC2_EAC;case En.ETC2_SRGB8_A8:return mF.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case En.EAC_R11:return mF.COMPRESSED_R11_EAC;case En.EAC_R11SN:return mF.COMPRESSED_SIGNED_R11_EAC;case En.EAC_RG11:return mF.COMPRESSED_RG11_EAC;case En.EAC_RG11SN:return mF.COMPRESSED_SIGNED_RG11_EAC;case En.PVRTC_RGB2:return mF.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case En.PVRTC_RGBA2:return mF.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case En.PVRTC_RGB4:return mF.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case En.PVRTC_RGBA4:return mF.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case En.ASTC_RGBA_4x4:return mF.COMPRESSED_RGBA_ASTC_4x4_KHR;case En.ASTC_RGBA_5x4:return mF.COMPRESSED_RGBA_ASTC_5x4_KHR;case En.ASTC_RGBA_5x5:return mF.COMPRESSED_RGBA_ASTC_5x5_KHR;case En.ASTC_RGBA_6x5:return mF.COMPRESSED_RGBA_ASTC_6x5_KHR;case En.ASTC_RGBA_6x6:return mF.COMPRESSED_RGBA_ASTC_6x6_KHR;case En.ASTC_RGBA_8x5:return mF.COMPRESSED_RGBA_ASTC_8x5_KHR;case En.ASTC_RGBA_8x6:return mF.COMPRESSED_RGBA_ASTC_8x6_KHR;case En.ASTC_RGBA_8x8:return mF.COMPRESSED_RGBA_ASTC_8x8_KHR;case En.ASTC_RGBA_10x5:return mF.COMPRESSED_RGBA_ASTC_10x5_KHR;case En.ASTC_RGBA_10x6:return mF.COMPRESSED_RGBA_ASTC_10x6_KHR;case En.ASTC_RGBA_10x8:return mF.COMPRESSED_RGBA_ASTC_10x8_KHR;case En.ASTC_RGBA_10x10:return mF.COMPRESSED_RGBA_ASTC_10x10_KHR;case En.ASTC_RGBA_12x10:return mF.COMPRESSED_RGBA_ASTC_12x10_KHR;case En.ASTC_RGBA_12x12:return mF.COMPRESSED_RGBA_ASTC_12x12_KHR;case En.ASTC_SRGBA_4x4:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case En.ASTC_SRGBA_5x4:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case En.ASTC_SRGBA_5x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case En.ASTC_SRGBA_6x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case En.ASTC_SRGBA_6x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case En.ASTC_SRGBA_8x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case En.ASTC_SRGBA_8x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case En.ASTC_SRGBA_8x8:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case En.ASTC_SRGBA_10x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case En.ASTC_SRGBA_10x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case En.ASTC_SRGBA_10x8:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case En.ASTC_SRGBA_10x10:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case En.ASTC_SRGBA_12x10:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case En.ASTC_SRGBA_12x12:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function xF(e,t){switch(e){case Tn.BOOL:return t.BOOL;case Tn.BOOL2:return t.BOOL_VEC2;case Tn.BOOL3:return t.BOOL_VEC3;case Tn.BOOL4:return t.BOOL_VEC4;case Tn.INT:return t.INT;case Tn.INT2:return t.INT_VEC2;case Tn.INT3:return t.INT_VEC3;case Tn.INT4:return t.INT_VEC4;case Tn.UINT:return t.UNSIGNED_INT;case Tn.FLOAT:return t.FLOAT;case Tn.FLOAT2:return t.FLOAT_VEC2;case Tn.FLOAT3:return t.FLOAT_VEC3;case Tn.FLOAT4:return t.FLOAT_VEC4;case Tn.MAT2:return t.FLOAT_MAT2;case Tn.MAT3:return t.FLOAT_MAT3;case Tn.MAT4:return t.FLOAT_MAT4;case Tn.SAMPLER2D:return t.SAMPLER_2D;case Tn.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Tn.UNKNOWN}}function SF(e,t){switch(e){case t.BOOL:return Tn.BOOL;case t.BOOL_VEC2:return Tn.BOOL2;case t.BOOL_VEC3:return Tn.BOOL3;case t.BOOL_VEC4:return Tn.BOOL4;case t.INT:return Tn.INT;case t.INT_VEC2:return Tn.INT2;case t.INT_VEC3:return Tn.INT3;case t.INT_VEC4:return Tn.INT4;case t.UNSIGNED_INT:return Tn.UINT;case t.FLOAT:return Tn.FLOAT;case t.FLOAT_VEC2:return Tn.FLOAT2;case t.FLOAT_VEC3:return Tn.FLOAT3;case t.FLOAT_VEC4:return Tn.FLOAT4;case t.FLOAT_MAT2:return Tn.MAT2;case t.FLOAT_MAT3:return Tn.MAT3;case t.FLOAT_MAT4:return Tn.MAT4;case t.SAMPLER_2D:return Tn.SAMPLER2D;case t.SAMPLER_CUBE:return Tn.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),Tn.UNKNOWN}}function TF(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function EF(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(mF||(mF={}));const AF=[512,513,514,515,516,517,518,519],CF=[0,7680,7681,7682,7683,5386,34055,34056],bF=[32774,32778,32779,32774,32774],RF=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];let wF;!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(wF||(wF={}));class IF{constructor(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e}}class OF extends IF{constructor(){super(wF.BEGIN_RENDER_PASS),this.gpuRenderPass=null,this.gpuFramebuffer=null,this.renderArea={x:0,y:0,width:0,height:0},this.clearFlag=Jn.NONE,this.clearColors=[],this.clearDepth=1,this.clearStencil=0}clear(){this.gpuFramebuffer=null,this.clearColors.length=0}}class PF extends IF{constructor(){super(wF.BIND_STATES),this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets=[],this.dynamicOffsets=[],this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=[],this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}clear(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}class MF extends IF{constructor(){super(wF.DRAW),this.drawInfo=new xs}clear(){}}class DF extends IF{constructor(){super(wF.UPDATE_BUFFER),this.gpuBuffer=null,this.buffer=null,this.offset=0,this.size=0}clear(){this.gpuBuffer=null,this.buffer=null}}class LF extends IF{constructor(){super(wF.COPY_BUFFER_TO_TEXTURE),this.gpuTexture=null,this.buffers=[],this.regions=[]}clear(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}class BF{constructor(){this.cmds=new po(1),this.beginRenderPassCmds=new po(1),this.bindStatesCmds=new po(1),this.drawCmds=new po(1),this.updateBufferCmds=new po(1),this.copyBufferToTextureCmds=new po(1)}clearCmds(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}function NF(e,t,i,n,s){if(t.usage&An.UNIFORM)ArrayBuffer.isView(i)?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&An.INDIRECT)t.indirects.length=n,Array.prototype.push.apply(t.indirects,i.drawInfos);else{const r=i,o=e.gl,a=e.stateCache;switch(t.glTarget){case o.ARRAY_BUFFER:e.useVAO&&a.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case o.ELEMENT_ARRAY_BUFFER:e.useVAO&&a.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}s===r.byteLength?o.bufferSubData(t.glTarget,n,r):o.bufferSubData(t.glTarget,n,r.slice(0,s))}}const FF={gpuPipelineState:null,gpuInputAssembler:null,gpuShader:null,glPrimitive:0,reverseCW:!1};function zF(e,t,i,n,s,r,o){FF.gpuInputAssembler=null,FF.gpuShader=null;const a=e.gl,c=e.stateCache;let l=0;if(i&&t){if(c.glFramebuffer!==i.glFramebuffer){a.bindFramebuffer(a.FRAMEBUFFER,i.glFramebuffer),c.glFramebuffer=i.glFramebuffer;const t=!!i.glFramebuffer;if(t!==FF.reverseCW){FF.reverseCW=t;const i=!e.stateCache.rs.isFrontFaceCCW;a.frontFace(i?a.CCW:a.CW),e.stateCache.rs.isFrontFaceCCW=i}}c.viewport.left===n.x&&c.viewport.top===n.y&&c.viewport.width===n.width&&c.viewport.height===n.height||(a.viewport(n.x,n.y,n.width,n.height),c.viewport.left=n.x,c.viewport.top=n.y,c.viewport.width=n.width,c.viewport.height=n.height),c.scissorRect.x===n.x&&c.scissorRect.y===n.y&&c.scissorRect.width===n.width&&c.scissorRect.height===n.height||(a.scissor(n.x,n.y,n.width,n.height),c.scissorRect.x=n.x,c.scissorRect.y=n.y,c.scissorRect.width=n.width,c.scissorRect.height=n.height);let h=s.length;e.WEBGL_draw_buffers||(h=1);for(let e=0;e<h;++e){const i=t.colorAttachments[e];if(i.format!==En.UNKNOWN)switch(i.loadOp){case qn.LOAD:break;case qn.CLEAR:{c.bs.targets[0].blendColorMask!==Nn.ALL&&a.colorMask(!0,!0,!0,!0);const e=s[0];a.clearColor(e.r,e.g,e.b,e.a),l|=a.COLOR_BUFFER_BIT;break}case qn.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==En.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case qn.LOAD:break;case qn.CLEAR:c.dss.depthWrite||a.depthMask(!0),a.clearDepth(r),l|=a.DEPTH_BUFFER_BIT;break;case qn.DISCARD:}if(_s[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case qn.LOAD:break;case qn.CLEAR:c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,65535),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,65535),a.clearStencil(o),l|=a.STENCIL_BUFFER_BIT;break;case qn.DISCARD:}}if(l&&a.clear(l),l&a.COLOR_BUFFER_BIT){const e=c.bs.targets[0].blendColorMask;if(e!==Nn.ALL){const t=(e&Nn.R)!==Nn.NONE,i=(e&Nn.G)!==Nn.NONE,n=(e&Nn.B)!==Nn.NONE,s=(e&Nn.A)!==Nn.NONE;a.colorMask(t,i,n,s)}}l&a.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&a.depthMask(!1),l&a.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,0),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,0))}}function UF(e,t,i,n,s,r,o,a,c,l,h,_,d){const m=e.gl,p=e.stateCache,f=FF.gpuShader=t&&t.gpuShader;let g,v,y,x=!1;if(t&&FF.gpuPipelineState!==t){if(FF.gpuPipelineState=t,FF.glPrimitive=t.glPrimitive,t.gpuShader){const e=t.gpuShader.glProgram;p.glProgram!==e&&(m.useProgram(e),p.glProgram=e,x=!0)}const e=t.rs;if(e){if(p.rs.cullMode!==e.cullMode){switch(e.cullMode){case Pn.NONE:m.disable(m.CULL_FACE);break;case Pn.FRONT:m.enable(m.CULL_FACE),m.cullFace(m.FRONT);break;case Pn.BACK:m.enable(m.CULL_FACE),m.cullFace(m.BACK)}p.rs.cullMode=e.cullMode}const t=FF.reverseCW?!e.isFrontFaceCCW:e.isFrontFaceCCW;p.rs.isFrontFaceCCW!==t&&(m.frontFace(t?m.CCW:m.CW),p.rs.isFrontFaceCCW=t),p.rs.depthBias===e.depthBias&&p.rs.depthBiasSlop===e.depthBiasSlop||(m.polygonOffset(e.depthBias,e.depthBiasSlop),p.rs.depthBias=e.depthBias,p.rs.depthBiasSlop=e.depthBiasSlop),p.rs.lineWidth!==e.lineWidth&&(m.lineWidth(e.lineWidth),p.rs.lineWidth=e.lineWidth)}const i=t.dss;i&&(p.dss.depthTest!==i.depthTest&&(i.depthTest?m.enable(m.DEPTH_TEST):m.disable(m.DEPTH_TEST),p.dss.depthTest=i.depthTest),p.dss.depthWrite!==i.depthWrite&&(m.depthMask(i.depthWrite),p.dss.depthWrite=i.depthWrite),p.dss.depthFunc!==i.depthFunc&&(m.depthFunc(AF[i.depthFunc]),p.dss.depthFunc=i.depthFunc),p.dss.stencilTestFront===i.stencilTestFront&&p.dss.stencilTestBack===i.stencilTestBack||(i.stencilTestFront||i.stencilTestBack?m.enable(m.STENCIL_TEST):m.disable(m.STENCIL_TEST),p.dss.stencilTestFront=i.stencilTestFront,p.dss.stencilTestBack=i.stencilTestBack),p.dss.stencilFuncFront===i.stencilFuncFront&&p.dss.stencilRefFront===i.stencilRefFront&&p.dss.stencilReadMaskFront===i.stencilReadMaskFront||(m.stencilFuncSeparate(m.FRONT,AF[i.stencilFuncFront],i.stencilRefFront,i.stencilReadMaskFront),p.dss.stencilFuncFront=i.stencilFuncFront,p.dss.stencilRefFront=i.stencilRefFront,p.dss.stencilReadMaskFront=i.stencilReadMaskFront),p.dss.stencilFailOpFront===i.stencilFailOpFront&&p.dss.stencilZFailOpFront===i.stencilZFailOpFront&&p.dss.stencilPassOpFront===i.stencilPassOpFront||(m.stencilOpSeparate(m.FRONT,CF[i.stencilFailOpFront],CF[i.stencilZFailOpFront],CF[i.stencilPassOpFront]),p.dss.stencilFailOpFront=i.stencilFailOpFront,p.dss.stencilZFailOpFront=i.stencilZFailOpFront,p.dss.stencilPassOpFront=i.stencilPassOpFront),p.dss.stencilWriteMaskFront!==i.stencilWriteMaskFront&&(m.stencilMaskSeparate(m.FRONT,i.stencilWriteMaskFront),p.dss.stencilWriteMaskFront=i.stencilWriteMaskFront),p.dss.stencilFuncBack===i.stencilFuncBack&&p.dss.stencilRefBack===i.stencilRefBack&&p.dss.stencilReadMaskBack===i.stencilReadMaskBack||(m.stencilFuncSeparate(m.BACK,AF[i.stencilFuncBack],i.stencilRefBack,i.stencilReadMaskBack),p.dss.stencilFuncBack=i.stencilFuncBack,p.dss.stencilRefBack=i.stencilRefBack,p.dss.stencilReadMaskBack=i.stencilReadMaskBack),p.dss.stencilFailOpBack===i.stencilFailOpBack&&p.dss.stencilZFailOpBack===i.stencilZFailOpBack&&p.dss.stencilPassOpBack===i.stencilPassOpBack||(m.stencilOpSeparate(m.BACK,CF[i.stencilFailOpBack],CF[i.stencilZFailOpBack],CF[i.stencilPassOpBack]),p.dss.stencilFailOpBack=i.stencilFailOpBack,p.dss.stencilZFailOpBack=i.stencilZFailOpBack,p.dss.stencilPassOpBack=i.stencilPassOpBack),p.dss.stencilWriteMaskBack!==i.stencilWriteMaskBack&&(m.stencilMaskSeparate(m.BACK,i.stencilWriteMaskBack),p.dss.stencilWriteMaskBack=i.stencilWriteMaskBack));const n=t.bs;if(n){p.bs.isA2C!==n.isA2C&&(n.isA2C?m.enable(m.SAMPLE_ALPHA_TO_COVERAGE):m.disable(m.SAMPLE_ALPHA_TO_COVERAGE),p.bs.isA2C=n.isA2C),p.bs.blendColor.r===n.blendColor.r&&p.bs.blendColor.g===n.blendColor.g&&p.bs.blendColor.b===n.blendColor.b&&p.bs.blendColor.a===n.blendColor.a||(m.blendColor(n.blendColor.r,n.blendColor.g,n.blendColor.b,n.blendColor.a),p.bs.blendColor.r=n.blendColor.r,p.bs.blendColor.g=n.blendColor.g,p.bs.blendColor.b=n.blendColor.b,p.bs.blendColor.a=n.blendColor.a);const e=n.targets[0],t=p.bs.targets[0];t.blend!==e.blend&&(e.blend?m.enable(m.BLEND):m.disable(m.BLEND),t.blend=e.blend),t.blendEq===e.blendEq&&t.blendAlphaEq===e.blendAlphaEq||(m.blendEquationSeparate(bF[e.blendEq],bF[e.blendAlphaEq]),t.blendEq=e.blendEq,t.blendAlphaEq=e.blendAlphaEq),t.blendSrc===e.blendSrc&&t.blendDst===e.blendDst&&t.blendSrcAlpha===e.blendSrcAlpha&&t.blendDstAlpha===e.blendDstAlpha||(m.blendFuncSeparate(RF[e.blendSrc],RF[e.blendDst],RF[e.blendSrcAlpha],RF[e.blendDstAlpha]),t.blendSrc=e.blendSrc,t.blendDst=e.blendDst,t.blendSrcAlpha=e.blendSrcAlpha,t.blendDstAlpha=e.blendDstAlpha),t.blendColorMask!==e.blendColorMask&&(m.colorMask((e.blendColorMask&Nn.R)!==Nn.NONE,(e.blendColorMask&Nn.G)!==Nn.NONE,(e.blendColorMask&Nn.B)!==Nn.NONE,(e.blendColorMask&Nn.A)!==Nn.NONE),t.blendColorMask=e.blendColorMask)}}if(t&&t.gpuPipelineLayout&&f){const i=f.glBlocks.length,r=t.gpuPipelineLayout.dynamicOffsetIndices;for(let e=0;e<i;e++){const t=f.glBlocks[e],i=n[t.set],o=i&&i.gpuDescriptors[t.binding];let a=null,c=0;if(o&&o.gpuBuffer){const e=o.gpuBuffer,i=r[t.set],n=i&&i[t.binding];n>=0&&(c=s[n]),"vf32"in e?a=e.vf32:(c+=e.offset,a=e.gpuBuffer.vf32),c>>=2}if(!a){u(`Buffer binding '${t.name}' at set ${t.set} binding ${t.binding} is not bounded`);continue}const l=t.glActiveUniforms.length;for(let e=0;e<l;e++){const i=t.glActiveUniforms[e];switch(i.glType){case m.BOOL:case m.INT:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniform1iv(i.glLoc,i.array);break}}break;case m.BOOL_VEC2:case m.INT_VEC2:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniform2iv(i.glLoc,i.array);break}}break;case m.BOOL_VEC3:case m.INT_VEC3:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniform3iv(i.glLoc,i.array);break}}break;case m.BOOL_VEC4:case m.INT_VEC4:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniform4iv(i.glLoc,i.array);break}}break;case m.FLOAT:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniform1fv(i.glLoc,i.array);break}}break;case m.FLOAT_VEC2:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniform2fv(i.glLoc,i.array);break}}break;case m.FLOAT_VEC3:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniform3fv(i.glLoc,i.array);break}}break;case m.FLOAT_VEC4:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniform4fv(i.glLoc,i.array);break}}break;case m.FLOAT_MAT2:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniformMatrix2fv(i.glLoc,!1,i.array);break}}break;case m.FLOAT_MAT3:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniformMatrix3fv(i.glLoc,!1,i.array);break}}break;case m.FLOAT_MAT4:for(let e=0;e<i.array.length;++e){const t=i.begin+c+e;if(a[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=a[s];m.uniformMatrix4fv(i.glLoc,!1,i.array);break}}}}}const o=f.glSamplers.length;for(let t=0;t<o;t++){var S;const i=f.glSamplers[t],s=n[i.set];let r=null!==(S=null==s?void 0:s.descriptorIndices[i.binding])&&void 0!==S?S:-1,o=s&&s.gpuDescriptors[r];const a=i.units.length;for(let t=0;t<a;t++){const n=i.units[t];if(o&&o.gpuSampler){if(o.gpuTexture&&o.gpuTexture.size>0){const t=o.gpuTexture,i=p.glTexUnits[n];i.glTexture!==t.glTexture&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),t.glTexture?m.bindTexture(t.glTarget,t.glTexture):m.bindTexture(t.glTarget,e.nullTex2D.gpuTexture.glTexture),i.glTexture=t.glTexture);const s=o.gpuSampler;t.isPowerOf2?(g=s.glWrapS,v=s.glWrapT):(g=m.CLAMP_TO_EDGE,v=m.CLAMP_TO_EDGE),y=t.isPowerOf2?t.mipLevel<=1&&(s.glMinFilter===m.LINEAR_MIPMAP_NEAREST||s.glMinFilter===m.LINEAR_MIPMAP_LINEAR)?m.LINEAR:s.glMinFilter:s.glMinFilter===m.LINEAR||s.glMinFilter===m.LINEAR_MIPMAP_NEAREST||s.glMinFilter===m.LINEAR_MIPMAP_LINEAR?m.LINEAR:m.NEAREST,t.glWrapS!==g&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),m.texParameteri(t.glTarget,m.TEXTURE_WRAP_S,g),t.glWrapS=g),t.glWrapT!==v&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),m.texParameteri(t.glTarget,m.TEXTURE_WRAP_T,v),t.glWrapT=v),t.glMinFilter!==y&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),m.texParameteri(t.glTarget,m.TEXTURE_MIN_FILTER,y),t.glMinFilter=y),t.glMagFilter!==s.glMagFilter&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),m.texParameteri(t.glTarget,m.TEXTURE_MAG_FILTER,s.glMagFilter),t.glMagFilter=s.glMagFilter)}o=s.gpuDescriptors[++r]}else u(`Sampler binding '${i.name}' at set ${i.set} binding ${i.binding} index ${t} is not bounded`)}}}if(i&&f&&(x||FF.gpuInputAssembler!==i)){FF.gpuInputAssembler=i;const t=e.ANGLE_instanced_arrays;if(e.useVAO){const n=e.OES_vertex_array_object;let s=i.glVAOs.get(f.glProgram);if(!s){let e;s=n.createVertexArrayOES(),i.glVAOs.set(f.glProgram,s),n.bindVertexArrayOES(s),m.bindBuffer(m.ARRAY_BUFFER,null),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null),p.glArrayBuffer=null,p.glElementArrayBuffer=null;const r=f.glInputs.length;for(let n=0;n<r;n++){const s=f.glInputs[n];e=null;const r=i.glAttribs.length;for(let t=0;t<r;t++){const n=i.glAttribs[t];if(n.name===s.name){e=n;break}}if(e){p.glArrayBuffer!==e.glBuffer&&(m.bindBuffer(m.ARRAY_BUFFER,e.glBuffer),p.glArrayBuffer=e.glBuffer);for(let i=0;i<e.componentCount;++i){const n=s.glLoc+i,r=e.offset+e.size*i;m.enableVertexAttribArray(n),p.glCurrentAttribLocs[n]=!0,m.vertexAttribPointer(n,e.count,e.glType,e.isNormalized,e.stride,r),t&&t.vertexAttribDivisorANGLE(n,e.isInstanced?1:0)}}}const o=i.gpuIndexBuffer;o&&m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,o.glBuffer),n.bindVertexArrayOES(null),m.bindBuffer(m.ARRAY_BUFFER,null),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null),p.glArrayBuffer=null,p.glElementArrayBuffer=null}p.glVAO!==s&&(n.bindVertexArrayOES(s),p.glVAO=s)}else{for(let t=0;t<e.maxVertexAttributes;++t)p.glCurrentAttribLocs[t]=!1;const n=f.glInputs.length;for(let e=0;e<n;e++){const n=f.glInputs[e];let s=null;const r=i.glAttribs.length;for(let e=0;e<r;e++){const t=i.glAttribs[e];if(t.name===n.name){s=t;break}}if(s){p.glArrayBuffer!==s.glBuffer&&(m.bindBuffer(m.ARRAY_BUFFER,s.glBuffer),p.glArrayBuffer=s.glBuffer);for(let e=0;e<s.componentCount;++e){const i=n.glLoc+e,r=s.offset+s.size*e;!p.glEnabledAttribLocs[i]&&i>=0&&(m.enableVertexAttribArray(i),p.glEnabledAttribLocs[i]=!0),p.glCurrentAttribLocs[i]=!0,m.vertexAttribPointer(i,s.count,s.glType,s.isNormalized,s.stride,r),t&&t.vertexAttribDivisorANGLE(i,s.isInstanced?1:0)}}}const s=i.gpuIndexBuffer;s&&p.glElementArrayBuffer!==s.glBuffer&&(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,s.glBuffer),p.glElementArrayBuffer=s.glBuffer);for(let t=0;t<e.maxVertexAttributes;++t)p.glEnabledAttribLocs[t]!==p.glCurrentAttribLocs[t]&&(m.disableVertexAttribArray(t),p.glEnabledAttribLocs[t]=!1)}}if(t){const e=t.dynamicStates.length;for(let i=0;i<e;i++){switch(t.dynamicStates[i]){case Zn.VIEWPORT:r&&(p.viewport.left===r.left&&p.viewport.top===r.top&&p.viewport.width===r.width&&p.viewport.height===r.height||(m.viewport(r.left,r.top,r.width,r.height),p.viewport.left=r.left,p.viewport.top=r.top,p.viewport.width=r.width,p.viewport.height=r.height));break;case Zn.SCISSOR:o&&(p.scissorRect.x===o.x&&p.scissorRect.y===o.y&&p.scissorRect.width===o.width&&p.scissorRect.height===o.height||(m.scissor(o.x,o.y,o.width,o.height),p.scissorRect.x=o.x,p.scissorRect.y=o.y,p.scissorRect.width=o.width,p.scissorRect.height=o.height));break;case Zn.LINE_WIDTH:a&&p.rs.lineWidth!==a&&(m.lineWidth(a),p.rs.lineWidth=a);break;case Zn.DEPTH_BIAS:c&&(p.rs.depthBias===c.constantFactor&&p.rs.depthBiasSlop===c.slopeFactor||(m.polygonOffset(c.constantFactor,c.slopeFactor),p.rs.depthBias=c.constantFactor,p.rs.depthBiasSlop=c.slopeFactor));break;case Zn.BLEND_CONSTANTS:p.bs.blendColor.r===l[0]&&p.bs.blendColor.g===l[1]&&p.bs.blendColor.b===l[2]&&p.bs.blendColor.a===l[3]||(m.blendColor(l[0],l[1],l[2],l[3]),p.bs.blendColor.r=l[0],p.bs.blendColor.g=l[1],p.bs.blendColor.b=l[2],p.bs.blendColor.a=l[3]);break;case Zn.STENCIL_WRITE_MASK:if(_)switch(_.face){case $n.FRONT:p.dss.stencilWriteMaskFront!==_.writeMask&&(m.stencilMaskSeparate(m.FRONT,_.writeMask),p.dss.stencilWriteMaskFront=_.writeMask);break;case $n.BACK:p.dss.stencilWriteMaskBack!==_.writeMask&&(m.stencilMaskSeparate(m.BACK,_.writeMask),p.dss.stencilWriteMaskBack=_.writeMask);break;case $n.ALL:p.dss.stencilWriteMaskFront===_.writeMask&&p.dss.stencilWriteMaskBack===_.writeMask||(m.stencilMask(_.writeMask),p.dss.stencilWriteMaskFront=_.writeMask,p.dss.stencilWriteMaskBack=_.writeMask)}break;case Zn.STENCIL_COMPARE_MASK:if(d)switch(d.face){case $n.FRONT:p.dss.stencilRefFront===d.reference&&p.dss.stencilReadMaskFront===d.compareMask||(m.stencilFuncSeparate(m.FRONT,AF[p.dss.stencilFuncFront],d.reference,d.compareMask),p.dss.stencilRefFront=d.reference,p.dss.stencilReadMaskFront=d.compareMask);break;case $n.BACK:p.dss.stencilRefBack===d.reference&&p.dss.stencilReadMaskBack===d.compareMask||(m.stencilFuncSeparate(m.BACK,AF[p.dss.stencilFuncBack],d.reference,d.compareMask),p.dss.stencilRefBack=d.reference,p.dss.stencilReadMaskBack=d.compareMask);break;case $n.ALL:p.dss.stencilRefFront===d.reference&&p.dss.stencilReadMaskFront===d.compareMask&&p.dss.stencilRefBack===d.reference&&p.dss.stencilReadMaskBack===d.compareMask||(m.stencilFunc(AF[p.dss.stencilFuncBack],d.reference,d.compareMask),p.dss.stencilRefFront=d.reference,p.dss.stencilReadMaskFront=d.compareMask,p.dss.stencilRefBack=d.reference,p.dss.stencilReadMaskBack=d.compareMask)}}}}}function GF(e,t){const i=e.gl,n=e.ANGLE_instanced_arrays,{gpuInputAssembler:s,gpuShader:r,glPrimitive:o}=FF;if(s&&r)if(s.gpuIndirectBuffer){const e=s.gpuIndirectBuffer.indirects.length;for(let t=0;t<e;t++){const e=s.gpuIndirectBuffer.indirects[t],r=s.gpuIndexBuffer;if(e.instanceCount&&n)if(r){if(e.indexCount>0){const t=e.firstIndex*r.stride;n.drawElementsInstancedANGLE(o,e.indexCount,s.glIndexType,t,e.instanceCount)}}else n.drawArraysInstancedANGLE(o,e.firstVertex,e.vertexCount,e.instanceCount);else if(r){if(e.indexCount>0){const t=e.firstIndex*r.stride;i.drawElements(o,e.indexCount,s.glIndexType,t)}}else i.drawArrays(o,e.firstVertex,e.vertexCount)}}else{const e=s.gpuIndexBuffer;if(t.instanceCount&&n)if(e){if(t.indexCount>0){const i=t.firstIndex*e.stride;n.drawElementsInstancedANGLE(o,t.indexCount,s.glIndexType,i,t.instanceCount)}}else n.drawArraysInstancedANGLE(o,t.firstVertex,t.vertexCount,t.instanceCount);else if(e){if(t.indexCount>0){const n=t.firstIndex*e.stride;i.drawElements(o,t.indexCount,s.glIndexType,n)}}else i.drawArrays(o,t.firstVertex,t.vertexCount)}}const HF=new Array(wF.COUNT);function VF(e,t){HF.fill(0);for(let i=0;i<t.cmds.length;++i){const n=t.cmds.array[i],s=HF[n]++;switch(n){case wF.BEGIN_RENDER_PASS:{const i=t.beginRenderPassCmds.array[s];zF(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break}case wF.BIND_STATES:{const i=t.bindStatesCmds.array[s];UF(e,i.gpuPipelineState,i.gpuInputAssembler,i.gpuDescriptorSets,i.dynamicOffsets,i.viewport,i.scissor,i.lineWidth,i.depthBias,i.blendConstants,i.depthBounds,i.stencilWriteMask,i.stencilCompareMask);break}case wF.DRAW:GF(e,t.drawCmds.array[s].drawInfo);break;case wF.UPDATE_BUFFER:{const i=t.updateBufferCmds.array[s];NF(e,i.gpuBuffer,i.buffer,i.offset,i.size);break}case wF.COPY_BUFFER_TO_TEXTURE:{const i=t.copyBufferToTextureCmds.array[s];kF(e,i.buffers,i.gpuTexture,i.regions);break}}}}function kF(e,t,i,n){const s=e.gl,r=e.stateCache.glTexUnits[e.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=1,c=1,l=0;const h=_s[i.format].isCompressed;switch(i.glTarget){case s.TEXTURE_2D:for(let r=0;r<n.length;r++){const l=n[r];a=l.texExtent.width,c=l.texExtent.height;const u=t[o++];h?i.glInternalFmt===mF.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,i.glInternalFmt,a,c,0,u):s.compressedTexSubImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,a,c,i.glFormat,u):s.texSubImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,a,c,i.glFormat,i.glType,u)}break;case s.TEXTURE_CUBE_MAP:for(let r=0;r<n.length;r++){const u=n[r],_=u.texSubres.baseArrayLayer+u.texSubres.layerCount;for(l=u.texSubres.baseArrayLayer;l<_;++l){a=u.texExtent.width,c=u.texExtent.height;const n=t[o++];h?i.glInternalFmt===mF.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,u.texSubres.mipLevel,i.glInternalFmt,a,c,0,n):s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,u.texSubres.mipLevel,u.texOffset.x,u.texOffset.y,a,c,i.glFormat,n):s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,u.texSubres.mipLevel,u.texOffset.x,u.texOffset.y,a,c,i.glFormat,i.glType,n)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Vn.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}class WF extends Ss{constructor(...e){super(...e),this._gpuBuffer=null,this._gpuBufferView=null,this._uniformBuffer=null}get gpuBuffer(){return this._gpuBuffer}get gpuBufferView(){return this._gpuBufferView}initialize(e){if("buffer"in e){this._isBufferView=!0;const t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:bn.NONE,this._usage&An.INDIRECT&&(this._indirectBuffer={drawInfos:[]}),this._flags&bn.BAKUP_BUFFER&&(this._bakcupBuffer=new Uint8Array(this._size),this._device.memoryStatus.bufferSize+=this._size),this._usage&An.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:this._bakcupBuffer,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&An.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&An.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){const i=e.gl,n=e.stateCache,s=t.memUsage&Cn.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&An.VERTEX){t.glTarget=i.ARRAY_BUFFER;const r=i.createBuffer();r&&(t.glBuffer=r,t.size>0&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&An.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;const r=i.createBuffer();r&&(t.glBuffer=r,t.size>0&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&An.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&An.INDIRECT||t.usage&An.TRANSFER_DST||t.usage&An.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}destroy(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null),this._bakcupBuffer=null}resize(e){if(this._isBufferView)return void console.warn("cannot resize buffer views!");const t=this._size;if(t!==e){if(this._size=e,this._count=this._size/this._stride,this._bakcupBuffer){const i=this._bakcupBuffer;this._bakcupBuffer=new Uint8Array(this._size),this._bakcupBuffer.set(i),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e}this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer?this._gpuBuffer.buffer=this._uniformBuffer:this._bakcupBuffer&&(this._gpuBuffer.buffer=this._bakcupBuffer),this._gpuBuffer.size=e,e>0&&(!function(e,t){const i=e.gl,n=e.stateCache,s=t.memUsage&Cn.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&An.VERTEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,s):i.bufferData(i.ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&An.INDEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,s):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&An.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&An.INDIRECT||t.usage&An.TRANSFER_DST||t.usage&An.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e))}}update(e,t,i){if(this._isBufferView)return void console.warn("cannot update through buffer views!");let n;if(n=void 0!==i?i:this._usage&An.INDIRECT?0:e.byteLength,this._bakcupBuffer&&e!==this._bakcupBuffer.buffer){const n=new Uint8Array(e,0,i);this._bakcupBuffer.set(n,t)}NF(this._device,this._gpuBuffer,e,t||0,n)}}class jF{constructor(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new po(t);for(let i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}alloc(e){if(this._freeIdx<0){const t=2*this._frees.length,i=this._frees;this._frees=new Array(t);const n=t-i.length;for(let t=0;t<n;++t)this._frees[t]=new e;for(let e=n,s=0;e<t;++e,++s)this._frees[e]=i[s];this._freeIdx+=n}const t=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++t.refCount,t}free(e){0==--e.refCount&&this._freeCmds.push(e)}freeCmds(e){for(let t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}release(){for(let e=0;e<this._freeCmds.length;++e){const t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}class qF{constructor(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new jF(OF,1),this.bindStatesCmdPool=new jF(PF,1),this.drawCmdPool=new jF(MF,1),this.updateBufferCmdPool=new jF(DF,1),this.copyBufferToTextureCmdPool=new jF(LF,1)}clearCmds(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}releaseCmds(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}class XF extends Ts{constructor(...e){super(...e),this.cmdPackage=new BF,this._webGLAllocator=null,this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets=[],this._curDynamicOffsets=[],this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._isStateInvalied=!1}initialize(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;const t=this._device.bindingMappingInfo.bufferOffsets.length;for(let e=0;e<t;e++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0}destroy(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}begin(e,t=0,i){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(let e=0;e<this._curDynamicOffsets.length;e++)this._curDynamicOffsets[e].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(e,t,i,n,s,r){const o=this._webGLAllocator.beginRenderPassCmdPool.alloc(OF);o.gpuRenderPass=e.gpuRenderPass,o.gpuFramebuffer=t.gpuFramebuffer,o.renderArea=i,o.clearColors.length=n.length;for(let e=0;e<n.length;++e)o.clearColors[e]=n[e];o.clearDepth=s,o.clearStencil=r,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(wF.BEGIN_RENDER_PASS),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(e){const t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}bindDescriptorSet(e,t,i){const n=t.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=n,this._isStateInvalied=!0),i){const t=this._curDynamicOffsets[e];for(let e=0;e<i.length;e++)t[e]=i[e];t.length=i.length,this._isStateInvalied=!0}}bindInputAssembler(e){const t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}setViewport(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth}}setScissor(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}setLineWidth(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}setDepthBias(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}setBlendConstants(e){4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3]||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,e),this._isStateInvalied=!0)}setDepthBound(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}setStencilWriteMask(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}setStencilCompareMask(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}draw(e){if(this._type===jn.PRIMARY&&this._isInRenderPass||this._type===jn.SECONDARY){this._isStateInvalied&&this.bindStates();const t=this._webGLAllocator.drawCmdPool.alloc(MF);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(wF.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;const i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState){switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(e,t,i,n){if(this._type===jn.PRIMARY&&!this._isInRenderPass||this._type===jn.SECONDARY){const s=e.gpuBuffer;if(s){const r=this._webGLAllocator.updateBufferCmdPool.alloc(DF);if(r){let o;o=void 0!==n?n:e.usage&An.INDIRECT?0:t.byteLength;const a=t;r.gpuBuffer=s,r.buffer=a,r.offset=void 0!==i?i:0,r.size=o,this.cmdPackage.updateBufferCmds.push(r),this.cmdPackage.cmds.push(wF.UPDATE_BUFFER)}}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}copyBuffersToTexture(e,t,i){if(this._type===jn.PRIMARY&&!this._isInRenderPass||this._type===jn.SECONDARY){const n=t.gpuTexture;if(n){const t=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(LF);t&&(t.gpuTexture=n,t.regions=i,t.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(t),this.cmdPackage.cmds.push(wF.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}execute(e,t){for(let i=0;i<t;++i){const t=e[i];for(let e=0;e<t.cmdPackage.beginRenderPassCmds.length;++e){const i=t.cmdPackage.beginRenderPassCmds.array[e];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(let e=0;e<t.cmdPackage.bindStatesCmds.length;++e){const i=t.cmdPackage.bindStatesCmds.array[e];++i.refCount,this.cmdPackage.bindStatesCmds.push(i)}for(let e=0;e<t.cmdPackage.drawCmds.length;++e){const i=t.cmdPackage.drawCmds.array[e];++i.refCount,this.cmdPackage.drawCmds.push(i)}for(let e=0;e<t.cmdPackage.updateBufferCmds.length;++e){const i=t.cmdPackage.updateBufferCmds.array[e];++i.refCount,this.cmdPackage.updateBufferCmds.push(i)}for(let e=0;e<t.cmdPackage.copyBufferToTextureCmds.length;++e){const i=t.cmdPackage.copyBufferToTextureCmds.array[e];++i.refCount,this.cmdPackage.copyBufferToTextureCmds.push(i)}this.cmdPackage.cmds.concat(t.cmdPackage.cmds.array),this._numDrawCalls+=t._numDrawCalls,this._numInstances+=t._numInstances,this._numTris+=t._numTris}}get webGLDevice(){return this._device}bindStates(){const e=this._webGLAllocator.bindStatesCmdPool.alloc(PF);if(e){e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets);for(let t=0;t<this._curDynamicOffsets.length;t++)Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets[t]);e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,Array.prototype.push.apply(e.blendConstants,this._curBlendConstants),e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(wF.BIND_STATES),this._isStateInvalied=!1}}}class YF extends Js{initialize(e){return!0}destroy(){}wait(){}reset(){}}class KF extends Rs{constructor(...e){super(...e),this._gpuFramebuffer=null}get gpuFramebuffer(){return this._gpuFramebuffer}initialize(e){if(this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null,e.depStencilMipmapLevel&&0!==e.depStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0."),e.colorMipmapLevels&&e.colorMipmapLevels.length>0)for(let t=0;t<e.colorMipmapLevels.length;++t)0!==e.colorMipmapLevels[t]&&console.warn(`The mipmap level of th texture image to be attached of color attachment ${t} should be 0. Convert to 0.`);const t=[];if(void 0!==e.colorTextures)for(const i of e.colorTextures)i&&t.push(i.gpuTexture);let i=null;return e.depthStencilTexture&&(i=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:i,glFramebuffer:null},function(e,t){if(!t.gpuColorTextures.length&&!t.gpuDepthStencilTexture)return;const i=e.gl,n=[],s=i.createFramebuffer();if(s){t.glFramebuffer=s,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(let e=0;e<t.gpuColorTextures.length;++e){const s=t.gpuColorTextures[e];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.RENDERBUFFER,s.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+e))}const r=t.gpuDepthStencilTexture;if(r){const e=_s[r.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;r.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,e,r.glTarget,r.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,e,i.RENDERBUFFER,r.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(n);const o=i.checkFramebufferStatus(i.FRAMEBUFFER);if(o!==i.FRAMEBUFFER_COMPLETE)switch(o){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}(this._device,this._gpuFramebuffer),!0}destroy(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)}}class ZF extends Ps{constructor(...e){super(...e),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{const e=this._vertexBuffers[0];this._vertexCount=e.size/e.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;const t=new Array(e.vertexBuffers.length);for(let i=0;i<e.vertexBuffers.length;++i){const n=e.vertexBuffers[i];n.gpuBuffer&&(t[i]=n.gpuBuffer)}let i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer,i))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Error index buffer stride.")}let s=null;return void 0!==e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:t,gpuIndexBuffer:i,gpuIndirectBuffer:s,glAttribs:[],glIndexType:n,glVAOs:new Map},function(e,t){const i=e.gl;t.glAttribs=new Array(t.attributes.length);const n=[0,0,0,0,0,0,0,0];for(let e=0;e<t.attributes.length;++e){const s=t.attributes[e],r=void 0!==s.stream?s.stream:0,o=t.gpuVertexBuffers[r],a=gF(s.format,i),c=_s[s.format].size;t.glAttribs[e]={name:s.name,glBuffer:o.glBuffer,glType:a,size:c,count:_s[s.format].count,stride:o.stride,componentCount:EF(a,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[r]},n[r]+=c}}(this._device,this._gpuInputAssembler),!0}destroy(){const e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){const i=t.glVAOs.values();let n=i.next();for(;!n.done;)e.OES_vertex_array_object.deleteVertexArrayOES(n.value),n=i.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null}}class $F extends $s{constructor(...e){super(...e),this._gpuDescriptorSetLayout=null}get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}initialize(e){Array.prototype.push.apply(this._bindings,e.bindings);let t=0;for(let e=0;e<this._bindings.length;e++){const i=this._bindings[e];this._descriptorIndices.push(t),t+=i.count}this._descriptorIndices.push(t);const i=[];for(let e=0;e<this._bindings.length;e++){const t=this._bindings[e];if(t.descriptorType&Zs)for(let n=0;n<t.count;n++)i.push(e)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:i,descriptorIndices:this._descriptorIndices,descriptorCount:t},!0}destroy(){this._bindings.length=0}}class QF extends Qs{constructor(...e){super(...e),this._gpuPipelineLayout=null}get gpuPipelineLayout(){return this._gpuPipelineLayout}initialize(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);const t=[],i=[],n=[];let s=0,r=0;for(let e=0;e<this._setLayouts.length;e++){const o=this._setLayouts[e],a=o.gpuDescriptorSetLayout.dynamicBindings,c=o.bindings,l=[];i.push(o.gpuDescriptorSetLayout);for(let e=0,t=0;e<c.length;e++)if(a[t]===e)for(l.push(r);a[t]===e;)t++,r++;else l.push(-1);t.push(l),n.push(s),s+=a.length}return this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetCount:s,dynamicOffsetOffsets:n,dynamicOffsetIndices:t},!0}destroy(){this._setLayouts.length=0}}const JF=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class ez extends Fs{constructor(...e){super(...e),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._is=e.inputState,this._renderPass=e.renderPass;const t=[];for(let e=0;e<31;e++)this._dynamicStates&1<<e&&t.push(1<<e);return this._gpuPipelineState={glPrimitive:JF[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:t},!0}destroy(){this._gpuPipelineState=null}}const tz=[];class iz extends XF{beginRenderPass(e,t,i,n,s,r){zF(this._device,e.gpuRenderPass,t.gpuFramebuffer,i,n,s,r),this._isInRenderPass=!0}draw(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),GF(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;const t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState){switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(e,t,i,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{const s=e.gpuBuffer;if(s){let r;void 0===i&&(i=0),r=void 0!==n?n:e.usage&An.INDIRECT?0:t.byteLength,NF(this._device,s,t,i,r)}}}copyBuffersToTexture(e,t,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{const n=t.gpuTexture;n&&kF(this._device,e,n,i)}}execute(e,t){for(let i=0;i<t;++i){const t=e[i];VF(this._device,t.cmdPackage),this._numDrawCalls+=t._numDrawCalls,this._numInstances+=t._numInstances,this._numTris+=t._numTris}}bindStates(){tz.length=0;for(let e=0;e<this._curDynamicOffsets.length;e++)Array.prototype.push.apply(tz,this._curDynamicOffsets[e]);UF(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,tz,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1}}class nz extends zs{constructor(...e){super(...e),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(e){return this._type=e.type,!0}destroy(){}submit(e,t){if(!this._isAsync){const t=e.length;for(let i=0;i<t;i++){const t=e[i];this.numDrawCalls+=t.numDrawCalls,this.numInstances+=t.numInstances,this.numTris+=t.numTris}}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class sz extends Hs{constructor(...e){super(...e),this._gpuRenderPass=null}get gpuRenderPass(){return this._gpuRenderPass}initialize(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subPasses&&(this._subPasses=e.subPasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}destroy(){this._gpuRenderPass=null}}const rz=[10497,33648,33071,33071];class oz extends ks{constructor(...e){super(...e),this._gpuSampler=null}get gpuSampler(){return this._gpuSampler}initialize(e){void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias);let t=0,i=0;const n=this._state.minFilter,s=this._state.magFilter,r=this._state.mipFilter;t=n===Fn.LINEAR||n===Fn.ANISOTROPIC?r===Fn.LINEAR||r===Fn.ANISOTROPIC?9987:r===Fn.POINT?9985:9729:r===Fn.LINEAR||r===Fn.ANISOTROPIC?9986:r===Fn.POINT?9984:9728,i=s===Fn.LINEAR||s===Fn.ANISOTROPIC?9729:9728;const o=rz[this._state.addressU],a=rz[this._state.addressV],c=rz[this._state.addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:o,glWrapT:a,glWrapR:c},!0}destroy(){this._gpuSampler=null}}class az extends Ws{constructor(...e){super(...e),this._gpuShader=null}get gpuShader(){return this._gpuShader}initialize(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(let t=0;t<e.stages.length;++t){const i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.stage,source:i.source,glShader:null}}return function(e,t){const i=e.gl;for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];let s=0,r="",o=1;switch(n.type){case kn.VERTEX:r="VertexShader",s=i.VERTEX_SHADER;break;case kn.FRAGMENT:r="FragmentShader",s=i.FRAGMENT_SHADER;break;default:return void console.error("Unsupported GFXShaderType.")}const a=i.createShader(s);if(a&&(n.glShader=a,i.shaderSource(n.glShader,n.source),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(r+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",n.source.replace(/^|\n/g,()=>`\n${o++} `)),console.error(i.getShaderInfoLog(n.glShader));for(let n=0;n<t.gpuStages.length;n++){const n=t.gpuStages[e];n.glShader&&(i.deleteShader(n.glShader),n.glShader=null)}return}}const n=i.createProgram();if(!n)return;t.glProgram=n;for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];i.attachShader(t.glProgram,n.glShader)}if(i.linkProgram(t.glProgram),e.destroyShadersImmediately)for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];n.glShader&&(i.detachShader(t.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}if(!i.getProgramParameter(t.glProgram,i.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(i.getProgramInfoLog(t.glProgram));console.info("Shader '"+t.name+"' compilation succeeded.");const s=i.getProgramParameter(t.glProgram,i.ACTIVE_ATTRIBUTES);t.glInputs=new Array(s);for(let e=0;e<s;++e){const n=i.getActiveAttrib(t.glProgram,e);if(n){let s;const r=n.name.indexOf("[");s=-1!==r?n.name.substr(0,r):n.name;const o=i.getAttribLocation(t.glProgram,s),a=SF(n.type,i),c=TF(n.type,i);t.glInputs[e]={binding:o,name:s,type:a,stride:c,count:n.size,size:c*n.size,glType:n.type,glLoc:o}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(let e=0;e<t.blocks.length;++e){const n=t.blocks[e],s={set:n.set,binding:n.binding,name:n.name,size:0,glUniforms:new Array(n.members.length),glActiveUniforms:[]};t.glBlocks[e]=s;for(let e=0;e<n.members.length;++e){const t=n.members[e],r=xF(t.type,i),o=TF(r,i),a=o*t.count,c=s.size/4,l=new Array(a/4);l.fill(0),s.glUniforms[e]={binding:-1,name:t.name,type:t.type,stride:o,count:t.count,size:a,offset:s.size,glType:r,glLoc:-1,array:l,begin:c},s.size+=a}}}if(t.samplers.length>0){t.glSamplers=new Array(t.samplers.length);for(let e=0;e<t.samplers.length;++e){const n=t.samplers[e];t.glSamplers[e]={set:n.set,binding:n.binding,name:n.name,type:n.type,units:[],glUnits:null,glType:xF(n.type,i),glLoc:-1}}}const r=i.getProgramParameter(t.glProgram,i.ACTIVE_UNIFORMS);let o=0;const a=[];for(let e=0;e<r;++e){const n=i.getActiveUniform(t.glProgram,e);if(n){const e=i.getUniformLocation(t.glProgram,n.name);if(null!==e){let s;const r=n.name.indexOf("[");s=-1!==r?n.name.substr(0,r):n.name;if(n.type===i.SAMPLER_2D||n.type===i.SAMPLER_CUBE)for(let i=0;i<t.glSamplers.length;i++){const r=t.glSamplers[i];if(r.name===s){for(let e=0;e<n.size;++e)r.units.push(o+e);r.glLoc=e,o+=n.size,a.push(r);break}}else for(let i=0;i<t.glBlocks.length;i++){const n=t.glBlocks[i];for(let t=0;t<n.glUniforms.length;t++){const i=n.glUniforms[t];if(i.name===s){i.glLoc=e,n.glActiveUniforms.push(i);break}}}}}}if(a.length){e.stateCache.glProgram!==t.glProgram&&i.useProgram(t.glProgram);for(let e=0;e<a.length;e++){const t=a[e];t.glUnits=new Int32Array(t.units),i.uniform1iv(t.glLoc,t.glUnits)}e.stateCache.glProgram!==t.glProgram&&i.useProgram(e.stateCache.glProgram)}for(let e=0;e<t.glBlocks.length;)t.glBlocks[e].glActiveUniforms.length?e++:(t.glBlocks[e]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);for(let e=0;e<t.glSamplers.length;)t.glSamplers[e].units.length?e++:(t.glSamplers[e]=t.glSamplers[t.glSamplers.length-1],t.glSamplers.length--)}(this._device,this._gpuShader),!0}destroy(){this._gpuShader&&(!function(e,t){if(t.glProgram){const i=e.gl;if(!e.destroyShadersImmediately)for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];n.glShader&&(i.detachShader(t.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}i.deleteProgram(t.glProgram),t.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null)}}class cz{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glTexUnits=new Array(gn),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new Ms,this.dss=new Ds,this.bs=new Bs,this.glEnabledAttribLocs=new Array(fn),this.glCurrentAttribLocs=new Array(fn),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(let e=0;e<gn;++e)this.glTexUnits[e]={glTexture:null}}}class lz extends qs{constructor(...e){super(...e),this._gpuTexture=null}get gpuTexture(){return this._gpuTexture}initialize(e){return"texture"in e?(console.log("WebGL does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.layerCount&&(this._layerCount=e.layerCount),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=js(this._width)&&js(this._height),this._size=ms(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._flags&Vn.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){const i=e.gl;t.glInternalFmt=vF(t.format,i),t.glFormat=yF(t.format,i),t.glType=gF(t.format,i);let n=t.width,s=t.height;switch(t.type){case Un.TEX2D:{t.glTarget=i.TEXTURE_2D;const r=Math.max(n,s);if(r>e.maxTextureSize&&S(9100,r,e.maxTextureSize),!e.WEBGL_depth_texture&&_s[t.format].hasDepth){const r=i.createRenderbuffer();r&&t.size>0&&(t.glRenderbuffer=r,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),t.glInternalFmt===i.DEPTH_COMPONENT&&(t.glInternalFmt=i.DEPTH_COMPONENT16),i.renderbufferStorage(i.RENDERBUFFER,t.glInternalFmt,n,s))}else if(t.samples===Hn.X1){const r=i.createTexture();if(r&&t.size>0){t.glTexture=r;const o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),_s[t.format].isCompressed)if(t.glInternalFmt!==mF.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<t.mipLevel;++e){const r=ds(t.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else{const e=ds(t.format,2,2,1),n=new Uint8Array(e);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternalFmt,2,2,0,n)}else for(let e=0;e<t.mipLevel;++e)i.texImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}else i.deleteTexture(r)}break}case Un.CUBE:{t.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);r>e.maxCubeMapTextureSize&&S(9100,r,e.maxTextureSize);const o=i.createTexture();if(o&&t.size>0){t.glTexture=o;const r=e.stateCache.glTexUnits[e.stateCache.texUnit];if(r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),r.glTexture=t.glTexture),_s[t.format].isCompressed)if(t.glInternalFmt!==mF.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<6;++e){n=t.width,s=t.height;for(let r=0;r<t.mipLevel;++r){const o=ds(t.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,t.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let e=0;e<6;++e){const n=ds(t.format,2,2,1),s=new Uint8Array(n);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,t.glInternalFmt,2,2,0,s)}else for(let e=0;e<6;++e){n=t.width,s=t.height;for(let r=0;r<t.mipLevel;++r)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break}default:console.error("Unsupported GFXTextureType, create texture failed."),t.type=Un.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}destroy(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._buffer=null}resize(e,t){const i=this._size;this._width=e,this._height=t,this._size=ms(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){const i=e.gl;t.glInternalFmt=vF(t.format,i),t.glFormat=yF(t.format,i),t.glType=gF(t.format,i);let n=t.width,s=t.height;switch(t.type){case Un.TEX2D:{t.glTarget=i.TEXTURE_2D;const r=Math.max(n,s);if(r>e.maxTextureSize&&S(9100,r,e.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,t.glInternalFmt,n,s);else if(t.glTexture){const r=e.stateCache.glTexUnits[e.stateCache.texUnit];if(r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),r.glTexture=t.glTexture),_s[t.format].isCompressed){if(t.glInternalFmt!==mF.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<t.mipLevel;++e){const r=ds(t.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let e=0;e<t.mipLevel;++e)i.texImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}case Un.CUBE:{t.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);r>e.maxCubeMapTextureSize&&S(9100,r,e.maxTextureSize);const o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),o.glTexture=t.glTexture),_s[t.format].isCompressed){if(t.glInternalFmt!==mF.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<6;++e){n=t.width,s=t.height;for(let r=0;r<t.mipLevel;++r){const o=ds(t.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,t.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}}else for(let e=0;e<6;++e){n=t.width,s=t.height;for(let r=0;r<t.mipLevel;++r)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}default:console.error("Unsupported GFXTextureType, create texture failed."),t.type=Un.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size)}}class hz extends bs{constructor(...e){super(...e),this.stateCache=new cz,this.cmdAllocator=new qF,this.nullTex2D=null,this.nullTexCube=null,this._webGLRC=null,this._isAntialias=!0,this._isPremultipliedAlpha=!0,this._useVAO=!1,this._destroyShadersImmediately=!0,this._noCompressedTexSubImage2D=!1,this._bindingMappingInfo=new Cs,this._webGLContextLostHandler=null,this._extensions=null,this._EXT_texture_filter_anisotropic=null,this._EXT_frag_depth=null,this._EXT_shader_texture_lod=null,this._EXT_sRGB=null,this._OES_vertex_array_object=null,this._EXT_color_buffer_half_float=null,this._WEBGL_color_buffer_float=null,this._WEBGL_compressed_texture_etc1=null,this._WEBGL_compressed_texture_etc=null,this._WEBGL_compressed_texture_pvrtc=null,this._WEBGL_compressed_texture_astc=null,this._WEBGL_compressed_texture_s3tc=null,this._WEBGL_compressed_texture_s3tc_srgb=null,this._WEBGL_debug_shaders=null,this._WEBGL_draw_buffers=null,this._WEBGL_lose_context=null,this._WEBGL_depth_texture=null,this._WEBGL_debug_renderer_info=null,this._OES_texture_half_float=null,this._OES_texture_half_float_linear=null,this._OES_texture_float=null,this._OES_texture_float_linear=null,this._OES_standard_derivatives=null,this._OES_element_index_uint=null,this._ANGLE_instanced_arrays=null}get gl(){return this._webGLRC}get webGLQueue(){return this._queue}get isAntialias(){return this._isAntialias}get isPremultipliedAlpha(){return this._isPremultipliedAlpha}get useVAO(){return this._useVAO}get destroyShadersImmediately(){return this._destroyShadersImmediately}get noCompressedTexSubImage2D(){return this._noCompressedTexSubImage2D}get bindingMappingInfo(){return this._bindingMappingInfo}get EXT_texture_filter_anisotropic(){return this._EXT_texture_filter_anisotropic}get EXT_frag_depth(){return this._EXT_frag_depth}get EXT_shader_texture_lod(){return this._EXT_shader_texture_lod}get EXT_sRGB(){return this._EXT_sRGB}get OES_vertex_array_object(){return this._OES_vertex_array_object}get WEBGL_color_buffer_float(){return this._WEBGL_color_buffer_float}get WEBGL_compressed_texture_etc1(){return this._WEBGL_compressed_texture_etc1}get WEBGL_compressed_texture_pvrtc(){return this._WEBGL_compressed_texture_pvrtc}get WEBGL_compressed_texture_astc(){return this._WEBGL_compressed_texture_astc}get WEBGL_compressed_texture_s3tc(){return this._WEBGL_compressed_texture_s3tc}get WEBGL_compressed_texture_s3tc_srgb(){return this._WEBGL_compressed_texture_s3tc_srgb}get WEBGL_debug_shaders(){return this._WEBGL_debug_shaders}get WEBGL_draw_buffers(){return this._WEBGL_draw_buffers}get WEBGL_lose_context(){return this._WEBGL_lose_context}get WEBGL_depth_texture(){return this._WEBGL_depth_texture}get WEBGL_debug_renderer_info(){return this._WEBGL_debug_renderer_info}get OES_texture_half_float(){return this._OES_texture_half_float}get OES_texture_half_float_linear(){return this._OES_texture_half_float_linear}get OES_texture_float(){return this._OES_texture_float}get OES_standard_derivatives(){return this._OES_standard_derivatives}get OES_element_index_uint(){return this._OES_element_index_uint}get ANGLE_instanced_arrays(){return this._ANGLE_instanced_arrays}initialize(e){this._canvas=e.canvasElm,void 0!==e.isAntialias&&(this._isAntialias=e.isAntialias),void 0!==e.isPremultipliedAlpha&&(this._isPremultipliedAlpha=e.isPremultipliedAlpha),void 0!==e.bindingMappingInfo&&(this._bindingMappingInfo=e.bindingMappingInfo),this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{const e={alpha:Bc.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",e)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener("webglcontextlost",this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=Es.WEBGL,this._deviceName="WebGL";const t=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=t.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR)),this._version=t.getParameter(t.VERSION),this._maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=t.getParameter(t.DEPTH_BITS),this._stencilBits=t.getParameter(t.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=En.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=En.D24S8:this._depthStencilFmt=En.D24:8===this._stencilBits?this._depthStencilFmt=En.D16S8:this._depthStencilFmt=En.D16,this._extensions=t.getSupportedExtensions();let i="";if(this._extensions){for(const e of this._extensions)i+=e+" ";console.debug("EXTENSIONS: "+i)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),Oa.os===Oa.OS_IOS&&14===Oa.osMainVersion&&Oa.isBrowser||(this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc")),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),Oa.browserType===Oa.BROWSER_TYPE_UC&&(this._ANGLE_instanced_arrays=null),Oa.os===Oa.OS_IOS&&Oa.osMainVersion<=10&&(this._destroyShadersImmediately=!1),this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[As.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[As.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[As.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[As.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[As.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[As.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[As.FORMAT_RGB8]=!0,this._WEBGL_depth_texture&&(this._features[As.FORMAT_D16]=!0,this._features[As.FORMAT_D24]=!0,this._features[As.FORMAT_D24S8]=!0),this._OES_element_index_uint&&(this._features[As.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[As.INSTANCED_ARRAYS]=!0);let n="";this._WEBGL_compressed_texture_etc1&&(this._features[As.FORMAT_ETC1]=!0,n+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[As.FORMAT_ETC2]=!0,n+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[As.FORMAT_DXT]=!0,n+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[As.FORMAT_PVRTC]=!0,n+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[As.FORMAT_ASTC]=!0,n+="astc "),this._OES_vertex_array_object&&(this._useVAO=!0),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+n),this.initStates(t),this._queue=this.createQueue({type:Qn.GRAPHICS});this._webGLRC.canvas;this.nullTex2D=new lz(this),this.nullTex2D.initialize({type:Un.TEX2D,usage:Gn.SAMPLED,format:En.RGBA8,width:2,height:2,flags:Vn.GEN_MIPMAP}),this.nullTexCube=new lz(this),this.nullTexCube.initialize({type:Un.TEX2D,usage:Gn.SAMPLED,format:En.RGBA8,width:2,height:2,layerCount:6,flags:Vn.CUBEMAP|Vn.GEN_MIPMAP});const s={buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{mipLevel:0,baseArrayLayer:0,layerCount:1}},r=new Uint8Array(this.nullTex2D.size);return r.fill(0),this.copyBuffersToTexture([r],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([r,r,r,r,r,r],this.nullTexCube,[s]),!0}destroy(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener("webglcontextlost",this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._extensions=null,this._webGLRC=null}resize(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}acquire(){this.cmdAllocator.releaseCmds()}present(){const e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}createCommandBuffer(e){const t=new(e.type===jn.PRIMARY?iz:XF)(this);return t.initialize(e),t}createBuffer(e){const t=new WF(this);return t.initialize(e)?t:null}createTexture(e){const t=new lz(this);return t.initialize(e)?t:null}createSampler(e){const t=new oz(this);return t.initialize(e)?t:null}createDescriptorSet(e){const t=new fF(this);return t.initialize(e)?t:null}createShader(e){const t=new az(this);return t.initialize(e)?t:null}createInputAssembler(e){const t=new ZF(this);return t.initialize(e)?t:null}createRenderPass(e){const t=new sz(this);return t.initialize(e)?t:null}createFramebuffer(e){const t=new KF(this);return t.initialize(e)?t:null}createDescriptorSetLayout(e){const t=new $F(this);return t.initialize(e)?t:null}createPipelineLayout(e){const t=new QF(this);return t.initialize(e)?t:null}createPipelineState(e){const t=new ez(this);return t.initialize(e)?t:null}createFence(e){const t=new YF(this);return t.initialize(e)?t:null}createQueue(e){const t=new nz(this);return t.initialize(e)?t:null}copyBuffersToTexture(e,t,i){kF(this,e,t.gpuTexture,i)}copyTexImagesToTexture(e,t,i){!function(e,t,i,n){const s=e.gl,r=e.stateCache.glTexUnits[e.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=0;switch(i.glTarget){case s.TEXTURE_2D:for(let e=0;e<n.length;e++){const r=n[e];s.texSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,t[o++])}break;case s.TEXTURE_CUBE_MAP:for(let e=0;e<n.length;e++){const r=n[e],c=r.texSubres.baseArrayLayer+r.texSubres.layerCount;for(a=r.texSubres.baseArrayLayer;a<c;++a)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,t[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Vn.GEN_MIPMAP&&i.isPowerOf2&&s.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}copyFramebufferToBuffer(e,t,i){const n=this._webGLRC,s=e.gpuFramebuffer,r=s.gpuColorTextures[0].format,o=yF(r,n),a=gF(r,n),c=gs(_s[r]),l=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==s.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,s.glFramebuffer),this.stateCache.glFramebuffer=s.glFramebuffer);const h=new c(t);for(const e of i){const t=e.texExtent.width,i=e.texExtent.height;n.readPixels(e.texOffset.x,e.texOffset.y,t,i,o,a,h)}this.stateCache.glFramebuffer!==l&&(n.bindFramebuffer(n.FRAMEBUFFER,l),this.stateCache.glFramebuffer=l)}blitFramebuffer(e,t,i,n,s){}getExtension(e){const t=["","WEBKIT_","MOZ_"];for(let i=0;i<t.length;++i){const n=this.gl.getExtension(t[i]+e);if(n)return n}return null}initStates(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}_onWebGLContextLost(e){y(11e3),h(e)}copyTextureToBuffers(e,t,i){!function(e,t,i,n){const{gl:s}=e,r=e.stateCache,o=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,o);let a=0,c=0,l=1,h=1;switch(t.glTarget){case s.TEXTURE_2D:for(let e=0;e<n.length;e++){const r=n[e];s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,r.texSubres.mipLevel),a=r.texOffset.x,c=r.texOffset.y,l=r.texExtent.width,h=r.texExtent.height,s.readPixels(a,c,l,h,t.glFormat,t.glType,i[e])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}s.bindFramebuffer(s.FRAMEBUFFER,null),r.glFramebuffer=null,s.deleteFramebuffer(o)}(this,e.gpuTexture,t,i)}}e("WebGLDevice",hz),i.WebGLDevice=hz;class uz extends Ks{constructor(...e){super(...e),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(e){this._layout=e.layout;const{bindings:t,descriptorCount:i,descriptorIndices:n}=e.layout.gpuDescriptorSetLayout;this._buffers=Array(i).fill(null),this._textures=Array(i).fill(null),this._samplers=Array(i).fill(null);const s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:n};for(let e=0;e<t.length;++e){const i=t[e];for(let e=0;e<i.count;e++)s.push({type:i.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}return!0}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const e=this._gpuDescriptorSet.gpuDescriptors;for(let t=0;t<e.length;++t)e[t].type&Xs?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&Ys&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}}const _z=[10497,33648,33071,33071],dz=[1,2,4,8,16,32,64],mz=new Float32Array(4);function pz(e,t){switch(e){case En.R8:return t.UNSIGNED_BYTE;case En.R8SN:return t.BYTE;case En.R8UI:return t.UNSIGNED_BYTE;case En.R8I:return t.BYTE;case En.R16F:return t.HALF_FLOAT;case En.R16UI:return t.UNSIGNED_SHORT;case En.R16I:return t.SHORT;case En.R32F:return t.FLOAT;case En.R32UI:return t.UNSIGNED_INT;case En.R32I:return t.INT;case En.RG8:return t.UNSIGNED_BYTE;case En.RG8SN:return t.BYTE;case En.RG8UI:return t.UNSIGNED_BYTE;case En.RG8I:return t.BYTE;case En.RG16F:return t.HALF_FLOAT;case En.RG16UI:return t.UNSIGNED_SHORT;case En.RG16I:return t.SHORT;case En.RG32F:return t.FLOAT;case En.RG32UI:return t.UNSIGNED_INT;case En.RG32I:return t.INT;case En.RGB8:case En.SRGB8:return t.UNSIGNED_BYTE;case En.RGB8SN:return t.BYTE;case En.RGB8UI:return t.UNSIGNED_BYTE;case En.RGB8I:return t.BYTE;case En.RGB16F:return t.HALF_FLOAT;case En.RGB16UI:return t.UNSIGNED_SHORT;case En.RGB16I:return t.SHORT;case En.RGB32F:return t.FLOAT;case En.RGB32UI:return t.UNSIGNED_INT;case En.RGB32I:return t.INT;case En.BGRA8:case En.RGBA8:case En.SRGB8_A8:return t.UNSIGNED_BYTE;case En.RGBA8SN:return t.BYTE;case En.RGBA8UI:return t.UNSIGNED_BYTE;case En.RGBA8I:return t.BYTE;case En.RGBA16F:return t.HALF_FLOAT;case En.RGBA16UI:return t.UNSIGNED_SHORT;case En.RGBA16I:return t.SHORT;case En.RGBA32F:return t.FLOAT;case En.RGBA32UI:return t.UNSIGNED_INT;case En.RGBA32I:return t.INT;case En.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case En.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case En.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case En.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case En.RGB10A2:case En.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case En.RGB9E5:return t.FLOAT;case En.D16:return t.UNSIGNED_SHORT;case En.D16S8:return t.UNSIGNED_INT_24_8;case En.D24:return t.UNSIGNED_INT;case En.D24S8:return t.UNSIGNED_INT_24_8;case En.D32F:return t.FLOAT;case En.D32F_S8:return t.FLOAT_32_UNSIGNED_INT_24_8_REV;case En.BC1:case En.BC1_SRGB:case En.BC2:case En.BC2_SRGB:case En.BC3:case En.BC3_SRGB:case En.BC4:return t.UNSIGNED_BYTE;case En.BC4_SNORM:return t.BYTE;case En.BC5:return t.UNSIGNED_BYTE;case En.BC5_SNORM:return t.BYTE;case En.BC6H_SF16:case En.BC6H_UF16:return t.FLOAT;case En.BC7:case En.BC7_SRGB:case En.ETC_RGB8:case En.ETC2_RGB8:case En.ETC2_SRGB8:case En.ETC2_RGB8_A1:case En.ETC2_SRGB8_A1:case En.ETC2_RGB8:case En.ETC2_SRGB8:case En.EAC_R11:return t.UNSIGNED_BYTE;case En.EAC_R11SN:return t.BYTE;case En.EAC_RG11:return t.UNSIGNED_BYTE;case En.EAC_RG11SN:return t.BYTE;case En.PVRTC_RGB2:case En.PVRTC_RGBA2:case En.PVRTC_RGB4:case En.PVRTC_RGBA4:case En.PVRTC2_2BPP:case En.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case En.ASTC_RGBA_4x4:case En.ASTC_RGBA_5x4:case En.ASTC_RGBA_5x5:case En.ASTC_RGBA_6x5:case En.ASTC_RGBA_6x6:case En.ASTC_RGBA_8x5:case En.ASTC_RGBA_8x6:case En.ASTC_RGBA_8x8:case En.ASTC_RGBA_10x5:case En.ASTC_RGBA_10x6:case En.ASTC_RGBA_10x8:case En.ASTC_RGBA_10x10:case En.ASTC_RGBA_12x10:case En.ASTC_RGBA_12x12:case En.ASTC_SRGBA_4x4:case En.ASTC_SRGBA_5x4:case En.ASTC_SRGBA_5x5:case En.ASTC_SRGBA_6x5:case En.ASTC_SRGBA_6x6:case En.ASTC_SRGBA_8x5:case En.ASTC_SRGBA_8x6:case En.ASTC_SRGBA_8x8:case En.ASTC_SRGBA_10x5:case En.ASTC_SRGBA_10x6:case En.ASTC_SRGBA_10x8:case En.ASTC_SRGBA_10x10:case En.ASTC_SRGBA_12x10:case En.ASTC_SRGBA_12x12:default:return t.UNSIGNED_BYTE}}function fz(e,t){switch(e){case En.A8:return t.ALPHA;case En.L8:return t.LUMINANCE;case En.LA8:return t.LUMINANCE_ALPHA;case En.R8:return t.R8;case En.R8SN:return t.R8_SNORM;case En.R8UI:return t.R8UI;case En.R8I:return t.R8I;case En.RG8:return t.RG8;case En.RG8SN:return t.RG8_SNORM;case En.RG8UI:return t.RG8UI;case En.RG8I:return t.RG8I;case En.RGB8:return t.RGB8;case En.RGB8SN:return t.RGB8_SNORM;case En.RGB8UI:return t.RGB8UI;case En.RGB8I:return t.RGB8I;case En.BGRA8:case En.RGBA8:return t.RGBA8;case En.RGBA8SN:return t.RGBA8_SNORM;case En.RGBA8UI:return t.RGBA8UI;case En.RGBA8I:return t.RGBA8I;case En.R16I:return t.R16I;case En.R16UI:return t.R16UI;case En.R16F:return t.R16F;case En.RG16I:return t.RG16I;case En.RG16UI:return t.RG16UI;case En.RG16F:return t.RG16F;case En.RGB16I:return t.RGB16I;case En.RGB16UI:return t.RGB16UI;case En.RGB16F:return t.RGB16F;case En.RGBA16I:return t.RGBA16I;case En.RGBA16UI:return t.RGBA16UI;case En.RGBA16F:return t.RGBA16F;case En.R32I:return t.R32I;case En.R32UI:return t.R32UI;case En.R32F:return t.R32F;case En.RG32I:return t.RG32I;case En.RG32UI:return t.RG32UI;case En.RG32F:return t.RG32F;case En.RGB32I:return t.RGB32I;case En.RGB32UI:return t.RGB32UI;case En.RGB32F:return t.RGB32F;case En.RGBA32I:return t.RGBA32I;case En.RGBA32UI:return t.RGBA32UI;case En.RGBA32F:return t.RGBA32F;case En.R5G6B5:return t.RGB565;case En.RGB5A1:return t.RGB5_A1;case En.RGBA4:return t.RGBA4;case En.RGB10A2:return t.RGB10_A2;case En.RGB10A2UI:return t.RGB10_A2UI;case En.R11G11B10F:return t.R11F_G11F_B10F;case En.D16:return t.DEPTH_COMPONENT16;case En.D16S8:return t.DEPTH24_STENCIL8;case En.D24:return t.DEPTH_COMPONENT24;case En.D24S8:return t.DEPTH24_STENCIL8;case En.D32F:return t.DEPTH_COMPONENT32F;case En.D32F_S8:return t.DEPTH32F_STENCIL8;case En.BC1:return mF.COMPRESSED_RGB_S3TC_DXT1_EXT;case En.BC1_ALPHA:return mF.COMPRESSED_RGBA_S3TC_DXT1_EXT;case En.BC1_SRGB:return mF.COMPRESSED_SRGB_S3TC_DXT1_EXT;case En.BC1_SRGB_ALPHA:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case En.BC2:return mF.COMPRESSED_RGBA_S3TC_DXT3_EXT;case En.BC2_SRGB:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case En.BC3:return mF.COMPRESSED_RGBA_S3TC_DXT5_EXT;case En.BC3_SRGB:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case En.ETC_RGB8:return mF.COMPRESSED_RGB_ETC1_WEBGL;case En.ETC2_RGB8:return mF.COMPRESSED_RGB8_ETC2;case En.ETC2_SRGB8:return mF.COMPRESSED_SRGB8_ETC2;case En.ETC2_RGB8_A1:return mF.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case En.ETC2_SRGB8_A1:return mF.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case En.ETC2_RGBA8:return mF.COMPRESSED_RGBA8_ETC2_EAC;case En.ETC2_SRGB8_A8:return mF.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case En.EAC_R11:return mF.COMPRESSED_R11_EAC;case En.EAC_R11SN:return mF.COMPRESSED_SIGNED_R11_EAC;case En.EAC_RG11:return mF.COMPRESSED_RG11_EAC;case En.EAC_RG11SN:return mF.COMPRESSED_SIGNED_RG11_EAC;case En.PVRTC_RGB2:return mF.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case En.PVRTC_RGBA2:return mF.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case En.PVRTC_RGB4:return mF.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case En.PVRTC_RGBA4:return mF.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case En.ASTC_RGBA_4x4:return mF.COMPRESSED_RGBA_ASTC_4x4_KHR;case En.ASTC_RGBA_5x4:return mF.COMPRESSED_RGBA_ASTC_5x4_KHR;case En.ASTC_RGBA_5x5:return mF.COMPRESSED_RGBA_ASTC_5x5_KHR;case En.ASTC_RGBA_6x5:return mF.COMPRESSED_RGBA_ASTC_6x5_KHR;case En.ASTC_RGBA_6x6:return mF.COMPRESSED_RGBA_ASTC_6x6_KHR;case En.ASTC_RGBA_8x5:return mF.COMPRESSED_RGBA_ASTC_8x5_KHR;case En.ASTC_RGBA_8x6:return mF.COMPRESSED_RGBA_ASTC_8x6_KHR;case En.ASTC_RGBA_8x8:return mF.COMPRESSED_RGBA_ASTC_8x8_KHR;case En.ASTC_RGBA_10x5:return mF.COMPRESSED_RGBA_ASTC_10x5_KHR;case En.ASTC_RGBA_10x6:return mF.COMPRESSED_RGBA_ASTC_10x6_KHR;case En.ASTC_RGBA_10x8:return mF.COMPRESSED_RGBA_ASTC_10x8_KHR;case En.ASTC_RGBA_10x10:return mF.COMPRESSED_RGBA_ASTC_10x10_KHR;case En.ASTC_RGBA_12x10:return mF.COMPRESSED_RGBA_ASTC_12x10_KHR;case En.ASTC_RGBA_12x12:return mF.COMPRESSED_RGBA_ASTC_12x12_KHR;case En.ASTC_SRGBA_4x4:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case En.ASTC_SRGBA_5x4:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case En.ASTC_SRGBA_5x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case En.ASTC_SRGBA_6x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case En.ASTC_SRGBA_6x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case En.ASTC_SRGBA_8x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case En.ASTC_SRGBA_8x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case En.ASTC_SRGBA_8x8:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case En.ASTC_SRGBA_10x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case En.ASTC_SRGBA_10x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case En.ASTC_SRGBA_10x8:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case En.ASTC_SRGBA_10x10:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case En.ASTC_SRGBA_12x10:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case En.ASTC_SRGBA_12x12:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function gz(e,t){switch(e){case En.A8:return t.ALPHA;case En.L8:return t.LUMINANCE;case En.LA8:return t.LUMINANCE_ALPHA;case En.R8:case En.R8SN:return t.RED;case En.R8UI:case En.R8I:return t.RED;case En.RG8:case En.RG8SN:case En.RG8UI:case En.RG8I:return t.RG;case En.RGB8:case En.RGB8SN:case En.RGB8UI:case En.RGB8I:return t.RGB;case En.BGRA8:case En.RGBA8:case En.RGBA8SN:case En.RGBA8UI:case En.RGBA8I:return t.RGBA;case En.R16UI:case En.R16I:case En.R16F:return t.RED;case En.RG16UI:case En.RG16I:case En.RG16F:return t.RG;case En.RGB16UI:case En.RGB16I:case En.RGB16F:return t.RGB;case En.RGBA16UI:case En.RGBA16I:case En.RGBA16F:return t.RGBA;case En.R32UI:case En.R32I:case En.R32F:return t.RED;case En.RG32UI:case En.RG32I:case En.RG32F:return t.RG;case En.RGB32UI:case En.RGB32I:case En.RGB32F:return t.RGB;case En.RGBA32UI:case En.RGBA32I:case En.RGBA32F:case En.RGB10A2:return t.RGBA;case En.R11G11B10F:case En.R5G6B5:return t.RGB;case En.RGB5A1:case En.RGBA4:return t.RGBA;case En.D16:return t.DEPTH_COMPONENT;case En.D16S8:return t.DEPTH_STENCIL;case En.D24:return t.DEPTH_COMPONENT;case En.D24S8:return t.DEPTH_STENCIL;case En.D32F:return t.DEPTH_COMPONENT;case En.D32F_S8:return t.DEPTH_STENCIL;case En.BC1:return mF.COMPRESSED_RGB_S3TC_DXT1_EXT;case En.BC1_ALPHA:return mF.COMPRESSED_RGBA_S3TC_DXT1_EXT;case En.BC1_SRGB:return mF.COMPRESSED_SRGB_S3TC_DXT1_EXT;case En.BC1_SRGB_ALPHA:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case En.BC2:return mF.COMPRESSED_RGBA_S3TC_DXT3_EXT;case En.BC2_SRGB:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case En.BC3:return mF.COMPRESSED_RGBA_S3TC_DXT5_EXT;case En.BC3_SRGB:return mF.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case En.ETC_RGB8:return mF.COMPRESSED_RGB_ETC1_WEBGL;case En.ETC2_RGB8:return mF.COMPRESSED_RGB8_ETC2;case En.ETC2_SRGB8:return mF.COMPRESSED_SRGB8_ETC2;case En.ETC2_RGB8_A1:return mF.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case En.ETC2_SRGB8_A1:return mF.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case En.ETC2_RGBA8:return mF.COMPRESSED_RGBA8_ETC2_EAC;case En.ETC2_SRGB8_A8:return mF.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case En.EAC_R11:return mF.COMPRESSED_R11_EAC;case En.EAC_R11SN:return mF.COMPRESSED_SIGNED_R11_EAC;case En.EAC_RG11:return mF.COMPRESSED_RG11_EAC;case En.EAC_RG11SN:return mF.COMPRESSED_SIGNED_RG11_EAC;case En.PVRTC_RGB2:return mF.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case En.PVRTC_RGBA2:return mF.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case En.PVRTC_RGB4:return mF.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case En.PVRTC_RGBA4:return mF.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case En.ASTC_RGBA_4x4:return mF.COMPRESSED_RGBA_ASTC_4x4_KHR;case En.ASTC_RGBA_5x4:return mF.COMPRESSED_RGBA_ASTC_5x4_KHR;case En.ASTC_RGBA_5x5:return mF.COMPRESSED_RGBA_ASTC_5x5_KHR;case En.ASTC_RGBA_6x5:return mF.COMPRESSED_RGBA_ASTC_6x5_KHR;case En.ASTC_RGBA_6x6:return mF.COMPRESSED_RGBA_ASTC_6x6_KHR;case En.ASTC_RGBA_8x5:return mF.COMPRESSED_RGBA_ASTC_8x5_KHR;case En.ASTC_RGBA_8x6:return mF.COMPRESSED_RGBA_ASTC_8x6_KHR;case En.ASTC_RGBA_8x8:return mF.COMPRESSED_RGBA_ASTC_8x8_KHR;case En.ASTC_RGBA_10x5:return mF.COMPRESSED_RGBA_ASTC_10x5_KHR;case En.ASTC_RGBA_10x6:return mF.COMPRESSED_RGBA_ASTC_10x6_KHR;case En.ASTC_RGBA_10x8:return mF.COMPRESSED_RGBA_ASTC_10x8_KHR;case En.ASTC_RGBA_10x10:return mF.COMPRESSED_RGBA_ASTC_10x10_KHR;case En.ASTC_RGBA_12x10:return mF.COMPRESSED_RGBA_ASTC_12x10_KHR;case En.ASTC_RGBA_12x12:return mF.COMPRESSED_RGBA_ASTC_12x12_KHR;case En.ASTC_SRGBA_4x4:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case En.ASTC_SRGBA_5x4:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case En.ASTC_SRGBA_5x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case En.ASTC_SRGBA_6x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case En.ASTC_SRGBA_6x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case En.ASTC_SRGBA_8x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case En.ASTC_SRGBA_8x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case En.ASTC_SRGBA_8x8:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case En.ASTC_SRGBA_10x5:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case En.ASTC_SRGBA_10x6:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case En.ASTC_SRGBA_10x8:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case En.ASTC_SRGBA_10x10:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case En.ASTC_SRGBA_12x10:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case En.ASTC_SRGBA_12x12:return mF.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function vz(e,t){switch(e){case Tn.BOOL:return t.BOOL;case Tn.BOOL2:return t.BOOL_VEC2;case Tn.BOOL3:return t.BOOL_VEC3;case Tn.BOOL4:return t.BOOL_VEC4;case Tn.INT:return t.INT;case Tn.INT2:return t.INT_VEC2;case Tn.INT3:return t.INT_VEC3;case Tn.INT4:return t.INT_VEC4;case Tn.UINT:return t.UNSIGNED_INT;case Tn.FLOAT:return t.FLOAT;case Tn.FLOAT2:return t.FLOAT_VEC2;case Tn.FLOAT3:return t.FLOAT_VEC3;case Tn.FLOAT4:return t.FLOAT_VEC4;case Tn.MAT2:return t.FLOAT_MAT2;case Tn.MAT2X3:return t.FLOAT_MAT2x3;case Tn.MAT2X4:return t.FLOAT_MAT2x4;case Tn.MAT3X2:return t.FLOAT_MAT3x2;case Tn.MAT3:return t.FLOAT_MAT3;case Tn.MAT3X4:return t.FLOAT_MAT3x4;case Tn.MAT4X2:return t.FLOAT_MAT4x2;case Tn.MAT4X3:return t.FLOAT_MAT4x3;case Tn.MAT4:return t.FLOAT_MAT4;case Tn.SAMPLER2D:return t.SAMPLER_2D;case Tn.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case Tn.SAMPLER3D:return t.SAMPLER_3D;case Tn.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Tn.UNKNOWN}}function yz(e,t){switch(e){case t.BOOL:return Tn.BOOL;case t.BOOL_VEC2:return Tn.BOOL2;case t.BOOL_VEC3:return Tn.BOOL3;case t.BOOL_VEC4:return Tn.BOOL4;case t.INT:return Tn.INT;case t.INT_VEC2:return Tn.INT2;case t.INT_VEC3:return Tn.INT3;case t.INT_VEC4:return Tn.INT4;case t.UNSIGNED_INT:return Tn.UINT;case t.UNSIGNED_INT_VEC2:return Tn.UINT2;case t.UNSIGNED_INT_VEC3:return Tn.UINT3;case t.UNSIGNED_INT_VEC4:return Tn.UINT4;case t.UNSIGNED_INT:return Tn.UINT;case t.FLOAT:return Tn.FLOAT;case t.FLOAT_VEC2:return Tn.FLOAT2;case t.FLOAT_VEC3:return Tn.FLOAT3;case t.FLOAT_VEC4:return Tn.FLOAT4;case t.FLOAT_MAT2:return Tn.MAT2;case t.FLOAT_MAT2x3:return Tn.MAT2X3;case t.FLOAT_MAT2x4:return Tn.MAT2X4;case t.FLOAT_MAT3x2:return Tn.MAT3X2;case t.FLOAT_MAT3:return Tn.MAT3;case t.FLOAT_MAT3x4:return Tn.MAT3X4;case t.FLOAT_MAT4x2:return Tn.MAT4X2;case t.FLOAT_MAT4x3:return Tn.MAT4X3;case t.FLOAT_MAT4:return Tn.MAT4;case t.SAMPLER_2D:return Tn.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return Tn.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return Tn.SAMPLER3D;case t.SAMPLER_CUBE:return Tn.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),Tn.UNKNOWN}}function xz(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Sz(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}const Tz=[512,513,514,515,516,517,518,519],Ez=[0,7680,7681,7682,7683,5386,34055,34056],Az=[32774,32778,32779,32774,32774],Cz=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];let bz;!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(bz||(bz={}));class Rz{constructor(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e}}class wz extends Rz{constructor(){super(bz.BEGIN_RENDER_PASS),this.gpuRenderPass=null,this.gpuFramebuffer=null,this.renderArea={x:0,y:0,width:0,height:0},this.clearColors=[],this.clearDepth=1,this.clearStencil=0}clear(){this.gpuFramebuffer=null,this.clearColors.length=0}}class Iz extends Rz{constructor(){super(bz.BIND_STATES),this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets=[],this.dynamicOffsets=[],this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=[],this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}clear(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}class Oz extends Rz{constructor(){super(bz.DRAW),this.drawInfo=new xs}clear(){}}class Pz extends Rz{constructor(){super(bz.UPDATE_BUFFER),this.gpuBuffer=null,this.buffer=null,this.offset=0,this.size=0}clear(){this.gpuBuffer=null,this.buffer=null}}class Mz extends Rz{constructor(){super(bz.COPY_BUFFER_TO_TEXTURE),this.gpuTexture=null,this.buffers=[],this.regions=[]}clear(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}class Dz{constructor(){this.cmds=new po(1),this.beginRenderPassCmds=new po(1),this.bindStatesCmds=new po(1),this.drawCmds=new po(1),this.updateBufferCmds=new po(1),this.copyBufferToTextureCmds=new po(1)}clearCmds(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}function Lz(e,t,i,n,s){if(t.usage&An.INDIRECT)t.indirects.length=n,Array.prototype.push.apply(t.indirects,i.drawInfos);else{const r=i,o=e.gl,a=e.stateCache;switch(t.glTarget){case o.ARRAY_BUFFER:a.glVAO&&(o.bindVertexArray(null),a.glVAO=null),a.glArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,t.glBuffer),a.glArrayBuffer=t.glBuffer),s===r.byteLength?o.bufferSubData(t.glTarget,n,r):o.bufferSubData(t.glTarget,n,r.slice(0,s));break;case o.ELEMENT_ARRAY_BUFFER:a.glVAO&&(o.bindVertexArray(null),a.glVAO=null),a.glElementArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t.glBuffer),a.glElementArrayBuffer=t.glBuffer),s===r.byteLength?o.bufferSubData(t.glTarget,n,r):o.bufferSubData(t.glTarget,n,r.slice(0,s));break;case o.UNIFORM_BUFFER:a.glUniformBuffer!==t.glBuffer&&(o.bindBuffer(o.UNIFORM_BUFFER,t.glBuffer),a.glUniformBuffer=t.glBuffer),s===r.byteLength?o.bufferSubData(t.glTarget,n,r):o.bufferSubData(t.glTarget,n,new Float32Array(r,0,s/4));break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}}}const Bz={gpuPipelineState:null,gpuInputAssembler:null,gpuShader:null,glPrimitive:0,reverseCW:!1,invalidateAttachments:[]};function Nz(e,t,i,n,s,r,o){Bz.gpuInputAssembler=null,Bz.gpuShader=null;const a=e.gl,c=e.stateCache;let l=0;if(i&&t){if(c.glFramebuffer!==i.glFramebuffer){a.bindFramebuffer(a.FRAMEBUFFER,i.glFramebuffer),c.glFramebuffer=i.glFramebuffer;const t=!!i.glFramebuffer;if(t!==Bz.reverseCW){Bz.reverseCW=t;const i=!e.stateCache.rs.isFrontFaceCCW;a.frontFace(i?a.CCW:a.CW),e.stateCache.rs.isFrontFaceCCW=i}}c.viewport.left===n.x&&c.viewport.top===n.y&&c.viewport.width===n.width&&c.viewport.height===n.height||(a.viewport(n.x,n.y,n.width,n.height),c.viewport.left=n.x,c.viewport.top=n.y,c.viewport.width=n.width,c.viewport.height=n.height),c.scissorRect.x===n.x&&c.scissorRect.y===n.y&&c.scissorRect.width===n.width&&c.scissorRect.height===n.height||(a.scissor(n.x,n.y,n.width,n.height),c.scissorRect.x=n.x,c.scissorRect.y=n.y,c.scissorRect.width=n.width,c.scissorRect.height=n.height),Bz.invalidateAttachments.length=0;for(let e=0;e<s.length;++e){const n=t.colorAttachments[e];if(n.format!==En.UNKNOWN)switch(n.loadOp){case qn.LOAD:break;case qn.CLEAR:if(c.bs.targets[0].blendColorMask!==Nn.ALL&&a.colorMask(!0,!0,!0,!0),i.isOffscreen)mz[0]=s[e].r,mz[1]=s[e].g,mz[2]=s[e].b,mz[3]=s[e].a,a.clearBufferfv(a.COLOR,e,mz);else{const e=s[0];a.clearColor(e.r,e.g,e.b,e.a),l|=a.COLOR_BUFFER_BIT}break;case qn.DISCARD:Bz.invalidateAttachments.push(a.COLOR_ATTACHMENT0+e)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==En.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case qn.LOAD:break;case qn.CLEAR:c.dss.depthWrite||a.depthMask(!0),a.clearDepth(r),l|=a.DEPTH_BUFFER_BIT;break;case qn.DISCARD:Bz.invalidateAttachments.push(a.DEPTH_ATTACHMENT)}if(_s[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case qn.LOAD:break;case qn.CLEAR:c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,65535),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,65535),a.clearStencil(o),l|=a.STENCIL_BUFFER_BIT;break;case qn.DISCARD:Bz.invalidateAttachments.push(a.STENCIL_ATTACHMENT)}}if(i.glFramebuffer&&Bz.invalidateAttachments.length&&a.invalidateFramebuffer(a.FRAMEBUFFER,Bz.invalidateAttachments),l&&a.clear(l),l&a.COLOR_BUFFER_BIT){const e=c.bs.targets[0].blendColorMask;if(e!==Nn.ALL){const t=(e&Nn.R)!==Nn.NONE,i=(e&Nn.G)!==Nn.NONE,n=(e&Nn.B)!==Nn.NONE,s=(e&Nn.A)!==Nn.NONE;a.colorMask(t,i,n,s)}}l&a.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&a.depthMask(!1),l&a.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,0),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,0))}}function Fz(e,t,i,n,s,r,o,a,c,l,h,_,d){const m=e.gl,p=e.stateCache,f=Bz.gpuShader=t&&t.gpuShader;let g=!1;if(t&&Bz.gpuPipelineState!==t){if(Bz.gpuPipelineState=t,Bz.glPrimitive=t.glPrimitive,f){const e=f.glProgram;p.glProgram!==e&&(m.useProgram(e),p.glProgram=e,g=!0)}const i=t.rs;if(i){if(p.rs.cullMode!==i.cullMode){switch(i.cullMode){case Pn.NONE:m.disable(m.CULL_FACE);break;case Pn.FRONT:m.enable(m.CULL_FACE),m.cullFace(m.FRONT);break;case Pn.BACK:m.enable(m.CULL_FACE),m.cullFace(m.BACK)}e.stateCache.rs.cullMode=i.cullMode}const t=i.isFrontFaceCCW!==Bz.reverseCW;e.stateCache.rs.isFrontFaceCCW!==t&&(m.frontFace(t?m.CCW:m.CW),e.stateCache.rs.isFrontFaceCCW=t),e.stateCache.rs.depthBias===i.depthBias&&e.stateCache.rs.depthBiasSlop===i.depthBiasSlop||(m.polygonOffset(i.depthBias,i.depthBiasSlop),e.stateCache.rs.depthBias=i.depthBias,e.stateCache.rs.depthBiasSlop=i.depthBiasSlop),e.stateCache.rs.lineWidth!==i.lineWidth&&(m.lineWidth(i.lineWidth),e.stateCache.rs.lineWidth=i.lineWidth)}const n=t.dss;n&&(p.dss.depthTest!==n.depthTest&&(n.depthTest?m.enable(m.DEPTH_TEST):m.disable(m.DEPTH_TEST),p.dss.depthTest=n.depthTest),p.dss.depthWrite!==n.depthWrite&&(m.depthMask(n.depthWrite),p.dss.depthWrite=n.depthWrite),p.dss.depthFunc!==n.depthFunc&&(m.depthFunc(Tz[n.depthFunc]),p.dss.depthFunc=n.depthFunc),p.dss.stencilTestFront===n.stencilTestFront&&p.dss.stencilTestBack===n.stencilTestBack||(n.stencilTestFront||n.stencilTestBack?m.enable(m.STENCIL_TEST):m.disable(m.STENCIL_TEST),p.dss.stencilTestFront=n.stencilTestFront,p.dss.stencilTestBack=n.stencilTestBack),p.dss.stencilFuncFront===n.stencilFuncFront&&p.dss.stencilRefFront===n.stencilRefFront&&p.dss.stencilReadMaskFront===n.stencilReadMaskFront||(m.stencilFuncSeparate(m.FRONT,Tz[n.stencilFuncFront],n.stencilRefFront,n.stencilReadMaskFront),p.dss.stencilFuncFront=n.stencilFuncFront,p.dss.stencilRefFront=n.stencilRefFront,p.dss.stencilReadMaskFront=n.stencilReadMaskFront),p.dss.stencilFailOpFront===n.stencilFailOpFront&&p.dss.stencilZFailOpFront===n.stencilZFailOpFront&&p.dss.stencilPassOpFront===n.stencilPassOpFront||(m.stencilOpSeparate(m.FRONT,Ez[n.stencilFailOpFront],Ez[n.stencilZFailOpFront],Ez[n.stencilPassOpFront]),p.dss.stencilFailOpFront=n.stencilFailOpFront,p.dss.stencilZFailOpFront=n.stencilZFailOpFront,p.dss.stencilPassOpFront=n.stencilPassOpFront),p.dss.stencilWriteMaskFront!==n.stencilWriteMaskFront&&(m.stencilMaskSeparate(m.FRONT,n.stencilWriteMaskFront),p.dss.stencilWriteMaskFront=n.stencilWriteMaskFront),p.dss.stencilFuncBack===n.stencilFuncBack&&p.dss.stencilRefBack===n.stencilRefBack&&p.dss.stencilReadMaskBack===n.stencilReadMaskBack||(m.stencilFuncSeparate(m.BACK,Tz[n.stencilFuncBack],n.stencilRefBack,n.stencilReadMaskBack),p.dss.stencilFuncBack=n.stencilFuncBack,p.dss.stencilRefBack=n.stencilRefBack,p.dss.stencilReadMaskBack=n.stencilReadMaskBack),p.dss.stencilFailOpBack===n.stencilFailOpBack&&p.dss.stencilZFailOpBack===n.stencilZFailOpBack&&p.dss.stencilPassOpBack===n.stencilPassOpBack||(m.stencilOpSeparate(m.BACK,Ez[n.stencilFailOpBack],Ez[n.stencilZFailOpBack],Ez[n.stencilPassOpBack]),p.dss.stencilFailOpBack=n.stencilFailOpBack,p.dss.stencilZFailOpBack=n.stencilZFailOpBack,p.dss.stencilPassOpBack=n.stencilPassOpBack),p.dss.stencilWriteMaskBack!==n.stencilWriteMaskBack&&(m.stencilMaskSeparate(m.BACK,n.stencilWriteMaskBack),p.dss.stencilWriteMaskBack=n.stencilWriteMaskBack));const s=t.bs;if(s){p.bs.isA2C!==s.isA2C&&(s.isA2C?m.enable(m.SAMPLE_ALPHA_TO_COVERAGE):m.disable(m.SAMPLE_ALPHA_TO_COVERAGE),p.bs.isA2C=s.isA2C),p.bs.blendColor.r===s.blendColor.r&&p.bs.blendColor.g===s.blendColor.g&&p.bs.blendColor.b===s.blendColor.b&&p.bs.blendColor.a===s.blendColor.a||(m.blendColor(s.blendColor.r,s.blendColor.g,s.blendColor.b,s.blendColor.a),p.bs.blendColor.r=s.blendColor.r,p.bs.blendColor.g=s.blendColor.g,p.bs.blendColor.b=s.blendColor.b,p.bs.blendColor.a=s.blendColor.a);const e=s.targets[0],t=p.bs.targets[0];t.blend!==e.blend&&(e.blend?m.enable(m.BLEND):m.disable(m.BLEND),t.blend=e.blend),t.blendEq===e.blendEq&&t.blendAlphaEq===e.blendAlphaEq||(m.blendEquationSeparate(Az[e.blendEq],Az[e.blendAlphaEq]),t.blendEq=e.blendEq,t.blendAlphaEq=e.blendAlphaEq),t.blendSrc===e.blendSrc&&t.blendDst===e.blendDst&&t.blendSrcAlpha===e.blendSrcAlpha&&t.blendDstAlpha===e.blendDstAlpha||(m.blendFuncSeparate(Cz[e.blendSrc],Cz[e.blendDst],Cz[e.blendSrcAlpha],Cz[e.blendDstAlpha]),t.blendSrc=e.blendSrc,t.blendDst=e.blendDst,t.blendSrcAlpha=e.blendSrcAlpha,t.blendDstAlpha=e.blendDstAlpha),t.blendColorMask!==e.blendColorMask&&(m.colorMask((e.blendColorMask&Nn.R)!==Nn.NONE,(e.blendColorMask&Nn.G)!==Nn.NONE,(e.blendColorMask&Nn.B)!==Nn.NONE,(e.blendColorMask&Nn.A)!==Nn.NONE),t.blendColorMask=e.blendColorMask)}}if(t&&t.gpuPipelineLayout&&f){const i=f.glBlocks.length,r=t.gpuPipelineLayout.dynamicOffsetIndices;for(let e=0;e<i;e++){const t=f.glBlocks[e],i=n[t.set],o=i&&i.gpuDescriptors[t.binding];if(!o||!o.gpuBuffer){u(`Buffer binding '${t.name}' at set ${t.set} binding ${t.binding} is not bounded`);continue}const a=r[t.set],c=a&&a[t.binding];let l=o.gpuBuffer.glOffset;c>=0&&(l+=s[c]),p.glBindUBOs[t.glBinding]===o.gpuBuffer.glBuffer&&p.glBindUBOOffsets[t.glBinding]===l||(l?m.bindBufferRange(m.UNIFORM_BUFFER,t.glBinding,o.gpuBuffer.glBuffer,l,o.gpuBuffer.size):m.bindBufferBase(m.UNIFORM_BUFFER,t.glBinding,o.gpuBuffer.glBuffer),p.glUniformBuffer=p.glBindUBOs[t.glBinding]=o.gpuBuffer.glBuffer,p.glBindUBOOffsets[t.glBinding]=l)}const o=f.glSamplers.length;for(let t=0;t<o;t++){var v;const i=f.glSamplers[t],s=n[i.set];let r=null!==(v=null==s?void 0:s.descriptorIndices[i.binding])&&void 0!==v?v:-1,o=s&&s.gpuDescriptors[r];for(let t=0;t<i.units.length;t++){const n=i.units[t],a=p.glTexUnits[n];if(o&&o.gpuTexture&&o.gpuSampler){if(o.gpuTexture&&o.gpuTexture.size>0){const t=o.gpuTexture;a.glTexture!==t.glTexture&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),t.glTexture?m.bindTexture(t.glTarget,t.glTexture):m.bindTexture(t.glTarget,e.nullTex2D.gpuTexture.glTexture),a.glTexture=t.glTexture);const i=o.gpuSampler;p.glSamplerUnits[n]!==i.glSampler&&(m.bindSampler(n,i.glSampler),p.glSamplerUnits[n]=i.glSampler)}o=s.gpuDescriptors[++r]}else u(`Sampler binding '${i.name}' at set ${i.set} binding ${i.binding} index ${t} is not bounded`)}}}if(i&&f&&(g||Bz.gpuInputAssembler!==i))if(Bz.gpuInputAssembler=i,e.useVAO){let e=i.glVAOs.get(f.glProgram);if(!e){let t;e=m.createVertexArray(),i.glVAOs.set(f.glProgram,e),m.bindVertexArray(e),m.bindBuffer(m.ARRAY_BUFFER,null),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null),p.glArrayBuffer=null,p.glElementArrayBuffer=null;for(let e=0;e<f.glInputs.length;e++){const n=f.glInputs[e];t=null;for(let e=0;e<i.glAttribs.length;e++){const s=i.glAttribs[e];if(s.name===n.name){t=s;break}}if(t){p.glArrayBuffer!==t.glBuffer&&(m.bindBuffer(m.ARRAY_BUFFER,t.glBuffer),p.glArrayBuffer=t.glBuffer);for(let e=0;e<t.componentCount;++e){const i=n.glLoc+e,s=t.offset+t.size*e;m.enableVertexAttribArray(i),p.glCurrentAttribLocs[i]=!0,m.vertexAttribPointer(i,t.count,t.glType,t.isNormalized,t.stride,s),m.vertexAttribDivisor(i,t.isInstanced?1:0)}}}const n=i.gpuIndexBuffer;n&&m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,n.glBuffer),m.bindVertexArray(null),m.bindBuffer(m.ARRAY_BUFFER,null),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null),p.glArrayBuffer=null,p.glElementArrayBuffer=null}p.glVAO!==e&&(m.bindVertexArray(e),p.glVAO=e)}else{for(let t=0;t<e.maxVertexAttributes;++t)p.glCurrentAttribLocs[t]=!1;for(let e=0;e<f.glInputs.length;e++){const t=f.glInputs[e];let n=null;for(let e=0;e<i.glAttribs.length;e++){const s=i.glAttribs[e];if(s.name===t.name){n=s;break}}if(n){p.glArrayBuffer!==n.glBuffer&&(m.bindBuffer(m.ARRAY_BUFFER,n.glBuffer),p.glArrayBuffer=n.glBuffer);for(let e=0;e<n.componentCount;++e){const i=t.glLoc+e,s=n.offset+n.size*e;!p.glEnabledAttribLocs[i]&&i>=0&&(m.enableVertexAttribArray(i),p.glEnabledAttribLocs[i]=!0),p.glCurrentAttribLocs[i]=!0,m.vertexAttribPointer(i,n.count,n.glType,n.isNormalized,n.stride,s),m.vertexAttribDivisor(i,n.isInstanced?1:0)}}}const t=i.gpuIndexBuffer;t&&p.glElementArrayBuffer!==t.glBuffer&&(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,t.glBuffer),p.glElementArrayBuffer=t.glBuffer);for(let t=0;t<e.maxVertexAttributes;++t)p.glEnabledAttribLocs[t]!==p.glCurrentAttribLocs[t]&&(m.disableVertexAttribArray(t),p.glEnabledAttribLocs[t]=!1)}if(t)for(let e=0;e<t.dynamicStates.length;e++){switch(t.dynamicStates[e]){case Zn.VIEWPORT:r&&(p.viewport.left===r.left&&p.viewport.top===r.top&&p.viewport.width===r.width&&p.viewport.height===r.height||(m.viewport(r.left,r.top,r.width,r.height),p.viewport.left=r.left,p.viewport.top=r.top,p.viewport.width=r.width,p.viewport.height=r.height));break;case Zn.SCISSOR:o&&(p.scissorRect.x===o.x&&p.scissorRect.y===o.y&&p.scissorRect.width===o.width&&p.scissorRect.height===o.height||(m.scissor(o.x,o.y,o.width,o.height),p.scissorRect.x=o.x,p.scissorRect.y=o.y,p.scissorRect.width=o.width,p.scissorRect.height=o.height));break;case Zn.LINE_WIDTH:a&&p.rs.lineWidth!==a&&(m.lineWidth(a),p.rs.lineWidth=a);break;case Zn.DEPTH_BIAS:c&&(p.rs.depthBias===c.constantFactor&&p.rs.depthBiasSlop===c.slopeFactor||(m.polygonOffset(c.constantFactor,c.slopeFactor),p.rs.depthBias=c.constantFactor,p.rs.depthBiasSlop=c.slopeFactor));break;case Zn.BLEND_CONSTANTS:p.bs.blendColor.r===l[0]&&p.bs.blendColor.g===l[1]&&p.bs.blendColor.b===l[2]&&p.bs.blendColor.a===l[3]||(m.blendColor(l[0],l[1],l[2],l[3]),p.bs.blendColor.r=l[0],p.bs.blendColor.g=l[1],p.bs.blendColor.b=l[2],p.bs.blendColor.a=l[3]);break;case Zn.STENCIL_WRITE_MASK:if(_)switch(_.face){case $n.FRONT:p.dss.stencilWriteMaskFront!==_.writeMask&&(m.stencilMaskSeparate(m.FRONT,_.writeMask),p.dss.stencilWriteMaskFront=_.writeMask);break;case $n.BACK:p.dss.stencilWriteMaskBack!==_.writeMask&&(m.stencilMaskSeparate(m.BACK,_.writeMask),p.dss.stencilWriteMaskBack=_.writeMask);break;case $n.ALL:p.dss.stencilWriteMaskFront===_.writeMask&&p.dss.stencilWriteMaskBack===_.writeMask||(m.stencilMask(_.writeMask),p.dss.stencilWriteMaskFront=_.writeMask,p.dss.stencilWriteMaskBack=_.writeMask)}break;case Zn.STENCIL_COMPARE_MASK:if(d)switch(d.face){case $n.FRONT:p.dss.stencilRefFront===d.reference&&p.dss.stencilReadMaskFront===d.compareMask||(m.stencilFuncSeparate(m.FRONT,Tz[p.dss.stencilFuncFront],d.reference,d.compareMask),p.dss.stencilRefFront=d.reference,p.dss.stencilReadMaskFront=d.compareMask);break;case $n.BACK:p.dss.stencilRefBack===d.reference&&p.dss.stencilReadMaskBack===d.compareMask||(m.stencilFuncSeparate(m.BACK,Tz[p.dss.stencilFuncBack],d.reference,d.compareMask),p.dss.stencilRefBack=d.reference,p.dss.stencilReadMaskBack=d.compareMask);break;case $n.ALL:p.dss.stencilRefFront===d.reference&&p.dss.stencilReadMaskFront===d.compareMask&&p.dss.stencilRefBack===d.reference&&p.dss.stencilReadMaskBack===d.compareMask||(m.stencilFunc(Tz[p.dss.stencilFuncBack],d.reference,d.compareMask),p.dss.stencilRefFront=d.reference,p.dss.stencilReadMaskFront=d.compareMask,p.dss.stencilRefBack=d.reference,p.dss.stencilReadMaskBack=d.compareMask)}}}}function zz(e,t){const i=e.gl,{gpuInputAssembler:n,gpuShader:s,glPrimitive:r}=Bz;if(n&&s)if(n.gpuIndirectBuffer){const e=n.gpuIndirectBuffer.indirects;for(let t=0;t<e.length;t++){const s=e[t],o=n.gpuIndexBuffer;if(s.instanceCount)if(o){if(s.indexCount>0){const e=s.firstIndex*o.stride;i.drawElementsInstanced(r,s.indexCount,n.glIndexType,e,s.instanceCount)}}else i.drawArraysInstanced(r,s.firstVertex,s.vertexCount,s.instanceCount);else if(o){if(s.indexCount>0){const e=s.firstIndex*o.stride;i.drawElements(r,s.indexCount,n.glIndexType,e)}}else i.drawArrays(r,s.firstVertex,s.vertexCount)}}else if(t.instanceCount)if(n.gpuIndexBuffer){if(t.indexCount>0){const e=t.firstIndex*n.gpuIndexBuffer.stride;i.drawElementsInstanced(r,t.indexCount,n.glIndexType,e,t.instanceCount)}}else i.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(n.gpuIndexBuffer){if(t.indexCount>0){const e=t.firstIndex*n.gpuIndexBuffer.stride;i.drawElements(r,t.indexCount,n.glIndexType,e)}}else i.drawArrays(r,t.firstVertex,t.vertexCount)}const Uz=new Array(bz.COUNT);function Gz(e,t){Uz.fill(0);for(let i=0;i<t.cmds.length;++i){const n=t.cmds.array[i],s=Uz[n]++;switch(n){case bz.BEGIN_RENDER_PASS:{const i=t.beginRenderPassCmds.array[s];Nz(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break}case bz.BIND_STATES:{const i=t.bindStatesCmds.array[s];Fz(e,i.gpuPipelineState,i.gpuInputAssembler,i.gpuDescriptorSets,i.dynamicOffsets,i.viewport,i.scissor,i.lineWidth,i.depthBias,i.blendConstants,i.depthBounds,i.stencilWriteMask,i.stencilCompareMask);break}case bz.DRAW:zz(e,t.drawCmds.array[s].drawInfo);break;case bz.UPDATE_BUFFER:{const i=t.updateBufferCmds.array[s];Lz(e,i.gpuBuffer,i.buffer,i.offset,i.size);break}case bz.COPY_BUFFER_TO_TEXTURE:{const i=t.copyBufferToTextureCmds.array[s];Hz(e,i.buffers,i.gpuTexture,i.regions);break}}}}function Hz(e,t,i,n){const s=e.gl,r=e.stateCache.glTexUnits[e.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=1,c=1,l=0;const h=_s[i.format].isCompressed;switch(i.glTarget){case s.TEXTURE_2D:for(let e=0;e<n.length;e++){const r=n[e];a=r.texExtent.width,c=r.texExtent.height;const l=t[o++];h?i.glInternalFmt!==mF.COMPRESSED_RGB_ETC1_WEBGL?s.compressedTexSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,a,c,i.glFormat,l):s.compressedTexImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,i.glInternalFmt,a,c,0,l):s.texSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,a,c,i.glFormat,i.glType,l)}break;case s.TEXTURE_CUBE_MAP:for(let e=0;e<n.length;e++){const r=n[e],u=r.texSubres.baseArrayLayer+r.texSubres.layerCount;for(l=r.texSubres.baseArrayLayer;l<u;++l){a=r.texExtent.width,c=r.texExtent.height;const e=t[o++];h?i.glInternalFmt!==mF.COMPRESSED_RGB_ETC1_WEBGL?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,a,c,i.glFormat,e):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,r.texSubres.mipLevel,i.glInternalFmt,a,c,0,e):s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,a,c,i.glFormat,i.glType,e)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Vn.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}class Vz extends Ss{constructor(...e){super(...e),this._gpuBuffer=null}get gpuBuffer(){return this._gpuBuffer}initialize(e){if("buffer"in e){this._isBufferView=!0;const t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:this._bakcupBuffer,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:bn.NONE,this._usage&An.INDIRECT&&(this._indirectBuffer={drawInfos:[]}),this._flags&bn.BAKUP_BUFFER&&(this._bakcupBuffer=new Uint8Array(this._size),this._device.memoryStatus.bufferSize+=this._size),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:this._bakcupBuffer,indirects:[],glTarget:0,glBuffer:null,glOffset:0},e.usage&An.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),function(e,t){const i=e.gl,n=e.stateCache,s=t.memUsage&Cn.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&An.VERTEX){t.glTarget=i.ARRAY_BUFFER;const r=i.createBuffer();r&&(t.glBuffer=r,t.size>0&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&An.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;const r=i.createBuffer();r&&(t.glBuffer=r,t.size>0&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&An.UNIFORM){t.glTarget=i.UNIFORM_BUFFER;const n=i.createBuffer();n&&t.size>0&&(t.glBuffer=n,e.stateCache.glUniformBuffer!==t.glBuffer&&(i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,s),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&An.INDIRECT||t.usage&An.TRANSFER_DST||t.usage&An.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}destroy(){this._gpuBuffer&&(this._isBufferView||(!function(e,t){const i=e.gl;if(t.glBuffer){switch(t.glTarget){case i.ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(i.bindVertexArray(null),e.stateCache.glVAO=null),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case i.ELEMENT_ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(i.bindVertexArray(null),e.stateCache.glVAO=null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case i.UNIFORM_BUFFER:i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}i.deleteBuffer(t.glBuffer),t.glBuffer=null}}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null),this._bakcupBuffer=null}resize(e){if(this._isBufferView)return void console.warn("cannot resize buffer views!");const t=this._size;if(t!==e){if(this._size=e,this._count=this._size/this._stride,this._bakcupBuffer){const i=this._bakcupBuffer;this._bakcupBuffer=new Uint8Array(this._size),this._bakcupBuffer.set(i),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e}this._gpuBuffer&&(this._bakcupBuffer&&(this._gpuBuffer.buffer=this._bakcupBuffer),this._gpuBuffer.size=e,e>0&&(!function(e,t){const i=e.gl,n=e.stateCache,s=t.memUsage&Cn.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&An.VERTEX?(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),n.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,s):i.bufferData(i.ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),n.glArrayBuffer=null):t.usage&An.INDEX?(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,s):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&An.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,s),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&An.INDIRECT||t.usage&An.TRANSFER_DST||t.usage&An.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e))}}update(e,t,i){if(this._isBufferView)return void console.warn("cannot update through buffer views!");let n;if(n=void 0!==i?i:this._usage&An.INDIRECT?0:e.byteLength,this._bakcupBuffer&&e!==this._bakcupBuffer.buffer){const n=new Uint8Array(e,0,i);this._bakcupBuffer.set(n,t)}Lz(this._device,this._gpuBuffer,e,t||0,n)}}class kz{constructor(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new po(t);for(let i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}alloc(e){if(this._freeIdx<0){const t=2*this._frees.length,i=this._frees;this._frees=new Array(t);const n=t-i.length;for(let t=0;t<n;++t)this._frees[t]=new e;for(let e=n,s=0;e<t;++e,++s)this._frees[e]=i[s];this._freeIdx+=n}const t=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++t.refCount,t}free(e){0==--e.refCount&&this._freeCmds.push(e)}freeCmds(e){for(let t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}release(){for(let e=0;e<this._freeCmds.length;++e){const t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}class Wz{constructor(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new kz(wz,1),this.bindStatesCmdPool=new kz(Iz,1),this.drawCmdPool=new kz(Oz,1),this.updateBufferCmdPool=new kz(Pz,1),this.copyBufferToTextureCmdPool=new kz(Mz,1)}clearCmds(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}releaseCmds(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}class jz extends Ts{constructor(...e){super(...e),this.cmdPackage=new Dz,this._webGLAllocator=null,this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUDescriptorSets=[],this._curGPUInputAssembler=null,this._curDynamicOffsets=[],this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._isStateInvalied=!1}initialize(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;const t=this._device.bindingMappingInfo.bufferOffsets.length;for(let e=0;e<t;e++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0}destroy(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}begin(e,t=0,i){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(let e=0;e<this._curDynamicOffsets.length;e++)this._curDynamicOffsets[e].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(e,t,i,n,s,r){const o=this._webGLAllocator.beginRenderPassCmdPool.alloc(wz);o.gpuRenderPass=e.gpuRenderPass,o.gpuFramebuffer=t.gpuFramebuffer,o.renderArea=i;for(let e=0;e<n.length;++e)o.clearColors[e]=n[e];o.clearDepth=s,o.clearStencil=r,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(bz.BEGIN_RENDER_PASS),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(e){const t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}bindDescriptorSet(e,t,i){const n=t.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=n,this._isStateInvalied=!0),i){const t=this._curDynamicOffsets[e];for(let e=0;e<i.length;e++)t[e]=i[e];t.length=i.length,this._isStateInvalied=!0}}bindInputAssembler(e){const t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}setViewport(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth}}setScissor(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}setLineWidth(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}setDepthBias(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}setBlendConstants(e){4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3]||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,e),this._isStateInvalied=!0)}setDepthBound(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}setStencilWriteMask(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}setStencilCompareMask(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}draw(e){if(this._type===jn.PRIMARY&&this._isInRenderPass||this._type===jn.SECONDARY){this._isStateInvalied&&this.bindStates();const t=this._webGLAllocator.drawCmdPool.alloc(Oz);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(bz.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;const i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState){switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(e,t,i,n){if(this._type===jn.PRIMARY&&!this._isInRenderPass||this._type===jn.SECONDARY){const s=e.gpuBuffer;if(s){const r=this._webGLAllocator.updateBufferCmdPool.alloc(Pz);let o;o=void 0!==n?n:e.usage&An.INDIRECT?0:t.byteLength;const a=t;r.gpuBuffer=s,r.buffer=a,r.offset=void 0!==i?i:0,r.size=o,this.cmdPackage.updateBufferCmds.push(r),this.cmdPackage.cmds.push(bz.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}copyBuffersToTexture(e,t,i){if(this._type===jn.PRIMARY&&!this._isInRenderPass||this._type===jn.SECONDARY){const n=t.gpuTexture;if(n){const t=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(Mz);t.gpuTexture=n,t.buffers=e,t.regions=i,this.cmdPackage.copyBufferToTextureCmds.push(t),this.cmdPackage.cmds.push(bz.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}execute(e,t){for(let i=0;i<t;++i){const t=e[i];for(let e=0;e<t.cmdPackage.beginRenderPassCmds.length;++e){const i=t.cmdPackage.beginRenderPassCmds.array[e];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(let e=0;e<t.cmdPackage.bindStatesCmds.length;++e){const i=t.cmdPackage.bindStatesCmds.array[e];++i.refCount,this.cmdPackage.bindStatesCmds.push(i)}for(let e=0;e<t.cmdPackage.drawCmds.length;++e){const i=t.cmdPackage.drawCmds.array[e];++i.refCount,this.cmdPackage.drawCmds.push(i)}for(let e=0;e<t.cmdPackage.updateBufferCmds.length;++e){const i=t.cmdPackage.updateBufferCmds.array[e];++i.refCount,this.cmdPackage.updateBufferCmds.push(i)}for(let e=0;e<t.cmdPackage.copyBufferToTextureCmds.length;++e){const i=t.cmdPackage.copyBufferToTextureCmds.array[e];++i.refCount,this.cmdPackage.copyBufferToTextureCmds.push(i)}this.cmdPackage.cmds.concat(t.cmdPackage.cmds.array),this._numDrawCalls+=t._numDrawCalls,this._numInstances+=t._numInstances,this._numTris+=t._numTris}}get webGLDevice(){return this._device}bindStates(){const e=this._webGLAllocator.bindStatesCmdPool.alloc(Iz);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets);for(let t=0;t<this._curDynamicOffsets.length;t++)Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets[t]);e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,Array.prototype.push.apply(e.blendConstants,this._curBlendConstants),e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(bz.BIND_STATES),this._isStateInvalied=!1}}class qz extends Js{constructor(...e){super(...e),this._sync=null}initialize(e){return!0}destroy(){}wait(){if(this._sync){const e=this._device.gl;e.clientWaitSync(this._sync,0,e.TIMEOUT_IGNORED)}}reset(){if(this._sync){this._device.gl.deleteSync(this._sync),this._sync=null}}insert(){const e=this._device.gl;this._sync&&e.deleteSync(this._sync),this._sync=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0)}}class Xz extends Rs{constructor(...e){super(...e),this._gpuFramebuffer=null}get gpuFramebuffer(){return this._gpuFramebuffer}initialize(e){if(this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null,e.depStencilMipmapLevel&&0!==e.depStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0."),e.colorMipmapLevels&&e.colorMipmapLevels.length>0)for(let t=0;t<e.colorMipmapLevels.length;++t)0!==e.colorMipmapLevels[t]&&console.warn(`The mipmap level of th texture image to be attached of color attachment ${t} should be 0. Convert to 0.`);const t=[];if(void 0!==e.colorTextures)for(let i=0;i<e.colorTextures.length;i++){const n=e.colorTextures[i];n&&t.push(n.gpuTexture)}let i=null;return e.depthStencilTexture&&(i=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:i,glFramebuffer:null},function(e,t){if(!t.gpuColorTextures.length&&!t.gpuDepthStencilTexture)return;const i=e.gl,n=[],s=i.createFramebuffer();if(s){t.glFramebuffer=s,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(let e=0;e<t.gpuColorTextures.length;++e){const s=t.gpuColorTextures[e];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.RENDERBUFFER,s.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+e))}const r=t.gpuDepthStencilTexture;if(r){const e=_s[r.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;r.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,e,r.glTarget,r.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,e,i.RENDERBUFFER,r.glRenderbuffer)}i.drawBuffers(n);const o=i.checkFramebufferStatus(i.FRAMEBUFFER);if(o!==i.FRAMEBUFFER_COMPLETE)switch(o){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}(this._device,this._gpuFramebuffer),!0}destroy(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)}}class Yz extends Ps{constructor(...e){super(...e),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{const e=this._vertexBuffers[0];this._vertexCount=e.size/e.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;const t=new Array(e.vertexBuffers.length);for(let i=0;i<e.vertexBuffers.length;++i){const n=e.vertexBuffers[i];n.gpuBuffer&&(t[i]=n.gpuBuffer)}let i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer,i))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Illegal index buffer stride.")}let s=null;return void 0!==e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:t,gpuIndexBuffer:i,gpuIndirectBuffer:s,glAttribs:[],glIndexType:n,glVAOs:new Map},function(e,t){const i=e.gl;t.glAttribs=new Array(t.attributes.length);const n=[0,0,0,0,0,0,0,0];for(let e=0;e<t.attributes.length;++e){const s=t.attributes[e],r=void 0!==s.stream?s.stream:0,o=t.gpuVertexBuffers[r],a=pz(s.format,i),c=_s[s.format].size;t.glAttribs[e]={name:s.name,glBuffer:o.glBuffer,glType:a,size:c,count:_s[s.format].count,stride:o.stride,componentCount:Sz(a,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[r]},n[r]+=c}}(this._device,this._gpuInputAssembler),!0}destroy(){const e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){const i=t.glVAOs.values();let n=i.next();for(;!n.done;)e.gl.deleteVertexArray(n.value),n=i.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null}}class Kz extends $s{constructor(...e){super(...e),this._gpuDescriptorSetLayout=null}get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}initialize(e){Array.prototype.push.apply(this._bindings,e.bindings);let t=0;for(let e=0;e<this._bindings.length;e++){const i=this._bindings[e];this._descriptorIndices.push(t),t+=i.count}this._descriptorIndices.push(t);const i=[];for(let e=0;e<this._bindings.length;e++){const t=this._bindings[e];if(t.descriptorType&Zs)for(let n=0;n<t.count;n++)i.push(e)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:i,descriptorIndices:this._descriptorIndices,descriptorCount:t},!0}destroy(){this._bindings.length=0}}class Zz extends Qs{constructor(...e){super(...e),this._gpuPipelineLayout=null}get gpuPipelineLayout(){return this._gpuPipelineLayout}initialize(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);const t=[],i=[],n=[];let s=0,r=0;for(let e=0;e<this._setLayouts.length;e++){const o=this._setLayouts[e],a=o.gpuDescriptorSetLayout.dynamicBindings,c=o.bindings,l=[];i.push(o.gpuDescriptorSetLayout);for(let e=0,t=0;e<c.length;e++)if(a[t]===e)for(l.push(r);a[t]===e;)t++,r++;else l.push(-1);t.push(l),n.push(s),s+=a.length}return this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetCount:s,dynamicOffsetOffsets:n,dynamicOffsetIndices:t},!0}destroy(){this._setLayouts.length=0}}const $z=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class Qz extends Fs{constructor(...e){super(...e),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._is=e.inputState,this._renderPass=e.renderPass,void 0!==e.dynamicStates&&(this._dynamicStates=e.dynamicStates);const t=[];for(let e=0;e<31;e++)this._dynamicStates&1<<e&&t.push(1<<e);return this._gpuPipelineState={glPrimitive:$z[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:t},!0}destroy(){this._gpuPipelineState=null}}const Jz=[];class eU extends jz{beginRenderPass(e,t,i,n,s,r){Nz(this._device,e.gpuRenderPass,t.gpuFramebuffer,i,n,s,r),this._isInRenderPass=!0}draw(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),zz(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;const t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState){switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(e,t,i,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{const s=e.gpuBuffer;if(s){let r;void 0===i&&(i=0),r=void 0!==n?n:e.usage&An.INDIRECT?0:t.byteLength,Lz(this._device,s,t,i,r)}}}copyBuffersToTexture(e,t,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{const n=t.gpuTexture;n&&Hz(this._device,e,n,i)}}execute(e,t){for(let i=0;i<t;++i){const t=e[i];Gz(this._device,t.cmdPackage),this._numDrawCalls+=t._numDrawCalls,this._numInstances+=t._numInstances,this._numTris+=t._numTris}}bindStates(){Jz.length=0;for(let e=0;e<this._curDynamicOffsets.length;e++)Array.prototype.push.apply(Jz,this._curDynamicOffsets[e]);Fz(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,Jz,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1}}class tU extends zs{constructor(...e){super(...e),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(e){return this._type=e.type,!0}destroy(){}submit(e,t){if(!this._isAsync)for(let t=0;t<e.length;t++){const i=e[t];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}t&&t.insert()}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class iU extends Hs{constructor(...e){super(...e),this._gpuRenderPass=null}get gpuRenderPass(){return this._gpuRenderPass}initialize(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subPasses&&(this._subPasses=e.subPasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}destroy(){this._gpuRenderPass=null}}class nU extends ks{constructor(...e){super(...e),this._gpuSampler=null}get gpuSampler(){return this._gpuSampler}initialize(e){return void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias),this._gpuSampler={glSampler:null,minFilter:this._state.minFilter,magFilter:this._state.magFilter,mipFilter:this._state.mipFilter,addressU:this._state.addressU,addressV:this._state.addressV,addressW:this._state.addressW,minLOD:this._state.minLOD,maxLOD:this._state.maxLOD,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},function(e,t){const i=e.gl,n=i.createSampler();n&&(t.minFilter===Fn.LINEAR||t.minFilter===Fn.ANISOTROPIC?t.mipFilter===Fn.LINEAR||t.mipFilter===Fn.ANISOTROPIC?t.glMinFilter=i.LINEAR_MIPMAP_LINEAR:t.mipFilter===Fn.POINT?t.glMinFilter=i.LINEAR_MIPMAP_NEAREST:t.glMinFilter=i.LINEAR:t.mipFilter===Fn.LINEAR||t.mipFilter===Fn.ANISOTROPIC?t.glMinFilter=i.NEAREST_MIPMAP_LINEAR:t.mipFilter===Fn.POINT?t.glMinFilter=i.NEAREST_MIPMAP_NEAREST:t.glMinFilter=i.NEAREST,t.magFilter===Fn.LINEAR||t.magFilter===Fn.ANISOTROPIC?t.glMagFilter=i.LINEAR:t.glMagFilter=i.NEAREST,t.glWrapS=_z[t.addressU],t.glWrapT=_z[t.addressV],t.glWrapR=_z[t.addressW],t.glSampler=n,i.samplerParameteri(n,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.samplerParameteri(n,i.TEXTURE_MAG_FILTER,t.glMagFilter),i.samplerParameteri(n,i.TEXTURE_WRAP_S,t.glWrapS),i.samplerParameteri(n,i.TEXTURE_WRAP_T,t.glWrapT),i.samplerParameteri(n,i.TEXTURE_WRAP_R,t.glWrapR),i.samplerParameterf(n,i.TEXTURE_MIN_LOD,t.minLOD),i.samplerParameterf(n,i.TEXTURE_MAX_LOD,t.maxLOD))}(this._device,this._gpuSampler),!0}destroy(){var e,t;this._gpuSampler&&(e=this._device,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null)}}class sU extends Ws{constructor(...e){super(...e),this._gpuShader=null}get gpuShader(){return this._gpuShader}initialize(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(let t=0;t<e.stages.length;++t){const i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.stage,source:i.source,glShader:null}}return function(e,t){const i=e.gl;for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];let s=0,r="",o=1;switch(n.type){case kn.VERTEX:r="VertexShader",s=i.VERTEX_SHADER;break;case kn.FRAGMENT:r="FragmentShader",s=i.FRAGMENT_SHADER;break;default:return void console.error("Unsupported GFXShaderType.")}const a=i.createShader(s);if(a&&(n.glShader=a,i.shaderSource(n.glShader,"#version 300 es\n"+n.source),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(r+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",n.source.replace(/^|\n/g,()=>`\n${o++} `)),console.error(i.getShaderInfoLog(n.glShader));for(let n=0;n<t.gpuStages.length;n++){const n=t.gpuStages[e];n.glShader&&(i.deleteShader(n.glShader),n.glShader=null)}return}}const n=i.createProgram();if(!n)return;t.glProgram=n;for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];i.attachShader(t.glProgram,n.glShader)}i.linkProgram(t.glProgram);for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];n.glShader&&(i.detachShader(t.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}if(!i.getProgramParameter(t.glProgram,i.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(i.getProgramInfoLog(t.glProgram));console.info("Shader '"+t.name+"' compilation successed.");const s=i.getProgramParameter(t.glProgram,i.ACTIVE_ATTRIBUTES);t.glInputs=new Array(s);for(let e=0;e<s;++e){const n=i.getActiveAttrib(t.glProgram,e);if(n){let s;const r=n.name.indexOf("[");s=-1!==r?n.name.substr(0,r):n.name;const o=i.getAttribLocation(t.glProgram,s),a=yz(n.type,i),c=xz(n.type,i);t.glInputs[e]={name:s,type:a,stride:c,count:n.size,size:c*n.size,glType:n.type,glLoc:o}}}const r=i.getProgramParameter(t.glProgram,i.ACTIVE_UNIFORM_BLOCKS);let o,a,c,l;if(r){t.glBlocks=new Array(r);for(let n=0;n<r;++n){o=i.getActiveUniformBlockName(t.glProgram,n);const s=o.indexOf("[");-1!==s&&(o=o.substr(0,s)),l=null;for(let e=0;e<t.blocks.length;e++)if(t.blocks[e].name===o){l=t.blocks[e];break}if(l){a=n,c=i.getActiveUniformBlockParameter(t.glProgram,a,i.UNIFORM_BLOCK_DATA_SIZE);const s=l.binding+(e.bindingMappingInfo.bufferOffsets[l.set]||0);i.uniformBlockBinding(t.glProgram,a,s),t.glBlocks[n]={set:l.set,binding:l.binding,idx:a,name:o,size:c,glBinding:s}}else u(`Block '${o}' does not bound`)}}if(t.samplers.length>0){t.glSamplers=new Array(t.samplers.length);for(let e=0;e<t.samplers.length;++e){const n=t.samplers[e];t.glSamplers[e]={set:n.set,binding:n.binding,name:n.name,type:n.type,units:[],glUnits:null,glType:vz(n.type,i),glLoc:-1}}}const h=i.getProgramParameter(t.glProgram,i.ACTIVE_UNIFORMS);let _=0;const d=[];for(let e=0;e<h;++e){const n=i.getActiveUniform(t.glProgram,e);if(n){const e=i.getUniformLocation(t.glProgram,n.name);if(null!==e){let s;const r=n.name.indexOf("[");s=-1!==r?n.name.substr(0,r):n.name;if(n.type===i.SAMPLER_2D||n.type===i.SAMPLER_CUBE)for(let i=0;i<t.glSamplers.length;i++){const r=t.glSamplers[i];if(r.name===s){for(let e=0;e<n.size;++e)r.units.push(_+e);r.glLoc=e,_+=n.size,d.push(r);break}}}}}if(d.length){e.stateCache.glProgram!==t.glProgram&&i.useProgram(t.glProgram);for(let e=0;e<d.length;e++){const t=d[e];t.glUnits=new Int32Array(t.units),i.uniform1iv(t.glLoc,t.glUnits)}e.stateCache.glProgram!==t.glProgram&&i.useProgram(e.stateCache.glProgram)}for(let e=0;e<t.glSamplers.length;)t.glSamplers[e].units.length?e++:(t.glSamplers[e]=t.glSamplers[t.glSamplers.length-1],t.glSamplers.length--)}(this._device,this._gpuShader),!0}destroy(){var e,t;this._gpuShader&&(e=this._device,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null)}}class rU{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=void 0,this.glBindUBOOffsets=void 0,this.glVAO=null,this.texUnit=0,this.glTexUnits=void 0,this.glSamplerUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glBindUBOs=new Array(yn),this.glBindUBOs.fill(null),this.glBindUBOOffsets=new Array(yn),this.glBindUBOOffsets.fill(0),this.glTexUnits=new Array(gn),this.glSamplerUnits=new Array(gn),this.glSamplerUnits.fill(null),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new Ms,this.dss=new Ds,this.bs=new Bs,this.glEnabledAttribLocs=new Array(fn),this.glCurrentAttribLocs=new Array(fn),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(let e=0;e<gn;++e)this.glTexUnits[e]={glTexture:null}}}class oU extends qs{constructor(...e){super(...e),this._gpuTexture=null}get gpuTexture(){return this._gpuTexture}initialize(e){return"texture"in e?(console.log("WebGL2 does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.layerCount&&(this._layerCount=e.layerCount),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=js(this._width)&&js(this._height),this._size=ms(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._flags&Vn.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){const i=e.gl;t.glInternalFmt=fz(t.format,i),t.glFormat=gz(t.format,i),t.glType=pz(t.format,i);let n=t.width,s=t.height;switch(t.type){case Un.TEX2D:{t.glTarget=i.TEXTURE_2D;const r=Math.max(n,s);if(r>e.maxTextureSize&&S(9100,r,e.maxTextureSize),t.samples===Hn.X1){const r=i.createTexture();if(r&&t.size>0){t.glTexture=r;const o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),_s[t.format].isCompressed)if(t.glInternalFmt!==mF.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<t.mipLevel;++e){const r=ds(t.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else{const e=ds(t.format,2,2,1),n=new Uint8Array(e);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternalFmt,2,2,0,n)}else for(let e=0;e<t.mipLevel;++e)i.texImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else i.deleteTexture(r)}else{const n=i.createRenderbuffer();n&&t.size>0&&(t.glRenderbuffer=n,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,dz[t.samples],t.glInternalFmt,t.width,t.height))}break}case Un.CUBE:{t.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);r>e.maxCubeMapTextureSize&&S(9100,r,e.maxTextureSize);const o=i.createTexture();if(o&&t.size>0){t.glTexture=o;const r=e.stateCache.glTexUnits[e.stateCache.texUnit];if(r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),r.glTexture=t.glTexture),_s[t.format].isCompressed)if(t.glInternalFmt!==mF.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<6;++e){n=t.width,s=t.height;for(let r=0;r<t.mipLevel;++r){const o=ds(t.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,t.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let e=0;e<6;++e){const n=ds(t.format,2,2,1),s=new Uint8Array(n);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,t.glInternalFmt,2,2,0,s)}else for(let e=0;e<6;++e){n=t.width,s=t.height;for(let r=0;r<t.mipLevel;++r)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}break}default:console.error("Unsupported GFXTextureType, create texture failed."),t.type=Un.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}destroy(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._buffer=null}resize(e,t){const i=this._size;this._width=e,this._height=t,this._size=ms(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){const i=e.gl;t.glInternalFmt=fz(t.format,i),t.glFormat=gz(t.format,i),t.glType=pz(t.format,i);let n=t.width,s=t.height;switch(t.type){case Un.TEX2D:{t.glTarget=i.TEXTURE_2D;const r=Math.max(n,s);if(r>e.maxTextureSize&&S(9100,r,e.maxTextureSize),t.samples===Hn.X1){const r=e.stateCache.glTexUnits[e.stateCache.texUnit];if(r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),r.glTexture=t.glTexture),_s[t.format].isCompressed){if(t.glInternalFmt!==mF.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<t.mipLevel;++e){const r=ds(t.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let e=0;e<t.mipLevel;++e)i.texImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else{const n=i.createRenderbuffer();n&&t.size>0&&(t.glRenderbuffer=n,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,dz[t.samples],t.glInternalFmt,t.width,t.height))}break}case Un.CUBE:{t.type=Un.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);r>e.maxCubeMapTextureSize&&S(9100,r,e.maxTextureSize);const o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),o.glTexture=t.glTexture),_s[t.format].isCompressed){if(t.glInternalFmt!==mF.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<6;++e){n=t.width,s=t.height;for(let r=0;r<t.mipLevel;++r){const o=ds(t.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,t.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}}else for(let e=0;e<6;++e){n=t.width,s=t.height;for(let r=0;r<t.mipLevel;++r)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}default:console.error("Unsupported GFXTextureType, create texture failed."),t.type=Un.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size)}}class aU extends bs{constructor(...e){super(...e),this.stateCache=new rU,this.cmdAllocator=new Wz,this.nullTex2D=null,this.nullTexCube=null,this._webGL2RC=null,this._isAntialias=!0,this._isPremultipliedAlpha=!0,this._useVAO=!0,this._bindingMappingInfo=new Cs,this._webGLContextLostHandler=null,this._extensions=null,this._EXT_texture_filter_anisotropic=null,this._OES_texture_float_linear=null,this._OES_texture_half_float_linear=null,this._EXT_color_buffer_float=null,this._EXT_disjoint_timer_query_webgl2=null,this._WEBGL_compressed_texture_etc1=null,this._WEBGL_compressed_texture_etc=null,this._WEBGL_compressed_texture_pvrtc=null,this._WEBGL_compressed_texture_astc=null,this._WEBGL_compressed_texture_s3tc=null,this._WEBGL_compressed_texture_s3tc_srgb=null,this._WEBGL_debug_renderer_info=null,this._WEBGL_texture_storage_multisample=null,this._WEBGL_debug_shaders=null,this._WEBGL_lose_context=null}get gl(){return this._webGL2RC}get isAntialias(){return this._isAntialias}get isPremultipliedAlpha(){return this._isPremultipliedAlpha}get useVAO(){return this._useVAO}get bindingMappingInfo(){return this._bindingMappingInfo}get EXT_texture_filter_anisotropic(){return this._EXT_texture_filter_anisotropic}get OES_texture_float_linear(){return this._OES_texture_float_linear}get EXT_color_buffer_float(){return this._EXT_color_buffer_float}get EXT_disjoint_timer_query_webgl2(){return this._EXT_disjoint_timer_query_webgl2}get WEBGL_compressed_texture_etc1(){return this._WEBGL_compressed_texture_etc1}get WEBGL_compressed_texture_etc(){return this._WEBGL_compressed_texture_etc}get WEBGL_compressed_texture_pvrtc(){return this._WEBGL_compressed_texture_pvrtc}get WEBGL_compressed_texture_s3tc(){return this._WEBGL_compressed_texture_s3tc}get WEBGL_compressed_texture_s3tc_srgb(){return this._WEBGL_compressed_texture_s3tc_srgb}get WEBGL_texture_storage_multisample(){return this._WEBGL_texture_storage_multisample}get WEBGL_debug_shaders(){return this._WEBGL_debug_shaders}get WEBGL_lose_context(){return this._WEBGL_lose_context}initialize(e){this._canvas=e.canvasElm,void 0!==e.isAntialias&&(this._isAntialias=e.isAntialias),void 0!==e.isPremultipliedAlpha&&(this._isPremultipliedAlpha=e.isPremultipliedAlpha),void 0!==e.bindingMappingInfo&&(this._bindingMappingInfo=e.bindingMappingInfo),this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{const e={alpha:Bc.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGL2RC=this._canvas.getContext("webgl2",e)}catch(e){return console.warn(e),!1}if(!this._webGL2RC)return console.warn("This device does not support WebGL2."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener("webglcontextlost",this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL2 device initialized."),this._gfxAPI=Es.WEBGL2,this._deviceName="WebGL2";const t=this._webGL2RC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=t.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR)),this._version=t.getParameter(t.VERSION),this._maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxUniformBufferBindings=t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),this._maxUniformBlockSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),this._maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._uboOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this._depthBits=t.getParameter(t.DEPTH_BITS),this._stencilBits=t.getParameter(t.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=En.RGBA8,32===this._depthBits?8===this._stencilBits?this._depthStencilFmt=En.D32F_S8:this._depthStencilFmt=En.D32F:24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=En.D24S8:this._depthStencilFmt=En.D24:8===this._stencilBits?this._depthStencilFmt=En.D16S8:this._depthStencilFmt=En.D16,this._extensions=t.getSupportedExtensions();let i="";if(this._extensions){for(const e of this._extensions)i+=e+" ";console.debug("EXTENSIONS: "+i)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_color_buffer_float=this.getExtension("EXT_color_buffer_float"),this._EXT_disjoint_timer_query_webgl2=this.getExtension("EXT_disjoint_timer_query_webgl2"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_texture_storage_multisample=this.getExtension("WEBGL_texture_storage_multisample"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._features.fill(!1),this._features[As.TEXTURE_FLOAT]=!0,this._features[As.TEXTURE_HALF_FLOAT]=!0,this._features[As.FORMAT_R11G11B10F]=!0,this._features[As.FORMAT_RGB8]=!0,this._features[As.FORMAT_D16]=!0,this._features[As.FORMAT_D24]=!0,this._features[As.FORMAT_D32F]=!0,this._features[As.FORMAT_D24S8]=!0,this._features[As.FORMAT_D32FS8]=!0,this._features[As.MSAA]=!0,this._features[As.ELEMENT_INDEX_UINT]=!0,this._features[As.INSTANCED_ARRAYS]=!0,this._EXT_color_buffer_float&&(this._features[As.COLOR_FLOAT]=!0,this._features[As.COLOR_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[As.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[As.TEXTURE_HALF_FLOAT_LINEAR]=!0);let n="";this._WEBGL_compressed_texture_etc1&&(this._features[As.FORMAT_ETC1]=!0,n+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[As.FORMAT_ETC2]=!0,n+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[As.FORMAT_DXT]=!0,n+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[As.FORMAT_PVRTC]=!0,n+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[As.FORMAT_ASTC]=!0,n+="astc "),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_ATTRIBS: "+this._maxVertexAttributes),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("MAX_FRAGMENT_UNIFORM_VECTORS: "+this._maxFragmentUniformVectors),console.info("MAX_TEXTURE_IMAGE_UNITS: "+this._maxTextureUnits),console.info("MAX_VERTEX_TEXTURE_IMAGE_UNITS: "+this._maxVertexTextureUnits),console.info("MAX_UNIFORM_BUFFER_BINDINGS: "+this._maxUniformBufferBindings),console.info("MAX_UNIFORM_BLOCK_SIZE: "+this._maxUniformBlockSize),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),console.info("UNIFORM_BUFFER_OFFSET_ALIGNMENT: "+this._uboOffsetAlignment),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+n),this.initStates(t),this._queue=this.createQueue({type:Qn.GRAPHICS}),this.nullTex2D=new oU(this),this.nullTex2D.initialize({type:Un.TEX2D,usage:Gn.SAMPLED,format:En.RGBA8,width:2,height:2,flags:Vn.GEN_MIPMAP}),this.nullTexCube=new oU(this),this.nullTexCube.initialize({type:Un.TEX2D,usage:Gn.SAMPLED,format:En.RGBA8,width:2,height:2,layerCount:6,flags:Vn.CUBEMAP|Vn.GEN_MIPMAP});const s={buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{mipLevel:0,baseArrayLayer:0,layerCount:1}},r=new Uint8Array(this.nullTex2D.size);return r.fill(0),this.copyBuffersToTexture([r],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([r,r,r,r,r,r],this.nullTexCube,[s]),!0}destroy(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener("webglcontextlost",this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._extensions=null,this._webGL2RC=null}resize(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}acquire(){this.cmdAllocator.releaseCmds()}present(){const e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}createCommandBuffer(e){const t=new(e.type===jn.PRIMARY?eU:jz)(this);return t.initialize(e)?t:null}createBuffer(e){const t=new Vz(this);return t.initialize(e)?t:null}createTexture(e){const t=new oU(this);return t.initialize(e)?t:null}createSampler(e){const t=new nU(this);return t.initialize(e)?t:null}createDescriptorSet(e){const t=new uz(this);return t.initialize(e)?t:null}createShader(e){const t=new sU(this);return t.initialize(e)?t:null}createInputAssembler(e){const t=new Yz(this);return t.initialize(e)?t:null}createRenderPass(e){const t=new iU(this);return t.initialize(e)?t:null}createFramebuffer(e){const t=new Xz(this);return t.initialize(e)?t:null}createDescriptorSetLayout(e){const t=new Kz(this);return t.initialize(e)?t:null}createPipelineLayout(e){const t=new Zz(this);return t.initialize(e)?t:null}createPipelineState(e){const t=new Qz(this);return t.initialize(e)?t:null}createFence(e){const t=new qz(this);return t.initialize(e)?t:null}createQueue(e){const t=new tU(this);return t.initialize(e)?t:null}copyBuffersToTexture(e,t,i){Hz(this,e,t.gpuTexture,i)}copyTexImagesToTexture(e,t,i){!function(e,t,i,n){const s=e.gl,r=e.stateCache.glTexUnits[e.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=0;switch(i.glTarget){case s.TEXTURE_2D:for(let e=0;e<n.length;e++){const r=n[e];s.texSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,t[o++])}break;case s.TEXTURE_CUBE_MAP:for(let e=0;e<n.length;e++){const r=n[e],c=r.texSubres.baseArrayLayer+r.texSubres.layerCount;for(a=r.texSubres.baseArrayLayer;a<c;++a)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,t[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Vn.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}copyFramebufferToBuffer(e,t,i){const n=this._webGL2RC,s=e.gpuFramebuffer,r=s.gpuColorTextures[0].format,o=gz(r,n),a=pz(r,n),c=gs(_s[r]),l=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==s.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,s.glFramebuffer),this.stateCache.glFramebuffer=s.glFramebuffer);const h=new c(t);for(const e of i){const t=e.texExtent.width,i=e.texExtent.height;n.readPixels(e.texOffset.x,e.texOffset.y,t,i,o,a,h)}this.stateCache.glFramebuffer!==l&&(n.bindFramebuffer(n.FRAMEBUFFER,l),this.stateCache.glFramebuffer=l)}blitFramebuffer(e,t,i,n,s){!function(e,t,i,n,s,r){const o=e.gl;e.stateCache.glReadFramebuffer!==t.glFramebuffer&&(o.bindFramebuffer(o.READ_FRAMEBUFFER,t.glFramebuffer),e.stateCache.glReadFramebuffer=t.glFramebuffer);const a=i.glFramebuffer!==e.stateCache.glFramebuffer;a&&o.bindFramebuffer(o.DRAW_FRAMEBUFFER,i.glFramebuffer);let c=0;t.gpuColorTextures.length>0&&(c|=o.COLOR_BUFFER_BIT),t.gpuDepthStencilTexture&&(c|=o.DEPTH_BUFFER_BIT,_s[t.gpuDepthStencilTexture.format].hasStencil&&(c|=o.STENCIL_BUFFER_BIT));const l=r===Fn.LINEAR||r===Fn.ANISOTROPIC?o.LINEAR:o.NEAREST;o.blitFramebuffer(n.x,n.y,n.x+n.width,n.y+n.height,s.x,s.y,s.x+s.width,s.y+s.height,c,l),a&&o.bindFramebuffer(o.FRAMEBUFFER,e.stateCache.glFramebuffer)}(this,e.gpuFramebuffer,t.gpuFramebuffer,i,n,s)}getExtension(e){const t=["","WEBKIT_","MOZ_"];for(let i=0;i<t.length;++i){const n=this.gl.getExtension(t[i]+e);if(n)return n}return null}initStates(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}_onWebGLContextLost(e){y(11e3),h(e)}copyTextureToBuffers(e,t,i){!function(e,t,i,n){const{gl:s}=e,r=e.stateCache,o=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,o);let a=0,c=0,l=1,h=1;switch(t.glTarget){case s.TEXTURE_2D:for(let e=0;e<n.length;e++){const r=n[e];s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,r.texSubres.mipLevel),a=r.texOffset.x,c=r.texOffset.y,l=r.texExtent.width,h=r.texExtent.height,s.readPixels(a,c,l,h,t.glFormat,t.glType,i[e])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}s.bindFramebuffer(s.FRAMEBUFFER,null),r.glFramebuffer=null,s.deleteFramebuffer(o)}(this,e.gpuTexture,t,i)}}e("WebGL2Device",aU),i.WebGL2Device=aU;let cU=0;class lU{constructor(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1}}class hU{constructor(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}_searchElementByTarget(e,t){for(var i=0;i<e.length;i++)if(t===e[i].target)return e[i];return null}_getElement(e,t){var i=this._elementPool.pop();return i||(i=new lU),i.target=e,i.paused=!!t,i}_putElement(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)}addAction(e,t,i){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+cU++);var n=this._hashTargets.get(t);n?n.actions||(n.actions=[]):(n=this._getElement(t,i),this._hashTargets.set(t,n),this._arrayTargets.push(n)),n.target=t,n.actions.push(e),e.startWithTarget(t)}else S(1e3)}removeAllActions(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var i=e[t];i&&this._putElement(i)}this._arrayTargets.length=0,this._hashTargets=new Map}removeAllActionsFromTarget(e){if(null!=e){var t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}}removeAction(e){if(null!=e){var t=e.getOriginalTarget(),i=this._hashTargets.get(t);if(i)for(var n=0;n<i.actions.length;n++)if(i.actions[n]===e){i.actions.splice(n,1),i.actionIndex>=n&&i.actionIndex--;break}}}_removeActionByTag(e,t,i){for(var n=0,s=t.actions.length;n<s;++n){var r=t.actions[n];if(r&&r.getTag()===e){if(i&&r.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,t);break}}}removeActionByTag(e,t){e===i.Action.TAG_INVALID&&g(1002);let n=this._hashTargets;if(t){var s=n.get(t);s&&this._removeActionByTag(e,s,t)}else n.forEach(t=>{this._removeActionByTag(e,t)})}getActionByTag(e,t){e===i.Action.TAG_INVALID&&g(1004);var n=this._hashTargets.get(t);if(n){if(null!=n.actions)for(var s=0;s<n.actions.length;++s){var r=n.actions[s];if(r&&r.getTag()===e)return r}g(1005,e)}return null}getNumberOfRunningActionsInTarget(e){var t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0}pauseTarget(e){var t=this._hashTargets.get(e);t&&(t.paused=!0)}resumeTarget(e){var t=this._hashTargets.get(e);t&&(t.paused=!1)}pauseAllRunningActions(){for(var e=[],t=this._arrayTargets,i=0;i<t.length;i++){var n=t[i];n&&!n.paused&&(n.paused=!0,e.push(n.target))}return e}resumeTargets(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])}pauseTargets(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])}purgeSharedManager(){i.director.getScheduler().unscheduleUpdate(this)}_removeActionAtIndex(e,t){t.actions[e];t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)}_deleteHashElement(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var i=this._arrayTargets,n=0,s=i.length;n<s;n++)if(i[n]===e){i.splice(n,1);break}this._putElement(e),t=!0}return t}update(e){for(var t,i=this._arrayTargets,n=0;n<i.length;n++){this._currentTarget=i[n];let r=(t=this._currentTarget).target;if(r instanceof Ua&&!r.isValid)this.removeAllActionsFromTarget(r),n--;else{if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var s=t.currentAction;t.currentAction=null,this.removeAction(s)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&n--}}}}class uU extends zI{constructor(...e){super(...e),this.actionMgr=new hU}get ActionManager(){return this.actionMgr}postUpdate(e){this.actionMgr.update(e)}}e("TweenSystem",uU),uU.ID="TWEEN",uU.instance=void 0,rO.on(sO.EVENT_INIT,(function(){let e=new uU;uU.instance=e,rO.registerSystem(uU.ID,e,100)}));class _U{constructor(){this.originalTarget=null,this.target=null,this.tag=_U.TAG_INVALID}clone(){var e=new _U;return e.originalTarget=null,e.target=null,e.tag=this.tag,e}isDone(){return!0}startWithTarget(e){this.originalTarget=e,this.target=e}stop(){this.target=null}step(e){g(1006)}update(e){g(1007)}getTarget(){return this.target}setTarget(e){this.target=e}getOriginalTarget(){return this.originalTarget}setOriginalTarget(e){this.originalTarget=e}getTag(){return this.tag}setTag(e){this.tag=e}reverse(){return g(1008),null}retain(){}release(){}}_U.TAG_INVALID=-1;class dU extends _U{constructor(...e){super(...e),this._duration=0,this._timesForRepeat=1}getDuration(){return this._duration*(this._timesForRepeat||1)}setDuration(e){this._duration=e}clone(){return new dU}}class mU extends dU{isDone(){return!0}step(e){this.update(1)}update(e){}reverse(){return this.clone()}clone(){return new mU}}class pU extends mU{update(e){for(var t=this.target.getComponentsInChildren(Qf),i=0;i<t.length;++i){t[i].enabled=!0}}reverse(){return new fU}clone(){return new pU}}class fU extends mU{update(e){for(var t=this.target.getComponentsInChildren(Qf),i=0;i<t.length;++i){t[i].enabled=!1}}reverse(){return new pU}clone(){return new fU}}class gU extends mU{constructor(e){super(),this._isNeedCleanUp=!0,void 0!==e&&this.init(e)}update(e){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()}init(e){return this._isNeedCleanUp=e,!0}reverse(){return new gU(this._isNeedCleanUp)}clone(){return new gU(this._isNeedCleanUp)}}class vU extends mU{constructor(e,t,i){super(),this._selectorTarget=null,this._function=null,this._data=null,this.initWithFunction(e,t,i)}initWithFunction(e,t,i){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==i&&(this._data=i),!0}execute(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)}update(e){this.execute()}getTargetCallback(){return this._selectorTarget}setTargetCallback(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)}clone(){var e=new vU;return e.initWithFunction(this._function,this._selectorTarget,this._data),e}}class yU extends dU{constructor(e){super(),this.MAX_VALUE=2,this._elapsed=0,this._firstTick=!1,this._easeList=[],this._speed=1,this._repeatForever=!1,this._repeatMethod=!1,this._speedMethod=!1,void 0===e||isNaN(e)||this.initWithDuration(e)}getElapsed(){return this._elapsed}initWithDuration(e){return this._duration=0===e?Bc.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0}isDone(){return this._elapsed>=this._duration}_cloneDecoration(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod}_reverseEaseList(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}}clone(){var e=new yU(this._duration);return this._cloneDecoration(e),e}easing(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this}_computeEaseTime(e){return e}step(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=1>t?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))}startWithTarget(e){_U.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0}reverse(){return g(1010),this}setAmplitudeRate(e){g(1011)}getAmplitudeRate(){return g(1012),0}speed(e){return e<=0?(g(1013),this):(this._speedMethod=!0,this._speed*=e,this)}getSpeed(){return this._speed}setSpeed(e){return this._speed=e,this}repeat(e){return e=Math.round(e),isNaN(e)||e<1?(g(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)}repeatForever(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this}}class xU extends yU{constructor(e){super(),this._actions=[],this._split=0,this._last=0,this._reversed=!1;var t=e instanceof Array?e:arguments;if(1!==t.length){var i=t.length-1;if(i>=0&&null==t[i]&&g(1015),i>=0){for(var n,s=t[0],r=1;r<i;r++)t[r]&&(n=s,s=xU._actionOneTwo(n,t[r]));this.initWithTwoActions(s,t[i])}}else S(1019)}initWithTwoActions(e,t){if(!e||!t)return S(1025),!1;var i=e._duration,n=t._duration,s=(i*=e._repeatMethod?e._timesForRepeat:1)+(n*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(s),this._actions[0]=e,this._actions[1]=t,!0}clone(){var e=new xU;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e}startWithTarget(e){yU.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1}stop(){-1!==this._last&&this._actions[this._last].stop(),_U.prototype.stop.call(this)}update(e){var t,i,n=0,s=this._split,r=this._actions,o=this._last;(e=this._computeEaseTime(e))<s?(t=0!==s?e/s:1,0===n&&1===o&&this._reversed&&(r[1].update(0),r[1].stop())):(n=1,t=1===s?1:(e-s)/(1-s),-1===o&&(r[0].startWithTarget(this.target),r[0].update(1),r[0].stop()),0===o&&(r[0].update(1),r[0].stop())),i=r[n],o===n&&i.isDone()||(o!==n&&i.startWithTarget(this.target),t*=i._timesForRepeat,i.update(t>1?t%1:t),this._last=n)}reverse(){var e=xU._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e}}function SU(e){var t=e instanceof Array?e:arguments;if(1===t.length)return S(1019),null;var i=t.length-1;i>=0&&null==t[i]&&g(1015);var n=null;if(i>=0){n=t[0];for(var s=1;s<=i;s++)t[s]&&(n=xU._actionOneTwo(n,t[s]))}return n}xU._actionOneTwo=function(e,t){var i=new xU;return i.initWithTwoActions(e,t),i};class TU extends yU{constructor(e,t){super(),this._times=0,this._total=0,this._nextDt=0,this._actionInstant=!1,this._innerAction=null,void 0!==t&&this.initWithAction(e,t)}initWithAction(e,t){var i=e._duration*t;return!!this.initWithDuration(i)&&(this._times=t,this._innerAction=e,e instanceof mU&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)}clone(){var e=new TU;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e}startWithTarget(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,yU.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}stop(){this._innerAction.stop(),_U.prototype.stop.call(this)}update(e){e=this._computeEaseTime(e);var t=this._innerAction,i=this._duration,n=this._times,s=this._nextDt;if(e>=s){for(;e>s&&this._total<n;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),s+=t._duration/i,this._nextDt=s>1?1:s;e>=1&&this._total<n&&(t.update(1),this._total++),this._actionInstant||(this._total===n?t.stop():t.update(e-(s-t._duration/i)))}else t.update(e*n%1)}isDone(){return this._total===this._times}reverse(){var e=new TU(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e}setInnerAction(e){this._innerAction!==e&&(this._innerAction=e)}getInnerAction(){return this._innerAction}}class EU extends yU{constructor(e){super(),this._innerAction=null,e&&this.initWithAction(e)}initWithAction(e){return e?(this._innerAction=e,!0):(S(1026),!1)}clone(){var e=new EU;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e}startWithTarget(e){yU.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}step(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))}isDone(){return!1}reverse(){var e=new EU(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e}setInnerAction(e){this._innerAction!==e&&(this._innerAction=e)}getInnerAction(){return this._innerAction}}class AU extends yU{constructor(e){super(),this._one=null,this._two=null;var t=e instanceof Array?e:arguments;if(1!==t.length){var i=t.length-1;if(i>=0&&null==t[i]&&g(1015),i>=0){for(var n,s=t[0],r=1;r<i;r++)t[r]&&(n=s,s=AU._actionOneTwo(n,t[r]));this.initWithTwoActions(s,t[i])}}else S(1020)}initWithTwoActions(e,t){if(!e||!t)return S(1027),!1;var i=!1,n=e._duration,s=t._duration;return this.initWithDuration(Math.max(n,s))&&(this._one=e,this._two=t,n>s?this._two=xU._actionOneTwo(t,RU(n-s)):n<s&&(this._one=xU._actionOneTwo(e,RU(s-n))),i=!0),i}clone(){var e=new AU;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e}startWithTarget(e){yU.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)}stop(){this._one.stop(),this._two.stop(),_U.prototype.stop.call(this)}update(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)}reverse(){var e=AU._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e}}function CU(e){var t=e instanceof Array?e:arguments;if(1===t.length)return S(1020),null;t.length>0&&null==t[t.length-1]&&g(1015);for(var i=t[0],n=1;n<t.length;n++)null!=t[n]&&(i=AU._actionOneTwo(i,t[n]));return i}AU._actionOneTwo=function(e,t){var i=new AU;return i.initWithTwoActions(e,t),i};class bU extends yU{update(e){}reverse(){var e=new bU(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e}clone(){var e=new bU;return this._cloneDecoration(e),e.initWithDuration(this._duration),e}}function RU(e){return new bU(e)}class wU extends yU{constructor(e){super(),this._other=null,e&&this.initWithAction(e)}initWithAction(e){return e?e===this._other?(S(1029),!1):!!yU.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(S(1028),!1)}clone(){var e=new wU;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e}startWithTarget(e){yU.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)}update(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)}reverse(){return this._other.clone()}stop(){this._other.stop(),_U.prototype.stop.call(this)}}class IU extends yU{constructor(e,t,n){if(super(),this._opts=void 0,this._props=void 0,this._originProps=void 0,null==n)n=Object.create(null);else if(function(e){const t=" [Tween:] ",n=" option is not support in v"+i.ENGINE_VERSION;e.delay&&h(t+"delay"+n),e.repeat&&h(t+"repeat"+n),e.repeatDelay&&h(t+"repeatDelay"+n),e.interpolation&&h(t+"interpolation"+n),e.onStop&&h(t+"onStop"+n)}(n),n.easing&&"string"==typeof n.easing&&(n.easing=function(e){let t=e.charAt(0);if(/[A-Z]/.test(t)){const i=(e=e.replace(t,t.toLowerCase())).split("-");if(2==i.length){const t=i[0];if("linear"==t)e="linear";else{const n=i[1];switch(t){case"quadratic":e="quad"+n;break;case"quartic":e="quart"+n;break;case"quintic":e="quint"+n;break;case"sinusoidal":e="sine"+n;break;case"exponential":e="expo"+n;break;case"circular":e="circ"+n;break;default:e=t+n}}}}return e}(n.easing)),n.progress||(n.progress=this.progress),n.easing&&"string"==typeof n.easing){let e=n.easing;n.easing=KL[e],n.easing||y(1031,e)}this._opts=n,this._props=Object.create(null);for(let e in t){let i,n,s=t[e];void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(i=i[s.easing],!i&&y(1031,s.easing)):i=s.easing,n=s.progress,s=s.value);let r=Object.create(null);r.value=s,r.easing=i,r.progress=n,this._props[e]=r}this._originProps=t,this.initWithDuration(e)}clone(){var e=new IU(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e}startWithTarget(e){yU.prototype.startWithTarget.call(this,e);const t=!!this._opts.relative,i=this._props;for(var n in i){const r=e[n];if(void 0===r)continue;const o=i[n],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=t?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)o.start[s]=r[s],o.current[s]=r[s],o.end[s]=t?r[s]+a[s]:a[s]}this._opts.onStart&&this._opts.onStart(this.target)}update(e){const t=this.target;if(!t)return;const i=this._props,n=this._opts;let s=e;n.easing&&(s=n.easing(e));let r=n.progress;for(const n in i){let o=i[n],a=o.easing?o.easing(e):s,c=o.progress?o.progress:r;const l=o.start,h=o.end;if("number"==typeof l)o.current=c(l,h,o.current,a);else if("object"==typeof l)for(const e in l)o.current[e]=c(l[e],h[e],o.current[e],a);t[n]=o.current}n.onUpdate&&n.onUpdate(this.target,e),1==e&&n.onComplete&&n.onComplete(this.target)}progress(e,t,i,n){return e+(t-e)*n}}class OU extends mU{constructor(e){super(),this._props=void 0,this._props={},void 0!==e&&this.init(e)}init(e){for(let t in e)this._props[t]=e[t];return!0}update(){let e=this._props,t=this.target;for(let i in e)t[i]=e[i]}clone(){var e=new OU;return e.init(this._props),e}}class PU{constructor(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=_U.TAG_INVALID,this._target=void 0===e?null:e}tag(e){return this._tag=e,this}then(e){return e instanceof _U?this._actions.push(e.clone()):this._actions.push(e._union()),this}target(e){return this._target=e,this}start(){return this._target?(this._finalAction&&uU.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),uU.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(h("Please set target to tween first"),this)}stop(){return this._finalAction&&uU.instance.ActionManager.removeAction(this._finalAction),this}clone(e){let t=this._union();return MU(e).then(t.clone())}union(){let e=this._union();return this._actions.length=0,this._actions.push(e),this}to(e,t,i){(i=i||Object.create(null)).relative=!1;const n=new IU(e,t,i);return this._actions.push(n),this}by(e,t,i){(i=i||Object.create(null)).relative=!0;const n=new IU(e,t,i);return this._actions.push(n),this}set(e){const t=new OU(e);return this._actions.push(t),this}delay(e){const t=RU(e);return this._actions.push(t),this}call(e){const t=new vU(e,i,n);var i,n;return this._actions.push(t),this}sequence(...e){const t=PU._wrappedSequence(...e);return this._actions.push(t),this}parallel(...e){const t=PU._wrappedParallel(...e);return this._actions.push(t),this}repeat(e,t){if(e==1/0)return this.repeatForever(t);const i=this._actions;let n;return n=t instanceof PU?t._union():i.pop(),i.push(function(e,t){return new TU(e,t)}(n,e)),this}repeatForever(e){const t=this._actions;let i;return i=e instanceof PU?e._union():t.pop(),t.push(function(e){return new EU(e)}(i)),this}reverseTime(e){const t=this._actions;let i;return i=e instanceof PU?e._union():t.pop(),t.push(function(e){return new wU(e)}(i)),this}hide(){let e=new fU;return this._actions.push(e),this}show(){let e=new pU;return this._actions.push(e),this}removeSelf(){let e=new gU(!1);return this._actions.push(e),this}static stopAll(){uU.instance.ActionManager.removeAllActions()}static stopAllByTag(e,t){uU.instance.ActionManager.removeActionByTag(e,t)}static stopAllByTarget(e){uU.instance.ActionManager.removeAllActionsFromTarget(e)}_union(){let e,t=this._actions;return e=1===t.length?t[0]:SU(t),e}_destroy(){this.stop()}static _wrappedSequence(...e){const t=PU._tmp_args;t.length=0;for(let i=e.length,n=0;n<i;n++){let i=t[n]=e[n];i instanceof PU&&(t[n]=i._union())}return SU.apply(SU,t)}static _wrappedParallel(...e){const t=PU._tmp_args;t.length=0;for(let i=e.length,n=0;n<i;n++){let i=t[n]=e[n];i instanceof PU&&(t[n]=i._union())}return CU.apply(CU,t)}}function MU(e){return new PU(e)}function DU(e){return h("tweenUtil' is deprecated, please use 'tween' instead "),new PU(e)}var LU,BU,NU,FU,zU,UU,GU,HU,VU,kU,WU,jU,qU,XU,YU,KU,ZU,$U,QU,JU,eG,tG;e("Tween",PU),PU._tmp_args=[],i.Tween=PU,i.tween=MU,i.tweenUtil=DU;const iG=new _i,nG=Ye({SOLID_COLOR:Jn.ALL,DEPTH_ONLY:Jn.DEPTH_STENCIL,DONT_CLEAR:Jn.NONE}),sG=Ye({OVERLAY:0,INTERSPERSE:1});let rG=function(t){return e({Canvas:t,CanvasComponent:t}),t}((LU=Go("cc.Canvas"),BU=ta(),NU=Vo(100),FU=Ho(xd),zU=$o(),UU=va(nG),GU=ra(),HU=ra(),VU=va(sG),kU=ra(),WU=ra(),jU=va(Eu),qU=ra(),XU=va(nG),YU=va(sG),LU(KU=BU(KU=NU(KU=FU(KU=zU(KU=Zo(KU=ko((Po((ZU=class extends f_{get clearFlag(){return this._clearFlag}set clearFlag(e){this._clearFlag=e,this._camera&&(this._camera.clearFlag=this._clearFlag)}get color(){return this._color}set color(e){Fi.copy(this._color,e),this._camera&&(this._camera.clearColor.r=e.r/255,this._camera.clearColor.g=e.g/255,this._camera.clearColor.b=e.b/255,this._camera.clearColor.a=e.a/255)}get renderMode(){return this._renderMode}set renderMode(e){this._renderMode=e,this._camera&&(this._camera.priority=this._getViewPriority())}get priority(){return this._priority}set priority(e){this._priority=e,this._camera&&(this._camera.priority=this._getViewPriority()),rO.root&&rO.root.ui&&rO.root.ui.sortScreens()}get targetTexture(){return this._targetTexture}set targetTexture(e){if(this._targetTexture===e)return;const t=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(t),this._updateTargetTexture()}get visibility(){return this._camera?this._camera.view.visibility:-1}get camera(){return this._camera}constructor(){super(),Oo(this,"_priority",$U,this),Oo(this,"_targetTexture",QU,this),Oo(this,"_clearFlag",JU,this),Oo(this,"_color",eG,this),Oo(this,"_renderMode",tG,this),this._thisOnResized=void 0,this._camera=null,this._pos=new _i,this._thisOnResized=this.alignWithScreen.bind(this)}__preload(){const e=new kd("UICamera_"+this.node.name);e.setPosition(0,0,1e3),this._camera=rO.root.createCamera(),this._camera.initialize({name:"ui_"+this.node.name,node:e,projection:MM.ProjectionType.ORTHO,priority:this._getViewPriority(),flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=this.clearFlag,this._camera.farClip=2e3,this._camera.viewport=new Bi(0,0,1,1),this.color=this._color,this._checkTargetTextureEvent(null),this._updateTargetTexture(),FC.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),rO.root.ui.addScreen(this)}onEnable(){this._camera&&rO.root.ui.renderScene.addCamera(this._camera)}onDisable(){this._camera&&rO.root.ui.renderScene.removeCamera(this._camera)}onDestroy(){rO.root.ui.removeScreen(this),this._camera&&rO.root.destroyCamera(this._camera),this._targetTexture&&this._targetTexture.off("resize"),FC.off("design-resolution-changed",this._thisOnResized)}alignWithScreen(){let e,t;this.node.getPosition(this._pos);const n=LS;{e=n,t=FC.getDesignResolutionSize();let s=0,r=0;FC.getResolutionPolicy()===i.view._rpNoBorder&&(s=.5*(t.width-n.width),r=.5*(t.height-n.height)),_i.set(iG,.5*n.width+s,.5*n.height+r,0)}this._pos.equals(iG)||this.node.setPosition(iG);const s=this.node._uiProps.uiTransformComp;s.width!==e.width&&(s.width=e.width),s.height!==e.height&&(s.height=e.height),this.node.getWorldPosition(iG);const r=this._camera;if(r){if(this._targetTexture){let e=this._targetTexture.window;r.setFixedSize(e.width,e.height),r.orthoHeight=n.height/2}else{const e=PC.canvas;r.resize(e.width,e.height),r.orthoHeight=PC.canvas.height/FC.getScaleY()/2}r.node.setPosition(iG.x,iG.y,1e3),r.update()}}_checkTargetTextureEvent(e){const t=e=>{this._camera&&this._camera.setFixedSize(e.width,e.height)};e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",t,this)}_updateTargetTexture(){if(!this._camera)return;const e=this._camera;if(this._targetTexture){const t=this._targetTexture.window;e.changeTargetWindow(t),e.orthoHeight=LS.height/2,e.isWindowSize=!1}else e.changeTargetWindow(),e.orthoHeight=PC.canvas.height/FC.getScaleY()/2,e.isWindowSize=!0}_getViewPriority(){return this._renderMode===sG.OVERLAY?this._priority|1<<30:this._priority}}).prototype,"clearFlag",[UU,GU],Object.getOwnPropertyDescriptor(ZU.prototype,"clearFlag"),ZU.prototype),Po(ZU.prototype,"color",[HU],Object.getOwnPropertyDescriptor(ZU.prototype,"color"),ZU.prototype),Po(ZU.prototype,"renderMode",[VU,kU],Object.getOwnPropertyDescriptor(ZU.prototype,"renderMode"),ZU.prototype),Po(ZU.prototype,"priority",[WU],Object.getOwnPropertyDescriptor(ZU.prototype,"priority"),ZU.prototype),Po(ZU.prototype,"targetTexture",[jU,qU],Object.getOwnPropertyDescriptor(ZU.prototype,"targetTexture"),ZU.prototype),$U=Po(ZU.prototype,"_priority",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QU=Po(ZU.prototype,"_targetTexture",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JU=Po(ZU.prototype,"_clearFlag",[XU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nG.DEPTH_ONLY}}),eG=Po(ZU.prototype,"_color",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0,0)}}),tG=Po(ZU.prototype,"_renderMode",[YU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sG.OVERLAY}}),KU=ZU))||KU)||KU)||KU)||KU)||KU)||KU)||KU));var oG;i.Canvas=rG;let aG=e("UIComponent",Go("cc.UIComponent")(oG=Ho(xd)(oG=Vo(110)(oG=ko(oG=Zo(oG=class extends f_{constructor(...e){super(...e),this._lastParent=null}__preload(){this.node._uiProps.uiComp=this}onEnable(){}onDisable(){}onDestroy(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}updateAssembler(e){}postUpdateAssembler(e){}})||oG)||oG)||oG)||oG)||oG);Gi(aG.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),i.UITransformComponent=xd,Be.setClassAlias(xd,"cc.UITransformComponent"),Be.setClassAlias(hb,"cc.RenderComponent"),i.CanvasComponent=rG,Be.setClassAlias(rG,"cc.CanvasComponent");const cG=new _i,lG=new wi;function hG(e,t,i,n){const s=i.data;let r=t.currBufferBatch,o=r.byteOffset>>2,a=i.vertexCount,c=r.indicesOffset,l=r.vertexOffset;r.request(a,i.indicesCount)||(r=t.currBufferBatch,a=0,c=0,l=0);const h=r.vData,u=r.iData;e.getWorldMatrix(lG);for(let e=0;e<a;e++){const t=s[e];_i.set(cG,t.x,t.y,0),_i.transformMat4(cG,cG,lG),h[o++]=cG.x,h[o++]=cG.y,h[o++]=cG.z,h[o++]=t.u,h[o++]=t.v,Fi.toArray(h,n,o),o+=4}for(let e=0,t=a/4;e<t;e++){const t=l+4*e;u[c++]=t,u[c++]=t+1,u[c++]=t+2,u[c++]=t+1,u[c++]=t+3,u[c++]=t+2}}var uG,_G,dG,mG,pG,fG,gG,vG,yG,xG,SG,TG,EG,AG,CG,bG,RG,wG,IG,OG,PG,MG,DG,LG,BG,NG,FG,zG,UG,GG,HG,VG,kG,WG,jG,qG,XG,YG,KG,ZG,$G,QG,JG,eH,tH,iH,nH,sH,rH,oH;const aH=new Fi;var cH,lH;let hH;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(cH||(cH={})),$e(cH),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(lH||(lH={})),function(e){e.CLICK="click"}(hH||(hH={}));let uH=function(t){return e({Button:t,ButtonComponent:t}),t}((uG=Go("cc.Button"),_G=ta(),dG=Vo(110),mG=$o(),pG=Ho(xd),fG=va(kd),gG=ua(),vG=ra(),yG=ua(),xG=ra(),SG=va(cH),TG=ua(),EG=ra(),AG=ra(),CG=ra(),bG=ra(),RG=ra(),wG=aa(),IG=ca(),OG=ra(),PG=ra(),MG=va(_h),DG=ra(),LG=va(_h),BG=ra(),NG=va(_h),FG=ra(),zG=va(_h),UG=ra(),GG=va([pO]),HG=ua(),VG=ra(),uG(kG=_G(kG=dG(kG=mG(kG=pG(kG=Zo((oH=rH=class extends f_{constructor(...e){super(...e),Oo(this,"clickEvents",jG,this),Oo(this,"_interactable",qG,this),Oo(this,"_transition",XG,this),Oo(this,"_normalColor",YG,this),Oo(this,"_hoverColor",KG,this),Oo(this,"_pressColor",ZG,this),Oo(this,"_disabledColor",$G,this),Oo(this,"_normalSprite",QG,this),Oo(this,"_hoverSprite",JG,this),Oo(this,"_pressedSprite",eH,this),Oo(this,"_disabledSprite",tH,this),Oo(this,"_duration",iH,this),Oo(this,"_zoomScale",nH,this),Oo(this,"_target",sH,this),this._pressed=!1,this._hovered=!1,this._fromColor=new Fi,this._toColor=new Fi,this._time=0,this._transitionFinished=!0,this._fromScale=new _i,this._toScale=new _i,this._originalScale=new _i,this._sprite=null,this._targetScale=new _i}get target(){return this._target}set target(e){this._target!==e&&(this._target=e,this._applyTarget())}get interactable(){return this._interactable}set interactable(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}set _resizeToTarget(e){e&&this._resizeNodeToTargetNode()}get transition(){return this._transition}set transition(e){this._transition!==e&&(this._transition=e)}get normalColor(){return this._normalColor}set normalColor(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}get pressedColor(){return this._pressColor}set pressedColor(e){this._pressColor!==e&&this._pressColor.set(e)}get hoverColor(){return this._hoverColor}set hoverColor(e){this._hoverColor!==e&&this._hoverColor.set(e)}get disabledColor(){return this._disabledColor}set disabledColor(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}get duration(){return this._duration}set duration(e){this._duration!==e&&(this._duration=e)}get zoomScale(){return this._zoomScale}set zoomScale(e){this._zoomScale!==e&&(this._zoomScale=e)}get normalSprite(){return this._normalSprite}set normalSprite(e){if(this._normalSprite===e)return;this._normalSprite=e;const t=this.node.getComponent(eR);t&&(t.spriteFrame=e),this._updateState()}get pressedSprite(){return this._pressedSprite}set pressedSprite(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}get hoverSprite(){return this._hoverSprite}set hoverSprite(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}get disabledSprite(){return this._disabledSprite}set disabledSprite(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}__preload(){this.target||(this.target=this.node);const e=this.node.getComponent(eR);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._updateState()}onEnable(){this._registerEvent()}onDisable(){this._resetState(),this.node.off(Du.TOUCH_START,this._onTouchBegan,this),this.node.off(Du.TOUCH_MOVE,this._onTouchMove,this),this.node.off(Du.TOUCH_END,this._onTouchEnded,this),this.node.off(Du.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(Du.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(Du.MOUSE_LEAVE,this._onMouseMoveOut,this)}update(e){const t=this._target?this._target:this.node;if(this._transitionFinished)return;if(this._transition!==cH.COLOR&&this._transition!==cH.SCALE)return;this._time+=e;let i=1;this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1,this._transitionFinished=!0);const n=t.getComponent(hb);n&&(this._transition===cH.COLOR?(Fi.lerp(aH,this._fromColor,this._toColor,i),n.color=aH):this.transition===cH.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=Xt(this._fromScale.x,this._toScale.x,i),this._targetScale.y=Xt(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale)))}_resizeNodeToTargetNode(){this._target&&this._target._uiProps.uiTransformComp}_resetState(){this._pressed=!1,this._hovered=!1;const e=this._target;if(!e)return;const t=e.getComponent(hb);if(!t)return;const i=this._transition;i===cH.COLOR&&this._interactable?t.color=this._normalColor:i===cH.SCALE&&e.setScale(this._originalScale),this._transitionFinished=!0}_registerEvent(){this.node.on(Du.TOUCH_START,this._onTouchBegan,this),this.node.on(Du.TOUCH_MOVE,this._onTouchMove,this),this.node.on(Du.TOUCH_END,this._onTouchEnded,this),this.node.on(Du.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(Du.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(Du.MOUSE_LEAVE,this._onMouseMoveOut,this)}_getTargetSprite(e){let t=null;return e&&(t=e.getComponent(eR)),t}_applyTarget(){this._sprite=this._getTargetSprite(this._target),this._target&&_i.copy(this._originalScale,this._target.getScale())}_onTouchBegan(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}_onTouchMove(e){if(!this._interactable||!this.enabledInHierarchy||!this._pressed)return;if(!e)return!1;const t=e.touch;if(!t)return!1;const i=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());if(this._transition===cH.SCALE&&this._target)i?(_i.copy(this._fromScale,this._originalScale),_i.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this._target&&this._target.setScale(this._originalScale));else{let e;e=i?lH.PRESSED:lH.NORMAL,this._applyTransition(e)}e&&(e.propagationStopped=!0)}_onTouchEnded(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(pO.emitEvents(this.clickEvents,e),this.node.emit(hH.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}_onTouchCancel(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}_onMouseMoveIn(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==cH.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}_onMouseMoveOut(e){this._hovered&&(this._hovered=!1,this._updateState())}_updateState(){const e=this._getButtonState();this._applyTransition(e)}_getButtonState(){let e=lH.NORMAL;return this._interactable?this._pressed?e=lH.PRESSED:this._hovered&&(e=lH.HOVER):e=lH.DISABLED,e.toString()}_updateColorTransition(e){const t=this[e+"Color"],i=this._target;if(!i)return;const n=i.getComponent(hb);n&&(e===lH.DISABLED?n.color=t:(this._fromColor=n.color.clone(),this._toColor=t,this._time=0,this._transitionFinished=!1))}_updateSpriteTransition(e){const t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)}_updateScaleTransition(e){this._interactable&&(e===lH.PRESSED?this._zoomUp():this._zoomBack())}_zoomUp(){_i.copy(this._fromScale,this._originalScale),_i.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1}_zoomBack(){this._target&&(_i.copy(this._fromScale,this._target.getScale()),_i.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}_applyTransition(e){const t=this._transition;t===cH.COLOR?this._updateColorTransition(e):t===cH.SPRITE?this._updateSpriteTransition(e):t===cH.SCALE&&this._updateScaleTransition(e)}},rH.Transition=cH,rH.EventType=hH,Po((WG=oH).prototype,"target",[fG,gG,vG],Object.getOwnPropertyDescriptor(WG.prototype,"target"),WG.prototype),Po(WG.prototype,"interactable",[yG,xG],Object.getOwnPropertyDescriptor(WG.prototype,"interactable"),WG.prototype),Po(WG.prototype,"transition",[SG,TG,EG],Object.getOwnPropertyDescriptor(WG.prototype,"transition"),WG.prototype),Po(WG.prototype,"normalColor",[AG],Object.getOwnPropertyDescriptor(WG.prototype,"normalColor"),WG.prototype),Po(WG.prototype,"pressedColor",[CG],Object.getOwnPropertyDescriptor(WG.prototype,"pressedColor"),WG.prototype),Po(WG.prototype,"hoverColor",[bG],Object.getOwnPropertyDescriptor(WG.prototype,"hoverColor"),WG.prototype),Po(WG.prototype,"disabledColor",[RG],Object.getOwnPropertyDescriptor(WG.prototype,"disabledColor"),WG.prototype),Po(WG.prototype,"duration",[wG,IG,OG],Object.getOwnPropertyDescriptor(WG.prototype,"duration"),WG.prototype),Po(WG.prototype,"zoomScale",[PG],Object.getOwnPropertyDescriptor(WG.prototype,"zoomScale"),WG.prototype),Po(WG.prototype,"normalSprite",[MG,DG],Object.getOwnPropertyDescriptor(WG.prototype,"normalSprite"),WG.prototype),Po(WG.prototype,"pressedSprite",[LG,BG],Object.getOwnPropertyDescriptor(WG.prototype,"pressedSprite"),WG.prototype),Po(WG.prototype,"hoverSprite",[NG,FG],Object.getOwnPropertyDescriptor(WG.prototype,"hoverSprite"),WG.prototype),Po(WG.prototype,"disabledSprite",[zG,UG],Object.getOwnPropertyDescriptor(WG.prototype,"disabledSprite"),WG.prototype),jG=Po(WG.prototype,"clickEvents",[GG,Xo,HG,VG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qG=Po(WG.prototype,"_interactable",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XG=Po(WG.prototype,"_transition",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cH.NONE}}),YG=Po(WG.prototype,"_normalColor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(214,214,214,255)}}),KG=Po(WG.prototype,"_hoverColor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(211,211,211,255)}}),ZG=Po(WG.prototype,"_pressColor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fi.WHITE.clone()}}),$G=Po(WG.prototype,"_disabledColor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(124,124,124,255)}}),QG=Po(WG.prototype,"_normalSprite",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JG=Po(WG.prototype,"_hoverSprite",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eH=Po(WG.prototype,"_pressedSprite",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tH=Po(WG.prototype,"_disabledSprite",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iH=Po(WG.prototype,"_duration",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),nH=Po(WG.prototype,"_zoomScale",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),sH=Po(WG.prototype,"_target",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kG=WG))||kG)||kG)||kG)||kG)||kG)||kG));class _H{constructor(){this.pool=[]}get(){let e=this.pool.pop();if(!e){const t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}put(e){this.pool.length>=32||this.pool.push(e)}}var dH,mH,pH,fH,gH,vH,yH,xH,SH,TH,EH,AH,CH,bH,RH,wH,IH,OH,PH,MH,DH,LH,BH,NH,FH,zH,UH,GH,HH,VH,kH,WH,jH,qH,XH,YH,KH,ZH,$H,QH,JH,eV,tV,iV,nV,sV,rV,oV,aV,cV,lV,hV,uV,_V,dV,mV,pV,fV,gV,vV;let yV,xV,SV,TV;e("CanvasPool",_H),function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(yV||(yV=e("HorizontalTextAlignment",{}))),$e(yV),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(xV||(xV=e("VerticalTextAlignment",{}))),$e(xV),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(SV||(SV=e("Overflow",{}))),$e(SV),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(TV||(TV=e("CacheMode",{}))),$e(TV);let EV,AV,CV,bV=function(t){return e({Label:t,LabelComponent:t}),t}((dH=Go("cc.Label"),mH=ta(),pH=Vo(110),fH=$o(),gH=ua(),vH=ra(),yH=va(yV),xH=ua(),SH=ra(),TH=va(xV),EH=ua(),AH=ra(),CH=ua(),bH=ra(),RH=ua(),wH=ra(),IH=ua(),OH=ra(),PH=va(SV),MH=ua(),DH=ra(),LH=ua(),BH=ra(),NH=va(sx),FH=ua(),zH=ra(),UH=ua(),GH=ra(),HH=va(TV),VH=ua(),kH=ra(),WH=ua(),jH=ra(),qH=ua(),XH=ra(),YH=ua(),KH=ra(),ZH=va(Lu),$H=sa(),QH=na(),dH(JH=mH(JH=pH(JH=fH((vV=gV=class e extends hb{get string(){return this._string}set string(e){e+="",this._string!==e&&(this._string=e,this.updateRenderData())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}get verticalAlign(){return this._verticalAlign}set verticalAlign(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}get actualFontSize(){return this._actualFontSize}set actualFontSize(e){this._actualFontSize=e}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}get lineHeight(){return this._lineHeight}set lineHeight(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}get overflow(){return this._overflow}set overflow(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}get enableWrapText(){return this._enableWrapText}set enableWrapText(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}get font(){return this._font}set font(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,"string"==typeof e&&y(4e3),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null,this._flushAssembler(),this.updateRenderData()))}get cacheMode(){return this._cacheMode}set cacheMode(e){this._cacheMode!==e&&(this._cacheMode===TV.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}get spriteFrame(){return this._texture}get isBold(){return this._isBold}set isBold(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}get isItalic(){return this._isItalic}set isItalic(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}get isUnderline(){return this._isUnderline}set isUnderline(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}get sharedMaterials(){return super.sharedMaterials}set sharedMaterials(e){super.sharedMaterials=e}get assemblerData(){return this._assemblerData}get fontAtlas(){return this._fontAtlas}set fontAtlas(e){this._fontAtlas=e}get spacingX(){return this._spacingX}set spacingX(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}get _bmFontOriginalSize(){return this._font instanceof gx?this._font.fontSize:-1}constructor(){super(),Oo(this,"_useOriginalSize",tV,this),Oo(this,"_string",iV,this),Oo(this,"_horizontalAlign",nV,this),Oo(this,"_verticalAlign",sV,this),Oo(this,"_actualFontSize",rV,this),Oo(this,"_fontSize",oV,this),Oo(this,"_fontFamily",aV,this),Oo(this,"_lineHeight",cV,this),Oo(this,"_overflow",lV,this),Oo(this,"_enableWrapText",hV,this),Oo(this,"_font",uV,this),Oo(this,"_isSystemFontUsed",_V,this),this._spacingX=0,Oo(this,"_isItalic",dV,this),Oo(this,"_isBold",mV,this),Oo(this,"_isUnderline",pV,this),Oo(this,"_cacheMode",fV,this),this._N$file=null,this._texture=null,this._ttfSpriteFrame=null,this._userDefinedFont=null,this._assemblerData=null,this._fontAtlas=null,this._letterTexture=null,this._ttfSpriteFrame=null}onEnable(){super.onEnable(),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}onDisable(){super.onDisable()}onDestroy(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){const e=this._ttfSpriteFrame.texture;if(e){const t=e;t.image&&t.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,super.onDestroy()}updateRenderData(e=!1){this.markForUpdateRenderData(),e&&(this._flushAssembler(),this._applyFontTexture())}_render(e){e.commitComp(this,this._texture.getGFXTexture(),this._assembler,this._texture.getGFXSampler())}_updateColor(){this._font instanceof gx?super._updateColor():this.updateRenderData(!1)}_canRender(){if(!super._canRender()||!this._string)return!1;const e=this._font;if(e&&e instanceof gx){const t=e.spriteFrame;if(!t||!t.textureLoaded())return!1}return!0}_flushAssembler(){const t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}_applyFontTexture(){const e=this._font;if(e instanceof gx){const t=e.spriteFrame,i=()=>{this._texture=t,this._assembler&&this._assembler.updateRenderData(this)};t&&(t.loaded||t.textureLoaded?i():t.once("load",i,this))}else{if(this.cacheMode===TV.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new _h,this._assemblerData=this._assembler.getAssemblerData();const e=new mc(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=e}this.cacheMode!==TV.CHAR&&(this._texture=this._ttfSpriteFrame),this._assembler&&this._assembler.updateRenderData(this)}}},gV.HorizontalAlign=yV,gV.VerticalAlign=xV,gV.Overflow=SV,gV.CacheMode=TV,gV._canvasPool=new _H,Po((eV=vV).prototype,"string",[gH,vH,da],Object.getOwnPropertyDescriptor(eV.prototype,"string"),eV.prototype),Po(eV.prototype,"horizontalAlign",[yH,xH,SH],Object.getOwnPropertyDescriptor(eV.prototype,"horizontalAlign"),eV.prototype),Po(eV.prototype,"verticalAlign",[TH,EH,AH],Object.getOwnPropertyDescriptor(eV.prototype,"verticalAlign"),eV.prototype),Po(eV.prototype,"fontSize",[CH,bH],Object.getOwnPropertyDescriptor(eV.prototype,"fontSize"),eV.prototype),Po(eV.prototype,"fontFamily",[RH,wH],Object.getOwnPropertyDescriptor(eV.prototype,"fontFamily"),eV.prototype),Po(eV.prototype,"lineHeight",[IH,OH],Object.getOwnPropertyDescriptor(eV.prototype,"lineHeight"),eV.prototype),Po(eV.prototype,"overflow",[PH,MH,DH],Object.getOwnPropertyDescriptor(eV.prototype,"overflow"),eV.prototype),Po(eV.prototype,"enableWrapText",[LH,BH],Object.getOwnPropertyDescriptor(eV.prototype,"enableWrapText"),eV.prototype),Po(eV.prototype,"font",[NH,FH,zH],Object.getOwnPropertyDescriptor(eV.prototype,"font"),eV.prototype),Po(eV.prototype,"useSystemFont",[UH,GH],Object.getOwnPropertyDescriptor(eV.prototype,"useSystemFont"),eV.prototype),Po(eV.prototype,"cacheMode",[HH,VH,kH],Object.getOwnPropertyDescriptor(eV.prototype,"cacheMode"),eV.prototype),Po(eV.prototype,"isBold",[WH,jH],Object.getOwnPropertyDescriptor(eV.prototype,"isBold"),eV.prototype),Po(eV.prototype,"isItalic",[qH,XH],Object.getOwnPropertyDescriptor(eV.prototype,"isItalic"),eV.prototype),Po(eV.prototype,"isUnderline",[YH,KH],Object.getOwnPropertyDescriptor(eV.prototype,"isUnderline"),eV.prototype),Po(eV.prototype,"sharedMaterials",[ZH,ya,$H,QH],Object.getOwnPropertyDescriptor(eV.prototype,"sharedMaterials"),eV.prototype),tV=Po(eV.prototype,"_useOriginalSize",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iV=Po(eV.prototype,"_string",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),nV=Po(eV.prototype,"_horizontalAlign",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yV.CENTER}}),sV=Po(eV.prototype,"_verticalAlign",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xV.CENTER}}),rV=Po(eV.prototype,"_actualFontSize",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oV=Po(eV.prototype,"_fontSize",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),aV=Po(eV.prototype,"_fontFamily",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),cV=Po(eV.prototype,"_lineHeight",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),lV=Po(eV.prototype,"_overflow",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SV.NONE}}),hV=Po(eV.prototype,"_enableWrapText",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uV=Po(eV.prototype,"_font",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_V=Po(eV.prototype,"_isSystemFontUsed",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dV=Po(eV.prototype,"_isItalic",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mV=Po(eV.prototype,"_isBold",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pV=Po(eV.prototype,"_isUnderline",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fV=Po(eV.prototype,"_cacheMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TV.NONE}}),JH=eV))||JH)||JH)||JH)||JH));class RV{static add(e){const t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)}static remove(e){const t=this._tabIndexList,i=t.indexOf(e);-1!==i&&t.splice(i,1)}static resort(){this._tabIndexList.sort((e,t)=>e._delegate.tabIndex-t._delegate.tabIndex)}static next(e){const t=this._tabIndexList,i=t.indexOf(e);if(e.setFocus(!1),-1!==i){const e=t[i+1];e&&e._delegate.tabIndex>=0&&e.setFocus(!0)}}}RV._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(EV||(EV={})),Ye(EV),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(AV||(AV={})),Ye(AV),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(CV||(CV={})),Ye(CV);class wV{constructor(){this._editing=!1,this._delegate=null}init(e){}onEnable(){}update(){}onDisable(){this._editing&&this.endEditing()}clear(){this._delegate=null}setTabIndex(e){}setSize(e,t){}setFocus(e){e?this.beginEditing():this.endEditing()}isFocused(){return this._editing}beginEditing(){}endEditing(){}}const IV=new wi,OV=new wi,PV=new _i;let MV=null,DV=0;class LV extends wV{constructor(...e){super(...e),this._delegate=null,this._inputMode=-1,this._inputFlag=-1,this._returnType=-1,this.__eventListeners={},this.__fullscreen=!1,this.__autoResize=!1,this.__orientationChanged=void 0,this._edTxt=null,this._isTextArea=!1,this._textLabelFont=null,this._textLabelFontSize=null,this._textLabelFontColor=null,this._textLabelAlign=null,this._placeholderLabelFont=null,this._placeholderLabelFontSize=null,this._placeholderLabelFontColor=null,this._placeholderLabelAlign=null,this._placeholderLineHeight=null,this._placeholderStyleSheet=null,this._domId="EditBoxId_"+ ++DV}init(e){e&&(this._delegate=e,e.inputMode===AV.ANY?this._createTextArea():this._createInput(),RV.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer(),this.__fullscreen=FC.isAutoFullScreenEnabled(),this.__autoResize=FC._resizeWithBrowserSize)}clear(){this._removeEventListeners(),this._removeDomFromGameContainer(),RV.remove(this),MV===this&&(MV=null),this._delegate=null}update(){this._updateMatrix()}setTabIndex(e){this._edTxt.tabIndex=e,RV.resort()}setSize(e,t){const i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")}beginEditing(){MV&&MV!==this&&MV.setFocus(!1),this._editing=!0,MV=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()}endEditing(){this._edTxt.blur()}_createInput(){this._isTextArea=!1,this._edTxt=document.createElement("input")}_createTextArea(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")}_addDomToGameContainer(){PC.container&&this._edTxt&&(PC.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))}_removeDomFromGameContainer(){He(PC.container,this._edTxt)&&this._edTxt&&PC.container.removeChild(this._edTxt);He(document.head,this._placeholderStyleSheet)&&document.head.removeChild(this._placeholderStyleSheet),this._edTxt=null,this._placeholderStyleSheet=null}_showDom(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),Oa.isMobile&&this._showDomOnMobile()}_hideDom(){const e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),Oa.isMobile&&this._hideDomOnMobile()}_showDomOnMobile(){Oa.os===Oa.OS_ANDROID&&(this.__fullscreen&&(FC.enableAutoFullScreen(!1),WC.exitFullScreen()),this.__autoResize&&FC.resizeWithBrowserSize(!1),this._adjustWindowScroll())}_hideDomOnMobile(){Oa.os===Oa.OS_ANDROID&&(this.__autoResize&&FC.resizeWithBrowserSize(!0),setTimeout(()=>{MV||this.__fullscreen&&FC.enableAutoFullScreen(!0)},400)),this._scrollBackWindow()}_adjustWindowScroll(){const e=this;setTimeout(()=>{window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})},400)}_scrollBackWindow(){setTimeout(()=>{Oa.browserType!==Oa.BROWSER_TYPE_WECHAT||Oa.os!==Oa.OS_IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)},400)}_updateMatrix(){if(!this._edTxt)return;const e=this._delegate.node;let t=FC.getScaleX(),i=FC.getScaleY();const n=FC.getViewportRect(),s=FC.getDevicePixelRatio();e.getWorldMatrix(IV);const r=e._uiProps.uiTransformComp;if(r&&_i.set(PV,-r.anchorX*r.width,-r.anchorY*r.height,PV.z),wi.transform(IV,IV,PV),!e._uiProps.uiTransformComp)return!1;const o=rO.root.ui.getScreen(e._uiProps.uiTransformComp.visibility);if(!o)return;o.node.getWorldRT(OV);const a=OV.m12,c=OV.m13,l=LS.center;OV.m12=l.x-(OV.m00*a+OV.m04*c),OV.m13=l.y-(OV.m01*a+OV.m05*c),wi.multiply(OV,OV,IV),t/=s,i/=s;const h=PC.container,u=OV.m00*t,_=IV.m01,d=IV.m04,m=OV.m05*i;let p=parseInt(h&&h.style.paddingLeft||"0");p+=n.x/s;let f=parseInt(h&&h.style.paddingBottom||"0");f+=n.y/s;const g="matrix("+u+","+-_+","+-d+","+m+","+(OV.m12*t+p)+","+-(OV.m13*i+f)+")";this._edTxt.style.transform=g,this._edTxt.style["-webkit-transform"]=g,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}_updateInputType(){const e=this._delegate,t=e.inputMode,i=e.inputFlag,n=e.returnType;let s=this._edTxt;if(this._inputMode===t&&this._inputFlag===i&&this._returnType===n)return;if(this._inputMode=t,this._inputFlag=i,this._returnType=n,this._isTextArea){let e="none";return i===CV.INITIAL_CAPS_ALL_CHARACTERS?e="uppercase":i===CV.INITIAL_CAPS_WORD&&(e="capitalize"),void(s.style.textTransform=e)}if(s=s,i===CV.PASSWORD)return void(s.type="password");let r=s.type;t===AV.EMAIL_ADDR?r="email":t===AV.NUMERIC||t===AV.DECIMAL?r="number":t===AV.PHONE_NUMBER?(r="number",s.pattern="[0-9]*"):t===AV.URL?r="url":(r="text",n===EV.SEARCH&&(r="search")),s.type=r;let o="none";i===CV.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":i===CV.INITIAL_CAPS_WORD&&(o="capitalize"),s.style.textTransform=o}_updateMaxLength(){let e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e}_initStyleSheet(){if(!this._edTxt)return;let e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="uppercase",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):(e=e,e.type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}_updateStyleSheet(){const e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))}_updateTextLabel(e){if(!e)return;let t=e.font;t=!t||t instanceof gx?e.fontFamily:t._fontFamily;const i=e.fontSize*e.node.scale.y;if(this._textLabelFont===t&&this._textLabelFontSize===i&&this._textLabelFontColor===e.fontColor&&this._textLabelAlign===e.horizontalAlign)return;if(this._textLabelFont=t,this._textLabelFontSize=i,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,!this._edTxt)return;const n=this._edTxt;switch(n.style.fontSize=i+"px",n.style.color=e.color.toCSS("rgba"),n.style.fontFamily=t,e.horizontalAlign){case bV.HorizontalAlign.LEFT:n.style.textAlign="left";break;case bV.HorizontalAlign.CENTER:n.style.textAlign="center";break;case bV.HorizontalAlign.RIGHT:n.style.textAlign="right"}}_updatePlaceholderLabel(e){if(!e)return;let t=e.font;t=!t||t instanceof gx?e.fontFamily:e.font._fontFamily;const n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont===t&&this._placeholderLabelFontSize===n&&this._placeholderLabelFontColor===e.fontColor&&this._placeholderLabelAlign===e.horizontalAlign&&this._placeholderLineHeight===e.fontSize)return;this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;const s=this._placeholderStyleSheet,r=e.color.toCSS("rgba"),o=e.fontSize;let a="";switch(e.horizontalAlign){case bV.HorizontalAlign.LEFT:a="left";break;case bV.HorizontalAlign.CENTER:a="center";break;case bV.HorizontalAlign.RIGHT:a="right"}s.innerHTML=`#${this._domId}::-webkit-input-placeholder{text-transform: initial;-family: ${t};font-size: ${n}px;color: ${r};line-height: ${o}px;text-align: ${a};}#${this._domId}::-moz-placeholder{text-transform: initial;-family: ${t};font-size: ${n}px;color: ${r};line-height: ${o}px;text-align: ${a};}#${this._domId}::-ms-input-placeholder{text-transform: initial;-family: ${t};font-size: ${n}px;color: ${r};line-height: ${o}px;text-align: ${a};}`,i.sys.browserType===i.sys.BROWSER_TYPE_EDGE&&(s.innerHTML+=`#${this._domId}::-ms-clear{display: none;}`)}_registerEventListeners(){if(!this._edTxt)return;const e=this,t=this._edTxt;let i=!1;const n=this.__eventListeners;n.compositionStart=()=>{i=!0},n.compositionEnd=()=>{i=!1,e._delegate._editBoxTextChanged(t.value)},n.onInput=()=>{if(i)return;const n=e._delegate,s=n.maxLength;s>=0&&(t.value=t.value.slice(0,s)),n._editBoxTextChanged(t.value)},n.onClick=()=>{e._editing&&Oa.isMobile&&e._adjustWindowScroll()},n.onKeydown=i=>{i.keyCode===Bc.KEY.enter?(i.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):i.keyCode===Bc.KEY.tab&&(i.propagationStopped=!0,i.preventDefault(),RV.next(e))},n.onBlur=()=>{Oa.isMobile&&i&&n.compositionEnd(),e._editing=!1,MV=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",n.compositionStart),t.addEventListener("compositionend",n.compositionEnd),t.addEventListener("input",n.onInput),t.addEventListener("keydown",n.onKeydown),t.addEventListener("blur",n.onBlur),t.addEventListener("touchstart",n.onClick)}_removeEventListeners(){if(!this._edTxt)return;const e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}}var BV,NV,FV,zV,UV,GV,HV,VV,kV,WV,jV,qV,XV,YV,KV,ZV,$V,QV,JV,ek,tk,ik,nk,sk,rk,ok,ak,ck,lk,hk,uk,_k,dk,mk,pk,fk,gk,vk,yk,xk,Sk,Tk,Ek,Ak,Ck,bk,Rk,wk,Ik,Ok,Pk,Mk,Dk,Lk,Bk,Nk,Fk,zk,Uk,Gk,Hk;var Vk;!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(Vk||(Vk={}));let kk=function(t){return e({EditBox:t,EditBoxComponent:t}),t}((BV=Go("cc.EditBox"),NV=ta(),FV=Vo(100),zV=$o(),UV=Ho(xd),GV=ua(),HV=ra(),VV=ua(),kV=ra(),WV=va(bV),jV=ua(),qV=ra(),XV=va(bV),YV=ua(),KV=ra(),ZV=va(_h),$V=ua(),QV=ra(),JV=va(CV),ek=ua(),tk=ra(),ik=va(AV),nk=ua(),sk=ra(),rk=va(EV),ok=ua(),ak=ra(),ck=ua(),lk=ra(),hk=ua(),uk=ra(),_k=va([pO]),dk=ua(),mk=ra(),pk=va([pO]),fk=ua(),gk=ra(),vk=va([pO]),yk=ua(),xk=ra(),Sk=va([pO]),Tk=ua(),Ek=ra(),BV(Ak=NV(Ak=FV(Ak=zV(Ak=UV(Ak=Zo((Hk=Gk=class e extends f_{constructor(...e){super(...e),Oo(this,"editingDidBegan",bk,this),Oo(this,"textChanged",Rk,this),Oo(this,"editingDidEnded",wk,this),Oo(this,"editingReturn",Ik,this),this._impl=null,this._background=null,Oo(this,"_textLabel",Ok,this),Oo(this,"_placeholderLabel",Pk,this),Oo(this,"_returnType",Mk,this),Oo(this,"_useOriginalSize",Dk,this),Oo(this,"_string",Lk,this),Oo(this,"_tabIndex",Bk,this),Oo(this,"_backgroundImage",Nk,this),Oo(this,"_inputFlag",Fk,this),Oo(this,"_inputMode",zk,this),Oo(this,"_maxLength",Uk,this),this._isLabelVisible=!1}get string(){return this._string}set string(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}get placeholder(){return this._placeholderLabel?this._placeholderLabel.string:""}set placeholder(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}get textLabel(){return this._textLabel}set textLabel(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}get placeholderLabel(){return this._placeholderLabel}set placeholderLabel(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}get backgroundImage(){return this._backgroundImage}set backgroundImage(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._createBackgroundSprite())}get inputFlag(){return this._inputFlag}set inputFlag(e){this._inputFlag=e,this._updateString(this._string)}get inputMode(){return this._inputMode}set inputMode(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}get returnType(){return this._returnType}set returnType(e){this._returnType=e}get maxLength(){return this._maxLength}set maxLength(e){this._maxLength=e}get tabIndex(){return this._tabIndex}set tabIndex(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}__preload(){this._init()}onEnable(){this._registerEvent(),this._impl&&this._impl.onEnable()}update(){this._impl&&this._impl.update()}onDisable(){this._unregisterEvent(),this._impl&&this._impl.onDisable()}onDestroy(){this._impl&&this._impl.clear()}setFocus(){this._impl&&this._impl.setFocus(!0)}focus(){this._impl&&this._impl.setFocus(!0)}blur(){this._impl&&this._impl.setFocus(!1)}isFocused(){return!!this._impl&&this._impl.isFocused()}_editBoxEditingDidBegan(){pO.emitEvents(this.editingDidBegan,this),this.node.emit(Vk.EDITING_DID_BEGAN,this)}_editBoxEditingDidEnded(){pO.emitEvents(this.editingDidEnded,this),this.node.emit(Vk.EDITING_DID_ENDED,this)}_editBoxTextChanged(e){e=this._updateLabelStringStyle(e,!0),this.string=e,pO.emitEvents(this.textChanged,e,this),this.node.emit(Vk.TEXT_CHANGED,this)}_editBoxEditingReturn(){pO.emitEvents(this.editingReturn,this),this.node.emit(Vk.EDITING_RETURN,this)}_showLabels(){this._isLabelVisible=!0,this._updateLabels()}_hideLabels(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}_onTouchBegan(e){e.propagationStopped=!0}_onTouchCancel(e){e.propagationStopped=!0}_onTouchEnded(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0}_init(){this._createBackgroundSprite(),this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(Du.SIZE_CHANGED,this._resizeChildNodes,this);(this._impl=new e._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}_createBackgroundSprite(){this._background||(this._background=this.node.getComponent(eR),this._background||(this._background=this.node.addComponent(eR))),this._background.type=eR.Type.SLICED,this._background.spriteFrame=this._backgroundImage}_updateTextLabel(){let e=this._textLabel;if(!e){let t=this.node.getChildByName("TEXT_LABEL");t||(t=new kd("TEXT_LABEL")),e=t.getComponent(bV),e||(e=t.addComponent(bV)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=bV.Overflow.CLAMP,this._inputMode===AV.ANY?(e.verticalAlign=xV.TOP,e.enableWrapText=!0):(e.verticalAlign=xV.CENTER,e.enableWrapText=!1),e.string=this._updateLabelStringStyle(this._string)}_updatePlaceholderLabel(){let e=this._placeholderLabel;if(!e){let t=this.node.getChildByName("PLACEHOLDER_LABEL");t||(t=new kd("PLACEHOLDER_LABEL")),e=t.getComponent(bV),e||(e=t.addComponent(bV)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=bV.Overflow.CLAMP,this._inputMode===AV.ANY?(e.verticalAlign=xV.TOP,e.enableWrapText=!0):(e.verticalAlign=xV.CENTER,e.enableWrapText=!1),e.string=this.placeholder}_syncSize(){let e=this.node._uiProps.uiTransformComp;const t=e.contentSize;if(this._background){let i=this._background.node._uiProps.uiTransformComp;i.anchorPoint=e.anchorPoint,i.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)}_updateLabels(){if(this._isLabelVisible){const e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}_updateString(e){const t=this._textLabel;if(!t)return;let i=e;i&&(i=this._updateLabelStringStyle(i)),t.string=i,this._updateLabels()}_updateLabelStringStyle(e,t=!1){const i=this._inputFlag;if(t||i!==CV.PASSWORD)i===CV.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===CV.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,e=>e.toUpperCase()):i===CV.INITIAL_CAPS_SENTENCE&&(e=function(e){return e.charAt(0).toUpperCase()+e.slice(1)}(e));else{let t="";const i=e.length;for(let e=0;e<i;++e)t+="";e=t}return e}_registerEvent(){this.node.on(Du.TOUCH_START,this._onTouchBegan,this),this.node.on(Du.TOUCH_END,this._onTouchEnded,this)}_unregisterEvent(){this.node.off(Du.TOUCH_START,this._onTouchBegan,this),this.node.off(Du.TOUCH_END,this._onTouchEnded,this)}_updateLabelPosition(e){let t=this.node._uiProps.uiTransformComp;const i=-t.anchorX*t.width,n=-t.anchorY*t.height,s=this._placeholderLabel,r=this._textLabel;r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.node.position=new _i(i+2,n+e.height,r.node.position.z),r.verticalAlign=this._inputMode===AV.ANY?xV.TOP:xV.CENTER,r.enableWrapText=this._inputMode===AV.ANY),s&&(s.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),s.lineHeight=e.height,s.node.position=new _i(i+2,n+e.height,s.node.position.z),s.verticalAlign=this._inputMode===AV.ANY?xV.TOP:xV.CENTER,s.enableWrapText=this._inputMode===AV.ANY)}_resizeChildNodes(){let e=this.node._uiProps.uiTransformComp;const t=this._textLabel&&this._textLabel.node;t&&(t.position=new _i(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));const i=this._placeholderLabel&&this._placeholderLabel.node;i&&(i.position=new _i(-e.width/2,e.height/2,i.position.z),i._uiProps.uiTransformComp.setContentSize(e.contentSize));const n=this._background&&this._background.node;n&&n._uiProps.uiTransformComp.setContentSize(e.contentSize)}},Gk._EditBoxImpl=wV,Gk.KeyboardReturnType=EV,Gk.InputFlag=CV,Gk.InputMode=AV,Gk.EventType=Vk,Po((Ck=Hk).prototype,"string",[GV,HV],Object.getOwnPropertyDescriptor(Ck.prototype,"string"),Ck.prototype),Po(Ck.prototype,"placeholder",[VV,kV],Object.getOwnPropertyDescriptor(Ck.prototype,"placeholder"),Ck.prototype),Po(Ck.prototype,"textLabel",[WV,jV,qV],Object.getOwnPropertyDescriptor(Ck.prototype,"textLabel"),Ck.prototype),Po(Ck.prototype,"placeholderLabel",[XV,YV,KV],Object.getOwnPropertyDescriptor(Ck.prototype,"placeholderLabel"),Ck.prototype),Po(Ck.prototype,"backgroundImage",[ZV,$V,QV],Object.getOwnPropertyDescriptor(Ck.prototype,"backgroundImage"),Ck.prototype),Po(Ck.prototype,"inputFlag",[JV,ek,tk],Object.getOwnPropertyDescriptor(Ck.prototype,"inputFlag"),Ck.prototype),Po(Ck.prototype,"inputMode",[ik,nk,sk],Object.getOwnPropertyDescriptor(Ck.prototype,"inputMode"),Ck.prototype),Po(Ck.prototype,"returnType",[rk,ok,ak],Object.getOwnPropertyDescriptor(Ck.prototype,"returnType"),Ck.prototype),Po(Ck.prototype,"maxLength",[ck,lk],Object.getOwnPropertyDescriptor(Ck.prototype,"maxLength"),Ck.prototype),Po(Ck.prototype,"tabIndex",[hk,uk],Object.getOwnPropertyDescriptor(Ck.prototype,"tabIndex"),Ck.prototype),bk=Po(Ck.prototype,"editingDidBegan",[_k,Xo,dk,mk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rk=Po(Ck.prototype,"textChanged",[pk,Xo,fk,gk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wk=Po(Ck.prototype,"editingDidEnded",[vk,Xo,yk,xk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ik=Po(Ck.prototype,"editingReturn",[Sk,Xo,Tk,Ek],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ok=Po(Ck.prototype,"_textLabel",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pk=Po(Ck.prototype,"_placeholderLabel",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mk=Po(Ck.prototype,"_returnType",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EV.DEFAULT}}),Dk=Po(Ck.prototype,"_useOriginalSize",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Lk=Po(Ck.prototype,"_string",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Bk=Po(Ck.prototype,"_tabIndex",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nk=Po(Ck.prototype,"_backgroundImage",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fk=Po(Ck.prototype,"_inputFlag",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CV.DEFAULT}}),zk=Po(Ck.prototype,"_inputMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AV.ANY}}),Uk=Po(Ck.prototype,"_maxLength",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),Ak=Ck))||Ak)||Ak)||Ak)||Ak)||Ak)||Ak));var Wk,jk,qk,Xk,Yk,Kk,Zk,$k,Qk,Jk,eW,tW,iW,nW,sW,rW,oW,aW,cW,lW,hW,uW,_W,dW,mW,pW,fW,gW,vW,yW,xW,SW,TW,EW,AW,CW,bW,RW,wW,IW,OW,PW;Oa.isBrowser&&(kk._EditBoxImpl=LV);const MW=Du;var DW,LW,BW,NW,FW;!function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(DW||(DW={})),$e(DW),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(LW||(LW={})),$e(LW),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(BW||(BW={})),$e(BW),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(NW||(NW={})),$e(NW),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(FW||(FW={})),$e(FW);const zW=new _i,UW=new _i;let GW,HW,VW,kW=function(t){return e({Layout:t,LayoutComponent:t}),t}((Wk=Go("cc.Layout"),jk=ta(),qk=Vo(110),Xk=$o(),Yk=Ho(xd),Kk=va(DW),Zk=ra(),$k=va(LW),Qk=ra(),Jk=ra(),eW=va(BW),tW=ra(),iW=ra(),nW=ra(),sW=ra(),rW=ra(),oW=ra(),aW=ra(),cW=va(NW),lW=ra(),hW=va(FW),uW=ra(),_W=ra(),dW=ra(),Wk(mW=jk(mW=qk(mW=Xk(mW=Yk(mW=Zo((PW=OW=class extends f_{constructor(...e){super(...e),Oo(this,"_resizeMode",fW,this),Oo(this,"_N$layoutType",gW,this),Oo(this,"_N$padding",vW,this),Oo(this,"_cellSize",yW,this),Oo(this,"_startAxis",xW,this),Oo(this,"_paddingLeft",SW,this),Oo(this,"_paddingRight",TW,this),Oo(this,"_paddingTop",EW,this),Oo(this,"_paddingBottom",AW,this),Oo(this,"_spacingX",CW,this),Oo(this,"_spacingY",bW,this),Oo(this,"_verticalDirection",RW,this),Oo(this,"_horizontalDirection",wW,this),Oo(this,"_affectedByScale",IW,this),this._layoutSize=new Di(300,200),this._layoutDirty=!0,this._isAlign=!1}get type(){return this._N$layoutType}set type(e){this._N$layoutType=e,this._isAlign=!0,this._doLayoutDirty()}get resizeMode(){return this._resizeMode}set resizeMode(e){this._N$layoutType===DW.NONE&&e===LW.CHILDREN||(this._resizeMode=e,this._doLayoutDirty())}get cellSize(){return this._cellSize}set cellSize(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}get startAxis(){return this._startAxis}set startAxis(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}get paddingLeft(){return this._paddingLeft}set paddingLeft(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}get paddingRight(){return this._paddingRight}set paddingRight(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}get paddingTop(){return this._paddingTop}set paddingTop(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}get paddingBottom(){return this._paddingBottom}set paddingBottom(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}get spacingX(){return this._spacingX}set spacingX(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}get spacingY(){return this._spacingY}set spacingY(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}get verticalDirection(){return this._verticalDirection}set verticalDirection(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}get horizontalDirection(){return this._horizontalDirection}set horizontalDirection(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}get padding(){return this._paddingLeft}set padding(e){this._N$padding=e,this._migratePaddingData(),this._doLayoutDirty()}get affectedByScale(){return this._affectedByScale}set affectedByScale(e){this._affectedByScale=e,this._doLayoutDirty()}updateLayout(){this._layoutDirty&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}onEnable(){this._addEventListeners();let e=this.node._uiProps.uiTransformComp;e.contentSize.equals(Di.ZERO)&&e.setContentSize(this._layoutSize),0!==this._N$padding&&this._migratePaddingData(),this._doLayoutDirty()}onDisable(){this._removeEventListeners()}_migratePaddingData(){this._paddingLeft=this._N$padding,this._paddingRight=this._N$padding,this._paddingTop=this._N$padding,this._paddingBottom=this._N$padding,this._N$padding=0}_addEventListeners(){rO.on(sO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(MW.SIZE_CHANGED,this._resized,this),this.node.on(MW.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(MW.CHILD_ADDED,this._childAdded,this),this.node.on(MW.CHILD_REMOVED,this._childRemoved,this),this._addChildrenEventListeners()}_removeEventListeners(){rO.off(sO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(MW.SIZE_CHANGED,this._resized,this),this.node.off(MW.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(MW.CHILD_ADDED,this._childAdded,this),this.node.off(MW.CHILD_REMOVED,this._childRemoved,this),this._removeChildrenEventListeners()}_addChildrenEventListeners(){const e=this.node.children;for(let t=0;t<e.length;++t){const i=e[t];i.on(MW.TRANSFORM_CHANGED,this._doScaleDirty,this),i.on(MW.SIZE_CHANGED,this._doLayoutDirty,this),i.on(MW.TRANSFORM_CHANGED,this._transformDirty,this),i.on(MW.ANCHOR_CHANGED,this._doLayoutDirty,this),i.on("active-in-hierarchy-changed",this._doLayoutDirty,this)}}_removeChildrenEventListeners(){const e=this.node.children;for(let t=0;t<e.length;++t){const i=e[t];i.off(MW.TRANSFORM_CHANGED,this._doScaleDirty,this),i.off(MW.SIZE_CHANGED,this._doLayoutDirty,this),i.off(MW.TRANSFORM_CHANGED,this._transformDirty,this),i.off(MW.ANCHOR_CHANGED,this._doLayoutDirty,this),i.off("active-in-hierarchy-changed",this._doLayoutDirty,this)}}_childAdded(e){e.on(MW.TRANSFORM_CHANGED,this._doScaleDirty,this),e.on(MW.SIZE_CHANGED,this._doLayoutDirty,this),e.on(MW.TRANSFORM_CHANGED,this._transformDirty,this),e.on(MW.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}_childRemoved(e){e.off(MW.TRANSFORM_CHANGED,this._doScaleDirty,this),e.off(MW.SIZE_CHANGED,this._doLayoutDirty,this),e.off(MW.TRANSFORM_CHANGED,this._transformDirty,this),e.off(MW.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}_resized(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}_doLayoutHorizontally(e,t,i,n){const s=this.node._uiProps.uiTransformComp,r=s.anchorPoint,o=this.node.children;let a=1,c=this._paddingLeft,l=-r.x*e;this._horizontalDirection===FW.RIGHT_TO_LEFT&&(a=-1,l=(1-r.x)*e,c=this._paddingRight);let h=l+a*c-a*this._spacingX,u=0,_=0,d=0,m=0,p=0,f=0,g=0;for(let e=0;e<o.length;++e)o[e].activeInHierarchy&&g++;let v=this._cellSize.width;this._N$layoutType!==DW.GRID&&this._resizeMode===LW.CHILDREN&&(v=(e-(this._paddingLeft+this._paddingRight)-(g-1)*this._spacingX)/g);for(let g=0;g<o.length;++g){const y=o[g],x=y._uiProps.uiTransformComp;if(!y.activeInHierarchy||!x)continue;y.getScale(UW);const S=this._getUsedScaleValue(UW.x),T=this._getUsedScaleValue(UW.y);this._resizeMode===LW.CHILDREN&&(x.width=v/S,this._N$layoutType===DW.GRID&&(x.height=this._cellSize.height/T));let E=x.anchorX;const A=x.width*S,C=x.height*T;d>_&&(_=d),C>=_&&(d=_,_=C,f=x.anchorY),this._horizontalDirection===FW.RIGHT_TO_LEFT&&(E=1-x.anchorX),h=h+a*E*A+a*this._spacingX;const b=a*(1-E)*A;if(t){const t=h+b+a*(a>0?this._paddingRight:this._paddingLeft);let i=!1;this._horizontalDirection===FW.LEFT_TO_RIGHT&&t>(1-r.x)*e&&(i=!0);let n=!1;this._horizontalDirection===FW.RIGHT_TO_LEFT&&t<-r.x*e&&(n=!0),(i||n)&&(C>=_?(0===d&&(d=_),u+=d,d=_):(u+=_,d=C,_=0),h=l+a*(c+E*A),m++)}const R=i(y,x,u,m);e>=A+this._paddingLeft+this._paddingRight&&n&&(y.getPosition(zW),y.setPosition(h,R,zW.z));let w,I=1;const O=0===_?C:_;this._verticalDirection===NW.TOP_TO_BOTTOM?(p=p||s.height,I=-1,w=R+I*(O*f+this._paddingBottom),w<p&&(p=w)):(p=p||-s.height,w=R+I*(O*f+this._paddingTop),w>p&&(p=w)),h+=b}return p}_doLayoutVertically(e,t,i,n){const s=this.node._uiProps.uiTransformComp,r=s.anchorPoint,o=this.node.children;let a=1,c=this._paddingBottom,l=-r.y*e;this._verticalDirection===NW.TOP_TO_BOTTOM&&(a=-1,l=(1-r.y)*e,c=this._paddingTop);let h=l+a*c-a*this._spacingY,u=0,_=0,d=0,m=0,p=0,f=0,g=0;for(let e=0;e<o.length;++e)o[e].activeInHierarchy&&g++;let v=this._cellSize.height;this._N$layoutType!==DW.GRID&&this._resizeMode===LW.CHILDREN&&(v=(e-(this._paddingTop+this._paddingBottom)-(g-1)*this._spacingY)/g);for(let g=0;g<o.length;++g){const y=o[g];if(!y)continue;const x=y.getScale(),S=this._getUsedScaleValue(x.x),T=this._getUsedScaleValue(x.y),E=y._uiProps.uiTransformComp;if(!y.activeInHierarchy||!E)continue;this._resizeMode===LW.CHILDREN&&(E.height=v/T,this._N$layoutType===DW.GRID&&(E.width=this._cellSize.width/S));let A=E.anchorY;const C=E.width*S,b=E.height*T;d>_&&(_=d),C>=_&&(d=_,_=C,f=E.anchorX),this._verticalDirection===NW.TOP_TO_BOTTOM&&(A=1-E.anchorY),h=h+a*A*b+a*this._spacingY;const R=a*(1-A)*b;if(t){const t=h+R+a*(a>0?this._paddingTop:this._paddingBottom);let i=!1;this._verticalDirection===NW.BOTTOM_TO_TOP&&t>(1-r.y)*e&&(i=!0);let n=!1;this._verticalDirection===NW.TOP_TO_BOTTOM&&t<-r.y*e&&(n=!0),(i||n)&&(C>=_?(0===d&&(d=_),u+=d,d=_):(u+=_,d=C,_=0),h=l+a*(c+A*b),m++)}const w=i(y,E,u,m);e>=b+(this._paddingTop+this._paddingBottom)&&n&&(y.getPosition(zW),y.setPosition(w,h,zW.z));let I,O=1;const P=0===_?C:_;this._horizontalDirection===FW.RIGHT_TO_LEFT?(O=-1,p=p||s.width,I=w+O*(P*f+this._paddingLeft),I<p&&(p=I)):(p=p||-s.width,I=w+O*(P*f+this._paddingRight),I>p&&(p=I)),h+=R}return p}_doLayoutBasic(){const e=this.node.children;let t=null;for(let i=0;i<e.length;++i){const n=e[i],s=n._uiProps.uiTransformComp;s&&(n.activeInHierarchy&&(t?Bi.union(t,t,s.getBoundingBoxToWorld()):t=s.getBoundingBoxToWorld()))}if(t){const e=this.node.parent.getComponent(xd);if(!e)return;_i.set(zW,t.x,t.y,0);const n=new _i;e.convertToNodeSpaceAR(zW,n),_i.set(n,n.x-this._paddingLeft,n.y-this._paddingBottom,n.z),_i.set(zW,t.x+t.width,t.y+t.height,0);const s=new _i;e.convertToNodeSpaceAR(zW,s),_i.set(s,s.x+this._paddingRight,s.y+this._paddingTop,s.z);const r=i.size(parseFloat((s.x-n.x).toFixed(2)),parseFloat((s.y-n.y).toFixed(2)));this.node.getPosition(zW);const o=this.node._uiProps.uiTransformComp;if(0!==r.width){const e=(zW.x-n.x)/r.width;o.anchorX=parseFloat(e.toFixed(2))}if(0!==r.height){const e=(zW.y-n.y)/r.height;o.anchorY=parseFloat(e.toFixed(2))}o.setContentSize(r)}}_doLayoutGridAxisHorizontal(e,t){const i=t.width;let n=1,s=-e.y*t.height,r=this._paddingBottom;this._verticalDirection===NW.TOP_TO_BOTTOM&&(n=-1,s=(1-e.y)*t.height,r=this._paddingTop);const o=this,a=(e,t,i,a)=>s+n*(i+t.anchorY*t.height*o._getUsedScaleValue(e.getScale().y)+r+a*this._spacingY);let c=0;if(this._resizeMode===LW.CONTAINER){const t=this._doLayoutHorizontally(i,!0,a,!1);c=s-t,c<0&&(c*=-1),s=-e.y*c,this._verticalDirection===NW.TOP_TO_BOTTOM&&(n=-1,s=(1-e.y)*c)}this._doLayoutHorizontally(i,!0,a,!0),this._resizeMode===LW.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)}_doLayoutGridAxisVertical(e,t){const i=t.height;let n=1,s=-e.x*t.width,r=this._paddingLeft;this._horizontalDirection===FW.RIGHT_TO_LEFT&&(n=-1,s=(1-e.x)*t.width,r=this._paddingRight);const o=this,a=(e,t,i,a)=>s+n*(i+t.anchorX*t.width*o._getUsedScaleValue(e.getScale().x)+r+a*this._spacingX);let c=0;if(this._resizeMode===LW.CONTAINER){const t=this._doLayoutVertically(i,!0,a,!1);c=s-t,c<0&&(c*=-1),s=-e.x*c,this._horizontalDirection===FW.RIGHT_TO_LEFT&&(n=-1,s=(1-e.x)*c)}this._doLayoutVertically(i,!0,a,!0),this._resizeMode===LW.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)}_doLayoutGrid(){let e=this.node._uiProps.uiTransformComp;const t=e.anchorPoint,i=e.contentSize;this.startAxis===BW.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,i):this.startAxis===BW.VERTICAL&&this._doLayoutGridAxisVertical(t,i)}_getHorizontalBaseWidth(e){let t=0,i=0;if(this._resizeMode===LW.CONTAINER){for(let n=0;n<e.length;++n){const s=e[n];s.getScale(UW);let r=s._uiProps.uiTransformComp;s.activeInHierarchy&&r&&(i++,t+=r.width*this._getUsedScaleValue(UW.x))}t+=(i-1)*this._spacingX+this._paddingLeft+this._paddingRight}else t=this.node._uiProps.uiTransformComp.width;return t}_getVerticalBaseHeight(e){let t=0,i=0;if(this._resizeMode===LW.CONTAINER){for(let n=0;n<e.length;++n){const s=e[n];s.getScale(UW);let r=s._uiProps.uiTransformComp;s.activeInHierarchy&&r&&(i++,t+=r.height*this._getUsedScaleValue(UW.y))}t+=(i-1)*this._spacingY+this._paddingBottom+this._paddingTop}else t=this.node._uiProps.uiTransformComp.height;return t}_doLayout(){if(this._N$layoutType===DW.HORIZONTAL){const e=this._getHorizontalBaseWidth(this.node.children),t=e=>(this._isAlign?_i.ZERO:e.position).y;this._doLayoutHorizontally(e,!1,t,!0),this._isAlign=!1,this.node._uiProps.uiTransformComp.width=e}else if(this._N$layoutType===DW.VERTICAL){const e=this._getVerticalBaseHeight(this.node.children),t=e=>(this._isAlign?_i.ZERO:e.position).x;this._doLayoutVertically(e,!1,t,!0),this._isAlign=!1,this.node._uiProps.uiTransformComp.height=e}else this._N$layoutType===DW.NONE?this._resizeMode===LW.CONTAINER&&this._doLayoutBasic():this._N$layoutType===DW.GRID&&this._doLayoutGrid()}_getUsedScaleValue(e){return this._affectedByScale?Math.abs(e):1}_transformDirty(e){e&K_.POSITION&&this._doLayoutDirty()}_doLayoutDirty(){this._layoutDirty=!0}_doScaleDirty(e){e&K_.SCALE&&(this._layoutDirty=this._layoutDirty||this._affectedByScale)}},OW.Type=DW,OW.VerticalDirection=NW,OW.HorizontalDirection=FW,OW.ResizeMode=LW,OW.AxisDirection=BW,Po((pW=PW).prototype,"type",[Kk,Zk],Object.getOwnPropertyDescriptor(pW.prototype,"type"),pW.prototype),Po(pW.prototype,"resizeMode",[$k,Qk],Object.getOwnPropertyDescriptor(pW.prototype,"resizeMode"),pW.prototype),Po(pW.prototype,"cellSize",[Jk],Object.getOwnPropertyDescriptor(pW.prototype,"cellSize"),pW.prototype),Po(pW.prototype,"startAxis",[eW,tW],Object.getOwnPropertyDescriptor(pW.prototype,"startAxis"),pW.prototype),Po(pW.prototype,"paddingLeft",[iW],Object.getOwnPropertyDescriptor(pW.prototype,"paddingLeft"),pW.prototype),Po(pW.prototype,"paddingRight",[nW],Object.getOwnPropertyDescriptor(pW.prototype,"paddingRight"),pW.prototype),Po(pW.prototype,"paddingTop",[sW],Object.getOwnPropertyDescriptor(pW.prototype,"paddingTop"),pW.prototype),Po(pW.prototype,"paddingBottom",[rW],Object.getOwnPropertyDescriptor(pW.prototype,"paddingBottom"),pW.prototype),Po(pW.prototype,"spacingX",[oW],Object.getOwnPropertyDescriptor(pW.prototype,"spacingX"),pW.prototype),Po(pW.prototype,"spacingY",[aW],Object.getOwnPropertyDescriptor(pW.prototype,"spacingY"),pW.prototype),Po(pW.prototype,"verticalDirection",[cW,lW],Object.getOwnPropertyDescriptor(pW.prototype,"verticalDirection"),pW.prototype),Po(pW.prototype,"horizontalDirection",[hW,uW],Object.getOwnPropertyDescriptor(pW.prototype,"horizontalDirection"),pW.prototype),Po(pW.prototype,"padding",[_W],Object.getOwnPropertyDescriptor(pW.prototype,"padding"),pW.prototype),Po(pW.prototype,"affectedByScale",[dW],Object.getOwnPropertyDescriptor(pW.prototype,"affectedByScale"),pW.prototype),fW=Po(pW.prototype,"_resizeMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LW.NONE}}),gW=Po(pW.prototype,"_N$layoutType",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DW.NONE}}),vW=Po(pW.prototype,"_N$padding",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yW=Po(pW.prototype,"_cellSize",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(40,40)}}),xW=Po(pW.prototype,"_startAxis",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BW.HORIZONTAL}}),SW=Po(pW.prototype,"_paddingLeft",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TW=Po(pW.prototype,"_paddingRight",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EW=Po(pW.prototype,"_paddingTop",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AW=Po(pW.prototype,"_paddingBottom",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CW=Po(pW.prototype,"_spacingX",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bW=Po(pW.prototype,"_spacingY",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RW=Po(pW.prototype,"_verticalDirection",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NW.TOP_TO_BOTTOM}}),wW=Po(pW.prototype,"_horizontalDirection",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FW.LEFT_TO_RIGHT}}),IW=Po(pW.prototype,"_affectedByScale",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mW=pW))||mW)||mW)||mW)||mW)||mW)||mW));var WW,jW,qW,XW,YW,KW,ZW,$W,QW,JW,ej,tj,ij,nj,sj,rj,oj,aj,cj,lj,hj,uj;!function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(GW||(GW={})),$e(GW),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(HW||(HW={})),$e(HW),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(VW||(VW={})),$e(VW);const _j={parent:null,owner:null,subModelIdx:0};let dj=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((WW=Go("cc.Graphics"),jW=ta(),qW=Vo(110),XW=$o(),YW=va(HW),KW=ra(),ZW=va(GW),$W=ra(),QW=ra(),JW=ra(),ej=ra(),tj=na(),WW(ij=jW(ij=qW(ij=XW((uj=hj=class e extends hb{get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}get lineJoin(){return this._lineJoin}set lineJoin(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}get lineCap(){return this._lineCap}set lineCap(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}get strokeColor(){return this._strokeColor}set strokeColor(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}get fillColor(){return this._fillColor}set fillColor(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}get miterLimit(){return this._miterLimit}set miterLimit(e){this._miterLimit=e}get color(){return this._color}set color(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}constructor(){super(),this.impl=null,this.model=null,Oo(this,"_lineWidth",sj,this),Oo(this,"_strokeColor",rj,this),Oo(this,"_lineJoin",oj,this),Oo(this,"_lineCap",aj,this),Oo(this,"_fillColor",cj,this),Oo(this,"_miterLimit",lj,this),this._instanceMaterialType=cb.ADD_COLOR,this._uiMaterialDirty=!0}onRestore(){this.impl||this._flushAssembler()}__preload(){super.__preload(),this.impl=this._assembler&&this._assembler.createImpl(this)}onLoad(){this._sceneGetter=rO.root.ui.getRenderSceneGetter(),this.model||(this.model=rO.root.createModel(Im)),this.helpInstanceMaterial()}onDisable(){this._detachFromScene()}onDestroy(){super.onDestroy(),this._sceneGetter=null,this.model&&(this.model.destroy(),rO.root.destroyModel(this.model),this.model=null),this.impl&&(this.impl.clear(),this.impl=null)}moveTo(e,t){this.impl&&this.impl.moveTo(e,t)}lineTo(e,t){this.impl&&this.impl.lineTo(e,t)}bezierCurveTo(e,t,i,n,s,r){this.impl&&this.impl.bezierCurveTo(e,t,i,n,s,r)}quadraticCurveTo(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}arc(e,t,i,n,s,r){this.impl&&this.impl.arc(e,t,i,n,s,r)}ellipse(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}circle(e,t,i){this.impl&&this.impl.circle(e,t,i)}rect(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}roundRect(e,t,i,n,s){this.impl&&this.impl.roundRect(e,t,i,n,s)}fillRect(e,t,i,n){this.rect(e,t,i,n),this.fill()}clear(e=!1){this.impl&&(this.impl.clear(e),this._detachFromScene(),this.model&&this.model.destroy(),this.markForUpdateRenderData())}close(){this.impl&&this.impl.close()}stroke(){this._assembler||this._flushAssembler(),this._assembler.stroke(this),this._attachToScene()}fill(){this._assembler||this._flushAssembler(),this._assembler.fill(this),this._attachToScene()}helpInstanceMaterial(){let e=null;_j.owner=this,this.sharedMaterial?(_j.parent=this.sharedMaterial[0],e=new Nu(_j)):(_j.parent=Th.get("ui-graphics-material"),e=new Nu(_j),e.recompileShaders({USE_LOCAL:!0})),this._uiMaterial=_j.parent,this._uiMaterialIns=e,this.impl||(this._flushAssembler(),this.impl=this._assembler&&this._assembler.createImpl(this))}_render(e){e.commitModel(this,this.model,this._uiMaterialIns)}_flushAssembler(){const t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t)}_canRender(){return!!super._canRender()&&(!!this.model&&this.model.inited)}_attachToScene(){const e=rO.root.ui.renderScene;this.model&&this.model.scene!==e&&(null!==this.model.scene&&this._detachFromScene(),e.addModel(this.model))}_detachFromScene(){this.model&&this.model.scene&&(this.model.scene.removeModel(this.model),this.model.scene=null)}},hj.LineJoin=HW,hj.LineCap=GW,Po((nj=uj).prototype,"lineWidth",[ia],Object.getOwnPropertyDescriptor(nj.prototype,"lineWidth"),nj.prototype),Po(nj.prototype,"lineJoin",[YW,KW],Object.getOwnPropertyDescriptor(nj.prototype,"lineJoin"),nj.prototype),Po(nj.prototype,"lineCap",[ZW,$W],Object.getOwnPropertyDescriptor(nj.prototype,"lineCap"),nj.prototype),Po(nj.prototype,"strokeColor",[QW],Object.getOwnPropertyDescriptor(nj.prototype,"strokeColor"),nj.prototype),Po(nj.prototype,"fillColor",[JW],Object.getOwnPropertyDescriptor(nj.prototype,"fillColor"),nj.prototype),Po(nj.prototype,"miterLimit",[ej],Object.getOwnPropertyDescriptor(nj.prototype,"miterLimit"),nj.prototype),Po(nj.prototype,"color",[ya,tj],Object.getOwnPropertyDescriptor(nj.prototype,"color"),nj.prototype),sj=Po(nj.prototype,"_lineWidth",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rj=Po(nj.prototype,"_strokeColor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fi.BLACK.clone()}}),oj=Po(nj.prototype,"_lineJoin",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HW.MITER}}),aj=Po(nj.prototype,"_lineCap",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GW.BUTT}}),cj=Po(nj.prototype,"_fillColor",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fi.WHITE.clone()}}),lj=Po(nj.prototype,"_miterLimit",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),ij=nj))||ij)||ij)||ij)||ij));var mj,pj,fj,gj,vj,yj,xj,Sj,Tj,Ej,Aj,Cj,bj,Rj,wj,Ij,Oj,Pj;const Mj=new wi,Dj=new ci,Lj=new wi,Bj=[];let Nj;!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL"}(Nj||(Nj={})),$e(Nj);let Fj=function(t){return e({Mask:t,MaskComponent:t}),t}((mj=Go("cc.Mask"),pj=ta(),fj=Vo(110),gj=$o(),vj=va(Nj),yj=ua(),xj=ra(),Sj=ra(),Tj=na(),Ej=na(),Aj=na(),mj(Cj=pj(Cj=fj(Cj=gj((Pj=Oj=class e extends hb{get type(){return this._type}set type(e){this._type!==e&&(this._type=e,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null))}get inverted(){return this._inverted}set inverted(e){i.game.renderType!==OC.RENDER_TYPE_CANVAS?this._inverted=e:y(4202)}get segments(){return this._segments}set segments(e){this._segments!==e&&(this._segments=jt(e,3,1e4),this._updateGraphics())}get graphics(){return this._graphics}get clearGraphics(){return this._clearGraphics}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}get color(){return this._color}set color(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}constructor(){super(),Oo(this,"_type",Rj,this),Oo(this,"_inverted",wj,this),Oo(this,"_segments",Ij,this),this._graphics=null,this._clearGraphics=null,this._instanceMaterialType=cb.ADD_COLOR,this._uiMaterialDirty=!0}onLoad(){this._createGraphics(),this._clearGraphics&&this._clearGraphics.onLoad(),this._graphics&&this._graphics.onLoad()}onRestore(){this._createGraphics(),this._updateGraphics()}onEnable(){super.onEnable(),this._enableGraphics(),FC.on("design-resolution-changed",this._updateClearGraphics,this)}onDisable(){super.onDisable(),this._disableGraphics(),FC.off("design-resolution-changed",this._updateClearGraphics)}onDestroy(){super.onDestroy(),this._removeGraphics()}isHit(e){const t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=i.width,s=i.height,r=Dj;this.node.getWorldMatrix(Mj),wi.invert(Lj,Mj),ci.transformMat4(r,e,Lj);const o=t.anchorPoint;r.x+=o.x*n,r.y+=o.y*s;let a=!1;if(this.type===Nj.RECT||this.type===Nj.GRAPHICS_STENCIL)a=r.x>=0&&r.y>=0&&r.x<=n&&r.y<=s;else if(this.type===Nj.ELLIPSE){const e=n/2,t=s/2,i=r.x-.5*n,o=r.y-.5*s;a=i*i/(e*e)+o*o/(t*t)<1}return this._inverted&&(a=!a),a}_render(e){e.commitComp(this,null,this._assembler)}_postRender(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler)}_nodeStateChange(e){super._nodeStateChange(e),this._updateGraphics()}_resolutionChanged(){this._updateClearGraphics()}_canRender(){return!!super._canRender()&&(null!==this._clearGraphics&&null!==this._graphics)}_flushAssembler(){const t=e.Assembler.getAssembler(this),i=e.PostAssembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._postAssembler!==i&&(this._postAssembler=i),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.sharedMaterial,this.markForUpdateRenderData())}_createGraphics(){if(!this._clearGraphics){const e=new kd("clear-graphics"),t=this._clearGraphics=e.addComponent(dj);t.delegateSrc=this.node,t.lineWidth=0;const i=Fi.WHITE.clone();i.a=0,t.fillColor=i}if(!this._graphics){const e=this._graphics=new dj;e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;const t=Fi.WHITE.clone();t.a=0,e.fillColor=t}}_updateClearGraphics(){if(!this._clearGraphics)return;const e=LS;this._clearGraphics.node.setWorldPosition(e.width/2,e.height/2,0),this._clearGraphics.clear(),this._clearGraphics.rect(-e.width/2,-e.height/2,e.width,e.height),this._clearGraphics.fill()}_updateGraphics(){if(!this._graphics)return;const e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();const i=e.contentSize,n=i.width,s=i.height,r=e.anchorPoint,o=-n*r.x,a=-s*r.y;if(this._type===Nj.RECT)t.rect(o,a,n,s);else if(this._type===Nj.ELLIPSE){const e=function(e,t,i){Bj.length=0;const n=2*Math.PI/i;for(let s=0;s<i;++s)Bj.push(new _i(t.x*Math.cos(n*s)+e.x,t.y*Math.sin(n*s)+e.y,0));return Bj}(new _i(o+n/2,a+s/2,0),new _i(n/2,s/2,0),this._segments);for(let i=0;i<e.length;++i){const n=e[i];0===i?t.moveTo(n.x,n.y):t.lineTo(n.x,n.y)}t.close()}t.fill()}_enableGraphics(){this._clearGraphics&&(this._clearGraphics.onEnable(),this._updateClearGraphics()),this._graphics&&(this._graphics.onEnable(),this._updateGraphics())}_disableGraphics(){this._graphics&&this._graphics.onDisable(),this._clearGraphics&&this._clearGraphics.onDisable()}_removeGraphics(){this._graphics&&this._graphics.destroy(),this._clearGraphics&&this._clearGraphics.destroy()}},Oj.Type=Nj,Po((bj=Pj).prototype,"type",[vj,yj,xj],Object.getOwnPropertyDescriptor(bj.prototype,"type"),bj.prototype),Po(bj.prototype,"inverted",[Sj],Object.getOwnPropertyDescriptor(bj.prototype,"inverted"),bj.prototype),Po(bj.prototype,"segments",[ia],Object.getOwnPropertyDescriptor(bj.prototype,"segments"),bj.prototype),Po(bj.prototype,"dstBlendFactor",[ya,Tj],Object.getOwnPropertyDescriptor(bj.prototype,"dstBlendFactor"),bj.prototype),Po(bj.prototype,"srcBlendFactor",[ya,Ej],Object.getOwnPropertyDescriptor(bj.prototype,"srcBlendFactor"),bj.prototype),Po(bj.prototype,"color",[ya,Aj],Object.getOwnPropertyDescriptor(bj.prototype,"color"),bj.prototype),Rj=Po(bj.prototype,"_type",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nj.RECT}}),wj=Po(bj.prototype,"_inverted",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ij=Po(bj.prototype,"_segments",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Cj=bj))||Cj)||Cj)||Cj)||Cj));var zj,Uj,Gj,Hj,Vj,kj,Wj,jj,qj,Xj,Yj,Kj,Zj,$j,Qj,Jj,eq,tq,iq,nq,sq,rq,oq;i.Mask=Fj,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(oq||(oq={})),Ye(oq);let aq=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((zj=Go("cc.ProgressBar"),Uj=ta(),Gj=Vo(110),Hj=$o(),Vj=Ho(xd),kj=va(eR),Wj=ra(),jj=va(oq),qj=ra(),Xj=ra(),Yj=oa(),Kj=ra(),Zj=ra(),zj($j=Uj($j=Gj($j=Hj($j=Vj((rq=sq=class extends f_{constructor(...e){super(...e),Oo(this,"_barSprite",Jj,this),Oo(this,"_mode",eq,this),Oo(this,"_totalLength",tq,this),Oo(this,"_progress",iq,this),Oo(this,"_reverse",nq,this)}get barSprite(){return this._barSprite}set barSprite(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}get mode(){return this._mode}set mode(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){const e=this._barSprite.node;if(!e)return;const t=e._uiProps.uiTransformComp.contentSize;this._mode===oq.HORIZONTAL?this.totalLength=t.width:this._mode===oq.VERTICAL?this.totalLength=t.height:this._mode===oq.FILLED&&(this.totalLength=this._barSprite.fillRange)}}get totalLength(){return this._totalLength}set totalLength(e){this._mode===oq.FILLED&&(e=qt(e)),this._totalLength=e,this._updateBarStatus()}get progress(){return this._progress}set progress(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}get reverse(){return this._reverse}set reverse(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}_initBarSprite(){if(this._barSprite){const e=this._barSprite.node;if(!e)return;const t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=t.anchorPoint,s=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===eR.FillType.RADIAL&&(this._mode=oq.FILLED),this._mode===oq.HORIZONTAL?this.totalLength=s.width:this._mode===oq.VERTICAL?this.totalLength=s.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){const t=-i.width*n.x;e.setPosition(t,0,0)}}}_updateBarStatus(){if(this._barSprite){const e=this._barSprite.node;if(!e)return;const t=e._uiProps.uiTransformComp,i=t.anchorPoint,n=t.contentSize,s=e.getPosition();let r=new ci(0,.5);const o=qt(this._progress);let a=this._totalLength*o,c=n,l=0,u=0;switch(this._mode){case oq.HORIZONTAL:this._reverse&&(r=new ci(1,.5)),c=new Di(a,n.height),l=this._totalLength,u=n.height;break;case oq.VERTICAL:r=this._reverse?new ci(.5,1):new ci(.5,0),c=new Di(n.width,a),l=n.width,u=this._totalLength}if(this._mode===oq.FILLED)this._barSprite.type!==eR.Type.FILLED?h("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(a*=-1),this._barSprite.fillRange=a);else if(this._barSprite.type!==eR.Type.FILLED){const n=r.x-i.x,o=r.y-i.y,a=new _i(l*n,u*o,0);e.setPosition(s.x+a.x,s.y+a.y,s.z),t.setAnchorPoint(r),t.setContentSize(c)}else h("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},sq.Mode=oq,Po((Qj=rq).prototype,"barSprite",[kj,Wj],Object.getOwnPropertyDescriptor(Qj.prototype,"barSprite"),Qj.prototype),Po(Qj.prototype,"mode",[jj,qj],Object.getOwnPropertyDescriptor(Qj.prototype,"mode"),Qj.prototype),Po(Qj.prototype,"totalLength",[Xj],Object.getOwnPropertyDescriptor(Qj.prototype,"totalLength"),Qj.prototype),Po(Qj.prototype,"progress",[Yj,ha,Kj],Object.getOwnPropertyDescriptor(Qj.prototype,"progress"),Qj.prototype),Po(Qj.prototype,"reverse",[Zj],Object.getOwnPropertyDescriptor(Qj.prototype,"reverse"),Qj.prototype),Jj=Po(Qj.prototype,"_barSprite",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eq=Po(Qj.prototype,"_mode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oq.HORIZONTAL}}),tq=Po(Qj.prototype,"_totalLength",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),iq=Po(Qj.prototype,"_progress",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),nq=Po(Qj.prototype,"_reverse",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$j=Qj))||$j)||$j)||$j)||$j)||$j));var cq,lq,hq,uq,_q,dq,mq,pq,fq,gq,vq;let yq=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}((cq=Go("cc.LabelOutline"),lq=ta(),hq=Vo(110),uq=$o(),_q=Ho(bV),dq=ra(),mq=ra(),cq(pq=lq(pq=hq(pq=uq(pq=_q(pq=Zo((gq=Po((fq=class extends f_{constructor(...e){super(...e),Oo(this,"_color",gq,this),Oo(this,"_width",vq,this)}get color(){return this._color}set color(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}get width(){return this._width}set width(e){this._width!==e&&(this._width=e,this._updateRenderData())}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const e=this.node.getComponent(bV);e&&e.updateRenderData(!0)}}).prototype,"_color",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0,255)}}),vq=Po(fq.prototype,"_width",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Po(fq.prototype,"color",[dq],Object.getOwnPropertyDescriptor(fq.prototype,"color"),fq.prototype),Po(fq.prototype,"width",[mq],Object.getOwnPropertyDescriptor(fq.prototype,"width"),fq.prototype),pq=fq))||pq)||pq)||pq)||pq)||pq)||pq));var xq,Sq,Tq,Eq,Aq,Cq,bq,Rq,wq,Iq,Oq,Pq,Mq,Dq,Lq,Bq,Nq,Fq,zq,Uq,Gq,Hq,Vq,kq,Wq,jq,qq,Xq,Yq,Kq,Zq,$q,Qq,Jq,eX;const tX=new Io,iX=new De(e=>{if(!i.isValid(e.node))return!1;{let t=e.node.getComponent(yq);t&&(t.width=0)}return!0},20);iX.get=function(e,t){let i=this._get();i||(i={node:new iI("RICHTEXT_CHILD"),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:""});let n=i.node;n||(n=new iI("RICHTEXT_CHILD"));let s=n.getComponent(bV);s||(s=n.addComponent(bV)),s.string=e,s.horizontalAlign=yV.LEFT,s.verticalAlign=xV.TOP,n.setPosition(0,0,0),n._uiProps.uiTransformComp.setAnchorPoint(.5,.5);return{node:n,comp:s,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:""}};let nX=function(t){return e({RichText:t,RichTextComponent:t}),t}((xq=Go("cc.RichText"),Sq=ta(),Tq=Vo(110),Eq=$o(),Aq=ra(),Cq=va(yV),bq=ra(),Rq=ra(),wq=ra(),Iq=va(sx),Oq=ra(),Pq=ra(),Mq=va(TV),Dq=ra(),Lq=ra(),Bq=ra(),Nq=va($v),Fq=ra(),zq=ra(),xq(Uq=Sq(Uq=Tq(Uq=Eq(Uq=Zo((eX=Jq=class extends aG{get string(){return this._string}set string(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}get font(){return this._font}set font(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}get cacheMode(){return this._cacheMode}set cacheMode(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}get lineHeight(){return this._lineHeight}set lineHeight(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}get imageAtlas(){return this._imageAtlas}set imageAtlas(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}get handleTouchEvent(){return this._handleTouchEvent}set handleTouchEvent(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}constructor(){super(),Oo(this,"_lineHeight",Hq,this),Oo(this,"_string",Vq,this),Oo(this,"_horizontalAlign",kq,this),Oo(this,"_fontSize",Wq,this),Oo(this,"_maxWidth",jq,this),Oo(this,"_fontFamily",qq,this),Oo(this,"_font",Xq,this),Oo(this,"_isSystemFontUsed",Yq,this),Oo(this,"_userDefinedFont",Kq,this),Oo(this,"_cacheMode",Zq,this),Oo(this,"_imageAtlas",$q,this),Oo(this,"_handleTouchEvent",Qq,this),this._textArray=[],this._labelSegments=[],this._labelSegmentsCache=[],this._linesWidth=[],this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0,this._lineOffsetX=0,this._updateRichTextStatus=void 0,this._updateRichTextStatus=this._updateRichText}onEnable(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}onDisable(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}start(){this._onTTFLoaded(),this.node.on(kd.EventType.ANCHOR_CHANGED,this._updateRichTextPosition,this)}onRestore(){}onDestroy(){for(const e of this._labelSegments)e.node.removeFromParent(),iX.put(e);this.node.off(kd.EventType.ANCHOR_CHANGED,this._updateRichTextPosition,this)}_addEventListeners(){this.node.on(kd.EventType.TOUCH_END,this._onTouchEnded,this)}_removeEventListeners(){this.node.off(kd.EventType.TOUCH_END,this._onTouchEnded,this)}_updateLabelSegmentTextAttributes(){this._labelSegments.forEach(e=>{this._applyTextAttribute(e)})}_createFontLabel(e){return iX.get(e,this)}_onTTFLoaded(){if(this._font instanceof cx)if(this._font._nativeAsset)this._layoutDirty=!0,this._updateRichText();else{const e=this;ES.load(this._font.nativeUrl,(t,i)=>{e._layoutDirty=!0,e._updateRichText()})}else this._layoutDirty=!0,this._updateRichText()}_measureText(e,t){const i=this,n=t=>{let n;0===i._labelSegmentsCache.length?(n=i._createFontLabel(t),i._labelSegmentsCache.push(n)):(n=i._labelSegmentsCache[0],n.node.getComponent(bV).string=t),n.styleIndex=e,i._applyTextAttribute(n);return n.node._uiProps.uiTransformComp.contentSize.width};return t?n(t):n}_onTouchEnded(e){const t=this.node.getComponents(f_);for(const i of this._labelSegments){const n=i.clickHandler,s=i.clickParam;n&&this._containsTouchLocation(i,e.touch.getUILocation())&&(t.forEach(t=>{const i=t[n];t.enabledInHierarchy&&i&&i.call(t,e,s)}),e.propagationStopped=!0)}}_containsTouchLocation(e,t){const i=e.node.getComponent(xd);if(!i)return!1;return i.getBoundingBoxToWorld().contains(t)}_resetState(){const e=this.node.children;for(let t=e.length-1;t>=0;t--){const i=e[t];if(("RICHTEXT_CHILD"===i.name||"RICHTEXT_Image_CHILD"===i.name)&&(i.parent===this.node?i.parent=null:e.splice(t,1),"RICHTEXT_CHILD"===i.name)){const e=this._labelSegments.findIndex(e=>e.node===i);-1!==e&&iX.put(this._labelSegments[e])}}this._labelSegments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}_activateChildren(e){for(let t=this.node.children.length-1;t>=0;t--){const i=this.node.children[t];"RICHTEXT_CHILD"!==i.name&&"RICHTEXT_Image_CHILD"!==i.name||(i.active=e)}}_addLabelSegment(e,t){let i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{i=this._labelSegmentsCache.pop();const t=i.node.getComponent(bV);t&&(t.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node._uiProps.uiTransformComp.setAnchorPoint(0,0),this._applyTextAttribute(i),this.node.addChild(i.node),this._labelSegments.push(i),i}_updateRichTextWithMaxWidth(e,t,i){let n,s=t;if(this._lineOffsetX>0&&s+this._lineOffsetX>this._maxWidth){let t=0;for(;this._lineOffsetX<=this._maxWidth;){const n=this._getFirstWordLen(e,t,e.length),r=e.substr(t,n),o=this._measureText(i,r);if(!(this._lineOffsetX+o<=this._maxWidth)){if(t>0){const n=e.substr(0,t);this._addLabelSegment(n,i),e=e.substr(t,e.length),s=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=o,t+=n}}if(s>this._maxWidth){const t=bo(e,s,this._maxWidth,this._measureText(i));for(let e=0;e<t.length;++e){const s=t[e];n=this._addLabelSegment(s,i);const r=n.node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=r.width,t.length>1&&e<t.length-1&&this._updateLineInfo()}}else this._lineOffsetX+=s,this._addLabelSegment(e,i)}_isLastComponentCR(e){return e.length-1===e.lastIndexOf("\n")}_updateLineInfo(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}_needsUpdateTextLayout(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(let t=0;t<this._textArray.length;t++){const i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;{let e=i.style,t=n.style;if(e){if(t){if(!!t.outline!=!!e.outline)return!0;if(e.size!==t.size||e.italic!==t.italic||e.isImage!==t.isImage)return!0;if(e.src!==t.src||e.imageAlign!==t.imageAlign||e.imageHeight!==t.imageHeight||e.imageWidth!==t.imageWidth||e.imageOffset!==t.imageOffset)return!0}else if(e.size||e.italic||e.isImage||e.outline)return!0}else if(t&&(t.size||t.italic||t.isImage||t.outline))return!0}}return!1}_addRichTextImageElement(e){if(!e.style)return;const t=e.style,i=t.src,n=this._imageAtlas&&i&&this._imageAtlas.getSpriteFrame(i);if(n){const e=new iI("RICHTEXT_Image_CHILD"),i=e.addComponent(eR);switch(t.imageAlign){case"top":e._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":e._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:e._uiProps.uiTransformComp.setAnchorPoint(0,0)}i.type=eR.Type.SLICED,i.sizeMode=eR.SizeMode.CUSTOM,i.spriteFrame=n,this.node.addChild(e);const s={node:e,comp:i,lineCount:0,styleIndex:0,imageOffset:t.imageOffset||"",clickParam:"",clickHandler:""};this._labelSegments.push(s);const r=n.rect.clone();let o=1,a=r.width,c=r.height;const l=t.imageWidth||0,h=t.imageHeight||0;h>0?(o=h/c,a*=o,c*=o):(o=this._lineHeight/c,a*=o,c*=o),l>0&&(a=l),this._maxWidth>0?(this._lineOffsetX+a>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=a):(this._lineOffsetX+=a,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),e._uiProps.uiTransformComp.setContentSize(a,c),s.lineCount=this._lineCount,s.clickHandler="",s.clickParam="";let u=t.event;u&&(s.clickHandler=u.click,s.clickParam=u.param)}else y(4400)}_updateRichText(){if(!this.enabledInHierarchy)return;const e=tX.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();let t,i=!1;for(let e=0;e<this._textArray.length;++e){const n=this._textArray[e],s=n.text;if(void 0===s)continue;if(""===s){if(n.style&&n.style.isNewLine){this._updateLineInfo();continue}if(n.style&&n.style.isImage&&this._imageAtlas){this._addRichTextImageElement(n);continue}}const r=s.split("\n");for(let n=0;n<r.length;++n){const o=r[n];if(""!==o)if(i=!1,this._maxWidth>0){const t=this._measureText(e,o);this._updateRichTextWithMaxWidth(o,t,e),r.length>1&&n<r.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(o,e),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),r.length>1&&n<r.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(s)&&n===r.length-1)continue;this._updateLineInfo(),i=!0}}}i||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+fo)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}_getFirstWordLen(e,t,i){let n=e.charAt(t);if(To(n)||Eo(n))return 1;let s=1;for(let r=t+1;r<i&&(n=e.charAt(r),!Eo(n)&&!To(n));++r)s++;return s}_updateRichTextPosition(){let e=0,t=1;const i=this._lineCount,n=this.node._uiProps.uiTransformComp,s=n.anchorX,r=n.anchorY;for(let n=0;n<this._labelSegments.length;++n){const o=this._labelSegments[n],a=o.lineCount;a>t&&(e=0,t=a);let c=this._labelWidth*(.5*this._horizontalAlign-s);switch(this._horizontalAlign){case yV.LEFT:break;case yV.CENTER:c-=this._linesWidth[a-1]/2;break;case yV.RIGHT:c-=this._linesWidth[a-1]}const l=o.node.position;if(o.node.setPosition(e+c,this._lineHeight*(i-a)-this._labelHeight*r,l.z),a===t&&(e+=o.node._uiProps.uiTransformComp.width),o.node.getComponent(eR)){let e=o.node.position.clone(),t=this._lineHeight,i=this._lineHeight*(1+fo);switch(o.node._uiProps.uiTransformComp.anchorY){case 1:e.y+=t+(i-t)/2;break;case.5:e.y+=i/2;break;default:e.y+=(i-t)/2}if(o.imageOffset){let t=o.imageOffset.split(",");if(1===t.length&&t[0]){let i=parseFloat(t[0]);Number.isInteger(i)&&(e.y+=i)}else if(2===t.length){let i=parseFloat(t[0]),n=parseFloat(t[1]);Number.isInteger(i)&&(e.x+=i),Number.isInteger(n)&&(e.y+=n)}}o.node.position=e}let h=o.node.getComponent(yq);if(h){let e=o.node.position.clone();e.y=e.y-h.width,o.node.position=e}}}_convertLiteralColorValue(e){const t=e.toUpperCase();if(Fi[t])return Fi[t];return(new Fi).fromHEX(e)}_applyTextAttribute(e){const t=e.node.getComponent(bV);if(!t)return;const i=e.styleIndex;let n;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){let t=e.node.getComponent(yq);t||(t=e.node.addComponent(yq)),t.color=this._convertLiteralColorValue(n.outline.color),t.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";let i=n.event;i&&(e.clickHandler=i.click||"",e.clickParam=i.param||"")}else t.fontSize=this._fontSize;t.cacheMode=this._cacheMode,this._font instanceof sx&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0)}},Jq.HorizontalAlign=yV,Jq.VerticalAlign=xV,Po((Gq=eX).prototype,"string",[da,Aq],Object.getOwnPropertyDescriptor(Gq.prototype,"string"),Gq.prototype),Po(Gq.prototype,"horizontalAlign",[Cq,bq],Object.getOwnPropertyDescriptor(Gq.prototype,"horizontalAlign"),Gq.prototype),Po(Gq.prototype,"fontSize",[Rq],Object.getOwnPropertyDescriptor(Gq.prototype,"fontSize"),Gq.prototype),Po(Gq.prototype,"fontFamily",[wq],Object.getOwnPropertyDescriptor(Gq.prototype,"fontFamily"),Gq.prototype),Po(Gq.prototype,"font",[Iq,Oq],Object.getOwnPropertyDescriptor(Gq.prototype,"font"),Gq.prototype),Po(Gq.prototype,"useSystemFont",[Pq],Object.getOwnPropertyDescriptor(Gq.prototype,"useSystemFont"),Gq.prototype),Po(Gq.prototype,"cacheMode",[Mq,Dq],Object.getOwnPropertyDescriptor(Gq.prototype,"cacheMode"),Gq.prototype),Po(Gq.prototype,"maxWidth",[Lq],Object.getOwnPropertyDescriptor(Gq.prototype,"maxWidth"),Gq.prototype),Po(Gq.prototype,"lineHeight",[Bq],Object.getOwnPropertyDescriptor(Gq.prototype,"lineHeight"),Gq.prototype),Po(Gq.prototype,"imageAtlas",[Nq,Fq],Object.getOwnPropertyDescriptor(Gq.prototype,"imageAtlas"),Gq.prototype),Po(Gq.prototype,"handleTouchEvent",[zq],Object.getOwnPropertyDescriptor(Gq.prototype,"handleTouchEvent"),Gq.prototype),Hq=Po(Gq.prototype,"_lineHeight",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Vq=Po(Gq.prototype,"_string",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),kq=Po(Gq.prototype,"_horizontalAlign",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yV.LEFT}}),Wq=Po(Gq.prototype,"_fontSize",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),jq=Po(Gq.prototype,"_maxWidth",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qq=Po(Gq.prototype,"_fontFamily",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),Xq=Po(Gq.prototype,"_font",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yq=Po(Gq.prototype,"_isSystemFontUsed",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kq=Po(Gq.prototype,"_userDefinedFont",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zq=Po(Gq.prototype,"_cacheMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TV.NONE}}),$q=Po(Gq.prototype,"_imageAtlas",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qq=Po(Gq.prototype,"_handleTouchEvent",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Uq=Gq))||Uq)||Uq)||Uq)||Uq)||Uq));var sX,rX,oX,aX,cX,lX,hX,uX,_X,dX,mX,pX,fX,gX,vX,yX,xX,SX,TX,EX,AX,CX,bX,RX;const wX=new _i,IX=new _i,OX=new _i,PX=new ci,MX=new Fi;var DX;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(DX||(DX={})),$e(DX);let LX=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((sX=Go("cc.ScrollBar"),rX=ta(),oX=Vo(110),aX=$o(),cX=Ho(xd),lX=va(eR),hX=ua(),uX=ra(),_X=va(DX),dX=ua(),mX=ra(),pX=ua(),fX=ra(),gX=ua(),vX=ra(),sX(yX=rX(yX=oX(yX=aX(yX=cX((RX=bX=class extends f_{constructor(...e){super(...e),Oo(this,"_scrollView",SX,this),Oo(this,"_handle",TX,this),Oo(this,"_direction",EX,this),Oo(this,"_enableAutoHide",AX,this),Oo(this,"_autoHideTime",CX,this),this._touching=!1,this._opacity=255,this._autoHideRemainingTime=0}get handle(){return this._handle}set handle(e){this._handle!==e&&(this._handle=e,this.onScroll(wX))}get direction(){return this._direction}set direction(e){this._direction!==e&&(this._direction=e,this.onScroll(new _i))}get enableAutoHide(){return this._enableAutoHide}set enableAutoHide(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}get autoHideTime(){return this._autoHideTime}set autoHideTime(e){this._autoHideTime!==e&&(this._autoHideTime=e)}hide(){this._autoHideRemainingTime=0,this._setOpacity(0)}show(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}onScroll(e){if(!this._scrollView)return;const t=this._scrollView.content;if(!t)return;const i=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize,s=this.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(i,n))return;this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));let r=0,o=0,a=0,c=0,l=0;this._direction===DX.HORIZONTAL?(r=i.width,o=n.width,l=s.width,a=e.x,c=-this._convertToScrollViewSpace(t).x):this._direction===DX.VERTICAL&&(r=i.height,o=n.height,l=s.height,a=e.y,c=-this._convertToScrollViewSpace(t).y);const h=this._calculateLength(r,o,l,a),u=this._calculatePosition(r,o,l,c,a,h);this._updateLength(h),this._updateHandlerPosition(u)}setScrollView(e){this._scrollView=e}onTouchBegan(){this._enableAutoHide&&(this._touching=!0)}onTouchEnded(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){const e=this._scrollView.content;if(e){const t=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}onEnable(){const e=this.node.getComponent(eR);e&&(this._opacity=e.color.a)}start(){this._enableAutoHide&&this._setOpacity(0)}update(e){this._processAutoHide(e)}_convertToScrollViewSpace(e){const t=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp;if(!t||!i)return wX;IX.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(IX,OX);const n=t.convertToNodeSpaceAR(OX);return n.x+=t.anchorX*t.width,n.y+=t.anchorY*t.height,n}_setOpacity(e){if(this._handle){let t=this.node.getComponent(eR);t&&(MX.set(t.color),MX.a=e,t.color=MX),t=this._handle.getComponent(eR),t&&(MX.set(t.color),MX.a=e,t.color=MX)}}_updateHandlerPosition(e){if(this._handle){const t=this._fixupHandlerPosition();this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}_fixupHandlerPosition(){const e=this.node._uiProps.uiTransformComp,t=e.contentSize,i=e.anchorPoint,n=this.handle.node._uiProps.uiTransformComp.contentSize,s=this.handle.node.parent;_i.set(IX,-t.width*i.x,-t.height*i.y,0);const r=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(IX,OX);let o=new _i;return s._uiProps.uiTransformComp.convertToNodeSpaceAR(r,o),this.direction===DX.HORIZONTAL?o=new _i(o.x,o.y+(t.height-n.height)/2,0):this.direction===DX.VERTICAL&&(o=new _i(o.x+(t.width-n.width)/2,o.y,0)),this.handle.node.setPosition(o),o}_conditionalDisableScrollBar(e,t){return e.width<=t.width&&this._direction===DX.HORIZONTAL||e.height<=t.height&&this._direction===DX.VERTICAL}_calculateLength(e,t,i,n){let s=e;n&&(s+=20*(n>0?n:-n));return i*(t/s)}_calculatePosition(e,t,i,n,s,r){let o=e-t;s&&(o+=Math.abs(s));let a=0;o&&(a=n/o,a=qt(a));const c=(i-r)*a;return this._direction===DX.VERTICAL?new _i(0,c,0):new _i(c,0,0)}_updateLength(e){if(this._handle){const t=this._handle.node._uiProps.uiTransformComp,i=t.contentSize,n=t.anchorPoint;n.x===PX.x&&n.y===PX.y||t.setAnchorPoint(PX),this._direction===DX.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}_processAutoHide(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);const e=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(e)}}},bX.Direction=DX,Po((xX=RX).prototype,"handle",[lX,hX,uX],Object.getOwnPropertyDescriptor(xX.prototype,"handle"),xX.prototype),Po(xX.prototype,"direction",[_X,dX,mX],Object.getOwnPropertyDescriptor(xX.prototype,"direction"),xX.prototype),Po(xX.prototype,"enableAutoHide",[pX,fX],Object.getOwnPropertyDescriptor(xX.prototype,"enableAutoHide"),xX.prototype),Po(xX.prototype,"autoHideTime",[gX,vX],Object.getOwnPropertyDescriptor(xX.prototype,"autoHideTime"),xX.prototype),SX=Po(xX.prototype,"_scrollView",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TX=Po(xX.prototype,"_handle",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EX=Po(xX.prototype,"_direction",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DX.HORIZONTAL}}),AX=Po(xX.prototype,"_enableAutoHide",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CX=Po(xX.prototype,"_autoHideTime",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yX=xX))||yX)||yX)||yX)||yX)||yX));var BX;let NX=e("ViewGroup",Go("cc.ViewGroup")(BX=Vo(110)(BX=class extends f_{})||BX)||BX);var FX,zX,UX,GX,HX,VX,kX,WX,jX,qX,XX,YX,KX,ZX,$X,QX,JX,eY,tY,iY,nY,sY,rY,oY,aY,cY,lY,hY,uY,_Y,dY,mY,pY,fY,gY,vY,yY,xY,SY,TY,EY,AY,CY,bY,RY,wY,IY,OY;i.ViewGroup=NX;const PY=new _i,MY=new _i,DY=new _i,LY=new ci,BY=new ci,NY=()=>(new Date).getMilliseconds(),FY={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};let zY;!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(zY||(zY={}));let UY=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((FX=Go("cc.ScrollView"),zX=ta(),UX=Vo(110),GX=$o(),HX=Ho(xd),VX=oa(),kX=ua(),WX=ra(),jX=oa(),qX=ua(),XX=ra(),YX=ua(),KX=ra(),ZX=ua(),$X=ra(),QX=va(kd),JX=ua(),eY=ra(),tY=ua(),iY=ra(),nY=va(LX),sY=ua(),rY=ra(),oY=ua(),aY=ra(),cY=va(LX),lY=ua(),hY=ra(),uY=ua(),_Y=ra(),dY=va([pO]),mY=ua(),pY=ra(),FX(fY=zX(fY=UX(fY=GX(fY=HX((OY=IY=class extends NX{constructor(...e){super(...e),Oo(this,"bounceDuration",vY,this),Oo(this,"brake",yY,this),Oo(this,"elastic",xY,this),Oo(this,"inertia",SY,this),Oo(this,"horizontal",TY,this),Oo(this,"vertical",EY,this),Oo(this,"cancelInnerEvents",AY,this),Oo(this,"scrollEvents",CY,this),this._autoScrolling=!1,this._scrolling=!1,Oo(this,"_content",bY,this),Oo(this,"_horizontalScrollBar",RY,this),Oo(this,"_verticalScrollBar",wY,this),this._topBoundary=0,this._bottomBoundary=0,this._leftBoundary=0,this._rightBoundary=0,this._touchMoveDisplacements=[],this._touchMoveTimeDeltas=[],this._touchMovePreviousTimestamp=0,this._touchMoved=!1,this._autoScrollAttenuate=!1,this._autoScrollStartPosition=new _i,this._autoScrollTargetDelta=new _i,this._autoScrollTotalTime=0,this._autoScrollAccumulatedTime=0,this._autoScrollCurrentlyOutOfBoundary=!1,this._autoScrollBraking=!1,this._autoScrollBrakingStartPosition=new _i,this._outOfBoundaryAmount=new _i,this._outOfBoundaryAmountDirty=!0,this._stopMouseWheel=!1,this._mouseWheelEventElapsedTime=0,this._isScrollEndedWithThresholdEventFired=!1,this._scrollEventEmitMask=0,this._isBouncing=!1,this._contentPos=new _i,this._deltaPos=new _i}get content(){return this._content}set content(e){if(this._content===e)return;let t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):g(4302)}get horizontalScrollBar(){return this._horizontalScrollBar}set horizontalScrollBar(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(PY)))}get verticalScrollBar(){return this._verticalScrollBar}set verticalScrollBar(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(PY)))}get view(){let e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}scrollToBottom(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new ci(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}scrollToTop(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new ci(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToLeft(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new ci(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToRight(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new ci(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToTopLeft(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new ci(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToTopRight(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new ci(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToBottomLeft(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new ci(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToBottomRight(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new ci(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToOffset(e,t,i=!0){const n=this.getMaxScrollOffset(),s=new ci(0,0);0===n.x?s.x=0:s.x=e.x/n.x,0===n.y?s.y=1:s.y=(n.y-e.y)/n.y,this.scrollTo(s,t,i)}getScrollOffset(){const e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new _i(t,e,0)}getMaxScrollOffset(){if(!this._content||!this.view)return PY;const e=this._content._uiProps.uiTransformComp.contentSize;let t=e.width-this.view.width,i=e.height-this.view.height;return t=t>=0?t:0,i=i>=0?i:0,new _i(t,i,0)}scrollToPercentHorizontal(e,t,i){const n=this._calculateMovePercentDelta({anchor:new ci(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}scrollTo(e,t,i){const n=this._calculateMovePercentDelta({anchor:new ci(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}scrollToPercentVertical(e,t,i){const n=this._calculateMovePercentDelta({anchor:new ci(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}stopAutoScroll(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}setContentPosition(e){if(!this._content)return;const t=this.getContentPosition();Math.abs(e.x-t.x)<1e-4&&Math.abs(e.y-t.y)<1e-4||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}getContentPosition(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):PY}isScrolling(){return this._scrolling}isAutoScrolling(){return this._autoScrolling}getScrollEndedEventTiming(){return 1e-4}start(){this._calculateBoundary(),this._content&&rO.once(sO.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}onEnable(){this._registerEvent(),this._content&&(this._content.on(kd.EventType.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(kd.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(kd.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(kd.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()}update(e){this._autoScrolling&&this._processAutoScrolling(e)}onDisable(){this._unregisterEvent(),this._content&&(this._content.off(kd.EventType.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(kd.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(kd.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(kd.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}_registerEvent(){this.node.on(kd.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(kd.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(kd.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(kd.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(kd.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_unregisterEvent(){this.node.off(kd.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(kd.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(kd.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(kd.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(kd.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_onMouseWheel(e,t){if(!this.enabledInHierarchy)return;if(this._hasNestedViewGroup(e,t))return;const i=new _i,n=e.getScrollY();this.vertical?i.set(0,-.1*n,0):this.horizontal&&i.set(-.1*n,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}_onTouchBegan(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}_onTouchMoved(e,t){if(!this.enabledInHierarchy||!this._content)return;if(this._hasNestedViewGroup(e,t))return;const i=e.touch;if(this._handleMoveLogic(i),!this.cancelInnerEvents)return;const n=i.getUILocation(LY);if(n.subtract(i.getUIStartLocation(BY)),n.length()>7&&!this._touchMoved&&e.target!==this.node){const t=new Uu(e.getTouches(),e.bubbles);t.type=kd.EventType.TOUCH_CANCEL,t.touch=e.touch,t.simulate=!0,e.target.dispatchEvent(t),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}_onTouchEnded(e,t){if(!this.enabledInHierarchy||!this._content||!e)return;if(this._hasNestedViewGroup(e,t))return;this._dispatchEvent(zY.TOUCH_UP);const i=e.touch;this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}_onTouchCancelled(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){const t=e.touch;this._handleReleaseLogic(t)}this._stopPropagationIfTargetIsMe(e)}}_calculateBoundary(){if(this._content&&this.view){const e=this._content.getComponent(kW);e&&e.enabledInHierarchy&&e.updateLayout();const t=this.view,i=t.width*t.anchorX,n=t.height*t.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}}_hasNestedViewGroup(e,t){if(e&&e.eventPhase===Fa.CAPTURING_PHASE){if(t)for(const i of t){const t=i;if(this.node===t)return!(!e.target||!e.target.getComponent(NX));if(t.getComponent(NX))return!0}return!1}}_startInertiaScroll(e){const t=new _i(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}_calculateAttenuatedFactor(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}_startAttenuatingAutoScroll(e,t){const i=new _i(e);if(i.normalize(),this._content&&this.view){const e=this._content._uiProps.uiTransformComp.contentSize,t=this.view.contentSize,n=e.width-t.width,s=e.height-t.height,r=this._calculateAttenuatedFactor(n),o=this._calculateAttenuatedFactor(s);i.x=i.x*n*(1-this.brake)*r,i.y=i.y*s*o*(1-this.brake),i.z=0}const n=e.length();let s=i.length()/n;if(i.add(e),this.brake>0&&s>7){s=Math.sqrt(s);const t=new _i(e);t.multiplyScalar(s),i.set(t),i.add(e)}let r=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&s>3&&(s=3,r*=s),0===this.brake&&s>1&&(r*=s),this._startAutoScroll(i,r,!0)}_calculateAutoScrollTimeByInitialSpeed(e){return Math.sqrt(Math.sqrt(e/5))}_startAutoScroll(e,t,i=!1){const n=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,_i.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new _i;this._getHowMuchOutOfBoundary().equals(PY,1e-4)||(this._autoScrollCurrentlyOutOfBoundary=!0)}_calculateTouchMoveVelocity(){let e=0;if(e=this._touchMoveTimeDeltas.reduce((e,t)=>e+t,e),e<=0||e>=.5)return new _i;let t=new _i;return t=this._touchMoveDisplacements.reduce((e,t)=>(e.add(t),e),t),new _i(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,0)}_flattenVectorByDirection(e){const t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}_moveContent(e,t){const i=this._flattenVectorByDirection(e);MY.set(this.getContentPosition()),MY.add(i),MY.set(1e-4*Math.floor(1e4*MY.x),1e-4*Math.floor(1e4*MY.y),MY.z),this.setContentPosition(MY);const n=this._getHowMuchOutOfBoundary();this._updateScrollBar(n),this.elastic&&t&&this._startBounceBackIfNeeded()}_getContentLeftBoundary(){if(!this._content)return-1;const e=this.getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width}_getContentRightBoundary(){if(!this._content)return-1;const e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width}_getContentTopBoundary(){if(!this._content)return-1;const e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height}_getContentBottomBoundary(){if(!this._content)return-1;const e=this.getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height}_getHowMuchOutOfBoundary(e){if((e=e||new _i).equals(PY,1e-4)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;let t=new _i;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals(PY,1e-4)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),t=this._clampDelta(t),t}_updateScrollBar(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}_onScrollBarTouchBegan(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}_onScrollBarTouchEnded(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}_dispatchEvent(e){if(e===zY.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===zY.SCROLL_TO_TOP||e===zY.SCROLL_TO_BOTTOM||e===zY.SCROLL_TO_LEFT||e===zY.SCROLL_TO_RIGHT){const t=1<<FY[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}pO.emitEvents(this.scrollEvents,this,FY[e]),this.node.emit(e,this)}_adjustContentOutOfBoundary(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){const e=this._getHowMuchOutOfBoundary();MY.set(this.getContentPosition()),MY.add(e),this._content.setPosition(MY),this._updateScrollBar(PY)}}_hideScrollBar(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}_updateScrollBarState(){if(!this._content||!this.view)return;const e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}_stopPropagationIfTargetIsMe(e){e.eventPhase===Fa.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}_processDeltaMove(e){this._scrollChildren(e),this._gatherTouchMove(e)}_handleMoveLogic(e){this._deltaPos.set(this._getLocalAxisAlignDelta(e)),this._processDeltaMove(this._deltaPos)}_handleReleaseLogic(e){this._deltaPos.set(this._getLocalAxisAlignDelta(e)),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(zY.SCROLL_ENDED))}_getLocalAxisAlignDelta(e){const t=this.node._uiProps.uiTransformComp,i=new _i;return t&&(e.getUILocation(LY),e.getUIPreviousLocation(BY),MY.set(LY.x,LY.y,0),DY.set(BY.x,BY.y,0),t.convertToNodeSpaceAR(MY,MY),t.convertToNodeSpaceAR(DY,DY),_i.subtract(i,MY,DY)),i}_scrollChildren(e){const t=e=this._clampDelta(e);let i,n;if(this.elastic&&(i=this._getHowMuchOutOfBoundary(),t.x*=0===i.x?1:.5,t.y*=0===i.y?1:.5),this.elastic||(i=this._getHowMuchOutOfBoundary(t),t.add(i)),this._content){const{anchorX:e,anchorY:i,width:s,height:r}=this._content._uiProps.uiTransformComp,o=this._content.position||PY;if(t.y>0){o.y-i*r+t.y>=this._bottomBoundary&&(n=zY.SCROLL_TO_BOTTOM)}else if(t.y<0){o.y-i*r+r+t.y<=this._topBoundary&&(n=zY.SCROLL_TO_TOP)}if(t.x<0){o.x-e*s+s+t.x<=this._rightBoundary&&(n=zY.SCROLL_TO_RIGHT)}else if(t.x>0){o.x-e*s+t.x>=this._leftBoundary&&(n=zY.SCROLL_TO_LEFT)}}this._moveContent(t,!1),0===t.x&&0===t.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent(zY.SCROLL_BEGAN)),this._dispatchEvent(zY.SCROLLING)),n&&n.length>0&&this._dispatchEvent(n)}_handlePressLogic(){this._autoScrolling&&this._dispatchEvent(zY.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=NY(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}_clampDelta(e){if(this._content&&this.view){const t=this.view.contentSize,i=this._content._uiProps.uiTransformComp;i.width<t.width&&(e.x=0),i.height<t.height&&(e.y=0)}return e}_gatherTouchMove(e){const t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);const i=NY();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}_startBounceBackIfNeeded(){if(!this.elastic)return!1;let e=this._getHowMuchOutOfBoundary();if(e=this._clampDelta(e),e.equals(PY,1e-4))return!1;const t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(zY.BOUNCE_TOP),e.y<0&&this._dispatchEvent(zY.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(zY.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(zY.BOUNCE_LEFT),this._isBouncing=!0),!0}_processInertiaScroll(){if(!this._startBounceBackIfNeeded()&&this.inertia){const e=this._calculateTouchMoveVelocity();!e.equals(MY,1e-4)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}_isOutOfBoundary(){return!this._getHowMuchOutOfBoundary().equals(PY,1e-4)}_isNecessaryAutoScrollBrake(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}_processAutoScrolling(e){const t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);let n=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);var s;this._autoScrollAttenuate&&(s=n,n=(s-=1)*s*s*s*s+1);const r=new _i(this._autoScrollTargetDelta);r.multiplyScalar(n);const o=new _i(this._autoScrollStartPosition);o.add(r);let a=Math.abs(n-1)<=1e-4;if(Math.abs(n-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(zY.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){const e=new _i(o);e.subtract(this._autoScrollBrakingStartPosition),t&&e.multiplyScalar(i),o.set(this._autoScrollBrakingStartPosition),o.add(e)}else{const e=new _i(o);e.subtract(this.getContentPosition());const t=this._getHowMuchOutOfBoundary(e);t.equals(PY,1e-4)||(o.add(t),a=!0)}a&&(this._autoScrolling=!1);const c=new _i(o);c.subtract(this.getContentPosition()),this._moveContent(this._clampDelta(c),a),this._dispatchEvent(zY.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(zY.SCROLL_ENDED))}_checkMouseWheel(e){if(!this._getHowMuchOutOfBoundary().equals(PY,1e-4))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(zY.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(zY.SCROLL_ENDED),this._stopMouseWheel=!1)}_calculateMovePercentDelta(e){const t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t.clampf(new ci(0,0),new ci(1,1));let s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;let r=this._getContentLeftBoundary()-this._leftBoundary;r=-r;const o=new _i;if(this._content&&this.view){let e=0;const a=this._content._uiProps.uiTransformComp.contentSize,c=this.view.contentSize;i&&(e=a.width-c.width,o.x=r-e*t.x),n&&(e=a.height-c.height,o.y=s-e*t.y)}return o}_moveContentToTopLeft(e){let t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;const i=new _i;let n=0,s=this._getContentLeftBoundary()-this._leftBoundary;if(s=-s,this._content){const r=this._content._uiProps.uiTransformComp.contentSize;r.height<e.height&&(n=r.height-e.height,i.y=t-n),r.width<e.width&&(n=r.width-e.width,i.x=s)}this._updateScrollBarState(),this._moveContent(i),this._adjustContentOutOfBoundary()}_scaleChanged(e){e===K_.SCALE&&this._calculateBoundary()}},IY.EventType=zY,vY=Po((gY=OY).prototype,"bounceDuration",[Xo,VX,kX,WX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yY=Po(gY.prototype,"brake",[Xo,jX,qX,XX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),xY=Po(gY.prototype,"elastic",[Xo,YX,KX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SY=Po(gY.prototype,"inertia",[Xo,ZX,$X],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Po(gY.prototype,"content",[QX,JX,eY],Object.getOwnPropertyDescriptor(gY.prototype,"content"),gY.prototype),TY=Po(gY.prototype,"horizontal",[Xo,tY,iY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Po(gY.prototype,"horizontalScrollBar",[nY,sY,rY],Object.getOwnPropertyDescriptor(gY.prototype,"horizontalScrollBar"),gY.prototype),EY=Po(gY.prototype,"vertical",[Xo,oY,aY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Po(gY.prototype,"verticalScrollBar",[cY,lY,hY],Object.getOwnPropertyDescriptor(gY.prototype,"verticalScrollBar"),gY.prototype),AY=Po(gY.prototype,"cancelInnerEvents",[Xo,uY,_Y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),CY=Po(gY.prototype,"scrollEvents",[dY,Xo,mY,pY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bY=Po(gY.prototype,"_content",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RY=Po(gY.prototype,"_horizontalScrollBar",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wY=Po(gY.prototype,"_verticalScrollBar",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fY=gY))||fY)||fY)||fY)||fY)||fY));var GY,HY,VY,kY,WY,jY,qY,XY,YY,KY,ZY,$Y,QY,JY,eK,tK,iK,nK,sK,rK,oK;const aK=new _i;var cK;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(cK||(cK={})),$e(cK);let lK=function(t){return e({Slider:t,SliderComponent:t}),t}((GY=Go("cc.Slider"),HY=ta(),VY=Vo(110),kY=$o(),WY=Ho(xd),jY=va(eR),qY=ra(),XY=va(cK),YY=ra(),KY=oa(),ZY=ra(),$Y=va([pO]),QY=ra(),GY(JY=HY(JY=VY(JY=kY(JY=WY((oK=rK=class extends f_{constructor(...e){super(...e),Oo(this,"slideEvents",tK,this),Oo(this,"_handle",iK,this),Oo(this,"_direction",nK,this),Oo(this,"_progress",sK,this),this._offset=new _i,this._dragging=!1,this._touchHandle=!1,this._handleLocalPos=new _i,this._touchPos=new _i}get handle(){return this._handle}set handle(e){this._handle!==e&&(this._handle=e)}get direction(){return this._direction}set direction(e){this._direction!==e&&(this._direction=e,this._changeLayout())}get progress(){return this._progress}set progress(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}__preload(){this._updateHandlePosition()}onEnable(){this._updateHandlePosition(),this.node.on(Du.TOUCH_START,this._onTouchBegan,this),this.node.on(Du.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(Du.TOUCH_END,this._onTouchEnded,this),this.node.on(Du.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(Du.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(Du.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(Du.TOUCH_END,this._onTouchEnded,this))}onDisable(){this.node.off(Du.TOUCH_START,this._onTouchBegan,this),this.node.off(Du.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(Du.TOUCH_END,this._onTouchEnded,this),this.node.off(Du.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(Du.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(Du.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(Du.TOUCH_END,this._onTouchEnded,this))}_onHandleDragStart(e){if(!e||!this._handle||!this._handle.node._uiProps.uiTransformComp)return;this._dragging=!0,this._touchHandle=!0;const t=e.touch.getUILocation();_i.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}_onTouchBegan(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}_onTouchMoved(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}_onTouchEnded(e){this._dragging=!1,this._touchHandle=!1,this._offset=new _i,e&&(e.propagationStopped=!0)}_onTouchCancelled(e){this._dragging=!1,e&&(e.propagationStopped=!0)}_handleSliderLogic(e){this._updateProgress(e),this._emitSlideEvent()}_emitSlideEvent(){pO.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}_updateProgress(e){if(!this._handle||!e)return;const t=e.getUILocation();_i.set(this._touchPos,t.x,t.y,0);const i=this.node._uiProps.uiTransformComp,n=i.convertToNodeSpaceAR(this._touchPos,aK);this.direction===cK.Horizontal?this.progress=qt(.5+(n.x-this._offset.x)/i.width):this.progress=qt(.5+(n.y-this._offset.y)/i.height)}_updateHandlePosition(){if(!this._handle)return;this._handleLocalPos.set(this._handle.node.getPosition());const e=this.node._uiProps.uiTransformComp;this._direction===cK.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}_changeLayout(){const e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){const e=this._handle.node.position;this._direction===cK.Horizontal?this._handle.node.setPosition(e.x,0,e.z):this._handle.node.setPosition(0,e.y,e.z),this._updateHandlePosition()}}},rK.Direction=cK,Po((eK=oK).prototype,"handle",[jY,qY],Object.getOwnPropertyDescriptor(eK.prototype,"handle"),eK.prototype),Po(eK.prototype,"direction",[XY,YY],Object.getOwnPropertyDescriptor(eK.prototype,"direction"),eK.prototype),Po(eK.prototype,"progress",[ha,KY,ZY],Object.getOwnPropertyDescriptor(eK.prototype,"progress"),eK.prototype),tK=Po(eK.prototype,"slideEvents",[$Y,Xo,QY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iK=Po(eK.prototype,"_handle",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nK=Po(eK.prototype,"_direction",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cK.Horizontal}}),sK=Po(eK.prototype,"_progress",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),JY=eK))||JY)||JY)||JY)||JY)||JY));function hK(...e){return Object.assign({},...e)}var uK,_K,dK,mK,pK,fK,gK,vK,yK,xK,SK,TK,EK,AK,CK,bK,RK,wK,IK,OK;!function(e){e.TOGGLE="toggle"}(OK||(OK={}));let PK=function(t){return e({Toggle:t,ToggleComponent:t}),t}((uK=Go("cc.Toggle"),_K=ta(),dK=Vo(110),mK=$o(),pK=Ho(xd),fK=ua(),gK=ra(),vK=va(eR),yK=ua(),xK=ra(),SK=va([pO]),TK=ra(),uK(EK=_K(EK=dK(EK=mK(EK=pK((IK=wK=class e extends uH{constructor(...e){super(...e),Oo(this,"checkEvents",CK,this),Oo(this,"_isChecked",bK,this),Oo(this,"_checkMark",RK,this)}get isChecked(){return this._isChecked}set isChecked(e){this._set(e)}get checkMark(){return this._checkMark}set checkMark(e){this._checkMark!==e&&(this._checkMark=e)}set _resizeToTarget(e){e&&this._resizeNodeToTargetNode()}get _toggleContainer(){const e=this.node.parent;return i.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}_internalToggle(){this.isChecked=!this.isChecked}_set(e,t=!0){if(this._isChecked==e)return;this._isChecked=e;const i=this._toggleContainer;i&&i.enabled&&this.enabled&&(e||!i.anyTogglesChecked()&&!i.allowSwitchOff)&&(this._isChecked=!0,i.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}playEffect(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}setIsCheckedWithoutNotify(e){this._set(e,!1)}onEnable(){super.onEnable(),this.playEffect(),this.node.on(e.EventType.CLICK,this._internalToggle,this)}onDisable(){super.onDisable(),this.node.off(e.EventType.CLICK,this._internalToggle,this)}OnDestroy(){let e=this._toggleContainer;e&&e.ensureValidState()}_emitToggleEvents(){this.node.emit(e.EventType.TOGGLE,this),this.checkEvents&&pO.emitEvents(this.checkEvents,this)}},wK.EventType=hK(OK,hH),Po((AK=IK).prototype,"isChecked",[fK,gK],Object.getOwnPropertyDescriptor(AK.prototype,"isChecked"),AK.prototype),Po(AK.prototype,"checkMark",[vK,yK,xK],Object.getOwnPropertyDescriptor(AK.prototype,"checkMark"),AK.prototype),CK=Po(AK.prototype,"checkEvents",[SK,Xo,TK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bK=Po(AK.prototype,"_isChecked",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),RK=Po(AK.prototype,"_checkMark",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EK=AK))||EK)||EK)||EK)||EK)||EK));var MK,DK,LK,BK,NK,FK,zK,UK,GK,HK,VK;let kK=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((MK=Go("cc.ToggleContainer"),DK=ta(),LK=Vo(110),BK=$o(),NK=ra(),FK=va([pO]),zK=ra(),MK(UK=DK(UK=LK(UK=BK(UK=Zo((HK=Po((GK=class extends f_{constructor(...e){super(...e),Oo(this,"_allowSwitchOff",HK,this),Oo(this,"checkEvents",VK,this)}get allowSwitchOff(){return this._allowSwitchOff}set allowSwitchOff(e){this._allowSwitchOff=e}get toggleItems(){return this.node.children.map(e=>{let t=e.getComponent("cc.Toggle");if(t&&t.enabled)return t}).filter(Boolean)}start(){this.ensureValidState()}activeToggles(){return this.toggleItems.filter(e=>e.isChecked)}anyTogglesChecked(){return!!this.toggleItems.find(e=>e.isChecked)}notifyToggleCheck(e,t=!0){if(this.enabledInHierarchy){for(let i=0;i<this.toggleItems.length;i++){let n=this.toggleItems[i];n!==e&&(t?n.isChecked=!1:n.setIsCheckedWithoutNotify(!1))}this.checkEvents&&i.Component.EventHandler.emitEvents(this.checkEvents,e)}}ensureValidState(){let e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){let t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}const t=this.activeToggles();if(t.length>1){let e=t[0];for(let i=0;i<t.length;++i){let n=t[i];n!==e&&(n.isChecked=!1)}}}}).prototype,"_allowSwitchOff",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Po(GK.prototype,"allowSwitchOff",[NK],Object.getOwnPropertyDescriptor(GK.prototype,"allowSwitchOff"),GK.prototype),VK=Po(GK.prototype,"checkEvents",[FK,Xo,zK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),UK=GK))||UK)||UK)||UK)||UK)||UK));var WK;let jK=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(Go("cc.UIMeshRenderer")(WK=ta()(WK=Vo(110)(WK=$o()(WK=class extends aG{constructor(...e){super(...e),this._models=null,this._modelComponent=null}get modelComponent(){return this._modelComponent}onLoad(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?(this._modelComponent._sceneGetter=rO.root.ui.getRenderSceneGetter(),this._models=this._modelComponent._collectModels()):console.warn(`node '${this.node&&this.node.name}' doesn't have any renderable component`)}onEnable(){super.onEnable(),this._modelComponent&&this._modelComponent._attachToScene()}onDisable(){super.onDisable(),this._modelComponent&&this._modelComponent._detachFromScene()}onDestroy(){super.onDestroy(),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,i.isValid(this._modelComponent,!0)&&this._modelComponent._attachToScene(),this._models=null)}updateAssembler(e){if(this._models){for(const t of this._models)e.commitModel.call(e,this,t,this._modelComponent.material);return!0}return!1}update(){this._fitUIRenderQueue()}_fitUIRenderQueue(){if(!this._modelComponent)return;const e=this._modelComponent.sharedMaterials.length;for(let t=0;t<e;t++){const e=this._modelComponent.getMaterialInstance(t);if(null==e)continue;const i=e.passes,n=i.length;for(let t=0;t<n;t++){const n=i[t];n._priority=Kc.MAX-11,n.blendState.targets[0].blend||e.overridePipelineStates({blendState:{targets:[{blend:!0}]}},t)}}}})||WK)||WK)||WK)||WK);var qK,XK,YK,KK,ZK,$K,QK,JK,eZ,tZ,iZ,nZ,sZ,rZ,oZ,aZ,cZ,lZ,hZ,uZ,_Z,dZ,mZ,pZ,fZ,gZ,vZ,yZ,xZ,SZ,TZ,EZ,AZ,CZ,bZ,RZ,wZ,IZ,OZ;const PZ=new _i;function MZ(e){return e instanceof Jw?LS:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:Di.ZERO}function DZ(e,t,i,n){let s=e.parent?e.parent.getScale():PZ,r=s.x,o=s.y,a=0,c=0;for(let l=e.parent;;){if(!l)return i.x=i.y=0,void(n.x=n.y=1);const e=l.getPosition();if(a+=e.x,c+=e.y,l=l.parent,l===t)break;{s=l?l.getScale():PZ;const e=s.x,t=s.y;a*=e,c*=t,r*=e,o*=t}}n.x=0!==r?1/r:1,n.y=0!==o?1/o:1,i.x=-a,i.y=-c}let LZ,BZ;!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(LZ||(LZ={})),$e(LZ),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(BZ||(BZ={}));const NZ=BZ.TOP|BZ.BOT,FZ=BZ.LEFT|BZ.RIGHT;let zZ=function(t){return e({Widget:t,WidgetComponent:t}),t}((qK=Go("cc.Widget"),XK=ta(),YK=Vo(110),KK=$o(),ZK=Ho(xd),$K=va(kd),QK=ra(),JK=ra(),eZ=ra(),tZ=ra(),iZ=ra(),nZ=ra(),sZ=ra(),rZ=na(),oZ=na(),aZ=va(LZ),cZ=ra(),qK(lZ=XK(lZ=YK(lZ=KK(lZ=ZK(lZ=Zo((OZ=IZ=class extends f_{constructor(...e){super(...e),this._lastPos=new _i,this._lastSize=new Di,this._dirty=!0,Oo(this,"_alignFlags",uZ,this),Oo(this,"_target",_Z,this),Oo(this,"_left",dZ,this),Oo(this,"_right",mZ,this),Oo(this,"_top",pZ,this),Oo(this,"_bottom",fZ,this),Oo(this,"_horizontalCenter",gZ,this),Oo(this,"_verticalCenter",vZ,this),Oo(this,"_isAbsLeft",yZ,this),Oo(this,"_isAbsRight",xZ,this),Oo(this,"_isAbsTop",SZ,this),Oo(this,"_isAbsBottom",TZ,this),Oo(this,"_isAbsHorizontalCenter",EZ,this),Oo(this,"_isAbsVerticalCenter",AZ,this),Oo(this,"_originalWidth",CZ,this),Oo(this,"_originalHeight",bZ,this),Oo(this,"_alignMode",RZ,this),Oo(this,"_lockFlags",wZ,this)}get target(){return this._target}set target(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}get isAlignTop(){return(this._alignFlags&BZ.TOP)>0}set isAlignTop(e){this._setAlign(BZ.TOP,e),this._recursiveDirty()}get isAlignBottom(){return(this._alignFlags&BZ.BOT)>0}set isAlignBottom(e){this._setAlign(BZ.BOT,e),this._recursiveDirty()}get isAlignLeft(){return(this._alignFlags&BZ.LEFT)>0}set isAlignLeft(e){this._setAlign(BZ.LEFT,e),this._recursiveDirty()}get isAlignRight(){return(this._alignFlags&BZ.RIGHT)>0}set isAlignRight(e){this._setAlign(BZ.RIGHT,e),this._recursiveDirty()}get isAlignVerticalCenter(){return(this._alignFlags&BZ.MID)>0}set isAlignVerticalCenter(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=BZ.MID):this._alignFlags&=~BZ.MID,this._recursiveDirty()}get isAlignHorizontalCenter(){return(this._alignFlags&BZ.CENTER)>0}set isAlignHorizontalCenter(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=BZ.CENTER):this._alignFlags&=~BZ.CENTER,this._recursiveDirty()}get isStretchWidth(){return(this._alignFlags&FZ)===FZ}get isStretchHeight(){return(this._alignFlags&NZ)===NZ}get top(){return this._top}set top(e){this._top=e,this._recursiveDirty()}get editorTop(){return this._isAbsTop?this._top:100*this._top}set editorTop(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}get bottom(){return this._bottom}set bottom(e){this._bottom=e,this._recursiveDirty()}get editorBottom(){return this._isAbsBottom?this._bottom:100*this._bottom}set editorBottom(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}get left(){return this._left}set left(e){this._left=e,this._recursiveDirty()}get editorLeft(){return this._isAbsLeft?this._left:100*this._left}set editorLeft(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}get right(){return this._right}set right(e){this._right=e,this._recursiveDirty()}get editorRight(){return this._isAbsRight?this._right:100*this._right}set editorRight(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}get horizontalCenter(){return this._horizontalCenter}set horizontalCenter(e){this._horizontalCenter=e,this._recursiveDirty()}get editorHorizontalCenter(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter}set editorHorizontalCenter(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}get verticalCenter(){return this._verticalCenter}set verticalCenter(e){this._verticalCenter=e,this._recursiveDirty()}get editorVerticalCenter(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter}set editorVerticalCenter(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}get isAbsoluteTop(){return this._isAbsTop}set isAbsoluteTop(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(BZ.TOP,this._isAbsTop))}get isAbsoluteBottom(){return this._isAbsBottom}set isAbsoluteBottom(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(BZ.BOT,this._isAbsBottom))}get isAbsoluteLeft(){return this._isAbsLeft}set isAbsoluteLeft(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(BZ.LEFT,this._isAbsLeft))}get isAbsoluteRight(){return this._isAbsRight}set isAbsoluteRight(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(BZ.RIGHT,this._isAbsRight))}get isAbsoluteHorizontalCenter(){return this._isAbsHorizontalCenter}set isAbsoluteHorizontalCenter(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(BZ.CENTER,this._isAbsHorizontalCenter))}get isAbsoluteVerticalCenter(){return this._isAbsVerticalCenter}set isAbsoluteVerticalCenter(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(BZ.MID,this._isAbsVerticalCenter))}get alignMode(){return this._alignMode}set alignMode(e){this._alignMode=e,this._recursiveDirty()}get alignFlags(){return this._alignFlags}set alignFlags(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}updateAlignment(){i._widgetManager.updateAlignment(this.node)}_validateTargetInDEV(){}setDirty(){this._recursiveDirty()}onEnable(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),i._widgetManager.add(this),this._registerEvent(),this._registerTargetEvents()}onDisable(){i._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}onDestroy(){this._removeParentEvent()}_adjustWidgetToAllowMovingInEditor(e){if(
/*!EDITOR ||*/
!(e&K_.POSITION))return;if(i._widgetManager.isAligning)return;const t=this,n=t.node.getPosition(),s=this._lastPos,r=new _i(n);r.subtract(s);let o=t.node.parent;const a=new _i(1,1,1);if(t.target&&(o=t.target,DZ(t.node,o,new _i,a)),!o)return;const c=MZ(o),l=new _i;0!==c.width&&0!==c.height&&_i.set(l,r.x/c.width,r.y/c.height,l.z),t.isAlignTop&&(t._top-=(t._isAbsTop?r.y:l.y)*a.y),t.isAlignBottom&&(t._bottom+=(t._isAbsBottom?r.y:l.y)*a.y),t.isAlignLeft&&(t._left+=(t._isAbsLeft?r.x:l.x)*a.x),t.isAlignRight&&(t._right-=(t._isAbsRight?r.x:l.x)*a.x),t.isAlignHorizontalCenter&&(t._horizontalCenter+=(t._isAbsHorizontalCenter?r.x:l.x)*a.x),t.isAlignVerticalCenter&&(t._verticalCenter+=(t._isAbsVerticalCenter?r.y:l.y)*a.y),this._recursiveDirty()}_adjustWidgetToAllowResizingInEditor(){if(i._widgetManager.isAligning)return;this.setDirty();const e=this,t=e.node._uiProps.uiTransformComp,n=t.contentSize,s=this._lastSize,r=new _i(n.width-s.width,n.height-s.height,0);let o=e.node.parent;const a=new _i(1,1,1);if(e.target&&(o=e.target,DZ(e.node,o,new _i,a)),!o)return;const c=MZ(o),l=new _i;0!==c.width&&0!==c.height&&_i.set(l,r.x/c.width,r.y/c.height,l.z);const h=t.anchorPoint;e.isAlignTop&&(e._top-=(e._isAbsTop?r.y:l.y)*(1-h.y)*a.y),e.isAlignBottom&&(e._bottom-=(e._isAbsBottom?r.y:l.y)*h.y*a.y),e.isAlignLeft&&(e._left-=(e._isAbsLeft?r.x:l.x)*h.x*a.x),e.isAlignRight&&(e._right-=(e._isAbsRight?r.x:l.x)*(1-h.x)*a.x),this._recursiveDirty()}_adjustWidgetToAnchorChanged(){this.setDirty()}_adjustTargetToParentChanged(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents()}_registerEvent(){this.node.on(Du.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.on(Du.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.on(Du.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(Du.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_unregisterEvent(){this.node.off(Du.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.off(Du.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.off(Du.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}_removeParentEvent(){this.node.off(Du.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_autoChangedValue(e,t){const i=(this._alignFlags&e)>0,n=this.node.parent&&this.node.parent._uiProps.uiTransformComp;if(!i||!n)return;const s=n.contentSize;this.isAlignLeft&&e===BZ.LEFT?this._left=t?this._left*s.width:this._left/s.width:this.isAlignRight&&e===BZ.RIGHT?this._right=t?this._right*s.width:this._right/s.width:this.isAlignHorizontalCenter&&e===BZ.CENTER?this._horizontalCenter=t?this._horizontalCenter*s.width:this._horizontalCenter/s.width:this.isAlignTop&&e===BZ.TOP?this._top=t?this._top*s.height:this._top/s.height:this.isAlignBottom&&e===BZ.BOT?this._bottom=t?this._bottom*s.height:this._bottom/s.height:this.isAbsoluteVerticalCenter&&e===BZ.MID&&(this._verticalCenter=this._verticalCenter/s.height),this._recursiveDirty()}_registerTargetEvents(){const e=this._target||this.node.parent;e&&(e.getComponent(xd)?(e.on(Du.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.on(Du.SIZE_CHANGED,this._targetChangedOperation,this)):y(6501,this.node.name))}_unregisterTargetEvents(){const e=this._target||this.node.parent;e&&(e.off(Du.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.off(Du.SIZE_CHANGED,this._targetChangedOperation,this))}_unregisterOldParentEvents(e){const t=this._target||e;t&&(t.off(Du.TRANSFORM_CHANGED,this._targetChangedOperation,this),t.off(Du.SIZE_CHANGED,this._targetChangedOperation,this))}_targetChangedOperation(){this._recursiveDirty()}_setAlign(e,t){if(t===(this._alignFlags&e)>0)return;const i=(e&FZ)>0,n=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=n.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=n.height))):(i?this.isStretchWidth&&(n.width=this._originalWidth):this.isStretchHeight&&(n.height=this._originalHeight),this._alignFlags&=~e)}_recursiveDirty(){this._dirty||(this._dirty=!0)}},IZ.AlignMode=LZ,Po((hZ=OZ).prototype,"target",[$K,QK],Object.getOwnPropertyDescriptor(hZ.prototype,"target"),hZ.prototype),Po(hZ.prototype,"isAlignTop",[JK],Object.getOwnPropertyDescriptor(hZ.prototype,"isAlignTop"),hZ.prototype),Po(hZ.prototype,"isAlignBottom",[eZ],Object.getOwnPropertyDescriptor(hZ.prototype,"isAlignBottom"),hZ.prototype),Po(hZ.prototype,"isAlignLeft",[tZ],Object.getOwnPropertyDescriptor(hZ.prototype,"isAlignLeft"),hZ.prototype),Po(hZ.prototype,"isAlignRight",[iZ],Object.getOwnPropertyDescriptor(hZ.prototype,"isAlignRight"),hZ.prototype),Po(hZ.prototype,"isAlignVerticalCenter",[nZ],Object.getOwnPropertyDescriptor(hZ.prototype,"isAlignVerticalCenter"),hZ.prototype),Po(hZ.prototype,"isAlignHorizontalCenter",[sZ],Object.getOwnPropertyDescriptor(hZ.prototype,"isAlignHorizontalCenter"),hZ.prototype),Po(hZ.prototype,"isStretchWidth",[rZ],Object.getOwnPropertyDescriptor(hZ.prototype,"isStretchWidth"),hZ.prototype),Po(hZ.prototype,"isStretchHeight",[oZ],Object.getOwnPropertyDescriptor(hZ.prototype,"isStretchHeight"),hZ.prototype),Po(hZ.prototype,"editorTop",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"editorTop"),hZ.prototype),Po(hZ.prototype,"editorBottom",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"editorBottom"),hZ.prototype),Po(hZ.prototype,"editorLeft",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"editorLeft"),hZ.prototype),Po(hZ.prototype,"editorRight",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"editorRight"),hZ.prototype),Po(hZ.prototype,"editorHorizontalCenter",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"editorHorizontalCenter"),hZ.prototype),Po(hZ.prototype,"editorVerticalCenter",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"editorVerticalCenter"),hZ.prototype),Po(hZ.prototype,"isAbsoluteTop",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"isAbsoluteTop"),hZ.prototype),Po(hZ.prototype,"isAbsoluteBottom",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"isAbsoluteBottom"),hZ.prototype),Po(hZ.prototype,"isAbsoluteLeft",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"isAbsoluteLeft"),hZ.prototype),Po(hZ.prototype,"isAbsoluteRight",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"isAbsoluteRight"),hZ.prototype),Po(hZ.prototype,"isAbsoluteHorizontalCenter",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"isAbsoluteHorizontalCenter"),hZ.prototype),Po(hZ.prototype,"isAbsoluteVerticalCenter",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"isAbsoluteVerticalCenter"),hZ.prototype),Po(hZ.prototype,"alignMode",[aZ,cZ],Object.getOwnPropertyDescriptor(hZ.prototype,"alignMode"),hZ.prototype),Po(hZ.prototype,"alignFlags",[ia],Object.getOwnPropertyDescriptor(hZ.prototype,"alignFlags"),hZ.prototype),uZ=Po(hZ.prototype,"_alignFlags",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_Z=Po(hZ.prototype,"_target",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dZ=Po(hZ.prototype,"_left",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mZ=Po(hZ.prototype,"_right",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pZ=Po(hZ.prototype,"_top",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fZ=Po(hZ.prototype,"_bottom",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gZ=Po(hZ.prototype,"_horizontalCenter",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vZ=Po(hZ.prototype,"_verticalCenter",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yZ=Po(hZ.prototype,"_isAbsLeft",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xZ=Po(hZ.prototype,"_isAbsRight",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SZ=Po(hZ.prototype,"_isAbsTop",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),TZ=Po(hZ.prototype,"_isAbsBottom",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),EZ=Po(hZ.prototype,"_isAbsHorizontalCenter",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),AZ=Po(hZ.prototype,"_isAbsVerticalCenter",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),CZ=Po(hZ.prototype,"_originalWidth",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bZ=Po(hZ.prototype,"_originalHeight",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RZ=Po(hZ.prototype,"_alignMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LZ.ON_WINDOW_RESIZE}}),wZ=Po(hZ.prototype,"_lockFlags",[Xo,Yo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lZ=hZ))||lZ)||lZ)||lZ)||lZ)||lZ)||lZ));var UZ,GZ,HZ,VZ,kZ,WZ,jZ,qZ,XZ,YZ,KZ,ZZ,$Z,QZ,JZ,e$,t$,i$,n$;i.internal.computeInverseTransForTarget=DZ,i.internal.getReadonlyNodeSize=MZ;const s$=new Fi;var r$;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(r$||(r$={})),$e(r$);let o$=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((UZ=Go("cc.PageViewIndicator"),GZ=ta(),HZ=Vo(110),VZ=$o(),kZ=va(_h),WZ=ra(),jZ=va(r$),qZ=ra(),XZ=va(Di),YZ=ra(),KZ=ra(),UZ(ZZ=GZ(ZZ=HZ(ZZ=VZ((n$=i$=class extends f_{constructor(...e){super(...e),Oo(this,"spacing",QZ,this),Oo(this,"_spriteFrame",JZ,this),Oo(this,"_direction",e$,this),Oo(this,"_cellSize",t$,this),this._layout=null,this._pageView=null,this._indicators=[]}get spriteFrame(){return this._spriteFrame}set spriteFrame(e){this._spriteFrame!==e&&(this._spriteFrame=e)}get direction(){return this._direction}set direction(e){this._direction!==e&&(this._direction=e)}get cellSize(){return this._cellSize}set cellSize(e){this._cellSize!==e&&(this._cellSize=e)}onLoad(){this._updateLayout()}setPageView(e){this._pageView=e,this._refresh()}_updateLayout(){this._layout=this.getComponent(kW),this._layout||(this._layout=this.addComponent(kW));const e=this._layout;this.direction===r$.HORIZONTAL?(e.type=kW.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===r$.VERTICAL&&(e.type=kW.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=kW.ResizeMode.CONTAINER}_createIndicator(){const e=new kd,t=e.addComponent(eR);return t.spriteFrame=this.spriteFrame,t.sizeMode=eR.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e}_changedState(){const e=this._indicators;if(0===e.length||!this._pageView)return;const t=this._pageView.curPageIdx;if(!(t>=e.length)){for(let t=0;t<e.length;++t){const i=e[t];if(!i._uiProps.uiComp)continue;const n=i._uiProps.uiComp;s$.set(n.color),s$.a=127.5,n.color=s$}if(e[t]._uiProps.uiComp){const i=e[t]._uiProps.uiComp;s$.set(i.color),s$.a=255,i.color=s$}}}_refresh(){if(!this._pageView)return;const e=this._indicators,t=this._pageView.getPages();if(t.length===e.length)return;let i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else{for(i=e.length-t.length;i>0;--i){const t=e[i-1];this.node.removeChild(t),e.splice(i-1,1)}}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}},i$.Direction=r$,Po(($Z=n$).prototype,"spriteFrame",[kZ,WZ],Object.getOwnPropertyDescriptor($Z.prototype,"spriteFrame"),$Z.prototype),Po($Z.prototype,"direction",[jZ,qZ],Object.getOwnPropertyDescriptor($Z.prototype,"direction"),$Z.prototype),Po($Z.prototype,"cellSize",[XZ,YZ],Object.getOwnPropertyDescriptor($Z.prototype,"cellSize"),$Z.prototype),QZ=Po($Z.prototype,"spacing",[Xo,KZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JZ=Po($Z.prototype,"_spriteFrame",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),e$=Po($Z.prototype,"_direction",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return r$.HORIZONTAL}}),t$=Po($Z.prototype,"_cellSize",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(20,20)}}),ZZ=$Z))||ZZ)||ZZ)||ZZ)||ZZ));var a$,c$,l$,h$,u$,_$,d$,m$,p$,f$,g$,v$,y$,x$,S$,T$,E$,A$,C$,b$,R$,w$,I$,O$,P$,M$,D$,L$,B$,N$,F$,z$,U$,G$,H$,V$,k$,W$,j$,q$,X$,Y$;const K$=new ci;var Z$,$$,Q$;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(Z$||(Z$={})),$e(Z$),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}($$||($$={})),$e($$),function(e){e.PAGE_TURNING="page-turning"}(Q$||(Q$={}));let J$=function(t){return e({PageView:t,PageViewComponent:t}),t}((a$=Go("cc.PageView"),c$=ta(),l$=Vo(110),h$=$o(),u$=va(Z$),_$=ra(),d$=va($$),m$=ra(),p$=oa(),f$=ra(),g$=oa(),v$=ra(),y$=va(o$),x$=ra(),S$=ra(),T$=va(LX),E$=na(),A$=va(LX),C$=na(),b$=na(),R$=na(),w$=na(),I$=va([pO]),O$=na(),P$=va([pO]),M$=ra(),a$(D$=c$(D$=l$(D$=h$((Y$=X$=class e extends UY{constructor(...e){super(...e),Oo(this,"autoPageTurningThreshold",B$,this),Oo(this,"horizontal",N$,this),Oo(this,"vertical",F$,this),Oo(this,"cancelInnerEvents",z$,this),Oo(this,"scrollEvents",U$,this),Oo(this,"pageTurningSpeed",G$,this),Oo(this,"pageEvents",H$,this),Oo(this,"_sizeMode",V$,this),Oo(this,"_direction",k$,this),Oo(this,"_scrollThreshold",W$,this),Oo(this,"_pageTurningEventTiming",j$,this),Oo(this,"_indicator",q$,this),this._curPageIdx=0,this._lastPageIdx=0,this._pages=[],this._initContentPos=new _i,this._scrollCenterOffsetX=[],this._scrollCenterOffsetY=[],this._touchBeganPosition=new _i,this._touchEndPosition=new _i}get sizeMode(){return this._sizeMode}set sizeMode(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}get direction(){return this._direction}set direction(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}get scrollThreshold(){return this._scrollThreshold}set scrollThreshold(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}get pageTurningEventTiming(){return this._pageTurningEventTiming}set pageTurningEventTiming(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}get indicator(){return this._indicator}set indicator(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}get curPageIdx(){return this._curPageIdx}get verticalScrollBar(){return super.verticalScrollBar}set verticalScrollBar(e){super.verticalScrollBar=e}get horizontalScrollBar(){return super.horizontalScrollBar}set horizontalScrollBar(e){super.horizontalScrollBar=e}__preload(){this.node.on(Du.SIZE_CHANGED,this._updateAllPagesSize,this)}onEnable(){super.onEnable(),this.node.on(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onDisable(){super.onDisable(),this.node.off(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onLoad(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}onDestroy(){this.node.off(Du.SIZE_CHANGED,this._updateAllPagesSize,this)}getCurrentPageIndex(){return this._curPageIdx}setCurrentPageIndex(e){this.scrollToPage(e,1)}getPages(){return this._pages}addPage(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):g(4301))}insertPage(e,t){if(t<0||!e||-1!==this._pages.indexOf(e)||!this.content)return;if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void g(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}}removePage(e){if(!e||!this.content)return;const t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):y(4300,e.name)}removePageAtIndex(e){const t=this._pages;if(e<0||e>=t.length)return;const i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}removeAllPages(){if(!this.content)return;const e=this._pages;for(let t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}scrollToPage(e,t=.3){e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())}getScrollEndedEventTiming(){return this.pageTurningEventTiming}_updatePageView(){if(!this.content)return;const e=this.content.getComponent(kW);e&&e.enabled&&e.updateLayout();const t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);const i=this._initContentPos;for(let e=0;e<t;++e){const t=this._pages[e].position;this.direction===$$.Horizontal?this._scrollCenterOffsetX[e]=Math.abs(i.x+t.x):this._scrollCenterOffsetY[e]=Math.abs(i.y+t.y)}this.indicator&&this.indicator._refresh()}_updateAllPagesSize(){let e=this.view;if(!this.content||!e)return;if(this._sizeMode!==Z$.Unified)return;const t=this._pages,i=e.contentSize;for(let e=0,n=t.length;e<n;e++)t[e]._uiProps.uiTransformComp.setContentSize(i)}_handleReleaseLogic(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(e.EventType.SCROLL_ENDED))}_onTouchBegan(e,t){e.touch.getUILocation(K$),_i.set(this._touchBeganPosition,K$.x,K$.y,0),super._onTouchBegan(e,t)}_onTouchMoved(e,t){super._onTouchMoved(e,t)}_onTouchEnded(e,t){e.touch.getUILocation(K$),_i.set(this._touchEndPosition,K$.x,K$.y,0),super._onTouchEnded(e,t)}_onTouchCancelled(e,t){e.touch.getUILocation(K$),_i.set(this._touchEndPosition,K$.x,K$.y,0),super._onTouchCancelled(e,t)}_onMouseWheel(){}_syncScrollDirection(){this.horizontal=this.direction===$$.Horizontal,this.vertical=this.direction===$$.Vertical}_syncSizeMode(){const e=this.view;if(!this.content||!e)return;const t=this.content.getComponent(kW);if(t){if(this._sizeMode===Z$.Free&&this._pages.length>0){const i=this._pages[0]._uiProps.uiTransformComp,n=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===$$.Horizontal?(t.paddingLeft=(e.width-i.width)/2,t.paddingRight=(e.width-n.width)/2):this.direction===$$.Vertical&&(t.paddingTop=(e.height-i.height)/2,t.paddingBottom=(e.height-n.height)/2)}t.updateLayout()}}_initPages(){if(!this.content)return;this._initContentPos=this.content.position;const e=this.content.children;for(let t=0;t<e.length;++t){const i=e[t];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}_dispatchPageTurningEvent(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,pO.emitEvents(this.pageEvents,this,Q$.PAGE_TURNING),this.node.emit(Q$.PAGE_TURNING,this))}_isQuicklyScrollable(e){if(this.direction===$$.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===$$.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}_moveOffsetValue(e){const t=new _i;if(this._sizeMode===Z$.Free)this.direction===$$.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===$$.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{const i=this.view;if(!i)return t;this.direction===$$.Horizontal?t.x=e*i.width:this.direction===$$.Vertical&&(t.y=e*i.height)}return t}_getDragDirection(e){return this._direction===$$.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1}_isScrollable(e,t,i){if(this._sizeMode===Z$.Free){let n=0,s=0;if(this.direction===$$.Horizontal)return n=this._scrollCenterOffsetX[t],s=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-s)*this.scrollThreshold;if(this.direction===$$.Vertical)return n=this._scrollCenterOffsetY[t],s=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-s)*this.scrollThreshold}else{const t=this.view;if(!t)return;if(this.direction===$$.Horizontal)return Math.abs(e.x)>=t.width*this.scrollThreshold;if(this.direction===$$.Vertical)return Math.abs(e.y)>=t.height*this.scrollThreshold}}_autoScrollToPage(){if(this._startBounceBackIfNeeded()){let e=this._getHowMuchOutOfBoundary();e=this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{const e=new _i;_i.subtract(e,this._touchBeganPosition,this._touchEndPosition);const t=this._curPageIdx,i=t+this._getDragDirection(e),n=this.pageTurningSpeed*Math.abs(t-i);if(i<this._pages.length){if(this._isScrollable(e,t,i))return void this.scrollToPage(i,n);{const e=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(e))return void this.scrollToPage(i,n)}}this.scrollToPage(t,n)}}},X$.SizeMode=Z$,X$.Direction=$$,X$.EventType=hK(Q$,zY),Po((L$=Y$).prototype,"sizeMode",[u$,_$],Object.getOwnPropertyDescriptor(L$.prototype,"sizeMode"),L$.prototype),Po(L$.prototype,"direction",[d$,m$],Object.getOwnPropertyDescriptor(L$.prototype,"direction"),L$.prototype),Po(L$.prototype,"scrollThreshold",[ha,p$,f$],Object.getOwnPropertyDescriptor(L$.prototype,"scrollThreshold"),L$.prototype),Po(L$.prototype,"pageTurningEventTiming",[ha,g$,v$],Object.getOwnPropertyDescriptor(L$.prototype,"pageTurningEventTiming"),L$.prototype),Po(L$.prototype,"indicator",[y$,x$],Object.getOwnPropertyDescriptor(L$.prototype,"indicator"),L$.prototype),B$=Po(L$.prototype,"autoPageTurningThreshold",[Xo,S$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),Po(L$.prototype,"verticalScrollBar",[T$,ya,E$],Object.getOwnPropertyDescriptor(L$.prototype,"verticalScrollBar"),L$.prototype),Po(L$.prototype,"horizontalScrollBar",[A$,ya,C$],Object.getOwnPropertyDescriptor(L$.prototype,"horizontalScrollBar"),L$.prototype),N$=Po(L$.prototype,"horizontal",[ya,Xo,b$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),F$=Po(L$.prototype,"vertical",[ya,Xo,R$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),z$=Po(L$.prototype,"cancelInnerEvents",[ya,Xo,w$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),U$=Po(L$.prototype,"scrollEvents",[I$,Xo,ya,O$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),G$=Po(L$.prototype,"pageTurningSpeed",[Xo,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),H$=Po(L$.prototype,"pageEvents",[P$,Xo,M$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),V$=Po(L$.prototype,"_sizeMode",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z$.Unified}}),k$=Po(L$.prototype,"_direction",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $$.Horizontal}}),W$=Po(L$.prototype,"_scrollThreshold",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),j$=Po(L$.prototype,"_pageTurningEventTiming",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),q$=Po(L$.prototype,"_indicator",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D$=L$))||D$)||D$)||D$)||D$));var eQ,tQ,iQ,nQ,sQ,rQ,oQ,aQ,cQ,lQ,hQ,uQ;let _Q=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}((eQ=Go("cc.UIStaticBatch"),tQ=ta(),iQ=$o(),nQ=Vo(110),sQ=na(),rQ=na(),oQ=na(),aQ=va(Lu),cQ=sa(),lQ=na(),eQ(hQ=tQ(hQ=iQ(hQ=nQ((Po((uQ=class extends hb{constructor(...e){super(...e),this._init=!1,this._meshBuffer=null,this._dirty=!0,this._lastMeshBuffer=null,this._uiDrawBatchList=[]}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}get color(){return this._color}set color(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}get sharedMaterials(){return super.sharedMaterials}set sharedMaterials(e){super.sharedMaterials=e}get drawBatchList(){return this._uiDrawBatchList}onLoad(){const e=this._getUI();if(!e)return;const t=eO,i=new qI(e);i.initialize(t,this._arrivalMaxBuffer),this._meshBuffer=i}onDestroy(){super.onDestroy(),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)}updateAssembler(e){this._dirty&&(e.finishMergeBatches(),this._lastMeshBuffer=e.currBufferBatch,e.currBufferBatch=this._meshBuffer,e.currStaticRoot=this),this._init&&(e.finishMergeBatches(),e.commitStaticBatch(this))}postUpdateAssembler(e){this._dirty&&(e.finishMergeBatches(),e.currBufferBatch=this._lastMeshBuffer,e.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadData())}markAsDirty(){this._getUI()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())}_requireDrawBatch(){const e=new QI;return e.isStatic=!0,this._uiDrawBatchList.push(e),e}_clearData(){if(this._meshBuffer){this._meshBuffer.reset();const e=this._getUI();for(let t=0;t<this._uiDrawBatchList.length;t++){this._uiDrawBatchList[t].destroy(e)}}this._uiDrawBatchList.length=0,this._init=!1}_getUI(){return rO.root&&rO.root.ui?rO.root.ui:(y(9301),null)}_arrivalMaxBuffer(){y(9300)}}).prototype,"dstBlendFactor",[ya,sQ],Object.getOwnPropertyDescriptor(uQ.prototype,"dstBlendFactor"),uQ.prototype),Po(uQ.prototype,"srcBlendFactor",[ya,rQ],Object.getOwnPropertyDescriptor(uQ.prototype,"srcBlendFactor"),uQ.prototype),Po(uQ.prototype,"color",[ya,oQ],Object.getOwnPropertyDescriptor(uQ.prototype,"color"),uQ.prototype),Po(uQ.prototype,"sharedMaterials",[ya,aQ,cQ,lQ],Object.getOwnPropertyDescriptor(uQ.prototype,"sharedMaterials"),uQ.prototype),hQ=uQ))||hQ)||hQ)||hQ)||hQ));var dQ,mQ,pQ;let fQ=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}(Go("cc.UIOpacity")(dQ=ta()(dQ=Vo(110)(dQ=$o()(dQ=Zo((Po((mQ=class extends f_{constructor(...e){super(...e),Oo(this,"_opacity",pQ,this)}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=e,this.node._uiProps.opacity=e/255)}onEnable(){this.node._uiProps.opacity=this._opacity/255}onDisable(){this.node._uiProps.opacity=1}}).prototype,"opacity",[ia],Object.getOwnPropertyDescriptor(mQ.prototype,"opacity"),mQ.prototype),pQ=Po(mQ.prototype,"_opacity",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),dQ=mQ))||dQ)||dQ)||dQ)||dQ)||dQ);var gQ;let vQ=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(Go("cc.SafeArea")(gQ=ta()(gQ=Vo(110)(gQ=Zo(gQ=$o()(gQ=Ho(zZ)(gQ=class extends f_{onEnable(){this.updateArea(),FC.on("canvas-resize",this.updateArea,this)}onDisable(){FC.off("canvas-resize",this.updateArea,this)}updateArea(){let e=this.node.getComponent(zZ),t=this.node.getComponent(xd);if(!e||!t)return;let{winSize:n,sys:s}=i;e.updateAlignment();let r=this.node.position,o=t.anchorPoint;e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;let a=n.width,c=n.height,l=s.getSafeAreaRect();console.log(l),e.top=c-l.y-l.height,e.bottom=l.y,e.left=l.x,e.right=a-l.x-l.width,e.updateAlignment();let h=this.node.position,u=o.x-(h.x-r.x)/t.width,_=o.y-(h.y-r.y)/t.height;t.setAnchorPoint(u,_),e.enabled=!0}})||gQ)||gQ)||gQ)||gQ)||gQ)||gQ);var yQ,xQ,SQ,TQ,EQ,AQ,CQ,bQ,RQ,wQ,IQ,OQ,PQ,MQ,DQ,LQ,BQ,NQ,FQ;let zQ=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((yQ=Go("cc.UICoordinateTracker"),xQ=ta(),SQ=$o(),TQ=Vo(110),EQ=va(kd),AQ=ra(),CQ=va(MM),bQ=ra(),RQ=ra(),wQ=ra(),IQ=va([pO]),OQ=ra(),yQ(PQ=xQ(PQ=SQ(PQ=TQ((Po((MQ=class extends f_{constructor(...e){super(...e),Oo(this,"syncEvents",DQ,this),Oo(this,"_target",LQ,this),Oo(this,"_camera",BQ,this),Oo(this,"_useScale",NQ,this),Oo(this,"_distance",FQ,this),this._transformPos=new _i,this._viewPos=new _i,this._canMove=!0,this._lastWPos=new _i,this._lastCameraPos=new _i}get target(){return this._target}set target(e){this._target!==e&&(this._target=e,this._checkCanMove())}get camera(){return this._camera}set camera(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}get useScale(){return this._useScale}set useScale(e){this._useScale!==e&&(this._useScale=e)}get distance(){return this._distance}set distance(e){this._distance!==e&&(this._distance=e)}onEnable(){this._checkCanMove()}update(){const e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&_i.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){const e=this._distance/Math.abs(this._viewPos.z);pO.emitEvents(this.syncEvents,this._transformPos,e)}}_checkCanMove(){this._canMove=!(!this._camera||!this._target)}}).prototype,"target",[EQ,AQ],Object.getOwnPropertyDescriptor(MQ.prototype,"target"),MQ.prototype),Po(MQ.prototype,"camera",[CQ,bQ],Object.getOwnPropertyDescriptor(MQ.prototype,"camera"),MQ.prototype),Po(MQ.prototype,"useScale",[RQ],Object.getOwnPropertyDescriptor(MQ.prototype,"useScale"),MQ.prototype),Po(MQ.prototype,"distance",[wQ],Object.getOwnPropertyDescriptor(MQ.prototype,"distance"),MQ.prototype),DQ=Po(MQ.prototype,"syncEvents",[IQ,Xo,OQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),LQ=Po(MQ.prototype,"_target",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BQ=Po(MQ.prototype,"_camera",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NQ=Po(MQ.prototype,"_useScale",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),FQ=Po(MQ.prototype,"_distance",[Xo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),PQ=MQ))||PQ)||PQ)||PQ)||PQ));var UQ;const GQ=[Du.TOUCH_START,Du.TOUCH_END,Du.TOUCH_MOVE,Du.MOUSE_DOWN,Du.MOUSE_MOVE,Du.MOUSE_UP,Du.MOUSE_ENTER,Du.MOUSE_LEAVE,Du.MOUSE_WHEEL];function HQ(e){e.propagationStopped=!0}let VQ=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(Go("cc.BlockInputEvents")(UQ=ta()(UQ=$o()(UQ=class extends f_{onEnable(){for(let e=0;e<GQ.length;e++)this.node.on(GQ[e],HQ,this)}onDisable(){for(let e=0;e<GQ.length;e++)this.node.off(GQ[e],HQ,this)}})||UQ)||UQ)||UQ);const kQ=new _i,WQ=new ci,jQ=new _i,qQ=new _i(1,1,1);function XQ(e,t){const i=t.target;let n;const s=jQ,r=qQ;if(i?(n=i,DZ(e,n,s,r)):n=e.parent,!n.getComponent(xd))return;const o=MZ(n),a=n instanceof Jw,c=a?WQ:n.getComponent(xd).anchorPoint,l=a;e.getPosition(kQ);const h=e._uiProps.uiTransformComp;let u=kQ.x,_=kQ.y;const d=h.anchorPoint,m=e.getScale();if(t.alignFlags&BZ.HORIZONTAL){let e=0,n=0;const a=o.width;l?(e=LS.left.x,n=LS.right.x):(e=-c.x*a,n=e+a),e+=t.isAbsoluteLeft?t.left:t.left*a,n-=t.isAbsoluteRight?t.right:t.right*a,i&&(e+=s.x,e*=r.x,n+=s.x,n*=r.x);let _=0,p=d.x,f=m.x;if(f<0&&(p=1-p,f=-f),t.isStretchWidth)_=n-e,0!==f&&(h.width=_/f),u=e+p*_;else if(_=h.width*f,t.isAlignHorizontalCenter){let e=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*a,n=(.5-c.x)*o.width;i&&(e*=r.x,n+=s.x,n*=r.x),u=n+(p-.5)*_+e}else u=t.isAlignLeft?e+p*_:n+(p-1)*_;t._lastSize.width=_}if(t.alignFlags&BZ.VERTICAL){let e=0,n=0;const a=o.height;l?(n=LS.bottom.y,e=LS.top.y):(n=-c.y*a,e=n+a),n+=t.isAbsoluteBottom?t.bottom:t.bottom*a,e-=t.isAbsoluteTop?t.top:t.top*a,i&&(n+=s.y,n*=r.y,e+=s.y,e*=r.y);let u=0,p=d.y,f=m.y;if(f<0&&(p=1-p,f=-f),t.isStretchHeight)u=e-n,0!==f&&(h.height=u/f),_=n+p*u;else if(u=h.height*f,t.isAlignVerticalCenter){let e=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*a,n=(.5-c.y)*o.height;i&&(e*=r.y,n+=s.y,n*=r.y),_=n+(p-.5)*u+e}else _=t.isAlignBottom?n+p*u:e+(p-1)*u;t._lastSize.height=u}e.setPosition(u,_,kQ.z),_i.set(t._lastPos,u,_,kQ.z)}function YQ(){const e=rO.getScene();if(e){if($Q.isAligning=!0,$Q._nodesOrderDirty)KQ.length=0,function e(t){const n=t.getComponent(zZ);if(n)if(XQ(t,n),n.alignMode!==LZ.ALWAYS)n.enabled=!1;else{if(!i.isValid(t,!0))return;KQ.push(n)}const s=t.children;for(const t of s)t.active&&e(t)}(e),$Q._nodesOrderDirty=!1;else{let e=null;const t=$Q._activeWidgetsIterator;for(t.i=0;t.i<KQ.length;++t.i)e=KQ[t.i],e._dirty&&(XQ(e.node,e),e._dirty=!1)}$Q.isAligning=!1}}const KQ=[];const ZQ=[],$Q=e("widgetManager",i._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Le.MutableForwardIterator(KQ),animationState:null,init(){if(rO.on(sO.EVENT_AFTER_UPDATE,YQ),Oa.isMobile){let e=this.onResized.bind(this);window.addEventListener("resize",e),window.addEventListener("orientationchange",e)}else DC.instance.on("design-resolution-changed",this.onResized,this)},add(e){this._nodesOrderDirty=!0;const t=rO.root.ui.getScreen(e.node._uiProps.uiTransformComp.visibility);t&&-1===ZQ.indexOf(t)&&(ZQ.push(t),t.node.on("design-resolution-changed",this.onResized,this))},remove(e){this._activeWidgetsIterator.remove(e)},onResized(){const e=rO.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized(e){if(kd.isNode(e)){const t=e.getComponent(zZ);t&&t.alignMode===LZ.ON_WINDOW_RESIZE&&(t.enabled=!0)}const t=e.children;for(const e of t)this.refreshWidgetOnResized(e)},updateOffsetsToStayPut(e,t){function i(e,t){return Math.abs(e-t)>1e-10?t:e}const n=e.node;let s=n.parent;if(s){const r=new _i,o=new _i(1,1,1);if(e.target&&(s=e.target,DZ(n,s,r,o)),!t)return;const a=s._uiProps.uiTransformComp,c=n._uiProps.uiTransformComp;if(!a)return void y(6501,e.node.name);const l=a.anchorPoint,h=MZ(s),u=c.anchorPoint,_=n.getPosition(),d=BZ,m=n.getScale();let p=0;if(t&d.LEFT){let t=-l.x*h.width;t+=r.x,t*=o.x,p=_.x-u.x*c.width*m.x-t,e.isAbsoluteLeft||(p/=h.width),p/=o.x,e.left=i(e.left,p)}if(t&d.RIGHT){let t=(1-l.x)*h.width;t+=r.x,p=(t*=o.x)-(_.x+(1-u.x)*c.width*m.x),e.isAbsoluteRight||(p/=h.width),p/=o.x,e.right=i(e.right,p)}if(t&d.TOP){let t=(1-l.y)*h.height;t+=r.y,p=(t*=o.y)-(_.y+(1-u.y)*c.height*m.y),e.isAbsoluteTop||(p/=h.height),p/=o.y,e.top=i(e.top,p)}if(t&d.BOT){let t=-l.y*h.height;t+=r.y,t*=o.y,p=_.y-u.y*c.height*m.y-t,e.isAbsoluteBottom||(p/=h.height),p/=o.y,e.bottom=i(e.bottom,p)}}},updateAlignment:function e(t){const i=t.parent;i&&kd.isNode(i)&&e(i);const n=t.getComponent(zZ);n&&i&&XQ(t,n)},AlignMode:LZ,AlignFlags:BZ});rO.on(sO.EVENT_INIT,()=>{$Q.init()});class QQ{constructor(e,t,i){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=i}}function JQ(e,t,i,n,s){let r=0,o=null;if(s===function(e,t,i,n){let s=0;for(let r=t,o=i-n;r<i;r+=n)s+=(e[o]-e[r])*(e[r+1]+e[o+1]),o=r;return s}(e,t,i,n)>0)for(r=t;r<i;r+=n)o=gJ(r,e[r],e[r+1],o);else for(r=i-n;r>=t;r-=n)o=gJ(r,e[r],e[r+1],o);return o&&dJ(o,o.next)&&(vJ(o),o=o.next),o}function eJ(e,t=null){if(!e)return e;t||(t=e);let i=e,n=!1;do{if(n=!1,i.steiner||!dJ(i,i.next)&&0!==_J(i.prev,i,i.next))i=i.next;else{if(vJ(i),i=t=i.prev,i===i.next)return null;n=!0}}while(n||i!==t);return t}function tJ(e,t,i,n,s,r,o=0){if(!e)return;!o&&r&&function(e,t,i,n){let s=e;do{null===s.z&&(s.z=cJ(s.x,s.y,t,i,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){let t=0,i=null,n=null,s=null,r=null,o=0,a=0,c=0,l=1;do{for(i=e,e=null,r=null,o=0;i;){for(o++,n=i,a=0,t=0;t<l&&(a++,n=n.nextZ,n);t++);for(c=l;a>0||c>0&&n;)0===a?(s=n,n=n.nextZ,c--):0!==c&&n?i.z<=n.z?(s=i,i=i.nextZ,a--):(s=n,n=n.nextZ,c--):(s=i,i=i.nextZ,a--),r?r.nextZ=s:e=s,s.prevZ=r,r=s;i=n}r.nextZ=null,l*=2}while(o>1)}(s)}(e,n,s,r);let a=e,c=null,l=null;for(;e.prev!==e.next;)if(c=e.prev,l=e.next,r?nJ(e,n,s,r):iJ(e))t.push(c.i/i),t.push(e.i/i),t.push(l.i/i),vJ(e),e=l.next,a=l.next;else if((e=l)===a){o?1===o?tJ(e=sJ(e,t,i),t,i,n,s,r,2):2===o&&rJ(e,t,i,n,s,r):tJ(eJ(e),t,i,n,s,r,1);break}}function iJ(e){const t=e.prev,i=e,n=e.next;if(_J(t,i,n)>=0)return!1;let s=e.next.next;for(;s!==e.prev;){if(hJ(t.x,t.y,i.x,i.y,n.x,n.y,s.x,s.y)&&_J(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function nJ(e,t,i,n){const s=e.prev,r=e,o=e.next;if(_J(s,r,o)>=0)return!1;const a=s.x<r.x?s.x<o.x?s.x:o.x:r.x<o.x?r.x:o.x,c=s.y<r.y?s.y<o.y?s.y:o.y:r.y<o.y?r.y:o.y,l=s.x>r.x?s.x>o.x?s.x:o.x:r.x>o.x?r.x:o.x,h=s.y>r.y?s.y>o.y?s.y:o.y:r.y>o.y?r.y:o.y,u=cJ(a,c,t,i,n),_=cJ(l,h,t,i,n);let d=e.nextZ;for(;d&&d.z<=_;){if(d!==e.prev&&d!==e.next&&hJ(s.x,s.y,r.x,r.y,o.x,o.y,d.x,d.y)&&_J(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(d=e.prevZ;d&&d.z>=u;){if(d!==e.prev&&d!==e.next&&hJ(s.x,s.y,r.x,r.y,o.x,o.y,d.x,d.y)&&_J(d.prev,d,d.next)>=0)return!1;d=d.prevZ}return!0}function sJ(e,t,i){let n=e;do{const s=n.prev,r=n.next.next;!dJ(s,r)&&mJ(s,n,n.next,r)&&pJ(s,r)&&pJ(r,s)&&(t.push(s.i/i),t.push(n.i/i),t.push(r.i/i),vJ(n),vJ(n.next),n=e=r),n=n.next}while(n!==e);return n}function rJ(e,t,i,n,s,r){let o=e;do{let e=o.next.next;for(;e!==o.prev;){if(o.i!==e.i&&uJ(o,e)){let a=fJ(o,e);return o=eJ(o,o.next),a=eJ(a,a.next),tJ(o,t,i,n,s,r),void tJ(a,t,i,n,s,r)}e=e.next}o=o.next}while(o!==e)}function oJ(e,t){return e.x-t.x}function aJ(e,t){if(t=function(e,t){let i=t;const n=e.x,s=e.y;let r=-1/0,o=null;do{if(s<=i.y&&s>=i.next.y){const e=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(e<=n&&e>r){if(r=e,e===n){if(s===i.y)return i;if(s===i.next.y)return i.next}o=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!o)return null;if(n===r)return o.prev;const a=o,c=o.x,l=o.y;let h,u=1/0;i=o.next;for(;i!==a;)n>=i.x&&i.x>=c&&hJ(s<l?n:r,s,c,l,s<l?r:n,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(n-i.x),(h<u||h===u&&i.x>o.x)&&pJ(i,e)&&(o=i,u=h)),i=i.next;return o}(e,t)){const i=fJ(t,e);eJ(i,i.next)}}function cJ(e,t,i,n,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/s)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function lJ(e){let t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}function hJ(e,t,i,n,s,r,o,a){return(s-o)*(t-a)-(e-o)*(r-a)>=0&&(e-o)*(n-a)-(i-o)*(t-a)>=0&&(i-o)*(r-a)-(s-o)*(n-a)>=0}function uJ(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&mJ(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&pJ(e,t)&&pJ(t,e)&&function(e,t){let i=e,n=!1;const s=(e.x+t.x)/2,r=(e.y+t.y)/2;do{i.y>r!=i.next.y>r&&s<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)}function _J(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function dJ(e,t){return e.x===t.x&&e.y===t.y}function mJ(e,t,i,n){return!!(dJ(e,t)&&dJ(i,n)||dJ(e,n)&&dJ(i,t))||_J(e,t,i)>0!=_J(e,t,n)>0&&_J(i,n,e)>0!=_J(i,n,t)>0}function pJ(e,t){return _J(e.prev,e,e.next)<0?_J(e,t,e.next)>=0&&_J(e,e.prev,t)>=0:_J(e,t,e.prev)<0||_J(e,e.next,t)<0}function fJ(e,t){const i=new QQ(e.i,e.x,e.y),n=new QQ(t.i,t.x,t.y),s=e.next,r=t.prev;return e.next=t,t.prev=e,i.next=s,s.prev=i,n.next=i,i.prev=n,r.next=n,n.prev=r,n}function gJ(e,t,i,n){const s=new QQ(e,t,i);return n?(s.next=n.next,s.prev=n,n.next.prev=s,n.next=s):(s.prev=s,s.next=s),s}function vJ(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function yJ(e,t,i){i=i||3;const n=t?t.length:0,s=n?t[0]*i:e.length;let r=JQ(e,0,s,i,!0);const o=[];if(!r)return o;let a=0,c=0,l=0,h=0,u=0,_=0,d=0;if(n&&(r=function(e,t,i,n){const s=[];let r=0,o=0,a=0,c=0,l=null;for(r=0,o=t.length;r<o;r++)a=t[r]*n,c=r<o-1?t[r+1]*n:e.length,l=JQ(e,a,c,n,!1),l&&(l===l.next&&(l.steiner=!0),s.push(lJ(l)));if(s.sort(oJ),!i)return i;for(r=0;r<s.length;r++)aJ(s[r],i),i=eJ(i,i.next);return i}(e,t,r,i)),e.length>80*i){a=l=e[0],c=h=e[1];for(let t=i;t<s;t+=i)u=e[t],_=e[t+1],u<a&&(a=u),_<c&&(c=_),u>l&&(l=u),_>h&&(h=_);d=Math.max(l-a,h-c)}return tJ(r,o,i,a,c,d),o}const xJ=Math.PI,SJ=Math.min,TJ=Math.max,EJ=Math.cos,AJ=Math.sin,CJ=Math.abs,bJ=Math.sign,RJ=.5522847493;function wJ(e,t,i,n,s){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+s*RJ,t-n*RJ,i+s,t,i+s),e.bezierCurveTo(t+n*RJ,i+s,t+n,i+s*RJ,t+n,i),e.bezierCurveTo(t+n,i-s*RJ,t+n*RJ,i-s,t,i-s),e.bezierCurveTo(t-n*RJ,i-s,t-n,i-s*RJ,t-n,i),e.close()}class IJ extends ci{constructor(e,t){super(e,t),this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0,this.reset()}reset(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}class OJ{constructor(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}reset(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}class PJ{constructor(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Fi.WHITE.clone(),this.lineCap=GW.BUTT,this.strokeColor=Fi.BLACK.clone(),this.lineJoin=HW.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataPool=new mo(()=>new zf,16),this._renderDataList=[],this._curPath=null}moveTo(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,VW.PT_CORNER),this._commandX=e,this._commandY=t}lineTo(e,t){this.addPoint(e,t,VW.PT_CORNER),this._commandX=e,this._commandY=t}bezierCurveTo(e,t,i,n,s,r){const o=this._curPath,a=o.points[o.points.length-1];a&&(a.x!==e||a.y!==t||i!==s||n!==r?(!function e(t,i,n,s,r,o,a,c,l,h,u){let _=0,d=0,m=0,p=0,f=0,g=0,v=0,y=0,x=0,S=0,T=0,E=0,A=0,C=0,b=0,R=0;h>10||(_=.5*(i+s),d=.5*(n+r),m=.5*(s+o),p=.5*(r+a),f=.5*(o+c),g=.5*(a+l),v=.5*(_+m),y=.5*(d+p),A=c-i,C=l-n,b=CJ((s-c)*C-(r-l)*A),R=CJ((o-c)*C-(a-l)*A),(b+R)*(b+R)<t.tessTol*(A*A+C*C)?t.addPoint(c,l,0===u?u|VW.PT_BEVEL:u):(x=.5*(m+f),S=.5*(p+g),T=.5*(v+x),E=.5*(y+S),e(t,i,n,_,d,v,y,T,E,h+1,0),e(t,T,E,x,S,f,g,c,l,h+1,u)))}(this,a.x,a.y,e,t,i,n,s,r,0,VW.PT_CORNER),this._commandX=s,this._commandY=r):this.lineTo(s,r))}quadraticCurveTo(e,t,i,n){const s=this._commandX,r=this._commandY;this.bezierCurveTo(s+2/3*(e-s),r+2/3*(t-r),i+2/3*(e-i),n+2/3*(t-n),i,n)}arc(e,t,i,n,s,r){!function(e,t,i,n,s,r,o){let a=0,c=0,l=0,h=0,u=0,_=0,d=0,m=0,p=0,f=0,g=0,v=0,y=0,x=0,S=0,T=0;if(c=r-s,o=o||!1)if(CJ(c)>=2*xJ)c=2*xJ;else for(;c<0;)c+=2*xJ;else if(CJ(c)>=2*xJ)c=2*-xJ;else for(;c>0;)c-=2*xJ;for(T=0|TJ(1,SJ(CJ(c)/(.5*xJ)+.5,5)),l=c/T/2,h=CJ(4/3*(1-EJ(l))/AJ(l)),o||(h=-h),S=0;S<=T;S++)a=s+c*(S/T),u=EJ(a),_=AJ(a),d=t+u*n,m=i+_*n,p=-_*n*h,f=u*n*h,0===S?e.moveTo(d,m):e.bezierCurveTo(g+y,v+x,d-p,m-f,d,m),g=d,v=m,y=p,x=f}(this,e,t,i,n,s,r)}ellipse(e,t,i,n){wJ(this,e,t,i,n),this._curPath.complex=!1}circle(e,t,i){wJ(this,e,t,i,i),this._curPath.complex=!1}rect(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}roundRect(e,t,i,n,s){!function(e,t,i,n,s,r){if(r<.1)e.rect(t,i,n,s);else{const o=SJ(r,.5*CJ(n))*bJ(n),a=SJ(r,.5*CJ(s))*bJ(s);e.moveTo(t,i+a),e.lineTo(t,i+s-a),e.bezierCurveTo(t,i+s-a*(1-RJ),t+o*(1-RJ),i+s,t+o,i+s),e.lineTo(t+n-o,i+s),e.bezierCurveTo(t+n-o*(1-RJ),i+s,t+n,i+s-a*(1-RJ),t+n,i+s-a),e.lineTo(t+n,i+a),e.bezierCurveTo(t+n,i+a*(1-RJ),t+n-o*(1-RJ),i,t+n-o,i),e.lineTo(t+o,i),e.bezierCurveTo(t+o*(1-RJ),i,t,i+a*(1-RJ),t,i+a),e.close()}}(this,e,t,i,n,s),this._curPath.complex=!1}clear(e=!1){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;const t=this._renderDataList;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&i.reset()}this._renderDataList.length=0,e&&this._renderDataPool.reset()}close(){this._curPath.closed=!0}requestRenderData(){const e=this._renderDataPool.add();return this._renderDataList.push(e),e}getRenderData(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}addPoint(e,t,i){const n=this._curPath;if(!n)return;const s=this._points,r=n.points;let o=s[this.pointsOffset++];o?(o.x=e,o.y=t):(o=new IJ(e,t),s.push(o)),o.flags=i,r.push(o)}_addPath(){const e=this.pathLength;let t=this.paths[e];return t?t.reset():(t=new OJ,this.paths.push(t)),this.pathLength++,this._curPath=t,t}}const MJ=Math.PI,DJ=Math.min,LJ=Math.max,BJ=Math.ceil,NJ=Math.acos,FJ=Math.cos,zJ=Math.sin,UJ=Math.atan2,GJ=[{name:Sn.ATTR_POSITION,format:En.RGB32F},{name:Sn.ATTR_COLOR,format:En.RGBA32F}];let HJ={dist:{name:"a_dist",format:En.R32F}};const VJ=[],kJ=[],WJ=[],jJ=[];let qJ=null,XJ=null;const YJ=new Fi,KJ=[];for(let e=0;e<4;e++)KJ.push(new _i);function ZJ(e,t,i){return e<t?t:e>i?i:e}const $J={useModel:!0,createImpl:e=>new PJ,updateRenderData(e){const t=e.impl?e.impl.getRenderData():[];for(let i=0,n=t.length;i<n;i++)t[i].material=e.getUIMaterialInstance()},fillBuffers(e,t){},renderIA(e,t){},getRenderData(e,t){if(!XJ)return null;const i=XJ.getRenderData();let n=i[XJ.dataOffset];if(!n)return null;let s=n;const r=s?s.vertexCount+t:0;return(r>65535||3*r>131070)&&(++XJ.dataOffset,XJ.dataOffset<i.length?n=i[XJ.dataOffset]:(n=XJ.requestRenderData(),i[XJ.dataOffset]=n),n.material=e.getUIMaterialInstance(),s=n),s&&s.vertexCount<r&&s.request(t,3*t),n},stroke(e){Fi.copy(YJ,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill(e){Fi.copy(YJ,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end(e){e.model&&e.model.inited&&e.model.destroy();const t=e.impl,i=wn.TRIANGLE_LIST,n=t&&t.getRenderData();if(!n)return;let s=0;VJ.length=0,jJ.length=0,kJ.length=0,WJ.length=0;for(const e of n){let t=e.byteCount>>2;const i=e.vData;for(s=0;s<t;)VJ.push(i[s++]),VJ.push(i[s++]),VJ.push(i[s++]),kJ.push(i[s++]),kJ.push(i[s++]),kJ.push(i[s++]),kJ.push(i[s++]),jJ.push(i[s++]);t=e.indicesCount;const n=e.iData;for(s=0;s<t;)WJ.push(n[s++])}if(0===VJ.length&&0===jJ.length&&0===kJ.length||0===WJ.length)return;const r=Yp({primitiveMode:i,positions:VJ,colors:kJ,attributes:GJ,customAttributes:[{attr:HJ.dist,values:jJ}],indices:WJ},void 0,{calculateBounds:!1});e.model.initialize(e.node),e.model.initSubModel(0,r.renderingSubMeshes[0],e.getUIMaterialInstance()),e.markForUpdateRenderData()},_expandStroke(e){const t=.5*e.lineWidth,i=e.lineCap,n=e.lineJoin,s=e.miterLimit;if(XJ=e.impl,!XJ)return;const r=function(e,t,i){const n=2*NJ(e/(e+i));return LJ(2,BJ(t/n))}(t,MJ,XJ.tessTol);this._calculateJoins(XJ,t,n,s);const o=XJ.paths;let a=0;for(let e=XJ.pathOffset,t=XJ.pathLength;e<t;e++){const t=o[e],s=t.points.length;n===HW.ROUND?a+=2*(s+t.bevel*(r+2)+1):a+=2*(s+5*t.bevel+1),t.closed||(i===GW.ROUND?a+=2*(2*r+2):a+=12)}const c=qJ=this.getRenderData(e,a);if(!c)return;const l=c.vData,h=c.iData;for(let e=XJ.pathOffset,s=XJ.pathLength;e<s;e++){const s=o[e],a=s.points,u=a.length,_=c.vertexStart;let d,m,p=0,f=0;const g=s.closed;if(g?(d=a[u-1],m=a[0],p=0,f=u):(d=a[0],m=a[1],p=1,f=u-1),!g){const e=new IJ(m.x,m.y);e.subtract(d),e.normalize();const n=e.x,s=e.y;i===GW.BUTT?this._buttCapStart(d,n,s,t,0):i===GW.SQUARE?this._buttCapStart(d,n,s,t,t):i===GW.ROUND&&this._roundCapStart(d,n,s,t,r)}for(let e=p;e<f;++e)n===HW.ROUND?this._roundJoin(d,m,t,t,r):0!=(m.flags&(VW.PT_BEVEL|VW.PT_INNERBEVEL))?this._bevelJoin(d,m,t,t):(this._vSet(m.x+m.dmx*t,m.y+m.dmy*t,1),this._vSet(m.x-m.dmx*t,m.y-m.dmy*t,-1)),d=m,m=a[e+1];if(g){let e=8*_;this._vSet(l[e],l[e+1],1),this._vSet(l[e+8],l[e+8+1],-1)}else{const e=new IJ(m.x,m.y);e.subtract(d),e.normalize();const n=e.x,s=e.y;i===GW.BUTT?this._buttCapEnd(m,n,s,t,0):i===GW.SQUARE?this._buttCapEnd(m,n,s,t,t):i===GW.ROUND&&this._roundCapEnd(m,n,s,t,r)}let v=c.indicesStart;for(let e=_+2,t=c.vertexStart;e<t;e++)h[v++]=e-2,h[v++]=e-1,h[v++]=e;if(c.indicesStart=v,v!==c.indicesCount){const e=new Array(c.indicesCount-v);c.iData.set(e,v)}}qJ=null,XJ=null},_expandFill(e){if(XJ=e.impl,!XJ)return;const t=XJ.paths;let i=0;for(let e=XJ.pathOffset,n=XJ.pathLength;e<n;e++){i+=t[e].points.length}const n=qJ=this.getRenderData(e,i);if(!n)return;const s=n,r=s.vData,o=s.iData;for(let e=XJ.pathOffset,i=XJ.pathLength;e<i;e++){const i=t[e],a=i.points,c=a.length;if(0===c)continue;const l=n.vertexStart;for(let e=0;e<c;++e)this._vSet(a[e].x,a[e].y);let h=n.indicesStart;if(i.complex){const e=[];for(let t=l,i=n.vertexStart;t<i;t++){let i=8*t;e.push(r[i++]),e.push(r[i++]),e.push(r[i++])}const t=yJ(e,null,3);if(!t||0===t.length)continue;for(let e=0,i=t.length;e<i;e++)o[h++]=t[e]+l}else{const e=l;for(let t=l+2,i=s.vertexStart;t<i;t++)o[h++]=e,o[h++]=t-1,o[h++]=t}if(s.indicesStart=h,h!==s.indicesCount){const e=new Array(s.indicesCount-h);s.iData.set(e,h)}}qJ=null,XJ=null},_calculateJoins(e,t,i,n){let s=0;t>0&&(s=1/t);const r=e.paths;for(let t=e.pathOffset,o=e.pathLength;t<o;t++){const e=r[t],o=e.points,a=o.length;let c=o[a-1],l=o[0];e.bevel=0;for(let t=0;t<a;t++){let r=0,a=0,h=0;const u=c.dy,_=-c.dx,d=l.dy,m=-l.dx;if(l.dmx=.5*(u+d),l.dmy=.5*(_+m),r=l.dmx*l.dmx+l.dmy*l.dmy,r>1e-6){let e=1/r;e>600&&(e=600),l.dmx*=e,l.dmy*=e}a=l.dx*c.dy-c.dx*l.dy,a>0&&(l.flags|=VW.PT_LEFT),h=LJ(11,DJ(c.len,l.len)*s),r*h*h<1&&(l.flags|=VW.PT_INNERBEVEL),l.flags&VW.PT_CORNER&&(r*n*n<1||i===HW.BEVEL||i===HW.ROUND)&&(l.flags|=VW.PT_BEVEL),0!=(l.flags&(VW.PT_BEVEL|VW.PT_INNERBEVEL))&&e.bevel++,c=l,l=o[t+1]}}},_flattenPaths(e){const t=e.paths;for(let i=e.pathOffset,n=e.pathLength;i<n;i++){const e=t[i],n=e.points;let s=n[n.length-1],r=n[0];s.equals(r)&&(e.closed=!0,n.pop(),s=n[n.length-1]);for(let e=0,t=n.length;e<t;e++){const t=new IJ(r.x,r.y);t.subtract(s),s.len=t.length(),(t.x||t.y)&&t.normalize(),s.dx=t.x,s.dy=t.y,s=r,r=n[e+1]}}},_chooseBevel(e,t,i,n){const s=i.x,r=i.y;let o=0,a=0,c=0,l=0;return 0!==e?(o=s+t.dy*n,a=r-t.dx*n,c=s+i.dy*n,l=r-i.dx*n):(o=c=s+i.dmx*n,a=l=r+i.dmy*n),[o,a,c,l]},_buttCapStart(e,t,i,n,s){const r=e.x-t*s,o=e.y-i*s,a=i,c=-t;this._vSet(r+a*n,o+c*n,1),this._vSet(r-a*n,o-c*n,-1)},_buttCapEnd(e,t,i,n,s){const r=e.x+t*s,o=e.y+i*s,a=i,c=-t;this._vSet(r+a*n,o+c*n,1),this._vSet(r-a*n,o-c*n,-1)},_roundCapStart(e,t,i,n,s){const r=e.x,o=e.y,a=i,c=-t;for(let e=0;e<s;e++){const l=e/(s-1)*MJ,h=FJ(l)*n,u=zJ(l)*n;this._vSet(r-a*h-t*u,o-c*h-i*u,1),this._vSet(r,o,0)}this._vSet(r+a*n,o+c*n,1),this._vSet(r-a*n,o-c*n,-1)},_roundCapEnd(e,t,i,n,s){const r=e.x,o=e.y,a=i,c=-t;this._vSet(r+a*n,o+c*n,1),this._vSet(r-a*n,o-c*n,-1);for(let e=0;e<s;e++){const l=e/(s-1)*MJ,h=FJ(l)*n,u=zJ(l)*n;this._vSet(r,o,0),this._vSet(r-a*h+t*u,o-c*h+i*u,1)}},_roundJoin(e,t,i,n,s){const r=e.dy,o=-e.dx,a=t.dy,c=-t.dx,l=t.x,h=t.y;if(0!=(t.flags&VW.PT_LEFT)){const u=this._chooseBevel(t.flags&VW.PT_INNERBEVEL,e,t,i),_=u[0],d=u[1],m=u[2],p=u[3],f=UJ(-o,-r);let g=UJ(-c,-a);g>f&&(g-=2*MJ),this._vSet(_,d,1),this._vSet(l-r*n,t.y-o*n,-1);const v=ZJ(BJ((f-g)/MJ)*s,2,s);for(let e=0;e<v;e++){const t=f+e/(v-1)*(g-f),i=l+FJ(t)*n,s=h+zJ(t)*n;this._vSet(l,h,0),this._vSet(i,s,-1)}this._vSet(m,p,1),this._vSet(l-a*n,h-c*n,-1)}else{const u=this._chooseBevel(t.flags&VW.PT_INNERBEVEL,e,t,-n),_=u[0],d=u[1],m=u[2],p=u[3],f=UJ(o,r);let g=UJ(c,a);g<f&&(g+=2*MJ),this._vSet(l+r*n,h+o*n,1),this._vSet(_,d,-1);const v=ZJ(BJ((g-f)/MJ)*s,2,s);for(let e=0;e<v;e++){const t=f+e/(v-1)*(g-f),n=l+FJ(t)*i,s=h+zJ(t)*i;this._vSet(n,s,1),this._vSet(l,h,0)}this._vSet(l+a*n,h+c*n,1),this._vSet(m,p,-1)}},_bevelJoin(e,t,i,n){let s=0,r=0,o=0,a=0,c=0,l=0,h=0,u=0;const _=e.dy,d=-e.dx,m=t.dy,p=-t.dx;if(t.flags&VW.PT_LEFT){const s=this._chooseBevel(t.flags&VW.PT_INNERBEVEL,e,t,i);c=s[0],l=s[1],h=s[2],u=s[3],this._vSet(c,l,1),this._vSet(t.x-_*n,t.y-d*n,-1),this._vSet(h,u,1),this._vSet(t.x-m*n,t.y-p*n,-1)}else{const c=this._chooseBevel(t.flags&VW.PT_INNERBEVEL,e,t,-n);s=c[0],r=c[1],o=c[2],a=c[3],this._vSet(t.x+_*i,t.y+d*i,1),this._vSet(s,r,-1),this._vSet(t.x+m*i,t.y+p*i,1),this._vSet(o,a,-1)}},_vSet(e,t,i=0){if(!qJ)return;const n=qJ;let s=8*n.vertexStart;const r=n.vData;r[s++]=e,r[s++]=t,r[s++]=0,Fi.toArray(r,YJ,s),s+=4,r[s++]=i,n.vertexStart++}},QJ=e("graphicsAssembler",{getAssembler:e=>$J});dj.Assembler=QJ;class JJ{constructor(){this.u=0,this.v=0,this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.validDefinition=!1,this.xAdvance=0}}class e0{constructor(){this._letterDefinitions={}}get letterDefinitions(){return this._letterDefinitions}addLetterDefinitions(e,t){this._letterDefinitions[e]=t}cloneLetterDefinition(){const e={};for(const t of Object.keys(this._letterDefinitions)){const i=new JJ;ye(i,this._letterDefinitions[t]),e[t]=i}return e}assignLetterDefinitions(e){for(const t of Object.keys(this._letterDefinitions)){const i=e[t];ye(this._letterDefinitions[t],i)}}scaleFontLetterDefinition(e){for(const t of Object.keys(this._letterDefinitions)){const i=this._letterDefinitions[t];i.width*=e,i.height*=e,i.offsetX*=e,i.offsetY*=e,i.xAdvance*=e}}getLetterDefinitionForChar(e){return this._letterDefinitions[e.charCodeAt(0)]}}i.FontAtlas=e0;class t0{constructor(){this.char="",this.valid=!0,this.positionX=0,this.positionY=0,this.lineIndex=0}}const i0=new Bi;let n0=null,s0=null;const r0=[],o0=[],a0=[],c0=[],l0=new Di;let h0=null,u0=null,_0=0,d0=0,m0=0,p0=0,f0=0,g0=1,v0=null;let y0="",x0=0,S0=0;const T0=new Di;let E0=0,A0=0,C0=0,b0=0,R0=0,w0=!1,I0=0,O0=0,P0=0;const M0={createData:e=>e.requestRenderData(),fillBuffers(e,t){hG(e.node,t,e.renderData,e.color)},appendQuad(e,t,i,n,s,r,o){const a=e.renderData;if(!a)return;const c=a.dataLength;a.dataLength+=4,a.vertexCount=a.dataLength,a.indicesCount=a.dataLength/2*3;const l=a.data,h=t.width,u=t.height,_=i.width,d=i.height;let m=0,p=0,f=0,g=0;n?(m=i.x/h,g=(i.x+d)/h,p=(i.y+_)/u,f=i.y/u,l[c].u=m,l[c].v=f,l[c+1].u=m,l[c+1].v=p,l[c+2].u=g,l[c+2].v=f,l[c+3].u=g,l[c+3].v=p):(m=i.x/h,g=(i.x+_)/h,p=(i.y+d)/u,f=i.y/u,l[c].u=m,l[c].v=p,l[c+1].u=g,l[c+1].v=p,l[c+2].u=m,l[c+2].v=f,l[c+3].u=g,l[c+3].v=f),l[c].x=s,l[c].y=r-d*o,l[c+1].x=s+_*o,l[c+1].y=r-d*o,l[c+2].x=s,l[c+2].y=r,l[c+3].x=s+_*o,l[c+3].y=r}};ve(M0,{updateRenderData(e){e.renderData&&e.renderData.vertDirty&&n0!==e&&(n0=e,s0=n0.node._uiProps.uiTransformComp,this._updateProperties(),this._updateContent(),n0.actualFontSize=x0,s0.setContentSize(T0),n0.renderData.vertDirty=n0.renderData.uvDirty=!1,n0=null,this._resetProperties())},_updateFontScale(){g0=x0/S0},_updateProperties(){if(!n0)return;const e=n0.font;if(!e)return;if(v0=e.spriteFrame,u0=e.fntConfig,h0=n0.fontAtlas,!h0){h0=new e0;const e=u0.fontDefDictionary;for(const t of Object.keys(e)){const i=new JJ,n=e[t].rect;i.offsetX=e[t].xOffset,i.offsetY=e[t].yOffset,i.width=n.width,i.height=n.height,i.u=n.x,i.v=n.y,i.textureID=0,i.validDefinition=!0,i.xAdvance=e[t].xAdvance,h0.addLetterDefinitions(t,i)}n0.fontAtlas=h0}y0=n0.string.toString(),x0=n0.fontSize,S0=u0.fontSize;const t=s0.contentSize;T0.width=t.width,T0.height=t.height,E0=n0.horizontalAlign,A0=n0.verticalAlign,C0=n0.spacingX,R0=n0.overflow,b0=n0.lineHeight,w0=R0!==SV.NONE&&(R0===SV.RESIZE_HEIGHT||n0.enableWrapText),this._setupBMFontOverflowMetrics()},_resetProperties(){h0=null,u0=null,v0=null},_updateContent(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText(){const e=y0,t=e.length,i=u0.kerningDict,n=r0;let s=-1;for(let r=0;r<t;++r){const o=e.charCodeAt(r),a=i[s<<16|65535&o]||0;n[r]=r<t-1?a:0,s=o}},_multilineTextWrap(e){const t=y0.length;let i=0,n=0,s=0,r=0,o=0,a=0,c=0,l=null;const h=new ci;this._updateFontScale();const u=h0.letterDefinitions;for(let _=0;_<t;){let d=y0.charAt(_);if("\n"===d){a0.push(o),o=0,i++,n=0,s-=b0*g0+0,this._recordPlaceholderInfo(_,d),_++;continue}const m=e(y0,_,t);let p=a,f=c,g=o,v=n,y=!1;for(let e=0;e<m;++e){const r=_+e;if(d=y0.charAt(r),"\r"===d){this._recordPlaceholderInfo(r,d);continue}if(l=h0&&h0.getLetterDefinitionForChar(d),!l){this._recordPlaceholderInfo(r,d),console.log("Can't find letter definition in texture atlas "+u0.atlasName+" for letter:"+d);continue}const a=v+l.offsetX*g0;if(w0&&P0>0&&n>0&&a+l.width*g0>P0&&!Eo(d)){a0.push(o),o=0,i++,n=0,s-=b0*g0+0,y=!0;break}h.x=a,h.y=s-l.offsetY*g0,this._recordLetterInfo(u,h,d,r,i),r+1<r0.length&&r<t-1&&(v+=r0[r+1]),v+=l.xAdvance*g0+C0,g=h.x+l.width*g0,p<h.y&&(p=h.y),f>h.y-l.height*g0&&(f=h.y-l.height*g0)}y||(n=v,o=g,a<p&&(a=p),c>f&&(c=f),r<o&&(r=o),_+=m)}return a0.push(o),_0=i+1,d0=_0*b0*g0,_0>1&&(d0+=0*(_0-1)),T0.width=I0,T0.height=O0,I0<=0&&(T0.width=parseFloat(r.toFixed(2))),O0<=0&&(T0.height=parseFloat(d0.toFixed(2))),p0=T0.height,f0=0,a>0&&(p0=T0.height+a),c<-d0&&(f0=d0+c),!0},_getFirstCharLen:()=>1,_getFirstWordLen(e,t,i){let n=e.charAt(t);if(To(n)||"\n"===n||Eo(n))return 1;let s=1,r=h0&&h0.getLetterDefinitionForChar(n);if(!r)return s;let o=r.xAdvance*g0+C0,a=0;for(let c=t+1;c<i&&(n=e.charAt(c),r=h0&&h0.getLetterDefinitionForChar(n),r);++c){if(a=o+r.offsetX*g0,a+r.width*g0>P0&&!Eo(n)&&P0>0)return s;if(o+=r.xAdvance*g0+C0,"\n"===n||Eo(n)||To(n))break;s++}return s},_multilineTextWrapByWord(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo(e,t){if(e>=o0.length){const e=new t0;o0.push(e)}o0[e].char=t,o0[e].valid=!1},_recordLetterInfo(e,t,i,n,s){if(n>=o0.length){const e=new t0;o0.push(e)}const r=i.charCodeAt(0);o0[n].lineIndex=s,o0[n].char=i,o0[n].valid=e[r].validDefinition,o0[n].positionX=t.x,o0[n].positionY=t.y},_alignText(){d0=0,a0.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),R0===SV.SHRINK&&x0>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||R0===SV.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown(e){let t=!0;e||(e=.1,t=!1),x0=e,t&&this._updateContent()},_shrinkLabelToContentSize(e){const t=x0,i=b0,n=h0;let s=0;const r=n?n.cloneLetterDefinition():{};let o=!0;for(;e();){++s;const e=t-s;if(o=!1,e<=0)break;const a=e/t;n&&(n.assignLetterDefinitions(r),n.scaleFontLetterDefinition(a)),b0=i*a,this._multilineTextWrapByWord(),this._computeAlignmentOffset()}b0=i,n&&n.assignLetterDefinitions(r),o||t-s>=0&&this._scaleFontSizeDown(t-s)},_isVerticalClamp:()=>d0>T0.height,_isHorizontalClamp(){if(!h0)return;let e=!1;for(let t=0,i=y0.length;t<i;++t){const i=o0[t];if(i.valid){const t=h0.getLetterDefinitionForChar(i.char);if(!t)continue;const n=i.positionX+t.width/2*g0,s=i.lineIndex;if(I0>0)if(w0){if(a0[s]>T0.width&&(n>T0.width||n<0)){e=!0;break}}else if(n>T0.width){e=!0;break}}}return e},_isHorizontalClamped(e,t){const i=a0[t],n=e>T0.width||e<0;return w0?i>T0.width&&n:n},_updateQuads(){if(!n0)return!1;const e=h0?h0.letterDefinitions:{},t=v0,i=n0.renderData;i.dataLength=i.vertexCount=i.indicesCount=0;const n=s0.anchorPoint,s=T0,r=n.x*s.width,o=n.y*s.height;let a=!0;for(let i=0,n=y0.length;i<n;++i){const n=o0[i];if(!n.valid)continue;const s=e[n.char.charCodeAt(0)];if(!s){console.warn("Can't find letter in this bitmap-font");continue}i0.height=s.height,i0.width=s.width,i0.x=s.u,i0.y=s.v;let c=n.positionY+m0;if(O0>0){if(c>p0){const e=c-p0;i0.y+=e,i0.height-=e,c-=e}c-s.height*g0<f0&&(i0.height=c<f0?0:c-f0)}const l=n.lineIndex,h=n.positionX+s.width/2*g0+c0[l];if(I0>0&&this._isHorizontalClamped(h,l))if(R0===SV.CLAMP)i0.width=0;else if(R0===SV.SHRINK){if(T0.width>s.width){a=!1;break}i0.width=0}if(v0&&i0.height>0&&i0.width>0){const e=v0.isRotated(),i=v0.getOriginalSize(),s=v0.getRect(),a=v0.getOffset(),l=a.x+(i.width-s.width)/2,h=a.y-(i.height-s.height)/2;if(e){const e=i0.x;i0.x=s.x+s.height-i0.y-i0.height-h,i0.y=e+s.y-l,i0.y<0&&(i0.height=i0.height+h)}else i0.x+=s.x-l,i0.y+=s.y+h;const u=n.positionX+c0[n.lineIndex];this.appendQuad(n0,t,i0,e,u-r,c-o,g0)}}return a},appendQuad(e,t,i,n,s,r,o){},_computeAlignmentOffset(){switch(c0.length=0,E0){case yV.LEFT:for(let e=0;e<_0;++e)c0.push(0);break;case yV.CENTER:for(let e=0,t=a0.length;e<t;e++)c0.push((T0.width-a0[e])/2);break;case yV.RIGHT:for(let e=0,t=a0.length;e<t;e++)c0.push(T0.width-a0[e])}switch(A0){case xV.TOP:m0=T0.height;break;case xV.CENTER:m0=(T0.height+d0)/2;break;case xV.BOTTOM:m0=d0}},_setupBMFontOverflowMetrics(){let e=T0.width,t=T0.height;R0===SV.RESIZE_HEIGHT&&(t=0),R0===SV.NONE&&(e=0,t=0),I0=e,O0=t,l0.width=e,l0.height=t,P0=e}});const D0=bV.Overflow,L0=Fi.WHITE.clone(),B0=bV.HorizontalAlign,N0=bV.VerticalAlign;class F0{constructor(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}}class z0{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}}class U0{constructor(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}updateRenderData(){this._updateProperties(),this._updateTexture()}destroy(){this.image=null}_updateProperties(){if(this.data=bV._canvasPool.get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;const e=Ao(this.context,this.char);this.width=parseFloat(e.toFixed(2)),this.height=this.labelInfo.fontSize}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new mc),this.image.reset(this.canvas)}_updateTexture(){if(!this.context||!this.canvas)return;const e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="middle",e.clearRect(0,0,i,n),e.fillStyle="rgba(255, 255, 255, 0.005)",e.fillRect(0,0,i,n),e.font=t.fontDesc;const s=i/2,r=n/2,o=t.color;if(e.lineJoin="round",e.fillStyle=`rgba(${o.r}, ${o.g}, ${o.b}, 1)`,t.isOutlined){const i=t.out||L0;e.strokeStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${i.a/255})`,e.lineWidth=2*t.margin,e.strokeText(this.char,s,r)}e.fillText(this.char,s,r)}}class G0 extends jc{initWithSize(e,t,i=rc.RGBA8888){this.reset({width:e,height:t,format:i}),this.loaded=!0,this.emit("load")}drawTextureAt(e,t,i){const n=this.getGFXTexture();if(!e||!n)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const r={buffStride:0,buffTexHeight:0,texOffset:{x:t,y:i,z:0},texExtent:{width:e.width,height:e.height,depth:1},texSubres:{mipLevel:0,baseArrayLayer:0,layerCount:1}};s.copyTexImagesToTexture([e.data],n,[r])}}class H0{get width(){return this._width}get height(){return this._height}constructor(e,t){this.texture=void 0,this._x=2,this._y=2,this._nextY=2,this._width=0,this._height=0,this._letterDefinitions=new Map,this._dirty=!1,this.texture=new G0,this.texture.initWithSize(e,t),this._width=e,this._height=t,rO.on(sO.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}insertLetterTexture(e){const t=e.image,i=rO.root.device;if(!t||!this.texture||!i)return null;const n=t.width,s=t.height;if(this._x+n+2>this._width&&(this._x=2,this._y=this._nextY),this._y+s>this._nextY&&(this._nextY=this._y+s+2),this._nextY>this._height)return null;this.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;const r=new z0;return r.u=this._x,r.v=this._y,r.texture=this.texture,r.valid=!0,r.w=e.width,r.h=e.height,r.xAdvance=e.width,this._x+=n+2,this._letterDefinitions.set(e.hash,r),r}update(){this._dirty&&(this._dirty=!1)}reset(){this._x=2,this._y=2,this._nextY=2,this._letterDefinitions.clear()}destroy(){this.reset(),this.texture&&this.texture.destroy()}beforeSceneLoad(){this.destroy();const e=new G0;e.initWithSize(this._width,this._height),this.texture=e}getLetter(e){return this._letterDefinitions.get(e)}addLetterDefinitions(e,t){this._letterDefinitions[e]=t}cloneLetterDefinition(){const e={};for(const t of Object.keys(this._letterDefinitions)){const i=new z0;ye(i,this._letterDefinitions[t]),e[t]=i}return e}assignLetterDefinitions(e){e.forEach((e,t)=>{ye(this._letterDefinitions[t],e)})}scaleFontLetterDefinition(e){for(const t of Object.keys(this._letterDefinitions)){const i=this._letterDefinitions[t];i.w*=e,i.h*=e,i.offsetX*=e,i.offsetY*=e,i.xAdvance*=e}}getLetterDefinitionForChar(e,t){const i=e.charCodeAt(0)+t.hash;let n=this._letterDefinitions.get(i);if(!n){const i=new U0(e,t);i.updateRenderData(),n=this.insertLetterTexture(i),i.destroy()}return n}}const V0=new Bi;let k0=null,W0=null;const j0=[],q0=[],X0=[],Y0=[],K0=new Di;let Z0=null,$0=0,Q0=0,J0=0,e1=0,t1=0,i1=1;let n1="",s1=0,r1=0;const o1=new Di;let a1=0,c1=0,l1=0,h1=0,u1=0,_1=!1,d1=0,m1=0,p1=0;let f1="",g1=!1;const v1={fontSize:0,lineHeight:0,hash:"",fontFamily:"",fontDesc:"Arial",hAlign:0,vAlign:0,color:L0,isOutlined:!1,out:L0,margin:0},y1={getAssemblerData:()=>(Z0||(Z0=new H0(1024,1024)),Z0.texture),updateRenderData(e){e.renderData&&e.renderData.vertDirty&&k0!==e&&(k0=e,W0=e.node._uiProps.uiTransformComp,this._updateFontFamily(e),v1.fontFamily=f1,this._updateProperties(),v1.fontDesc=this._getFontDesc(),this._updateContent(),k0.actualFontSize=s1,W0.setContentSize(o1),k0.renderData.vertDirty=k0.renderData.uvDirty=!1,k0=null,this._resetProperties())},_updateFontScale(){i1=s1/r1},_updateProperties(){if(!k0)return;n1=k0.string.toString(),s1=k0.fontSize,r1=s1;const e=W0.contentSize;o1.width=e.width,o1.height=e.height,a1=k0.horizontalAlign,c1=k0.verticalAlign,l1=k0.spacingX,u1=k0.overflow,h1=k0.lineHeight,g1=k0.isBold,_1=u1!==D0.NONE&&(u1===D0.RESIZE_HEIGHT||k0.enableWrapText);const t=k0.getComponent(yq);t&&t.enabled?(v1.isOutlined=!0,v1.margin=t.width,v1.out=t.color,v1.out.a=t.color.a*k0.color.a/255):(v1.isOutlined=!1,v1.margin=0),v1.lineHeight=h1,v1.fontSize=s1,v1.fontFamily=f1,v1.color=k0.color,v1.hash=this._computeHash(v1),this._setupBMFontOverflowMetrics()},_updateFontFamily(e){e.useSystemFont?f1=e.fontFamily:e.font?e.font._nativeAsset?f1=e.font._nativeAsset:(f1=ES.getRes(e.font.nativeUrl)||"",f1||ES.load(e.font.nativeUrl,(t,i)=>{f1=i||"Arial",e.font&&(e.font._nativeAsset=i),e.updateRenderData(!0)})):f1="Arial"},_computeHash(e){const t=e.color.toHEX("#rrggbb");let i="";return e.isOutlined&&(i=e.out.toHEX("#rrggbb")),""+e.fontSize+e.fontFamily+t+i},_getFontDesc(){let e=s1.toString()+"px ";return e+=f1,g1&&(e="bold "+e),e},_resetProperties(){},_updateContent(){this._updateFontScale(),this._alignText()},_computeHorizontalKerningForText(){},_multilineTextWrap(e){const t=n1.length;let i=0,n=0,s=0,r=0,o=0,a=0,c=0,l=null;const h=new ci(0,0);this._updateFontScale();for(let u=0;u<t;){let _=n1.charAt(u);if("\n"===_){X0.push(o),o=0,i++,n=0,s-=h1*i1+0,this._recordPlaceholderInfo(u,_),u++;continue}const d=e(n1,u,t);let m=a,p=c,f=o,g=n,v=!1;for(let e=0;e<d;++e){const r=u+e;if(_=n1.charAt(r),"\r"===_){this._recordPlaceholderInfo(r,_);continue}if(l=Z0&&Z0.getLetterDefinitionForChar(_,v1),!l){this._recordPlaceholderInfo(r,_);continue}const a=g+l.offsetX*i1;if(_1&&p1>0&&n>0&&a+l.w*i1>p1&&!Eo(_)){X0.push(o),o=0,i++,n=0,s-=h1*i1+0,v=!0;break}h.x=a,h.y=s-l.offsetY*i1,this._recordLetterInfo(h,_,r,i),r+1<j0.length&&r<t-1&&(g+=j0[r+1]),g+=l.xAdvance*i1+l1,f=h.x+l.w*i1,m<h.y&&(m=h.y),p>h.y-l.h*i1&&(p=h.y-l.h*i1)}v||(n=g,o=f,a<m&&(a=m),c>p&&(c=p),r<o&&(r=o),u+=d)}return X0.push(o),$0=i+1,Q0=$0*h1*i1,$0>1&&(Q0+=0*($0-1)),o1.width=d1,o1.height=m1,d1<=0&&(o1.width=parseFloat(r.toFixed(2))),m1<=0&&(o1.height=parseFloat(Q0.toFixed(2))),e1=o1.height,t1=0,a>0&&(e1=o1.height+a),c<-Q0&&(t1=Q0+c),!0},_getFirstCharLen:()=>1,_getFirstWordLen(e,t,i){let n=e.charAt(t);if(To(n)||"\n"===n||Eo(n))return 1;if(!Z0)return;let s=1,r=Z0.getLetterDefinitionForChar(n,v1);if(!r)return s;let o,a=r.xAdvance*i1+l1;for(let c=t+1;c<i&&(n=e.charAt(c),r=Z0.getLetterDefinitionForChar(n,v1),r);++c){if(o=a+r.offsetX*i1,o+r.w*i1>p1&&!Eo(n)&&p1>0)return s;if(a+=r.xAdvance*i1+l1,"\n"===n||Eo(n)||To(n))break;s++}return s},_multilineTextWrapByWord(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo(e,t){if(e>=q0.length){const e=new F0;q0.push(e)}q0[e].char=t,q0[e].hash=t.charCodeAt(0)+v1.hash,q0[e].valid=!1},_recordLetterInfo(e,t,i,n){if(i>=q0.length){const e=new F0;q0.push(e)}const s=t.charCodeAt(0)+v1.hash;q0[i].line=n,q0[i].char=t,q0[i].hash=s;const r=Z0&&Z0.getLetter(s);q0[i].valid=!!r&&!!r.valid,q0[i].x=e.x,q0[i].y=e.y},_alignText(){Q0=0,X0.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),this._updateQuads()},_scaleFontSizeDown(e){let t=!0;e||(e=.1,t=!1),s1=e,t&&this._updateContent()},_isVerticalClamp:()=>Q0>o1.height,_isHorizontalClamp(){let e=!1;for(let t=0,i=n1.length;t<i;++t){const i=q0[t];if(i.valid){const t=Z0.getLetter(i.hash);if(!t)continue;const n=i.x+t.w*i1,s=i.line;if(d1>0)if(_1){if(X0[s]>o1.width&&(n>o1.width||n<0)){e=!0;break}}else if(n>o1.width){e=!0;break}}}return e},_isHorizontalClamped(e,t){const i=X0[t],n=e>o1.width||e<0;return _1?i>o1.width&&n:n},_updateQuads(){if(!k0||!Z0)return;const e=Z0.texture,t=(k0.node,k0.renderData);t.dataLength=t.vertexCount=t.indicesCount=0;const i=o1,n=W0.anchorPoint,s=n.x*i.width,r=n.y*i.height;let o=!0;for(let t=0,i=n1.length;t<i;++t){const i=q0[t];if(!i.valid)continue;const n=Z0.getLetter(i.hash);if(!n)continue;V0.height=n.h,V0.width=n.w,V0.x=n.u,V0.y=n.v;let a=i.y+J0;if(m1>0){if(a>e1){const e=a-e1;V0.y+=e,V0.height-=e,a-=e}a-n.h*i1<t1&&(V0.height=a<t1?0:a-t1)}const c=i.line,l=i.x+n.w/2*i1+Y0[c];if(d1>0&&this._isHorizontalClamped(l,c))if(u1===D0.CLAMP)V0.width=0;else if(u1===D0.SHRINK){if(o1.width>n.w){o=!1;break}V0.width=0}if(V0.height>0&&V0.width>0){const t=i.x+Y0[i.line];this.appendQuad(k0,e,V0,!1,t-s,a-r,i1)}}return o},appendQuad(e,t,i,n,s,r,o){},_computeAlignmentOffset(){switch(Y0.length=0,a1){case B0.LEFT:for(let e=0;e<$0;++e)Y0.push(0);break;case B0.CENTER:for(let e=0,t=X0.length;e<t;e++)Y0.push((o1.width-X0[e])/2);break;case B0.RIGHT:for(let e=0,t=X0.length;e<t;e++)Y0.push(o1.width-X0[e])}switch(c1){case N0.TOP:J0=o1.height;break;case N0.CENTER:J0=(o1.height+Q0)/2-(h1-s1)/2;break;case N0.BOTTOM:J0=(o1.height+Q0)/2-(h1-s1)}},_setupBMFontOverflowMetrics(){let e=o1.width,t=o1.height;u1===D0.RESIZE_HEIGHT&&(t=0),u1===D0.NONE&&(e=0,t=0),d1=e,m1=t,K0.width=e,K0.height=t,p1=e}},x1=new Fi(255,255,255,255),S1={createData:e=>e.requestRenderData(),fillBuffers(e,t){if(!e.renderData)return;const i=e.node;x1.a=e.color.a,hG(i,t,e.renderData,x1)},appendQuad:M0.appendQuad};ve(S1,y1);const T1=bV.Overflow,E1=Fi.WHITE.clone(),A1=Te(yq,f_);let C1=null,b1=null,R1=null,w1="",I1="",O1=0,P1=0,M1=[];const D1=new Di;let L1=0,B1=0,N1=0,F1=new Fi,z1="",U1=T1.NONE,G1=!1,H1=!1;const V1=new Fi;let k1=0,W1=0,j1=!1,q1=!1,X1=!1;const Y1={getAssemblerData(){const e=bV._canvasPool.get();return e.canvas.width=e.canvas.height=1,e},resetAssemblerData(e){e&&bV._canvasPool.put(e)},updateRenderData(e){if(!e.renderData||!e.renderData.vertDirty)return;let t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._calculateSplitStrings(),this._updateLabelDimensions(),this._calculateTextBaseline(),this._updateTexture(),e.actualFontSize=O1,t.setContentSize(D1),this.updateVertexData(e),e.markForUpdateRenderData(!1),C1=null,b1=null,R1=null},updateVertexData(e){},_updateFontFamily(e){e.useSystemFont?z1=e.fontFamily:e.font?e.font._nativeAsset?z1=e.font._nativeAsset:ES.load(e.font.nativeUrl,(t,i)=>{z1=i||"Arial",e.font._nativeAsset=i,e.updateRenderData(!0)}):z1="Arial"},_updateProperties(e,t){const i=e.assemblerData;if(!i)return;C1=i.context,b1=i.canvas,R1=e.spriteFrame,I1=e.string.toString(),O1=e.fontSize,P1=O1,U1=e.overflow,D1.width=t.width,D1.height=t.height,L1=e.lineHeight,B1=e.horizontalAlign,N1=e.verticalAlign,F1=e.color,j1=e.isBold,q1=e.isItalic,X1=e.isUnderline,G1=U1!==T1.NONE&&(U1===T1.RESIZE_HEIGHT||e.enableWrapText);const n=A1&&e.getComponent(yq);n&&n.enabled?(H1=!0,W1=k1=n.width,V1.set(n.color),V1.a=V1.a*e.color.a/255):(H1=!1,W1=0)},_calculateFillTextStartPosition(){const e=this._getLineHeight(),t=M1.length;let i=0,n=0;return i=B1===yV.RIGHT?D1.width-W1:B1===yV.CENTER?D1.width/2:0+W1,n=N1===xV.TOP?O1*(fo/2):N1===xV.CENTER?D1.height/2-e*(t-1)/2:D1.height-e*(t-1),new ci(i,n)},_updateTexture(){if(!C1||!b1)return;C1.clearRect(0,0,b1.width,b1.height),C1.font=w1;const e=this._calculateFillTextStartPosition(),t=this._getLineHeight();let i;C1.lineJoin="round",C1.fillStyle=`rgba(${F1.r}, ${F1.g}, ${F1.b}, ${F1.a/255})`;for(let n=0;n<M1.length;++n){if(H1){const i=V1||E1;C1.strokeStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${i.a/255})`,C1.lineWidth=2*k1,C1.strokeText(M1[n],e.x,e.y+n*t)}C1.fillText(M1[n],e.x,e.y+n*t),X1&&(i=this._calculateUnderlineStartPosition(),C1.save(),C1.beginPath(),C1.lineWidth=O1/8,C1.strokeStyle=`rgba(${F1.r}, ${F1.g}, ${F1.b}, ${F1.a/255})`,C1.moveTo(i.x,i.y+n*t-1),C1.lineTo(i.x+b1.width,i.y+n*t-1),C1.stroke(),C1.restore())}if(R1){let e;e=R1 instanceof _h?R1.texture:R1;0!==b1.width&&0!==b1.height&&(e.reset({width:b1.width,height:b1.height,mipmapLevel:1}),e.uploadData(b1))}},_calculateUnderlineStartPosition(){const e=this._getLineHeight(),t=M1.length,i=0+W1;let n=0;return n=N1===xV.TOP?O1:N1===xV.CENTER?D1.height/2-e*(t-1)/2+O1/2:D1.height-e*(t-1),new ci(i,n)},_updateLabelDimensions(){if(!C1)return;const e=I1.split("\n");if(U1===T1.RESIZE_HEIGHT)D1.height=(M1.length+fo)*this._getLineHeight();else if(U1===T1.NONE){M1=e;let t=0,i=0;for(const i of e){const e=Ao(C1,i);t=t>e?t:e}i=(M1.length+fo)*this._getLineHeight(),D1.width=parseFloat(t.toFixed(2))+2*W1,D1.height=parseFloat(i.toFixed(2)),q1&&(D1.width+=P1*Math.tan(.20943951))}b1&&(b1.width=D1.width,b1.height=D1.height)},_calculateTextBaseline(){let e,t;e=B1===yV.RIGHT?"right":B1===yV.CENTER?"center":"left",t=N1===xV.TOP?"top":N1===xV.CENTER?"middle":"bottom",C1&&(C1.textAlign=e,C1.textBaseline=t)},_calculateSplitStrings(){if(!C1)return;const e=I1.split("\n");if(G1){M1=[];const t=D1.width-2*W1;for(const i of e){const e=bo(i,Ao(C1,i),t,this._measureText(C1));M1=M1.concat(e)}}else M1=e},_getFontDesc(){let e=O1.toString()+"px ";return e+=z1,j1&&(e="bold "+e),q1&&(e="italic "+e),e},_getLineHeight(){let e=L1;return e=0===e?O1:e*O1/P1,0|e},_calculateParagraphLength(e,t){const i=[];for(const n of e){const e=Ao(t,n);i.push(e)}return i},_measureText:e=>t=>Ao(e,t),_calculateLabelFont(){if(C1&&(w1=this._getFontDesc(),C1.font=w1,U1===T1.SHRINK)){const e=I1.split("\n"),t=this._calculateParagraphLength(e,C1);M1=e;let i=0,n=0,s=0;if(G1){const t=D1.width-2*W1,r=D1.height-2*W1;if(t<0||r<0)return w1=this._getFontDesc(),void(C1.font=w1);n=r+1,s=t+1;let o=O1+1,a=[],c=!0,l=0|o;for(;n>r||s>t;){if(c?o=l/2|0:(o=l-1,l=o),o<=0){g(4003);break}for(O1=o,w1=this._getFontDesc(),C1.font=w1,M1=[],n=0,i=0;i<e.length;++i){let r=0;const o=Ao(C1,e[i]);for(a=bo(e[i],o,t,this._measureText(C1));r<a.length;){s=Ao(C1,a[r]),n+=this._getLineHeight(),++r}M1=M1.concat(a)}c&&(n>r?l=0|o:(c=!1,n=r+1))}}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)s<t[i]&&(s=t[i]);const r=(D1.width-2*W1)/s,o=D1.height/n;O1=P1*Math.min(1,r,o)|0,w1=this._getFontDesc(),C1.font=w1}}}},K1=Fi.WHITE.clone(),Z1={createData(e){const t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indicesCount=6;const i=t.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;let n=5;for(let e=0;e<4;e++)Fi.toArray(i,K1,n),n+=9;return t},fillBuffers(e,t){const i=e.renderData,n=i.data,s=e.node;let r=t.currBufferBatch;const o=r.byteOffset>>2;let a=r.indicesOffset,c=r.vertexOffset;r.request()||(r=t.currBufferBatch,a=0,c=0);const l=r.vData,h=r.iData,u=i.vData,_=n[0],d=n[3];s.updateWorldTransform();const m=s._pos,p=s._rot,f=s._scale,g=_.x*f.x,v=d.x*f.x,y=_.y*f.y,x=d.y*f.y,S=p.x,T=p.y,E=p.z,A=p.w,C=S*T,b=E*A,R=S*S-T*T,w=A*A-E*E,I=w+R,O=2*(C-b),P=w-R,M=2*(C+b),D=m.x,L=m.y;u[0]=I*g+O*y+D,u[1]=P*y+M*g+L,u[9]=I*v+O*y+D,u[10]=P*y+M*v+L,u[18]=I*g+O*x+D,u[19]=P*x+M*g+L,u[27]=I*v+O*x+D,u[28]=P*x+M*v+L,l.set(u,o),h[a++]=c,h[a++]=c+1,h[a++]=c+2,h[a++]=c+2,h[a++]=c+1,h[a++]=c+3},updateVertexData(e){const t=e.renderData;if(!t)return;const i=e.node._uiProps.uiTransformComp,n=i.width,s=i.height,r=i.anchorX*n,o=i.anchorY*s,a=t.data;a[0].x=-r,a[0].y=-o,a[3].x=n-r,a[3].y=s-o}};ve(Z1,Y1);const $1=e("labelAssembler",{getAssembler(e){let t=Z1;return e.font instanceof gx?t=M0:e.cacheMode===bV.CacheMode.CHAR&&(t=S1),t}});bV.Assembler=$1;const Q1=YI.sharedManager,J1={createData(e){const t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t},updateRenderData(e){const t=e.renderData;t&&t.vertDirty&&this.updateVertexData&&this.updateVertexData(e)},updateVertexData(e){const t=e.renderData;if(!t)return;const i=e.node._uiProps.uiTransformComp,n=t.data,s=i.width,r=i.height,o=i.anchorX*s,a=i.anchorY*r;let c=0,l=0,h=0,u=0;c=-o,l=-a,h=s-o,u=r-a,n[0].x=c,n[0].y=l,n[3].x=h,n[3].y=u,t.vertDirty=!1},fillBuffers(e,t){Q1.pushMask(e),Q1.clear(),e.clearGraphics.updateAssembler(t),Q1.enterLevel(),e.graphics.updateAssembler(t),Q1.enableMask()}},e2={fillBuffers(e,t){Q1.exitMask()}},t2={getAssembler:()=>J1},i2={getAssembler:()=>e2};Fj.Assembler=t2,Fj.PostAssembler=i2;const n2=eR.FillType,s2=new wi,r2={useModel:!1,updateRenderData(e){const t=e.spriteFrame,i=e.renderData;if(i&&t){const t=i.uvDirty,n=i.vertDirty;if(!t&&!n)return;let s=e.fillStart,r=e.fillRange;r<0&&(s+=r,r=-r),r=s+r,s=s>1?1:s,s=s<0?0:s,r=r>1?1:r,r=r<0?0:r,r-=s,r=r<0?0:r;let o=s+r;o=o>1?1:o,t&&this.updateUVs(e,s,o),n&&(this.updateVertexData&&this.updateVertexData(e,s,o),this.updateWorldVertexData(e))}},updateUVs(e,t,i){const n=e.spriteFrame,s=e.renderData,r=s.data,o=n.width,a=n.height,c=n.getRect();let l=0,h=0,u=0,_=0,d=0,m=0,p=0,f=0,g=0,v=0,y=0,x=0;switch(n.isRotated()?(l=c.x/o,h=(c.y+c.width)/a,u=(c.x+c.height)/o,_=c.y/a,d=p=l,g=y=u,f=x=h,m=v=_):(l=c.x/o,h=(c.y+c.height)/a,u=(c.x+c.width)/o,_=c.y/a,d=g=l,p=y=u,m=f=h,v=x=_),e.fillType){case n2.HORIZONTAL:r[0].u=d+(p-d)*t,r[0].v=m+(f-m)*t,r[1].u=d+(p-d)*i,r[1].v=m+(f-m)*i,r[2].u=g+(y-g)*t,r[2].v=v+(x-v)*t,r[3].u=g+(y-g)*i,r[3].v=v+(x-v)*i;break;case n2.VERTICAL:r[0].u=d+(g-d)*t,r[0].v=m+(v-m)*t,r[1].u=p+(y-p)*t,r[1].v=f+(x-f)*t,r[2].u=d+(g-d)*i,r[2].v=m+(v-m)*i,r[3].u=p+(y-p)*i,r[3].v=f+(x-f)*i;break;default:S(2626)}s.uvDirty=!1},updateVertexData(e,t,i){const n=e.renderData,s=n.data,r=e.node._uiProps.uiTransformComp,o=r.width,a=r.height,c=r.anchorX*o,l=r.anchorY*a;let h=-c,u=-l,_=o-c,d=a-l,m=0,p=0;switch(e.fillType){case n2.HORIZONTAL:m=h+(_-h)*t,p=h+(_-h)*i,h=m,_=p;break;case n2.VERTICAL:m=u+(d-u)*t,p=u+(d-u)*i,u=m,d=p;break;default:S(2626)}s[4].x=h,s[4].y=u,s[5].x=_,s[5].y=u,s[6].x=h,s[6].y=d,s[7].x=_,s[7].y=d,n.vertDirty=!1},createData(e){const t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indicesCount=6;const i=t.data;for(const e of i)e.z=0;return t},updateWorldVertexData(e){const t=e.node,i=e.renderData.data;t.getWorldMatrix(s2);for(let e=0;e<4;e++){const t=i[e+4],n=i[e];_i.transformMat4(n,t,s2)}},fillBuffers(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);e.node;!function(e,t,i,n){const s=i.data;let r=t.currBufferBatch,o=r.byteOffset>>2,a=i.vertexCount,c=r.indicesOffset,l=r.vertexOffset;r.request(a,i.indicesCount)||(r=t.currBufferBatch,a=0,c=0,l=0);const h=r.vData;for(let e=0;e<a;e++){const t=s[e];h[o++]=t.x,h[o++]=t.y,h[o++]=t.z,h[o++]=t.u,h[o++]=t.v,Fi.toArray(h,n,o),o+=4}const u=r.iData;u[c++]=l,u[c++]=l+1,u[c++]=l+2,u[c++]=l+1,u[c++]=l+3,u[c++]=l+2}(0,t,e.renderData,e.color)}},o2=2*Math.PI,a2=[new ci,new ci,new ci,new ci],c2=new Array(4),l2=new Array(8),h2=[new ci,new ci,new ci,new ci],u2=[new ci,new ci,new ci,new ci],_2=new ci,d2=[new ci,new ci,new ci,new ci];function m2(e,t,i,n,s,r,o){let a=Math.sin(r);a=Math.abs(a)>1e-6?a:0;let c=Math.cos(r);c=Math.abs(c)>1e-6?c:0;let l=0,h=0;if(0!==c){if(l=a/c,(e-s.x)*c>0){const t=s.y+l*(e-s.x);o[0].x=e,o[0].y=t}if((t-s.x)*c>0){const e=s.y+l*(t-s.x);o[2].x=t,o[2].y=e}}if(0!==a){if(h=c/a,(n-s.y)*a>0){const e=s.x+h*(n-s.y);o[3].x=e,o[3].y=n}if((i-s.y)*a>0){const e=s.x+h*(i-s.y);o[1].x=e,o[1].y=i}}}function p2(e,t){const i=t.x-e.x,n=t.y-e.y;if(0===i&&0===n)return 0;if(0===i)return n>0?.5*Math.PI:1.5*Math.PI;{let e=Math.atan(n/i);return i<0&&(e+=Math.PI),e}}function f2(e,t,i,n,s){const r=c2,o=r[0],a=r[1],c=r[2],l=r[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=s.x,e[t+2].y=s.y;let h=0,u=0;h=(i.x-o)/(c-o),u=(i.y-a)/(l-a),g2(h,u,e,t),h=(n.x-o)/(c-o),u=(n.y-a)/(l-a),g2(h,u,e,t+1),h=(s.x-o)/(c-o),u=(s.y-a)/(l-a),g2(h,u,e,t+2)}function g2(e,t,i,n){const s=l2,r=s[0]+(s[2]-s[0])*e,o=s[4]+(s[6]-s[4])*e,a=s[1]+(s[3]-s[1])*e,c=s[5]+(s[7]-s[5])*e,l=i[n];l.u=r+(o-r)*t,l.v=a+(c-a)*t}const v2={useModel:!1,createData:e=>e.requestRenderData(),updateRenderData(e){const t=e.spriteFrame,i=e.renderData;if(i&&t&&(i.vertDirty||i.uvDirty)){const n=i.data;let s=e.fillStart,r=e.fillRange;for(r<0&&(s+=r,r=-r);s>=1;)s-=1;for(;s<0;)s+=1;s*=o2,r*=o2;const o=s+r;!function(e){const t=e.node._uiProps.uiTransformComp,i=t.width,n=t.height,s=t.anchorX*i,r=t.anchorY*n,o=-s,a=-r,c=i-s,l=n-r,h=c2;h[0]=o,h[1]=a,h[2]=c,h[3]=l;const u=e.fillCenter,_=_2.x=Math.min(Math.max(0,u.x),1)*(c-o)+o,d=_2.y=Math.min(Math.max(0,u.y),1)*(l-a)+a;a2[0].x=a2[3].x=o,a2[1].x=a2[2].x=c,a2[0].y=a2[1].y=a,a2[2].y=a2[3].y=l;for(const e of d2)ci.set(e,0,0);_!==h[0]&&ci.set(d2[0],3,0),_!==h[2]&&ci.set(d2[2],1,2),d!==h[1]&&ci.set(d2[1],0,1),d!==h[3]&&ci.set(d2[3],2,3)}(e),function(e){const t=e.width,i=e.height,n=e.getRect();let s=0,r=0,o=0,a=0;const c=l2;e.isRotated()?(s=n.x/t,r=(n.x+n.height)/t,o=n.y/i,a=(n.y+n.width)/i,c[0]=c[2]=s,c[4]=c[6]=r,c[3]=c[7]=a,c[1]=c[5]=o):(s=n.x/t,r=(n.x+n.width)/t,o=n.y/i,a=(n.y+n.height)/i,c[0]=c[4]=s,c[2]=c[6]=r,c[1]=c[3]=a,c[5]=c[7]=o)}(t),m2(c2[0],c2[2],c2[1],c2[3],_2,s,h2),m2(c2[0],c2[2],c2[1],c2[3],_2,s+r,u2);let a=0;for(let e=0;e<4;++e){const t=d2[e];if(!t)continue;if(r>=o2){i.dataLength=a+3,f2(n,a,_2,a2[t.x],a2[t.y]),a+=3;continue}let c=p2(_2,a2[t.x]),l=p2(_2,a2[t.y]);l<c&&(l+=o2),c-=o2,l-=o2;for(let r=0;r<3;++r)c>=o||(c>=s?(i.dataLength=a+3,f2(n,a,_2,a2[t.x],l>=o?u2[e]:a2[t.y]),a+=3):l<=s||(l<=o?(i.dataLength=a+3,f2(n,a,_2,h2[e],a2[t.y]),a+=3):(i.dataLength=a+3,f2(n,a,_2,h2[e],u2[e]),a+=3))),c+=o2,l+=o2}i.indicesCount=i.vertexCount=a,i.vertDirty=i.uvDirty=!1}},fillBuffers(e,t){!function(e,t,i,n){const s=i.data;let r=t.currBufferBatch,o=r.byteOffset>>2,a=i.vertexCount,c=r.indicesOffset,l=r.vertexOffset;r.request(a,i.indicesCount)||(r=t.currBufferBatch,a=0,c=0,l=0);const h=r.vData;e.getWorldMatrix(lG);for(let e=0;e<a;e++){const t=s[e];_i.set(cG,t.x,t.y,0),_i.transformMat4(cG,cG,lG),h[o++]=cG.x,h[o++]=cG.y,h[o++]=cG.z,h[o++]=t.u,h[o++]=t.v,Fi.toArray(h,n,o),o+=4}const u=r.iData;for(let e=0;e<i.dataLength;e++)u[c+e]=l+e}(e.node,t,e.renderData,e.color)}},y2=[];for(let e=0;e<4;e++)y2.push(new _i);const x2={createData(e){const t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t.vData=new Float32Array(36),t},updateRenderData(e){const t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&this.updateVertexData(e),i.uvDirty&&this.updateUvs(e))},fillBuffers(e,t){if(null===e)return;const i=e.renderData.data,n=e.node;let s=t.currBufferBatch,r=s.byteOffset>>2,o=s.indicesOffset,a=s.vertexOffset;s.request()||(s=t.currBufferBatch,r=0,o=0,a=0);const c=s.vData,l=s.iData,h=e.renderData.vData,u=i[0],_=i[3],d=n.worldMatrix,m=d.m00,p=d.m01,f=d.m04,g=d.m05,v=d.m12,y=d.m13,x=u.x,S=_.x,T=u.y,E=_.y,A=m*x,C=m*S,b=p*x,R=p*S,w=f*T,I=f*E,O=g*T,P=g*E;h[0]=A+w+v,h[1]=b+O+y,h[9]=C+w+v,h[10]=R+O+y,h[18]=A+I+v,h[19]=b+P+y,h[27]=C+I+v,h[28]=R+P+y,c.set(h,r),l[o++]=a,l[o++]=a+1,l[o++]=a+2,l[o++]=a+2,l[o++]=a+1,l[o++]=a+3},updateVertexData(e){const t=e.renderData;if(!t)return;const i=e.node._uiProps.uiTransformComp,n=t.data,s=i.width,r=i.height,o=i.anchorX*s,a=i.anchorY*r;let c=0,l=0,h=0,u=0;if(e.trim)c=-o,l=-a,h=s-o,u=r-a;else{const t=e.spriteFrame,i=t.getOriginalSize(),n=t.getRect(),_=i.width,d=i.height,m=n.width,p=n.height,f=t.getOffset(),g=s/_,v=r/d,y=f.x+(_-m)/2,x=f.x-(_-m)/2;c=y*g-o,l=(f.y+(d-p)/2)*v-a,h=s+x*g-o,u=r+(f.y-(d-p)/2)*v-a}n[0].x=c,n[0].y=l,n[0].z=0,n[3].x=h,n[3].y=u,n[3].z=0,t.vertDirty=!1},updateUvs(e){const t=e.renderData,i=t.vData,n=e.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],t.uvDirty=!1},updateColor(e){const t=e.renderData.vData;let i=5;const n=e.color,s=n.r/255,r=n.g/255,o=n.b/255,a=n.a/255;for(let e=0;e<4;e++)t[i]=s,t[i+1]=r,t[i+2]=o,t[i+3]=a,i+=9}},S2=new _i,T2=new wi,E2={useModel:!1,createData(e){const t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indicesCount=54,t},updateRenderData(e){const t=e.spriteFrame,i=e.renderData;if(i&&t){i.vertDirty&&(this.updateVertexData(e),this.updateWorldVertexData(e))}},updateVertexData(e){const t=e.renderData,i=t.data,n=e.node._uiProps.uiTransformComp,s=n.width,r=n.height,o=n.anchorX*s,a=n.anchorY*r,c=e.spriteFrame,l=c.insetLeft,h=c.insetRight,u=c.insetTop,_=c.insetBottom;let d=s-l-h,m=r-u-_,p=s/(l+h),f=r/(u+_);p=isNaN(p)||p>1?1:p,f=isNaN(f)||f>1?1:f,d=d<0?0:d,m=m<0?0:m,i[0].x=-o,i[0].y=-a,i[1].x=l*p-o,i[1].y=_*f-a,i[2].x=i[1].x+d,i[2].y=i[1].y+m,i[3].x=s-o,i[3].y=r-a,t.vertDirty=!1},fillBuffers(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);let i=t.currBufferBatch;const n=e.renderData,s=n.data;let r=i.byteOffset>>2;const o=n.vertexCount;let a=i.indicesOffset,c=i.vertexOffset;const l=e.spriteFrame.uvSliced;i.request(o,n.indicesCount)||(i=t.currBufferBatch,r=0,a=0,c=0);const h=i.vData,u=i.iData;for(let t=4;t<20;++t){const i=s[t],n=l[t-4];h[r++]=i.x,h[r++]=i.y,h[r++]=i.z,h[r++]=n.u,h[r++]=n.v,Fi.toArray(h,e.color,r),r+=4}for(let e=0;e<3;++e)for(let t=0;t<3;++t){const i=c+4*e+t;u[a++]=i,u[a++]=i+1,u[a++]=i+4,u[a++]=i+1,u[a++]=i+5,u[a++]=i+4}},updateWorldVertexData(e){const t=e.node,i=e.renderData.data;t.getWorldMatrix(T2);for(let e=0;e<4;++e){const t=i[e];for(let n=0;n<4;++n){const s=i[n],r=i[4+4*e+n];_i.set(S2,s.x,t.y,0),_i.transformMat4(r,S2,T2)}}}},A2=[];for(let e=0;e<4;e++)A2.push(new _i);const C2={useModel:!1,createData:e=>e.requestRenderData(),updateRenderData(e){const t=e.renderData,i=e.spriteFrame;if(!i||!t||!t.uvDirty&&!t.vertDirty)return;const n=e.node._uiProps.uiTransformComp,s=Math.abs(n.width),r=Math.abs(n.height),o=n.anchorX*s,a=n.anchorY*r,c=i.getRect(),l=c.width,h=c.height,u=s/l,_=r/h,d=Math.ceil(_),m=Math.ceil(u),p=t.data;t.dataLength=Math.max(8,d+1,m+1);for(let e=0;e<=m;++e)p[e].x=Math.min(l*e,s)-o;for(let e=0;e<=d;++e)p[e].y=Math.min(h*e,r)-a;t.vertexCount=d*m*4,t.indicesCount=d*m*6,t.uvDirty=!1,t.vertDirty=!1},fillBuffers(e,t){const i=e.node,n=e.node._uiProps.uiTransformComp,s=e.renderData;let r=t.currBufferBatch,o=r.indicesOffset,a=r.byteOffset>>2,c=r.vertexOffset;const l=s.vertexCount,h=s.indicesCount,u=r.vData,_=r.iData;r.request(l,h)||(r=t.currBufferBatch,a=0,o=0,c=0);const d=e.spriteFrame,m=d.isRotated(),p=d.uv,f=d.getRect(),g=Math.abs(n.width),v=Math.abs(n.height),y=g/f.width,x=v/f.height,S=Math.ceil(x),T=Math.ceil(y),E=i.worldMatrix;this.fillVertices(u,a,E,S,T,s.data);let A=0,C=0;for(let t=0,i=S;t<i;++t){C=Math.min(1,x-t);for(let t=0,i=T;t<i;++t){A=Math.min(1,y-t);const i=a+3,n=i+1;m?(u[i]=p[0],u[n]=p[1],u[i+9]=p[0],u[n+9]=p[1]+(p[7]-p[1])*A,u[i+18]=p[0]+(p[6]-p[0])*C,u[n+18]=p[1],u[i+27]=u[i+18],u[n+27]=u[n+9]):(u[i]=p[0],u[n]=p[1],u[i+9]=p[0]+(p[6]-p[0])*A,u[n+9]=p[1],u[i+18]=p[0],u[n+18]=p[1]+(p[7]-p[1])*C,u[i+27]=u[i+9],u[n+27]=u[n+18]),Fi.toArray(u,e.color,n+1),Fi.toArray(u,e.color,n+9+1),Fi.toArray(u,e.color,n+18+1),Fi.toArray(u,e.color,n+27+1),a+=36}}for(let e=0;e<h;e+=6)_[o++]=c,_[o++]=c+1,_[o++]=c+2,_[o++]=c+1,_[o++]=c+3,_[o++]=c+2,c+=4},fillVertices(e,t,i,n,s,r){let o=0,a=0,c=0,l=0;for(let h=0,u=n;h<u;++h){c=r[h].y,l=r[h+1].y;for(let n=0,h=s;n<h;++n){o=r[n].x,a=r[n+1].x,_i.set(A2[0],o,c,0),_i.set(A2[1],a,c,0),_i.set(A2[2],o,l,0),_i.set(A2[3],a,l,0);for(let n=0;n<4;n++){const s=A2[n];_i.transformMat4(s,s,i);const r=9*n;e[t+r]=s.x,e[t+r+1]=s.y,e[t+r+2]=s.z}t+=36}}}},b2=eR.Type,R2=eR.FillType,w2=e("spriteAssembler",{getAssembler(e){let t=x2;const i=e;switch(i.type){case b2.SLICED:t=E2;break;case b2.TILED:t=C2;break;case b2.FILLED:t=i.fillType===R2.RADIAL?v2:r2}return t}});var I2;eR.Assembler=w2;let O2=e("UIReorderComponent",Go("cc.UIReorderComponent")(I2=class{constructor(){y(1408,"UIReorderComponent")}})||I2);i.UIReorderComponent=O2,i.ButtonComponent=uH,Be.setClassAlias(uH,"cc.ButtonComponent"),i.EditBoxComponent=kk,Be.setClassAlias(kk,"cc.EditBoxComponent"),i.LayoutComponent=kW,Be.setClassAlias(kW,"cc.LayoutComponent"),i.MaskComponent=Fj,Be.setClassAlias(Fj,"cc.MaskComponent"),i.LabelComponent=bV,Be.setClassAlias(bV,"cc.LabelComponent"),i.LabelOutlineComponent=yq,Be.setClassAlias(yq,"cc.LabelOutlineComponent"),i.ProgressBarComponent=aq,Be.setClassAlias(aq,"cc.ProgressBarComponent"),i.RichTextComponent=nX,Be.setClassAlias(nX,"cc.RichTextComponent"),i.ScrollViewComponent=UY,Be.setClassAlias(UY,"cc.ScrollViewComponent"),i.ScrollBarComponent=LX,Be.setClassAlias(LX,"cc.ScrollBarComponent"),i.SliderComponent=lK,Be.setClassAlias(lK,"cc.SliderComponent"),i.SpriteComponent=eR,Be.setClassAlias(eR,"cc.SpriteComponent"),i.ToggleComponent=PK,Be.setClassAlias(PK,"cc.ToggleComponent"),i.ToggleContainerComponent=kK,Be.setClassAlias(kK,"cc.ToggleContainerComponent"),i.UIModelComponent=jK,Be.setClassAlias(jK,"cc.UIModelComponent"),i.WidgetComponent=zZ,Be.setClassAlias(zZ,"cc.WidgetComponent"),i.GraphicsComponent=dj,Be.setClassAlias(dj,"cc.GraphicsComponent"),i.PageViewComponent=J$,Be.setClassAlias(J$,"cc.PageViewComponent"),i.PageViewIndicatorComponent=o$,Be.setClassAlias(o$,"cc.PageViewIndicatorComponent"),Be.setClassAlias(_Q,"cc.UIStaticBatchComponent"),Be.setClassAlias(fQ,"cc.UIOpacityComponent"),i.SafeAreaComponent=vQ,Be.setClassAlias(vQ,"cc.SafeAreaComponent"),Be.setClassAlias(zQ,"cc.UICoordinateTrackerComponent"),i.BlockInputEventsComponent=VQ,Be.setClassAlias(VQ,"cc.BlockInputEventsComponent"),i.UI={MeshBuffer:qI,UIVertexFormat:tO,spriteAssembler:w2,graphicsAssembler:QJ,labelAssembler:$1}}}}));
